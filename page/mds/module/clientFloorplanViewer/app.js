var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||typeof Object.defineProperties=='function'?Object.defineProperty:function(b,c,a){a=a;if(b==Array.prototype||b==Object.prototype){return}b[c]=a.value};$jscomp.getGlobal=function(a){return typeof window!='undefined'&&window===a?a:typeof global!='undefined'&&global!=null?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(i,f,j,k){if(!f){return}var a=$jscomp.global;var b=i.split('.');for(var e=0;e<b.length-1;e++){var d=b[e];if(!(d in a)){a[d]={}}a=a[d]}var g=b[b.length-1];var h=a[g];var c=f(h);if(c==h||c==null){return}$jscomp.defineProperty(a,g,{configurable:!0,writable:!0,value:c})};$jscomp.polyfill('Array.prototype.copyWithin',function(a){if(a){return a}var b=function(d,c,b){var e=this.length;d=Number(d);c=Number(c);b=Number(b!=null?b:e);if(d<c){b=Math.min(b,e);while(c<b){if(c in this){this[d++]=this[c++]}else {delete this[d++];c++}}}else {b=Math.min(b,e+c-d);d+=b-c;while(b>c){if(--b in this){this[--d]=this[b]}else {delete this[d]}}}return this};return b},'es6','es3');$jscomp.SYMBOL_PREFIX='jscomp_symbol_';$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};if(!$jscomp.global['Symbol']){$jscomp.global['Symbol']=$jscomp.Symbol}};$jscomp.Symbol=function(){var a=0;function Symbol(b){return $jscomp.SYMBOL_PREFIX+(b||'')+a++}return Symbol}();$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global['Symbol'].iterator;if(!a){a=$jscomp.global['Symbol'].iterator=$jscomp.global['Symbol']('iterator')}if(typeof Array.prototype[a]!='function'){$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}})}$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){if(b<a.length){return {done:!1,value:a[b++]}}else {return {done:!0}}})};$jscomp.iteratorPrototype=function(b){$jscomp.initSymbolIterator();var a={next:b};a[$jscomp.global['Symbol'].iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,d){$jscomp.initSymbolIterator();if(a instanceof String){a=a+''}var c=0;var b={next:function(){if(c<a.length){var e=c++;return {value:d(e,a[e]),done:!1}}b.next=function(){return {done:!0,value:void 0}};return b.next()}};b[Symbol.iterator]=function(){return b};return b};$jscomp.polyfill('Array.prototype.entries',function(a){if(a){return a}var b=function(){return $jscomp.iteratorFromArray(this,function(b,c){return [b,c]})};return b},'es6','es3');$jscomp.polyfill('Array.prototype.fill',function(a){if(a){return a}var b=function(f,c,b){var d=this.length||0;if(c<0){c=Math.max(0,d+c)}if(b==null||b>d){b=d}b=Number(b);if(b<0){b=Math.max(0,d+b)}for(var e=Number(c||0);e<b;e++){this[e]=f}return this};return b},'es6','es3');$jscomp.findInternal=function(a,d,e){if(a instanceof String){a=String(a)}var f=a.length;for(var b=0;b<f;b++){var c=a[b];if(d.call(e,c,b,a)){return {i:b,v:c}}}return {i:-1,v:void 0}};$jscomp.polyfill('Array.prototype.find',function(a){if(a){return a}var b=function(c,b){return $jscomp.findInternal(this,c,b).v};return b},'es6','es3');$jscomp.polyfill('Array.prototype.findIndex',function(a){if(a){return a}var b=function(c,b){return $jscomp.findInternal(this,c,b).i};return b},'es6','es3');$jscomp.polyfill('Array.from',function(a){if(a){return a}var b=function(b,c,g){$jscomp.initSymbolIterator();c=c!=null?c:function(d){return d};var d=[];var f=b[Symbol.iterator];if(typeof f=='function'){b=f.call(b);var h;while(!(h=b.next()).done){d.push(c.call(g,h.value))}}else {var i=b.length;for(var e=0;e<i;e++){d.push(c.call(g,b[e]))}}return d};return b},'es6','es3');$jscomp.polyfill('Object.is',function(a){if(a){return a}var b=function(b,c){if(b===c){return b!==0||1/b===1/c}else {return b!==b&&c!==c}};return b},'es6','es3');$jscomp.polyfill('Array.prototype.includes',function(a){if(a){return a}var b=function(d,e){var b=this;if(b instanceof String){b=String(b)}var f=b.length;for(var c=e||0;c<f;c++){if(b[c]==d||Object.is(b[c],d)){return !0}}return !1};return b},'es7','es3');$jscomp.polyfill('Array.prototype.keys',function(a){if(a){return a}var b=function(){return $jscomp.iteratorFromArray(this,function(b){return b})};return b},'es6','es3');$jscomp.polyfill('Array.of',function(a){if(a){return a}var b=function(b){return Array.from(arguments)};return b},'es6','es3');$jscomp.polyfill('Array.prototype.values',function(a){if(a){return a}var b=function(){return $jscomp.iteratorFromArray(this,function(c,b){return b})};return b},'es6','es3');$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.polyfill('Promise',function(c){if(c&&!$jscomp.FORCE_POLYFILL_PROMISE){return c}function AsyncExecutor(){this.batch_=null}AsyncExecutor.prototype.asyncExecute=function(a){if(this.batch_==null){this.batch_=[];this.asyncExecuteBatch_()}this.batch_.push(a);return this};AsyncExecutor.prototype.asyncExecuteBatch_=function(){var a=this;this.asyncExecuteFunction(function(){a.executeBatch_()})};var e=$jscomp.global['setTimeout'];AsyncExecutor.prototype.asyncExecuteFunction=function(a){e(a,0)};AsyncExecutor.prototype.executeBatch_=function(){while(this.batch_&&this.batch_.length){var b=this.batch_;this.batch_=[];for(var a=0;a<b.length;++a){var d=b[a];delete b[a];try{d()}catch(f){this.asyncThrow_(f)}}}this.batch_=null};AsyncExecutor.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a})};var b={PENDING:0,FULFILLED:1,REJECTED:2};var a=function(d){this.state_=b.PENDING;this.result_=undefined;this.onSettledCallbacks_=[];var a=this.createResolveAndReject_();try{d(a.resolve,a.reject)}catch(f){a.reject(f)}};a.prototype.createResolveAndReject_=function(){var b=this;var a=!1;function firstCallWins(d){return function(e){if(!a){a=!0;d.call(b,e)}}}return {resolve:firstCallWins(this.resolveTo_),reject:firstCallWins(this.reject_)}};a.prototype.resolveTo_=function(b){if(b===this){this.reject_(new TypeError('A Promise cannot resolve to itself'))}else {if(b instanceof a){this.settleSameAsPromise_(b)}else {if(isObject(b)){this.resolveToNonPromiseObj_(b)}else {this.fulfill_(b)}}}};a.prototype.resolveToNonPromiseObj_=function(b){var a=undefined;try{a=b.then}catch(f){this.reject_(f);return}if(typeof a=='function'){this.settleSameAsThenable_(a,b)}else {this.fulfill_(b)}};function isObject(a){switch(typeof a){case 'object':return a!=null;case 'function':return !0;default:return !1;}}a.prototype.reject_=function(a){this.settle_(b.REJECTED,a)};a.prototype.fulfill_=function(a){this.settle_(b.FULFILLED,a)};a.prototype.settle_=function(d,a){if(this.state_!=b.PENDING){throw new Error('Cannot settle('+d+', '+a|'): Promise already settled in state'+this.state_)}this.state_=d;this.result_=a;this.executeOnSettledCallbacks_()};a.prototype.executeOnSettledCallbacks_=function(){if(this.onSettledCallbacks_!=null){var b=this.onSettledCallbacks_;for(var a=0;a<b.length;++a){b[a].call();b[a]=null}this.onSettledCallbacks_=null}};var d=new AsyncExecutor();a.prototype.settleSameAsPromise_=function(b){var a=this.createResolveAndReject_();b.callWhenSettled_(a.resolve,a.reject)};a.prototype.settleSameAsThenable_=function(b,d){var a=this.createResolveAndReject_();try{b.call(d,a.resolve,a.reject)}catch(f){a.reject(f)}};a.prototype.then=function(f,g){var b;var d;var e=new a(function(a,e){b=a;d=e});function createCallback(a,e){if(typeof a=='function'){return function(h){try{b(a(h))}catch(i){d(i)}}}else {return e}}this.callWhenSettled_(createCallback(f,b),createCallback(g,d));return e};a.prototype['catch']=function(a){return this.then(undefined,a)};a.prototype.callWhenSettled_=function(e,f){var a=this;function callback(){switch(a.state_){case b.FULFILLED:e(a.result_);break;case b.REJECTED:f(a.result_);break;default:throw new Error('Unexpected state: '+a.state_);}}if(this.onSettledCallbacks_==null){d.asyncExecute(callback)}else {this.onSettledCallbacks_.push(function(){d.asyncExecute(callback)})}};function resolvingPromise(b){if(b instanceof a){return b}else {return new a(function(a,d){a(b)})}}a['resolve']=resolvingPromise;a['reject']=function(b){return new a(function(d,a){a(b)})};a['race']=function(b){return new a(function(e,f){var d=$jscomp.makeIterator(b);for(var a=d.next();!a.done;a=d.next()){resolvingPromise(a.value).callWhenSettled_(e,f)}})};a['all']=function(e){var d=$jscomp.makeIterator(e);var b=d.next();if(b.done){return resolvingPromise([])}else {return new a(function(g,h){var a=[];var f=0;function onFulfilled(b){return function(d){a[b]=d;f--;if(f==0){g(a)}}}do{a.push(undefined);f++;resolvingPromise(b.value).callWhenSettled_(onFulfilled(a.length-1),h);b=d.next()}while(!b.done)})}};return a},'es6','es3');$jscomp.executeAsyncGenerator=function(a){function passValueToGenerator(b){return a.next(b)}function passErrorToGenerator(b){return a['throw'](b)}return new Promise(function(b,c){function handleGeneratorRecord(d){if(d.done){b(d.value)}else {Promise.resolve(d.value).then(passValueToGenerator,passErrorToGenerator).then(handleGeneratorRecord,c)}}handleGeneratorRecord(a.next())})};$jscomp.owns=function(b,a){return Object.prototype.hasOwnProperty.call(b,a)};$jscomp.polyfill('WeakMap',function(c){function isConformant(){if(!c||!Object.seal){return !1}try{var b=Object.seal({});var d=Object.seal({});var a=new c([[b,2],[d,3]]);if(a.get(b)!=2||a.get(d)!=3){return !1}a['delete'](b);a.set(d,4);return !a.has(b)&&a.get(d)==4}catch(e){return !1}}if(isConformant()){return c}var a='$jscomp_hidden_'+Math.random().toString().substring(2);function insert(b){if(!$jscomp.owns(b,a)){var d={};$jscomp.defineProperty(b,a,{value:d})}}function patch(a){var b=Object[a];if(b){Object[a]=function(d){insert(d);return b(d)}}}patch('freeze');patch('preventExtensions');patch('seal');var d=0;var b=function(a){this.id_=(d+=Math.random()+1).toString();if(a){$jscomp.initSymbol();$jscomp.initSymbolIterator();var f=$jscomp.makeIterator(a);var b;while(!(b=f.next()).done){var e=b.value;this.set(e[0],e[1])}}};b.prototype.set=function(b,d){insert(b);if(!$jscomp.owns(b,a)){throw new Error('WeakMap key fail: '+b)}b[a][this.id_]=d;return this};b.prototype.get=function(b){return $jscomp.owns(b,a)?b[a][this.id_]:undefined};b.prototype.has=function(b){return $jscomp.owns(b,a)&&$jscomp.owns(b[a],this.id_)};b.prototype['delete']=function(b){if(!$jscomp.owns(b,a)||!$jscomp.owns(b[a],this.id_)){return !1}return delete b[a][this.id_]};return b},'es6','es3');$jscomp.MapEntry=function(){this.previous;this.next;this.head;this.key;this.value};$jscomp.polyfill('Map',function(b){var g=!$jscomp.ASSUME_NO_NATIVE_MAP&&function(){if(!b||!b.prototype.entries||typeof Object.seal!='function'){return !1}try{b=b;var e=Object.seal({x:4});var c=new b($jscomp.makeIterator([[e,'s']]));if(c.get(e)!='s'||c.size!=1||c.get({x:4})||c.set({x:4},'t')!=c||c.size!=2){return !1}var d=c.entries();var a=d.next();if(a.done||a.value[0]!=e||a.value[1]!='s'){return !1}a=d.next();if(a.done||a.value[0].x!=4||a.value[1]!='t'||!d.next().done){return !1}return !0}catch(j){return !1}}();if(g){return b}$jscomp.initSymbol();$jscomp.initSymbolIterator();var e=new WeakMap();var a=function(a){this.data_={};this.head_=f();this.size=0;if(a){var e=$jscomp.makeIterator(a);var c;while(!(c=e.next()).done){var d=c.value;this.set(d[0],d[1])}}};a.prototype.set=function(e,d){var a=c(this,e);if(!a.list){a.list=this.data_[a.id]=[]}if(!a.entry){a.entry={next:this.head_,previous:this.head_.previous,head:this.head_,key:e,value:d};a.list.push(a.entry);this.head_.previous.next=a.entry;this.head_.previous=a.entry;this.size++}else {a.entry.value=d}return this};a.prototype['delete']=function(d){var a=c(this,d);if(a.entry&&a.list){a.list.splice(a.index,1);if(!a.list.length){delete this.data_[a.id]}a.entry.previous.next=a.entry.next;a.entry.next.previous=a.entry.previous;a.entry.head=null;this.size--;return !0}return !1};a.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=f();this.size=0};a.prototype.has=function(a){return !!c(this,a).entry};a.prototype.get=function(d){var a=c(this,d).entry;return a&&a.value};a.prototype.entries=function(){return d(this,function(a){return [a.key,a.value]})};a.prototype.keys=function(){return d(this,function(a){return a.key})};a.prototype.values=function(){return d(this,function(a){return a.value})};a.prototype.forEach=function(e,d){var f=this.entries();var c;while(!(c=f.next()).done){var a=c.value;e.call(d,a[1],a[0],this)}};a.prototype[Symbol.iterator]=a.prototype.entries;var c=function(g,e){var f=i(e);var a=g.data_[f];if(a&&$jscomp.owns(g.data_,f)){for(var d=0;d<a.length;d++){var c=a[d];if(e!==e&&c.key!==c.key||e===c.key){return {id:f,list:a,index:d,entry:c}}}}return {id:f,list:a,index:-1,entry:undefined}};var d=function(c,d){var a=c.head_;return $jscomp.iteratorPrototype(function(){if(a){while(a.head!=c.head_){a=a.previous}while(a.next!=a.head){a=a.next;return {done:!1,value:d(a)}}a=null}return {done:!0,value:void 0}})};var f=function(){var a={};a.previous=a.next=a.head=a;return a};var h=0;var i=function(a){var c=a&&typeof a;if(c=='object'||c=='function'){a=a;if(!e.has(a)){var d=''+ ++h;e.set(a,d);return d}return e.get(a)}return 'p_'+a};return a},'es6','es3');$jscomp.polyfill('Math.acosh',function(a){if(a){return a}var b=function(b){b=Number(b);return Math.log(b+Math.sqrt(b*b-1))};return b},'es6','es3');$jscomp.polyfill('Math.asinh',function(a){if(a){return a}var b=function(b){b=Number(b);if(b===0){return b}var c=Math.log(Math.abs(b)+Math.sqrt(b*b+1));return b<0?-c:c};return b},'es6','es3');$jscomp.polyfill('Math.log1p',function(a){if(a){return a}var b=function(b){b=Number(b);if(b<0.25&&b>-0.25){var f=b;var g=1;var c=b;var d=0;var e=1;while(d!=c){f*=b;e*=-1;c=(d=c)+e*f/++g}return c}return Math.log(1+b)};return b},'es6','es3');$jscomp.polyfill('Math.atanh',function(b){if(b){return b}var a=Math.log1p;var c=function(c){c=Number(c);return (a(c)-a(-c))/2};return c},'es6','es3');$jscomp.polyfill('Math.cbrt',function(a){if(a){return a}var b=function(b){if(b===0){return b}b=Number(b);var c=Math.pow(Math.abs(b),1/3);return b<0?-c:c};return b},'es6','es3');$jscomp.polyfill('Math.clz32',function(a){if(a){return a}var b=function(b){b=Number(b)>>>0;if(b===0){return 32}var c=0;if((b&4.29490176E9)===0){b<<=16;c+=16}if((b&4.27819008E9)===0){b<<=8;c+=8}if((b&4.02653184E9)===0){b<<=4;c+=4}if((b&3.221225472E9)===0){b<<=2;c+=2}if((b&2.147483648E9)===0){c++}return c};return b},'es6','es3');$jscomp.polyfill('Math.cosh',function(a){if(a){return a}var b=Math.exp;var c=function(c){c=Number(c);return (b(c)+b(-c))/2};return c},'es6','es3');$jscomp.polyfill('Math.expm1',function(a){if(a){return a}var b=function(b){b=Number(b);if(b<0.25&&b>-0.25){var e=b;var f=1;var c=b;var d=0;while(d!=c){e*=b/++f;c=(d=c)+e}return c}return Math.exp(b)-1};return b},'es6','es3');$jscomp.polyfill('Math.hypot',function(a){if(a){return a}var b=function(c,d,h){c=Number(c);d=Number(d);var b,g,f;var e=Math.max(Math.abs(c),Math.abs(d));for(b=2;b<arguments.length;b++){e=Math.max(e,Math.abs(arguments[b]))}if(e>1.0E100||e<1.0E-100){c=c/e;d=d/e;f=c*c+d*d;for(b=2;b<arguments.length;b++){g=Number(arguments[b])/e;f+=g*g}return Math.sqrt(f)*e}else {f=c*c+d*d;for(b=2;b<arguments.length;b++){g=Number(arguments[b]);f+=g*g}return Math.sqrt(f)}};return b},'es6','es3');$jscomp.polyfill('Math.imul',function(a){if(a){return a}var b=function(b,c){b=Number(b);c=Number(c);var f=b>>>16&65535;var d=b&65535;var g=c>>>16&65535;var e=c&65535;var h=f*e+d*g<<16>>>0;return d*e+h|0};return b},'es6','es3');$jscomp.polyfill('Math.log10',function(a){if(a){return a}var b=function(b){return Math.log(b)/Math.LN10};return b},'es6','es3');$jscomp.polyfill('Math.log2',function(a){if(a){return a}var b=function(b){return Math.log(b)/Math.LN2};return b},'es6','es3');$jscomp.polyfill('Math.sign',function(a){if(a){return a}var b=function(b){b=Number(b);return b===0||isNaN(b)?b:b>0?1:-1};return b},'es6','es3');$jscomp.polyfill('Math.sinh',function(a){if(a){return a}var b=Math.exp;var c=function(c){c=Number(c);if(c===0){return c}return (b(c)-b(-c))/2};return c},'es6','es3');$jscomp.polyfill('Math.tanh',function(a){if(a){return a}var b=function(b){b=Number(b);if(b===0){return b}var c=Math.exp(-2*Math.abs(b));var d=(1-c)/(1+c);return b<0?-d:d};return b},'es6','es3');$jscomp.polyfill('Math.trunc',function(a){if(a){return a}var b=function(b){b=Number(b);if(isNaN(b)||b===Infinity||b===-Infinity||b===0){return b}var c=Math.floor(Math.abs(b));return b<0?-c:c};return b},'es6','es3');$jscomp.polyfill('Number.EPSILON',function(a){return Math.pow(2,-52)},'es6','es3');$jscomp.polyfill('Number.MAX_SAFE_INTEGER',function(){return 9.007199254740991E15},'es6','es3');$jscomp.polyfill('Number.MIN_SAFE_INTEGER',function(){return -9.007199254740991E15},'es6','es3');$jscomp.polyfill('Number.isFinite',function(a){if(a){return a}var b=function(b){if(typeof b!=='number'){return !1}return !isNaN(b)&&b!==Infinity&&b!==-Infinity};return b},'es6','es3');$jscomp.polyfill('Number.isInteger',function(a){if(a){return a}var b=function(b){if(!Number.isFinite(b)){return !1}return b===Math.floor(b)};return b},'es6','es3');$jscomp.polyfill('Number.isNaN',function(a){if(a){return a}var b=function(b){return typeof b==='number'&&isNaN(b)};return b},'es6','es3');$jscomp.polyfill('Number.isSafeInteger',function(a){if(a){return a}var b=function(b){return Number.isInteger(b)&&Math.abs(b)<=Number.MAX_SAFE_INTEGER};return b},'es6','es3');$jscomp.polyfill('Object.assign',function(a){if(a){return a}var b=function(e,f){for(var d=1;d<arguments.length;d++){var b=arguments[d];if(!b){continue}for(var c in b){if($jscomp.owns(b,c)){e[c]=b[c]}}}return e};return b},'es6','es3');$jscomp.polyfill('Object.entries',function(a){if(a){return a}var b=function(c){var d=[];for(var b in c){if($jscomp.owns(c,b)){d.push([b,c[b]])}}return d};return b},'es8','es3');$jscomp.polyfill('Object.getOwnPropertySymbols',function(a){if(a){return a}return function(){return []}},'es6','es5');$jscomp.polyfill('Reflect.ownKeys',function(b){if(b){return b}var a='jscomp_symbol_';function isSymbol(c){return c.substring(0,a.length)==a}var c=function(e){var f=[];var c=Object.getOwnPropertyNames(e);var d=Object.getOwnPropertySymbols(e);for(var a=0;a<c.length;a++){(isSymbol(c[a])?d:f).push(c[a])}return f.concat(d)};return c},'es6','es5');$jscomp.polyfill('Object.getOwnPropertyDescriptors',function(a){if(a){return a}var b=function(e){var d={};var c=Reflect.ownKeys(e);for(var b=0;b<c.length;b++){d[c[b]]=Object.getOwnPropertyDescriptor(e,c[b])}return d};return b},'es8','es5');$jscomp.underscoreProtoCanBeSet=function(){var b={a:!0};var a={};try{a.__proto__=b;return a.a}catch(c){}return !1};$jscomp.setPrototypeOf=typeof Object.setPrototypeOf=='function'?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b){throw new TypeError(a+' is not extensible')}return a}:null;$jscomp.polyfill('Object.setPrototypeOf',function(a){return a||$jscomp.setPrototypeOf},'es6','es5');$jscomp.polyfill('Object.values',function(a){if(a){return a}var b=function(b){var c=[];for(var d in b){if($jscomp.owns(b,d)){c.push(b[d])}}return c};return b},'es8','es3');$jscomp.polyfill('Reflect.apply',function(a){if(a){return a}var c=Function.prototype.apply;var b=function(e,d,b){return c.call(e,d,b)};return b},'es6','es3');$jscomp.objectCreate=$jscomp.ASSUME_ES5||typeof Object.create=='function'?Object.create:function(b){var a=function(){};a.prototype=b;return new a()};$jscomp.construct=function(){function reflectConstructWorks(){function Base(){}function Derived(){}new Base();Reflect.construct(Base,[],Derived);return new Base() instanceof Base}if(typeof Reflect!='undefined'&&Reflect.construct){if(reflectConstructWorks()){return Reflect.construct}var b=Reflect.construct;var a=function(e,d,a){var c=b(e,d);if(a){Reflect.setPrototypeOf(c,a.prototype)}return c};return a}function construct(b,d,a){if(a===undefined){a=b}var f=a.prototype||Object.prototype;var c=$jscomp.objectCreate(f);var e=Function.prototype.apply;var g=e.call(b,c,d);return g||c}return construct}();$jscomp.polyfill('Reflect.construct',function(a){return $jscomp.construct},'es6','es3');$jscomp.polyfill('Reflect.defineProperty',function(a){if(a){return a}var b=function(e,d,c){try{Object.defineProperty(e,d,c);var b=Object.getOwnPropertyDescriptor(e,d);if(!b){return !1}return b.configurable===(c.configurable||!1)&&b.enumerable===(c.enumerable||!1)&&('value' in b?b.value===c.value&&b.writable===(c.writable||!1):b.get===c.get&&b.set===c.set)}catch(f){return !1}};return b},'es6','es5');$jscomp.polyfill('Reflect.deleteProperty',function(a){if(a){return a}var b=function(c,b){if(!$jscomp.owns(c,b)){return !0}try{return delete c[b]}catch(d){return !1}};return b},'es6','es3');$jscomp.polyfill('Reflect.getOwnPropertyDescriptor',function(a){return a||Object.getOwnPropertyDescriptor},'es6','es5');$jscomp.polyfill('Reflect.getPrototypeOf',function(a){return a||Object.getPrototypeOf},'es6','es5');$jscomp.findDescriptor=function(d,c){var a=d;while(a){var b=Reflect.getOwnPropertyDescriptor(a,c);if(b){return b}a=Reflect.getPrototypeOf(a)}return undefined};$jscomp.polyfill('Reflect.get',function(a){if(a){return a}var b=function(d,c,e){if(arguments.length<=2){return d[c]}var b=$jscomp.findDescriptor(d,c);if(b){return b.get?b.get.call(e):b.value}return undefined};return b},'es6','es5');$jscomp.polyfill('Reflect.has',function(a){if(a){return a}var b=function(c,b){return b in c};return b},'es6','es3');$jscomp.polyfill('Reflect.isExtensible',function(a){if(a){return a}if($jscomp.ASSUME_ES5||typeof Object.isExtensible=='function'){return Object.isExtensible}return function(){return !0}},'es6','es3');$jscomp.polyfill('Reflect.preventExtensions',function(a){if(a){return a}if(!($jscomp.ASSUME_ES5||typeof Object.preventExtensions=='function')){return function(){return !1}}var b=function(b){Object.preventExtensions(b);return !Object.isExtensible(b)};return b},'es6','es3');$jscomp.polyfill('Reflect.set',function(a){if(a){return a}var b=function(b,d,e,f){var c=$jscomp.findDescriptor(b,d);if(!c){if(Reflect.isExtensible(b)){b[d]=e;return !0}return !1}if(c.set){c.set.call(arguments.length>3?f:b,e);return !0}else {if(c.writable&&!Object.isFrozen(b)){b[d]=e;return !0}}return !1};return b},'es6','es5');$jscomp.polyfill('Reflect.setPrototypeOf',function(a){if(a){return a}else {if($jscomp.setPrototypeOf){var b=$jscomp.setPrototypeOf;var c=function(c,d){try{b(c,d);return !0}catch(e){return !1}};return c}else {return null}}},'es6','es5');$jscomp.polyfill('Set',function(b){var c=!$jscomp.ASSUME_NO_NATIVE_SET&&function(){if(!b||!b.prototype.entries||typeof Object.seal!='function'){return !1}try{b=b;var d=Object.seal({x:4});var c=new b($jscomp.makeIterator([d]));if(!c.has(d)||c.size!=1||c.add(d)!=c||c.size!=1||c.add({x:4})!=c||c.size!=2){return !1}var e=c.entries();var a=e.next();if(a.done||a.value[0]!=d||a.value[1]!=d){return !1}a=e.next();if(a.done||a.value[0]==d||a.value[0].x!=4||a.value[1]!=a.value[0]){return !1}return e.next().done}catch(f){return !1}}();if(c){return b}$jscomp.initSymbol();$jscomp.initSymbolIterator();var a=function(a){this.map_=new Map();if(a){var e=$jscomp.makeIterator(a);var c;while(!(c=e.next()).done){var d=c.value;this.add(d)}}this.size=this.map_.size};a.prototype.add=function(a){this.map_.set(a,a);this.size=this.map_.size;return this};a.prototype['delete']=function(c){var a=this.map_['delete'](c);this.size=this.map_.size;return a};a.prototype.clear=function(){this.map_.clear();this.size=0};a.prototype.has=function(a){return this.map_.has(a)};a.prototype.entries=function(){return this.map_.entries()};a.prototype.values=function(){return this.map_.values()};a.prototype.keys=a.prototype.values;a.prototype[Symbol.iterator]=a.prototype.values;a.prototype.forEach=function(c,a){var d=this;this.map_.forEach(function(e){return c.call(a,e,e,d)})};return a},'es6','es3');$jscomp.checkStringArgs=function(a,c,b){if(a==null){throw new TypeError("The 'this' value for String.prototype."+b+' must not be null or undefined')}if(c instanceof RegExp){throw new TypeError('First argument to String.prototype.'+b+' must not be a regular expression')}return a+''};$jscomp.polyfill('String.prototype.codePointAt',function(a){if(a){return a}var b=function(b){var e=$jscomp.checkStringArgs(this,null,'codePointAt');var f=e.length;b=Number(b)||0;if(!(b>=0&&b<f)){return void 0}b=b|0;var c=e.charCodeAt(b);if(c<55296||c>56319||b+1===f){return c}var d=e.charCodeAt(b+1);if(d<56320||d>57343){return c}return (c-55296)*1024+d+9216};return b},'es6','es3');$jscomp.polyfill('String.prototype.endsWith',function(a){if(a){return a}var b=function(b,c){var d=$jscomp.checkStringArgs(this,b,'endsWith');b=b+'';if(c===void 0){c=d.length}var f=Math.max(0,Math.min(c|0,d.length));var e=b.length;while(e>0&&f>0){if(d[--f]!=b[--e]){return !1}}return e<=0};return b},'es6','es3');$jscomp.polyfill('String.fromCodePoint',function(a){if(a){return a}var b=function(e){var c='';for(var d=0;d<arguments.length;d++){var b=Number(arguments[d]);if(b<0||b>1114111||b!==Math.floor(b)){throw new RangeError('invalid_code_point '+b)}if(b<=65535){c+=String.fromCharCode(b)}else {b-=65536;c+=String.fromCharCode(b>>>10&1023|55296);c+=String.fromCharCode(b&1023|56320)}}return c};return b},'es6','es3');$jscomp.polyfill('String.prototype.includes',function(a){if(a){return a}var b=function(b,c){var d=$jscomp.checkStringArgs(this,b,'includes');return d.indexOf(b,c||0)!==-1};return b},'es6','es3');$jscomp.polyfill('String.prototype.repeat',function(a){if(a){return a}var b=function(b){var c=$jscomp.checkStringArgs(this,null,'repeat');if(b<0||b>1342177279){throw new RangeError('Invalid count value')}b=b|0;var d='';while(b){if(b&1){d+=c}if(b>>>=1){c+=c}}return d};return b},'es6','es3');$jscomp.stringPadding=function(c,a){var b=c!==undefined?String(c):' ';if(!(a>0)||!b){return ''}var d=Math.ceil(a/b.length);return b.repeat(d).substring(0,a)};$jscomp.polyfill('String.prototype.padEnd',function(a){if(a){return a}var b=function(d,c){var b=$jscomp.checkStringArgs(this,null,'padStart');var e=d-b.length;return b+$jscomp.stringPadding(c,e)};return b},'es8','es3');$jscomp.polyfill('String.prototype.padStart',function(a){if(a){return a}var b=function(d,c){var b=$jscomp.checkStringArgs(this,null,'padStart');var e=d-b.length;return $jscomp.stringPadding(c,e)+b};return b},'es8','es3');$jscomp.polyfill('String.prototype.startsWith',function(a){if(a){return a}var b=function(b,g){var c=$jscomp.checkStringArgs(this,b,'startsWith');b=b+'';var h=c.length;var e=b.length;var f=Math.max(0,Math.min(g|0,c.length));var d=0;while(d<e&&f<h){if(c[f++]!=b[d++]){return !1}}return d>=e};return b},'es6','es3');$jscomp.arrayFromIterator=function(c){var b;var a=[];while(!(b=c.next()).done){a.push(b.value)}return a};$jscomp.arrayFromIterable=function(a){if(a instanceof Array){return a}else {return $jscomp.arrayFromIterator($jscomp.makeIterator(a))}};$jscomp.inherits=function(a,b){a.prototype=$jscomp.objectCreate(b.prototype);a.prototype.constructor=a;if($jscomp.setPrototypeOf){var e=$jscomp.setPrototypeOf;e(a,b)}else {for(var c in b){if(c=='prototype'){continue}if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);if(d){Object.defineProperty(a,c,d)}}else {a[c]=b[c]}}}a.superClass_=b.prototype};$jscomp.polyfill('WeakSet',function(b){function isConformant(){if(!b||!Object.seal){return !1}try{var c=Object.seal({});var d=Object.seal({});var a=new b([c]);if(!a.has(c)||a.has(d)){return !1}a['delete'](c);a.add(d);return !a.has(c)&&a.has(d)}catch(e){return !1}}if(isConformant()){return b}var a=function(a){this.map_=new WeakMap();if(a){$jscomp.initSymbol();$jscomp.initSymbolIterator();var e=$jscomp.makeIterator(a);var c;while(!(c=e.next()).done){var d=c.value;this.add(d)}}};a.prototype.add=function(a){this.map_.set(a,!0);return this};a.prototype.has=function(a){return this.map_.has(a)};a.prototype['delete']=function(a){return this.map_['delete'](a)};return a},'es6','es3');try{if(Array.prototype.values.toString().indexOf('[native code]')==-1){delete Array.prototype.values}}catch(a){}var Ext=Ext||{};if(!Ext.classic){Ext.classic={}}if(!Ext.classic.toolbar){Ext.classic.toolbar={}}if(!Ext.dd){Ext.dd={}}if(!Ext.draw){Ext.draw={}}if(!Ext.draw.engine){Ext.draw.engine={}}if(!Ext.draw.engine.SvgContext){Ext.draw.engine.SvgContext={}}if(!Ext.draw.gradient){Ext.draw.gradient={}}if(!Ext.draw.modifier){Ext.draw.modifier={}}if(!Ext.draw.overrides){Ext.draw.overrides={}}if(!Ext.draw.overrides.hittest){Ext.draw.overrides.hittest={}}if(!Ext.draw.overrides.hittest.sprite){Ext.draw.overrides.hittest.sprite={}}if(!Ext.draw.plugin){Ext.draw.plugin={}}if(!Ext.draw.sprite){Ext.draw.sprite={}}if(!Ext.overrides){Ext.overrides={}}if(!Ext.overrides.app){Ext.overrides.app={}}if(!Ext.overrides.button){Ext.overrides.button={}}if(!Ext.overrides.container){Ext.overrides.container={}}if(!Ext.overrides.data){Ext.overrides.data={}}if(!Ext.overrides.data.proxy){Ext.overrides.data.proxy={}}if(!Ext.overrides.data.reader){Ext.overrides.data.reader={}}if(!Ext.overrides.dom){Ext.overrides.dom={}}if(!Ext.overrides.event){Ext.overrides.event={}}if(!Ext.overrides.form){Ext.overrides.form={}}if(!Ext.overrides.form.field){Ext.overrides.form.field={}}if(!Ext.overrides.grid){Ext.overrides.grid={}}if(!Ext.overrides.menu){Ext.overrides.menu={}}if(!Ext.overrides.panel){Ext.overrides.panel={}}if(!Ext.overrides.scroll){Ext.overrides.scroll={}}if(!Ext.overrides.util){Ext.overrides.util={}}if(!Ext.overrides.view){Ext.overrides.view={}}if(!Ext.theme){Ext.theme={}}if(!Ext.theme.classic){Ext.theme.classic={}}if(!Ext.theme.classic.grid){Ext.theme.classic.grid={}}if(!Ext.theme.classic.grid.column){Ext.theme.classic.grid.column={}}if(!Ext.theme.classic.grid.plugin){Ext.theme.classic.grid.plugin={}}if(!Ext.theme.gray){Ext.theme.gray={}}if(!Ext.ux){Ext.ux={}}if(!Ext.ux.colorpick){Ext.ux.colorpick={}}var MdsOverrides=MdsOverrides||{};if(!MdsOverrides.overrides){MdsOverrides.overrides={}}if(!MdsOverrides.overrides.window){MdsOverrides.overrides.window={}}var PhotoID=PhotoID||{};var SiteWalk360=SiteWalk360||{};var accountShared=accountShared||{};if(!accountShared.model){accountShared.model={}}if(!accountShared.view){accountShared.view={}}if(!accountShared.view.field){accountShared.view.field={}}var aconex=aconex||{};if(!aconex.model){aconex.model={}}if(!aconex.view){aconex.view={}}if(!aconex.view.aconexwindow){aconex.view.aconexwindow={}}if(!aconex.view.cards){aconex.view.cards={}}if(!aconex.view.form){aconex.view.form={}}var analytics=analytics||{};var bim360=bim360||{};if(!bim360.model){bim360.model={}}if(!bim360.store){bim360.store={}}if(!bim360.view){bim360.view={}}if(!bim360.view.bim360window){bim360.view.bim360window={}}if(!bim360.view.cards){bim360.view.cards={}}var bluebeam=bluebeam||{};if(!bluebeam.model){bluebeam.model={}}if(!bluebeam.view){bluebeam.view={}}if(!bluebeam.view.bluebeamwindow){bluebeam.view.bluebeamwindow={}}if(!bluebeam.view.cards){bluebeam.view.cards={}}var clientFloorplanViewer=clientFloorplanViewer||{};if(!clientFloorplanViewer.view){clientFloorplanViewer.view={}}if(!clientFloorplanViewer.view.main){clientFloorplanViewer.view.main={}}var clientHelp=clientHelp||{};if(!clientHelp.view){clientHelp.view={}}if(!clientHelp.view.helpsequence){clientHelp.view.helpsequence={}}if(!clientHelp.view.helpsequences){clientHelp.view.helpsequences={}}if(!clientHelp.view.newfeature){clientHelp.view.newfeature={}}if(!clientHelp.view.newfeatures){clientHelp.view.newfeatures={}}var clientNavigation=clientNavigation||{};if(!clientNavigation.model){clientNavigation.model={}}if(!clientNavigation.view){clientNavigation.view={}}if(!clientNavigation.view.clientViewport){clientNavigation.view.clientViewport={}}if(!clientNavigation.view.companyandrole){clientNavigation.view.companyandrole={}}if(!clientNavigation.view.fileUploads){clientNavigation.view.fileUploads={}}var clientPunchlist=clientPunchlist||{};if(!clientPunchlist.model){clientPunchlist.model={}}if(!clientPunchlist.store){clientPunchlist.store={}}if(!clientPunchlist.values){clientPunchlist.values={}}if(!clientPunchlist.view){clientPunchlist.view={}}if(!clientPunchlist.view.assignee){clientPunchlist.view.assignee={}}if(!clientPunchlist.view.assignee.assigneefield){clientPunchlist.view.assignee.assigneefield={}}if(!clientPunchlist.view.category){clientPunchlist.view.category={}}if(!clientPunchlist.view.components){clientPunchlist.view.components={}}if(!clientPunchlist.view.detailForm){clientPunchlist.view.detailForm={}}if(!clientPunchlist.view.fixMemberAccess){clientPunchlist.view.fixMemberAccess={}}if(!clientPunchlist.view.location){clientPunchlist.view.location={}}if(!clientPunchlist.view.punchlist){clientPunchlist.view.punchlist={}}if(!clientPunchlist.view.template){clientPunchlist.view.template={}}var comments=comments||{};if(!comments.model){comments.model={}}if(!comments.view){comments.view={}}if(!comments.view.batchaddcomment){comments.view.batchaddcomment={}}if(!comments.view.comments){comments.view.comments={}}var customData=customData||{};if(!customData.fields){customData.fields={}}var files=files||{};if(!files.model){files.model={}}var filters=filters||{};if(!filters.view){filters.view={}}var floorplanList=floorplanList||{};if(!floorplanList.store){floorplanList.store={}}if(!floorplanList.view){floorplanList.view={}}var floorplanViewer=floorplanViewer||{};if(!floorplanViewer.controller){floorplanViewer.controller={}}if(!floorplanViewer.model){floorplanViewer.model={}}if(!floorplanViewer.store){floorplanViewer.store={}}if(!floorplanViewer.view){floorplanViewer.view={}}if(!floorplanViewer.view.files){floorplanViewer.view.files={}}if(!floorplanViewer.view.files.fileViewer){floorplanViewer.view.files.fileViewer={}}if(!floorplanViewer.view.files.multivistaPhoto){floorplanViewer.view.files.multivistaPhoto={}}if(!floorplanViewer.view.files.photoFileViewer){floorplanViewer.view.files.photoFileViewer={}}if(!floorplanViewer.view.floorplanViewer){floorplanViewer.view.floorplanViewer={}}if(!floorplanViewer.view.punchlistLocation){floorplanViewer.view.punchlistLocation={}}if(!floorplanViewer.view.pushpinFlyout){floorplanViewer.view.pushpinFlyout={}}var formShared=formShared||{};if(!formShared.model){formShared.model={}}if(!formShared.plugin){formShared.plugin={}}if(!formShared.view){formShared.view={}}if(!formShared.view.components){formShared.view.components={}}if(!formShared.view.grid){formShared.view.grid={}}if(!formShared.view.integrations){formShared.view.integrations={}}var mdsData=mdsData||{};if(!mdsData.model){mdsData.model={}}if(!mdsData.store){mdsData.store={}}var mdsOverrides=mdsOverrides||{};if(!mdsOverrides.overrides){mdsOverrides.overrides={}}if(!mdsOverrides.overrides.window){mdsOverrides.overrides.window={}}var mdsPreferences=mdsPreferences||{};var mdsUtil=mdsUtil||{};var mdsWidget=mdsWidget||{};if(!mdsWidget.view){mdsWidget.view={}}var multiupload=multiupload||{};var mvstr=mvstr||{};var notifications=notifications||{};if(!notifications.model){notifications.model={}}if(!notifications.view){notifications.view={}}if(!notifications.view.NotificationBell){notifications.view.NotificationBell={}}var permissions=permissions||{};if(!permissions.view){permissions.view={}}var photoActions=photoActions||{};if(!photoActions.controller){photoActions.controller={}}if(!photoActions.model){photoActions.model={}}if(!photoActions.store){photoActions.store={}}if(!photoActions.view){photoActions.view={}}if(!photoActions.view.addPhotosToAlbum){photoActions.view.addPhotosToAlbum={}}if(!photoActions.view.photosettings){photoActions.view.photosettings={}}if(!photoActions.view.widget){photoActions.view.widget={}}var photoViewer=photoViewer||{};if(!photoViewer.controller){photoViewer.controller={}}if(!photoViewer.dd){photoViewer.dd={}}if(!photoViewer.draw){photoViewer.draw={}}if(!photoViewer.draw.engine){photoViewer.draw.engine={}}if(!photoViewer.draw.layout){photoViewer.draw.layout={}}if(!photoViewer.model){photoViewer.model={}}if(!photoViewer.store){photoViewer.store={}}if(!photoViewer.view){photoViewer.view={}}if(!photoViewer.view.addphotostoalbum){photoViewer.view.addphotostoalbum={}}if(!photoViewer.view.annotations){photoViewer.view.annotations={}}if(!photoViewer.view.annotations.shapes){photoViewer.view.annotations.shapes={}}if(!photoViewer.view.annotations.sprites){photoViewer.view.annotations.sprites={}}if(!photoViewer.view.annotations.tools){photoViewer.view.annotations.tools={}}if(!photoViewer.view.annotations.widget){photoViewer.view.annotations.widget={}}if(!photoViewer.view.exif){photoViewer.view.exif={}}if(!photoViewer.view.mainpanel){photoViewer.view.mainpanel={}}if(!photoViewer.view.measurements){photoViewer.view.measurements={}}if(!photoViewer.view.pannellum){photoViewer.view.pannellum={}}if(!photoViewer.view.photo){photoViewer.view.photo={}}if(!photoViewer.view.photocontainer){photoViewer.view.photocontainer={}}if(!photoViewer.view.photomenu){photoViewer.view.photomenu={}}if(!photoViewer.view.photoviewer){photoViewer.view.photoviewer={}}if(!photoViewer.view.positioncontrols){photoViewer.view.positioncontrols={}}if(!photoViewer.view.sidepanel){photoViewer.view.sidepanel={}}if(!photoViewer.view.sidepanel.photoviewerannotationspane){photoViewer.view.sidepanel.photoviewerannotationspane={}}if(!photoViewer.view.sidepanel.photoviewermeasurementspane){photoViewer.view.sidepanel.photoviewermeasurementspane={}}if(!photoViewer.view.topbar){photoViewer.view.topbar={}}if(!photoViewer.view.webcam){photoViewer.view.webcam={}}var planGrid=planGrid||{};if(!planGrid.model){planGrid.model={}}if(!planGrid.store){planGrid.store={}}if(!planGrid.view){planGrid.view={}}if(!planGrid.view.cards){planGrid.view.cards={}}if(!planGrid.view.form){planGrid.view.form={}}if(!planGrid.view.plangridwindow){planGrid.view.plangridwindow={}}var procore=procore||{};if(!procore.model){procore.model={}}if(!procore.store){procore.store={}}if(!procore.view){procore.view={}}if(!procore.view.cards){procore.view.cards={}}if(!procore.view.cards.dailylogs){procore.view.cards.dailylogs={}}if(!procore.view.form){procore.view.form={}}if(!procore.view.procorefloorplanexport){procore.view.procorefloorplanexport={}}if(!procore.view.procorewindow){procore.view.procorewindow={}}var sharedLookup=sharedLookup||{};if(!sharedLookup.model){sharedLookup.model={}}if(!sharedLookup.model.date){sharedLookup.model.date={}}if(!sharedLookup.store){sharedLookup.store={}}if(!sharedLookup.store.date){sharedLookup.store.date={}}if(!sharedLookup.view){sharedLookup.view={}}if(!sharedLookup.view.date){sharedLookup.view.date={}}if(!sharedLookup.view.follow){sharedLookup.view.follow={}}var siteWalk360=siteWalk360||{};var viewerPhoto=viewerPhoto||{};if(!viewerPhoto.model){viewerPhoto.model={}}var webcamShared=webcamShared||{};if(!webcamShared.view){webcamShared.view={}}if(!webcamShared.view.PTZ){webcamShared.view.PTZ={}}Ext.define('Ext.overrides.Ajax',{override:'Ext.Ajax',timeout:60000,request:function(a){if(!a){a={}}if(a.useDefaultXhrHeader===undefined){a.useDefaultXhrHeader=!1}if(a.withCredentials===undefined){a.withCredentials=!0}if(a.url&&!a.url.match(/:\/\//)){a.url=mdslink.server+a.url}if(!a||!a.successCallback&&!a.useDefaults){return this.callParent(arguments)}var b={url:undefined,params:{},successCallback:undefined,noResponseCallback:undefined,afterFailMessageCallback:undefined,disableCaching:!0,timeout:Ext.Ajax.timeout};if(a.mask){if(typeof a.mask=='string'){Ext.getBody().mask(a.mask)}else {Ext.getBody().mask()}}for(var c in a){if(a.hasOwnProperty(c)){b[c]=a[c]}}if(b.successCallback&&a.scope){b.successCallback=Ext.bind(b.successCallback,a.scope)}if(b.afterFailMessageCallback&&a.scope){b.afterFailMessageCallback=Ext.bind(b.afterFailMessageCallback,a.scope)}b.callback=function(f,g,d){if(a.mask){Ext.getBody().unmask()}try{var c=Ext.decode(d.responseText)}catch(h){var e=d.responseText.match('Client Login')?window.mvstr?mvstr.G_LoginRequired:'User login required.':window.mvstr?mvstr.G_UnexpectedError:'An unexpected error has occurred.';if(!a.noAlert){Ext.Msg.alert(window.mvstr?mvstr.G_Error:'Error',e)}if(b.afterFailMessageCallback){b.afterFailMessageCallback(null,e)}return}if(c){if(!c.success&&c.success!==undefined){if(c.message!=''&&!a.noAlert){Ext.Msg.alert(' ',c.message)}else {if(!a.noAlert){Ext.Msg.alert(window.mvstr?mvstr.G_Error:'An unexpected error has occurred.',window.mvstr?mvstr.G_UnexpectedError:'An unexpected error has occurred.')}}if(b.afterFailMessageCallback){b.afterFailMessageCallback(c.data,c.message)}}else {if(b.successCallback){b.successCallback(c.data!==undefined?c.data:c)}}}else {if(b.noResponseCallback){b.noResponseCallback()}}};return this.callParent([b])},postFormData:function(e,b,a){var c=Ext.create('Ext.form.Panel',{standardSubmit:!0,url:e});for(var d in b){c.add({xtype:'textfield',name:d,value:b[d]})}if(a===undefined){a={}}c.submit(a)}});Ext.define('Ext.overrides.event.Event',{override:'Ext.event.Event',getWheelDeltas:function(){var d=this,a=d.browserEvent,c=0,b=0;if(Ext.isDefined(a.wheelDeltaX)){c=a.wheelDeltaX;b=a.wheelDeltaY}else {if(a.wheelDelta){b=a.wheelDelta}else {if(a.detail){b=-a.detail;if(b>100){b=3}else {if(b<-100){b=-3}}if(Ext.isDefined(a.axis)&&a.axis===a.HORIZONTAL_AXIS){c=b;b=0}}else {if(a.deltaX||a.deltaY){c=a.deltaX*-1;b=a.deltaY*-1}}}}return {x:d.correctWheelDelta(c),y:d.correctWheelDelta(b)}}});Ext.define('Ext.overrides.util.MixedCollection',{override:'Ext.util.MixedCollection',add:function(a,b){if(arguments.length===1&&typeof a=='object'&&a.isController){return (arguments.callee.$previous||Ext.util.AbstractMixedCollection.prototype.add).call(this,a.$className,a)}return (arguments.callee.$previous||Ext.util.AbstractMixedCollection.prototype.add).apply(this,arguments)}});Ext.define('Ext.overrides.dom.Element',{override:'Ext.dom.Element',setStyle:function(b,a){if(!this.dom){return}return arguments.callee.$previous.apply(this,arguments)}});Ext.define('Ext.overrides.util.Format',{override:'Ext.util.Format',fileSize:function(a){if(a==0){return ''}return this.callParent(arguments)},date:function(b,a){if(a.substr(0,5)=='DATE_'){a=mvstr[a]}return this.callParent([b,a])}});if(!window.config){window.config={}}config.ISARCHIVE=!0;Ext.cmd.derive('Ext.MDSLink',Ext.Base,{statics:{links:{adminCompanyMembersList:'/index.cfm?fuseaction=companyadmin.memberlist&',adminMegaViewer:'/index.cfm?fuseaction=aAdminMegaViewer.home&',adminMembersList:'/index.cfm?fuseaction=memberadmin.list',adminProjectAdd:'/index.cfm?fuseaction=aAdmin.projectAdd',adminProjectGrid:'/index.cfm?fuseaction=aAdmin.projectgrid&',adminProjectList:'/index.cfm?fuseaction=aAdmin.projectlist&',adminProjectsMap:'/index.cfm?fuseaction=aAdmin.projectMaplist&',adminProjectMembersList:'/index.cfm?fuseaction=memberadmin.projectlist&',adminScheduler:'index.cfm?fuseaction=aAdmin.adminScheduler',adminSpecialPlans:'/index.cfm?fuseaction=aAdminPlan.admin&',adminVideo:'/index.cfm?fuseaction=aAdminVideo.home&',adminWebcamProjectGrid:'/index.cfm?fuseaction=aAdminWebcam.projectGrid&',adminWebcamGrid:'/index.cfm?fuseaction=aAdminWebcam.grid',adminWebcamThumb:'/index.cfm?fuseaction=aAdminWebcam.thumb',adminUserAdd:'/index.cfm?fuseaction=aAdmin.addUser',adminUserEdit:'/index.cfm?fuseaction=aAdmin.editUser&',client3DImmersive:'/index.cfm?fuseaction=aClient3DImmersive.home&',client3DImmersiveViewer:'/index.cfm?fuseaction=aClient3DImmersive.view&',clientAccount:'/index.cfm?fuseaction=aClientDashboard.home#account',clientNotifications:'/index.cfm?fuseaction=aClientDashboard.home#notifications',clientDashboard:'/index.cfm?fuseaction=aClientDashboard.home',clientFileManager:'/index.cfm?fuseaction=aClientFileManager.view&',clientFloorplanOverview:'/index.cfm?fuseaction=aClientFloorplanOverview.home&',clientFloorplanOverview_workingPlans:'/index.cfm?fuseaction=aClientFloorplanOverview.workingPlans&',clientPunchlistPlans:'/index.cfm?fuseaction=aClientPunchlist.plans&',clientFloorplanViewer:'/index.cfm?fuseaction=aClientFloorplanViewer.view&',clientFloorplanViewer_punchlistPlan:'/index.cfm?fuseaction=aClientFloorplanViewer.view&',clientMegaViewer:'/index.cfm?fuseaction=aClientMegaViewer.home&',clientPeopleOverview:'/index.cfm?fuseaction=aClientPeopleOverview.home&',clientPhotoList:'/index.cfm?fuseaction=aClientPhotoList.home&',clientPhotoViewer:'/index.cfm?fuseaction=aClientPhotoViewer.view&',clientPunchlistOverview_Base:'/index.cfm?fuseaction=aClientPunchlist.view&',clientPunchlistEntry:'/index.cfm?fuseaction=aClientPunchlist.entry&',clientTagSearch:'/index.cfm?fuseaction=aClientTagSearch.home&',clientUserAdd:'/index.cfm?fuseaction=aClientPeopleOverview.addUser&',clientVideo:'/index.cfm?fuseaction=aClientVideo.home&',clientWebcamLive:'/index.cfm?fuseaction=aClientWebcam.live&',clientWebcamGridView:'/index.cfm?fuseaction=aClientWebcam.grid&',clientWebcamOverview:'/index.cfm?fuseaction=aClientWebcam.home&',clientWebcamTimelapse:'/index.cfm?fuseaction=aClientWebcam.timelapse&',home:'/index.cfm?fuseaction=home.gateway',logout:'/index.cfm?fuseaction=member.logout',profile:'/index.cfm?fuseaction=member.profileform',projectAnalytics:'/index.cfm?fuseaction=projectadmin.analytics&',projectGateway:'/index.cfm?fuseaction=aClientNavigation.ProjectGateway&',projectEdit:'/index.cfm?fuseaction=projectadmin.navigation_tiled&',projectEditJump:'/index.cfm?fuseaction=aClientNavigation.adminEditJump&',projectView:'/index.cfm?fuseaction=aClientNavigation.adminviewjump&',publicWebcamEmbed:'/index.cfm?fuseaction=aPublicWebcam.embed&',publicWebcamPage:'/index.cfm?fuseaction=aPublicWebcam.page&',notificationLink:'/index.cfm?fuseaction=aNotifications.link&'}},singleton:!0,constructor:function(){this.callParent(arguments);window.mdslink=this.self.links;mdslink.server='';if(window.config&&config.ISARCHIVE){mdslink.clientFileManager='fileManager.htm?';mdslink.clientFloorplanOverview='floorplanOverview.htm?';mdslink.clientFloorplanViewer='floorplanViewer.htm?';mdslink.clientVideo='clientVideo.htm?';mdslink.clientPeopleOverview='peopleOverview.htm?';mdslink.clientPhotoList='photoList.htm?';mdslink.clientPhotoViewer='photoViewerNew.htm?';mdslink.clientWebcamOverview='webcamOverview.htm?';mdslink.clientWebcamTimelapse='webcamTimelapse.htm?';mdslink.projectGateway=mdslink[config.GATEWAY];mdslink.home='../index.htm'}mdslink.clientPunchlistOverview=mdslink.clientPunchlistOverview_Base+'ListTypeID=1&';mdslink.clientPunchlistOverview_QAQCList=mdslink.clientPunchlistOverview_Base+'ListTypeID=2&';mdslink.clientPunchlistOverview_FMList=mdslink.clientPunchlistOverview_Base+'ListTypeID=3&'}},1,0,0,0,0,0,[Ext,'MDSLink'],0);Ext.cmd.derive('mdsOverrides.mvstr',Ext.Base,{'singleton':!0,'alternateClassName':'mvstr'},0,0,0,0,0,0,[mdsOverrides,'mvstr',0,'mvstr'],0);Ext.define('Ext.overrides.Template',{override:'Ext.Template',constructor:function(h){arguments.callee.$previous.apply(this,arguments);var c=this.html.match(/\{mdslink_[^\{]+\}/g),b=this.html.match(/mvstr\[[^\]]+\]/g);if(c){for(var a=0;a<c.length;a++){var d=c[a],e=d.match(/\{mdslink_([^\{]+)\}/)[1],g=mdslink[e]?mdslink[e]:'';this.html=this.html.replace(d,g)}}if(b){for(var a=0;a<b.length;a++){var f=b[a].match(/mvstr\[([^\]]+)\]/)[1];this.html=this.html.replace(b[a],mvstr[f])}}}});Ext.define('Ext.overrides.scroll.Scroller',{override:'Ext.scroll.Scroller',privates:{restoreState:function(){if(!this.mvDisableRestoreState){return arguments.callee.$previous.apply(this,arguments)}}}});Ext.define('Ext.theme.classic.Component',{override:'Ext.Component'},function(){Ext.namespace('Ext.theme.is').Classic=!0;Ext.theme.name='Classic'});Ext.define('Ext.theme.gray.Component',{override:'Ext.Component'},function(){Ext.namespace('Ext.theme.is').Gray=!0;Ext.theme.name='Gray'});Ext.define('Ext.overrides.Component',{override:'Ext.Component',privates:{applyBind:function(a,j){for(var c in a){if(typeof a[c]=='object'){continue}var e=a[c].match(/\{mdslink_[^\{]+\}/g),d=a[c].match(/mvstr\[[^\]]+\]/g);if(d){for(var b=0;b<d.length;b++){var h=d[b].match(/mvstr\[([^\]]+)\]/)[1];a[c]=a[c].replace(d[b],mvstr[h])}}if(e){for(var b=0;b<e.length;b++){var f=e[b],g=f.match(/\{mdslink_([^\{]+)\}/)[1],i=mdslink[g]?mdslink[g]:'';a[c]=a[c].replace(f,i)}}}return arguments.callee.$previous.apply(this,arguments)}},config:{mvPreloadImages:null,loadMaskCls:null,maskCls:null},removeCls:function(){var a=this,b=a.rendered?a.el:a.protoEl;if(b){b.removeCls.apply(b,arguments)}return a},addCls:function(c){var a=this,b=a.rendered?a.el:a.protoEl;if(b){b.addCls.apply(b,arguments)}return a},updateMvPreloadImages:function(a){if(a){for(var b=0;b<a.length;b++){var c=new Image();c.src=a[b]}}},setLoading:function(){var a=arguments.callee.$previous.apply(this,arguments),b=this.getLoadMaskCls();if(a&&b){a.el.addCls(b)}return a},mask:function(){arguments.callee.$previous.apply(this,arguments);var a=this.getMaskCls();if(a){var c=this.getMaskTarget()||this.el,d=c.getData(),b=d.maskEl;b.addCls(a)}},constructor:function(b){b=b||{};var c=Ext.clone(this.config.localized)||Ext.clone(this.localized)||{};c=Ext.merge(c,b.localized||{});var j=this,a,h=/mvstr\[[^\]]+\]/g;if(Ext.isObject(c)){for(var d in c){if(b[d]!==undefined){continue}a=c[d];if(a&&typeof a=='string'){if(mvstr[a]){b[d]=mvstr[a]}else {if(a.match(h)){var g=a.match(h);for(var f=0;f<g.length;f++){var i=g[f].match(/mvstr\[([^\]]+)\]/)[1];a=a.replace(g[f],mvstr[i])}b[d]=a}else {console.error('Missing translation ('+mvstr.LanguageID+") for key '"+a+"'.")}}}else {if(typeof a=='object'){var e=a[mvstr.LanguageID];if(e===undefined){e=a['default']}if(e!==undefined){b[d]=e}}}}}arguments.callee.$previous.call(this,b)}});Ext.define('Ext.overrides.data.Field',{override:'Ext.data.Field',constructor:function(a){var c=['ProjectUID','ListTypeID'];if(mdslink[a.name]){a.defaultValue=mdslink[a.name]}else {if(Ext.Array.contains(c,a.name)){var b=Ext.Object.fromQueryString(document.location.search);if(b[a.name]){a.defaultValue=b[a.name]}}}arguments.callee.$previous.apply(this,arguments)}});Ext.define('Ext.overrides.data.Model',{override:'Ext.data.Model',privates:{statics:{initFields:function(d,e,b){var c=this,a;c.callParent(arguments);a=b.idField;a.defaultValue=a.convert?undefined:null;a.defaultValue=a.calculate?undefined:null}}},save:function(a){if(!a){a={}}var c=a.success?a.success:a.silentSuccess?Ext.emptyFn:function(){Ext.Msg.alert(window.mvstr?mvstr.G_Success:'Success',window.mvstr?mvstr.G_SuccessMsg:'Changes were successfully saved.')},b=a.afterFailMessageCallback?a.afterFailMessageCallback:Ext.emptyFn;if(a.scope){c=Ext.bind(c,a.scope);b=Ext.bind(b,a.scope)}if(!a.failure){a.failure=function(f,d){var e=window.mvstr?mvstr.G_UnexpectedError:'An unexpected error has occurred.';try{var c=Ext.JSON.decode(d.getResponse().responseText).message;if(c){e=c}}catch(g){}Ext.Msg.alert(window.mvstr?mvstr.G_Error:'Error',e);b(f,d)}}a.success=function(d,b){try{var e=Ext.JSON.decode(b.getResponse().responseText).data}catch(f){a.failure(d,b);return}c(d,b,e)};arguments.callee.$previous.call(this,a)}});Ext.define('Ext.overrides.data.proxy.Ajax',{override:'Ext.data.proxy.Ajax',timeout:60000,config:{useDefaultXhrHeader:!1,withCredentials:!0,reader:{type:'json',messageProperty:'message'},writer:{writeAllFields:!0}},constructor:function(a){if(a&&a.url&&!a.url.match('^'+mdslink.server)&&!a.url.match(/:\/\//)){a.url=mdslink.server+a.url}(arguments.callee.$previous||Ext.data.proxy.Server.prototype.constructor).apply(this,arguments)},processResponse:function(){var a=this.getReader();if(a&&a.mvMessage){delete a.mvMessage}return (arguments.callee.$previous||Ext.data.proxy.Server.prototype.processResponse).apply(this,arguments)}});Ext.define('Ext.overrides.data.reader.Json',{override:'Ext.data.reader.Json',extractRecord:function(k,h,i,j,g){if(!this.getFields){return (arguments.callee.$previous||Ext.data.reader.Reader.prototype.extractRecord).apply(this,arguments)}var a=(arguments.callee.$previous||Ext.data.reader.Reader.prototype.extractRecord).apply(this,arguments);var d=this.getModel().idProperty,c=this.getFields();for(var b=0,f=c.length;b<f;b++){if(c[b].name==d){var e=c[b].calculate;if(e){a.set(d,e(a.getData()));return a}}}return a}});Ext.define('Ext.overrides.data.Store',{override:'Ext.data.Store',proxy:{type:'ajax',reader:{type:'json',transform:{fn:function(a){this.mvMessage=a&&a.message?a.message:'';return a}}}},constructor:function(a){if(this.config&&typeof this.config.proxy=='string'||a&&typeof a.proxy=='string'){(arguments.callee.$previous||Ext.data.ProxyStore.prototype.constructor).apply(this,arguments);return}var b=undefined,c=undefined,d=undefined;if(this.config&&this.config.proxy&&this.config.proxy.reader&&this.config.proxy.reader.rootProperty!==undefined){b=this.config.proxy.reader.rootProperty}if(a&&a.proxy&&a.proxy.reader&&a.proxy.reader.rootProperty!==undefined){b=a.proxy.reader.rootProperty}if(this.config&&this.config.root){c=this.config.root}if(a&&a.root){c=a.root}if(this.config&&this.config.type){d=this.config.type}if(a&&a.type){d=a.type}if(!c&&b===undefined&&d!='tree'){if(!a){a={}}if(!a.proxy){a.proxy={}}if(!a.proxy.reader){a.proxy.reader={}}a.proxy.reader.rootProperty='data'}(arguments.callee.$previous||Ext.data.ProxyStore.prototype.constructor).call(this,a);if(a&&a.mvCanAbort||this.config&&this.mvCanAbort){this.addListener('beforeload',function(c,b){c.mvLastOperation=b},this)}},mvAbort:function(){if(this.loading&&this.mvLastOperation){var a=Ext.Ajax.requests;for(var b in a){if(a.hasOwnProperty(b)&&a[b].options.operation==this.mvLastOperation){Ext.Ajax.abort(a[b]);delete a[b];return}}}},sync:function(a){if(!a){a={}}var b=a.silentSuccess!==undefined?a.silentSuccess:!!this.silentSuccess;if(!a.success&&!b&&!a.noAlert){a.success=function(){Ext.Msg.alert(window.mvstr?mvstr.G_Success:'Success',window.mvstr?mvstr.G_SuccessMsg:'Changes were successfully saved.')}}if(!a.failure){a.failure=function(d){var e=d.proxy.getReader().mvMessage,c=e?e:window.mvstr?mvstr.G_UnexpectedError:'An unexpected error has occurred.',b=d.getOperations()[0];if(b&&b.error&&typeof b.error==='string'){c=b.error}if(!a.noAlert){Ext.Msg.alert(window.mvstr?mvstr.G_Error:'Error',c)}if(a.afterFailMessageCallback){a.afterFailMessageCallback.call(a.scope||window,d,c)}}}var c=this.getNewRecords().length||this.getUpdatedRecords().length||this.getRemovedRecords().length?!0:!1;(arguments.callee.$previous||Ext.data.ProxyStore.prototype.sync).call(this,a);return c},refreshFilters:function(){var a=this.filters?this.filters.getRange():[];if(a.length==0){this.clearFilter(!1);return}this.clearFilter(!0);for(var b=0;b<a.length;b++){this.addFilter(a[b])}},reset:function(){this.clearFilter();this.removeAll(!0);this.loadCount=0}});Ext.cmd.derive('mdsPreferences.Local',Ext.Base,{identification:null,initializeIdentification:Ext.emptyFn,showLog:!1,getStorage:function(a){a=this.getIdentification();var d=Ext.Array.sort(Ext.Object.getKeys(a)),c=[];for(var b=0;b<d.length;b++){c.push(a[d[b]])}var e=c.join('');if(!e){throw 'Need to identify storage'}return Ext.util.LocalStorage.get(e)},getIdentification:function(a){if(!a){a=this.identification}if(!a){throw 'Need to identify storage'}return a},logActivity:function(a,c,d){var b=a!='Removed'},getListValue:function(b,d){var c=this.getStorage(this.getIdentification(d)),a=c.getItem(b);a=a?a.split(','):[];this.logActivity('Retrieved',b,a);c.release();return a},setListValue:function(a,e,d){var b=this.getStorage(this.getIdentification(d)),c=e.join(',');b.setItem(a,c);this.logActivity('Set',a,c);b.release()},getValue:function(a,d){var b=this.getStorage(this.getIdentification(d)),c=b.getItem(a);this.logActivity('Retrieved',a,c);b.release();return c},setValue:function(a,c,d){var b=this.getStorage(this.getIdentification(d));b.setItem(a,c);this.logActivity('Set',a,c);b.release()},removeValue:function(a,c){var b=this.getStorage(this.getIdentification(c));b.removeItem(a);this.logActivity('Removed',a);b.release()},getNumericValue:function(b,d){var c=this.getStorage(this.getIdentification(d)),a=c.getItem(b);a=a!==undefined?Number(a):undefined;this.logActivity('Retrieved',b,a);c.release();return a},getBooleanValue:function(d,c){var b=this.getStorage(this.getIdentification(c)),a=b.getItem(d);a=a===null?undefined:a=='true'?!0:!1;b.release();return a},setBooleanValue:function(b,c,a){this.setValue(b,c,a)},getDateValue:function(e,d,b){var c=this.getStorage(this.getIdentification(d)),a=c.getItem(e);b=b||'Y-m-d';a=a===null?undefined:Ext.Date.parse(a,b);c.release();return a||null},setDateValue:function(c,d,b,a){a=a||'Y-m-d';this.setValue(c,Ext.Date.format(d,a),b)},getObjectValue:function(b,d){var c=this.getStorage(this.getIdentification(d)),a=c.getItem(b);try{a=Ext.decode(a)}catch(e){a={}}this.logActivity('Retrieved',b,a);c.release();return a},setObjectValue:function(a,c,d){var b=this.getStorage(this.getIdentification(d));b.setItem(a,Ext.encode(c));this.logActivity('Set',a,c);b.release()}},0,0,0,0,0,0,[mdsPreferences,'Local'],0);Ext.cmd.derive('mdsPreferences.GlobalPreferences',mdsPreferences.Local,{singleton:!0,getStorage:function(a){a=a||this.getIdentification();return Ext.util.LocalStorage.get(a)},getIdentification:function(){return 'MDS'},getLang:function(){return this.getValue('lang')},setLang:function(a){this.setValue('lang',a)},removeLang:function(){this.removeValue('lang')}},0,0,0,0,0,0,[mdsPreferences,'GlobalPreferences'],0);Ext.define('Ext.overrides.app.Application',{override:'Ext.app.Application',onProfilesReady:function(){var a=this;if(a.mvInitLocale===undefined){a.mvInitLocale=!0}if(!a.mvInitLocale||a.mvLanguageInitialized){return arguments.callee.$previous.apply(this,arguments)}else {a.initLang().then(function(){a.mvLanguageInitialized=!0;a.onProfilesReady()})}},getLang:function(){return new Ext.Promise(Ext.bind(function(a){var b='en',e=!!this.getName().match(/^public/),g=!!this.getName().match(/^admin/),f=!!this.getName().match(/^render/);if(e||g||f){a(b)}var d=Ext.Object.fromQueryString(document.location.search).lang,c=d||mdsPreferences.GlobalPreferences.getLang();if(c){a(c)}else {Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientNavigation.getLanguagePreference',scope:this,successCallback:function(b){mdsPreferences.GlobalPreferences.setLang(b);a(b)},failure:function(){mdsPreferences.GlobalPreferences.setLang(b);a(b)},noAlert:!0},this)}},this))},initLang:function(){return new Ext.Promise(Ext.bind(function(a){this.getLang().then(function(b){if(window.moment){moment.locale(b)}var c='mds/locale/'+b+'/ext-locale.js';Ext.Loader.loadScript({url:c});Ext.Loader.loadScript({url:'mds/locale/'+b+'/translation.js'});Ext.Loader.onReady(a)})},this))}});Ext.define('Ext.overrides.app.ViewController',{override:'Ext.app.ViewController'});Ext.define('Ext.overrides.data.Batch',{override:'Ext.data.Batch',getError:function(){if(this.hasException){return this.getExceptions()[0].getError()}return null}});Ext.define('Ext.overrides.app.ViewModel',{override:'Ext.app.ViewModel',constructor:function(a){var o=['ProjectUID','Model3DID','FloorplanUID','GetWorkingPlans','ListTypeID','ProjectID','SearchString','PunchItemID','PushpinUID','ClosedView','ListTypeID','PunchStatusID','HotspotID','SNID1','SNID2','SAID1','SAID2','DroneDeployPlanID','planID','CompanyUID'],i=Ext.Object.fromQueryString(document.location.search);if(!a){a={}}Ext.applyIf(a,this.config);if(!a.data){a.data={}}Ext.applyIf(a.data,this.config.data||{});if(!a.mvRecords){a.mvRecords={}}Ext.applyIf(a.mvRecords,this.config.mvRecords||{});if(!a.formulas){a.formulas={}}Ext.applyIf(a.formulas,this.config.formulas||{});if(!a.stores){a.stores={}}Ext.applyIf(a.stores,this.config.stores||{});for(var c in a.data){var e=c.match(/^mdslink_(.+)$/);if(e){a.data[c]=mdslink[e[1]]}else {if(typeof a.data[c]=='object'){for(var l in a.data[c]){var e=l.match(/^mdslink_(.+)$/);if(e){a.data[c][l]=mdslink[e[1]]}}}else {if(Ext.Array.contains(o,c)&&a.data[c]===''){for(var j in i){if(j.toLowerCase()==c.toLowerCase()){a.data[c]=i[j];if(!isNaN(a.data[c])){a.data[c]=Number(a.data[c])}break}}}}}}for(var g in a.mvRecords){var k=a.mvRecords[g],n=g,d=k.idName,h='_record'+n;if(typeof d=='string'){d=[d]}if(a.formulas[g]){continue}a.data[h]=null;var m={record:'{'+h+'}',recordName:h,modelName:k.modelName,idName:d};for(var f=0;f<d.length;f++){m['id'+f]='{'+d[f]+'}'}a.formulas[n]={bind:m,get:this.mvRecordFn}}if(!a.data){a.data={}}for(var b in a.stores){if(a.stores[b].mvAutoLoadVars){a.stores[b].name=b;if(!a.stores[b].listeners){a.stores[b].listeners={}}a.stores[b].listeners.load={fn:this.mvAutoLoadVarOnLoad,scope:'controller'};a.stores[b].listeners.beforeload={fn:this.mvAutoLoadVarBeforeLoad,scope:'controller'};a.data['_'+b+'Loaded']=!1}if(a.stores[b].mvAutoDataChangedVar){a.stores[b].name=b;if(!a.stores[b].listeners){a.stores[b].listeners={}}a.stores[b].listeners.datachanged={fn:this.mvAutoDataChangedVarOnDataChanged,scope:'controller'};a.data['_'+b+'DataChanged']=-1}}arguments.callee.$previous.call(this,a)},mvRecordFn:function(a){var b=a.record,d={};if(b){return b}for(var c=0;c<a.idName.length;c++){if(!a['id'+c]){return null}d[a.idName[c]]=a['id'+c]}b=Ext.create(a.modelName);b.getProxy().setExtraParams(d);b.load({success:function(){if(!this.isDestroyed){this.set(a.recordName,b)}},scope:this})},mvAutoLoadVarOnLoad:function(a){this.getViewModel().set('_'+a.name+'Loaded',!0)},mvAutoLoadVarBeforeLoad:function(a){this.getViewModel().set('_'+a.name+'Loaded',!1)},mvAutoDataChangedVarOnDataChanged:function(c){var a='_'+c.name+'DataChanged',b=this.getViewModel();if(c.isLoaded()&&b.get(a)==-1){b.set(a,0)}else {b.set(a,(new Date()).getTime())}},doArrayPush:function(a,c){var b=this.get(a);b.push(c);this.set(a,Ext.Array.clone(b))},doArrayPop:function(a){var b=this.get(a),c=b.pop();this.set(a,Ext.Array.clone(b));return c},doArrayRemove:function(a){var b=this.get(a),c=b.pop();this.set(a,Ext.Array.clone(b));return c}});Ext.define('Ext.overrides.ZIndexManager',{override:'Ext.ZIndexManager',privates:{showModalMask:function(a){var b=this,f=a.el,d=a.maskParent||a.floatParent,e=d?d.getEl():a.container,c=b.mask;if(!c){b.mask=c=Ext.getBody().createChild({role:'presentation',cls:'x-mask x-border-box'+(a.modalMaskCls?' '+a.modalMaskCls:''),style:'height:0;width:0'});c.setVisibilityMode(Ext.Element.DISPLAY);c.on({mousedown:b.onMaskMousedown,click:b.onMaskClick,scope:b})}else {b.hideModalMask()}c.maskTarget=e;e.saveTabbableState({excludeRoot:f});b.syncModalMask(a)}}});Ext.define('Ext.overrides.container.Container',{override:'Ext.container.Container',privates:{repositionFloatingItems:function(){var b=this.floatingItems,d,c,a;if(b){b=b.items;d=b.length;for(c=0;c<d;c++){a=b[c];if(a.el&&!a.hidden&&!a.noRepositionFloatingItems){a.setPosition(a.x,a.y)}}}}},getComponent:function(a){if(Ext.isObject(a)){a=a.getItemId()}var b=this.items?this.items.get(a):null,c=this.floatingItems;if(!b&&c&&typeof a!=='number'){b=c.get(a)}return b},getRefItems:function(){if(!this.items){return []}return arguments.callee.$previous.apply(this,arguments)}});Ext.define('Ext.overrides.button.Button',{override:'Ext.button.Button',focusCls:'',setUi:function(a){if(a!==undefined){this.setUI(a)}},setUI:function(b){var a=this,c=a.activeUI;if(a.scale&&b&&!b.match(a.scale)){b=b+'-'+a.scale}if(b===c){return}if(c){if(a.btnWrap){a.btnWrap.removeCls(a._btnWrapCls+'-'+c);a.btnWrap.addCls(a._btnWrapCls+'-'+b)}if(a.btnEl){a.btnEl.removeCls(a._btnCls+'-'+c);a.btnEl.addCls(a._btnCls+'-'+b)}if(a.btnIconEl){a.btnIconEl.removeCls(a._baseIconCls+'-'+c);a.btnIconEl.addCls(a._baseIconCls+'-'+b)}if(a.btnInnerEl){a.btnInnerEl.removeCls(a._innerCls+'-'+c);a.btnInnerEl.addCls(a._innerCls+'-'+b)}}(arguments.callee.$previous||Ext.Component.prototype.setUI).call(this,b)},setCls:function(a){if(!this.el){this.addListener('afterrender',Ext.bind(this.setCls,this,[a]),this,{single:!0});return}if(this.cls){this.el.removeCls(this.cls)}this.cls=a;this.el.addCls(this.cls)},setTooltip:function(b,j){if(b&&typeof b=='object'){var d=b.localized;if(d){var a,h=/mvstr\[[^\]]+\]/g;if(Ext.isObject(d)){for(var c in d){if(b[c]!==undefined){continue}a=d[c];if(a&&typeof a=='string'){if(mvstr[a]){b[c]=mvstr[a]}else {if(a.match(h)){var g=a.match(h);for(var f=0;f<g.length;f++){var i=g[f].match(/mvstr\[([^\]]+)\]/)[1];a=a.replace(g[f],mvstr[i])}b[c]=a}else {console.error('Missing translation ('+mvstr.LanguageID+") for key '"+a+"'.")}}}else {if(typeof a=='object'){var e=a[mvstr.LanguageID];if(e===undefined){e=a['default']}if(e!==undefined){b[c]=e}}}}}}}arguments.callee.$previous.call(this,b,j)}});Ext.define('Ext.classic.toolbar.Toolbar',{override:'Ext.toolbar.Toolbar',defaultFieldUI:'toolbar'});Ext.define('Ext.overrides.container.DockingContainer',{override:'Ext.container.DockingContainer',getDockedItems:function(b,a){if(!this.getComponentLayout().getDockedItems){return []}return arguments.callee.$previous.apply(this,arguments)}});Ext.define('Ext.overrides.panel.Panel',{override:'Ext.panel.Panel',constructor:function(a){a=a||{};a.closeToolText=a.closeToolText||mvstr['G_Close panel'];(arguments.callee.$previous||Ext.container.Container.prototype.constructor).call(this,a)}});Ext.define('mdsOverrides.overrides.window.Window',{override:'Ext.window.Window',getDockedItems:function(){if(!this.getComponentLayout().getDockedItems){return []}return (arguments.callee.$previous||Ext.panel.Panel.prototype.getDockedItems).apply(this,arguments)},constructor:function(){var a=this;a.closeToolText=mvstr['G_Close Dialog'];(arguments.callee.$previous||Ext.panel.Panel.prototype.constructor).apply(this,arguments)}});Ext.define('Ext.overrides.form.field.Base',{override:'Ext.form.field.Base',publishValue:function(){var a=this;if(a.rendered&&(!a.getErrors().length||a.mvPublishWithErrors)){a.publishState('value',a.getValue())}},onRender:function(){var b=this.callParent(arguments);if(this.config){if(typeof this.config.tooltip==='string'&&this.config.tooltip){this.config.tooltip=Ext.create('Ext.tip.ToolTip',{target:this,html:this.config.tooltip})}var a=this.config.autoComplete;if(this.inputEl&&a===!0||a==='on'){this.inputEl.set({autocomplete:'on'})}}return b}});Ext.define('Ext.overrides.form.field.TextArea',{override:'Ext.form.field.TextArea',autoSize:function(){var a=this,b,e,c,f,d;if(a.grow&&a.rendered&&a.getSizeModel().height.auto){b=a.inputEl;f=b.getWidth(!0);d=Ext.util.Format.htmlEncode(b.dom.value)||'&#160;';d+=a.growAppend;d=d.replace(/\n/g,'<br/>');c=Ext.util.TextMetrics.measure(b,d,f).height+b.getPadding('tb')+a.inputWrap.getBorderWidth('tb')+a.triggerWrap.getBorderWidth('tb');c=Math.min(Math.max(c,a.growMin),a.growMax);e=a.preventScrollbars||!a.growMax||c<a.growMax;b.setStyle('overflow-y',e?'hidden':'auto');a.bodyEl.setHeight(c);a.updateLayout();a.fireEvent('autosize',a,c)}}});Ext.define('MdsOverrides.overrides.window.MessageBox',{override:'Ext.window.MessageBox',error:function(a,b,d,c){if(Ext.isString(a)&&b==null){b=a;a=mvstr['G_Error']}return this.showWithIcon(a,b,d,c,this.ERROR)},warn:function(a,b,d,c){if(Ext.isString(a)&&b==null){b=a;a='Warning'}return this.showWithIcon(a,b,d,c,this.WARNING)},info:function(c,a,d,b){return this.showWithIcon(c,a,d,b,this.INFO)},question:function(c,a,d,b){return this.showWithIcon(c,a,d,b,this.QUESTION)},showWithIcon:function(a,b,e,c,d){if(Ext.isString(a)){a={title:a,message:b,buttons:this.OK,icon:d,fn:e,scope:c}}this.on({boxready:{fn:function(){this.center()},scope:this,single:!0}});return this.show(a)}});Ext.define('Ext.overrides.form.Panel',{override:'Ext.form.Panel',getErrors:function(){var b=this.form.getFields(),a=[];b.each(function(b){if(!b.isValid()){var d=b.getErrors(),e=(b.getFieldLabel?b.getFieldLabel():'')||(b.getBoxLabel?b.getBoxLabel():'');for(var c=0;c<d.length;c++){a.push((e?'<b>'+e+':</b> ':'')+d[c])}}},this);return a}});Ext.define('Ext.overrides.view.AbstractView',{override:'Ext.view.AbstractView',updateIndexes:function(d,b){var f=this.all.elements,c,e=this.getViewRange(),a,g=this.id;d=d||0;b=b||(b===0?0:f.length-1);for(a=d;a<=b;a++){c=f[a];c.setAttribute('data-recordIndex',a);if(e[a]){c.setAttribute('data-recordId',e[a].internalId)}c.setAttribute('data-boundView',g)}},refresh:function(){var a=this,d=a.all,n=d.getCount(),k=a.refreshCounter,h,b,o=a.getSelectionModel(),g,e=k&&d.getCount()&&a.preserveScrollOnRefresh&&a.getScrollable(),j=a.bufferedRenderer,c;if(!a.rendered||a.destroyed){return}if(!a.hasListeners.beforerefresh||a.fireEvent('beforerefresh',a)!==!1){a.el.dom.style.visibility='hidden';a.refreshing=!0;if(a.saveFocusState){g=a.saveFocusState()}h=a.getTargetEl();b=a.getViewRange();if(e){c=e.getPosition();if(!(c.x||c.y)){c=null}}if(k){a.clearViewEl();a.refreshCounter++}else {a.refreshCounter=1}a.tpl.append(h,a.collectData(b,d.startIndex||0));if(b.length<1){a.addEmptyText();d.clear()}else {a.collectNodes(h.dom);a.updateIndexes(0)}if(a.groupField&&a.groupTpl){var l='';for(var i=0;i<b.length;i++){var f=b[i],m=f.get(a.groupField);if(l!=m){l=m;if(a.getNode(f)){a.groupTpl.insertBefore(a.getNode(f),f.getData())}}}}a.el.dom.style.visibility='';if(g){g()}if(a.refreshSelmodelOnRefresh!==!1){o.refresh()}a.refreshNeeded=!1;a.refreshSize(d.getCount()!==n);a.fireItemMutationEvent('refresh',a,b);if(e){e.scrollTo(c)}if(!a.viewReady){a.viewReady=!0;a.fireEvent('viewready',a)}a.refreshing=!1;if(j){j.refreshSize()}a.cleanupData()}if(!a.tabGuardEl){a.tabGuardEl=a.el.createChild({cls:'x-tab-guard x-tab-guard-after',tabIndex:'0'},null,!0)}}});Ext.define('Ext.overrides.view.View',{override:'Ext.view.View',initComponent:function(){(arguments.callee.$previous||Ext.view.AbstractView.prototype.initComponent).call(this);if(this.groupTpl&&(Ext.isArray(this.groupTpl)||Ext.isString(this.groupTpl))){this.groupTpl=new Ext.XTemplate(this.groupTpl)}},addEmptyText:function(){var a=this,b=a.getStore();if(a.emptyText&&!b.isLoading()&&(!a.deferEmptyText||b.isLoaded())){a.emptyEl=Ext.core.DomHelper.insertHtml('beforeEnd',a.getTargetEl().dom,"<div class='empty-text'>"+a.emptyText+'</div>')}},setEmptyText:function(a){this.emptyText=a}});Ext.define('Ext.overrides.form.field.ComboBox',{override:'Ext.form.field.ComboBox',config:{enableKeySelect:!1,enableKeyHighlight:!1,keySelectDelay:750},constructor:function(a){a=this.setupKeySelectConfigs(a);(arguments.callee.$previous||Ext.form.field.Picker.prototype.constructor).apply(this,arguments)},setupKeySelectConfigs:function(a){a=a||{};if(a.enableKeySelect){a.enableKeyHighlight=!0}if(a.enableKeyHighlight!==!1){if(a.enableKeyHighlight===!0){a.editable=!1;a.queryMode='local'}else {var d=a.editable!==!1&&this.config.editable!==!1;var c=a.queryMode||this.config.queryMode;if(d===!1&&c==='local'){a.enableKeyHighlight=!0}}}if(a.enableKeyHighlight){a.enableKeyEvents=!0;a.listeners=a.listeners||{};if(a.listeners.keyup){var b=a.listeners.keyup;a.listeners.keyup=function(c,d){var e=b.call(this,c,d);this.keyupHandler(c,d);return e}.bind(this)}else {a.listeners.keyup=this.keyupHandler.bind(this)}}return a},keyupHandler:function(d,f){if(this.config.enableKeyHighlight){var c=f.keyCode;if(c>=32&&c<=126){var i=String.fromCharCode(f.getKey()).toLowerCase();var h=this.getKeySelectSearchString(c,i);var a=d.getPicker();var g=a.getStore();var b=this.keySelectSearch(d,g,h);this.keyHighlightIndex=b;if(b>=0){var e=g.getAt(b);a.highlightItem(a.getNode(e));a.getNavigationModel().setPosition(b);if(this.config.enableKeySelect){a.getSelectionModel().select(e,!1,!0);d.expand()}}}}},getKeySelectSearchString:function(d,a){if(this.keySelectString===undefined){this.keySelectString='';this.keySelectLastTime=0;this.keyHighlightIndex=-1}var b=(new Date()).getTime();var c=b-this.keySelectLastTime;this.keySelectLastTime=b;if(c>this.config.keySelectDelay){this.keySelectString=a}else {this.keySelectString=this.keySelectString+a}return this.keySelectString},keySelectSearch:function(a,d,b){var c=-1;if(b.length>1){c=this.keySelectStoreFind(d,a.displayField,b,0,a.anyMatch,a.caseSensitive);b=b.charAt(0)}if(c===-1){var e=this.keyHighlightIndex+1;c=this.keySelectStoreFind(d,a.displayField,b,e,a.anyMatch,a.caseSensitive)}return c},keySelectStoreFind:function(f,e,g,c,d,b){var a=f.find(e,g,c,d,b);if(a===-1&&c>0){a=f.find(e,g,0,d,b)}return a},setValue:function(a){if(this.getStore()===null){if(a!==null){this.mvComboFixValue=a}return this}return (arguments.callee.$previous||Ext.form.field.Picker.prototype.setValue).apply(this,arguments)},setStore:function(){arguments.callee.$previous.apply(this,arguments);if(this.mvComboFixValue){this.setValue(this.mvComboFixValue);this.mvComboFixValue=undefined}}});Ext.define('Ext.overrides.form.field.Base',{override:'Ext.form.field.Date',config:{mvPickerUI:''},createPicker:function(){var b=(arguments.callee.$previous||Ext.form.field.Picker.prototype.createPicker).apply(this,arguments),a=this.getMvPickerUI();if(a){b.setUI(a)}return b}});Ext.define('Ext.overrides.grid.CellContext',{override:'Ext.grid.CellContext',onCellMouseDown:function(c,e,g,h,i,f,a){var b=Ext.Component.fromElement(a.target,e),d;if(c.actionableMode&&(a.getTarget(null,null,!0).isTabbable()||(d=Ext.ComponentManager.getActiveComponent())&&d.owns(a))){return}if(a.pointerType!=='touch'){this.setPosition(a.position,null,a)}if(b&&b.isFocusable&&b.isFocusable()){c.setActionableMode(!0,a.position);b.focus()}},setPosition:function(b,a){if(b!==null||a!==null){return arguments.callee.$previous.apply(this,arguments)}}});Ext.define('Ext.overrides.grid.NavigationModel',{override:'Ext.grid.NavigationModel',onCellMouseDown:function(c,e,g,h,i,f,a){var b=Ext.Component.fromElement(a.target,e),d;if(c.actionableMode&&(a.getTarget(null,null,!0).isTabbable()||(d=Ext.ComponentManager.getActiveComponent())&&d.owns(a))){return}if(a.pointerType!=='touch'){this.setPosition(a.position,null,a)}if(b&&b.isFocusable&&b.isFocusable()){c.setActionableMode(!0,a.position);b.focus()}}});Ext.define('Ext.theme.classic.grid.column.Widget',{override:'Ext.grid.column.Widget',config:{defaultWidgetUI:{button:'grid-cell',splitbutton:'grid-cell',cyclebutton:'grid-cell',textfield:'grid-cell',pickerfield:'grid-cell',combobox:'grid-cell',combo:'grid-cell',datefield:'grid-cell',timefield:'grid-cell',filefield:'grid-cell',fileuploadfield:'grid-cell',sliderwidget:'grid-cell'}}});Ext.define('Ext.overrides.menu.Menu',{override:'Ext.menu.Menu',calculateConstrainedPosition:function(a,f,h,g){var e=this,d=e.floatParent,b=d?d.getTargetEl():null,c=b?Ext.getCmp(b.id):null;if(!a&&c&&c.isToolbar){a=e.container}(arguments.callee.$previous||Ext.panel.Panel.prototype.calculateConstrainedPosition).call(this,a,f,h,g)}});Ext.define('Ext.theme.classic.grid.plugin.Editing',{override:'Ext.grid.plugin.Editing',defaultFieldUI:'grid-cell'});Ext.cmd.derive('mdsPreferences.MemberPreferences',mdsPreferences.Local,{singleton:!0,setIdentification:function(a){this.identification={MemberUID:a}},getTasklistSetting_alwaysCloneWhenDone:function(a){return this.getBooleanValue('tasklistSetting_alwaysCloneWhenDone',a)},setTasklistSetting_alwaysCloneWhenDone:function(a,b){this.setBooleanValue('tasklistSetting_alwaysCloneWhenDone',a,b)},getTasklistSetting_showConfirmationPrompt:function(a){return this.getBooleanValue('tasklistSetting_showConfirmationPrompt',a)},setTasklistSetting_showConfirmationPrompt:function(a,b){this.setBooleanValue('tasklistSetting_showConfirmationPrompt',a,b)},getTasklistSetting_includePhotos:function(a){return this.getBooleanValue('tasklistSetting_includePhotos',a)},setTasklistSetting_includePhotos:function(a,b){this.setBooleanValue('tasklistSetting_includePhotos',a,b)},getTasklistSetting_includePins:function(a){return this.getBooleanValue('tasklistSetting_includePins',a)},setTasklistSetting_includePins:function(a,b){this.setBooleanValue('tasklistSetting_includePins',a,b)},getTasklistSetting_includeFiles:function(a){return this.getBooleanValue('tasklistSetting_includeFiles',a)},setTasklistSetting_includeFiles:function(a,b){this.setBooleanValue('tasklistSetting_includeFiles',a,b)},getOnboardingSetting_LayoutTemplateID:function(a){return this.getValue('onboardingSetting_LayoutTemplateID',a)},setOnboardingSetting_LayoutTemplateID:function(b,a){this.setValue('onboardingSetting_LayoutTemplateID',b,a)},getOnboardingSetting_ContentTemplateID:function(a){return this.getValue('onboardingSetting_ContentTemplateID',a)},setOnboardingSetting_ContentTemplateID:function(b,a){this.setValue('onboardingSetting_ContentTemplateID',b,a)},getWebcamSetting_gridViewSelection:function(a){return this.getObjectValue('webcamSetting_gridViewSelection',a)},setWebcamSetting_gridViewSelection:function(a,b){this.setObjectValue('webcamSetting_gridViewSelection',a,b)},getAdminSetting_restrictedFeatureID:function(a){return this.getValue('adminSetting_restrictedFeatureID',a)},setAdminSetting_restrictedFeatureID:function(a,b){this.setValue('adminSetting_restrictedFeatureID',a,b)},getPhotoListCart:function(b,c){var a=this.getValue('photoListCart');if(a){a=JSON.parse(a);if(a.sessionDataID!=b||a.ProjectUID!=c){this.removeValue('photoListCart');return []}}return a||[]},setPhotoListCart:function(a){this.setValue('photoListCart',a)}},0,0,0,0,0,0,[mdsPreferences,'MemberPreferences'],0);Ext.cmd.derive('mdsPreferences.ProjectPreferences',mdsPreferences.Local,{singleton:!0,setIdentification:function(a,b){this.identification={ProjectUID:a,MemberUID:b}},getAlbumUIDArray:function(a){return this.getListValue('albums',a)},setAlbumUIDArray:function(b,a){this.setListValue('albums',b,a)},getShareTypeID:function(a){return this.getNumericValue('ShareTypeID',a)},setShareTypeID:function(b,a){this.setValue('ShareTypeID',b,a)},getShareMembersList:function(a){return this.getValue('ShareMembersList',a)},setShareMembersList:function(b,a){this.setValue('ShareMembersList',b,a)},getProcoreSetting_companyID:function(a){return this.getNumericValue('procoreSetting_companyID',a)},setProcoreSetting_companyID:function(a,b){this.setValue('procoreSetting_companyID',a,b)},getProcoreSetting_projectID:function(a){return this.getNumericValue('procoreSetting_projectID',a)},setProcoreSetting_projectID:function(a,b){this.setValue('procoreSetting_projectID',a,b)},getProcoreSetting_entityType:function(a){return this.getValue('procoreSetting_entityType',a)},setProcoreSetting_entityType:function(a,b){this.setValue('procoreSetting_entityType',a,b)},getProcoreSetting_attachAsPhoto:function(a){return this.getBooleanValue('procoreSetting_AttachAsPhoto',a)},setProcoreSetting_attachAsPhoto:function(a,b){this.setBooleanValue('procoreSetting_AttachAsPhoto',a,b)},getProcoreSetting_attachAs4View:function(a){return this.getBooleanValue('procoreSetting_AtachAs4View',a)},setProcoreSetting_attachAs4View:function(a,b){this.setBooleanValue('procoreSetting_AtachAs4View',a,b)},getProcoreSetting_dailyLogSubType:function(a){return this.getValue('procoreSetting_dailyLogSubType',a)},setProcoreSetting_dailyLogSubType:function(a,b){this.setValue('procoreSetting_dailyLogSubType',a,b)},getProcoreSetting_punchlistAction:function(a){return this.getValue('procoreSetting_punchlistAction',a)},setProcoreSetting_punchlistAction:function(a,b){this.setValue('procoreSetting_punchlistAction',a,b)},getProcoreSetting_observationAction:function(a){return this.getValue('procoreSetting_observationAction',a)},setProcoreSetting_observationAction:function(a,b){this.setValue('procoreSetting_observationAction',a,b)},getProcoreSetting_photoAction:function(a){return this.getValue('procoreSetting_photoAction',a)},setProcoreSetting_photoAction:function(a,b){this.setValue('procoreSetting_photoAction',a,b)},getProcoreSetting_photoCategoryID:function(a){return this.getNumericValue('procoreSetting_photoCategoryID',a)},setProcoreSetting_photoCategoryID:function(a,b){this.setValue('procoreSetting_photoCategoryID',a,b)},getProcoreSetting_rfiFilterValue:function(a){return this.getObjectValue('procoreSetting_rfiFilterValue',a)},setProcoreSetting_rfiFilterValue:function(a,b){this.setObjectValue('procoreSetting_rfiFilterValue',a,b)},getPlanGridSetting_projectID:function(a){return this.getValue('planGridSetting_projectID',a)},setPlanGridSetting_projectID:function(a,b){this.setValue('planGridSetting_projectID',a,b)},getPlanGridSetting_entityType:function(a){return this.getValue('planGridSetting_entityType',a)},setPlanGridSetting_entityType:function(a,b){this.setValue('planGridSetting_entityType',a,b)},getPlanGridSetting_attachAsPhoto:function(a){return this.getBooleanValue('planGridSetting_attachAsPhoto',a)},setPlanGridSetting_attachAsPhoto:function(a,b){this.setBooleanValue('planGridSetting_attachAsPhoto',a,b)},getPlanGridSetting_attachAs4View:function(a){return this.getBooleanValue('planGridSetting_attachAs4View',a)},setPlanGridSetting_attachAs4View:function(a,b){this.setBooleanValue('planGridSetting_attachAs4View',a,b)},getPlanGridSetting_rfiAssignee:function(a){return this.getValue('planGridSetting_rfiAssignee',a)},setPlanGridSetting_rfiAssignee:function(a,b){this.setValue('planGridSetting_rfiAssignee',a,b)},getAconexSetting_projectID:function(a){return this.getNumericValue('aconexSetting_projectID',a)},setAconexSetting_projectID:function(a,b){this.setValue('aconexSetting_projectID',a,b)},getAconexSetting_entityType:function(a){return this.getValue('aconexSetting_entityType',a)},setAconexSetting_entityType:function(a,b){this.setValue('aconexSetting_entityType',a,b)},getAconexSetting_attachAsPhoto:function(a){return this.getBooleanValue('aconexSetting_attachAsPhoto',a)},setAconexSetting_attachAsPhoto:function(a,b){this.setBooleanValue('aconexSetting_attachAsPhoto',a,b)},getAconexSetting_attachAs4View:function(a){return this.getBooleanValue('aconexSetting_attachAs4View',a)},setAconexSetting_attachAs4View:function(a,b){this.setBooleanValue('aconexSetting_attachAs4View',a,b)},getAconexSetting_rfiFilterValue:function(a){return this.getObjectValue('aconexSetting_rfiFilterValue',a)},setAconexSetting_rfiFilterValue:function(a,b){this.setObjectValue('aconexSetting_rfiFilterValue',a,b)},getBim360Setting_hubID:function(a){return this.getValue('bim360Setting_hubID',a)},setBim360Setting_hubID:function(a,b){this.setValue('bim360Setting_hubID',a,b)},getBim360Setting_projectID:function(a){return this.getValue('bim360Setting_projectID',a)},setBim360Setting_projectID:function(a,b){this.setValue('bim360Setting_projectID',a,b)},getBim360Setting_attachAsPhoto:function(a){return this.getBooleanValue('bim360Setting_attachAsPhoto',a)},setBim360Setting_attachAsPhoto:function(a,b){this.setBooleanValue('bim360Setting_attachAsPhoto',a,b)},getBim360Setting_attachAs4View:function(a){return this.getBooleanValue('bim360Setting_attachAs4View',a)},setBim360Setting_attachAs4View:function(a,b){this.setBooleanValue('bim360Setting_attachAs4View',a,b)},getBim360Setting_documentAction:function(a){return this.getValue('bim360Setting_documentAction',a)},setBim360Setting_documentAction:function(a,b){this.setValue('bim360Setting_documentAction',a,b)},getBim360Setting_folderID:function(a){return this.getValue('bim360Setting_folderID',a)},setBim360Setting_folderID:function(a,b){this.setValue('bim360Setting_folderID',a,b)},getBluebeamSetting_projectID:function(a){return this.getValue('bluebeamSetting_projectID',a)},setBluebeamSetting_projectID:function(a,b){this.setValue('bluebeamSetting_projectID',a,b)},getBluebeamSetting_entityType:function(a){return this.getValue('bluebeamSetting_entityType',a)},setBluebeamSetting_entityType:function(a,b){this.setValue('bluebeamSetting_entityType',a,b)},getBluebeamSetting_attachAsPhoto:function(a){return this.getBooleanValue('bluebeamSetting_attachAsPhoto',a)},setBluebeamSetting_attachAsPhoto:function(a,b){this.setBooleanValue('bluebeamSetting_attachAsPhoto',a,b)},getBluebeamSetting_attachAs4View:function(a){return this.getBooleanValue('bluebeamSetting_attachAs4View',a)},setBluebeamSetting_attachAs4View:function(a,b){this.setBooleanValue('bluebeamSetting_attachAs4View',a,b)},getBluebeamSetting_rfiFilterValue:function(a){return this.getObjectValue('bluebeamSetting_rfiFilterValue',a)},setBluebeamSetting_rfiFilterValue:function(a,b){this.setObjectValue('bluebeamSetting_rfiFilterValue',a,b)}},0,0,0,0,0,0,[mdsPreferences,'ProjectPreferences'],0);Ext.define(null,{override:'Ext.view.DropZone',positionIndicator:function(e,l,m){var a=this,i=a.view,c=a.getPosition(m,e),b=i.getRecord(e),f=l.records,g,h,d,k,j;if(!Ext.Array.contains(f,b)&&(c==='before'&&!a.containsRecordAtOffset(f,b,-1)||c==='after'&&!a.containsRecordAtOffset(f,b,1))){a.valid=!0;if(a.overRecord!==b||a.currentPosition!==c){h=a.view.getScrollable();d=h&&h.getElement();k=d&&d.isScrollable()?d:Ext.fly(i.getNodeContainer());j=k.getY();g=Ext.fly(e).getY()-j-1;if(c==='after'){g+=Ext.fly(e).getHeight()}a.getIndicator().setWidth(Ext.fly(i.el).getWidth()).showAt(0,g);a.overRecord=b;a.currentPosition=c}}else {a.invalidateDrop()}}});Ext.cmd.derive('clientHelp.view.HtmlHelpHelper',Ext.Base,{FILE_NAMES:['aClientDashboard','aClientFileManager','aClientFloorplanOverview','aClientFloorplanViewer','aClientPeopleOverview','aClientPhotoList','aClientPhotoViewer','aClientTagSearch','aClientWebcam.live','aClientWebcamOverview','aClientPunchlist.view','aClientPunchlist.entry','aClientPunchlist.plans'],PROJECT_PREFERENCE_NAME:'xProjectPreference',fuseMap:{clientDashboard:'aClientDashboard',clientFileManager:'aClientFileManager',clientFloorplanOverview:'aClientFloorplanOverview',clientFloorplanViewer:'aClientFloorplanViewer',clientPeopleOverview:'aClientPeopleOverview',clientPhotoList:'aClientPhotoList',clientPhotoViewer:'aClientPhotoViewer',clientTagSearch:'aClientTagSearch',clientWebcamLive:'aClientWebcamLive',clientWebcamOverview:'aClientWebcamOverview',clientPunchlistOverview:'aClientPunchlist.view',clientPunchlistEntry:'aClientPunchlist.entry'},constructor:function(b){var a=this;a.context=b.context;a.defaultFileName=b.defaultFileName?b.defaultFileName:'defaultHelp';a.helpFileExtention=b.helpFileExtention?b.helpFileExtention:'html';a.helpDirectory=b.helpDirectory?b.helpDirectory:'mds/module/clientHelp/';a.helpIndex=0;a.greetingId=0;a.greetingIdProjectPreference=0;a.projectpreference='';a.callback=b.callback;a.helpDirectory=(mdslink.server?mdslink.server+'/':'')+a.helpDirectory;var e=Ext.Object.fromQueryString(document.location.search),c=window.location.pathname.match(/(\w+)\/?$/);if(c&&c.length>1&&this.fuseMap[c[1]]){c=this.fuseMap[c[1]].toLowerCase()}else {c=''}a.helpFile=a.defaultFileName;if(a.helpFile=='defaultHelp'){a.fuse=e.fuseaction?e.fuseaction.substr(0,e.fuseaction.indexOf('.')).toLowerCase():c;for(var d=0;d<a.FILE_NAMES.length;d++){if(a.fuse==a.FILE_NAMES[d].toLowerCase()){if(a.FILE_NAMES[d]=='aClientPhotoViewer'&&Ext.isDefined(e.WebcamUID)){a.helpFile='aClientPhotoViewerWebcam'}else {a.helpFile=a.FILE_NAMES[d]}break}else {if(e.fuseaction){var f=e.fuseaction.toLowerCase();if(f==a.FILE_NAMES[d].toLowerCase()){a.helpFile=a.FILE_NAMES[d];break}}}}}},fuse:'',handleHtmlHelpHelper:function(){var a=this;a.makeSplashscreen();a.loadHelpHtml(a.makeFileURL())},handleGreetings:function(c){var a=this;for(var b=0;b<c.length;b++){if(c[b].Name.toLowerCase()==a.fuse){if(c[b].seen==!1){a.greetingId=c[b].GreetingID}break}}if(a.greetingId==1){a.helpIndex=-1;a.makeSplashscreen();var d=a.helpDirectory+a.helpFile+'.greeting.'+a.helpFileExtention;a.loadHelpHtml(d)}else {if('aClientDashboard'.toLowerCase()!=a.fuse&&'aClientPhotoViewer'.toLowerCase()!=a.fuse){for(var b=0;b<c.length;b++){if(c[b].Name.toLowerCase()==a.PROJECT_PREFERENCE_NAME.toLowerCase()){if(c[b].seen==!1){a.greetingIdProjectPreference=c[b].GreetingID}break}}}if(a.greetingIdProjectPreference!=0){a.helpIndex=-1;a.makeSplashscreen();var d=a.helpDirectory+(a.greetingId==0?'projectpreference.close.':'projectpreference.next.')+a.helpFileExtention;a.loadHelpHtml(d)}else {if(a.greetingId!=0){a.helpIndex=0;a.makeSplashscreen();var d=a.makeFileURL();a.loadHelpHtml(d)}}}if(a.greetingId!==0){if(window.localStorage.getItem('Multivista_ClientSession')){var e=JSON.parse(window.localStorage.getItem('Multivista_ClientSession'));var f=e.greeting?e.greeting.length:0;for(var b=0;b<f;++b){if(e.greeting[b].GreetingID==a.greetingId){e.greeting[b].seen=!0;window.localStorage.setItem('Multivista_ClientSession',JSON.stringify(e));break}}}}},closeHelp:function(){this.helpIndex=0;this.deleteHelpContent();this.splashscreen.destroy()},onHelpProgressBtnCloseClick:function(b,c){var a=this;a.closeHelp(a)},onHelpProgressBtnNextClick:function(b,c){var a=this;a.deleteHelpContent();a.helpIndex+=1;a.loadHelpHtml(a.makeFileURL())},onHelpProgressBtnPrevClick:function(b,c){var a=this;a.deleteHelpContent();a.helpIndex-=1;a.loadHelpHtml(a.makeFileURL())},onPreferenceProgressBtnCloseClick:function(){var a=this;a.updatePreference();a.onHelpProgressBtnCloseClick(arguments)},onPreferenceProgressBtnNextClick:function(){var a=this;a.updatePreference();a.onHelpProgressBtnNextClick(arguments)},updatePreference:function(){var a=this;node=a.helpContent.down('input[type="radio"]:checked');a.projectpreference=node.dom.value;a.context.fireEvent('updateProjectPreference')},makeFileURL:function(){var a=this;return a.helpDirectory+a.helpFile+'.'+a.helpIndex+'.'+a.helpFileExtention},loadHelpHtml:function(b){var a=this;Ext.Ajax.request({url:b,success:function(d){a.helpContent=Ext.DomHelper.insertHtml('afterEnd',a.splashscreen.dom,d.responseText);a.helpContent=new Ext.dom.Element(a.helpContent);if(a.callback){a.callback(a)}var c=a.helpContent.down('.closeModal');if(c){c.on('click',function(c,e,f){a.onHelpProgressBtnCloseClick(c,e)})}c=a.helpContent.down('.helpProgressBtnClose');if(c){c.on('click',function(c,e,f){a.onHelpProgressBtnCloseClick(c,e)})}c=a.helpContent.down('.helpProgressBtnNext');if(c){c.on('click',function(c,e,f){a.onHelpProgressBtnNextClick(c,e)})}c=a.helpContent.down('.helpProgressBtnPrev');if(c){c.on('click',function(c,e,f){a.onHelpProgressBtnPrevClick(c,e)})}c=a.helpContent.down('.preferenceBtnClose');if(c){c.on('click',function(c,e,f){a.onPreferenceProgressBtnCloseClick(c,e)})}c=a.helpContent.down('.preferenceBtnNext');if(c){c.on('click',function(c,e,f){a.onPreferenceProgressBtnNextClick(c,e)})}}})},deleteHelpContent:function(){var a=this;if(a.helpContent){a.helpContent.destroy()}},makeSplashscreen:function(){var a=Ext.create('Ext.Component',{cls:'help-mask',width:'100%',height:'100%',renderTo:Ext.getBody(),floating:!0,shadow:!1,listeners:{click:{fn:Ext.bind(this.closeHelp,this),element:'el'}}});a.toFront();this.splashscreen=a.el;this.splashscreenCmp=a}},1,['htmlhelphelper'],['htmlhelphelper'],{'htmlhelphelper':!0},['widget.htmlhelphelper'],0,[clientHelp.view,'HtmlHelpHelper'],0);Ext.cmd.derive('clientHelp.view.helpsequence.HelpSequenceModel',Ext.app.ViewModel,{data:{title:'My Title',body:'My Body',index:-1,retryGetComponent:!1},formulas:{maxIndex:function(a){return a('pages').length-1},continueText:function(a){return a('nextIndex')<=a('maxIndex')?mvstr['G_Continue']:mvstr['G_Done']},nextIndex:function(b){var c=b('maxIndex');for(var a=b('index')+1;a<=c;a++){var d=this.getView().lookupController().getComponentForIndex(a);if(d||b('retryGetComponent')){return a}}return c+1}}},0,0,0,0,['viewmodel.helpsequence'],0,[clientHelp.view.helpsequence,'HelpSequenceModel'],0);Ext.cmd.derive('clientHelp.view.helpsequence.HelpSequenceController',Ext.app.ViewController,{retryGetComponent:!1,init:function(){var a=Ext.ComponentQuery.query(this.getView().xtype)[0];if(a!=this.getView()){a.destroy()}this.getViewModel().bind('{index}',this.showHelpForIndex,this);this.parentDestroyListener=this.getView().getParentView().addListener('destroy',this.quit,this,{single:!0,destroyable:!0})},getAlignTarget:function(a){return this.getView().getParentView().down(a)},showHelpForIndex:function(e,c){if(e==-1){this.doContinue();return}var a=this.getView(),d=this.getViewModel(),b=d.get('pages')[e],h=this.getComponentForIndex(e);if(!h){if(!d.get('retryGetComponent')||c==100){this.quit()}else {if(!c){c=1}else {c++}Ext.defer(function(){this.showHelpForIndex(e,c)},100,this)}return}a.anchor=b.anchor||'top';a.defaultAlign=b.defaultAlign||'bl-tl';a.setMargin(0);d.set('title',this.getTitle(b));var g=[],f=0;while(this.getParagraph(b,f)){g.push('<p>'+this.getParagraph(b,f)+'</p>');f++}d.set('body',g.join());var i=b.delay||0;Ext.defer(function(){var i=this.getAlignTarget(b.alignTarget);a.setStyle({opacity:0});a.showBy(i.el);var h=a.getBox(),d=h.x,f=h.y;if(b.offset){d+=b.offset[0];f+=b.offset[1]}var j=d,k=f,g=37;if(a.anchor=='top'||a.defaultAlign=='c-c'){f-=g}else {if(a.anchor=='bottom'){f+=g}else {if(a.anchor=='left'){d-=g}else {if(a.anchor=='right'){d+=g}}}}Ext.create('Ext.fx.Anim',{target:a,duration:1200,from:{opacity:0},to:{opacity:1}});Ext.create('Ext.fx.Anim',{target:a,duration:750,easing:'bounceOut',from:{x:d,y:f},to:{x:j,y:k}})},i,this)},getComponentForIndex:function(d){var c=this.getViewModel().get('pages')[d];if(!c){return null}var b=this.getAlignTarget(c.alignTarget),a=b?b.el:null;return a&&a.isVisible()?a:null},getParagraph:function(b,a){return mvstr[b.name+'_P'+a]},getTitle:function(a){return mvstr[a.name+'_Title']},doSkip:function(){this.quit()},doContinue:function(){this.getViewModel().set('index',this.getViewModel().get('nextIndex'))},quit:function(){this.getView().destroy()},beforeDestroy:function(){this.parentDestroyListener.destroy()}},0,0,0,0,['controller.helpsequence'],0,[clientHelp.view.helpsequence,'HelpSequenceController'],0);Ext.cmd.derive('clientHelp.view.helpsequence.HelpSequence',Ext.panel.Panel,{viewModel:{type:'helpsequence'},controller:'helpsequence',config:{pages:[],parentView:null,forceShow:!1,alwaysOnTop:2},floating:!0,bind:{title:'{title}'},width:260,modal:!0,modalMaskCls:'modal-transparent',ui:'help',shadow:!1,items:[{xtype:'component',bind:{html:'{body}'}}],dockedItems:[{xtype:'container',width:'100%',dock:'bottom',padding:'0 15 15 15',layout:{type:'hbox'},items:[{xtype:'button',ui:'help',localized:{text:'G_Cancel'},listeners:{click:'doSkip'}},{xtype:'component',flex:1},{xtype:'button',ui:'help',bind:{text:'{continueText}'},listeners:{click:'doContinue'}}]}],constrainPosition:!0,baseCls:'x-tip',focusOnToFront:!1,defaultAlign:'bl-tl',alwaysOnTop:!0,listeners:{beforedestroy:'beforeDestroy'},initComponent:function(){var a=this;Ext.panel.Panel.prototype.initComponent.call(this);a.setTarget(a.target);a.currentTarget=new Ext.dom.Fly()},onRender:function(c,b){var a=this;Ext.panel.Panel.prototype.onRender.apply(this,arguments);a.anchorEl=a.el.createChild({role:'presentation',cls:'x-tip-anchor'})},show:function(){if(!this.currentTarget.dom&&this.target){return this.showBy(this.target)}Ext.panel.Panel.prototype.show.call(this)},setTarget:function(a){var b=this;if(a){b.target=a=Ext.get(a.el||a)}else {b.target=null}},getAlignRegion:function(){var a=this,b=a.anchorEl,e=a.getAnchorAlign(),c,d;if(!a.anchorSize){b.addCls('x-tip-anchor-top');b.show();a.anchorSize=new Ext.util.Offset(b.getWidth(!1,!0),b.getHeight(!1,!0));b.removeCls('x-tip-anchor-top');b.hide()}d=a.currentTarget.getRegion();c={align:a.convertPositionSpec(e),axisLock:a.axisLock,target:d,offset:a.targetOffset,inside:a.constrainPosition?a.constrainTo||Ext.getBody().getRegion().adjust(5,-5,-5,5):null};if(a.anchor){c.anchorSize=a.anchorSize}return a.getRegion().alignTo(c)},getAnchorAlign:function(){switch(this.anchor){case 'top':return 'tl-bl';case 'left':return 'tl-tr';case 'right':return 'tr-tl';default:return this.defaultAlign;}},afterShow:function(){Ext.panel.Panel.prototype.afterShow.call(this);this.realignToTarget()},realignToTarget:function(){var a=this;a.doAlignment(a.getAlignRegion())},showBy:function(b){var a=this;a.align=a.defaultAlign;if(b.isEvent){a.currentTarget.attach(b.target);a.pointerEvent=b}else {a.currentTarget.attach(Ext.getDom(b.el||b));a.triggerElement=a.currentTarget.dom}if(a.isVisible()){a.realignToTarget()}else {a.show()}return a},doDestroy:function(){var a=this;Ext.destroy(a.anchorEl);Ext.panel.Panel.prototype.doDestroy.call(this)},doAlignment:function(b){var c=this,a=c.anchorEl,d=b.anchor;c.setPagePosition([b.x,b.y]);if(a){a.removeCls(c.anchorCls);if(d){c.anchorCls='x-tip-anchor-'+d.position;a.addCls(c.anchorCls);a.show();if(d.align&1){a.setTop(b.anchor.y-b.y);a.dom.style.left=''}else {a.setLeft(b.anchor.x-b.x);a.dom.style.top=''}}else {a.hide()}}},convertPositionSpec:function(b){var a=Ext.panel.Panel.prototype.convertPositionSpec.apply(this,arguments);if(a.myEdge=='c'&&a.otherEdge=='c'){a.position=0}return a}},0,0,['component','box','container','panel'],{'component':!0,'box':!0,'container':!0,'panel':!0},0,0,[clientHelp.view.helpsequence,'HelpSequence'],0);Ext.cmd.derive('clientHelp.view.helpsequences.WebcamViewerHelpSequence',clientHelp.view.helpsequence.HelpSequence,{viewModel:{data:{pages:[{name:'HELPPV_WebcamViewToggle',alignTarget:'#photoViewerWebcamModeToggle',anchor:'top',offset:[0,4]},{name:'HELPPV_WebcamTitle',alignTarget:'photoviewertitle',anchor:'top'},{name:'HELPPV_WebcamBottomBar',alignTarget:'#bottomBarExpandTab',anchor:'bottom'},{name:'HELPPV_PTZControls',alignTarget:'streampositioncontrols',anchor:'left',offset:[0,148]},{name:'HELPPV_PTZPresets',alignTarget:'streampositioncontrols',anchor:'top',offset:[0,4]}]}}},0,['photoviewerhelpsequence'],['component','box','container','panel','photoviewerhelpsequence'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewerhelpsequence':!0},['widget.photoviewerhelpsequence'],0,[clientHelp.view.helpsequences,'WebcamViewerHelpSequence'],0);Ext.cmd.derive('clientHelp.view.helpsequences.PhotoViewerHelpSequence',clientHelp.view.helpsequence.HelpSequence,{viewModel:{data:{pages:[{name:'HELPPV_MainPhoto',alignTarget:'photocontainer',anchor:'bottom',defaultAlign:'c-c',offset:[0,-70]},{name:'HELPPV_ViewToggle',alignTarget:'#photoViewerLayoutModeToggle'},{name:'HELPPV_MainMenu',alignTarget:'photoactionsmenu'},{name:'HELPPV_SideBar',alignTarget:'photoviewersidecontrols',anchor:'right'},{name:'HELPPV_FloorplanWidget',alignTarget:'photoviewerflooplanview',anchor:'right'},{name:'HELPPV_BottomBar',alignTarget:'#bottomBarExpandTab',anchor:'bottom'}]}}},0,['photoviewerhelpsequence'],['component','box','container','panel','photoviewerhelpsequence'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewerhelpsequence':!0},['widget.photoviewerhelpsequence'],0,[clientHelp.view.helpsequences,'PhotoViewerHelpSequence'],0);Ext.cmd.derive('clientHelp.view.newfeature.NewFeatureModel',clientHelp.view.helpsequence.HelpSequenceModel,{data:{retryGetComponent:!0}},0,0,0,0,['viewmodel.newfeature'],0,[clientHelp.view.newfeature,'NewFeatureModel'],0);Ext.cmd.derive('clientHelp.view.newfeature.NewFeatureController',clientHelp.view.helpsequence.HelpSequenceController,{confirmFeature:function(){var b=this.getFeatureName();if(window.localStorage.getItem('Multivista_ClientSession')){var c=JSON.parse(window.localStorage.getItem('Multivista_ClientSession'));var a=this.getViewModel().get('account');var d=a.newFeatureNotifications.indexOf(b);if(d>-1){a.newFeatureNotifications.splice(d,1)}c.account=a;window.localStorage.setItem('Multivista_ClientSession',JSON.stringify(c))}Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientNavigation.acceptNewFeature&feature='+b});this.quit()},getFeatureName:function(){return this.getView().xtype.split('_')[1]}},0,0,0,0,['controller.newfeature'],0,[clientHelp.view.newfeature,'NewFeatureController'],0);Ext.cmd.derive('clientHelp.view.newfeature.NewFeature',clientHelp.view.helpsequence.HelpSequence,{viewModel:{type:'newfeature'},controller:'newfeature',modal:!1,dockedItems:[{xtype:'container',width:'100%',dock:'bottom',padding:'0 15 15 15',layout:{type:'hbox',pack:'middle'},items:[{xtype:'button',ui:'help',text:'Got it!',listeners:{click:'confirmFeature'}}]}]},0,['newfeature'],['component','box','container','panel','newfeature'],{'component':!0,'box':!0,'container':!0,'panel':!0,'newfeature':!0},['widget.newfeature'],0,[clientHelp.view.newfeature,'NewFeature'],0);Ext.cmd.derive('clientHelp.view.newfeatures.clientUserAdd',clientHelp.view.newfeature.NewFeature,{statics:{isVisibleNotification:function(a){return !!a.JoinedWithAddUserPermission}},viewModel:{data:{pages:[{name:'NEWF_clientUserAdd',alignTarget:'navigationbar #peopleBtn',anchor:'top'}]}}},0,['newfeature_clientUserAdd'],['component','box','container','panel','newfeature','newfeature_clientUserAdd'],{'component':!0,'box':!0,'container':!0,'panel':!0,'newfeature':!0,'newfeature_clientUserAdd':!0},['widget.newfeature_clientUserAdd'],0,[clientHelp.view.newfeatures,'clientUserAdd'],0);Ext.cmd.derive('customData.Util',Ext.Base,{singleton:!0,uuidRegEx:/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,isUUID:function(a){return this.uuidRegEx.test(a)},getTimeDescription:function(b,a){if(!b){b=new Date()}if(!a){return ''}var d=Math.round((b.getTime()-a.getTime())/1000),c=Math.round(d/60),e=Math.round(c/60),f=Math.round(e/24);if(f<6){return moment(a,b).from()}return Ext.Date.format(a,mvstr.DATE_Full||'F j, Y')}},0,0,0,0,0,0,[customData,'Util'],0);Ext.cmd.derive('customData.fields.tzadate',Ext.data.field.Date,{statics:{convertFn:function(a){if(!a){return null}a=String(a);if(a.match(/^\d{4}-\d{2}-\d{2}$/)){return Ext.Date.parse(a,'Y-m-d')}var b=a.split(' ');if(b.length>4){b.pop()}return new Date(b.join(' '))}},convert:function(a){return customData.fields.tzadate.convertFn(a)},depends:[]},0,0,0,0,['data.field.tzadate'],0,[customData.fields,'tzadate'],0);Ext.cmd.derive('mdsData.FloorplanValues',Ext.Base,{statics:{DEFAULT_ICON_SIZE:[33,33],DEFAULT_ICON_ANCHOR:[5,26],PUNCHPIN_ICON_ANCHOR:[16,16],ICON_ANCHORS:{5:[17,4],6:[29,17],7:[17,29],8:[4,17],15:[24,8],16:[24,24],17:[8,24],18:[8,8]},iconTemplate:new Ext.XTemplate(['<div class="plan-pin-icon {cls}" style="width: {width}px; height: {height}px; background-image: url(\'{PushpinSymbol}\')">','<span class="text-overlay">{TextOverlay}</span>','</div>'])}},0,0,0,0,0,0,[mdsData,'FloorplanValues'],0);Ext.cmd.derive('mdsData.PreferenceValues',Ext.Base,{statics:{MEASURE_PREFERENCE_IMPERIAL:1,MEASURE_PREFERENCE_METRIC:2}},0,0,0,0,0,0,[mdsData,'PreferenceValues'],0);Ext.cmd.derive('mdsData.PunchlistValues',Ext.Base,{singleton:!0,PUNCH_STATUS:{OPEN:1,CLOSED:2,ON_HOLD:3},WORK_STATUS:{NOT_STARTED:1,IN_PROGRESS:2,COMPLETE:3,ON_HOLD:4},LIST_DESC:{1:'Punch List',2:'QA/QC List',3:'FM List'},LIST_DESC_LONG:{1:'Punch List',2:'QA/QC List',3:'FM List'},LIST_ITEM_DESC:{1:'Punch Item',2:'QA/QC Item',3:'FM Item'},ACTION_CHANGE_TO_IN_PROGRESS:1,ACTION_CHANGE_TO_ON_HOLD:2,ACTION_CHANGE_TO_COMPLETE:3,ACTION_CHANGE_TO_NOT_STARTED:4,ACTION_DELETE:5,ACTION_MOVE_TO_CLOSED:6,ACTION_MOVE_TO_OPEN:7,ACTION_PRINT:8,ACTION_SELECT_ALL:9,ACTION_PRINT_DETAILS:10,ACTION_TOGGLE_CLOSED:11,ACTION_CSV:12,ACTION_BATCH:13,ACTION_CLONE:14,SUBMENU_CHANGE_WORK_STATUS:1001,SUBMENU_EXPORT:1002,SUBMENU_CLONE:1003,SUBMENU_CLONE_SETTINGS:1004,isOverdue:function(b){var a=Ext.Date.diff(new Date(),b.DueDate,Ext.Date.HOUR);return a<0&&a<=-24&&b.PunchStatusID!=mdsData.PunchlistValues.PUNCH_STATUS.CLOSED},constructor:function(){this.WORK_STATUS_LABELS={};this.WORK_STATUS_LABELS[this.WORK_STATUS.NOT_STARTED]='Not Started';this.WORK_STATUS_LABELS[this.WORK_STATUS.IN_PROGRESS]='In Progress';this.WORK_STATUS_LABELS[this.WORK_STATUS.COMPLETE]='Complete';this.WORK_STATUS_LABELS[this.WORK_STATUS.ON_HOLD]='On Hold';this.WORK_STATUSES=[{WorkStatusID:this.WORK_STATUS.ON_HOLD,Label:this.WORK_STATUS_LABELS[this.WORK_STATUS.ON_HOLD]},{WorkStatusID:this.WORK_STATUS.NOT_STARTED,Label:this.WORK_STATUS_LABELS[this.WORK_STATUS.NOT_STARTED]},{WorkStatusID:this.WORK_STATUS.IN_PROGRESS,Label:this.WORK_STATUS_LABELS[this.WORK_STATUS.IN_PROGRESS]},{WorkStatusID:this.WORK_STATUS.COMPLETE,Label:this.WORK_STATUS_LABELS[this.WORK_STATUS.COMPLETE]}];this.PUNCH_STATUS_LABELS={};this.PUNCH_STATUS_LABELS[this.PUNCH_STATUS.OPEN]='Open';this.PUNCH_STATUS_LABELS[this.PUNCH_STATUS.CLOSED]='Closed';this.PUNCH_STATUS_LABELS[this.PUNCH_STATUS.ON_HOLD]='On Hold';this.PUNCH_STATUSES=[{PunchStatusID:this.PUNCH_STATUS.OPEN,Label:this.PUNCH_STATUS_LABELS[this.PUNCH_STATUS.OPEN]},{PunchStatusID:this.PUNCH_STATUS.CLOSED,Label:this.PUNCH_STATUS_LABELS[this.PUNCH_STATUS.CLOSED]},{PunchStatusID:this.PUNCH_STATUS.ON_HOLD,Label:this.PUNCH_STATUS_LABELS[this.PUNCH_STATUS.ON_HOLD]}]}},1,0,0,0,0,0,[mdsData,'PunchlistValues'],0);Ext.cmd.derive('mdsData.model.File',Ext.data.Model,{fields:[{name:'DocumentUID',type:'string'},{name:'DocumentID',type:'number',persist:!1},{name:'DocumentType',type:'number',persist:!1},{name:'DocumentParent',type:'number',persist:!1},{name:'DocumentSymbol',type:'string',persist:!1},{name:'DocumentShortName',type:'string',persist:!1},{name:'DocumentDescription',type:'string',persist:!1},{name:'DocumentFilename',type:'string',persist:!1},{name:'DocumentURL',type:'string',persist:!1},{name:'DocumentFileSize',type:'number',persist:!1},{name:'DocumentMimeType',type:'string',persist:!1},{name:'DocumentTypeName',type:'string',persist:!1},{name:'DocumentCreator',type:'number',persist:!1},{name:'DocumentCreatorName',type:'string',persist:!1},{name:'DocumentCreationDate',type:'date',persist:!1},{name:'DocumentLastEditedDate',type:'date',persist:!1},{name:'DocumentIsDeleted',type:'boolean',persist:!1},{name:'ShareTypeID',type:'int',persist:!1},{name:'MemberList',type:'string',persist:!1},{name:'expanded',type:'boolean',persist:!1,convert:function(b,a){return !0}},{name:'leaf',type:'boolean',persist:!1,convert:function(b,a){return !a.get('DocumentMimeType')=='folder'}},{name:'isFolder',type:'boolean',persist:!1,convert:function(b,a){return a.get('DocumentMimeType')=='folder'}},{name:'DocumentSymbolLarge',calculate:function(a){return a.DocumentSymbol.replace('mds/module/clientFileManager/image/icons','mds/image/clientFileManager/icons/large')}}],idProperty:'DocumentUID'},0,0,0,0,0,0,[mdsData.model,'File'],0);Ext.cmd.derive('mdsData.model.ListReport',Ext.data.Model,{fields:[{name:'ListTypeID',type:'int'},{name:'ProjectFlagName',type:'string'},{name:'PlanFlagName',type:'string'},{name:'Label',type:'string'},{name:'ProjectUID'},{name:'url',calculate:function(a){return mdslink.clientPunchlistOverview_Base+'ProjectUID='+a.ProjectUID+'&ListTypeID='+a.ListTypeID}},{name:'ItemLabel',calculate:function(a){return 'List Item'}}],idProperty:'ListTypeID'},0,0,0,0,0,0,[mdsData.model,'ListReport'],0);Ext.cmd.derive('mdsData.model.Location',Ext.data.Model,{fields:[{name:'Location'}],idProperty:'Location'},0,0,0,0,0,0,[mdsData.model,'Location'],0);Ext.cmd.derive('mdsData.model.Floorplan',Ext.data.Model,{fields:[{name:'FloorplanUID',mapping:'PunchlistPlanUID'},'ImageURL','ProjectShootTypeLabel',{name:'FloorplanDescription',mapping:'PunchlistPlanDescription'},'ProjectUID','ListTypeID',{name:'BaseURL',mapping:function(a){return a.PunchlistPlanUID?mdslink.clientFloorplanViewer_punchlistPlan:mdslink.clientFloorplanViewer}},{name:'Pins',convert:function(a,c){if(!a||!a.length){return []}for(var b=0;b<a.length;b++){a[b].Cls=a[b].PushpinTypeName.toLowerCase().replace(/\W+/g,'')}}},{name:'CommentCount',type:'int',defaultValue:0,persist:!1},{name:'PushpinCount',type:'int',defaultValue:0,persist:!1}],idProperty:'FloorplanUID'},0,0,0,0,0,0,[mdsData.model,'Floorplan'],0);Ext.cmd.derive('mdsData.model.Photo',Ext.data.Model,{fields:[{name:'ImageURL',type:'string',persist:!1},{name:'CreatorName',type:'string',persist:!1,mapping:'UploadedBy'},{name:'ImageURLThumb',type:'string',persist:!1,mapping:'ThumbURL'},{name:'ImageURLMedium',type:'string'},{name:'Identifier',type:'string',mapping:'UDEFPhotoUID'},{name:'PushpinUID',type:'string'},{name:'FileName',type:'string',persist:!1,mapping:'UDEFPhotoOriginalFileName'},{name:'PhotoDate',mapping:function(a){return a.PhotoDate||a.UDEFPhotoDate||a.UDEFPhotoUploadDate},type:'tzadate',persist:!1},{name:'FileSize',persist:!1,defaultValue:0,mapping:'UDEFPhotoFileSize'},{name:'Type',defaultValue:'U'},{name:'ImageURLUnaltered',type:'string',persist:!1,calculate:function(a){return a.ImageURL.replace('originals','unaltered')}},{name:'PhotoNumber'},{name:'DescLine1',mapping:function(a){if(a.FileName){return a.FileName}if(a.Description){return a.Description}}},{name:'DescLine2',mapping:function(a){if(a.CreatorName){return a.CreatorName}if(a.Location){return a.Location}}},{name:'DescLine3',calculate:function(b){var a=[],f=b.Type,c=b.PhotoNumber,e=b.PhotoDate,d=Ext.Date.format(e,f=='W'?mvstr['DATE_Medium2']+' g:i A':mvstr['DATE_Medium2']);if(d){a.push(d)}if(c){a.push(mvstr['PV_Photo {x}'].replace('{x}',c))}return a.join(' - ')}},{name:'LoadedImage',defaultValue:''},{name:'PunchItemID',type:'int'},{name:'Selected',type:'boolean',defaultValue:!1,persist:!1},{name:'SelectedCls',calculate:function(a){return a.Selected?'selected':''}},{name:'Active',defaultValue:!1},{name:'IsFavourite',type:'boolean',defaultValue:!1},{name:'FavouriteCls',calculate:function(a){return a.IsFavourite?'favourite':''}},{name:'title',calculate:function(a){var b=[];if(a.DescLine1){b.push(a.DescLine1)}if(a.DescLine2){b.push(a.DescLine2)}if(a.DescLine3){b.push(a.DescLine3)}return b.join(' - ')}},{name:'id',calculate:function(a){return a.Type+a.Identifier}},{name:'x',type:'int'},{name:'y',type:'int'},{name:'IsOwnedByUser',type:'boolean',defaultValue:!1},{name:'ShareTypeID',type:'int'},{name:'MemberUIDs'},{name:'HotspotID',mapping:'hotspotID'},{name:'FloorplanUID',mapping:'floorplanUID'},{name:'WebcamUID'},{name:'CmiName'},{name:'HasAnnotations',type:'boolean'},{name:'HasMeasurements',type:'boolean'},{name:'HasDrawables',calculate:function(a){return !!(a.HasMeasurements||a.HasAnnotations)}},{name:'OriginalsWidth',type:'int'},{name:'OriginalsHeight',type:'int'},{name:'ShootUID'},{name:'Orientation'},{name:'MediumWidth',type:'int',defaultValue:0},{name:'MediumHeight',type:'int',defaultValue:0},{name:'IsInteriorPano',type:'boolean',defaultValue:!1},{name:'Is360Pano',type:'boolean',defaultValue:!1},{name:'CanSnapshot',type:'boolean',calculate:function(a){return a.Is360Pano||a.IsInteriorPano}},{name:'PhotoLatitude'},{name:'PhotoLongitude'},{name:'PhotoAltitude'}],idProperty:'Identifier',getPhotoEventProperties:function(){var a='Photo';if(this.get('IsInteriorPano')){a='SW360';if(this.get('IsTruView')){a='TruView'}}else {if(this.get('CmiName')){a='BLK3D'}else {if(this.get('IsPano')){a='UAVPano'}else {if(this.get('Type')==='P'&&this.get('Is360Pano')){a='360'}else {if(this.get('Type')==='U'){if(this.get('Is360Pano')){a='UDEF360'}else {a='UDEF'}}else {if(this.get('Type')==='W'){a='Webcam'}}}}}}return {'Photo ID':this.get('Identifier'),'Photo Type':a,'Photo ID with Prefix':this.get('id')}}},0,0,0,0,0,0,[mdsData.model,'Photo'],0);Ext.cmd.derive('mdsData.model.Pushpin',Ext.data.Model,{fields:[{name:'PushpinUID',type:'string'},{name:'PushpinLabel',type:'string',persist:!0},{name:'PushpinType',type:'number'},{name:'PushpinCreationDate',type:'date'},{name:'PushpinXCoordinate',type:'number'},{name:'PushpinYCoordinate',type:'number'},{name:'PushpinSymbol',type:'string',persist:!1},{name:'ShareTypeID',type:'number'},{name:'MemberList',type:'string'},{name:'IsOwner',type:'boolean',persist:!1},{name:'PunchItemID',type:'string',persist:!1},{name:'floorplanImage',type:'string',persist:!1},{name:'LocationName',type:'string',persist:!1},{name:'TextOverlay',type:'string',persist:!1},{name:'FloorplanUID',type:'string'},{name:'ListTypeID',type:'string',persist:!1},{name:'ProjectUID',type:'string'},{name:'PunchPinOverviewURL',type:'string',calculate:function(a){return mdslink.server+'/index.cfm?fuseaction=aClientPunchlist.getPinOverviewImage&ProjectUID='+a.ProjectUID+'&FloorplanUID='+a.FloorplanUID+'&PushpinXCoordinate='+a.PushpinXCoordinate+'&PushpinYCoordinate='+a.PushpinYCoordinate+'&showBorders=true&PunchStatusID='+a.PunchStatusID+'&WorkStatusID='+a.WorkStatusID+'&DueDate='+Ext.Date.format(a.DueDate,'Y-m-d')+'&TextOverlay='+a.TextOverlay}},{name:'PunchPinZoomURL',type:'string',calculate:function(a){return mdslink.server+'/index.cfm?fuseaction=aClientPunchlist.getPinZoomedImage&ProjectUID='+a.ProjectUID+'&FloorplanUID='+a.FloorplanUID+'&PushpinXCoordinate='+a.PushpinXCoordinate+'&PushpinYCoordinate='+a.PushpinYCoordinate+'&showBorders=true&PunchStatusID='+a.PunchStatusID+'&WorkStatusID='+a.WorkStatusID+'&DueDate='+Ext.Date.format(a.DueDate,'Y-m-d')+'&TextOverlay='+a.TextOverlay}},{name:'PunchStatusID',type:'int'},{name:'WorkStatusID',type:'int'},{name:'DueDate',type:'date'}],idProperty:'PushpinUID',proxy:{type:'jsonp',reader:{type:'json',rootProperty:'data'},api:{read:'index.cfm?fuseaction=aClientFloorplanViewer.getPushpin',update:'index.cfm?fuseaction=aClientFloorplanViewer.updatePushpin666',destroy:'index.cfm?fuseaction=aClientFloorplanViewer.deletePushpin666'}}},0,0,0,0,0,0,[mdsData.model,'Pushpin'],0);Ext.cmd.derive('mdsData.store.Files',Ext.data.Store,{model:'mdsData.model.File',sorters:[{property:'isFolder',direction:'DESC'}]},0,0,0,0,['store.files'],0,[mdsData.store,'Files'],0);Ext.cmd.derive('mdsData.store.ListReports',Ext.data.Store,{model:'mdsData.model.ListReport',proxy:{type:'jsonp',api:{read:'index.cfm?fuseaction=aClientPunchlist.getProjectAvailableListsAndReports'}}},0,0,0,0,['store.listreports'],0,[mdsData.store,'ListReports'],0);Ext.cmd.derive('mdsData.store.Locations',Ext.data.Store,{model:'mdsData.model.Location',proxy:{type:'memory'},sorters:[{sorterFn:function(j,k){var a=j.get('Location'),b=k.get('Location'),f=/\s*\d.*/,g=/([\d]+)/,h=a.replace(f,''),i=b.replace(f,''),e=a==b?0:a<b?-1:1;if(a=='All locations'){return 1}if(b=='All locations'){return -1}if(h==i){var c=0,d=0;while(c==d){if(g.exec(a)===null){return e}c=Number(RegExp.$1);if(g.exec(b)===null){return e}d=Number(RegExp.$1);if(c!=d){return c<d?1:-1}a=a.replace(c,'');b=b.replace(d,'')}}return e}}],isLoaded:function(){return !!this.getCount()}},0,0,0,0,['store.locations'],0,[mdsData.store,'Locations'],0);Ext.cmd.derive('sharedLookup.model.Follower',Ext.data.Model,{idProperty:'MemberUID',fields:[{name:'MemberUID',type:'string'},{name:'IsCreator',type:'boolean',persist:!1},{name:'IsSubscriber',type:'boolean',persist:!0},{name:'IsFollower',type:'boolean',calculate:function(a){return !!(a.IsCreator||a.IsSubscriber)}},{name:'NoAccess',type:'boolean'},{name:'MemberFirstName',type:'string',persist:!1},{name:'MemberLastName',type:'string',persist:!1},{name:'MemberName',type:'string',persist:!1,calculate:function(a){return Ext.String.trim((a.MemberFirstName?a.MemberFirstName:'')+' '+(a.MemberLastName?a.MemberLastName:''))}}]},0,0,0,0,0,0,[sharedLookup.model,'Follower'],0);Ext.cmd.derive('sharedLookup.model.ProjectSelector',Ext.data.Model,{fields:[{name:'projectTitle',type:'string'},{name:'projectListing',type:'string',convert:function(b,a){if(a.get('ProjectID')){return a.get('ProjectID')+' - '+a.get('projectTitle')}return a.get('projectTitle')}},{name:'projectAddress',type:'string'},{name:'ProjectName',type:'string'},{name:'ProjectAddress1',type:'string'},{name:'ProjectAddress2',type:'string'},{name:'ProjectLatitude',type:'float'},{name:'ProjectLongitude',type:'float'},{name:'ProjectUID',type:'string'},{name:'lastUpdate',type:'string'},{name:'imageURL',type:'string'},{name:'image16URL',type:'string'},{name:'image24URL',type:'string'},{name:'image32URL',type:'string'},{name:'image64URL',type:'string'},{name:'companyLogoURL',type:'string',defaultValue:''},{name:'projectLogoURL',type:'string',defaultValue:''},{name:'isHidden',type:'bool'},{name:'ProjectID',type:'int'}]},0,0,0,0,0,0,[sharedLookup.model,'ProjectSelector'],0);Ext.cmd.derive('sharedLookup.model.date.DateRange',Ext.data.Model,{fields:[{name:'Label',type:'string'},{name:'StartDate',type:'date'},{name:'EndDate',type:'date'}],idProperty:'Label'},0,0,0,0,0,0,[sharedLookup.model.date,'DateRange'],0);Ext.cmd.derive('sharedLookup.store.date.DateRanges',Ext.data.Store,{model:'sharedLookup.model.date.DateRange',proxy:{type:'memory'},statics:{setDateToMidnight:function(a){a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);return a},nDaysAgo:function(a){return sharedLookup.store.date.DateRanges.setDateToMidnight(Ext.Date.add(new Date(),Ext.Date.DAY,-1*a))},startOfMonthNMonthsAgo:function(b){var a=Ext.Date.add(new Date(),Ext.Date.MONTH,-1*b);a.setDate(1);return sharedLookup.store.date.DateRanges.setDateToMidnight(a)},endOfMonthNMonthsAgo:function(a){return Ext.Date.add(sharedLookup.store.date.DateRanges.startOfMonthNMonthsAgo(a-1),Ext.Date.DAY,-1)}},constructor:function(a){a=a||{};a.data=[];a.data.push({Label:mvstr['GSL_Custom'],StartDate:null,EndDate:null});a.data.push({Label:mvstr['GSL_Last 30 Days'],StartDate:this.self.nDaysAgo(30),EndDate:new Date()});a.data.push({Label:mvstr['GSL_Last 90 Days'],StartDate:this.self.nDaysAgo(90),EndDate:new Date()});a.data.push({Label:mvstr['GSL_All Time'],StartDate:null,EndDate:null});Ext.data.Store.prototype.constructor.call(this,a)}},1,0,0,0,['store.dateranges'],0,[sharedLookup.store.date,'DateRanges'],0);Ext.cmd.derive('sharedLookup.view.date.DatePicker',Ext.picker.Date,{config:{isStartDate:!0},showToday:!1},0,['photoGroupDatePicker'],['component','box','datepicker','photoGroupDatePicker'],{'component':!0,'box':!0,'datepicker':!0,'photoGroupDatePicker':!0},['widget.photoGroupDatePicker'],0,[sharedLookup.view.date,'DatePicker'],0);Ext.cmd.derive('sharedLookup.view.date.DatePickerWindow',Ext.window.Window,{title:'Custom Date Range',modal:!0,layout:'vbox',closeAction:'hide',config:{viewport:null,callback:null},items:[{reference:'startDatePicker',xtype:'photoGroupDatePicker'},{reference:'endDatePicker',xtype:'photoGroupDatePicker',isStartDate:!1},{xtype:'container',defaultType:'button',width:176,defaults:{margin:3},layout:{type:'hbox',pack:'center'},items:[{text:'OK',listeners:{click:'onDateRangeConfirm'}},{reference:'dateRangeCancel',text:'Cancel',listeners:{click:function(){this.up('window').hide()}}}]}],listeners:{hide:'onDatePickerWindowHide'}},0,['datepickerwindow'],['component','box','container','panel','window','datepickerwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'datepickerwindow':!0},['widget.datepickerwindow'],0,[sharedLookup.view.date,'DatePickerWindow'],0);Ext.cmd.derive('sharedLookup.view.date.DateSelector',Ext.form.field.ComboBox,{queryMode:'local',displayField:'Label',valueField:'Label',editable:!1,setDateRange:function(a){var b=this.store.getById(mvstr['GSL_All Time']);b.set('StartDate',a.startDate);b.set('EndDate',a.endDate)},setFilterRange:function(a){if(!a||a&&a.dateSelection==mvstr['GSL_All Time']){var d=this.store.getById(mvstr['GSL_All Time']);if(d){this.setValue(d)}return}var e=this.store.getCount();for(var b=e-1;b>=0;b--){var c=this.store.getAt(b);if(this.dateMatches(c,a)){this.setValue(c.get('Label'));return}}this.addCustomValue(a.startDate,a.endDate)},dateMatches:function(a,b){return Ext.Date.format(a.get('StartDate'),'Y-m-d')==Ext.Date.format(b.startDate,'Y-m-d')&&Ext.Date.format(a.get('EndDate'),'Y-m-d')==Ext.Date.format(b.endDate,'Y-m-d')},getDateLabel:function(a,b){return Ext.Date.format(a,'d/m/Y')+' - '+Ext.Date.format(b,'d/m/Y')},addCustomValue:function(a,b){var c=this.getDateLabel(a,b),d=Ext.create('sharedLookup.model.date.DateRange',{StartDate:a,EndDate:b,Label:c});this.store.add(d);this.setValue(c)},listeners:{select:'onDateSelectorSelect'}},0,['dateselector'],['component','box','field','textfield','pickerfield','combobox','combo','dateselector'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'dateselector':!0},['widget.dateselector'],0,[sharedLookup.view.date,'DateSelector'],0);Ext.cmd.derive('sharedLookup.view.date.DateSelectorController',Ext.app.ViewController,{init:function(){this.getViewModel().bind('{dateRange}',this.setDateRange,this)},setDateRange:function(a){this.setPickerRange(this.lookupReference('startDatePicker'),a,!0);this.setPickerRange(this.lookupReference('endDatePicker'),a,!1)},setPickerRange:function(f,e,g){if(!e.startDate||!e.endDate){return}var c=e.startDate,d=e.endDate,a=g?c:d,b=this.getViewModel().get('filterRange'),h=this.lookupReference('dateSelector');f.setMinDate(c);f.setMaxDate(d);if(b&&b.startDate&&b.endDate){if(g){a=b.startDate<c?c:b.startDate;a=a>d?d:a}else {a=b.endDate>d?d:b.endDate;a=a<c?c:a}}f.setValue(a)},onDateSelectorSelect:function(c){var a=c.getValue(),e=c.getStore();if(a==mvstr['PUL_Custom']){this.lookupReference('datePickerWindow').show();return}var b=e.getById(a),f=b.get('StartDate'),g=b.get('EndDate'),d={startDate:f,endDate:g,dateSelection:a};this.getViewModel().set('dateFilter.filterDateRange',d);this.getView().fireEvent('datechange',d,a)},onDateRangeConfirm:function(){var a=this.lookupReference('startDatePicker').getValue(),b=this.lookupReference('endDatePicker').getValue(),d=this.getViewModel(),c={startDate:a,endDate:b};d.set('dateFilter.filterDateRange',c);this.lookupReference('datePickerWindow').hide();var e=this.lookupReference('dateSelector');this.getView().fireEvent('datechange',c,e.getDateLabel(a,b))},onDatePickerWindowHide:function(){var a=this.lookupReference('dateSelector');if(a){a.setFilterRange(this.getViewModel().get('filterRange'))}}},0,0,0,0,['controller.dateselector'],0,[sharedLookup.view.date,'DateSelectorController'],0);Ext.cmd.derive('sharedLookup.view.date.DateSelectorModel',Ext.app.ViewModel,{formulas:{dateRange:function(c){var a=c('dateFilter.contextDateRange'),b=c('dateFilter.overallDateRange');return {startDate:a.startDate||b.startDate,endDate:a.endDate||b.endDate}},filterRange:function(b){var c=b('dateFilter.overallDateRange'),a=b('dateFilter.filterDateRange'),d=b('dateRange');if(!c.startDate||!d.startDate||!a.startDate){return null}return {startDate:a.startDate,endDate:a.endDate,dateSelection:a.dateSelection}}}},0,0,0,0,['viewmodel.dateselector'],0,[sharedLookup.view.date,'DateSelectorModel'],0);Ext.cmd.derive('sharedLookup.view.date.DateSelectorWrapper',Ext.Container,{controller:'dateselector',layout:{type:'fit'},viewModel:{type:'dateselector'},initComponent:function(){var a=Ext.merge(this.selectorConfig||{},{xtype:'dateselector',reference:'dateSelector',bind:{filterRange:'{filterRange}',dateRange:'{dateRange}'},defaultValue:mvstr['GSL_All Time'],store:Ext.create('sharedLookup.store.date.DateRanges')});this.items=[a,{xtype:'datepickerwindow',reference:'datePickerWindow',renderTo:Ext.getBody()}];Ext.container.Container.prototype.initComponent.apply(this,arguments)},getSelector:function(){return this.down('dateselector')}},0,['dateselectorwrapper'],['component','box','container','dateselectorwrapper'],{'component':!0,'box':!0,'container':!0,'dateselectorwrapper':!0},['widget.dateselectorwrapper'],0,[sharedLookup.view.date,'DateSelectorWrapper'],0);Ext.cmd.derive('sharedLookup.view.follow.FollowerGrid',Ext.grid.Panel,{cls:'follower-list tasklist-member-grid',ui:'detail-popup',disableSelection:!0,bind:{store:'{followers}'},hideHeaders:!0,columns:[{xtype:'checkcolumn',dataIndex:'IsFollower',width:50,listeners:{checkchange:function(c,d,b,a){a.set('IsSubscriber',b)}}},{dataIndex:'MemberName',flex:1}],tbar:[{xtype:'component',html:"Select users you'd like to follow this item"},'->',{xtype:'button',height:25,minWidth:70,ui:'orange',scale:'small',textAlign:'left',bind:{isFollower:'{isFollower}',disabled:'{followDisabled}'},setIsFollower:function(a){this.setText(a?'Following':'Follow');this.setIconCls(a?'follow-icon-check':'follow-icon-follow')},listeners:{click:'onFollowClick'}}],viewConfig:{getRowClass:function(b){var a=[];if(b.get('IsCreator')){a.push('disabled-row creator')}if(b.get('NoAccess')){a.push('no-access')}return a.join(' ')}}},0,['followerGrid'],['component','box','container','panel','tablepanel','gridpanel','grid','followerGrid'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tablepanel':!0,'gridpanel':!0,'grid':!0,'followerGrid':!0},['widget.followerGrid'],0,[sharedLookup.view.follow,'FollowerGrid'],0);Ext.cmd.derive('formShared.IntegrationsUtil',Ext.Base,{singleton:!0,getDisplayDateString:function(b){var a=Ext.Date.parse('00:00','H:i');a=Ext.Date.add(a,Ext.Date.HOUR,b.time_hour);a=Ext.Date.add(a,Ext.Date.MINUTE,b.time_minute);return Ext.Date.format(a,'g:ia')}},0,0,0,0,0,0,[formShared,'IntegrationsUtil'],0);Ext.cmd.derive('formShared.model.IntegrationEntityType',Ext.data.Model,{fields:[{name:'id',type:'string'},{name:'name',type:'string'},{name:'storeType',type:'string',defaultValue:null},{name:'createAction',type:'string',defaultValue:null},{name:'searchFields',defaultValue:null},{name:'subCreateActions',defaultValue:null},{name:'subSearchFields',defaultValue:null},{name:'hasSubStores',defaultValue:!1}]},0,0,0,0,0,0,[formShared.model,'IntegrationEntityType'],0);Ext.cmd.derive('formShared.view.grid.ManualRowEditor',Ext.grid.RowEditor,{startEdit:function(g,h){var a=this,d=a.editingPlugin,e=d.grid,f=a.context=d.context,c=a.isVisible(),b=a.wrapEl;if(a._cachedNode){a.clearCache()}Ext.suspendLayouts();if(!a.rendered){a.width=a.getClientWidth();a.render(e.el,e.el.dom.firstChild);b=a.wrapEl=a.el.wrap();b.setVisibilityMode(3);b.addCls(a._wrapCls);a.getFloatingButtons().render(b);a.onViewScroll()}a.setLocalY(0);a.context=f;a.onGridResize();a.loadRecord(g);Ext.resumeLayouts(c);if(c){a.reposition(!0)}else {a.skipFocusScroll=!0;a.show()}}},0,['manualroweditor'],['component','box','container','panel','form','roweditor','manualroweditor'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'roweditor':!0,'manualroweditor':!0},['widget.manualroweditor'],0,[formShared.view.grid,'ManualRowEditor'],0);Ext.cmd.derive('formShared.plugin.ManualEditing',Ext.grid.plugin.RowEditing,{initEditTriggers:Ext.emptyFn,initEditor:function(){return new formShared.view.grid.ManualRowEditor(this.initEditorConfig())}},0,0,0,0,['plugin.manualediting'],0,[formShared.plugin,'ManualEditing'],0);Ext.cmd.derive('formShared.view.components.Combo',Ext.form.field.ComboBox,{cls:'detail-form-combo',ui:'detail-form',width:160,editable:!1,queryMode:'local',labelAlign:'top',labelSeparator:'',constructor:function(a){if(a&&a.showRequiredText){a.afterLabelTextTpl=new Ext.XTemplate('<span class="mvRequired">(mvstr[G_Required])</span>')}Ext.form.field.ComboBox.prototype.constructor.apply(this,arguments)},listeners:{render:function(){if(this.labelEl){this.labelEl.on('mousedown',function(a){if(this.isExpanded){a.stopEvent()}}.bind(this))}}}},1,['detailformcombo'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0},['widget.detailformcombo'],0,[formShared.view.components,'Combo'],0);Ext.cmd.derive('formShared.view.components.ComboGrouped',formShared.view.components.Combo,{queryMode:'local',displayField:'name',valueField:'id',listConfig:{cls:'grouped-list'},config:{grouperField:'category'},initComponent:function(){var a=this.getGrouperField();this.tpl=Ext.create('Ext.XTemplate','{[this.currentKey = null]}<tpl for=".">','<tpl if="this.shouldShowHeader('+a+')"><div class="group-header">{[this.showHeader(values.'+a+')]}</div></tpl><div class="x-boundlist-item">{name}</div>','</tpl>',{shouldShowHeader:function(a){return this.currentKey!=a},showHeader:function(a){this.currentKey=a;return a}});formShared.view.components.Combo.prototype.initComponent.apply(this,arguments)}},0,['detailformgroupedcombo'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','detailformgroupedcombo'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'detailformgroupedcombo':!0},['widget.detailformgroupedcombo'],0,[formShared.view.components,'ComboGrouped'],0);Ext.cmd.derive('formShared.view.components.ComboMultiselect',Ext.form.field.Tag,{cls:'detail-form-multi-combo',ui:'detail-form',width:160,selectOnFocus:!1,grow:!1,queryMode:'local',labelAlign:'top',labelSeparator:'',listConfig:{cls:'detail-form-multi-combo',getInnerTpl:function(a){return '<img src="'+Ext.BLANK_IMAGE_URL+'" class="checkbox" /> {'+a+'}'}},listeners:{render:function(){if(this.labelEl){this.labelEl.on('mousedown',function(a){if(this.isExpanded){a.stopEvent()}}.bind(this))}}}},0,['detailformmulticombo'],['component','box','field','textfield','pickerfield','combobox','combo','tagfield','detailformmulticombo'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'tagfield':!0,'detailformmulticombo':!0},['widget.detailformmulticombo'],0,[formShared.view.components,'ComboMultiselect'],0);Ext.cmd.derive('formShared.view.components.DateField',Ext.form.field.Date,{ui:'detail-form',labelAlign:'top',labelSeparator:'',cls:'with-icon',mvPickerUI:'mds-light'},0,['detailformdatefield'],['component','box','field','textfield','pickerfield','datefield','detailformdatefield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'datefield':!0,'detailformdatefield':!0},['widget.detailformdatefield'],0,[formShared.view.components,'DateField'],0);Ext.cmd.derive('formShared.view.components.MultiSelect',Ext.container.Container,{config:{layout:{type:'vbox'},width:300,title:'',displayField:'text',valueField:'',viewConfig:{},cls:{$value:['mds-multiselect'],merge:function(a,b){var c=[].concat(a,b);return c}}},initComponent:function(){var a=this.getDisplayField(),d=this.getTitle(),c=this.getViewConfig(),b=this.config.required?'<span class="mvRequired">('+mvstr['TL_Required']+')</span>':'';this.setValueField(this.getValueField()||a);Ext.applyIf(this,{items:[{xtype:'container',width:'100%',layout:{type:'hbox',align:'middle'},items:[{xtype:'label',cls:'x-form-item-label-detail-form',html:d+b,flex:1},{xtype:'button',itemId:'addButton',ui:'orange',text:'+',cls:'multiselect-add',width:18,height:18,textAlign:'center',listeners:{click:function(){this.up('multiselect').fireEvent('onaddclick')}}}]},{xtype:'component',flex:1},Ext.merge({xtype:'dataview',cls:'multiselect-view',width:this.config.width,height:105,minHeight:27,scrollable:{x:!1,y:'auto'},itemSelector:'.multiselect-item',tpl:new Ext.XTemplate('<tpl for=".">','<div class="multiselect-item">','<span class="multiselect-value">{'+a+'}</span>','<span class="multiselect-remove"></span>','</div>','</tpl>'),listeners:{itemclick:function(b,a,e,d,c){if(Ext.fly(c.getTarget()).hasCls('multiselect-remove')){b.getStore().remove(a);this.up('multiselect').fireEvent('removerecord',a)}}}},c)]});Ext.container.Container.prototype.initComponent.apply(this,arguments)},setReadOnly:function(a){if(a){this.el.removeCls('can-edit')}else {this.el.addCls('can-edit')}},setWidth:function(b){var a=this.down('dataview');if(a){a.setWidth(b)}(arguments.callee.$previous||Ext.container.Container.prototype.setWidth).apply(this,arguments)}},0,['multiselect'],['component','box','container','multiselect'],{'component':!0,'box':!0,'container':!0,'multiselect':!0},['widget.multiselect'],0,[formShared.view.components,'MultiSelect'],0);Ext.cmd.derive('formShared.view.components.NumberField',Ext.form.field.Number,{ui:'detail-form',labelAlign:'top',hideTrigger:!0,labelSeparator:''},0,['detailformnumberfield'],['component','box','field','textfield','spinnerfield','numberfield','detailformnumberfield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'spinnerfield':!0,'numberfield':!0,'detailformnumberfield':!0},['widget.detailformnumberfield'],0,[formShared.view.components,'NumberField'],0);Ext.cmd.derive('formShared.view.components.PhotoSelectionThumb',Ext.Component,{viewModel:{formulas:{photoSrc:function(b){var a=b('selectedPhotos');if(!a){return 'mds/images/transparent.png'}return a.getAt(0).get('ImageURLMedium')},photoCount:function(b){var a=b('selectedPhotos');if(!a){return 0}return a.getCount()},description:function(b){var a=b('photoCount');return a+' '+(a==1?'photo':'photos')+' selected'}}},bind:{html:'<div class="wrapper"><img src="{photoSrc}"></div><div class="description">{description}</div>'},initComponent:function(){this.getViewModel().bind('{photoCount}',Ext.bind(function(a){if(a==1){this.removeCls('multiple');this.addCls('single')}else {this.removeCls('single');this.addCls('multiple')}},this));Ext.Component.prototype.initComponent.apply(this,arguments)}},0,['photoselectionthumb'],['component','box','photoselectionthumb'],{'component':!0,'box':!0,'photoselectionthumb':!0},['widget.photoselectionthumb'],0,[formShared.view.components,'PhotoSelectionThumb'],0);(function(){var a=new Image(),b=new Image();a.src='mds/image/component/photothumb-top.svg';b.src='mds/image/component/photothumb-left.svg'})();Ext.cmd.derive('formShared.view.components.SaveButton',Ext.Container,{layout:{type:'absolute'},config:{disabled:!1,processing:!1,done:!1,width:62,height:30,localized:{text:'G_Done'}},viewModel:{data:{disabled:!1,processing:!1,done:!1,buttonWidth:62,localized:{buttonText:'G_Done'}},formulas:{imageVisible:function(a){return a('processing')||a('done')},imageCls:function(a){if(a('done')){return 'done'}if(a('processing')){return 'processing'}return ''}}},setDisabled:function(a){this.getViewModel().set('disabled',a)},updateProcessing:function(a){this.getViewModel().set('processing',a)},updateDone:function(a){this.getViewModel().set('done',a)},setWidth:function(a){var b=(arguments.callee.$previous||Ext.container.Container.prototype.setWidth).apply(this,arguments);this.getViewModel().set('buttonWidth',a);this.setIndicatorX(a+10);return b},updateText:function(a){this.getViewModel().set('buttonText',a)},setIndicatorX:function(a){if(this.items&&this.items.length>0){if(this.items[1]){this.items[1].x=a}else {if(this.items.items&&this.items.items[1]){this.items.items[1].setLocalX(a)}}}},items:[{xtype:'button',x:0,y:0,width:62,scale:'medium',ui:'green',localized:{text:'G_Done'},bind:{disabled:'{disabled}',text:'{buttonText}',width:'{buttonWidth}'},listeners:{click:function(){var a=this.up('savebutton');a.fireEvent('click',a)}}},{xtype:'component',x:72,y:0,width:30,height:30,hidden:!0,cls:'save-button-indicator',setCls:function(a){this.removeCls('done');this.removeCls('processing');this.addCls(a)},bind:{hidden:'{!imageVisible}',cls:'{imageCls}'}}]},0,['savebutton'],['component','box','container','savebutton'],{'component':!0,'box':!0,'container':!0,'savebutton':!0},['widget.savebutton'],0,[formShared.view.components,'SaveButton'],0);Ext.cmd.derive('formShared.view.components.ScrollPageBoundList',Ext.view.BoundList,{preserveScrollOnReload:!0,loadMask:!1,createPagingToolbar:function(){var a=this;return new Ext.toolbar.Paging({id:a.id+'-paging-toolbar',pageSize:a.pageSize,store:a.dataSource,border:!1,ownerCt:a,ownerLayout:a.getComponentLayout(),style:{display:'none'}})},onScroll:function(c,g,f){var a=this.pagingToolbar.store;if(a.isLoading()){return}var e=c.getMaxPosition().y;if(e-f<=0){var d=this.pagingToolbar.getPageData().pageCount,b=a.currentPage+1;if(b<=d){this.up().loadPage(b,{addRecords:!0})}}},listeners:{'viewready':{fn:function(){var a=this.getScrollable();a.addListener('scroll',this.onScroll,this,{buffer:20})},single:!0}}},0,['scrollpageboundlist'],['component','box','dataview','boundlist','scrollpageboundlist'],{'component':!0,'box':!0,'dataview':!0,'boundlist':!0,'scrollpageboundlist':!0},['widget.scrollpageboundlist'],0,[formShared.view.components,'ScrollPageBoundList'],0);Ext.cmd.derive('formShared.view.components.SearchField',Ext.form.field.Text,{ui:'searchfield',cls:'empty',triggers:{clear:{cls:'clear',hidden:!0,handler:function(){this.setValue('')}}},listeners:{change:function(a,b){a.getTriggers().clear.setHidden(!b);if(b){a.removeCls('empty');a.fireEvent('search',b)}else {a.addCls('empty');a.fireEvent('clearsearch')}}}},0,['mvsearchfield'],['component','box','field','textfield','mvsearchfield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'mvsearchfield':!0},['widget.mvsearchfield'],0,[formShared.view.components,'SearchField'],0);Ext.cmd.derive('formShared.view.components.TextArea',Ext.form.field.TextArea,{ui:'detail-form',labelAlign:'top',labelSeparator:''},0,['detailformtextarea'],['component','box','field','textfield','textareafield','textarea','detailformtextarea'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'textareafield':!0,'textarea':!0,'detailformtextarea':!0},['widget.detailformtextarea'],0,[formShared.view.components,'TextArea'],0);Ext.cmd.derive('formShared.view.components.TextDateField',Ext.form.field.Number,{labelSeparator:'',height:17,hideTrigger:!0,autoStripChars:!0,validator:function(){var a=this.up(),d=a.down('#day').getValue(),b=a.down('#month').getValue(),c=a.down('#year').getValue();if(c==null&&b==null&&d==null||Ext.Date.isValid(c,b,d)){return !0}return 'Please enter a valid date.'},listeners:{render:function(a){a.el.select('input').elements[0].setAttribute('maxlength',a.maxLength)},change:{fn:function(a){this.up().onFieldChange(a)}}}},0,['textdatefield'],['component','box','field','textfield','spinnerfield','numberfield','textdatefield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'spinnerfield':!0,'numberfield':!0,'textdatefield':!0},['widget.textdatefield'],0,[formShared.view.components,'TextDateField'],0);Ext.cmd.derive('formShared.view.components.TextDate',Ext.Container,{layout:'hbox',publishes:['date','valid','dirty','empty'],config:{date:null,valid:!0,dirty:!1,empty:!0,initialDate:-1},defaults:{xtype:'textdatefield',margin:'0 15 0 0'},constructor:function(a){a=a||{};a.items=[{itemId:'month',fieldLabel:'Month',minValue:1,maxValue:12,width:62,labelWidth:36,maxLength:2},{itemId:'day',fieldLabel:'Day',minValue:1,maxValue:31,width:48,labelWidth:22,maxLength:2},{itemId:'year',fieldLabel:'Year',minValue:1753,maxValue:9999,width:68,labelWidth:29,margin:0,maxLength:4}];this.empty=!(a.date||this.config.date);Ext.container.Container.prototype.constructor.apply(this,arguments)},onFieldChange:function(){var d=this.items.items,a=0,b=!0;for(var c=0;c<d.length;c++){if(!d[c].validate()){b=!1}if(d[c].getValue()==null||d[c].getValue()==''){a++}}if(a==1||a==2){b=!1}var g=this.down('#day').getValue(),e=this.down('#month').getValue(),f=this.down('#year').getValue();if(!Ext.Date.isValid(f,e,g)){b=!1}this.setValid(b);var h=!!(a==3);this.setEmpty(h);if(a==0&&b){this.setDate(Ext.Date.parse(g+'-'+e+'-'+f,'j-n-Y'))}else {this.setDate(null)}},getDateFromFields:function(){if(!this.getValid()){return null}var c=this.down('#day').getValue(),a=this.down('#month').getValue(),b=this.down('#year').getValue();return Ext.Date.parse(c+'-'+a+'-'+b,'j-n-Y')},updateDate:function(a){var b=this.getDateFromFields();if(!Ext.Date.isEqual(b,a)){this.down('#day').setValue(Number(Ext.Date.format(a,'j')));this.down('#month').setValue(Number(Ext.Date.format(a,'n')));this.down('#year').setValue(Number(Ext.Date.format(a,'Y')))}this.setDirty(!Ext.Date.isEqual(a,this.getInitialDate()))},updateInitialDate:function(a){this.setDirty(!Ext.Date.isEqual(a,this.getDate()))}},1,['textdate'],['component','box','container','textdate'],{'component':!0,'box':!0,'container':!0,'textdate':!0},['widget.textdate'],0,[formShared.view.components,'TextDate'],0);Ext.cmd.derive('formShared.view.components.TextField',Ext.form.field.Text,{ui:'detail-form',labelAlign:'top',labelSeparator:'',constructor:function(a){if(a&&a.showRequiredText){a.afterLabelTextTpl=new Ext.XTemplate('<span class="mvRequired">(mvstr[G_Required])</span>')}Ext.form.field.Text.prototype.constructor.apply(this,arguments)}},1,['detailformtextfield'],['component','box','field','textfield','detailformtextfield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'detailformtextfield':!0},['widget.detailformtextfield'],0,[formShared.view.components,'TextField'],0);Ext.cmd.derive('formShared.view.integrations.FileSelectionBox',Ext.Container,{layout:{type:'hbox',align:'middle'},cls:'file-selection-box noselect',width:202,height:51,padding:'0 0 0 10',listeners:{click:{fn:function(c,b){if(b.type!='checkbox'){var a=Ext.getCmp(this.id).down('checkbox');a.setValue(!a.getValue())}},element:'el',scope:'this'}}},0,['integrationfileselectionbox'],['component','box','container','integrationfileselectionbox'],{'component':!0,'box':!0,'container':!0,'integrationfileselectionbox':!0},['widget.integrationfileselectionbox'],0,[formShared.view.integrations,'FileSelectionBox'],0);Ext.cmd.derive('formShared.view.integrations.Attachment',Ext.Container,{layout:'vbox',width:'100%',constructor:function(a){a=a||{};a.photoBinding=a.photoBinding||'{integrationAttachAsPhoto}';a.pdfBinding=a.pdfBinding||'{integrationAttachAs4View}';a.items=[{xtype:'label',cls:'instructions',localized:{html:'INT_SelectFiles'},margin:'0 0 15 0',bind:{hidden:'{attachFloorplanOnly}'}},{xtype:'container',layout:'hbox',width:'100%',items:[{xtype:'integrationfileselectionbox',items:[{xtype:'checkboxfield',inputValue:!0,uncheckedValue:!1,itemId:'attachPhoto',name:'attachAsPhoto',margin:'0 14 0 0',ui:'plain-16',bind:{value:a.photoBinding,disabled:'{attachFloorplanOnly}'},isValid:function(){if(this.isDisabled()){return !0}return !!(this.getValue()||this.up('integrationattachment').down('#attachDetails').getValue())},getErrors:function(){return this.isValid()?[]:[mvstr['INTMSG_NoAttachment']]}},{xtype:'image',src:'mds/image/icon/photo.png',width:32,height:26,margin:'0 14 0 0'},{xtype:'label',localized:{html:'INT_SelectFilesJPG'},width:63}]},{xtype:'component',flex:1},{xtype:'integrationfileselectionbox',items:[{xtype:'checkboxfield',inputValue:!0,uncheckedValue:!1,itemId:'attachDetails',name:'attachAs4View',ui:'plain-16',margin:'0 14 0 0',bind:{value:a.pdfBinding,disabled:'{attachFloorplanOnly}'},isValid:function(){if(this.isDisabled()){return !0}return !!(this.getValue()||this.up('integrationattachment').down('#attachPhoto').getValue())},getActiveErrors:function(){return this.isValid()?[]:[mvstr['INTMSG_NoAttachment']]}},{xtype:'image',src:'mds/image/icon/details.png',width:36,height:29,margin:'0 14 0 0'},{xtype:'label',localized:{html:'INT_SelectFilesPDF'},width:102}]}],bind:{hidden:'{attachFloorplanOnly}'}},{xtype:'container',layout:'column',cls:'floorplan-export-attachment',items:[{xtype:'label',cls:'instructions',localized:{html:'INT_FloorplanInstructions'},width:'100%',margin:'0 0 15 0'},{xtype:'checkboxfield',name:'displayHeader',inputValue:!0,uncheckedValue:!1,ui:'plain-16',localized:{boxLabel:'INT_FloorplanProjectNameTitle'},itemId:'headerCheckbox',value:!0,width:'100%',margin:'0 0 8 0'},{xtype:'checkboxfield',name:'displayHotspots',inputValue:!0,uncheckedValue:!1,ui:'plain-16',localized:{boxLabel:'INT_FloorplanMVContent'},itemId:'hotspotsCheckbox',value:!0,width:202,margin:'0 28 0 0',hidden:!0,bind:{hidden:'{!account.MultivistaContentPermission}'}},{xtype:'checkboxfield',name:'displayPushpins',inputValue:!0,uncheckedValue:!1,ui:'plain-16',localized:{boxLabel:'INT_FloorplanUDEFContent'},itemId:'pushpinsCheckbox',value:!0,width:202,hidden:!0,bind:{hidden:'{!account.canRead}'}}],hidden:!0,bind:{visible:'{attachFloorplanOnly}',disabled:'{!attachFloorplanOnly}'}}];Ext.container.Container.prototype.constructor.call(this,a)}},1,['integrationattachment'],['component','box','container','integrationattachment'],{'component':!0,'box':!0,'container':!0,'integrationattachment':!0},['widget.integrationattachment'],0,[formShared.view.integrations,'Attachment'],0);Ext.cmd.derive('formShared.view.integrations.Comments',formShared.view.components.TextArea,{localized:{fieldLabel:'INT_Comments'},itemId:'comments',width:'100%',height:110,margin:'0 0 28 0',name:'comment'},0,['integrationcomments'],['component','box','field','textfield','textareafield','textarea','detailformtextarea','integrationcomments'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'textareafield':!0,'textarea':!0,'detailformtextarea':!0,'integrationcomments':!0},['widget.integrationcomments'],0,[formShared.view.integrations,'Comments'],0);Ext.cmd.derive('formShared.view.integrations.Lookup',formShared.view.components.Combo,{name:'id',width:202,config:{entityType:null,noItemsAvailable:!1},itemId:'entities',editable:!0,localized:{emptyText:'G_Select',fieldLabel:'INT_Item'},queryMode:'local',displayField:'displayField',valueField:'id',disabled:!0,forceSelection:!0,listConfig:{loadMask:!1},bind:{value:'{entityID}',disabled:'{!projectsLoaded}',entityType:'{entityType}',store:'{entityStore}',emptyText:'{emptyText}',noItemsAvailable:'{noItemsAvailable}'},updateNoItemsAvailable:function(a){if(a){this.addCls('no-items-available')}else {this.removeCls('no-items-available')}},getLookupFilter:function(e){var b=this.getEntityType(),a=b.get('searchFields')||b.get('subSearchFields')[this.lookupController().getViewModel().get('subType')],d=e.toLowerCase(),c=function(a){return !!String(a).toLowerCase().match(d)};return this.queryFilter=new Ext.util.Filter({id:this.id+'-filter',filterFn:function(g){for(var d=0;d<a.length;d++){var b=g.get(a[d]);if(typeof b=='object'){for(var f in b){if(c(b[f])){return !0}}}if(c(b)){return !0}}return !1}})},doLocalQuery:function(c){var a=this,b=c.query,f=a.getStore(),e=b,d;a.clearLocalFilter();if(b){if(e!==null){a.changingFilters=!0;d=a.queryFilter=a.getLookupFilter(e);f.addFilter(d,!0);a.changingFilters=!1}}if(a.store.getCount()||a.getPicker().emptyText){a.getPicker().refresh();a.expand()}else {a.collapse()}a.afterQuery(c)},getErrors:function(){if(this.getValue()){return []}var a=this.getStore();if(a.isLoaded()&&!a.getCount()){return [mvstr['INTMSG_NoItems']]}else {return [mvstr['INTMSG_NoItem']]}}},0,['integrationlookup'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','integrationlookup'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'integrationlookup':!0},['widget.integrationlookup'],0,[formShared.view.integrations,'Lookup'],0);Ext.cmd.derive('formShared.view.integrations.RemoteLookup',formShared.view.components.Combo,{width:202,config:{entityType:null,noItemsAvailable:!1},itemId:'entities',editable:!0,fieldLabel:'Item',localized:{emptyText:'G_Select'},queryMode:'remote',minChars:1,displayField:'displayField',valueField:'id',disabled:!0,forceSelection:!0,pageSize:25,autoSelect:!1,clearFilterOnBlur:!1,bind:{value:'{entityID}',disabled:'{!projectsLoaded}',entityType:'{entityType}',store:'{entityStore}',emptyText:'{emptyText}',noItemsAvailable:'{noItemsAvailable}'},updateNoItemsAvailable:function(a){if(a){this.addCls('no-items-available')}else {this.removeCls('no-items-available')}},createPicker:function(){var a=this,b,c=Ext.apply({xtype:'scrollpageboundlist',id:a.id+'-picker',pickerField:a,selectionModel:a.pickerSelectionModel,floating:!0,hidden:!0,store:a.getPickerStore(),displayField:a.displayField,preserveScrollOnRefresh:!0,pageSize:a.pageSize,tpl:a.tpl,ariaSelectable:a.ariaSelectable},a.listConfig,a.defaultListConfig);b=a.picker=Ext.widget(c);if(a.pageSize){b.pagingToolbar.on('beforechange',a.onPageChange,a)}if(!b.initialConfig.maxHeight){b.on({beforeshow:a.onBeforePickerShow,scope:a})}b.getSelectionModel().on({beforeselect:a.onBeforeSelect,beforedeselect:a.onBeforeDeselect,focuschange:a.onFocusChange,scope:a});b.getNavigationModel().navigateOnSpace=!1;return b},afterQuery:function(){if(!this.store){return}formShared.view.components.Combo.prototype.afterQuery.apply(this,arguments)},onTriggerClick:function(e,d,b){var a=this,c;if(!a.readOnly&&!a.disabled){if(a.isExpanded){a.collapse()}else {if(b&&b.type==='keydown'&&b.altKey){c=a.autoSelect;a.autoSelect=!1;a.expand();a.autoSelect=c}else {if(!a.lastQuery){if(a.triggerAction==='all'){a.doQuery(a.allQuery,!0)}else {if(a.triggerAction==='last'){a.doQuery(a.lastQuery,!0)}else {a.doQuery(a.getRawValue(),!1,!0)}}}else {a.expand()}}}}},getErrors:function(){if(this.getValue()){return []}var a=this.getStore();if(a.isLoaded()&&!a.getCount()){return [mvstr['INTMSG_NoItems']]}else {return [mvstr['INTMSG_NoItem']]}}},0,['integrationremotelookup'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','integrationremotelookup'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'integrationremotelookup':!0},['widget.integrationremotelookup'],0,[formShared.view.integrations,'RemoteLookup'],0);Ext.cmd.derive('formShared.view.integrations.SubType',formShared.view.components.Combo,{width:202,itemId:'subType',localized:{fieldLabel:'INT_Action',emptyText:'G_Select'},queryMode:'local',displayField:'name',valueField:'id',editable:!1,submitValue:!1},0,['integrationssubtype'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','integrationssubtype'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'integrationssubtype':!0},['widget.integrationssubtype'],0,[formShared.view.integrations,'SubType'],0);Ext.cmd.derive('formShared.view.integrations.Type',formShared.view.components.Combo,{width:202,localized:{fieldLabel:'INT_Type',emptyText:'G_Select'},queryMode:'local',displayField:'name',valueField:'id',editable:!1,disabled:!0,bind:{value:'{integrationEntityType}',store:'{integrationEntityTypes}',disabled:'{!projectSelected}'},submitValue:!1},0,['integrationtype'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','integrationtype'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'integrationtype':!0},['widget.integrationtype'],0,[formShared.view.integrations,'Type'],0);Ext.cmd.derive('Ext.ux.IFrame',Ext.Component,{loadMask:'Loading...',src:'about:blank',renderTpl:['<iframe src="{src}" id="{id}-iframeEl" data-ref="iframeEl" name="{frameName}" width="100%" height="100%" frameborder="0"></iframe>'],childEls:['iframeEl'],initComponent:function(){Ext.Component.prototype.initComponent.call(this);this.frameName=this.frameName||this.id+'-frame'},initEvents:function(){var a=this;Ext.Component.prototype.initEvents.call(this);a.iframeEl.on('load',a.onLoad,a)},initRenderData:function(){return Ext.apply(Ext.Component.prototype.initRenderData.call(this),{src:this.src,frameName:this.frameName})},getBody:function(){var a=this.getDoc();return a.body||a.documentElement},getDoc:function(){try{return this.getWin().document}catch(b){return null}},getWin:function(){var a=this,b=a.frameName,c=Ext.isIE?a.iframeEl.dom.contentWindow:window.frames[b];return c},getFrame:function(){var a=this;return a.iframeEl.dom},onLoad:function(){var a=this,b=a.getDoc();if(b){this.el.unmask();this.fireEvent('load',this)}else {if(a.src){this.el.unmask();this.fireEvent('error',this)}}},load:function(c){var a=this,b=a.loadMask,d=a.getFrame();if(a.fireEvent('beforeload',a,c)!==!1){if(b&&a.el){a.el.mask(b)}d.src=a.src=c||a.src}}},0,['uxiframe'],['component','box','uxiframe'],{'component':!0,'box':!0,'uxiframe':!0},['widget.uxiframe'],0,[Ext.ux,'IFrame'],0);Ext.cmd.derive('Ext.ux.colorpick.Selection',Ext.Base,{mixinId:'colorselection',config:{format:'hex6',value:'FF0000',color:null,previousColor:null},applyColor:function(b){var a=b;if(Ext.isString(a)){a=Ext.ux.colorpick.ColorUtils.parseColor(b)}return a},applyValue:function(a){var b=Ext.ux.colorpick.ColorUtils.parseColor(a||'#000000');return this.formatColor(b)},formatColor:function(a){return Ext.ux.colorpick.ColorUtils.formats[this.getFormat()](a)},updateColor:function(b){var a=this;if(!a.syncing){a.syncing=!0;a.setValue(a.formatColor(b));a.syncing=!1}},updateValue:function(b,c){var a=this;if(!a.syncing){a.syncing=!0;a.setColor(b);a.syncing=!1}this.fireEvent('change',a,b,c)}},0,0,0,0,0,0,[Ext.ux.colorpick,'Selection'],0);Ext.cmd.derive('Ext.ux.colorpick.ColorUtils',Ext.Base,function(a){var b=Ext.isIE&&Ext.ieVersion<10;return {singleton:!0,constructor:function(){a=this},backgroundTpl:b?"filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr='#{alpha}{hex}', endColorstr='#{alpha}{hex}');":'background: {rgba};',setBackground:b?function(c,b){if(c){var f=Ext.XTemplate.getTpl(a,'backgroundTpl'),e={hex:a.rgb2hex(b.r,b.g,b.b),alpha:Math.floor(b.a*255).toString(16)},d=f.apply(e);c.applyStyles(d)}}:function(b,d){if(b){var f=Ext.XTemplate.getTpl(a,'backgroundTpl'),e={rgba:a.getRGBAString(d)},c=f.apply(e);b.applyStyles(c)}},formats:{HEX6:function(b){return a.rgb2hex(b.r,b.g,b.b)},HEX8:function(b){var c=a.rgb2hex(b.r,b.g,b.b),d=Math.round(b.a*255).toString(16);if(d.length<2){c+='0'}c+=d.toUpperCase();return c}},hexRe:/^#?([0-9a-f]{3,8})$/i,rgbaAltRe:/^rgba\(\s*([\w#\d]+)\s*,\s*([\d\.]+)\s*\)$/,rgbaRe:/^rgba\(\s*([\d\.]+)\s*,\s*([\d\.]+)\s*,\s*([\d\.]+)\s*,\s*([\d\.]+)\s*\)$/,rgbRe:/^rgb\(\s*([\d\.]+)\s*,\s*([\d\.]+)\s*,\s*([\d\.]+)\s*\)$/,parseColor:function(d){if(!d){return null}var e=this,f=e.colorMap[d],b,c,g;if(f){c={r:f[0],g:f[1],b:f[2],a:1}}else {if(d==='transparent'){c={r:0,g:0,b:0,a:0}}else {b=e.hexRe.exec(d);if(b){b=b[1];switch(b.length){default:return null;case 3:c={r:parseInt(b[0]+b[0],16),g:parseInt(b[1]+b[1],16),b:parseInt(b[2]+b[2],16),a:1};break;case 6:case 8:c={r:parseInt(b.substr(0,2),16),g:parseInt(b.substr(2,2),16),b:parseInt(b.substr(4,2),16),a:parseInt(b.substr(6,2)||'ff',16)/255};break;}}else {b=e.rgbaRe.exec(d);if(b){c={r:parseFloat(b[1]),g:parseFloat(b[2]),b:parseFloat(b[3]),a:parseFloat(b[4])}}else {b=e.rgbaAltRe.exec(d);if(b){c=e.parseColor(b[1]);c.a=parseFloat(b[2]);return c}b=e.rgbRe.exec(d);if(b){c={r:parseFloat(b[1]),g:parseFloat(b[2]),b:parseFloat(b[3]),a:1}}else {return null}}}}}g=this.rgb2hsv(c.r,c.g,c.b);return Ext.apply(c,g)},getRGBAString:function(b){return 'rgba('+b.r+','+b.g+','+b.b+','+b.a+')'},getRGBString:function(b){return 'rgb('+b.r+','+b.g+','+b.b+')'},hsv2rgb:function(e,i,h){e=e*360;if(e===360){e=0}var c=h*i;var g=e/60;var d=c*(1-Math.abs(g%2-1));var b=[0,0,0];switch(Math.floor(g)){case 0:b=[c,d,0];break;case 1:b=[d,c,0];break;case 2:b=[0,c,d];break;case 3:b=[0,d,c];break;case 4:b=[d,0,c];break;case 5:b=[c,0,d];break;default:break;}var f=h-c;b[0]+=f;b[1]+=f;b[2]+=f;b[0]=Math.round(b[0]*255);b[1]=Math.round(b[1]*255);b[2]=Math.round(b[2]*255);return {r:b[0],g:b[1],b:b[2]}},rgb2hsv:function(e,d,c){e=e/255;d=d/255;c=c/255;var g=Math.max(e,d,c);var k=Math.min(e,d,c);var f=g-k;var h=0;if(f!==0){if(g===e){h=(d-c)/f%6}else {if(g===d){h=(c-e)/f+2}else {if(g===c){h=(e-d)/f+4}}}}var b=h*60;if(b===360){b=0}var j=g;var i=0;if(f!==0){i=f/j}b=b/360;if(b<0){b=b+1}return {h:b,s:i,v:j}},rgb2hex:function(d,c,b){d=d.toString(16);c=c.toString(16);b=b.toString(16);if(d.length<2){d='0'+d}if(c.length<2){c='0'+c}if(b.length<2){b='0'+b}return (d+c+b).toUpperCase()},colorMap:{aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]}}},1,0,0,0,0,0,[Ext.ux.colorpick,'ColorUtils'],function(c){var a=c.formats,b={};a['#HEX6']=function(b){return '#'+a.HEX6(b)};a['#HEX8']=function(b){return '#'+a.HEX8(b)};Ext.Object.each(a,function(a,d){b[a.toLowerCase()]=function(b){var e=d(b);return e.toLowerCase()}});Ext.apply(a,b)});Ext.cmd.derive('Ext.ux.colorpick.ColorMapController',Ext.app.ViewController,{onFirstBoxReady:function(){var a=this,c=a.getView(),d=c.down('#dragHandle'),b=d.dd;b.constrain=!0;b.constrainTo=c.getEl();b.initialConstrainTo=b.constrainTo;b.on('drag',Ext.bind(a.onHandleDrag,a));a.mon(c.getEl(),{mousedown:a.onMouseDown,dragstart:a.onDragStart,scope:a})},onHandleDrag:function(k,l){var h=this,a=h.getView(),e=a.down('#dragHandle'),i=e.getX()-a.getX(),j=e.getY()-a.getY(),d=a.getEl(),g=d.getWidth(),f=d.getHeight(),b=i/g,c=j/f;if(b>0.99){b=1}if(c>0.99){c=1}a.fireEvent('handledrag',b,c)},onMouseDown:function(b){var c=this,d=c.getView(),a=d.down('#dragHandle');a.setY(b.getY());a.setX(b.getX());c.onHandleDrag();a.dd.onMouseDown(b,a.dd.el)},onDragStart:function(d){var c=this,b=c.getView(),a=b.down('#dragHandle');a.dd.onDragStart(d,a.dd.el)},onMapClick:function(h){var f=this,a=f.getView(),g=a.down('#dragHandle'),c=a.getXY(),d=h.getXY(),b,e;b=d[0]-c[0];e=d[1]-c[1];g.getEl().setStyle({left:b+'px',top:e+'px'});f.onHandleDrag()},onColorBindingChanged:function(n){var i=this,m=i.getViewModel(),a=m.get('selectedColor'),b,d=i.getView(),l=d.down('#dragHandle'),c=d.getEl(),k=c.getWidth(),j=c.getHeight(),e,f,g,h;b=Ext.ux.colorpick.ColorUtils.rgb2hsv(a.r,a.g,a.b);e=b.s;g=k*e;f=1-b.v;h=j*f;l.getEl().setStyle({left:g+'px',top:h+'px'})},onHueBindingChanged:function(d){var c=this,e=c.getViewModel(),a,b;a=Ext.ux.colorpick.ColorUtils.hsv2rgb(d,1,1);b=Ext.ux.colorpick.ColorUtils.rgb2hex(a.r,a.g,a.b);c.getView().getEl().applyStyles({'background-color':'#'+b})}},0,0,0,0,['controller.colorpickercolormapcontroller'],0,[Ext.ux.colorpick,'ColorMapController'],0);Ext.cmd.derive('Ext.ux.colorpick.ColorMap',Ext.container.Container,{controller:'colorpickercolormapcontroller',cls:'x-colorpicker-colormap',items:[{xtype:'component',cls:'x-colorpicker-colormap-draghandle-container',itemId:'dragHandle',width:1,height:1,draggable:!0,html:'<div class="x-colorpicker-colormap-draghandle"></div>'}],listeners:{boxready:{single:!0,fn:'onFirstBoxReady',scope:'controller'},colorbindingchanged:{fn:'onColorBindingChanged',scope:'controller'},huebindingchanged:{fn:'onHueBindingChanged',scope:'controller'}},afterRender:function(){var c=this,a=c.mapGradientUrl,b=c.el;Ext.container.Container.prototype.afterRender.call(this);if(!a){a=b.getStyle('background-image');a=a.substring(4,a.length-1);if(a.indexOf('"')===0){a=a.substring(1,a.length-1)}Ext.ux.colorpick.ColorMap.prototype.mapGradientUrl=a}b.setStyle('background-image','none');b=c.layout.getElementTarget();b.createChild({tag:'img',cls:'x-colorpicker-colormap-blender',src:a})},setPosition:function(c){var b=this,a=b.down('#dragHandle');if(!a.dd||!a.dd.constrain){return}if(typeof a.dd.dragEnded!=='undefined'&&!a.dd.dragEnded){return}b.fireEvent('colorbindingchanged',c)},setHue:function(b){var a=this;if(!a.getEl()){return}a.fireEvent('huebindingchanged',b)}},0,['colorpickercolormap'],['component','box','container','colorpickercolormap'],{'component':!0,'box':!0,'container':!0,'colorpickercolormap':!0},['widget.colorpickercolormap'],0,[Ext.ux.colorpick,'ColorMap'],0);Ext.cmd.derive('Ext.ux.colorpick.SelectorModel',Ext.app.ViewModel,{data:{selectedColor:{r:255,g:255,b:255,h:0,s:1,v:1,a:1},previousColor:{r:0,g:0,b:0,h:0,s:1,v:1,a:1}},formulas:{hex:{get:function(a){var e=a('selectedColor.r').toString(16),d=a('selectedColor.g').toString(16),c=a('selectedColor.b').toString(16),b;b=Ext.ux.colorpick.ColorUtils.rgb2hex(e,d,c);return '#'+b},set:function(a){var b=Ext.ux.colorpick.ColorUtils.hex2rgb(a);this.changeRGB(b)}},red:{get:function(a){return a('selectedColor.r')},set:function(a){this.changeRGB({r:a})}},green:{get:function(a){return a('selectedColor.g')},set:function(a){this.changeRGB({g:a})}},blue:{get:function(a){return a('selectedColor.b')},set:function(a){this.changeRGB({b:a})}},hue:{get:function(a){return a('selectedColor.h')*360},set:function(a){this.changeHSV({h:a/360})}},saturation:{get:function(a){return a('selectedColor.s')*100},set:function(a){this.changeHSV({s:a/100})}},value:{get:function(a){var b=a('selectedColor.v');return b*100},set:function(a){this.changeHSV({v:a/100})}},alpha:{get:function(a){var b=a('selectedColor.a');return b*100},set:function(a){this.set('selectedColor',Ext.applyIf({a:a/100},this.data.selectedColor))}}},changeHSV:function(a){Ext.applyIf(a,this.data.selectedColor);var b=Ext.ux.colorpick.ColorUtils.hsv2rgb(a.h,a.s,a.v);a.r=b.r;a.g=b.g;a.b=b.b;this.set('selectedColor',a)},changeRGB:function(a){Ext.applyIf(a,this.data.selectedColor);var b=Ext.ux.colorpick.ColorUtils.rgb2hsv(a.r,a.g,a.b);a.h=b.h;a.s=b.s;a.v=b.v;this.set('selectedColor',a)}},0,0,0,0,['viewmodel.colorpick-selectormodel'],0,[Ext.ux.colorpick,'SelectorModel'],0);Ext.cmd.derive('Ext.ux.colorpick.SelectorController',Ext.app.ViewController,{destroy:function(){var c=this,b=c.getView(),a=b.childViewModel;if(a){a.destroy();b.childViewModel=null}Ext.app.ViewController.prototype.destroy.call(this)},changeHSV:function(a){var b=this.getView(),d=b.getColor(),c;Ext.applyIf(a,d);c=Ext.ux.colorpick.ColorUtils.hsv2rgb(a.h,a.s,a.v);Ext.apply(a,c);b.setColor(a)},onColorMapHandleDrag:function(a,b){this.changeHSV({s:a,v:1-b})},onValueSliderHandleDrag:function(a){this.changeHSV({v:1-a})},onSaturationSliderHandleDrag:function(a){this.changeHSV({s:1-a})},onHueSliderHandleDrag:function(a){this.changeHSV({h:1-a})},onAlphaSliderHandleDrag:function(c){var a=this.getView(),d=a.getColor(),b=Ext.applyIf({a:1-c},d);a.setColor(b);a.el.repaint()},onPreviousColorSelected:function(c,a){var b=this.getView();b.setColor(a)},onOK:function(){var b=this,a=b.getView();a.fireEvent('ok',a,a.getValue())},onCancel:function(){this.fireViewEvent('cancel',this.getView())},onResize:function(){var c=this,h=c.getView(),b=h.childViewModel,a=c.getReferences(),e,f,g,d;if(!c.hasResizedOnce){c.hasResizedOnce=!0;return}e=b.get('hue');f=b.get('saturation');g=b.get('value');d=b.get('alpha');a.colorMap.setPosition(b.getData());a.hueSlider.setHue(e);a.satSlider.setSaturation(f);a.valueSlider.setValue(g);a.alphaSlider.setAlpha(d)}},0,0,0,0,['controller.colorpick-selectorcontroller'],0,[Ext.ux.colorpick,'SelectorController'],0);Ext.cmd.derive('Ext.ux.colorpick.ColorPreview',Ext.Component,{style:'position: relative',html:'<div class="x-colorpreview-filter" style="height:100%; width:100%; position: absolute;"></div><a class="btn" style="height:100%; width:100%; position: absolute;"></a>',cls:'x-colorpreview',height:256,onRender:function(){var a=this;Ext.Component.prototype.onRender.apply(this,arguments);a.mon(a.el.down('.btn'),'click',a.onClick,a)},onClick:function(){this.fireEvent('click',this,this.color)},setColor:function(b){var a=this,c=a.getEl();if(!c){return}a.color=b;a.applyBgStyle(b)},bgStyleTpl:Ext.create('Ext.XTemplate',Ext.isIE&&Ext.ieVersion<10?"filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr='#{hexAlpha}{hex}', endColorstr='#{hexAlpha}{hex}');":'background: {rgba};'),applyBgStyle:function(a){var i=this,b=Ext.ux.colorpick.ColorUtils,g='.x-colorpreview-filter',h=i.getEl().down(g),f,d,e,c;f=b.rgb2hex(a.r,a.g,a.b);d=Ext.util.Format.hex(Math.floor(a.a*255),2);e=b.getRGBAString(a);c=this.bgStyleTpl.apply({hex:f,hexAlpha:d,rgba:e});h.applyStyles(c)}},0,['colorpickercolorpreview'],['component','box','colorpickercolorpreview'],{'component':!0,'box':!0,'colorpickercolorpreview':!0},['widget.colorpickercolorpreview'],0,[Ext.ux.colorpick,'ColorPreview'],0);Ext.cmd.derive('Ext.ux.colorpick.SliderController',Ext.app.ViewController,{boxReady:function(e){var b=this,d=b.getDragContainer(),c=b.getDragHandle(),a=c.dd;a.constrain=!0;a.constrainTo=d.getEl();a.initialConstrainTo=a.constrainTo;a.on('drag',b.onHandleDrag,b)},getDragHandle:function(){return this.view.lookupReference('dragHandle')},getDragContainer:function(){return this.view.lookupReference('dragHandleContainer')},onHandleDrag:function(i){var b=this,g=b.getView(),c=b.getDragContainer(),f=b.getDragHandle(),h=f.getY()-c.getY(),e=c.getEl(),d=e.getHeight(),a=h/d;if(a>0.99){a=1}g.fireEvent('handledrag',a)},onMouseDown:function(c){var b=this,a=b.getDragHandle(),d=c.getY();a.setY(d);b.onHandleDrag();a.el.repaint();a.dd.onMouseDown(c,a.dd.el)},onDragStart:function(c){var b=this,a=b.getDragHandle();a.dd.onDragStart(c,a.dd.el)},onMouseUp:function(){var a=this.getDragHandle();a.dd.dragEnded=!0}},0,0,0,0,['controller.colorpick-slidercontroller'],0,[Ext.ux.colorpick,'SliderController'],0);Ext.cmd.derive('Ext.ux.colorpick.Slider',Ext.container.Container,{controller:'colorpick-slidercontroller',afterRender:function(){Ext.container.Container.prototype.afterRender.apply(this,arguments);var c=this.width,a=this.lookupReference('dragHandleContainer'),b=a.getWidth();a.el.setStyle('left',(c-b)/2+'px')},baseCls:'x-colorpicker-slider',referenceHolder:!0,listeners:{element:'el',mousedown:'onMouseDown',mouseup:'onMouseUp',dragstart:'onDragStart'},items:{xtype:'container',cls:'x-colorpicker-draghandle-container',reference:'dragHandleContainer',height:'100%',items:{xtype:'component',cls:'x-colorpicker-draghandle-outer',reference:'dragHandle',width:'100%',height:1,draggable:!0,html:'<div class="x-colorpicker-draghandle"></div>'}},getDragHandle:function(){return this.lookupReference('dragHandle')},getDragContainer:function(){return this.lookupReference('dragHandleContainer')}},0,['colorpickerslider'],['component','box','container','colorpickerslider'],{'component':!0,'box':!0,'container':!0,'colorpickerslider':!0},['widget.colorpickerslider'],0,[Ext.ux.colorpick,'Slider'],0);Ext.cmd.derive('Ext.ux.colorpick.SliderAlpha',Ext.ux.colorpick.Slider,{cls:'x-colorpicker-alpha',gradientStyleTpl:Ext.create('Ext.XTemplate',Ext.isIE&&Ext.ieVersion<10?"filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr='#FF{hex}', endColorstr='#00{hex}');":'background: -moz-linear-gradient(top, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);background: -webkit-linear-gradient(top,rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);background: -o-linear-gradient(top, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);background: -ms-linear-gradient(top, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);background: linear-gradient(to bottom, rgba({r}, {g}, {b}, 1) 0%, rgba({r}, {g}, {b}, 0) 100%);'),setAlpha:function(h){var d=this,g=d.getDragContainer(),a=d.getDragHandle(),f=g.getEl(),e=f.getHeight(),c,b;if(!a.dd||!a.dd.constrain){return}if(typeof a.dd.dragEnded!=='undefined'&&!a.dd.dragEnded){return}b=e*(1-h/100);c=a.getEl();c.setStyle({top:b+'px'})},setColor:function(a){var b=this,e=b.getDragContainer(),c,d;if(!b.getEl()){return}c=Ext.ux.colorpick.ColorUtils.rgb2hex(a.r,a.g,a.b);d=e.getEl().first();d.applyStyles(b.gradientStyleTpl.apply({hex:c,r:a.r,g:a.g,b:a.b}))}},0,['colorpickerslideralpha'],['component','box','container','colorpickerslider','colorpickerslideralpha'],{'component':!0,'box':!0,'container':!0,'colorpickerslider':!0,'colorpickerslideralpha':!0},['widget.colorpickerslideralpha'],0,[Ext.ux.colorpick,'SliderAlpha'],0);Ext.cmd.derive('Ext.ux.colorpick.SliderSaturation',Ext.ux.colorpick.Slider,{cls:'x-colorpicker-saturation',gradientStyleTpl:Ext.create('Ext.XTemplate',Ext.isIE&&Ext.ieVersion<10?"filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr='#{hex}', endColorstr='#ffffff');":'background: -mox-linear-gradient(top, #{hex} 0%, #ffffff 100%);background: -webkit-linear-gradient(top, #{hex} 0%,#ffffff 100%);background: -o-linear-gradient(top, #{hex} 0%,#ffffff 100%);background: -ms-linear-gradient(top, #{hex} 0%,#ffffff 100%);background: linear-gradient(to bottom, #{hex} 0%,#ffffff 100%);'),setSaturation:function(g){var d=this,h=d.getDragContainer(),a=d.getDragHandle(),f=h.getEl(),e=f.getHeight(),b,c;if(!a.dd||!a.dd.constrain){return}if(typeof a.dd.dragEnded!=='undefined'&&!a.dd.dragEnded){return}b=1-g/100;c=e*b;a.getEl().setStyle({top:c+'px'})},setHue:function(e){var b=this,d=b.getDragContainer(),a,c;if(!b.getEl()){return}a=Ext.ux.colorpick.ColorUtils.hsv2rgb(e,1,1);c=Ext.ux.colorpick.ColorUtils.rgb2hex(a.r,a.g,a.b);d.getEl().applyStyles(b.gradientStyleTpl.apply({hex:c}))}},0,['colorpickerslidersaturation'],['component','box','container','colorpickerslider','colorpickerslidersaturation'],{'component':!0,'box':!0,'container':!0,'colorpickerslider':!0,'colorpickerslidersaturation':!0},['widget.colorpickerslidersaturation'],0,[Ext.ux.colorpick,'SliderSaturation'],0);Ext.cmd.derive('Ext.ux.colorpick.SliderValue',Ext.ux.colorpick.Slider,{cls:'x-colorpicker-value',gradientStyleTpl:Ext.create('Ext.XTemplate',Ext.isIE&&Ext.ieVersion<10?"filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0, startColorstr='#{hex}', endColorstr='#000000');":'background: -mox-linear-gradient(top, #{hex} 0%, #000000 100%);background: -webkit-linear-gradient(top, #{hex} 0%,#000000 100%);background: -o-linear-gradient(top, #{hex} 0%,#000000 100%);background: -ms-linear-gradient(top, #{hex} 0%,#000000 100%);background: linear-gradient(to bottom, #{hex} 0%,#000000 100%);'),setValue:function(h){var d=this,g=d.getDragContainer(),a=d.getDragHandle(),f=g.getEl(),e=f.getHeight(),b,c;if(!a.dd||!a.dd.constrain){return}if(typeof a.dd.dragEnded!=='undefined'&&!a.dd.dragEnded){return}b=1-h/100;c=e*b;a.getEl().setStyle({top:c+'px'})},setHue:function(e){var b=this,d=b.getDragContainer(),a,c;if(!b.getEl()){return}a=Ext.ux.colorpick.ColorUtils.hsv2rgb(e,1,1);c=Ext.ux.colorpick.ColorUtils.rgb2hex(a.r,a.g,a.b);d.getEl().applyStyles(b.gradientStyleTpl.apply({hex:c}))}},0,['colorpickerslidervalue'],['component','box','container','colorpickerslider','colorpickerslidervalue'],{'component':!0,'box':!0,'container':!0,'colorpickerslider':!0,'colorpickerslidervalue':!0},['widget.colorpickerslidervalue'],0,[Ext.ux.colorpick,'SliderValue'],0);Ext.cmd.derive('Ext.ux.colorpick.SliderHue',Ext.ux.colorpick.Slider,{cls:'x-colorpicker-hue',afterRender:function(){var c=this,a=c.gradientUrl,b=c.el;Ext.ux.colorpick.Slider.prototype.afterRender.call(this);if(!a){a=b.getStyle('background-image');a=a.substring(4,a.length-1);if(a.indexOf('"')===0){a=a.substring(1,a.length-1)}Ext.ux.colorpick.SliderHue.prototype.gradientUrl=a}b.setStyle('background-image','none');b=c.getDragContainer().layout.getElementTarget();b.createChild({tag:'img',cls:'x-colorpicker-hue-gradient',src:a})},setHue:function(h){var d=this,g=d.getDragContainer(),a=d.getDragHandle(),f=g.getEl(),e=f.getHeight(),c,b;if(!a.dd||!a.dd.constrain){return}if(typeof a.dd.dragEnded!=='undefined'&&!a.dd.dragEnded){return}b=e*(1-h);c=a.getEl();c.setStyle({top:b+'px'})}},0,['colorpickersliderhue'],['component','box','container','colorpickerslider','colorpickersliderhue'],{'component':!0,'box':!0,'container':!0,'colorpickerslider':!0,'colorpickersliderhue':!0},['widget.colorpickersliderhue'],0,[Ext.ux.colorpick,'SliderHue'],0);Ext.cmd.derive('Ext.ux.colorpick.Selector',Ext.container.Container,{controller:'colorpick-selectorcontroller',width:580,height:337,cls:'x-colorpicker',padding:10,layout:{type:'hbox',align:'stretch'},defaultBindProperty:'value',twoWayBindable:['value'],fieldWidth:50,fieldPad:5,showPreviousColor:!1,showOkCancelButtons:!1,listeners:{resize:'onResize'},constructor:function(c){var a=this,b=Ext.Factory.viewModel('colorpick-selectormodel');a.childViewModel=b;a.items=[a.getMapAndHexRGBFields(b),a.getSliderAndHField(b),a.getSliderAndSField(b),a.getSliderAndVField(b),a.getSliderAndAField(b),a.getPreviewAndButtons(b,c)];a.childViewModel.bind('{selectedColor}',function(b){a.setColor(b)});Ext.container.Container.prototype.constructor.apply(this,arguments)},updateColor:function(b){var a=this;a.mixins.colorselection.updateColor.call(a,b);a.childViewModel.set('selectedColor',b)},updatePreviousColor:function(a){this.childViewModel.set('previousColor',a)},getMapAndHexRGBFields:function(d){var c=this,a={top:0,right:c.fieldPad,bottom:0,left:0},b=c.fieldWidth;return {xtype:'container',viewModel:d,cls:'x-colorpicker-escape-overflow',flex:1,layout:{type:'vbox',align:'stretch'},margin:'0 10 0 0',items:[{xtype:'colorpickercolormap',reference:'colorMap',flex:1,bind:{position:{bindTo:'{selectedColor}',deep:!0},hue:'{selectedColor.h}'},listeners:{handledrag:'onColorMapHandleDrag'}},{xtype:'container',layout:'hbox',defaults:{labelAlign:'top',labelSeparator:'',allowBlank:!1,onChange:function(){if(this.isValid()){Ext.form.field.Base.prototype.onChange.apply(this,arguments)}}},items:[{xtype:'textfield',fieldLabel:'HEX',flex:1,bind:'{hex}',margin:a,readOnly:!0},{xtype:'numberfield',fieldLabel:'R',bind:'{red}',width:b,hideTrigger:!0,maxValue:255,minValue:0,margin:a},{xtype:'numberfield',fieldLabel:'G',bind:'{green}',width:b,hideTrigger:!0,maxValue:255,minValue:0,margin:a},{xtype:'numberfield',fieldLabel:'B',bind:'{blue}',width:b,hideTrigger:!0,maxValue:255,minValue:0,margin:0}]}]}},getSliderAndHField:function(b){var c=this,a=c.fieldWidth;return {xtype:'container',viewModel:b,cls:'x-colorpicker-escape-overflow',width:a,layout:{type:'vbox',align:'stretch'},items:[{xtype:'colorpickersliderhue',reference:'hueSlider',flex:1,bind:{hue:'{selectedColor.h}'},width:a,listeners:{handledrag:'onHueSliderHandleDrag'}},{xtype:'numberfield',fieldLabel:'H',labelAlign:'top',labelSeparator:'',bind:'{hue}',hideTrigger:!0,maxValue:360,minValue:0,allowBlank:!1,margin:0}]}},getSliderAndSField:function(c){var a=this,b=a.fieldWidth;return {xtype:'container',viewModel:c,cls:'x-colorpicker-escape-overflow',width:b,layout:{type:'vbox',align:'stretch'},margin:{right:a.fieldPad,left:a.fieldPad},items:[{xtype:'colorpickerslidersaturation',reference:'satSlider',flex:1,bind:{saturation:'{saturation}',hue:'{selectedColor.h}'},width:b,listeners:{handledrag:'onSaturationSliderHandleDrag'}},{xtype:'numberfield',fieldLabel:'S',labelAlign:'top',labelSeparator:'',bind:'{saturation}',hideTrigger:!0,maxValue:100,minValue:0,allowBlank:!1,margin:0}]}},getSliderAndVField:function(b){var c=this,a=c.fieldWidth;return {xtype:'container',viewModel:b,cls:'x-colorpicker-escape-overflow',width:a,layout:{type:'vbox',align:'stretch'},items:[{xtype:'colorpickerslidervalue',reference:'valueSlider',flex:1,bind:{value:'{value}',hue:'{selectedColor.h}'},width:a,listeners:{handledrag:'onValueSliderHandleDrag'}},{xtype:'numberfield',fieldLabel:'V',labelAlign:'top',labelSeparator:'',bind:'{value}',hideTrigger:!0,maxValue:100,minValue:0,allowBlank:!1,margin:0}]}},getSliderAndAField:function(c){var b=this,a=b.fieldWidth;return {xtype:'container',viewModel:c,cls:'x-colorpicker-escape-overflow',width:a,layout:{type:'vbox',align:'stretch'},margin:{left:b.fieldPad},items:[{xtype:'colorpickerslideralpha',reference:'alphaSlider',flex:1,bind:{alpha:'{alpha}',color:{bindTo:'{selectedColor}',deep:!0}},width:a,listeners:{handledrag:'onAlphaSliderHandleDrag'}},{xtype:'numberfield',fieldLabel:'A',labelAlign:'top',labelSeparator:'',bind:'{alpha}',hideTrigger:!0,maxValue:100,minValue:0,allowBlank:!1,margin:0}]}},getPreviewAndButtons:function(c,b){var a=[{xtype:'colorpickercolorpreview',flex:1,bind:{color:{bindTo:'{selectedColor}',deep:!0}}}];if(b.showPreviousColor){a.push({xtype:'colorpickercolorpreview',flex:1,bind:{color:{bindTo:'{previousColor}',deep:!0}},listeners:{click:'onPreviousColorSelected'}})}if(b.showOkCancelButtons){a.push({xtype:'button',text:'OK',margin:'10 0 0 0',handler:'onOK'},{xtype:'button',text:'Cancel',margin:'10 0 0 0',handler:'onCancel'})}return {xtype:'container',viewModel:c,width:70,margin:'0 0 0 10',items:a,layout:{type:'vbox',align:'stretch'}}}},1,['colorselector'],['component','box','container','colorselector'],{'component':!0,'box':!0,'container':!0,'colorselector':!0},['widget.colorselector'],[[Ext.ux.colorpick.Selection.prototype.mixinId||Ext.ux.colorpick.Selection.$className,Ext.ux.colorpick.Selection]],[Ext.ux.colorpick,'Selector'],0);Ext.cmd.derive('Ext.ux.colorpick.ButtonController',Ext.app.ViewController,{afterRender:function(a){a.updateColor(a.getColor())},destroy:function(){var a=this.getView(),b=a.colorPickerWindow;if(b){b.destroy();a.colorPickerWindow=a.colorPicker=null}Ext.app.ViewController.prototype.destroy.call(this)},getPopup:function(){var b=this.getView(),a=b.colorPickerWindow,c;if(!a){a=Ext.create(b.getPopup());b.colorPickerWindow=a;a.colorPicker=b.colorPicker=c=a.lookupReference('selector');c.setFormat(b.getFormat());c.on({ok:'onColorPickerOK',cancel:'onColorPickerCancel',scope:this});a.on({close:'onColorPickerCancel',scope:this})}return a},onClick:function(){var e=this,d=e.getView(),b=d.getColor(),c=e.getPopup(),a=c.colorPicker;a.setColor(b);a.setPreviousColor(b);c.showBy(d,'tl-br?')},onColorPickerOK:function(b){var a=this.getView(),c=b.getColor(),d=a.colorPickerWindow;d.hide();a.setColor(c)},onColorPickerCancel:function(){var b=this.getView(),a=b.colorPickerWindow;a.hide()},syncColor:function(a){var b=this.getView();Ext.ux.colorpick.ColorUtils.setBackground(b.filterEl,a)}},0,0,0,0,['controller.colorpick-buttoncontroller'],0,[Ext.ux.colorpick,'ButtonController'],0);Ext.cmd.derive('Ext.ux.colorpick.Button',Ext.Component,{controller:'colorpick-buttoncontroller',baseCls:'x-colorpicker-button',width:20,height:20,childEls:['btnEl','filterEl'],config:{popup:{lazy:!0,$value:{xtype:'window',closeAction:'hide',referenceHolder:!0,minWidth:540,minHeight:200,layout:'fit',header:!1,resizable:!0,items:{xtype:'colorselector',reference:'selector',showPreviousColor:!0,showOkCancelButtons:!0}}}},defaultBindProperty:'value',twoWayBindable:'value',renderTpl:'<div id="{id}-filterEl" data-ref="filterEl" style="height:100%; width:100%; position: absolute;"></div><a id="{id}-btnEl" data-ref="btnEl" style="height:100%; width:100%; position: absolute;"></a>',listeners:{click:'onClick',element:'btnEl'},updateColor:function(b){var a=this,c=a.colorPicker;a.mixins.colorselection.updateColor.call(a,b);Ext.ux.colorpick.ColorUtils.setBackground(a.filterEl,b);if(c){c.setColor(b)}},updateFormat:function(b){var a=this.colorPicker;if(a){a.setFormat(b)}}},0,['colorbutton'],['component','box','colorbutton'],{'component':!0,'box':!0,'colorbutton':!0},['widget.colorbutton'],[[Ext.ux.colorpick.Selection.prototype.mixinId||Ext.ux.colorpick.Selection.$className,Ext.ux.colorpick.Selection]],[Ext.ux.colorpick,'Button'],0);Ext.cmd.derive('SiteWalk360.FloorplanPanoUtil',Ext.Base,{config:{panoScanLayer:null,directionArrow:null},getMarkerElement:function(a){if(a&&a._container){return a._container}else {if(a&&a._bgLayer&&a._bgLayer._container){return a._bgLayer._container}else {if(a&&a._icon){return a._icon}}}return null},addMarkerClass:function(b,c){var a=this.getMarkerElement(b);if(a&&a.classList){a.classList.add(c)}},removeMarkerClass:function(b,c){var a=this.getMarkerElement(b);if(a&&a.classList){a.classList.remove(c)}},createPanoLayer:function(){if(this.getPanoScanLayer()==null){var a=MVLeaflet||L;this.setPanoScanLayer(new a.layerGroup());this.map.addLayer(this.getPanoScanLayer());this.mapZoomHandler=this.mapZoomEndHandler.bind(this);this.map.on('zoomend',this.mapZoomHandler)}else {this.removeDirectionMarker();this.getPanoScanLayer().clearLayers()}return this.getPanoScanLayer()},removePanoLayer:function(){this.removeDirectionMarker();if(this.getPanoScanLayer()){this.getPanoScanLayer().eachLayer(function(a){a.clearAllEventListeners()});this.getPanoScanLayer().clearLayers();if(this.map){this.map.removeLayer(this.getPanoScanLayer());this.map.off('zoomend',this.mapZoomHandler);mapZoomHandler=null}this.setPanoScanLayer(null)}},mapZoomEndHandler:function(g){var f=g.target.getZoom();var d=this.getPanoMarkerRadius();var b=this.getPanoMarkersMap();for(var e in b){var c=b[e];c.setRadius(d)}var a=this.getDirectionArrow();if(a&&a.classList){if(f==0){a.classList.add('small')}else {a.classList.remove('small')}}this.updateDirectionMarkerOnFloorplan()},getPanoMarkerRadius:function(b){var a=Math.min(15,6+this.map.getZoom()*3);if(b===!0){a=Math.round(a*1.2)}return a},removeDirectionMarker:function(){var a=this.getDirectionMarker();if(a&&this.getPanoScanLayer()){this.getPanoScanLayer().removeLayer(a)}this.setDirectionMarker(null);this.setDirectionArrow(null)},updateDirectionMarkerOnFloorplan:function(){if(!this.getViewerReady()){return}var h=this.getCurrentRotation();if(!h){return}try{var a=this.getDirectionMarker();var b=this.getActivePano();if(!b||!this.getPanoScanLayer()||b.hidden){this.removeDirectionMarker();return}if(!a){a=this.addCustomIconMarker(this.getPanoScanLayer(),b.x,b.y,{className:'matterportDirectionMarker',div:!0,html:'<div class="matterportDirectionArrow'+(this.map.getZoom()==0?' small':'')+'"></div>'});this.setDirectionMarker(a);this.setDirectionArrow(a._icon.firstChild)}else {var e=a.getLatLng();e.lat=b.y;e.lng=b.x;a.setLatLng(e)}var c=0-Math.round(h.y)-this.getFloorplanTheta();while(c<0){c+=360}var d=this.getDirectionArrow();if(d){var g='rotate('+c+'deg)';if(g!=d.style.transform){d.style.transform=g;var f=15;var i=Math.round(f*Math.sin(this.toRadians(c)));var j=Math.round(-f*Math.cos(this.toRadians(c))+f);d.style.marginLeft=i+'px';d.style.marginTop=j+'px'}}}catch(k){this.error('Error placing direction marker on floorplan');this.error(k.message)}},addPanoScanMarker:function(d,e,f,a){a=Ext.applyIf(a||{},{radius:12,weight:4,fixedWeight:!0,opacity:1,fillOpacity:1,fill:!0,clickable:!0});var c=MVLeaflet||L;var b=c.panoScanMarker({lng:e,lat:f},a);d.addLayer(b);return b},addPanoHotspotMarker:function(d,e,f,a){a=Ext.applyIf(a||{},{radius:12,color:'#E65E25'});var c=MVLeaflet||L;var b=c.panoMarker({lng:e,lat:f},a);d.addLayer(b);return b},addCustomIconMarker:function(d,f,g,a){a=a||{div:!1};var b=MVLeaflet||L;var e=a.div?b.divIcon(a):b.icon(a);var c=b.marker({lng:f,lat:g},{clickable:!1,icon:e});d.addLayer(c);return c},panToMarker:function(b,c,a){if(this.map){this.map.panTo({lng:b,lat:c},{animate:!!a})}}},0,0,0,0,0,0,[SiteWalk360,'FloorplanPanoUtil'],0);Ext.cmd.derive('siteWalk360.SW360Util',Ext.Base,{config:{isDebug:window.location.href.indexOf('debug=true')!=-1},fixedFloat:function(b,a){return parseFloat(b.toFixed(a))},toDegrees:function(a){return 180*a/Math.PI},toRadians:function(a){return Math.PI*a/180},constrainAngle:function(b){var a=b%360;while(a<0){a+=360}return a},min:function(a,b){return isNaN(a)?b:Math.min(a,b)},max:function(a,b){return isNaN(a)?b:Math.max(a,b)},normalize:function(c,a,b){return (c-a)/(b-a)},quaternionToEulerAngles:function(a,c,d,b){if(typeof a=='object'){c=a.y;d=a.z;b=a.w;a=a.x}var f,e,g;var h=a*c+d*b;if(h>0.499){f=2*Math.atan2(a,b);e=Math.PI/2;g=0}else {if(h<-0.499){f=-2*Math.atan2(a,b);e=-Math.PI/2;g=0}else {var j=a*a;var k=c*c;var i=d*d;f=Math.atan2(2*c*b-2*a*d,1-2*k-2*i);e=Math.asin(2*h);g=Math.atan2(2*a*b-2*c*d,1-2*j-2*i)}}return {x:this.toDegrees(g),y:this.toDegrees(f),z:this.toDegrees(e)}},eulerAnglesToQuaternion:function(a,c,d,b){if(typeof a=='object'){if(b===undefined&&c!=null){b=c}if(a.hasOwnProperty('bank')){c=a.heading;d=a.attitude;a=a.bank}else {if(a.hasOwnProperty('x')){c=a.y;d=a.z;a=a.x}else {console.error("Invalid input object - must have 'heading|attitude|bank' or 'x|y|z' properties");return null}}}c=this.toRadians(c);d=this.toRadians(d);a=this.toRadians(a);var i=Math.cos(c*0.5);var j=Math.cos(d*0.5);var k=Math.cos(a*0.5);var l=Math.sin(c*0.5);var m=Math.sin(d*0.5);var n=Math.sin(a*0.5);var e=i*j*k-l*m*n;var f=l*m*k+i*j*n;var g=l*j*k+i*m*n;var h=i*m*k-l*j*n;if(b!=null&&!isNaN(b)&&b>=0){f=this.fixedFloat(f,b);g=this.fixedFloat(g,b);h=this.fixedFloat(h,b);e=this.fixedFloat(e,b)}if(isNaN(f)||isNaN(g)||isNaN(h)||isNaN(e)){console.error('Unable to calculate quaternion x,y,z,w values',arguments,a,c,d,f,g,h,e);return null}return {x:f,y:g,z:h,w:e}},distanceBetween:function(c,e,d,f){var a=d-c;var b=f-e;return Math.sqrt(a*a+b*b)},panoDistance:function(a,b){return this.distanceBetween(a.x,a.y,b.x,b.y)},findNearestPano:function(f,c){var e=0;var b=-1;for(var a=0;a<c.length;a++){var d=this.panoDistance(f,c[a]);if(a===0||d<e){e=d;b=a}if(d===0){break}}return b>=0?c[b]:null},findDistanceToNearestPano:function(e,d){var b=NaN;for(var a=0;a<d.length;a++){var c=this.panoDistance(e,d[a]);if(a===0||c<b){b=c}if(c===0){break}}return b},debug:function(){if(this.getIsDebug()){if(arguments.length&&typeof arguments[0]=='string'){arguments[0]='[SiteWalk360] '+arguments[0]}else {Array.prototype.unshift.call(arguments,'[SiteWalk360]')}console.log.apply(null,arguments)}},error:function(){if(arguments.length&&typeof arguments[0]=='string'){arguments[0]='[SiteWalk360] '+arguments[0]}else {Array.prototype.unshift.call(arguments,'[SiteWalk360]')}console.error.apply(null,arguments)}},0,0,0,0,0,0,[siteWalk360,'SW360Util'],0);Ext.cmd.derive('siteWalk360.MatterportShowcaseSDK',Ext.Base,{config:{showcase:null,applicationKey:window.location.hostname.indexOf('multivista.com')!=-1?'579a5d5b-72a1-4c71-a7c1-b38e1219ffac':'c4a11c55-dfc3-4b41-9df3-f2a466927a89'},constructor:function(a){this.initConfig(a);this.mixins.observable.constructor.call(this,a)},clear:function(){if(this.getShowcase()){this.setShowcase(null);this.fireEvent('showcaseconnected',!1)}},hasShowcase:function(){return this.getShowcase()!=null},addInteriorPanoIframeLoadListener:function(a){this.iframe=a;if(typeof a.addEventListener=='function'){var c=this;var b=function(){c.debug('InteriorPano <iframe> load event');a.removeEventListener('load',b);a.focus();setTimeout(function(){c.addShowcaseEventListeners()},500)};a.addEventListener('load',b)}else {a.focus()}},connectToShowcase:function(b,d,c){b=b||0;d=d||1000;c=c===undefined?10:c;var a=this;var e=this.getShowcase();if(e!=null){return new Promise(function(a,f){a(e)})}this.debug('Connecting to Showcase SDK (timeout='+d+'ms)'+(b>0?' (retry #'+b+')...':'...'));if(b>=c){return new Promise(function(g,f){var e='Tried to connect to Showcase SDK '+c+' times, aborting';a.error(e);f(e)})}return this.connectToShowcaseWithTimeout(d).then(function(e){if(typeof e==='string'){a.error('Error connecting to showcase: '+e);return null}a.setShowcase(e);a.fireEvent('showcaseconnected',!0);window.showcase=e;window.mpsdk=a;a.debug('Showcase connected');return e},function(e){a.debug('Retrying...',e,arguments);return a.connectToShowcase(b+1,d,c)})},connectToShowcaseWithTimeout:function(c){var e=this.getApplicationKey();var d=this.iframe;if(!this.iframe){console.warn('No iframe set');return new Promise(function(b,a){a('No iframe set')})}var a=window.SHOWCASE_SDK.connect(d,e,'3.0');var b=new Promise(function(b,a){setTimeout(a,c)});return Promise.race([a,b])},addShowcaseEventListeners:function(){this.removeShowcaseEventListeners();var a=this;this.connectToShowcase().then(function(b){if(b){a.showcaseEventEnterPanoRef=a.showcaseEventEnterPano.bind(a);b.on(b.Sweep.Event.ENTER,a.showcaseEventEnterPanoRef);a.showcaseEventMoveRef=a.showcaseEventMove.bind(a);b.on(b.Camera.Event.MOVE,a.showcaseEventMoveRef);b.Model.getData().then(function(c){if(c&&c.sweeps&&c.sweeps.length){a.showcaseEventModelLoaded({panos:c.sweeps})}else {console.warn('No panos found in data',c)}});a.debug('Added showcase event listeners')}return b})},removeShowcaseEventListeners:function(){var a=this.getShowcase();if(a){if(this.showcaseEventEnterPanoRef){a.off(a.Sweep.Event.ENTER,this.showcaseEventEnterPanoRef);delete this.showcaseEventEnterPanoRef}if(this.showcaseEventMoveRef){a.off(a.Camera.Event.MOVE,this.showcaseEventMoveRef);delete this.showcaseEventMoveRef}if(this.showcaseEventModelLoadedRef){delete this.showcaseEventModelLoadedRef}this.debug('Removed showcase event listeners')}},showcaseEventEnterPano:function(b,a){this.debug('PANO '+b+' -> '+a);this.fireEvent('panoselect',a)},showcaseEventMove:function(a){var b=a.sweep;this.fireEvent('rotationchange',a.rotation,b)},showcaseEventModelLoaded:function(b){this.debug('Matterport model metadata loaded');var a=[];b.panos.forEach(function(d,e){if(d.position){var c=d.position;var f={uuid:d.uuid,xo:c.x,yo:c.z,zo:c.y,sx:c.x,sy:c.y,sz:c.z,num:e+1};a.push(f)}}.bind(this));this.fireEvent('initialpanosload',a)},moveToPano:function(b,d,c){var a=this;this.connectToShowcase().then(function(e){if(e){var f={};if(d!=null){f.rotation=d}if(c!=null){f.transition=c}e.off(e.App.Event.PHASE_CHANGE,function(){a.moveToPano(b,d,c)});e.App.getState().then(function(h){if(h.phase!=e.App.Phase.PLAYING){a.debug('Cannot move to pano. Retrying on phase change.',h);e.on(e.App.Event.PHASE_CHANGE,function(){a.moveToPano(b,d,c)});return}else {var g=!1;if(a.showcaseEventMoveRef){e.off(e.Camera.Event.MOVE,a.showcaseEventMoveRef);g=!0}return e.Sweep.moveTo(b,f).then(function(i){a.debug('Success moving to pano',i,f);if(g&&a.showcaseEventMoveRef){e.on(e.Camera.Event.MOVE,a.showcaseEventMoveRef)}return i},function(i){a.error('Error moving to pano',b,i,f);if(g&&a.showcaseEventMoveRef){e.on(e.Camera.Event.MOVE,a.showcaseEventMoveRef)}return i})}})['catch'](function(g){a.error('Error moving to pano',b,g,f)})}return e})},getInstantTransition:function(){return 'transition.instant'},takeScreenShot:function(a,b){if(a==null&&window.resolutionOptions){a=window.resolutionOptions}if(b==null&&window.visibilityOptions){b=window.visibilityOptions}this.debug('takeSnapshot',a,b);var c=this;return this.connectToShowcase().then(function(d){if(d){return d.Renderer.takeScreenShot(a,b).then(function(e){c.debug('Success taking snapshot',e?e.length:-1);return e},function(e){c.debug('Error taking snapshot',arguments);return e})}return d})},getPose:function(){var a=this;return this.connectToShowcase().then(function(b){return b.Camera.getPose().then(function(c){a.debug('Pose',c);return c},function(c){a.debug('Error getting pose',arguments);return c})})}},1,0,0,0,0,[[Ext.mixin.Observable.prototype.mixinId||Ext.mixin.Observable.$className,Ext.mixin.Observable],[siteWalk360.SW360Util.prototype.mixinId||siteWalk360.SW360Util.$className,siteWalk360.SW360Util]],[siteWalk360,'MatterportShowcaseSDK'],0);Ext.cmd.derive('siteWalk360.TruViewSDK',Ext.Base,{config:{siteMap:null,scanViewer:null,tvcUrl:'https://multivista.truview-cloud.com',currentSiteId:null,currentScanId:null,currentRotation:null},SETUP_REGEX:/_Setup(\d+)$/i,constructor:function(a){this.initConfig(a);this.mixins.observable.constructor.call(this,a)},clear:function(){this.disposeScanViewer();this.disposeSiteMap();this.setCurrentSiteId(null);this.setCurrentScanId(null);this.setCurrentRotation(null)},hasSiteMap:function(){return this.getSiteMap()!=null},hasScanViewer:function(){return this.getScanViewer()!=null},disposeSiteMap:function(){var a=this.getSiteMap();if(a){this.setSiteMap(null);this.setupSiteMapEventListeners(a,!1)}},showSiteMap:function(b,a){this.setCurrentSiteId(a);window.tvsdk=this;this.disposeSiteMap();tvgmap({id:'tvgsitemap',server:this.getTvcUrl(),siteid:a,containerid:b},function(d,c){if(d){console.error('Error loading site map: ',d.message,d);if(d.message.indexOf('Remote GET request failed')){Ext.Msg.error('Unable to load TruView Site Map - it is probably private.<br>Try making the site public and try again.<br><br>Find the site in <a href="'+this.getTvcUrl()+'/locations" target="TruViewWindow">this list</a>, select the row, and click on the share icon (<i class="fa fa-share-alt"></i>).')}}else {console.log('Site map loaded: '+c.name,c);this.setSiteMap(c);this.setupSiteMapEventListeners(c,!0);window.tvsm=c}c.oldScans=c.scans;c.scans=function(){var e=this.getActiveIndex();return e<0?[]:this.getMap(e).scans}.bind(c._map._sitemap);this.fireEvent('sitemapready',c,d);this.loadSiteScans(a,function(e,i){var f=[];if(e){if(e.length===0){e=c.scans();console.log('Using sitemap scans',e);for(var h=0;h<e.length;h++){var g=e[h];g.position={x:g.coords.x,y:-g.coords.y,z:0}}}e.forEach(function(h,l){var g=h.position;var j=l+1;var k=this.SETUP_REGEX.exec(h.name);if(k&&k[1]){j=parseInt(k[1]);if(isNaN(j)){j=l+1}}var m={uuid:h.id,num:j,name:h.name,xo:g.x,yo:-g.y,zo:g.z,sx:g.x,sy:-g.y,sz:g.z};f.push(m)}.bind(this))}else {Ext.Msg.error('Failed to load site scans:<br>'+i);console.error('Failed to load site scans: ',i)}this.debug('TruView panos',f);this.fireEvent('initialpanosload',f)}.bind(this))}.bind(this))},setupSiteMapEventListeners:function(a,b){if(b){this.smClickHandler=this.siteMapClickHandler.bind(this);a.addListener('click',this.smClickHandler)}else {a.removeListener('click',this.smClickHandler);delete this.smClickHandler}},siteMapClickHandler:function(a){if(a&&a.id){this.fireEvent('sitemappanoselect',a.id)}},siteMapSelectScan:function(c,b){var a=this.getSiteMap();if(a&&b){}},disposeScanViewer:function(){var a=this.getScanViewer();if(a){this.setupViewerEventListeners(a,!1);a.dispose()}this.setScanViewer(null)},showScanViewer:function(b,a,c,d){this.imperial=d;if(b){this.lastElementId=b}else {b=this.lastElementId}if(!b){this.error('Must specify an html element');return}if(!a){this.error('Invalid scan id');return}if(a==this.getCurrentScanId()){console.log('Scan '+a+' already loaded');if(c&&c!=this.getCurrentRotation()){this.setInitialCameraAngle(this.getScanViewer(),c)}return}this.disposeScanViewer();this.setCurrentScanId(a);this.fireEvent('panoselect',a);this.toggleViewerLoading(!0);tvgviewer({id:a,server:this.getTvcUrl(),scanid:a,containerid:b,locale:mvstr.LanguageID.split('_')[0]||'en',sidebar:!0,minimap:!1,neighbors:!0,disablemodeselect:!0,hidetools:{layers:!1,snapshots:!0,measure:!1,neighbors:!0,geotags:!0,minimap:!0}},function(f,e){if(f){console.error('** tvgviewer error:',f);Ext.Msg.error('Failed to connect to TruView')}this.setScanViewer(e);window.tvg=e;if(e&&!f){e.setProps({units:d?'in':'mm',neighbors:{max:5,showLabels:!1,showPosition:!0}});e.setMarkerScaleFactor(0.25);e.setMarkerColor(233,92,19,1);e.enableCameraMouse(2);this.setInitialCameraAngle(e,c);this.setupViewerEventListeners(e,!0)}this.fireEvent('scanviewerready',e,f);this.toggleViewerLoading(!1)}.bind(this))},toggleViewerLoading:function(a){var b=Ext.ComponentQuery.query('photoviewer')[0];if(!b){return}var c=b.lookupViewModel();a=!!a;b.setLoading(a);c.set('forceHideInteriorPano',a)},setInitialCameraAngle:function(d,c){var b=0;if(!c){c=this.getCurrentRotation()}if(c){b=this.toRadians(c.y)}try{var a=d.getCamera();if(b!=null&&b!==0){this.debug('TVG set initial camera '+b+' ('+this.toDegrees(b)+' ), was '+a.longitude+' ('+this.toDegrees(a.longitude)+' )');d.setCamera(a.altitude,b,a.aperture)}else {this.debug('TVG initial camera',a);this.tvgCameraChange(a.altitude,a.longitude,a.aperture)}}catch(e){this.error('Failed to set initial angle')}},setupViewerEventListeners:function(b,a){if(a){this.tvgLoadCompleteHandler=this.tvgLoadComplete.bind(this);this.tvgCameraChangeHandler=this.tvgCameraChange.bind(this);this.tvgMouseClickHandler=this.tvgMouseClick.bind(this)}b.loadComplete(this.tvgLoadCompleteHandler,a);b.cameraChange(this.tvgCameraChangeHandler,a);b.mouseClick(this.tvgMouseClickHandler,a);if(!a){delete this.tvgLoadCompleteHandler;delete this.tvgCameraChangeHandler;delete this.tvgMouseClickHandler}},tvgLoadComplete:function(){this.debug('TVG loadComplete',arguments)},tvgCameraChange:function(d,c,e){var b=this.toDegrees(d);var a=this.toDegrees(c);this.setCurrentRotation({x:b,y:a});this.fireEvent('rotationchange',this.getCurrentRotation(),this.getCurrentScanId())},tvgMouseClick:function(a){if(a&&a.guid){this.tvgMoveToScanPosition(a.guid)}else {}return !1},tvgMoveToScanPosition:function(a){Ext.defer(function(){this.showScanViewer(null,a,null,this.imperial)},100,this)},createSnapShot:function(){var a=this.getScanViewer();if(!a){return new Promise(function(b,a){a('No viewer')})}return new Promise(function(b,c){a.createView('TestView'+(new Date()).getTime(),function(a,d){if(a){console.error('Error creating view',a);c('Error creating view: '+a)}else {console.log('View created');b(d)}})})},takeScreenShot:function(){var a=this.getScanViewer();return a.getPictureDataURL()},loadSiteScans:function(c,b,a){if(!a){a=this.getTvcUrl()}var d=a+'/site/scans/'+c+'?count=1000';this.debug('Loading site scans...',d);this.tvgRestApiCall(d,function(e,f){var h=[];if(e&&e.scans&&e.scans.length){this.debug('Loaded '+e.total+' scans');for(var g=0;g<e.scans.length;g++){var d=e.scans[g];if(d.id&&d.name&&d.position&&d.position.length){if(d.position.length<3){f="Scans don't contain x, y, z values";console.warn("Warning - scan position doesn't contain x, y, z",d);break}h.push({id:d.id,name:d.name,position:{x:d.position[0],y:d.position[1],z:d.position[2]}})}}}else {if(!f){f='No scans returned for '+c}}if(b){b.call(this,h,f)}}.bind(this))},tvgRestApiCall:function(b,a){if(a===undefined){a=Ext.emptyFn}Ext.Ajax.request({url:b,method:'GET',headers:{'Content-Type':'application/json','Accept':'application/json'},withCredentials:!1,success:function(c,e){console.log('TVG Rest API response',c);try{var d=Ext.JSON.decode(c.responseText);a(d)}catch(f){console.error('Failed to parse json response',f);a(null,'Failed to parse json response')}},failure:function(c,d){console.error('Rest API call failed',c);a(null,'Rest API call failed')}})}},1,0,0,0,0,[[Ext.mixin.Observable.prototype.mixinId||Ext.mixin.Observable.$className,Ext.mixin.Observable],[siteWalk360.SW360Util.prototype.mixinId||siteWalk360.SW360Util.$className,siteWalk360.SW360Util]],[siteWalk360,'TruViewSDK'],0);Ext.cmd.derive('mdsUtil.Browser',Ext.Base,{singleton:!0,isMouseEventSupported:function(a){var b=document.createElement('div');a='on'+a;var c=a in b;if(!c){b.setAttribute(a,'return;');c=typeof b[a]=='function'}b=null;return c}},0,0,0,0,0,0,[mdsUtil,'Browser'],0);Ext.cmd.derive('permissions.Values',Ext.Base,{statics:{PUBLIC:1,PRIVATE:2,CUSTOM:3,getPermissionEventProperties:function(a){return {'Permission Level':{1:'Project Team',2:'Only Me',3:'Custom'}[a],'Share Type ID':a}}}},0,0,0,0,0,0,[permissions,'Values'],0);Ext.cmd.derive('permissions.view.ShareWindow',Ext.window.Window,{layout:'fit',localized:{title:'GSS_Select Members to Sha'},modal:!0,disabled:!1,width:400,height:300,closeAction:'hide',config:{parentButton:null},items:[{xtype:'gridpanel',reference:'memberGrid',bind:'{people}',sortOnLoad:!0,rowLines:!0,selModel:{selType:'checkboxmodel',mode:'SIMPLE',injectCheckbox:'last',allowDeselect:!0},columns:[{localized:{text:'GSS_First Name'},dataIndex:'MemberFirstName',flex:1},{localized:{text:'GSS_Last Name'},dataIndex:'MemberLastName',flex:1}],viewConfig:{listeners:{refresh:{fn:function(a){a.addListener('refresh',function(b){var h=b.up('shareMemberWindow').getParentButton();h.madeChanges=!1;var i=h.getViewModel(),c=i.get('selectedMemberList'),j=b.getStore();if(!c){c=''}var f=c.split(','),e=[];for(var d=0;d<f.length;d++){var g=j.getById(f[d]);if(g){e.push(g)}}b.select(e);b.gridReady=!0},a,{single:!0})},single:!0},selectionchange:function(b){var a=this.up('shareMemberWindow');if(this.gridReady){a.getParentButton().madeChanges=!0;a.madeChanges=!0}}}}}],bbar:['->',{xtype:'button',localized:{text:'G_Done'},listeners:{click:function(e){var a=e.up('shareMemberWindow'),d=a.getSelection(),c=[];for(var b=0;b<d.length;b++){c.push(d[b].getId())}analytics.Ctrl.log('Confirmed Members to Share With',{'Member UIDs':c.join(','),'Made Changes':!!a.madeChanges},['Object Type','Context']);a.hide()}}}],setSelectedMemberList:Ext.emptyFn,getSelection:function(){return this.down('grid').getSelection()},listeners:{hide:function(b){var a=b.getParentButton();if(!a.madeChanges){return}var e=b.down('grid'),d=e.getStore(),c=b.getSelection();if(!c.length){a.setNewShareType(permissions.Values.PRIVATE)}else {if(c.length==d.getCount()){a.setNewShareType(permissions.Values.PUBLIC)}else {a.setNewShareType(permissions.Values.CUSTOM,a.getMemberListFromArray(c))}}b.destroy()}}},0,['shareMemberWindow'],['component','box','container','panel','window','shareMemberWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'shareMemberWindow':!0},['widget.shareMemberWindow'],0,[permissions.view,'ShareWindow'],0);Ext.cmd.derive('permissions.view.ShareWithButton',Ext.button.Button,{config:{owner:'',parentView:null,iconSize:'small'},viewModel:{data:{initialShareTypeID:null,initalShareMemberList:null,shareGridReady:!1},formulas:{selectedShareType:function(b){var a=b('initialShareTypeID'),c=b('selectedShareTypeID');return a!==null?a:c},selectedMemberList:function(b){var a=b('initalShareMemberList');return a!==null?a:b('selectedShareMemberUIDList')},shareIcon:function(d){var b=d('selectedShareType'),c=permissions.view.ShareWithButton,a=c['icons'+Ext.String.capitalize(this.getView().iconSize)];return a[b]?a[b]:a['default']},shareTooltip:function(b){var a=b('selectedShareType');return mvstr['GSS_Shared_with_'+a]?mvstr['GSS_Shared_with_'+a]:mvstr['GSS_Shared_with_default']}}},bind:{selectedShareType:'{selectedShareType}',selectedMemberList:'{selectedMemberList}',icon:'{shareIcon}',tooltip:'{shareTooltip}'},mvPreloadImages:['mds/image/icon/VisibleAllSmall.png','mds/image/icon/VisibleMeSmall.png','mds/image/icon/VisibleSelectedSmall.png'],menu:{items:[{localized:{text:'GSS_Project Team'},action:'all',icon:'mds/image/icon/VisibleAllSmall.png'},{localized:{text:'GSS_Only Me'},action:'me',icon:'mds/image/icon/VisibleMeSmall.png'},{localized:{text:'GSS_Custom'},action:'custom',icon:'mds/image/icon/VisibleSelectedSmall.png'}],listeners:{click:function(e,c,f,d){if(!c){return}var b=this.up('shareWithButton'),a;switch(c.action){case 'all':b.setNewShareType(permissions.Values.PUBLIC);a=permissions.Values.PUBLIC;break;case 'me':b.setNewShareType(permissions.Values.PRIVATE);a=permissions.Values.PRIVATE;break;case 'custom':b.showShareWindow();a=permissions.Values.CUSTOM;}analytics.Ctrl.log('Set Permission Level',permissions.Values.getPermissionEventProperties(a),['Object Type','Context'])}}},constructor:function(a){permissions.view.ShareWithButton.iconsSmall={1:'mds/image/icon/VisibleAllSmall.png',2:'mds/image/icon/VisibleMeSmall.png',3:'mds/image/icon/VisibleSelectedSmall.png','default':'mds/image/icon/VisibleUnknownSmall.png'};permissions.view.ShareWithButton.iconsMedium={1:'mds/image/icon/VisibleAllMedium.png',2:'mds/image/icon/VisibleMeMedium.png',3:'mds/image/icon/VisibleSelectedMedium.png','default':'mds/image/icon/VisibleUnknownMedium.png'};Ext.button.Button.prototype.constructor.apply(this,arguments);if(!a.parentView&&this.getViewModel().getParent()){this.setParentView(this.getViewModel().getParent().getView())}if(a.selectedShareType){this.initialize(a.selectedShareType,a.selectedMemberList)}if(a.menuUi){this.menu.ui=a.menuUi}},loadStore:function(){var a=this.lookupViewModel().get('people');if(!a){setTimeout(Ext.bind(this.loadStore,this),1);return}if(!a.isLoaded()&&!a.isLoading()){a.load()}},showShareWindow:function(){this.shareWindow=this.getParentView().add({xtype:'shareMemberWindow',parentButton:this,renderTo:Ext.getBody()});this.shareWindow.showBy(Ext.getBody(),'c-c?')},initialize:function(c,b){var d=this.getViewModel(),a=b;if(typeof b=='object'){a=this.getMemberListFromArray(b)}if(!a||c!=permissions.Values.CUSTOM){a=''}d.set('initialShareTypeID',c);d.set('initalShareMemberList',a)},fireChangeEvent:function(){var a=this.getViewModel();this.fireEvent('selectionChange',{owner:this.owner,selectedShareType:this.private_ShareTypeID,selectedMemberList:this.private_ShareMemberList,button:this})},setNewShareType:function(b,a){if(!a){a=''}this.private_ShareTypeID=b;this.private_ShareMemberList=a;var c=this.getViewModel();this.getViewModel().getParent().set('selectedShareTypeID',b);c.set('initialShareTypeID',null);this.setNewSelectedMemberList(a)},setNewSelectedMemberList:function(b){var a=this.getParentView().lookupViewModel();a.set('selectedShareMemberUIDList',b);a.set('initalShareMemberList',null);this.fireChangeEvent()},getSelectedMemberList:function(){return this.getViewModel().get('selectedShareMemberUIDList')},getSelectedMemberArray:function(){var a=this.getSelectedMemberList();return a?a.split(','):[]},setSelectedMemberArray:function(a){this.setSelectedMemberList(this.getMemberListFromArray(a))},getSelectedShareType:function(){return this.getViewModel().get('selectedShareType')},getSelectedShareTypeStr:function(b){var a='';switch(b){case permissions.Values.PUBLIC:a='public';break;case permissions.Values.PRIVATE:a='private';break;case permissions.Values.CUSTOM:a='custom';}return a},setIcon:function(a){if(!this.el||!this.el.dom){return}Ext.button.Button.prototype.setIcon.apply(this,arguments)},setTooltip:function(a){if(!this.el||!this.el.dom){return}Ext.button.Button.prototype.setTooltip.apply(this,arguments)},setSelectedMemberList:Ext.emptyFn,setSelectedShareType:Ext.emptyFn,getMemberListFromArray:function(d){var a=[];for(var c=0;c<d.length;c++){var b=d[c];if(typeof b=='string'){a.push(b)}else {a.push(b.get('MemberUID'))}}return a.join(',')},listeners:{destroy:function(a){if(a.shareWindow){a.shareWindow.destroy()}}}},1,['shareWithButton'],['component','box','button','shareWithButton'],{'component':!0,'box':!0,'button':!0,'shareWithButton':!0},['widget.shareWithButton'],0,[permissions.view,'ShareWithButton'],0);Ext.cmd.derive('mdsWidget.view.SimpleColorWidget',Ext.ux.colorpick.Button,{width:12,height:12,baseCls:'x-simplecolorwidget',constructor:function(a){a=a||{};a.popup={xtype:'window',referenceHolder:!0,minWidth:173,minHeight:8*20+35,layout:'fit',title:'Annotation color',header:!0,closable:!0,closeAction:'hide',cls:'simple-color-widget-window',ui:a.popupUi||'default',shadow:a.popupShadow===undefined?!0:!1,alwaysOnTop:2,listeners:{show:{fn:function(c){var b=this.up().el.getZIndex();if(!isNaN(b)){c.el.setZIndex(b+1)}},scope:this},focusLeave:{fn:function(b){b.hide()}}},items:{xtype:'colorpicker',reference:'selector',allowReselect:!0,colors:['FF8080','FFFF80','80FF80','00FF80','80FFFF','0080FF','FF80C0','FF80FF','FF0000','FFFF00','80FF00','00FF40','00FFFF','0080C0','8080C0','FF00FF','804040','FF8040','00FF00','008080','004080','8080FF','800040','FF0080','C02020','C08040','20C080','008040','2040A0','336699','204080','C080FF','A04020','FF4040','A0FFA0','40FF40','4000C0','4040FF','4080C0','8020A0','800000','FF8000','008000','40A040','0000FF','0000A0','800080','8000FF','400000','804000','004000','004040','000080','000040','400040','400080','000000','202020','404040','808080','A0A0A0','C0C0C0','E0E0E0','FFFFFF'],handler:function(b,c){this.fireEvent('ok',b,c)},setValue:function(b){if(typeof b==='object'&&b!=null&&b.hasOwnProperty('r')){b=Ext.ux.colorpick.ColorUtils.rgb2hex(b.r,b.g,b.b)}if(b){b=b.toUpperCase();if(this.colors.indexOf(b)===-1){this.colors.push(b);var c=Math.ceil(this.colors.length/8);this.up('window').minHeight=c*20+35}}if(b!==this.value){try{this.select(b,!0)}catch(d){console.log(d.message)}}},getColor:function(){var b=this.getValue();return b?b.toUpperCase():null},setColor:function(b){this.setValue(b)},getPreviousColor:function(){return this.previousColor},setPreviousColor:function(b){this.previousColor=b},getFormat:function(){return this.format},setFormat:function(b){this.format=b},listeners:{afterrender:function(b){var c=this.up('window')}}}};Ext.ux.colorpick.Button.prototype.constructor.call(this,a)},listeners:{click:{fn:function(a){a.stopEvent();if(window.openColorPicker&&window.openColorPicker!==this){if(window.openColorPicker.component&&window.openColorPicker.component.colorPickerWindow){window.openColorPicker.component.colorPickerWindow.close()}}window.openColorPicker=this},element:'btnEl'}}},1,['simplecolorwidget'],['component','box','colorbutton','simplecolorwidget'],{'component':!0,'box':!0,'colorbutton':!0,'simplecolorwidget':!0},['widget.simplecolorwidget'],0,[mdsWidget.view,'SimpleColorWidget'],0);Ext.cmd.derive('mdsWidget.view.AnnotationsGrid',Ext.grid.Panel,{config:{typeHidden:!1,removeImportExport:!1,removeCopy:!1,tooltipConfig:null,showVisibilityHeaderToggle:!1,titleHeaderLabel:''},scrollable:'y',selModel:'rowmodel',emptyText:'There are no annotations for this plan',ui:'annotationsgrid',rowLines:!1,minHeight:120,plugins:{ptype:'cellediting',clicksToEdit:2},bind:{selection:'{selectedAnnotation}',store:'{annotationStore}'},viewConfig:{markDirty:!1,getRowClass:function(a){return a.get('Visible')?'visible':''}},listeners:{colorbuttonchange:'annotationColorButtonChange',beforeselect:'annotationGridBeforeSelectionChanged',select:'annotationGridSelectionChanged',beforerowclick:'annotationGridBeforeRowClick',rowclick:'annotationGridRowClick',beforecelldblclick:'annotationGridCellEdit',cellclick:function(g,h,b,a,i,f){console.log('click old');if(b==4){var e=a.get('Visible');a.set('Visible',e==0?1:0);this.fireEvent('visibilitychanged',a);return !1}if(b==5){if(a.get('CanEdit')){var d=a.get('ShareTypeID');var c=d===1?2:1;a.set('ShareTypeID',c);this.fireEvent('sharetypechanged',a,c,d)}}},visibilitychanged:'annotationVisibilityChanged',sharetypechanged:'annotationShareTypeChanged',edit:'annotationGridEdit',itemmousedown:function(d,a,c,b){if(window.openColorPicker&&window.openColorPicker.component&&window.openColorPicker.component.colorPickerWindow){window.openColorPicker.component.colorPickerWindow.close();delete window.openColorPicker}},beforeitemkeydown:function(f,b,e,d,a,c){if(a.event.code==='Delete'){this.fireEvent('deleteKeyPressed')}},deleteKeyPressed:'removeButtonClick'},initComponent:function(){if(this.getTitleHeaderLabel()==''){this.setTitleHeaderLabel(mvstr['MVTI_Title'])}var a=this.getShowVisibilityHeaderToggle();this.columns=[{text:'',dataIndex:'Color',width:31,xtype:'widgetcolumn',resizable:!1,sortable:!0,menuDisabled:!0,widget:{xtype:'simplecolorwidget',width:12,height:12,listeners:{beforerender:function(a){a.setDisabled(!a.getWidgetRecord().get('CanEdit')||!a.lookupViewModel().get('projectMapEditable'))},change:function(e,b,c){if(c==undefined){return}var a=e.getWidgetRecord();if(a==undefined){return}if(Number('0x'+a.get('Color').split('#')[1])==Number('0x'+b)){return}var d=this.up('annotationsgrid');d.fireEvent('colorbuttonchange','#'+b.toUpperCase(),a)}}}},{text:this.getTitleHeaderLabel(),dataIndex:'Title',flex:1,editor:'textfield',resizable:!1,menuDisabled:!0,renderer:function(c,b,a){return a.get('TitleDisplayValue')}},{localized:{text:'MVTI_Owner',tooltip:'MVTI_Owner'},dataIndex:'MemberInitials',width:this.getTypeHidden()?60:50,align:'center',resizable:!1,menuDisabled:!0,renderer:function(b,c,a){return '<span title="'+a.get('MemberName')+'">'+b+'</span>'}},{localized:{text:'MVTI_Type'},dataIndex:'TypeLabelShort',width:50,align:'center',resizable:!1,menuDisabled:!0,hidden:this.getTypeHidden()},{text:a?'':mvstr['MVTI_Vis'],tooltip:a?undefined:mvstr['MVFPO_Visibility'],sortable:!a,focusCls:a?'':'focus',cls:a?'visibility-toggle':'',padding:0,dataIndex:'Visible',localized:{width:{zh_CN:36,'default':30}},align:'center',resizable:!1,menuDisabled:!0,renderer:function(a,b,c){return '<span class="mapping-visible-icon'+(a?'':' hidden')+'"></span>'},listeners:{render:{fn:function(b){if(a){this.visibilityToggle=Ext.create('Ext.button.Button',{ui:'plain',cls:'annotation-visible-icon',renderTo:b.el,height:20,padding:4,width:30,enableToggle:!0,pressedCls:'hidden',listeners:{click:{fn:'onToggleAllVisibilityClick',scope:this.lookupController()}}})}},scope:this}}},{text:'',dataIndex:'ShareTypeID',width:30,align:'center',resizable:!1,menuDisabled:!0,bind:{hidden:'{!projectMapEditable}'},renderer:function(d,e,c){var b=['team','private'];var a=c.get('CanEdit')?'':' disabled';return '<div class="mapping-permission-icon '+b[d-1]+a+'"></div>'}}];var b=this.getTooltipConfig(),c=['->',{xtype:'button',tooltip:b?Ext.merge({text:mvstr['GABTT_Delete']},b):mvstr['GABTT_Delete'],ui:'annotationfooterbutton',iconCls:'annotationFooterIcon remove',disabled:!0,bind:{disabled:'{deleteAnnotationBtnDisabled}'},listeners:{click:'removeButtonClick'}}];if(!this.getRemoveCopy()){Ext.Array.insert(c,1,[{xtype:'button',tooltip:b?Ext.merge({text:mvstr['GABTT_Copy']},b):mvstr['GABTT_Copy'],ui:'annotationfooterbutton',iconCls:'annotationFooterIcon copy',disabled:!1,bind:{disabled:'{copyAnnotationBtnDisabled}'},listeners:{click:'copyButtonClick'}},'-'])}if(!this.getRemoveImportExport()){Ext.Array.insert(c,1,[{xtype:'button',localized:{tooltip:'GABTT_Import'},ui:'annotationfooterbutton',iconCls:'annotationFooterIcon import',listeners:{click:'importButtonClick'}},'-',{xtype:'button',localized:{tooltip:'GABTT_Export'},ui:'annotationfooterbutton',iconCls:'annotationFooterIcon export',listeners:{click:'exportButtonClick'}},'-'])}this.dockedItems={xtype:'toolbar',dock:'bottom',ui:'toolbar',hidden:!0,bind:{hidden:'{!projectMapEditable}'},cls:'annotationGridFooter',items:c};Ext.grid.Panel.prototype.initComponent.apply(this,arguments)}},0,['annotationsgrid'],['component','box','container','panel','tablepanel','gridpanel','grid','annotationsgrid'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tablepanel':!0,'gridpanel':!0,'grid':!0,'annotationsgrid':!0},['widget.annotationsgrid'],0,[mdsWidget.view,'AnnotationsGrid'],0);Ext.cmd.derive('mdsWidget.view.ExpandTab',Ext.button.Button,{ui:'expandtab',scale:'medium',width:17,height:89,config:{lhs:!1},initComponent:function(){if(this.scale=='small'){this.setWidth(21);this.setHeight(32)}Ext.button.Button.prototype.initComponent.apply(this,arguments);this.setIconCls(this.getEffectiveIconCls('collapse'));if(this.getLhs()){this.addCls('lhs')}},getEffectiveIconCls:function(a){return a=='collapse'&&!this.getLhs()||a!='collapse'&&this.getLhs()?'collapse':'expand'},listeners:{click:function(){if(this.getEffectiveIconCls(this.iconCls)=='collapse'){this.setIconCls(this.getEffectiveIconCls('expand'));this.fireEvent('collapse')}else {this.setIconCls(this.getEffectiveIconCls('collapse'));this.fireEvent('expand')}}}},0,['expandtab'],['component','box','button','expandtab'],{'component':!0,'box':!0,'button':!0,'expandtab':!0},['widget.expandtab'],0,[mdsWidget.view,'ExpandTab'],0);Ext.cmd.derive('mdsWidget.view.ShootLockToggle',Ext.button.Button,{scale:'small',ui:'plain',config:{menuConfig:[{localized:{text:'PT_Same Day'},itemId:'lockToShootDate'},{localized:{text:'PT_Same Location'},itemId:'lockToHotspot'}],lockMode:'lockToShootDate'},publishes:'lockMode',padding:'3 6 0 6',width:116,textAlign:'left',initComponent:function(){var a=this.getMenuConfig();for(var b=0;b<a.length;b++){a[b].listeners={click:{fn:this.onMenuButtonClick,scope:this}};if(a[b].itemId==this.getLockMode()){this.setText(mvstr[a[b].localized.text]);a[b].cls='selected'}a[b].height=21}this.setMenu({ui:'dark2',showSeparator:!1,shadow:!1,cls:'shoot-lock-menu',defaultMinWidth:106,width:106,items:a});Ext.button.Button.prototype.initComponent.apply(this,arguments)},onMenuButtonClick:function(a){this.setLockMode(a.getItemId())},updateLockMode:function(c){if(!c||this.isConfiguring){return}var d=this.getMenu().down('#'+c);this.setText(d.config.text);var b=this.getMenu().items.items;for(var a=0;a<b.length;a++){if(b[a].getItemId()==c){b[a].addCls('selected')}else {b[a].removeCls('selected')}}}},0,['shootlocktoggle'],['component','box','button','shootlocktoggle'],{'component':!0,'box':!0,'button':!0,'shootlocktoggle':!0},['widget.shootlocktoggle'],0,[mdsWidget.view,'ShootLockToggle'],0);Ext.cmd.derive('comments.model.CommentEntry',Ext.data.Model,{entityName:'CommentEntry',fields:[{name:'CommentDateTime',type:'date',persist:!1},{name:'MemberUID',persist:!1},{name:'Text'},{name:'ShareTypeID'},{name:'ShareMembers'},{name:'IsMine',type:'boolean',persist:!1},{name:'CommentEntryID'},{calculate:function(a){return a.IsMine?!0:!1},name:'IsEditable',persist:!1},{name:'MemberFirstName',persist:!1},{name:'MemberLastName',persist:!1},{calculate:function(a){return a.IsMine?'my-comment':'not-my-comment'},name:'OwnershipCls',persist:!1},{name:'referenceTime',convert:function(a){if(a){return a}return new Date()},persist:!1},{calculate:function(a){return customData.Util.getTimeDescription(a.referenceTime,a.CommentDateTime)},name:'TimeDescription',type:'string',persist:!1},{name:'MemberName',calculate:function(a){return Ext.String.trim(a.MemberFirstName+' '+a.MemberLastName)},persist:!1},{name:'ShareCls',calculate:function(a){return a.ShareTypeID==1?'team':a.ShareTypeID==2?'me':a.ShareTypeID==3?'custom':''},persist:!1},{name:'id'},{name:'ParentID',mapping:function(a){if(a.PunchItemID){return a.PunchItemID}return null}},{name:'mentions'},{name:'CommentStyled',calculate:function(b){var a=b.Text;a=a.replace(/</g,'&lt;');a=a.replace(/>/g,'&gt;');if(b.mentions&&b.mentions.length){b.mentions.sort(function(a,c){if(a.Position==c.Position){return 0}return a.Position>c.Position?-1:1});Ext.each(b.mentions,function(c){var e=c.Position+c.Length+1,d=c.Position;a=[a.slice(0,e),'</span>',a.slice(e)].join('');a=[a.slice(0,d),'<span class="mention">',a.slice(d)].join('')})}return a}}],idProperty:'CommentEntryID',clientIdProperty:'id',proxy:{type:'ajax',reader:{type:'json',rootProperty:'data'},writer:{writeAllFields:!0}}},0,0,0,0,0,0,[comments.model,'CommentEntry'],0);Ext.cmd.derive('comments.view.batchaddcomment.AddCommentModel',Ext.app.ViewModel,{data:{saving:!1,saveDone:!1},formulas:{saveEnabled:function(a){return !!a('comment.value')}}},0,0,0,0,['viewmodel.batchaddcomment'],0,[comments.view.batchaddcomment,'AddCommentModel'],0);Ext.cmd.derive('comments.view.batchaddcomment.AddCommentController',Ext.app.ViewController,{statics:{MAX_PHOTOS:100},init:function(){analytics.Ctrl.setOptionalDefaultEventProperties({'Object Type':'Photo Comment','Context':'Batch-Add Comment Dialog'})},save:function(){var b=this.getViewModel(),c=this.lookupReference('shareWithButton'),d=c.getSelectedMemberArray(),a={Text:this.lookupReference('comment').getValue(),CommentType:'photo',mentions:[]};a.ShareTypeID=c.getSelectedShareType();if(a.ShareTypeID==3){a.ShareMembers=d}a.PhotoIdentifiers=[];b.get('selectedPhotos').each(function(b){a.PhotoIdentifiers.push(b.get('id'))});b.set('saving',!0);analytics.Ctrl.log('Commented on Photo',{},['Photo List','Photo Action Element']);Ext.Ajax.request({url:'/index.cfm?fuseaction=aComments.batchSaveComments',jsonData:a,params:{ProjectUID:b.get('ProjectUID'),nComments:1},successCallback:function(){b.set('saveDone',!0);this.getView().fireEvent('changedphotos',a);Ext.defer(function(){this.getView().destroy()},1000,this)},afterFailMessageCallback:function(c,a){b.set('saving',!1);b.set('errorMessage',a?a:mvstr.G_UnexpectedError)},scope:this})}},0,0,0,0,['controller.batchaddcomment'],0,[comments.view.batchaddcomment,'AddCommentController'],0);Ext.cmd.derive('comments.view.batchaddcomment.AddComment',Ext.window.Window,{viewModel:{type:'batchaddcomment'},controller:'batchaddcomment',ui:'orange',cls:'photo-actions-window',localized:{title:'PUL_Add a Comment'},modal:!0,padding:'28 20 24 20',width:426,height:415,layout:{type:'vbox'},constructor:function(){var a=this;a.items=[{xtype:'container',width:'100%',flex:1,layout:{type:'hbox'},items:[{xtype:'component',cls:'instructions',html:'<b>'+mvstr['PUL_Add a Comment to Phot']+'</b><div>'+mvstr['PUL_This will add your co']+'</div>',width:216},{xtype:'photoselectionthumb'}]},{xtype:'container',layout:{type:'hbox',align:'top'},items:[{xtype:'component',html:'<b>'+mvstr['PUL_Add your comment']+'</b>',padding:'3 0 0 0'},{xtype:'shareWithButton',reference:'shareWithButton',menuUi:'white',ui:'plain'}]},{xtype:'detailformtextarea',reference:'comment',publishes:'value',maxLength:255,enforceMaxLength:!0,width:'100%',height:107}];Ext.window.Window.prototype.constructor.apply(this,arguments)},dockedItems:[{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},padding:'12 0 0 0',items:[{xtype:'button',scale:'medium',ui:'grey',localized:{text:'G_Cancel'},margin:'0 12 0 12',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',bind:{processing:'{saving}',done:'{saveDone}',disabled:'{!saveEnabled}'},margin:'0 12 0 12',listeners:{click:'save'}}]}]},1,['batchaddcomment'],['component','box','container','panel','window','batchaddcomment'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'batchaddcomment':!0},['widget.batchaddcomment'],0,[comments.view.batchaddcomment,'AddComment'],0);Ext.cmd.derive('comments.view.comments.Comment',Ext.container.Container,{cls:'comment-component',comment:null,readOnlyTpl:new Ext.XTemplate('<tpl for="."><div class="comment-container"><div class="comment-text"><tpl if="IsEditable"><div class="comment-menu-button"></div></tpl><span class="comment-member-name">{MemberName}:</span>&nbsp;{CommentStyled}</div><div class="comment-footer"><span class="comment-date">{TimeDescription}</span><div class="comment-permissions {ShareCls}"></div></div></div></tpl>'),initComponent:function(){Ext.container.Container.prototype.initComponent.apply(this,arguments);this.startReadOnly()},listeners:{click:{element:'el',fn:'onCommentEntryClick'}},startReadOnly:function(){var a=this.readOnlyTpl.apply(this.comment.getData());this.removeAll(!0);this.add({xtype:'component',html:a})},startEdit:function(){var b=this.getEl().getWidth();this.removeAll(!0);this.add([{xtype:'textarea',cls:'existing-comment',minLength:1,maxLength:255,allowOnlyWhitespace:!1,value:this.comment.get('Text'),height:46,grow:!0,enableKeyEvents:!0,listeners:{keydown:this.onEntryKeyPress,scope:this,blur:{fn:this.onEntryBlur,delay:1}},margin:0,width:b},{xtype:'component',cls:'directions',localized:{html:'GC_Press escape to exit'},margin:'2 2 3 2'}]);var a=this.down('textarea');a.focus();var c=a.getValue();a.setValue('');a.setValue(c)},onEntryKeyPress:function(c,a){var b=a.getCharCode();if(b==a.ENTER&&!a.shiftKey){if(!c.isValid()){a.preventDefault();return !1}this.lookupController().updateComment(this);return !1}else {if(b==a.ESC){this.onEntryBlur();return !1}}return !0},onEntryBlur:function(){this.comment.reject();this.startReadOnly()}},0,['commentcomponent'],['component','box','container','commentcomponent'],{'component':!0,'box':!0,'container':!0,'commentcomponent':!0},['widget.commentcomponent'],0,[comments.view.comments,'Comment'],0);Ext.cmd.derive('comments.view.comments.CommentMenu',Ext.menu.Menu,{showSeparator:!1,ui:'comment',defaultAlign:'tr-bl?',items:[{localized:{text:'GC_Edit'},icon:'mds/image/icon/details_edit.png',listeners:{click:function(a){a.up('menu').commentCmp.startEdit()}}},{localized:{text:'GC_Delete'},icon:'mds/image/icon/x.png',listeners:{click:function(b){var a=b.up('menu');a.hide();Ext.defer(function(){this.lookupController().deleteComment(a.commentCmp)},1,this)}}}]},0,['commentmenu'],['component','box','container','panel','menu','commentmenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'commentmenu':!0},['widget.commentmenu'],0,[comments.view.comments,'CommentMenu'],0);Ext.cmd.derive('comments.view.comments.CommentsController',Ext.app.ViewController,{config:{isWaiting:!1},newCommentMentions:[],currentMention:null,init:function(){this.control({'#listWrapper shareWithButton':{selectionChange:function(a){var d=a.button.comment,e=this.getViewModel(),b=e.get('commentParams'),c=this.getStore('comments');d.set('ShareTypeID',a.selectedShareType);d.set('ShareMembers',a.selectedMemberList?a.selectedMemberList.split(','):[]);if(b){c.getProxy().setExtraParams(b);c.sync({silentSuccess:!0,callback:this.loadComments,scope:this})}}}});this.addListener('triggerbufferload',this.doCommentsLoad,this,{buffer:1000})},beforeCommentsLoaded:function(b){var a=this.getView();if(b){a.setLoading(!0)}else {a.setLoading(!1)}a.down('#listWrapper').removeAll()},doCommentsLoad:function(){var a=!!this.getViewModel().get('commentViewData.BufferLoad'),b=this.getViewModel().get('commentViewData.CommentCount');if(!a||a&&b){this.getStore('comments').load({callback:this.onCommentsLoaded,scope:this})}},loadComments:function(){var b=this.getViewModel().get('commentViewData.CommentCount'),a=this.getStore('comments'),c=!!this.getViewModel().get('commentViewData.BufferLoad');if(a.isLoading()){a.mvAbort()}this.beforeCommentsLoaded(b);if(b){if(c){this.fireEvent('triggerbufferload')}else {this.doCommentsLoad()}}else {a.loadData([],!1);this.getView().onCommentsRefresh(a)}},onCommentsLoaded:function(c,b,a){if(a){this.getView().setLoading(!1)}},saveNewComment:function(){var e=this.lookupReference('newCommentShareMemberButton'),c=this.getView(),d=this.getViewModel(),m=!c.down('commententryfield_old').isVisible(),n=m?'newCommentEntry':'newCommentText',f=this.lookupReference(n),h=c.down('#listWrapper'),a=this.getStore('comments'),j=f.getValue(),k=this.newCommentMentions,b=d.get('commentParams');d.set('commentViewData.CommentCount',d.get('commentViewData.CommentCount')+1);var g=Ext.create('comments.model.CommentEntry',{ShareTypeID:e.getSelectedShareType(),ShareMembers:e.getSelectedMemberArray(),Text:j,MemberFirstName:d.get('account.MemberUsername'),MemberLastName:'',referenceTime:new Date(),CommentDateTime:new Date(),mentions:k,IsMine:!0});f.setValue('');a.add(g);g.newCmp=c.onCommentsRefresh(a);h.scrollBy(0,Infinity);if(b){g.newCmp.mask('Saving ...')}var l=Ext.bind(function(){if(b){a.getProxy().setExtraParams(b);a.sync({success:function(e){var d=e.getOperations()[0].getRecords();c.onCommentsRefresh(a);h.scrollBy(0,Infinity);for(var b=0;b<d.length;b++){d[b].newCmp.unmask()}this.newCommentMentions=[];a.fireEvent('aftersync')},afterFailMessageCallback:function(e){var d=e.getOperations()[0].getRecords();for(var b=0;b<d.length;b++){a.remove(d[b])}f.setValue(j);this.newCommentMentions=k;c.onCommentsRefresh(a);a.fireEvent('aftersync')}})}},this);if(!a.isSyncing){l()}else {if(!this.getIsWaiting()){this.setIsWaiting(!0);a.addListener('aftersync',function(){l();this.setIsWaiting(!1)},this,{single:!0})}}if(b&&b.Identifier){var i=permissions.Values.getPermissionEventProperties(e.getSelectedShareType());if(b.CommentType=='photo'){analytics.Ctrl.log('Commented on Photo',Ext.apply({'Photo List':b.Identifier,'Photo Action Element':'Photo Viewer Comment Entry'},i))}else {if(b.CommentType=='punchitem'){analytics.Ctrl.log('Commented on Photo',i,['Task List Item ID'])}}}},deleteComment:function(c){var b=this.getStore('comments'),d=c.comment,e=this.getView(),a=this.getViewModel().get('commentParams');b.remove(d);e.onCommentsRefresh(b);if(a){Ext.defer(function(){b.getProxy().setExtraParams(a);b.sync({scope:this,useDefaults:!0,afterFailMessageCallback:this.loadComments,silentSuccess:!0})},1,this);if(a.Identifier){analytics.Ctrl.log('Deleted Comment on Photo',{'Photo List':a.Identifier,'Photo Action Element':'Photo Viewer Comment Entry'})}}},onCommentEntryClick:function(d,c){var a=Ext.fly(c),b=Ext.getCmp(a.up('.comment-component').id);if(a.hasCls('comment-menu-button')){if(this.commentMenu){this.commentMenu.destroy()}this.commentMenu=this.getView().add({commentCmp:b,xtype:'commentmenu'});this.commentMenu.showBy(a)}},initView:function(){this.lookupReference('newCommentShareMemberButton').setParentView(this.getViewModel().getParent().getView())},updateComment:function(a){var e=a.down('textarea').getValue(),d=a.comment,b=this.getViewModel().get('commentParams'),c=this.getStore('comments');d.set('Text',e);a.startReadOnly();if(b){a.mask('Saving ...');c.getProxy().setExtraParams(b);c.sync({success:function(){a.unmask()},afterFailMessageCallback:function(){d.reject();a.startReadOnly();a.unmask()}})}},newCommentKeyDown:function(b,a){var c=a.getCharCode(),d=this.activeMentionKeydown(a)||this.checkMentionSelectionOnKeydown(a);if(d){a.preventDefault();return !1}this.newCommentTextChange();if(c==a.ENTER&&!a.shiftKey){if(!b.isValid()){a.preventDefault();return !1}this.saveNewComment();a.preventDefault();return !1}else {if(a.event.key=='@'){this.currentMention={Position:a.getTarget().selectionStart};this.lookupReference('userMentionSelection').show()}else {if(c==a.ESC){b.blur();return !1}}}return !0},activeMentionKeydown:function(a){if(!this.currentMention){return}var b=a.getCharCode(),d=this.lookupReference('newCommentEntry').getValue(),c=this.currentMention.Position;end=d.slice(c).search(/\s/);if(a.getTarget().selectionStart<=c||end>-1&&a.getTarget().selectionStart>end+c){this.breakMention();return}if(b==a.ENTER&&!a.shiftKey){this.addMentionToComment();return !0}else {if(b==a.DOWN){this.navigateBoundlist(1);return !0}else {if(b==a.UP){this.navigateBoundlist(-1);return !0}else {if(b==a.SPACE){this.breakMention()}}}}},breakMention:function(){this.currentMention=null;this.lookupReference('userMentionSelection').hide()},navigateBoundlist:function(d){var a=this.lookupReference('userMentionSelection'),c=a.getStore(),e=a.selection,b=c.findExact('MemberUID',e.get('MemberUID')),f=a.getScrollable();b=Math.min(c.getCount()-1,b+d);a.select(c.getAt(b));var g=a.getNode(a.selection);f.scrollIntoView(g)},filterBoundlist:function(f){var d=this.lookupReference('userMentionSelection').getStore(),a=this.currentMention.Position,h=this.newCommentMentions,b=f||this.lookupReference('newCommentEntry').getValue(),e=b.slice(a).search(/\s/),i=e>-1?e+a:b.length,g=b.slice(a+1,i).toLowerCase()||'',c=[];d.clearFilter();Ext.each(h,function(a){c.push(a.MemberUID)});d.filterBy(function(a){var b=a.get('MemberDisplayName').toLowerCase(),d=a.get('MemberUID');return b.indexOf(g)>-1&&c.indexOf(d)==-1})},addMentionToComment:function(i,h){var e=i||this.lookupReference('userMentionSelection'),g=h||e.selection,f=this.lookupReference('newCommentEntry'),a=f.getValue(),c=this.currentMention.Position,b=a.slice(c).search(/\s/),d=g.get('MemberDisplayName').trim();this.currentMention.MemberUID=g.get('MemberUID');this.currentMention.MemberDisplayName=d;this.currentMention.Length=d.length;b=b>-1?b+c:a.length;a=a.slice(0,c+1)+d+a.slice(b);this.newCommentMentions.push(this.currentMention);this.currentMention=null;this.newCommentMentions=this.newCommentMentions.sort(function(a,b){if(a.Position==b.Position){return 0}return a.Position>b.Position?-1:1});f.setValue(a);e.hide()},commentTextAreaScroll:function(c){var a=this.lookupReference('commentOverlay'),d=this.lookupReference('newCommentEntry'),b=0;a.removeCls('scrollable');if(d.inputEl.isScrollable()){a.addCls('scrollable')}if(c&&a){b+=c.target.scrollTop;a.setStyle({'top':-1*b+'px'})}},newCommentTextChange:function(){var c=this.lookupReference('commentOverlay'),a=this.lookupReference('newCommentEntry').getValue();this.checkMentionPositions(a);if(this.currentMention){this.filterBoundlist(a)}a=a.replace(/</g,'&lt;');a=a.replace(/>/g,'&gt;');var b=this.newCommentMentions;if(b&&b.length){Ext.each(b,function(b){var d=b.Position+b.Length+1,c=b.Position,e='mention'+(b.Selected?' highlight':'');a=[a.slice(0,d),'</span>',a.slice(d)].join('');a=[a.slice(0,c),'<span class="'+e+'">',a.slice(c)].join('')})}c.setHtml(a);this.commentTextAreaScroll()},checkMentionPositions:function(c){var b=this.newCommentMentions,a=[];Ext.each(b,function(b){var e='@'+b.MemberDisplayName,d=c.indexOf(e);if(d>-1){b.Position=d;a.push(b)}});this.newCommentMentions=null;this.newCommentMentions=a},hideUserMentionSelection:function(){this.lookupReference('userMentionSelection').hide()},checkMentionSelectionOnKeydown:function(a){var b=a.getCharCode(),f=this.newCommentMentions,e=a.target.selectionStart,d=this.lookupReference('newCommentEntry'),c=!1;if(b!=a.LEFT&&b!=a.RIGHT&&b!=a.BACKSPACE){return}Ext.each(f,function(f){var g=f.Position;var h=f.Position+f.Length+1;if(b==a.LEFT){if(e==h){if(!f.Selected){f.Selected=c=!0}else {d.selectText(g+1,g+1)}}}else {if(b==a.RIGHT){if(e==g){if(f.Selected){d.selectText(h,h)}else {f.Selected=c=!0}}}else {if(b==a.BACKSPACE){if(f.Selected){var i=d.getValue();i=i.slice(0,g)+i.slice(h);d.setValue(i);d.selectText(g,g);c=!0;return}if(e==h){f.Selected=c=!0}}}}});this.newCommentTextChange();return c},checkMentionCaretPosition:function(b,e){var a=e.target.selectionEnd,d=this.newCommentMentions,c=this;b=b||this.lookupReference('newCommentEntry');Ext.each(d,function(d){var g=d.Position;var f=d.Position+d.Length+1;if(g!=a&&f!=a&&d.Selected){d.Selected=!1;c.newCommentTextChange()}if(g<a&&f>a&&!d.Selected){b.selectText(f,f)}})}},0,0,0,0,['controller.comments'],0,[comments.view.comments,'CommentsController'],0);Ext.cmd.derive('comments.view.comments.CommentEntryField',Ext.container.Container,{items:[{xtype:'container',items:[{xtype:'container',cls:'new-comment-form',margin:'2 0 0 0',width:'100%',layout:{type:'hbox'},bind:{hidden:'{!canWriteComments}'},items:[{xtype:'container',flex:1,items:[{xtype:'component',reference:'commentOverlay',cls:'new-comment-overlay',width:'100%'},{xtype:'textareafield',cls:'new-comment',reference:'newCommentEntry',allowBlank:!1,grow:!0,localized:{emptyText:'GC_Write a comment\u2026'},minLength:1,maxLength:255,growMax:125,growMin:40,enforceMaxLength:!0,invalidCls:'',triggerWrapInvalidCls:'',inputWrapInvalidCls:'',width:'100%',preventMark:!0,enableKeyEvents:!0,listeners:{keydown:'newCommentKeyDown',change:'newCommentTextChange',focusleave:'hideUserMentionSelection',render:function(b){var a=this.lookupController();b.inputEl.on('scroll',a.commentTextAreaScroll,a);b.inputEl.on('click',function(c){a.checkMentionCaretPosition(null,c)})},keyup:'checkMentionCaretPosition'}}]},{xtype:'shareWithButton',reference:'newCommentShareMemberButton',width:38,height:42,arrowAlign:'left',iconSize:'medium',bind:{selectedShareType:'{defaultShareTypeID}'}}]}]},{xtype:'boundlist',reference:'userMentionSelection',bind:'{people}',maxHeight:150,floating:!0,hidden:!0,defaultAlign:'bl',alignOnScroll:!0,cls:'userMentionSelection',itemTpl:'{MemberDisplayName}<br><span class="email">{MemberEmail}</span>',listeners:{itemclick:'addMentionToComment',beforeshow:function(a){var b=this.up('comments');a.lookupController().filterBoundlist();a.setWidth(b.getWidth())},show:function(a){var b=a.lookupController().lookupReference('newCommentEntry');a.anchorTo(b,'tl-bl',[-1,6]);a.setMaxHeight(150)},refresh:function(a){var b=a.getStore();if(b.getAt(0)){a.select(b.getAt(0))}},hide:function(a){a.getStore().clearFilter()}}}]},0,['commententryfield'],['component','box','container','commententryfield'],{'component':!0,'box':!0,'container':!0,'commententryfield':!0},['widget.commententryfield'],0,[comments.view.comments,'CommentEntryField'],0);Ext.cmd.derive('comments.view.comments.CommentEntryField_old',Ext.container.Container,{items:[{xtype:'container',cls:'new-comment-form',margin:'2 0 0 0',width:'100%',layout:{type:'hbox'},bind:{hidden:'{!canWriteComments}'},items:[{xtype:'textfield',cls:'new-comment',reference:'newCommentText',allowBlank:!1,localized:{emptyText:'GC_Write a comment\u2026'},minLength:1,maxLength:255,enforceMaxLength:!0,invalidCls:'',triggerWrapInvalidCls:'',inputWrapInvalidCls:'',flex:1,height:40,preventMark:!0,enableKeyEvents:!0,listeners:{keydown:function(c,a){var b=a.getCharCode();if(b==a.ENTER&&!a.shiftKey){if(!c.isValid()){a.preventDefault();return !1}this.lookupController().saveNewComment();return !1}else {if(b==a.ESC){c.blur();return !1}}return !0}}},{xtype:'shareWithButton',reference:'newCommentShareMemberButton',width:38,height:42,arrowAlign:'left',iconSize:'medium',bind:{selectedShareType:'{defaultShareTypeID}'}}]}]},0,['commententryfield_old'],['component','box','container','commententryfield_old'],{'component':!0,'box':!0,'container':!0,'commententryfield_old':!0},['widget.commententryfield_old'],0,[comments.view.comments,'CommentEntryField_old'],0);Ext.cmd.derive('comments.view.comments.Comments',Ext.container.Container,{cls:'comments-view',controller:'comments',viewModel:{type:'comments'},layout:{type:'vbox',align:'start'},bind:{comments:'{comments}',userCls:'{commentsCls}'},config:{loadMaskCls:'light-load-indicator'},items:[{xtype:'container',itemId:'listWrapper',reserveScrollbar:!0,width:'100%',flex:1,scrollable:{x:!1,y:!0},items:[]},{xtype:'component',itemId:'emptyText',cls:'empty-text',localized:{html:'GC_There are currently n'},flex:2,width:'100%',margin:'0 25 0 5'},{xtype:'commententryfield',width:'100%',hidden:!0,bind:{hidden:'{!mentionsEnabled}'}},{xtype:'commententryfield_old',width:'100%',hidden:!0,bind:{hidden:'{mentionsEnabled}'}}],listeners:{afterrender:{fn:'initView'}},setComments:function(a){a.addListener('refresh',function(){this.onCommentsRefresh(a);this.down('#listWrapper').scrollBy(0,Infinity)},this)},onCommentsRefresh:function(c){var d=c.getCount(),b=this.down('#listWrapper'),g=[],e=[],h=[],j=this.items.length!=d,a;this.suspendLayouts();for(a=0;a<d;a++){c.getAt(a).set('referenceTime',new Date())}for(a=0;a<b.items.length;a++){var f=b.items.items[a],i=f.comment.getId();if(c.getById(i)){h.push(i);f.startReadOnly()}else {e.push(f)}}for(a=0;a<d;a++){if(!Ext.Array.contains(h,c.getAt(a).getId())){g.push({xtype:'commentcomponent',comment:c.getAt(a)})}}b.add(g);for(a=0;a<e.length;a++){b.remove(e[a],!0)}if(j){this.fireEvent('commentcountchange',Ext.Object.merge(this.getViewModel().get('commentParams')||{},{nComments:d}))}if(d){this.down('#emptyText').hide()}else {this.down('#emptyText').show()}this.resumeLayouts(!0);return b.items.length?b.items.items[b.items.length-1]:null}},0,['comments'],['component','box','container','comments'],{'component':!0,'box':!0,'container':!0,'comments':!0},['widget.comments'],0,[comments.view.comments,'Comments'],0);Ext.cmd.derive('comments.view.comments.CommentsModel',Ext.app.ViewModel,{data:{project_CommentMentionsEnabled:!1,newCommentTextValue:''},formulas:{commentParams:function(b){var f=b('commentViewData.CommentType'),c=b('ProjectUID'),e=b('commentViewData.Identifier'),d=b('comments');if(!b('account.canRead')||!c){return null}var a=e?{Identifier:e}:null;if(a){if(isNaN(c)){a.ProjectUID=c}else {a.ProjectID=c}}if(a&&d){d.getProxy().setExtraParams(a)}return a},triggerLoadComments:function(b){var c=b('commentParams'),a=b('comments');if(c&&a&&!a.getModifiedRecords().length){this.getView().lookupController().loadComments()}},canWriteComments:function(a){return !!(a('account.canWrite')&&a('commentParams'))},mentionsEnabled:function(a){return !!(a('project_CommentMentionsEnabled')||a('project.commentMentionsEnabled'))},commentsCls:function(a){return a('mentionsEnabled')?'with-mentions':'no-mentions'}},stores:{comments:{model:'comments.model.CommentEntry',autoLoad:!1,sortOnLoad:!0,proxy:{type:'jsonp',api:{create:'/index.cfm?fuseaction=aComments.saveComments',read:'/index.cfm?fuseaction=aComments.getComments',update:'/index.cfm?fuseaction=aComments.saveComments',destroy:'/index.cfm?fuseaction=aComments.removeComments'},reader:{type:'json',rootProperty:'data'}},data:[]}}},0,0,0,0,['viewmodel.comments'],0,[comments.view.comments,'CommentsModel'],0);Ext.cmd.derive('viewerPhoto.model.Photo',Ext.data.Model,{fields:[{name:'storePosition',type:'int'},{name:'photoIndex',type:'int',convert:function(a,b){return a===undefined?b.get('storePosition'):a}},{name:'photoID',type:'int',defaultValue:0,mapping:'PhotoID'},{name:'hotspotID',type:'int',defaultValue:0},{name:'shootUID',type:'string',defaultValue:'00000000-0000-0000-0000-000000000000'},{name:'albumUID',type:'string',defaultValue:'00000000-0000-0000-0000-000000000000'},{name:'UDEFPhotoUID',type:'string',defaultValue:''},{name:'WebcamPhotoUID',type:'string',defaultValue:''},{name:'commentThreadID',type:'int',defaultValue:0},{name:'SphereImageID',type:'int',defaultValue:0},{name:'id',type:'string',calculate:function(a){if(a.UDEFPhotoUID.length!==0){return 'U'+a.UDEFPhotoUID}else {if(a.WebcamPhotoUID.length!==0){return 'W'+a.WebcamPhotoUID}else {if(a.Type=='B'){return 'B'+a.SphereImageID}else {return 'P'+a.photoID}}}}},{name:'isUDEF',type:'boolean',calculate:function(a){if(a.UDEFPhotoUID.length===0){return !1}else {return !0}}},{name:'isWebcam',type:'boolean',calculate:function(a){if(a.WebcamPhotoUID.length===0){return !1}else {return !0}}},{name:'name',type:'string',defaultValue:'',mapping:'Description'},{name:'floorplanDesc',type:'string',defaultValue:'',mapping:'Location'},{name:'dateTaken',mapping:'PhotoDate',type:'tzadate'},{name:'src',type:'string',mapping:'ImageURL'},{name:'med',type:'string',mapping:'ImageURLMedium'},{name:'tmb',type:'string',mapping:'ImageURLThumb'},{name:'floorplanUID',type:'string',defaultValue:'0'},{name:'floorplanImage',type:'string',defaultValue:''},{name:'floorplanImageW',type:'int',defaultValue:null},{name:'floorplanImageH',type:'int',defaultValue:null},{name:'floorplanOffsetLeft',type:'int',defaultValue:null},{name:'floorplanOffsetTop',type:'int',defaultValue:null},{name:'floorplanLabel',type:'string',defaultValue:null},{name:'commentCount',type:'int',defaultValue:'0',mapping:'CommentCount'},{name:'hasAnnotations',type:'int',defaultValue:'0',mapping:'HasAnnotations'},{name:'isFavorite',type:'boolean',convert:function(a){if(a>0){return !0}return !1}},{name:'WebcamUID',type:'string',defaultValue:''},{name:'Weather',type:'string',defaultValue:''},{name:'TemperatureF',type:'auto'},{name:'WindDirection',type:'string'},{name:'WindMPH',type:'auto'},{name:'altitude',type:'string'},{name:'latitude',type:'string'},{name:'longitude',type:'string'},{name:'IconName',type:'string',calculate:function(e){if(e.id.charAt(0)!='W'){return ''}var a=e.Weather,b;if(a.indexOf('Thunderstorm')!=-1){b='storm'}else {if(a.indexOf('Ice')!=-1||a.indexOf('Hail')!=-1){if(a.indexOf('Rain')!=-1||a.indexOf('Drizzle')!=-1){b='rainsnow'}else {b='hail'}}else {if(a.indexOf('Snow')!=-1){if(a.indexOf('Freezing')!=-1||a.indexOf('Rain')!=-1||a.indexOf('Drizzle')!=-1){b='rainsnow.png'}else {b='snow'}}else {if(a.indexOf('Dust')!=-1||a.indexOf('Sand')!=-1){b='dust'}else {if(a.indexOf('Windy')!=-1&&a.indexOf('Rain')==-1&&a.indexOf('Fog')==-1){b='clear_sunny'}else {if(a.indexOf('Cloudy')!=-1){b='part_cloud'}else {if(a.indexOf('Fair')!=-1||a.indexOf('Clear')!=-1||a.indexOf('Sunny')!=-1){b='clear_sunny'}else {if(a.indexOf('A Few Clouds')!=-1){b='part_cloud'}else {if(a.indexOf('Overcast')!=-1){b='overcast'}else {if(a.indexOf('Freezing')!=-1){if(a.indexOf('Fog')!=-1){b='fog'}var d=a.match(/Rain/g);d=d?d.length:0;var c=a.match(/Drizzle/g);c=c?c.length:0;if(d+c>1){b='rainsnow'}else {b='hail'}}else {if(a.indexOf('Showers')!=-1||a.indexOf('Light Rain')!=-1||a.indexOf('Drizzle')!=-1||a.indexOf('Rain')!=-1){b='rain'}else {if(a.indexOf('Fog')!=-1||a.indexOf('Haze')!=-1){b='fog'}else {b='overcast'}}}}}}}}}}}}var f=e.dateTaken.getHours();if((f<6||f>19)&&(b=='clear_sunny'||b=='part_cloud')){if(b=='clear_sunny'){b='clear_night'}else {if(b=='part_cloud'){b='part_cloud_night'}}}return b+'.png'}},{name:'isSelected',type:'boolean',defaultValue:!1},{name:'tmbSelected',type:'boolean',defaultValue:!1},{name:'mdslink_clientFloorplanViewer'},{name:'DescLine1',type:'string',defaultValue:'',mapping:'name'},{name:'DescLine2',type:'string',defaultValue:'',mapping:'floorplanDesc'},{name:'DescLine3',convert:function(e,c){var a=c.get('photoIndex'),d=c.get('dateTaken'),b=Ext.Date.format(d,'M d Y');return a?b+=' - Photo '+a:b}},{name:'FileSize',type:'int',defaultValue:0},{name:'Type',defaultValue:'P'},{name:'ImageURLMedium',type:'string',mapping:'med'},{name:'Identifier',type:'int',mapping:'photoID'},{name:'PhotoDate',type:'tzadate',mapping:'dateTaken'},{name:'ImageURLThumb',type:'string',mapping:'med'},{name:'is360Pano',type:'boolean',defaultValue:!1},{name:'isInteriorPano',type:'boolean',defaultValue:!1},{name:'CanSnapshot',type:'boolean',calculate:function(a){return a.is360Pano||a.isInteriorPano}}]},0,0,0,0,0,0,[viewerPhoto.model,'Photo'],0);Ext.cmd.derive('floorplanList.PlanUtil',Ext.Base,{singleton:!0,pinPointToLayer:function(a,f){var b=a.properties.PushpinType,e=mdsData.FloorplanValues.DEFAULT_ICON_SIZE,c=a.properties.PunchItemID?mdsData.FloorplanValues.PUNCHPIN_ICON_ANCHOR:mdsData.FloorplanValues.DEFAULT_ICON_ANCHOR;if(mdsData.FloorplanValues.ICON_ANCHORS[b]){c=mdsData.FloorplanValues.ICON_ANCHORS[b]}var d=MVLeaflet.divIcon({html:mdsData.FloorplanValues.iconTemplate.apply(floorplanList.PlanUtil.getPinValuesFromFeature(a)),iconSize:e,iconAnchor:c});return MVLeaflet.marker(f,{icon:d})},getPinValuesFromFeature:function(a){var b=mdsData.FloorplanValues.DEFAULT_ICON_SIZE;return {PushpinSymbol:a.properties.PushpinSymbol,TextOverlay:a.properties.TextOverlay?a.properties.TextOverlay:'',width:b[0],height:b[1],cls:a.properties.PunchItemID?'punchpin':'pushpin'}},filterPushpinData:function(b,d){var c=[];for(var a=0;a<b.features.length;a++){if(!!b.features[a].properties.PunchItemID!=d){c.push(b.features[a])}}for(var a=0;a<c.length;a++){Ext.Array.remove(b.features,c[a])}},pinToFeature:function(a){return {properties:a.getData(),id:a.getId(),type:'Feature',geometry:{coordinates:[a.get('PushpinXCoordinate'),a.get('PushpinYCoordinate')],type:'Point'}}},pinsToFeatures:function(b){var d=b.getCount(),c=[];for(var a=0;a<d;a++){c.push(floorplanList.PlanUtil.pinToFeature(b.getAt(a)))}return {type:'FeatureCollection',features:c}}},0,0,0,0,0,0,[floorplanList,'PlanUtil'],0);Ext.cmd.derive('floorplanList.store.Floorplans',Ext.data.Store,{model:'mdsData.model.Floorplan',proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'index.cfm?fuseaction=aClientFloorplanOverview.getFloorplans'}},0,0,0,0,['store.floorplans'],0,[floorplanList.store,'Floorplans'],0);Ext.cmd.derive('floorplanList.view.FloorplanList',Ext.view.View,{cls:'floorplan-list'},0,['floorplanlist'],['component','box','dataview','floorplanlist'],{'component':!0,'box':!0,'dataview':!0,'floorplanlist':!0},['widget.floorplanlist'],0,[floorplanList.view,'FloorplanList'],0);Ext.cmd.derive('floorplanList.view.FloorplanOverview',floorplanList.view.FloorplanList,{bind:{store:'{floorplans}',emptyText:'{listEmptyText}'},itemSelector:'.floorplanCover',groupTpl:'<div class="title mds-light-bg-list-header">{ProjectShootTypeLabel}</div>',groupField:'ProjectShootTypeLabel',noLink:!1,initComponent:function(){this.tpl=['<tpl for=".">','<div class="floorplanCover">',this.noLink?'':'<a href="{BaseURL}ProjectUID={ProjectUID}&FloorplanUID={FloorplanUID}&ListTypeID={ListTypeID}">','<img id="F-{FloorplanUID}" class="floorplanCoverImage" src="{ImageURL}">','<div class="floorplanCoverLabel"><span>{FloorplanDescription}</span></div>','<div class="floorplan-badges">','<tpl if="CommentCount &gt; 0">',"<span class=\"badge-icon comment\" onclick=\"function isCommentIconClicked() { analytics.Ctrl.log('Clicked Activity Callout', { 'Floorplan Name': '{FloorplanDescription}', 'Callout Type': 'Comment'  }); }; isCommentIconClicked();\">",'<img src="mds/image/icon/comment.png"></span>','<span class="badge-label">{CommentCount}</span>','</tpl>','<tpl if="PushpinCount &gt; 0">',"<div class=\"badge-icon pushpin\" onclick=\"function isPushpinIconClicked() { analytics.Ctrl.log('Clicked Activity Callout', { 'Floorplan Name': '{FloorplanDescription}', 'Callout Type': 'Pushpin'  }); }; isPushpinIconClicked();\">",'<img src="mds/module/clientFileManager/image/pin_green.png"></div>','<span class="badge-label">{PushpinCount}</span>','</tpl>','</div>',this.noLink?'':'</a>','<tpl if="PunchlistPlanUID">','<tpl if="Pins.length">','<div class="floorplanCoverLabel punch-item">','<tpl for="Pins">','<div class="punchpin {Cls}"><img src="{PushpinSymbol}"><span>{Count}</span></div>','</tpl>','</div>','</tpl>','</tpl>','<script>function isCommentIconClicked() { console.log("inside isCommentIconClicked"); }</script>','</div>','</tpl>'];floorplanList.view.FloorplanList.prototype.initComponent.apply(this,arguments)},listeners:{itemclick:function(f,a,e,d,c,b){analytics.Ctrl.log('Clicked Floorplan',{'Floorplan Name':a.data.FloorplanDescription,'Floorplan UID':a.data.FloorplanUID})}}},0,['floorplanoverview'],['component','box','dataview','floorplanlist','floorplanoverview'],{'component':!0,'box':!0,'dataview':!0,'floorplanlist':!0,'floorplanoverview':!0},['widget.floorplanoverview'],0,[floorplanList.view,'FloorplanOverview'],0);Ext.cmd.derive('multiupload.UploadManager',Ext.util.MixedCollection,{singleton:!0,register:function(a){this.add(a)},unregister:function(a){this.remove(a)},getKey:function(a){return a.instanceId},uploadCallback:function(c,b){var a=this.get(c);if(a){switch(b.event){case 'fileAdded':a.fireEvent('fileadded',a,b);break;case 'fileOpen':a.fireEvent('uploadstart',a,b);break;case 'uploadProgress':a.fireEvent('uploadprogress',a,b);break;case 'uploadComplete':a.fireEvent('uploadcomplete',a,b);break;case 'uploadCompleteData':a.fireEvent('uploaddatacomplete',a,b);break;case 'queueUploadComplete':a.fireEvent('queuecomplete',a,b);break;case 'queueUploadDataComplete':a.fireEvent('queuedatacomplete',a,b);break;case 'uploadError':a.fireEvent('uploaderror',a,b);break;}}}},0,0,0,0,0,0,[multiupload,'UploadManager'],0);Ext.cmd.derive('multiupload.Upload',Ext.flash.Component,{width:101,height:22,wmode:'transparent',url:'/mds/sencha/ux/multiupload/Upload.swf',statics:{instanceId:0},constructor:function(a){a=a||{};a.instanceId=Ext.String.format('upload-{0}',++multiupload.Upload.instanceId);a.flashVars=a.flashVars||{};a.flashVars=Ext.apply({instanceId:a.instanceId,buttonImagePath:'/mds/image/multiupload/button.png',buttonImageHoverPath:'/mds/image/multiupload/button.png',fileFilters:'Images (*.jpg)|*.jpg',uploadUrl:'/upload/url',maxFileSize:0,maxQueueLength:0,maxQueueSize:0,callback:'multiupload.UploadManager.uploadCallback'},a.uploadConfig);Ext.flash.Component.prototype.constructor.call(this,a)},initComponent:function(){multiupload.UploadManager.register(this);Ext.flash.Component.prototype.initComponent.apply(this,arguments)},onDestroy:function(){multiupload.UploadManager.unregister(this);Ext.flash.Component.prototype.onDestroy.apply(this,arguments)}},1,['uploader'],['component','box','flash','uploader'],{'component':!0,'box':!0,'flash':!0,'uploader':!0},['widget.uploader'],0,[multiupload,'Upload'],0);Ext.cmd.derive('multiupload.Panel',Ext.panel.Panel,{statics:{doUploaderCheck:function(b,a){if(Dropzone.isBrowserSupported()){b.call(a)}else {Ext.Loader.loadScript({url:'mds/lib/swfobject.js',onLoad:b,scope:a})}}},layout:'fit',initComponent:function(){var a=this;if(Dropzone.isBrowserSupported()){var e=mvstr['FVCFD_Drop files here'];if(this.uploadConfig.hasOwnProperty('uploadMessage')){e=this.uploadConfig.uploadMessage}var b=!1;if(this.uploadConfig.hasOwnProperty('hideShareButton')&&this.uploadConfig.hideShareButton){b=this.uploadConfig.hideShareButton}var d=mvstr['FVCFD_Add files'];if(this.uploadConfig.hasOwnProperty('addFilesLabel')){d=this.uploadConfig.addFilesLabel}var c=mvstr['FVCFD_Clear files'];if(this.uploadConfig.hasOwnProperty('clearFilesLabel')){c=this.uploadConfig.clearFilesLabel}a.tbar=[{xtype:'button',text:d,itemId:'dropzoneAddFilesBtn',icon:'mds/module/clientFileManager/image/icons/folder_new.png',cls:'dz-clickable'},{xtype:'button',text:c,itemId:'dropzoneClearFilesBtn',icon:'mds/module/clientFileManager/image/icons/delete.png',hidden:!0},'->',{xtype:'shareWithButton',reference:'uploadShareButton',itemId:'fileUploadShareWithButton',ownerUID:'multiupload',hidden:b}];a.items=[{xtype:'component',itemId:'dropzoneUploadComponent',bodyPadding:20,cls:'dropzone dz-clickable dropzone-previews',autoScroll:!0,html:'<div class="dz-message"><span>'+e+'</span></div>'}]}else {a.tbar=[{xtype:'uploader',uploadConfig:this.uploadConfig,listeners:{'fileadded':function(c,b){a.child('#flashUploadPanel').store.add({id:b.fileIndex,name:b.fileName,size:b.fileSize,status:'waiting...',progress:0})},'uploadstart':function(e,c){var d=a.child('#flashUploadPanel');var b=d.store.getById(c.fileIndex);if(b){b.set('status','uploading...')}},'uploadprogress':function(f,b){var d=a.child('#flashUploadPanel');var c=d.store.getById(b.fileIndex);if(c){var e=Math.min(Math.round(b.fileProgress/b.fileSize*100),100);c.set('progress',e)}},'uploaddatacomplete':function(e,b){var d=a.child('#flashUploadPanel');var c=d.store.getById(b.fileIndex);if(c){c.set('status','completed')}a.fireEvent('fileuploadcomplete',b.data);a.fireEvent('fileUploadedAndAccepted',b.data)},'queuedatacomplete':function(b,a){Ext.Msg.show({title:'Complete',msg:'Upload queue complete. '+a.files+' file(s) uploaded.',buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},'uploaderror':function(c,a){var b='ErrorType: '+a.errorType;switch(a.errorType){case 'FileSize':b='This file is too big: '+Ext.util.Format.fileSize(a.fileSize)+'. The maximum upload size is '+Ext.util.Format.fileSize(a.maxFileSize)+'.';break;case 'QueueLength':b='The maximum number of photos which can be uploaded in a single batch is '+a.maxQueueLength+'. Please select fewer photos and try again.';break;}Ext.Msg.show({title:'Upload Error',msg:b,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}}},'->',{xtype:'shareWithButton',itemId:'fileUploadShareWithButton',ownerUID:'multiupload',hidden:b}];a.items=[{xtype:'grid',itemId:'flashUploadPanel',viewConfig:{markDirty:!1,selectedItemCls:''},store:{fields:['id','name','size','status','progress']},columns:[{header:'Name',dataIndex:'name',width:200},{header:'Size',dataIndex:'size',renderer:Ext.util.Format.fileSize,flex:2},{header:'Status',dataIndex:'status',flex:2},{header:'Progress',dataIndex:'progress',renderer:function(a){return a+'%'},flex:2}]}]}Ext.panel.Panel.prototype.initComponent.apply(this,arguments)},listeners:{render:function(){var e=this;if(!Dropzone.isBrowserSupported()){return}var i=this.uploadConfig.dropzoneUploadUrl;var g=this.uploadConfig.acceptedFiles;var h=Math.round(this.uploadConfig.maxFileSize/1048576);var d=this.uploadConfig.maxQueueLength;var f={};if(this.uploadConfig.hasOwnProperty('uploadParams')){f=this.uploadConfig.uploadParams}var j=this.child('#dropzoneUploadComponent');var b={doc:'doc',docx:'doc',xls:'xls',xlsx:'xls',ppt:'ppt',pptx:'ppt',mp4:'mp4',avi:'avi',mpg:'mpg',pdf:'pdf',zip:'zip',tar:'zip',gz:'zip',gif:'gif',png:'png',jpg:'jpg',jpeg:'jpg',tif:'tiff',tiff:'tiff',dwg:'dwg',dwf:'dwf',dxf:'dxf',rvt:'rvt',ifc:'ifc'};var a=new Dropzone('#'+j.id,{url:i,maxFilesize:h,maxFiles:d,paramName:'Filedata',thumbnailHeight:128,thumbnailWidth:128,parallelUploads:10,timeout:this.uploadConfig.timeout||600000,clickable:'.dz-clickable',acceptedFiles:g,uploadMultiple:!1,createImageThumbnails:!0,autoProcessQueue:!0,dictFileTooBig:'This file is too big ({{filesize}}MB). The max filesize is {{maxFilesize}}MB.',dictResponseError:'There was an error uploading the file (status code {{statusCode}})',previewTemplate:'<div class="dz-preview dz-file-preview"><div class="dz-image"><img data-dz-thumbnail /></div><div class="dz-filetype none"></div><div class="dz-details"><div class="dz-size"><span data-dz-size></span></div><div class="dz-filename"><span data-dz-name></span></div></div><div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div><div class="dz-error-message"><span data-dz-errormessage></span></div><div class="dz-success-mark"><svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg"><title>Check</title><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M23.5,31.8431458 L17.5852419,25.9283877 C16.0248253,24.3679711 13.4910294,24.366835 11.9289322,25.9289322 C10.3700136,27.4878508 10.3665912,30.0234455 11.9283877,31.5852419 L20.4147581,40.0716123 C20.5133999,40.1702541 20.6159315,40.2626649 20.7218615,40.3488435 C22.2835669,41.8725651 24.794234,41.8626202 26.3461564,40.3106978 L43.3106978,23.3461564 C44.8771021,21.7797521 44.8758057,19.2483887 43.3137085,17.6862915 C41.7547899,16.1273729 39.2176035,16.1255422 37.6538436,17.6893022 L23.5,31.8431458 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z" stroke-opacity="0.2" stroke="#747474" fill-opacity="0.7" fill="#26BE26"></path></g></svg></div><div class="dz-error-mark"><svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg"><title>Error</title><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g stroke="#747474" stroke-opacity="0.2" fill="#BE2626" fill-opacity="0.7"><path d="M32.6568542,29 L38.3106978,23.3461564 C39.8771021,21.7797521 39.8758057,19.2483887 38.3137085,17.6862915 C36.7547899,16.1273729 34.2176035,16.1255422 32.6538436,17.6893022 L27,23.3431458 L21.3461564,17.6893022 C19.7823965,16.1255422 17.2452101,16.1273729 15.6862915,17.6862915 C14.1241943,19.2483887 14.1228979,21.7797521 15.6893022,23.3461564 L21.3431458,29 L15.6893022,34.6538436 C14.1228979,36.2202479 14.1241943,38.7516113 15.6862915,40.3137085 C17.2452101,41.8726271 19.7823965,41.8744578 21.3461564,40.3106978 L27,34.6568542 L32.6538436,40.3106978 C34.2176035,41.8744578 36.7547899,41.8726271 38.3137085,40.3137085 C39.8758057,38.7516113 39.8771021,36.2202479 38.3106978,34.6538436 L32.6568542,29 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z"></path></g></g></svg></div></div>',storageUsed:this.uploadConfig.storageUsed,storageQuota:this.uploadConfig.storageQuota});var c=this.down('#dropzoneClearFilesBtn');c.on('click',function(){a.removeAllFiles();c.setHidden(!0);e.fireEvent('clearfiles')});a.on('addedfile',function(a){c.setHidden(!1);if(this.options.storageQuota!==undefined&&this.options.storageUsed+a.size>this.options.storageQuota){this.emit('error',a,'Insufficient storage space');this.options.autoQueue=!1;return}this.options.autoQueue=!0;var f=a.name.lastIndexOf('.');if(f!=-1){var e=a.name.substr(f+1).toLowerCase();console.log('File ext: '+e+', '+b.hasOwnProperty(e));if(b.hasOwnProperty(e)){var d=a.previewElement.querySelectorAll('.dz-filetype');if(d.length==1){d[0].classList.remove('none');d[0].classList.add(b[e])}else {console.log('File types: '+d.length)}}}});a.on('uploadprogress',function(c,b,a){});a.on('sending',function(d,g,c){var a=Ext.apply({},f);e.fireEvent('addUploadFormData',a,d);for(var b in a){c.append(b,a[b])}});a.on('success',function(c,b){var d=!0;if(b){d=b.success}if(d){e.fireEvent('fileUploadedAndAccepted',b.data);this.options.storageUsed+=c.size}else {console.log('Upload failed: '+b.message);c.status=Dropzone.ERROR;c.previewElement.classList.remove('dz-success');a.emit('error',c,b.message,{})}});a.on('error',function(a,b,e){console.log('Error uploading file '+a.name+': '+b);if(b.length>100){b='There was an error uploading the file.'}if(a.previewElement){a.previewElement.classList.remove('dz-success');a.previewElement.classList.add('dz-error');var d=a.previewElement.querySelectorAll('[data-dz-errormessage]');for(var c=0;c<d.length;c++){d[c].textContent=b}}});a.handleFiles=function(a){if(a.length>d){Ext.Msg.show({title:'Upload Error',icon:Ext.Msg.ERROR,buttons:Ext.Msg.OK,message:'The maximum number of files which can be uploaded in a single batch is '+d+'.<br>Please select fewer files and try again.'})}else {Dropzone.prototype.handleFiles.call(this,a)}};a.addFile=function(a){if(a.size==0){var b='Uploading folders is not supported.';if(a.type){b='The file "'+a.name+'" is empty.'}Ext.Msg.show({title:'Upload Error',icon:Ext.Msg.ERROR,buttons:Ext.Msg.OK,message:b})}else {Dropzone.prototype.addFile.call(this,a)}}},'fileUploadedAndAccepted':function(a){this.fireEvent('fileUploadCompleted',a)}}},0,['uploadPanel'],['component','box','container','panel','uploadPanel'],{'component':!0,'box':!0,'container':!0,'panel':!0,'uploadPanel':!0},['widget.uploadPanel'],0,[multiupload,'Panel'],0);Ext.cmd.derive('filters.view.Filters',Ext.view.View,{itemSelector:'div.filter',margin:'0 1 0 1',padding:'0 0 15 0',cls:'filters',config:{filterValueName:'FilterValue',filterLabelName:'FilterValue'},initComponent:function(){this.tpl=new Ext.XTemplate('<tpl for=".">','<div class="filter"><input type="checkbox" <tpl if="isSelected">checked</tpl> onclick="return false;"><div class="filter-name">{'+this.filterLabelName+'}</div></div>','</tpl>');Ext.view.View.prototype.initComponent.apply(this,arguments)},clearSelected:function(){this.getStore().each(function(a){a.set('isSelected',!1)})},listeners:{itemclick:function(c,a,b){a.set('isSelected',!a.get('isSelected'));if(a.get('isSelected')){Ext.fly(b).addCls('selected')}else {Ext.fly(b).removeCls('selected')}}}},0,['filter'],['component','box','dataview','filter'],{'component':!0,'box':!0,'dataview':!0,'filter':!0},['widget.filter'],0,[filters.view,'Filters'],0);Ext.cmd.derive('filters.view.FiltersPane',Ext.Container,{cls:'filters-pane',padding:'40 10 0 10',width:224},0,0,['component','box','container'],{'component':!0,'box':!0,'container':!0},0,0,[filters.view,'FiltersPane'],0);Ext.cmd.derive('clientPunchlist.model.Assignee',Ext.data.Model,{fields:[{name:'PunchlistCustomAssigneeID',type:'int'},{name:'AssigneeFirstName',type:'string'},{name:'AssigneeLastName',type:'string'},{name:'AssigneeEmail',type:'string'},{name:'MemberUID',type:'string'},{name:'IsDefault',type:'int'},{name:'IsOwner',type:'int',defaultValue:0},{name:'NoAccess',type:'boolean'},{name:'FilterValue',mapping:function(a){return Ext.String.trim(a.AssigneeFirstName+' '+a.AssigneeLastName)}},{name:'AssigneeID',type:'string'},{name:'Assignee',type:'string',calculate:function(a){return Ext.String.trim(a.AssigneeFirstName+' '+a.AssigneeLastName)}},{name:'IsAssignee',type:'boolean',defaultValue:'false'},{name:'InUse',type:'boolean',defaultValue:!1},{name:'CanDelete',type:'boolean',calculate:function(a){return a.IsOwner&&!a.InUse}}],idProperty:'AssigneeID',clientIdProperty:'AssigneeID'},0,0,0,0,0,0,[clientPunchlist.model,'Assignee'],0);Ext.cmd.derive('clientPunchlist.values.FixMemberAccess',Ext.Base,{singleton:!0,activeUserNoAccessTitle:"You don't have permissions to access this {ListTypeName}",activeUserNoAccessExplanation1:'You do not currently have permission to access this task list. You are still assigned the task but unable to access it.',activeUserNoAccessExplanation2:'Contact your Multivista Project Implementation Specialist or send a request to Multivista support to change these permissions.',activeUserNoAccessPostTitle:'Your request has been sent!',activeUserNoAccessPostExplanation:'Your permissions request has been sent and you should be able to access your {listTypeDesc} shortly. You will be notified when your permissions have been changed.',otherUserNoAccessTitleLong:'Request Permissions Change for {MemberName}',otherUserNoAccessTitleShort:'Request Permissions Change',otherUserNoAccessExplanation1:'This user does not currently have permission to access this task list. You can assign the task to them and they will be notified of the assignment but unable to access it.',otherUserNoAccessExplanation2:'You can click here to send a request to Multivista support to change these permissions',otherUserNoAccessPostTitle:'Your Request has been Sent',otherUserNoAccessPostExplanation:'A request has been sent to Multivista Support to change the permissions for this user. Return to the list item by clicking the done button below.'},0,0,0,0,0,0,[clientPunchlist.values,'FixMemberAccess'],0);Ext.cmd.derive('clientPunchlist.view.fixMemberAccess.WindowController',Ext.app.ViewController,{closeWindow:function(){this.getView().destroy()},sendRequest:function(){this.getViewModel().set('maskMessage',mvstr['TLNA_Sending Request...']);Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.requestPermissions',params:{ProjectUID:this.getViewModel().get('ProjectUID'),MemberUID:this.getViewModel().get('MemberUID')},successCallback:function(){this.getViewModel().set('step',1);this.getViewModel().set('maskMessage','')},failure:function(){this.getViewModel().set('maskMessage','')},scope:this})}},0,0,0,0,['controller.fixmemberaccesswindow'],0,[clientPunchlist.view.fixMemberAccess,'WindowController'],0);Ext.cmd.derive('clientPunchlist.view.fixMemberAccess.WindowModel',Ext.app.ViewModel,{data:{step:0,maskMessage:''}},0,0,0,0,['viewmodel.fixmemberaccesswindow'],0,[clientPunchlist.view.fixMemberAccess,'WindowModel'],0);Ext.cmd.derive('clientPunchlist.model.Base',Ext.data.Model,{schema:{id:'clientPunchlist',namespace:'clientPunchlist.model'}},0,0,0,0,0,0,[clientPunchlist.model,'Base'],0);Ext.cmd.derive('clientPunchlist.model.Follower',Ext.data.Model,{idProperty:'MemberUID',fields:[{name:'MemberUID',type:'string'},{name:'IsCreator',type:'boolean',persist:!1},{name:'IsSubscriber',type:'boolean',persist:!0},{name:'IsAssignee',type:'boolean',persist:!1},{name:'IsFollower',type:'boolean',calculate:function(a){return !!(a.IsCreator||a.IsSubscriber||a.IsAssignee)}},{name:'NoAccess',type:'boolean'},{name:'MemberFirstName',type:'string',persist:!1},{name:'MemberLastName',type:'string',persist:!1},{name:'MemberName',type:'string',persist:!1,calculate:function(a){return Ext.String.trim((a.MemberFirstName?a.MemberFirstName:'')+' '+(a.MemberLastName?a.MemberLastName:''))}}]},0,0,0,0,0,0,[clientPunchlist.model,'Follower'],0);Ext.cmd.derive('clientPunchlist.model.PunchItem',clientPunchlist.model.Base,{fields:[{name:'ProjectUID',type:'string'},{name:'PunchStatusID',type:'int',defaultValue:mdsData.PunchlistValues.PUNCH_STATUS.OPEN},{name:'PunchStatusLabel',persist:!1,calculate:function(a){return mvstr['TLIS_'+a.PunchStatusID]}},{name:'WorkStatusID',type:'int',persist:!0,defaultValue:mdsData.PunchlistValues.WORK_STATUS.NOT_STARTED},{name:'WorkStatusLabel',persist:!1,calculate:function(a){return mvstr['TLWS_'+a.WorkStatusID]}},{name:'PunchlistCategoryID',type:'int'},{name:'CategoryLabel',type:'string',persist:!1,depends:'PunchlistCategoryID',convert:function(c,b){var a='TLC_'+b.get('PunchlistCategoryID');return mvstr[a]||c}},{name:'Description',type:'string'},{name:'LocationDetail',type:'string'},{name:'DueDate',type:'date',dateFormat:'Y-m-d'},{name:'ExternalIDString',type:'string'},{name:'ShareTypeID',type:'int'},{name:'PunchPinCount',type:'int'},{name:'PunchPins'},{name:'PunchlistPlans',persist:!1},{name:'CreatorName',type:'string',persist:!1,mapping:function(a){return Ext.String.trim(a.CreatorFirstName+' '+a.CreatorLastName)}},{name:'CompletionDate',type:'date',persist:!1},{name:'DocumentCount'},{name:'PhotoCount'},{name:'CreationDate',type:'date',persist:!1},{name:'LastEditorFirstName'},{name:'LastEditorLastName'},{name:'LastEditorName',persist:!1,mapping:function(a){return Ext.String.trim(a.LastEditorFirstName+' '+a.LastEditorLastName)}},{name:'LastEditedDate',type:'date',persist:!1},{name:'ListTypeID'},{name:'CategoryAbbreviation',type:'string'},{name:'CategoryAbbreviationOrCategory',type:'string',calculate:function(a){return a.CategoryAbbreviation?a.CategoryAbbreviation:a.CategoryLabel}},{name:'IsOwner',type:'boolean'},{name:'IsAssignee',type:'boolean'},{name:'IsSubscriber',type:'boolean'},{name:'IsFollower',calculate:function(a){return a.IsOwner||a.IsAssignee||a.IsSubscriber}},{name:'DueDateDescription',calculate:function(a){var e=new Date(),d=a.DueDate,c=a.PunchStatusID;if(!mdsData.PunchlistValues.isOverdue({DueDate:d,PunchStatusID:c})){return Ext.Date.format(a.DueDate,'M j, Y')}var b=Ext.Date.diff(a.DueDate,e,Ext.Date.DAY);return b+' Day'+(b==1?'':'s')+' OVERDUE'}},{name:'PlanList',calculate:function(e){var a=e.PunchlistPlans,c=[];if(!a){return ''}for(var b=0;b<a.length;b++){var d=a[b].PunchlistPlanDescription;if(d){c.push(d)}}return c.join(', ')}},{name:'PunchlistPlanUIDs',persist:!0,calculate:function(a){var b=[];if(!a.PunchlistPlans){return b}for(var c=0;c<a.PunchlistPlans.length;c++){b.push(a.PunchlistPlans[c].PunchlistPlanUID)}return b}},{name:'PushpinSymbol',persist:!1,calculate:function(a){var c=a.PunchStatusID,b=a.WorkStatusID;if(c==mdsData.PunchlistValues.PUNCH_STATUS.CLOSED){return 'mds/image/clientFloorplanViewer/punchpin-5.png'}else {if(mdsData.PunchlistValues.isOverdue({DueDate:a.DueDate,PunchStatusID:a.PunchStatusID})){return 'mds/image/clientFloorplanViewer/punchpin-6.png'}if(b==mdsData.PunchlistValues.WORK_STATUS.NOT_STARTED){return 'mds/image/clientFloorplanViewer/punchpin-1.png'}else {if(b==mdsData.PunchlistValues.WORK_STATUS.IN_PROGRESS){return 'mds/image/clientFloorplanViewer/punchpin-2.png'}else {if(b==mdsData.PunchlistValues.WORK_STATUS.COMPLETE){return 'mds/image/clientFloorplanViewer/punchpin-3.png'}else {return 'mds/image/clientFloorplanViewer/punchpin-4.png'}}}}}},{name:'Assignees',persist:!0,defaultValue:[]},{name:'AssigneeList',type:'string',persist:!1,calculate:function(d){var b=d.Assignees,c=[];for(var a=0;a<b.length;a++){c.push(Ext.String.trim(b[a].AssigneeFirstName+' '+b[a].AssigneeLastName))}return c.join(', ')}},{name:'PrevPunchItemID',type:'int'},{name:'NextPunchItemID',type:'int'},{name:'CommentCount',persist:!1}],idProperty:'PunchItemID',clientIdProperty:'id',proxy:{type:'ajax',writer:{type:'json',writeAllFields:!1},reader:{type:'json',rootProperty:'data'},api:{read:'/index.cfm?fuseaction=aClientPunchlist.getProjectPunchItems',create:'/index.cfm?fuseaction=aClientPunchlist.createPunchItem',update:'/index.cfm?fuseaction=aClientPunchlist.updatePunchItem'}},validators:{PunchlistCategoryID:{type:'range',min:1},Description:{type:'presence'}}},0,0,0,0,0,0,[clientPunchlist.model,'PunchItem'],0);Ext.cmd.derive('clientPunchlist.model.PunchStatus',Ext.data.Model,{fields:['PunchStatusID','Label',{name:'FilterValue',calculate:function(a){return a.Label}}]},0,0,0,0,0,0,[clientPunchlist.model,'PunchStatus'],0);Ext.cmd.derive('clientPunchlist.model.PunchlistCategory',Ext.data.Model,{fields:[{name:'PunchlistCategoryID',type:'int'},{name:'CategoryLabel',type:'string',convert:function(c,b){var a='TLC_'+b.get('PunchlistCategoryID');return mvstr[a]||c}},{name:'CategoryAbbreviation',type:'string'},{name:'InUse',type:'boolean'}],idProperty:'PunchlistCategoryID',clientIdProperty:'id'},0,0,0,0,0,0,[clientPunchlist.model,'PunchlistCategory'],0);Ext.cmd.derive('clientPunchlist.model.WorkStatus',Ext.data.Model,{fields:['WorkStatusID','Label',{name:'FilterValue',calculate:function(a){return a.Label}}]},0,0,0,0,0,0,[clientPunchlist.model,'WorkStatus'],0);Ext.cmd.derive('clientPunchlist.store.PunchItems',Ext.data.Store,{model:'clientPunchlist.model.PunchItem',proxy:{url:'/index.cfm?fuseaction=aClientPunchlist.getProjectPunchItems'}},0,0,0,0,['store.punchitems'],0,[clientPunchlist.store,'PunchItems'],0);Ext.cmd.derive('clientPunchlist.store.PunchStatus',Ext.data.Store,{proxy:{type:'memory'},constructor:function(){this.config.data=[{PunchStatusID:mdsData.PunchlistValues.PUNCH_STATUS.OPEN,Label:mvstr['TLIS_'+mdsData.PunchlistValues.PUNCH_STATUS.OPEN]},{PunchStatusID:mdsData.PunchlistValues.PUNCH_STATUS.CLOSED,Label:mvstr['TLIS_'+mdsData.PunchlistValues.PUNCH_STATUS.CLOSED]},{PunchStatusID:mdsData.PunchlistValues.PUNCH_STATUS.ON_HOLD,Label:mvstr['TLIS_'+mdsData.PunchlistValues.PUNCH_STATUS.ON_HOLD]}];Ext.data.Store.prototype.constructor.apply(this,arguments)}},1,0,0,0,['store.punchstatus'],0,[clientPunchlist.store,'PunchStatus'],0);Ext.cmd.derive('clientPunchlist.store.WorkStatus',Ext.data.Store,{proxy:{type:'memory'},constructor:function(){this.config.data=[{WorkStatusID:mdsData.PunchlistValues.WORK_STATUS.ON_HOLD,Label:mvstr['TLWS_'+mdsData.PunchlistValues.WORK_STATUS.ON_HOLD]},{WorkStatusID:mdsData.PunchlistValues.WORK_STATUS.NOT_STARTED,Label:mvstr['TLWS_'+mdsData.PunchlistValues.WORK_STATUS.NOT_STARTED]},{WorkStatusID:mdsData.PunchlistValues.WORK_STATUS.IN_PROGRESS,Label:mvstr['TLWS_'+mdsData.PunchlistValues.WORK_STATUS.IN_PROGRESS]},{WorkStatusID:mdsData.PunchlistValues.WORK_STATUS.COMPLETE,Label:mvstr['TLWS_'+mdsData.PunchlistValues.WORK_STATUS.COMPLETE]}];Ext.data.Store.prototype.constructor.apply(this,arguments)}},1,0,0,0,['store.workstatus'],0,[clientPunchlist.store,'WorkStatus'],0);Ext.cmd.derive('clientPunchlist.view.CloneConfirmationWindow',Ext.window.Window,{height:300,width:390,title:'Duplicate Confirmation',modal:!0,resizable:!1,layout:{type:'vbox',align:'center'},defaults:{width:'100%'},config:{saveArgs:[]},items:[{xtype:'label',flex:2,padding:20,text:'Would you like to include the photos, pins, and files in the duplicated item about to be created?'},{xtype:'fieldcontainer',labelAlign:'top',flex:3,margin:'20 60 0 60',fieldLabel:'Include',layout:{type:'hbox',pack:'center'},defaults:{xtype:'checkbox',ui:'plain-21',flex:1},items:[{boxLabel:'Photos',itemId:'includePhotos',bind:{value:{bindTo:'{tasklistSetting_includePhotos}',single:!0}}},{boxLabel:'Pins',itemId:'includePins',bind:{value:{bindTo:'{tasklistSetting_includePins}',single:!0}}},{boxLabel:'Files',itemId:'includeFiles',bind:{value:{bindTo:'{tasklistSetting_includeFiles}',single:!0}}}]}],fbar:['->',{xtype:'button',scale:'medium',ui:'grey',text:'Cancel',margin:'0 20 0 0',handler:function(a){a.up('cloneConfirmationWindow').close()}},{xtype:'button',scale:'medium',ui:'green',text:'Duplicate',listeners:{click:'onCloneConfirm'}},'->']},0,['cloneConfirmationWindow'],['component','box','container','panel','window','cloneConfirmationWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'cloneConfirmationWindow':!0},['widget.cloneConfirmationWindow'],0,[clientPunchlist.view,'CloneConfirmationWindow'],0);Ext.cmd.derive('clientPunchlist.view.ItemActionMenu',Ext.menu.Menu,{plain:!0,items:[{text:'Print',hidden:!0,bind:{hidden:'{unsaved}'},handler:'printPunchItem'},{text:'Delete',hidden:!0,bind:{hidden:'{!editingOwnExisting}'},handler:'deletePunchItem'},{localized:{text:'TL_Follow list'},hidden:!0,bind:{hidden:'{!followControlsVisible}'},handler:'showFollowers'}]},0,['itemActionMenu'],['component','box','container','panel','menu','itemActionMenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'itemActionMenu':!0},['widget.itemActionMenu'],0,[clientPunchlist.view,'ItemActionMenu'],0);Ext.cmd.derive('clientPunchlist.view.PunchItemFilters',filters.view.FiltersPane,{reference:'punchItemFilters',layout:{type:'vbox',align:'stretch'},width:203,items:[{xtype:'container',layout:{type:'hbox'},items:[{xtype:'component',localized:{html:'TLLFP_Filters'},cls:'title'},{xtype:'component',flex:1},{xtype:'component',reference:'clearFilters',cls:'clear',localized:{html:'TLLFP_Clear All'},listeners:{click:'onClearFiltersClick',element:'el'}}]},{xtype:'container',cls:'filters-pane-inner',layout:{type:'vbox',align:'stretch'},scrollable:{x:!1,y:'auto'},items:[{xtype:'component',cls:'title',localized:{html:'TLLFP_Category'}},{xtype:'filter',bind:{store:'{categories}'},listeners:{'itemclick':'updateFilter'},reference:'categoryFilters',localized:{title:'TLLFP_Category'},filterValueName:'PunchlistCategoryID',filterLabelName:'CategoryLabel'},{xtype:'component',cls:'title',localized:{html:'TLLFP_Work Status'}},{xtype:'filter',listeners:{'itemclick':'updateFilter'},reference:'workStatusFilters',localized:{title:'TLLFP_Work Status'},bind:{store:'{workstatus}'},filterValueName:'WorkStatusID',filterLabelName:'Label'},{xtype:'component',cls:'title',localized:{html:'TLLFP_Item Status'},bind:{hidden:'{ClosedView}'}},{xtype:'filter',listeners:{'itemclick':'updateFilter'},reference:'statusFilters',localized:{title:'TLLFP_Item Status'},bind:{store:'{punchstatus}',hidden:'{ClosedView}'},filterValueName:'PunchStatusID',filterLabelName:'Label'},{xtype:'component',cls:'title',localized:{html:'TLLFP_Assignee'}},{xtype:'filter',bind:{store:'{assignees}'},listeners:{'itemclick':'updateFilter'},reference:'assigneeFilters',localized:{title:'TLLFP_Assignee'},filterValueName:'AssigneeID'}]}]},0,['punchitemfilters'],['component','box','container','punchitemfilters'],{'component':!0,'box':!0,'container':!0,'punchitemfilters':!0},['widget.punchitemfilters'],0,[clientPunchlist.view,'PunchItemFilters'],0);Ext.cmd.derive('clientPunchlist.view.fixMemberAccess.InfoColumn',Ext.grid.column.Action,{cls:'no-access-info-col',tdCls:'no-access-info',icon:'/mds/image/icon/info.png',localized:{tooltip:'TLNA_otherUserNoAccessExplanation'},width:18},0,['fixmemberaccessinfocolumn'],['component','box','container','headercontainer','gridcolumn','actioncolumn','fixmemberaccessinfocolumn'],{'component':!0,'box':!0,'container':!0,'headercontainer':!0,'gridcolumn':!0,'actioncolumn':!0,'fixmemberaccessinfocolumn':!0},['widget.fixmemberaccessinfocolumn'],0,[clientPunchlist.view.fixMemberAccess,'InfoColumn'],0);Ext.cmd.derive('clientPunchlist.view.fixMemberAccess.Window',Ext.Window,{cls:'fix-member-access-prompt',width:700,minHeight:300,modal:!0,closable:!0,localized:{title:'TL_Send Permission Chang'},layout:{type:'card'},controller:'fixmemberaccesswindow',viewModel:{type:'fixmemberaccesswindow'},bind:{activeItem:'{step}'},constructor:function(){var a=this;a.items=[{xtype:'container',cls:'inner-container',padding:50,layout:{type:'vbox',align:'center'},setMaskMessage:function(a){a?this.mask(a):this.unmask()},bind:{maskMessage:'{maskMessage}'},items:[{xtype:'label',bind:mvstr['TLNA_otherUserNoAccessTitleLong'],cls:'title',width:'100%'},{xtype:'label',width:565,margin:'25 0 25 0',cls:'explanation',html:mvstr['TLNA_otherUserNoAccessExplanation']},{xtype:'container',layout:{type:'hbox',align:'center'},margin:'10 0 0 0',items:[{xtype:'button',text:'Cancel',ui:'grey',scale:'large',width:130,height:36,margin:'0 12 0 12',listeners:{click:'closeWindow'}},{xtype:'button',text:mvstr['TLNA_Send Request'],ui:'orange',scale:'large',width:130,height:36,margin:'0 12 0 12',listeners:{click:'sendRequest'}}]}]},{xtype:'container',cls:'inner-container',padding:50,layout:{type:'vbox',align:'center'},items:[{xtype:'label',text:mvstr['TLNA_noAccessPostTitle'],cls:'title',width:'100%'},{xtype:'label',width:565,cls:'explanation',margin:'25 0 25 0',text:mvstr['TLNA_otherUserNoAccessPostExplanation']},{xtype:'container',margin:'10 0 0 0',layout:{type:'hbox',align:'center'},items:[{xtype:'button',text:mvstr['G_Done'],ui:'orange',scale:'large',width:130,height:36,listeners:{click:'closeWindow'}}]}]}];Ext.window.Window.prototype.constructor.apply(this,arguments)}},1,['fixmemberaccessbuttonwindow'],['component','box','container','panel','window','fixmemberaccessbuttonwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'fixmemberaccessbuttonwindow':!0},['widget.fixmemberaccessbuttonwindow'],0,[clientPunchlist.view.fixMemberAccess,'Window'],0);Ext.cmd.derive('clientPunchlist.view.fixMemberAccess.Button',Ext.Button,{config:{MemberUID:null},defaultBindProperty:'MemberUID',localized:{text:'TL_Fix'},width:25,height:18,margin:'1 0 0 0',listeners:{click:function(){var a=this.up('grid').getStore().findRecord('MemberUID',this.getMemberUID());this.lookupController().getView().add({xtype:'fixmemberaccessbuttonwindow',viewModel:{data:{MemberName:a.get('Assignee')||Ext.String.trim(a.get('MemberFirstName')+' '+a.get('MemberLastName')),MemberUID:a.get('MemberUID')}}}).show()}}},0,['fixmemberaccessbutton'],['component','box','button','fixmemberaccessbutton'],{'component':!0,'box':!0,'button':!0,'fixmemberaccessbutton':!0},['widget.fixmemberaccessbutton'],0,[clientPunchlist.view.fixMemberAccess,'Button'],0);Ext.cmd.derive('clientPunchlist.view.fixMemberAccess.ButtonColumn',Ext.grid.column.Widget,{tdCls:'no-access-fix',width:40,dataIndex:'MemberUID',menuDisabled:!0,focusCls:'',hoverCls:'',widget:{xtype:'fixmemberaccessbutton',ui:'orange',scale:'small'}},0,['fixmemberaccessbuttoncolumn'],['component','box','container','headercontainer','gridcolumn','widgetcolumn','fixmemberaccessbuttoncolumn'],{'component':!0,'box':!0,'container':!0,'headercontainer':!0,'gridcolumn':!0,'widgetcolumn':!0,'fixmemberaccessbuttoncolumn':!0},['widget.fixmemberaccessbuttoncolumn'],0,[clientPunchlist.view.fixMemberAccess,'ButtonColumn'],0);Ext.cmd.derive('clientPunchlist.view.PunchItemFollowers',Ext.menu.Menu,{cls:'follower-list',items:[{maxHeight:300,width:400,localized:{title:'TL_Follow list'},xtype:'gridpanel',ui:'detail-popup',cls:'tasklist-member-grid',disableSelection:!0,bind:{store:'{followers}'},hideHeaders:!0,columns:[{xtype:'checkcolumn',dataIndex:'IsFollower',width:50,listeners:{checkchange:function(c,d,b,a){a.set('IsSubscriber',b)}}},{dataIndex:'MemberName',flex:1},{xtype:'fixmemberaccessinfocolumn'},{xtype:'fixmemberaccessbuttoncolumn'}],tbar:[{xtype:'component',localized:{html:"TL_Select users you'd li"}}],viewConfig:{getRowClass:function(b){var a=[];if(b.get('IsAssignee')){a.push('disabled-row assignee')}else {if(b.get('IsCreator')){a.push('disabled-row creator')}}if(b.get('NoAccess')){a.push('no-access')}return a.join(' ')}}}],listeners:{show:function(a){a.showBy(a.up('button'),'bl',[-320,5])}}},0,['punchItemFollowers'],['component','box','container','panel','menu','punchItemFollowers'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'punchItemFollowers':!0},['widget.punchItemFollowers'],0,[clientPunchlist.view,'PunchItemFollowers'],0);Ext.cmd.derive('clientPunchlist.view.assignee.ChooseAssigneeWindow',Ext.window.Window,{modal:!0,resizable:!0,layout:'fit',height:300,width:700,searchField:null,initComponent:function(){var a=this,b=this.lookupViewModel().get('assignees');a.setBind({'title':mvstr['TL_Assign {ListItemDesc}']});Ext.applyIf(a,{items:[{xtype:'gridpanel',ui:'detail-popup',cls:'tasklist-member-grid',reference:'chooseAssigneeGrid',store:a.store,alias:'assignee',sortOnLoad:!0,rowLines:!0,plugins:{ptype:'manualediting',pluginId:'manualEditing'},bind:{selection:'{assigneeSelection}'},selModel:{selType:'rowmodel',mode:'SIMPLE',allowDeselect:!0,onNavigate:Ext.emptyFn},viewConfig:{selectedCls:'',markDirty:!1,getRowClass:function(a){return a.get('IsDefault')&&a.get('NoAccess')?'no-access':''}},columns:{defaults:{menuDisabled:!0},items:[{xtype:'checkcolumn',localized:{text:'TL_Assign'},dataIndex:'IsAssignee',width:50},{localized:{text:'TL_First Name'},dataIndex:'AssigneeFirstName',flex:2,editor:{xtype:'textfield',allowBlank:!1},renderer:function(a,c,b){a=Ext.String.htmlEncode(a);return b.get('IsDefault')?b.get('NoAccess')?a+' (lacks permissions)':a:a+"<span class='custom-assignee'>("+mvstr['TL_Custom']+')</span>'}},{localized:{text:'TL_Last Name'},editor:{xtype:'textfield',allowBlank:!0},formatter:'htmlEncode',dataIndex:'AssigneeLastName',flex:2},{localized:{text:'TL_Email'},editor:{xtype:'textfield',allowBlank:!0,inputType:'email'},formatter:'htmlEncode',dataIndex:'AssigneeEmail',flex:3},{text:'',tdCls:'x-action-col-cell edit-cell',cls:'edit-col',dataIndex:'IsOwner',align:'center',renderer:function(a){return a?'g':''},width:22},{text:'',tdCls:'x-action-col-cell delete-cell',cls:'delete-col',dataIndex:'CanDelete',align:'center',renderer:function(a){return a?'X':''},width:22},{xtype:'fixmemberaccessinfocolumn'},{xtype:'fixmemberaccessbuttoncolumn'}]},listeners:{cellclick:'cellClick',selectionchange:function(c,a){var b=c.getStore();b.each(function(b){for(var d=0;d<a.length;d++){if(a[d].getId()==b.getId()){b.set('IsAssignee',!0);return}}b.set('IsAssignee',!1)})},render:{fn:function(a){a.searchField=Ext.create('formShared.view.components.SearchField',{ui:'searchfield2',renderTo:a.el.select('.x-grid-header-ct').elements[0],localized:{emptyText:'TL_Find an Assignee...'},style:{position:'absolute',top:'3px',right:'3px'},listeners:{search:function(d){var c=a.getStore(),b=Ext.String.createRegex(d,!1,!1,!0);c.clearFilter();c.setFilters([{filterFn:function(c){return b.test(c.get('AssigneeFirstName'))||b.test(c.get('AssigneeLastName'))||b.test(c.get('AssigneeEmail'))}}])},clearsearch:function(){var b=a.searchField;if(b.getValue()){b.setValue('');return}var c=a.getStore();c.clearFilter()}}})},single:!0},destroy:function(a){a.searchField.destroy()}}}]});Ext.window.Window.prototype.initComponent.apply(this,arguments)},bbar:{padding:'5 5 8 5',items:[{xtype:'button',localized:{text:'TL_Create Custom'},ui:'orange',height:31,scale:'medium',listeners:{click:'customAssignee'}},'->',{xtype:'button',ui:'green',localized:{text:'G_Done'},height:31,scale:'medium',listeners:{click:'onChooseAssigneesDone'}}]}},0,['chooseAssigneeWindow'],['component','box','container','panel','window','chooseAssigneeWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'chooseAssigneeWindow':!0},['widget.chooseAssigneeWindow'],0,[clientPunchlist.view.assignee,'ChooseAssigneeWindow'],0);Ext.cmd.derive('clientPunchlist.view.assignee.CustomAssigneeWindow',Ext.window.Window,{localized:{title:'TL_Create Custom Assigne'},modal:!0,resizable:!0,layout:'fit',height:200,width:300,initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:'container',style:'background-color: white',layout:{type:'vbox',pack:'center',align:'middle'},defaults:{labelWidth:70,width:250},items:[{xtype:'textfield',localized:{fieldLabel:'TL_First Name'},alias:'customFirst',margin:'10 0 5 0'},{xtype:'textfield',localized:{fieldLabel:'TL_Last Name'},alias:'customLast',emptyText:'(optional)'},{xtype:'textfield',localized:{fieldLabel:'TL_Email'},alias:'customEmail',emptyText:'(optional)'},{xtype:'container',flex:1}]}]});Ext.window.Window.prototype.initComponent.apply(this,arguments)},bbar:{padding:'5 5 8 5',items:[{xtype:'button',localized:{text:'TL_Cancel'},scale:'medium',ui:'grey',height:31,listeners:{click:function(){Ext.ComponentQuery.query('customAssigneeWindow')[0].destroy()}}},'->',{xtype:'button',scale:'medium',localized:{text:'TL_Done'},ui:'green',height:31,listeners:{click:'saveCustomAssignee'}}]}},0,['customAssigneeWindow'],['component','box','container','panel','window','customAssigneeWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'customAssigneeWindow':!0},['widget.customAssigneeWindow'],0,[clientPunchlist.view.assignee,'CustomAssigneeWindow'],0);Ext.cmd.derive('clientPunchlist.view.assignee.assigneefield.AssigneeFieldController',Ext.app.ViewController,{},0,0,0,0,['controller.assigneefield'],0,[clientPunchlist.view.assignee.assigneefield,'AssigneeFieldController'],0);Ext.cmd.derive('clientPunchlist.view.assignee.assigneefield.AssigneeFieldModel',Ext.app.ViewModel,{},0,0,0,0,['viewmodel.assigneefield'],0,[clientPunchlist.view.assignee.assigneefield,'AssigneeFieldModel'],0);Ext.cmd.derive('clientPunchlist.view.assignee.assigneefield.AssigneeField',formShared.view.components.MultiSelect,{localized:{title:'TL_Assignees'},displayField:'Assignee',valueField:'AssigneeID',bind:{readOnly:'{!canEdit}'},viewConfig:{bind:{store:'{assigneeCollection}'}},listeners:{onaddclick:'selectAssignee',removerecord:'deselectAssignee'}},0,['assigneefield'],['component','box','container','multiselect','assigneefield'],{'component':!0,'box':!0,'container':!0,'multiselect':!0,'assigneefield':!0},['widget.assigneefield'],0,[clientPunchlist.view.assignee.assigneefield,'AssigneeField'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryAbbrevField',Ext.form.field.Text,{width:33,maxLength:2,enforceMaxLength:!0,hidden:!0,ui:'category-select',bind:{hidden:'{!editing}',value:'{record.CategoryAbbreviation}'}},0,['choosecategoryabbrevfield'],['component','box','field','textfield','choosecategoryabbrevfield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'choosecategoryabbrevfield':!0},['widget.choosecategoryabbrevfield'],0,[clientPunchlist.view.category,'ChooseCategoryAbbrevField'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryDeleteBtn',Ext.button.Button,{text:'X',ui:'plain',width:9,bind:{hidden:'{editing}'},listeners:{click:function(a){a.up('choosecategoryoption').deleteCategory()}}},0,['choosecategorydeletebtn'],['component','box','button','choosecategorydeletebtn'],{'component':!0,'box':!0,'button':!0,'choosecategorydeletebtn':!0},['widget.choosecategorydeletebtn'],0,[clientPunchlist.view.category,'ChooseCategoryDeleteBtn'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryDoneBtn',Ext.button.Button,{ui:'grey2',scale:'small',text:'Done',hidden:!0,width:32,height:18,bind:{hidden:'{!editing}'},listeners:{click:function(){this.up('choosecategoryoption').onDoneEdit()}}},0,['choosecategorydonebtn'],['component','box','button','choosecategorydonebtn'],{'component':!0,'box':!0,'button':!0,'choosecategorydonebtn':!0},['widget.choosecategorydonebtn'],0,[clientPunchlist.view.category,'ChooseCategoryDoneBtn'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryEditBtn',Ext.button.Button,{ui:'plain',width:18,height:18,bind:{hidden:'{editing}'},listeners:{click:function(a){a.up('choosecategoryoption').editCategory()}}},0,['choosecategoryeditbtn'],['component','box','button','choosecategoryeditbtn'],{'component':!0,'box':!0,'button':!0,'choosecategoryeditbtn':!0},['widget.choosecategoryeditbtn'],0,[clientPunchlist.view.category,'ChooseCategoryEditBtn'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryNameField',Ext.form.field.Text,{width:80,hidden:!0,ui:'category-select',bind:{hidden:'{!editing}',value:'{record.CategoryLabel}'}},0,['choosecategorynamefield'],['component','box','field','textfield','choosecategorynamefield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'choosecategorynamefield':!0},['widget.choosecategorynamefield'],0,[clientPunchlist.view.category,'ChooseCategoryNameField'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryRadio',Ext.form.field.Radio,{ui:'plain-radio-16',name:'CategoryLabel',focus:Ext.emptyFn},0,['choosecategoryradio'],['component','box','field','checkboxfield','checkbox','radiofield','radio','choosecategoryradio'],{'component':!0,'box':!0,'field':!0,'checkboxfield':!0,'checkbox':!0,'radiofield':!0,'radio':!0,'choosecategoryradio':!0},['widget.choosecategoryradio'],0,[clientPunchlist.view.category,'ChooseCategoryRadio'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryOption',Ext.Container,{viewModel:{data:{editing:!1,record:null},formulas:{categoryAbbrevLabel:function(b){var a=b('record.CategoryAbbreviation');return a?'('+a+')':''}}},config:{record:null,focusable:!1},layout:{type:'hbox'},width:185,height:22,listeners:{'deletecategory':'deleteCategory','editcategory':'editCategory','click':{fn:function(c,b){var a=Ext.getCmp(this.id);if(!a.lookupViewModel().get('editing')){a.down('choosecategoryradio').setValue(!0)}},element:'el',scope:'this'}},initComponent:function(){var a=this.getRecord(),c=a.get('PunchlistCategoryID'),b=[{xtype:'choosecategoryradio',inputValue:c,value:this.config.initialValue},{xtype:'label',cls:'category-label',margin:'0 1 0 0',maxWidth:100,bind:{html:'{record.CategoryLabel:htmlEncode}',hidden:'{editing}'}},{xtype:'label',cls:'category-abbrev',bind:{html:'{categoryAbbrevLabel}',hidden:'{editing}'},margin:'0 1 0 0'},{xtype:'choosecategorynamefield'},{xtype:'choosecategoryabbrevfield'},{xtype:'choosecategorydonebtn'}],d=a.get('IsOwner'),e=a.get('InUse');if(d){b.push({xtype:'choosecategoryeditbtn'});if(!e){b.push({xtype:'choosecategorydeletebtn'})}}this.items=b;this.getViewModel().set('record',a);Ext.container.Container.prototype.initComponent.apply(this,arguments)},getLabel:function(){var a=this.getRecord();return a.get('CategoryLabel')+(a.get('CategoryAbbreviation')?' ('+a.get('CategoryAbbreviation')+')':'')},deleteCategory:function(){Ext.Msg.confirm('Confirm','Are you sure you\'d like to delete the category "'+this.getLabel()+'"?',function(a){if(a=='yes'){this.fireEvent('deletecategory',this.getRecord())}},this)},editCategory:function(){var b=this.up('chooseCategoryWindow').getOptions();for(var a=0;a<b.length;a++){b[a].getViewModel().set('editing',b[a]==this)}},onDoneEdit:function(){var a=this.getRecord();this.getViewModel().set('editing',!1);if(a.dirty){this.fireEvent('editcategory',a)}}},0,['choosecategoryoption'],['component','box','container','choosecategoryoption'],{'component':!0,'box':!0,'container':!0,'choosecategoryoption':!0},['widget.choosecategoryoption'],0,[clientPunchlist.view.category,'ChooseCategoryOption'],0);Ext.cmd.derive('clientPunchlist.view.category.ChooseCategoryWindow',Ext.window.Window,{viewModel:{data:{newRecord:null}},config:{store:null},localized:{title:'TL_Choose Category'},modal:!0,resizable:!1,layout:'fit',height:400,width:400,scrollable:{x:!1,y:'auto'},reference:'chooseCategoryWindow',closeAction:'hide',dockedItems:[{xtype:'container',cls:'top-container',padding:'0 10 0 10',height:34,width:'100%',layout:{type:'hbox',align:'middle'},items:[{xtype:'label',cls:'create-label',localized:{html:'TL_Create Category'},flex:1},{xtype:'textfield',localized:{emptyText:'TL_Type Name'},width:128,height:22,margin:'0 5 0 0',bind:{value:'{newRecord.CategoryLabel}'}},{xtype:'textfield',localized:{emptyText:'TL_Abbrev.'},width:50,height:22,margin:'0 5 0 0',bind:{value:'{newRecord.CategoryAbbreviation}'},maxLength:2,enforceMaxLength:!0},{xtype:'button',ui:'orange',scale:'small',localized:{text:'TL_Add'},height:22,disabled:!0,bind:{disabled:'{!newRecord.CategoryLabel}'},listeners:{click:function(){this.lookupController().createCategory(this.lookupViewModel().get('newRecord'))}}}]}],initComponent:function(){var f=this,c=[],a=this.getStore(),e=a.getCount();for(var b=0;b<e;b++){var d=a.getAt(b);c.push({xtype:'choosecategoryoption',record:d,initialValue:this.config.PunchlistCategoryID==d.getId()})}Ext.applyIf(f,{items:[{margin:0,xtype:'radiogroup',alias:'categoryRadios',itemId:'categoryRadios',focusable:!1,width:400,columns:2,vertical:!1,defaults:{margin:'5 0 0 5'},reference:'categoryContainer',items:c,validate:function(){return !0},onFocusableContainerMousedown:Ext.emptyFn}]});this.getViewModel().set('newRecord',this.getNewRecord());a.addListener('remove',this.onRecordRemove,this);a.addListener('add',this.onRecordsAdd,this);a.addListener('createsuccess',this.onCreateSuccess,this);Ext.window.Window.prototype.initComponent.apply(this,arguments)},bbar:{padding:'5 5 8 5',items:['->',{xtype:'button',localized:{text:'TL_Done'},ui:'green',height:31,scale:'medium',listeners:{click:function(){this.up('chooseCategoryWindow').onDone()}}}]},getOptions:function(){return this.query('choosecategoryoption')},getOptionById:function(c){var b=this.getOptions();for(var a=0;a<b.length;a++){if(b[a].getRecord().getId()==c){return b[a]}}return null},onRecordRemove:function(d,b){for(var a=0;a<b.length;a++){var c=this.getOptionById(b[a].getId());if(c){c.hide()}}},onRecordsAdd:function(e,b){for(var a=0;a<b.length;a++){var c=this.getOptionById(b[a].getId());if(c){c.show()}else {var d=e.indexOf(b[a]);this.down('#categoryRadios').insert(d,{xtype:'choosecategoryoption',record:b[a]})}}},onCreateSuccess:function(b){this.getViewModel().set('newRecord',this.getNewRecord());var a=this.getOptionById(b.getId());a.down('radio').setValue(!0)},onDone:function(){var b=this.getOptions(),c=null;for(var a=0;a<b.length;a++){if(b[a].down('radio').getValue()){c=b[a].getRecord();break}}if(c){this.lookupController().changeCategory(c)}this.hide()},getNewRecord:function(){return Ext.create('clientPunchlist.model.PunchlistCategory',{InUse:0,IsDefault:0,IsOwner:1})},confirmDelete:function(b){var a=this.getOptionById(b.getId());if(a){a.destroy()}},listeners:{hide:function(){Ext.defer(function(){Ext.suspendLayouts();this.destroy();Ext.resumeLayouts()},1,this)},destroy:function(){var a=this.getStore();a.removeListener('remove',this.onRecordRemove,this);a.removeListener('add',this.onRecordsAdd,this);a.removeListener('createsuccess',this.onCreateSuccess,this)}}},0,['chooseCategoryWindow'],['component','box','container','panel','window','chooseCategoryWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'chooseCategoryWindow':!0},['widget.chooseCategoryWindow'],0,[clientPunchlist.view.category,'ChooseCategoryWindow'],0);Ext.cmd.derive('clientPunchlist.view.components.WorkStatusCombo',formShared.view.components.Combo,{constructor:function(){formShared.view.components.Combo.prototype.constructor.apply(this,arguments);this.addListener('change',this.updateStyle,this)},updateStyle:function(c,a,b){if(a){if(this.myCls){this.removeCls(this.myCls)}this.myCls='work-status-'+a;this.addCls(this.myCls)}}},1,['workstatuscombo'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','workstatuscombo'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'workstatuscombo':!0},['widget.workstatuscombo'],0,[clientPunchlist.view.components,'WorkStatusCombo'],0);Ext.cmd.derive('clientPunchlist.view.detailForm.PunchItemCategoryField',formShared.view.components.TextField,{flex:1,margin:'0 5 0 0',localized:{fieldLabel:'TL_Category'},reference:'category',allowBlank:!1,readOnly:!0,cls:'combo-empty-dark'},0,['punchitemcategoryfield'],['component','box','field','textfield','detailformtextfield','punchitemcategoryfield'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'detailformtextfield':!0,'punchitemcategoryfield':!0},['widget.punchitemcategoryfield'],0,[clientPunchlist.view.detailForm,'PunchItemCategoryField'],0);Ext.cmd.derive('clientPunchlist.view.detailForm.DetailFormPanel1',Ext.form.Panel,{ui:'detail-form',padding:'10 20 15 15',layout:{type:'vbox',align:'stretch'},viewModel:{formulas:{detailsTitle:function(a){if(a('unsaved')){return mvstr['TL_Details']}else {var b=a('PunchItem.ProjectPunchItemID');return b?mvstr['TL_Item #{x}'].replace('{x}',b):''}}}},constructor:function(){this.items=[{xtype:'title',cls:'x-panel-header-title-detail-form',bind:{text:'{detailsTitle}'}},{xtype:'container',layout:{type:'hbox'},margin:'15 0 0 0',items:[{xtype:'detailformtextfield',margin:'0 35 0 0 ',localized:{fieldLabel:'TL_Description'},allowBlank:!1,afterLabelTextTpl:new Ext.XTemplate('<span class="mvRequired">(mvstr[TL_Required])</span>'),flex:1,bind:{readOnly:'{!canEdit}',value:'{PunchItem.Description}'},listeners:{change:'onDescriptionChange'}},{xtype:'detailformcombo',width:100,localized:{fieldLabel:'TL_Item Status'},valueField:'PunchStatusID',displayField:'Label',readOnly:!0,bind:{store:'{punchstatus}',value:'{PunchItem.PunchStatusID}',readOnly:'{!canEditPunchStatus}'},listeners:{change:'onItemStatusComboChange'}}]},{xtype:'container',layout:{type:'hbox',align:'stretchmax'},margin:'35 0 0 0',items:[{xtype:'assigneefield',required:!0},{xtype:'container',margin:'0 0 0 35',layout:{type:'vbox',align:'stretch'},flex:1,items:[{xtype:'container',layout:{type:'hbox',align:'bottom'},items:[{xtype:'punchitemcategoryfield',afterLabelTextTpl:new Ext.XTemplate('<span class="mvRequired">(mvstr[TL_Required])</span>'),bind:{value:'{PunchItem.CategoryLabel}'}},{xtype:'button',ui:'orange',height:30,listeners:{click:'selectCategory'},hidden:!0,bind:{hidden:'{!canEdit}',text:'{categoryButtonText}',loading:'{!_categoriesLoaded}',disabled:'{!_categoriesLoaded}'}}]},{xtype:'detailformtextfield',margin:'25 0 0 0',localized:{fieldLabel:'TL_Alternate ID'},maxLength:255,bind:{readOnly:'{!canEdit}',value:'{PunchItem.ExternalIDString}'}}]}]},{xtype:'detailformtextfield',reference:'locationField',localized:{fieldLabel:'TL_Location'},margin:'25 0 0 0',maxLength:255,bind:{readOnly:'{!canEdit}',value:'{PunchItem.LocationDetail}'}},{xtype:'container',margin:'25 0 0 0',layout:{type:'hbox'},items:[{xtype:'workstatuscombo',localized:{fieldLabel:'TL_Work Status'},valueField:'WorkStatusID',displayField:'Label',readOnly:!0,bind:{store:'{workstatus}',value:'{PunchItem.WorkStatusID}',readOnly:'{!canEdit}'},listeners:{change:'onWorkStatusComboChange'}},{xtype:'datefield',margin:'0 0 0 175',ui:'detail-form',width:160,localized:{fieldLabel:'TL_Due Date'},reference:'dueDateField',name:'DueDate',allowBlank:!1,editable:!1,labelAlign:'top',labelSeparator:'',readOnly:!0,cls:'with-icon',format:'M j, Y',bind:{value:'{PunchItem.DueDate}',readOnly:'{!canEdit}'}}]}];Ext.form.Panel.prototype.constructor.apply(this,arguments)}},1,['detailformpanel1'],['component','box','container','panel','form','detailformpanel1'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'detailformpanel1':!0},['widget.detailformpanel1'],0,[clientPunchlist.view.detailForm,'DetailFormPanel1'],0);Ext.cmd.derive('clientPunchlist.view.detailForm.PhotoFileList',Ext.view.View,{cls:'documentList',border:!0,padding:0,itemSelector:'.photo',margin:'10 15 0 15',bind:{store:'{photos}'},scrollable:{x:'auto',y:!1},focusable:!1,tpl:['<tpl for=".">','<div class="photo fileviewer-item type-cls-{Type}">','<div class="img-wrap">','<div class="remove-button"></div>','<img src="{ImageURLMedium}" alt="Open in Photo Viewer">','</div>','<div class="details">','<tpl if="CreatorName"><div class="uploader">Uploaded by: {CreatorName}</div><br></tpl>','<div class="date">{PhotoDate:date("M j, Y")}</div>','</div>','</div>','</tpl>'],listeners:{beforerefresh:function(a){if(!this.hasCls('print')){a.up('photofileviewer').setHeight(a.getStore().getCount()?370:90)}}}},0,['detailformphotofilelist'],['component','box','dataview','detailformphotofilelist'],{'component':!0,'box':!0,'dataview':!0,'detailformphotofilelist':!0},['widget.detailformphotofilelist'],0,[clientPunchlist.view.detailForm,'PhotoFileList'],0);Ext.cmd.derive('clientPunchlist.view.detailForm.DetailForm',Ext.panel.Panel,{layout:{type:'fit'},itemId:'activePage',width:'100%',flex:1,viewModel:{formulas:{showComments:function(a){return a('onEntryPage')},addPhotoButtonHidden:function(a){return !!(!a('canEdit')||a('onPhotoPage'))},addPhotoButtonDisabled:function(a){return !a('unsaved')&&!a('_photosLoaded')},pinsHidden:function(a){return !a('onEntryPage')&&!a('onPhotoPage')},filesHidden:function(a){return !a('onEntryPage')},backToListText:function(b){var a=b('ListTypeID');return a?'&lt; '+mvstr['TL_Back_to_'+a]:''}}},bind:{savedCls:'{unsaved}',editCls:'{canEdit}'},setSavedCls:function(a){if(a){this.removeCls('saved');this.addCls('unsaved')}else {this.removeCls('unsaved');this.addCls('saved')}},setEditCls:function(a){if(a){this.addCls('can-edit-item')}else {this.removeCls('can-edit-item')}},initComponent:function(){if(this.printMode){return Ext.panel.Panel.prototype.initComponent.apply(this,arguments)}if(app.getName()!='clientPunchlistOverview'){this.lookupViewModel().notify()}var b=this.lookupViewModel().get('onPhotoPage'),a=!!(this.up('clientPunchlistEntry')||this.up('entryPage')),d=[{xtype:'container',layout:'hbox',items:[{xtype:'container',layout:{type:'vbox'},flex:1,items:[{xtype:'detailformpanel1',height:445,margin:'0 0 20 0',width:'100%'}]},{xtype:'container',width:400,height:445,layout:{type:'hbox',align:'stretch'},items:[{xtype:'panel',localized:{title:'GC_Comments'},margin:'0 0 0 20',padding:'15 15 18 15',bodyPadding:'5 0 0 5',ui:'detail-form',cls:'comments',width:380,layout:{type:'fit'},items:[{xtype:'comments',reference:'comments',flex:1}]}],hidden:!0,bind:{hidden:'{!showComments}'}}]},{xtype:'punchItemLocations',margin:'20 0 20 0',padding:'20 0 20 0',hidden:!0,bind:{hidden:'{pinsHidden}'}},{xtype:'fileviewer',reference:'fileViewer',ui:'detail-form',showDownloadButton:!1,showTbarTitle:!0,scrollable:null,margin:'20 0 0 0',padding:'20 0 20 0',title:null,fileList:{xtype:'detailformfilelist',initRefresh:!0},folderFileList:{xtype:'detailformfilelist',bind:{store:'{folderFiles}'}},addButton:{xtype:'button',ui:'orange',scale:'large',localized:{text:'TL_Add File'},minWidth:104,margin:'0 15 0 0',bind:{hidden:'{!canEdit}'}},hidden:!0,bind:{hidden:'{filesHidden}'}}];if(a||b){Ext.Array.insert(d,b?0:1,[{xtype:'photofileviewer',reference:'photoList',ui:'detail-form',title:null,tbarTitle:b?mvstr['TL_Selected Photos']:mvstr['TL_Photos'],listView:{xtype:'detailformphotofilelist'},addButton:{xtype:'button',ui:'orange',scale:'large',minWidth:104,localized:{text:'TL_Add Photo'},margin:'0 15 0 0',hidden:!0,disabled:!0,bind:{hidden:'{addPhotoButtonHidden}',disabled:'{addPhotoButtonDisabled}'}},showDownloadButton:!1,showTbarTitle:!0,scrollable:null,margin:'0 0 12 0',padding:'20 0 0 0',width:a?1150:'100%',height:90}])}this.tbar={xtype:'container',margin:'10 0 4 0',width:'100%',layout:{type:'hbox',align:'center'},items:[{xtype:'component',flex:1},{xtype:'container',layout:{type:'hbox',align:'middle'},width:a?1150:959,height:30,items:[{xtype:'container',layout:{type:'hbox',align:'middle'},width:750,height:'100%',items:[{xtype:'button',ui:'plain',cls:'content-link',hrefTarget:'',hidden:!0,bind:{html:'{backToListText}',href:'{backLink}',hidden:'{!onEntryPage}'},listeners:{click:'onBackLinkClick'}},{xtype:'component',flex:1},{xtype:'container',layout:{type:'vbox',align:'end',pack:'end'},height:'100%',items:[{xtype:'component',hideMode:'visibility',cls:'editor-label',bind:{html:"<span class='label'>mvstr[TL_Created By]:</span> {PunchItem.CreatorName} on {PunchItem.CreationDate:date('M j, Y')}",hidden:'{unsaved}'}},{xtype:'component',hideMode:'visibility',cls:'editor-label',margin:'2 0 0 0',bind:{html:"<span class='label'>mvstr[TL_Last Edited By]:</span> {PunchItem.LastEditorName} on {PunchItem.LastEditedDate:date('M j, Y')}",hidden:'{!PunchItem.LastEditedDate}'}}]}]},{xtype:'component',flex:1},{xtype:'container',layout:{type:'hbox'},hidden:!0,bind:{hidden:'{!followControlsVisible}'},items:[{xtype:'button',height:25,minWidth:70,cls:'edit-followers-btn',_disabledCls:'',ui:'orange',scale:'small',textAlign:'left',bind:{isFollower:'{isFollower}',disabled:'{followDisabled}'},setIsFollower:function(a){this.setText(a?mvstr['TL_Following']:mvstr['TL_Follow']);this.setIcon(a?'mds/image/icon/btn-following-check-icon.png':'mds/image/icon/btn_follow-star-icon.png')},listeners:{click:'toggleFollow'}}]},{xtype:'button',ui:'more-options',reference:'menuButton',scale:'medium',margin:'0 0 0 15',menu:{xtype:'itemActionMenu'},hidden:!0,bind:{hidden:'{!onEntryPage}'}}]},{xtype:'component',flex:1},{xtype:'component',width:Ext.getScrollbarSize().width}]};var c={xtype:'container',width:'100%',items:d};if(a){c.minHeight=Ext.getBody().getViewSize().height}this.items=[{xtype:'panel',reference:'punchItemDetails',layout:{type:'fit'},items:{xtype:'panel',reference:'scrollableContainer',layout:{type:'hbox',pack:'middle'},flex:1,width:'100%',scrollable:{x:!1,y:'scroll'},items:[{xtype:'button',ui:'plain',reference:'prevPunchItem',cls:'taskitem-nav-btn previous',text:'<',margin:'0 10 0 0',hidden:!0,bind:{hidden:'{!onTaskList}'},listeners:{click:'prev'}},{xtype:'container',layout:{type:'vbox'},width:a?1150:'100%',padding:!a?5:0,items:[c]},{xtype:'button',ui:'plain',reference:'nextPunchItem',cls:'taskitem-nav-btn next',text:'>',margin:'0 0 0 10',hrefTarget:'',hidden:!0,bind:{hidden:'{!onTaskList}'},listeners:{click:'next'}}]},fbar:{xtype:'container',layout:{type:'hbox',pack:'middle'},defaults:{height:31,xtype:'button',scale:'medium',padding:'0 15 0 15',margin:15},items:[{xtype:'button',ui:'grey',localized:{text:'TL_Cancel'},bind:{href:'{backLink}'},hrefTarget:'',listeners:{click:'onCancelClick'}},{xtype:'button',ui:'orange',localized:{text:'TL_Done'},listeners:{click:'saveAndBack'},disabled:!0,bind:{disabled:'{saveDisabled}'}},{xtype:'button',ui:'orange',localized:{text:'TL_Done & New'},listeners:{click:'saveAndNew'},disabled:!0,hidden:!0,bind:{disabled:'{saveDisabled}',hidden:{bindTo:'{doneAndNewHidden}',single:!0}}}],hidden:!0,bind:{hidden:'{!canEdit}'}}}];Ext.panel.Panel.prototype.initComponent.apply(this,arguments)}},0,['punchitemdetails'],['component','box','container','panel','punchitemdetails'],{'component':!0,'box':!0,'container':!0,'panel':!0,'punchitemdetails':!0},['widget.punchitemdetails'],0,[clientPunchlist.view.detailForm,'DetailForm'],0);Ext.cmd.derive('clientPunchlist.view.location.SelectPunchPlanWindow',Ext.window.Window,{title:'Select Location(s)',modal:!0,resizable:!0,layout:'fit',height:300,width:500,initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:'gridpanel',reference:'planGrid',store:this.store,alias:'punchplan',sortOnLoad:!0,rowLines:!0,selModel:{selType:'checkboxmodel',mode:'SIMPLE',injectCheckbox:'last',allowDeselect:!0},columns:[{text:'Category',dataIndex:'ProjectShootTypeLabel',flex:1},{text:'Location',dataIndex:'PunchlistPlanDescription',flex:1}],bbar:['->',{xtype:'button',text:'Done',listeners:{click:'saveSelectedPlans'}}],listeners:{beforedeselect:function(c,b){if(Ext.Array.contains(a.store.PinnedLocations,b.get('PunchlistPlanUID'))){Ext.Msg.alert('Error','Cannot deselect a location that the item is pinned to.');return !1}}}}]});Ext.window.Window.prototype.initComponent.apply(this,arguments)}},0,['selectPunchPlanWindow'],['component','box','container','panel','window','selectPunchPlanWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'selectPunchPlanWindow':!0},['widget.selectPunchPlanWindow'],0,[clientPunchlist.view.location,'SelectPunchPlanWindow'],0);Ext.cmd.derive('clientPunchlist.view.detailForm.DetailFormController',Ext.app.ViewController,{init:function(){analytics.Ctrl.setOptionalDefaultEventProperties({'Task List UI':'Task List Item Details - New Item','Object Type':'Task List Item','Context':'Task List Item - New Item'});var a=this.getViewModel();a.bind('{assigneeSelection}',this.onAssigneeSelectionChange,this);this.initPunchItem();var b=a.bind({_commentsLoaded:'{_commentsLoaded}',PunchItem:'{PunchItem}'},function(a){if(!a._commentsLoaded||!a.PunchItem){return}var c=this.lookupReference('comments').lookupViewModel().get('comments');c.addListener('datachanged',function(){a.PunchItem.set('CommentCount',c.getCount())},this);b.destroy()},this);a.bind('{PunchItem}',function(a){if(a&&!isNaN(a.getId())){analytics.Ctrl.setOptionalDefaultEventProperties({'Task List Item ID':a.getId(),'Task List Item List':a.getId(),'Task List UI':'Task List Item Details - Existing Item','Context':'Task List Item Details - Existing Item'})}})},initPunchItem:function(){this.loadPunchItem(this.getViewModel().get('ProjectUID'))},loadPunchItem:function(i,g,b){var m=!!b;b=b||Ext.create('clientPunchlist.model.PunchItem');var e=this.getView(),a=this.getViewModel(),d=function(){if(a.getView()){a.set('dirty',b.dirty);a.set('recordValid',b.isValid())}},f=this.lookupReference('locationField'),c=this.lookupReference('dueDateField'),l=this.lookupReference('comments').lookupViewModel().get('comments');a.set('PunchItem',b);l.addListener('load',function(){a.set('_commentsLoaded',!0)},this,{single:!0});if(b){d()}b.session={afterLoad:d,afterEdit:d,afterReject:d,afterCommit:d};if(g){var j=function(){if(b.isLoading()){e.mask()}},k={ProjectUID:i,PunchItemID:g};var h=a.get('ListTypeID');if(h){k.ListTypeID=h}if(!m){b.getProxy().setExtraParams(k);b.load({callback:Ext.bind(e.unmask,e)})}if(e.getEl()){j()}else {e.addListener('afterrender',j,undefined,{single:!0})}Ext.defer(function(){this.getStore('files').load(function(){a.bind('{_filesDataChanged}',function(){b.set('DocumentCount',a.get('files').getCount())},this)});this.getStore('photos').load(function(){a.bind('{_photosDataChanged}',function(){b.set('PhotoCount',a.get('photos').getCount())},this)});this.getStore('pins').load(function(){a.bind('{_pinsDataChanged}',function(){b.set('PunchPinCount',a.get('pins').getCount())},this)})},10,this);f.addListener('change',function(){f.addListener('change',this.onLocationChange,this)},this,{single:!0});c.addListener('change',function(){c.addListener('change',this.onDueDateChange,this)},this,{single:!0})}else {f.addListener('change',this.onLocationChange,this);c.addListener('change',function(){c.addListener('change',function(){c.addListener('change',this.onDueDateChange,this)},this,{single:!0})},this,{single:!0});b.getProxy().setExtraParams({ProjectUID:i});a.bind('{initialPunchlistCategoryID}',this.initializePunchlistCategory,this);a.bind('{initialPunchlistLocation}',this.initializePunchlistLocation,this);a.bind('{initialPunchlistDueDate}',this.initializePunchlistDueDate,this)}},getAssigneeChanges:function(){var b=this.getStore('assignees').getModifiedRecords(),c=[];for(var a=0;a<b.length;a++){if(b[a].getData({changes:!0}).IsAssignee!==undefined){c.push(b[a])}}return c},savePunchItem:function(n,w,y,f){var a=this.getViewModel(),d=a.get('PunchItem'),s=[],j=this.getAssigneeChanges(),u=a.get('alwaysCloneWhenDone_readOnly'),x=u&&a.get('showConfirmationPrompt_readOnly'),z=f?f.includePhotos:a.get('tasklistSetting_includePhotos'),D=f?f.includePins:a.get('tasklistSetting_includePins'),B=f?f.includeFiles:a.get('tasklistSetting_includeFiles');if(x&&!y){this.getView().add({xtype:'cloneConfirmationWindow',reference:'cloneConfirmationWindow',saveArgs:[n,w,!0]}).showBy(Ext.getBody(),'c-c?');return}if(j.length){for(var b=0;b<j.length;b++){s.push(j[b].getData({changes:!0,critical:!0}))}d.set('Assignees',s)}d.set('ListTypeID',a.get('ListTypeID'));var H=this.getView().up(),e=a.get('unsaved'),E=this.getStore('files'),k=this.getStore('followers'),c=[this.getStore('photos'),this.getStore('pins'),E,this.lookupReference('comments').lookupViewModel().get('comments')],g=this.getView().up('punchlistwindow')||this.getView().up('clientviewport'),q=0,r=!0,h={},o=!!(d.dirty||d.phantom),G=function(){var a=H.up('punchlistwindow');g.setLoading(!1);if(a){Ext.defer(a.destroy,1,a);h[0].IsNewItem=e?1:0;app.fireEvent('startaddpunchpin',h[0])}delete d.session;if(r&&n){n.call(w)}},C=function(){if(this.name){a.set('_'+this.name+'Loaded',!0);a.set('save_'+this.name+'Done',!0)}},F=function(){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.clonePunchItem',params:{ProjectUID:a.get('ProjectUID'),PunchItemID:a.get('PunchItem.PunchItemID'),includePhotos:z,includePins:D,includeFiles:B},scope:this,successCallback:function(){a.set('save_cloneDone',!0)},afterFailMessageCallback:function(){g.unmask();console.log("didn't clone :(")}})};for(var b=0;b<c.length;b++){if(!c[b]){continue}if(c[b].getModifiedRecords().length||c[b].getRemovedRecords().length){q++}}var A=!!q,i=!!k.getModifiedRecords().length,p=Ext.bind(function(){if(o){d.save({success:function(d,c,b){h=b;if(e){a.set('PunchItemID',h[0].PunchItemID);a.notify();app.fireEvent('savednewpunchitem',a.get('PunchItemID'))}a.set('save_itemDone',!0)},afterFailMessageCallback:function(){if(!e){d.reject()}g.unmask()},scope:this})}},this),v=function(){if(A){for(var d=0;d<c.length;d++){var b=c[d],g=b.getProxy().getExtraParams();g.IsNewItem=e?1:0;b.sync({silentSuccess:!0,callback:C,failure:function(){r=!1},scope:b})}}if(!e&&i){k.sync({silentSuccess:!0,success:function(){a.set('save_FollowersDone',!0)}})}};g.setLoading(!0);d.set('ShareTypeID',this.getViewModel().get('account.canShare')?1:2);if(i&&e){var l=[],m=k.getModifiedRecords();for(b=0;b<m.length;b++){var t=m[b].get('MemberUID');if(customData.Util.isUUID(t)){l.push({MemberUID:t,IsSubscriber:m[b].get('IsSubscriber')})}}if(l.length){d.set('Followers',l)}a.set('save_FollowersDone',!0)}else {a.set('save_FollowersDone',!i)}a.bind({save_pinsDone:'{save_pinsDone}',save_photosDone:'{save_photosDone}',save_filesDone:'{save_filesDone}',save_itemDone:'{save_itemDone}',save_cloneDone:'{save_cloneDone}',save_FollowersDone:'{save_FollowersDone}'},function(a){if(a.save_pinsDone&&a.save_photosDone&&a.save_filesDone&&a.save_itemDone&&a.save_cloneDone&&a.save_FollowersDone){G()}},this);if(e){a.bind({save_itemDone:'{save_itemDone}'},function(a){if(a.save_itemDone){v()}},this)}else {a.bind({save_pinsDone:'{save_pinsDone}',save_filesDone:'{save_filesDone}',save_photosDone:'{save_photosDone}',save_FollowersDone:'{save_FollowersDone}'},function(a){if(a.save_pinsDone&&a.save_filesDone&&a.save_photosDone&&a.save_FollowersDone){p()}},this)}if(u){a.bind({save_pinsDone:'{save_pinsDone}',save_photosDone:'{save_photosDone}',save_filesDone:'{save_filesDone}',save_itemDone:'{save_itemDone}',save_FollowersDone:'{save_FollowersDone}'},function(a){if(a.save_pinsDone&&a.save_photosDone&&a.save_filesDone&&a.save_itemDone&&a.save_FollowersDone){F()}},this)}else {a.set('save_cloneDone',!0)}a.set('save_itemDone',!o);for(var b=0;b<c.length;b++){if(!c[b]){continue}if(!c[b].getModifiedRecords().length&&!c[b].getRemovedRecords().length){a.set('save_'+c[b].name+'Done',!0)}}if(e){p()}else {v()}},selectCategory:function(){var a=this.getStore('categories'),b=this.getView();b.add({xtype:'chooseCategoryWindow',store:a,reference:'chooseCategoryWindow',PunchlistCategoryID:this.getViewModel().get('PunchItem.PunchlistCategoryID')}).showBy(Ext.getBody(),'c-c?')},changeCategory:function(a){this.getViewModel().set('PunchItem.PunchlistCategoryID',a.getId());this.getViewModel().set('PunchItem.CategoryLabel',a.get('CategoryLabel'));this.getViewModel().set('PunchItem.CategoryAbbreviation',a.get('CategoryAbbreviation'));this.getViewModel().set('punchlistCategoryChanged',!0)},createCategory:function(c){var b=this.lookupReference('chooseCategoryWindow');b.mask('Saving ...');var a=this.getStore('categories');a.add(c);a.sync({success:function(){b.unmask();a.fireEvent('createsuccess',c)},afterFailMessageCallback:function(){a.rejectChanges();b.unmask()}})},deleteCategory:function(c){var a=this.lookupReference('chooseCategoryWindow');a.mask('Saving ...');var b=this.getStore('categories');b.remove(c);b.sync({success:function(){a.unmask();a.confirmDelete(c)},afterFailMessageCallback:function(){b.rejectChanges();a.unmask()}})},editCategory:function(c){var a=this.lookupReference('chooseCategoryWindow');a.mask('Saving ...');var b=this.getStore('categories');b.sync({success:function(){a.unmask()},afterFailMessageCallback:function(){b.rejectChanges();a.unmask()}})},selectPlans:function(){var f=this.getStore('punchplans'),b=this.getViewModel().get('PunchItem.PunchlistPlanUIDs'),g=this.getView(),d=g.add({xtype:'selectPunchPlanWindow',store:f,reference:'selectPunchPlanWindow'}).showBy(Ext.getBody(),'c-c?'),c=d.down('grid');for(var a=0;a<b.length;a++){var e=c.store.find('PunchlistPlanUID',b[a]);c.getSelectionModel().select(e,!0)}},saveSelectedPlans:function(d){var b=this.lookupReference('planGrid').getSelectionModel().getSelection(),c=[];for(var a=0;a<b.length;a++){c.push(b[a].getData())}this.getViewModel().set('PunchItem.PunchlistPlans',c);d.up('window').destroy()},initializePunchlistCategory:function(b){var a=this.getViewModel().getStore('categories').getById(b);if(a){this.changeCategory(a)}},initializePunchlistLocation:function(a){if(a!==null){this.getViewModel().set('PunchItem.LocationDetail',a)}},initializePunchlistDueDate:function(a){if(a!==null){this.getViewModel().set('PunchItem.DueDate',a)}},selectAssignee:function(){this.getView().add({xtype:'chooseAssigneeWindow',store:this.getStore('assignees'),reference:'chooseAssigneeWindow',AssigneeID:this.getViewModel().get('PunchItem.AssigneeID')}).showBy(Ext.getBody(),'c-c?')},deselectAssignee:function(a){var b=this.getViewModel().get('assignees'),a=b.getById(a.getId());a.set('IsAssignee',!1)},onAssigneesUpdate:function(f){this.getViewModel().set('assigneesChanged',(new Date()).getTime());this.getViewModel().set('assigneesDirty',!!this.getAssigneeChanges().length);var e=f.getModifiedRecords(),b=null,c=null,g=[];f.each(function(a){if(a.get('IsAssignee')){g.push(a.getId())}});for(var d=0;d<e.length;d++){b=e[d];var a=b.getData({changes:!0,critical:!0});if(a.AssigneeFirstName!==undefined||a.AssigneeLastName!==undefined||a.AssigneeEmail!==undefined){c=Ext.clone(a);delete c.IsAssignee}}if(c){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.updatePunchlistCustomAssignee',params:{ProjectUID:this.getViewModel().get('ProjectUID')},jsonData:c,scope:this,successCallback:function(){if(a.IsAssignee!==undefined){b.set('IsAssignee',!a.IsAssignee,{silent:!0})}b.commit(!0);if(a.IsAssignee!==undefined){b.set('IsAssignee',a.IsAssignee,{silent:!0})}},afterFailMessageCallback:function(){b.reject();if(a.IsAssignee!==undefined){b.set('IsAssignee',a.IsAssignee)}}})}},onAssigneesLoad:function(){this.getViewModel().set('assigneesLoaded',!0)},onAssigneeSelectionChange:function(a){var b=this.getStore('followers');if(b){b.each(function(b){for(var c=0;c<a.length;c++){var d=a[c].get('MemberUID');if(b.get('MemberUID')==d){b.set('IsAssignee',!0);return}}b.set('IsAssignee',!1)})}},customAssignee:function(){this.getView().add({xtype:'customAssigneeWindow',reference:'customAssigneeWindow'}).showBy(Ext.getBody(),'c-c?')},onChooseAssigneesDone:function(){this.lookupReference('chooseAssigneeWindow').destroy()},onFollowersLoad:function(d){var a=this.getViewModel(),c=a.get('account.MemberUID'),b=d.getById(c);if(!b){b=Ext.create('clientPunchlist.model.Follower',{MemberUID:c,IsCreator:a.get('isOwner'),IsSubscriber:a.get('PunchItem.IsSubscriber'),IsAssignee:a.get('IsAssignee'),NoAccess:!1,MemberFirstName:a.get('account.MemberUsername')});d.add(b)}if(!a.get('PunchItemID')){b.set('IsCreator',!0)}a.set('isFollower',b.get('IsFollower'));a.set('userFollowerModel',b);a.set('followersLoaded',!0)},onFollowersUpdate:function(b){var a=this.getViewModel();a.set('followersChanged',!!b.getModifiedRecords().length);a.set('isFollower',b.getById(a.get('account.MemberUID')).get('IsFollower'))},toggleFollow:function(){var a=this.getViewModel().get('userFollowerModel'),b=!a.get('IsSubscriber');a.set('IsSubscriber',b);analytics.Ctrl.log('Toggled Following Task List Item',{'Action':b?'Followed':'Unfollowed'},['Task List Item ID','Task List UI'])},saveCustomAssignee:function(){var b=Ext.ComponentQuery.query("textfield[alias='customFirst']")[0].value,c=Ext.ComponentQuery.query("textfield[alias='customLast']")[0].value,a=Ext.ComponentQuery.query("textfield[alias='customEmail']")[0].value;if(!b.length){Ext.Msg.alert('Error','Custom assignees must be given a First Name value.')}else {Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.createPunchlistCustomAssignee',params:{ProjectUID:this.getViewModel().get('ProjectUID'),CustomAssigneeFirstName:b,CustomAssigneeLastName:c.length?c:null,CustomAssigneeEmail:a.length?a:null},scope:this,successCallback:function(f){var d=Ext.ComponentQuery.query("grid[alias='assignee']")[0];var e=d.store.add({PunchlistCustomAssigneeID:f,AssigneeFirstName:b,AssigneeLastName:c,AssigneeEmail:a,IsDefault:0,IsOwner:1,AssigneeID:'C'+f,IsAssignee:!0})[0];var g=d.store.indexOf(e);d.getSelectionModel().select(e,!0,!0);d.getView().scrollRowIntoView(g,!0);d.store.Assignee=e;Ext.ComponentQuery.query('customAssigneeWindow')[0].destroy()},failure:function(){Ext.Msg.alert('Error','An error occurred. Assignee could not be saved.')}})}},cellClick:function(b,g,e,a,h,d,c,f){if(a.get('CanDelete')&&c.position.column.cls==='delete-col'){this.deleteAssignee(a,d)}if(a.get('IsOwner')&&c.position.column.cls==='edit-col'){b.grid.getPlugin('manualEditing').startEdit(a)}if(c.position.column.xtype==='gridcolumn'&&!c.position.column.cls){if(b.getSelectionModel().getSelection().indexOf(a)>-1){b.getSelectionModel().deselect(a)}else {b.getSelectionModel().select(a,!0)}}},deleteAssignee:function(b,a){Ext.Msg.confirm('Confirm',"Are you sure you'd like to delete this custom assignee?",function(c,d){if(c=='yes'){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.deletePunchlistCustomAssignee',params:{ProjectUID:this.getViewModel().get('ProjectUID'),PunchlistCustomAssigneeID:b.get('PunchlistCustomAssigneeID')},scope:this,successCallback:function(){var e=Ext.ComponentQuery.query('chooseAssigneeWindow')[0].store;e.removeAt(a)},failure:function(){Ext.Msg.alert('Error','An error occurred. Assignee could not be deleted.')}})}},this)},updatePins:function(b){var a=this.getStore('pins');if(!a){return}a.suspendEvents(!1);var e=a.getCount();for(var d=0;d<e;d++){var c=a.getAt(d);c.set('PushpinSymbol',b.PushpinSymbol);c.set('TextOverlay',b.CategoryAbbreviation);c.set('ListTypeID',b.ListTypeID)}Ext.defer(function(){a.resumeEvents();var c=this.lookupReference('pinnedLocationsDataview');if(c){c.refresh()}},50,this)},saveAndBack:function(){analytics.Ctrl.log('Clicked Task List Item Done Button',{},['Task List UI']);app.fireEvent('savingnewpunchitem',this.getStore('photos'));this.savePunchItem()},addPunchPinToPlan:function(){this.getView().setActiveItem(this.lookupReference('pinWizard'))},closePinWizard:function(){this.getView().setActiveItem(this.lookupReference('punchItemDetails'))},deletePunchPin:function(g,c,f,e,a){if(Ext.fly(a.target).hasCls('remove-button')){var b=this.getViewModel();var d=b.get('pins');d.remove(c);a.preventDefault();return !1}},onDescriptionChange:function(a){this.getViewModel().set('punchItemDescriptionValid',a.isValid())},onLocationChange:function(a,b){this.getViewModel().set('punchlistLocationChanged',!0)},onDueDateChange:function(b,a){if(a){this.getViewModel().set('punchlistDueDateChanged',!0)}},printPunchItem:function(){var a=this.getViewModel();var c={ProjectUID:a.get('ProjectUID'),ListTypeID:a.get('ListTypeID'),PunchItemID:a.get('PunchItem.PunchItemID'),PunchStatusID:a.get('PunchItem.PunchStatusID')};var b=mdslink.server+'/index.cfm?fuseaction=aClientPunchlist.detailsPDF&'+Ext.Object.toQueryString(c);window.open(b,'_blank')},deletePunchItem:function(){Ext.Msg.confirm('Confirm','Delete selected item?',function(a,b){if(a=='yes'){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.deletePunchItem',params:{ProjectUID:this.getViewModel().get('ProjectUID'),PunchItemID:this.getViewModel().get('PunchItem.PunchItemID')},scope:this,successCallback:function(d){if(this.backToList){var c=this.getViewModel().get('PunchItem');c.store.remove(c);this.backToList()}else {document.location.href=this.getViewModel().get('backLink')}}},this)}},this)},onCloneConfirm:function(){var a=this.lookupReference('cloneConfirmationWindow'),b=a.getSaveArgs();b.push({includePhotos:a.down('#includePhotos').getValue(),includePins:a.down('#includePins').getValue(),includeFiles:a.down('#includeFiles').getValue()});this.savePunchItem.apply(this,b);a.destroy()},deleteButtonClicked:function(){Ext.Msg.confirm('Confirm',"Are you sure you'd like to delete this item?",function(a,b){if(a=='yes'){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.deletePunchItem',params:{ProjectUID:this.getViewModel().get('ProjectUID'),PunchItemID:this.PunchItem.get('PunchItemID')},scope:this,successCallback:function(c){Ext.Msg.alert('Success','Item deleted successfully',function(d,e){if(d=='ok'){window.location=mdslink.clientPunchlistOverview+'ProjectUID='+this.getViewModel().get('ProjectUID')}},this)}},this)}},this)},cancelButtonClicked:function(){this.setFormValues(this.PunchItem)},setFormValues:function(a){Ext.ComponentQuery.query('shareWithButton')[0].initialize(a.get('ShareTypeID'),a.get('ShareMembers'));var b=Ext.ComponentQuery.query('punchitemdetails')[0];b.loadRecord(a)},saveAndNew:function(){analytics.Ctrl.log('Clicked Task List Item Done and New Button');this.savePunchItem(function(){document.location.href=document.location.href},this)},onBackLinkClick:function(){analytics.Ctrl.log('Clicked Back To Task List Link',{},['Task List UI'])},next:Ext.emptyFn,prev:Ext.emptyFn,nextPrev:Ext.emptyFn,onCancelClick:function(b){var a=b.up('window');if(a){a.destroy()}},showFollowers:function(){this.getView().add({xtype:'punchItemFollowers',reference:'punchItemFollowers'}).showBy(this.lookupReference('menuButton'),'c-c?')},onWorkStatusComboChange:function(e,c,d){var a=this.getViewModel().get('PunchItem.PunchItemID');if(a&&!d){return}var b=['Task List UI'];if(!a||!isNaN(a)){b.push('Task List Item List')}analytics.Ctrl.log('Changed Task List Item Work Status',{'Work Status':e.getDisplayValue(),'Work Status ID':c},b)},onItemStatusComboChange:function(e,c,d){var a=this.getViewModel().get('PunchItem.PunchItemID');if(a&&!d){return}var b=['Task List UI'];if(!a||!isNaN(a)){b.push('Task List Item List')}analytics.Ctrl.log('Changed Task List Item Status',{'Item Status':e.getDisplayValue(),'Item Status ID':c},b)}},0,0,0,0,['controller.detailform'],0,[clientPunchlist.view.detailForm,'DetailFormController'],0);Ext.cmd.derive('clientPunchlist.view.detailForm.DetailFormModel',Ext.app.ViewModel,{data:{dirty:!1,recordValid:!1,_forceUpdatePins:0,followersChanged:!1,isFollower:!1,userFollowerModel:null,followersLoaded:!1,assigneesLoaded:!1,assigneesChanged:0,assigneesDirty:!1,punchItemDescriptionValid:!0,private_PunchlistCategoryID:null,private_AssigneeList:null,private_punchlistLocation:null,private_punchlistDueDate:null,punchlistCategoryChanged:!1,punchlistLocationChanged:!1,punchlistDueDateChanged:!1,save_itemDone:!1,save_pinsDone:!1,save_photosDone:!1,save_filesDone:!1,save_cloneDone:!1,save_FollowersDone:!1,_commentsLoaded:!1},formulas:{onEntryPage:function(){return !!(this.getView().xtype=='clientPunchlistEntry'||this.getView().xtype=='entryPage')},canEdit:function(a){return !!(a('account.canWrite')&&(a('isOwner')||a('account.canShare')))},showEditButton:function(a){return !!(a('canEdit')&&!a('unsaved'))},isOwner:function(a){return !!(a('unsaved')||a('PunchItem.IsOwner'))},canEditPunchStatus:function(a){return !!(a('isOwner')||a('account.TaskListItemStatusPermission'))},editingOwn:function(a){return !!(a('canEdit')&&a('isOwner'))},editingExisting:function(a){return !!(a('canEdit')&&!a('unsaved'))},editingOwnExisting:function(a){return !!(a('canEdit')&&a('PunchItem.IsOwner'))},unsaved:function(a){if(!a('onEntryPage')){return !0}var b=a('PunchItem');return b?isNaN(b.getId()):!a('PunchItemID')},commentViewData:function(a){var b=a('PunchItem');if(!b||isNaN(b.getId())){return null}return {CommentType:'punchitem',CommentCount:a('PunchItem.CommentCount'),Identifier:a('PunchItem.PunchItemID')}},_triggerUpdatePins:{bind:{PinsLoaded:'{_pinsLoaded}',PushpinSymbol:'{PunchItem.PushpinSymbol}',CategoryAbbreviation:'{PunchItem.CategoryAbbreviation}',ListTypeID:'{PunchItem.ListTypeID}',_forceUpdatePins:'{_forceUpdatePins}'},get:function(a){this.getView().lookupController().updatePins(a)}},saveDisabled:function(a){var d=a('PunchItem'),b=a('valid'),e=a('unsaved'),c=d?e?!b:!a('hasChanges')||!b:!0;return c},hasChanges:function(a){var d=a('PunchItem'),e=a('dirty'),b=!!(a('_photosDataChanged')>0||a('_filesDataChanged')>0||a('_pinsDataChanged')>0||a('followersChanged')||a('assigneesDirty')),c=d?e||b:!1;return c},valid:function(a){return a('recordValid')&&a('assigneeSelection').length&&a('punchItemDescriptionValid')},_triggerPhotoSet:function(g){var b=this.getView(),f=g('photos');if(f&&b.photos){var d=[];for(var c=0;c<b.photos.length;c++){var a=Ext.clone(b.photos[c].getData());if(b.photos[c].$className!='mdsData.model.Photo'){a.Type=a.UDEFPhotoUID?'U':a.WebcamPhotoUID?'W':'P';a.Identifier=a.id.substr(1,a.id.length-1);a.ImageURLMedium=a.med||a.ImageURL;a.PhotoDate=a.PhotoDate||a.dateTaken}var e=Ext.create('mdsData.model.Photo',a);e.phantom=!0;d.push(e)}f.add(d)}},followDisabled:function(a){return !!(a('isOwner')||a('userFollowerModel.IsAssignee'))},followControlsVisible:function(a){return a('followersLoaded')&&a('canEdit')},assigneeSelection:function(a){if(!a('assigneesLoaded')&&!a('assigneesChanged')){return []}return a('assignees').query('IsAssignee',!0).items},assigneeCollection:function(a){return Ext.create('Ext.data.Store',{data:a('assigneeSelection')})},categoryButtonText:function(a){return a('PunchItem.PunchlistCategoryID')?mvstr['TL_Change']:mvstr['TL_Add']},locationButtonText:function(a){return a('PunchItem.PlanList')?mvstr['TL_Change']:mvstr['TL_Add']},initialPunchlistCategoryID:function(a){return null},initialPunchlistLocation:function(a){return null},initialPunchlistDueDate:function(c){var a=new Date(),b=0,d=Ext.Date.weekendDays;while(b<5){a=Ext.Date.add(a,Ext.Date.DAY,1);if(Ext.Array.indexOf(d,a.getDay())==-1){b++}}return c('punchlistDueDateChanged')||!c('unsaved')?null:a},ListItemDesc:function(b){var a=b('ListTypeID');return a?mvstr['TL_ListItemDesc_'+a]:mvstr['TL_ListItemDesc']},doneAndNewHidden:function(a){return !(app.getName()=='clientPunchlistEntry'&&!Ext.Object.fromQueryString(document.location.search).PunchItemID)},cloneOptionAvailable:function(a){return !a('doneAndNewHidden')}},stores:{punchstatus:{type:'punchstatus'},workstatus:{type:'workstatus'},categories:{autoLoad:!0,model:'clientPunchlist.model.PunchlistCategory',proxy:{type:'ajax',reader:{type:'json'},writer:{writeAllFields:!1,allowSingle:!1},api:{create:'/index.cfm?fuseaction=aClientPunchlist.createProjectPunchlistCategories',read:'/index.cfm?fuseaction=aClientPunchlist.getProjectPunchlistCategories',update:'/index.cfm?fuseaction=aClientPunchlist.updateProjectPunchlistCategories',destroy:'/index.cfm?fuseaction=aClientPunchlist.deleteProjectPunchlistCategories'},extraParams:{ProjectUID:'{ProjectUID}'}},sorters:[{property:'CategoryLabel',direction:'ASC'}],mvAutoLoadVars:!0},assignees:{model:'clientPunchlist.model.Assignee',autoLoad:!0,sorters:[{property:'AssigneeLastName',direction:'ASC'},{property:'AssigneeFirstName',direction:'ASC'}],proxy:{api:{read:'/index.cfm?fuseaction=aClientPunchlist.getProjectPunchlistAssignees',update:'/index.cfm?fuseaction=aClientPunchlist.updatePunchItemAssignees'},extraParams:{ProjectUID:'{ProjectUID}',PunchItemID:'{PunchItemID}'},writer:{writeAllFields:!1}},listeners:{update:'onAssigneesUpdate',add:'onAssigneesUpdate',remove:'onAssigneesUpdate',load:'onAssigneesLoad'}},assigneeSelectionStore:{model:'clientPunchlist.model.Assignee',proxy:{type:'memory'}},punchplans:{autoLoad:!0,model:'mdsData.model.Floorplan',PinnedLocations:[],proxy:{api:{read:'/index.cfm?fuseaction=aClientPunchlist.getProjectPunchlistPlans'},extraParams:{ProjectUID:'{ProjectUID}',ListTypeID:'{ListTypeID}'}}},files:{type:'files',proxy:{api:{create:'/index.cfm?fuseaction=aClientPunchlist.addDocumentsToPunchItem',read:'/index.cfm?fuseaction=aClientPunchlist.getPunchItemDocuments',update:'/index.cfm?fuseaction=aClientPunchlist.addDocumentsToPunchItem',destroy:'/index.cfm?fuseaction=aClientPunchlist.removeDocumentsFromPunchItem'},extraParams:{PunchItemID:'{PunchItemID}',ProjectUID:'{ProjectUID}'}},autoLoad:!1,allowAutoSave:!1,mvAutoDataChangedVar:!0},photos:{model:'mdsData.model.Photo',proxy:{api:{create:'/index.cfm?fuseaction=aClientPunchlist.addPhotosToPunchItem',read:'/index.cfm?fuseaction=aClientPunchlist.getPunchItemPhotos',destroy:'/index.cfm?fuseaction=aClientPunchlist.removePhotosFromPunchItem'},extraParams:{PunchItemID:'{PunchItemID}',ProjectUID:'{ProjectUID}'}},autoLoad:!1,allowAutoSave:!1,mvAutoDataChangedVar:!0,mvAutoLoadVars:!0},pins:{model:'mdsData.model.Pushpin',proxy:{api:{read:'/index.cfm?fuseaction=aClientPunchlist.getPunchItemPins',create:'/index.cfm?fuseaction=aClientPunchlist.addPunchPinsToPunchItem',destroy:'/index.cfm?fuseaction=aClientPunchlist.deletePunchPins'},extraParams:{ProjectUID:'{ProjectUID}',PunchItemID:'{PunchItemID}'}},listeners:{add:{fn:function(a){this.getViewModel().set('_forceUpdatePins',(new Date()).getTime())},scope:'controller'},scope:'controller'},mvAutoLoadVars:!0,mvAutoDataChangedVar:!0},followers:{model:'clientPunchlist.model.Follower',autoLoad:!0,proxy:{api:{read:'/index.cfm?fuseaction=aClientPunchlist.getPunchItemFollowers',update:'/index.cfm?fuseaction=aClientPunchlist.updatePunchItemFollowers'},writer:{allowSingle:!1},extraParams:{ProjectUID:'{ProjectUID}',PunchItemID:'{PunchItemID}'}},listeners:{update:'onFollowersUpdate',load:'onFollowersLoad'}}}},0,0,0,0,['viewmodel.punchitemdetail'],0,[clientPunchlist.view.detailForm,'DetailFormModel'],0);Ext.cmd.derive('clientPunchlist.view.detailForm.FileList',Ext.view.View,{cls:'documentList',border:!0,padding:0,itemSelector:'.document',bind:{store:'{files}'},scrollable:{x:'auto',y:!1},initRefresh:!1,focusable:!1,style:'white-space: nowrap;',tpl:['<tpl for=".">','<div class="document fileviewer-item">','<div class="remove-button"></div>','<img src="{DocumentSymbolLarge}">','<div class="details">','{DocumentFilename}','</div>','</div>','</tpl>'],getMaskTarget:function(){return this.up().el}},0,['detailformfilelist'],['component','box','dataview','detailformfilelist'],{'component':!0,'box':!0,'dataview':!0,'detailformfilelist':!0},['widget.detailformfilelist'],0,[clientPunchlist.view.detailForm,'FileList'],0);Ext.cmd.derive('clientPunchlist.view.template.PinnedLocation',Ext.Base,{singleton:!0,constructor:function(){this.interactive=Ext.create('Ext.XTemplate','<tpl for=".">','<div class="punchPinCover">','<tpl if="this.isSaved(values)">','<a href="{mdslink_clientFloorplanViewer_punchlistPlan}ProjectUID={ProjectUID}','&FloorplanUID={FloorplanUID}&pushpinUID={PushpinUID}&ListTypeID={ListTypeID}">','</tpl>','<div class="punchPinCoverImage"',' style="background-image: url({floorplanImage}); background-position: {[this.getOffset(values)]}; background-repeat: no-repeat">','{[this.getPin(values)]}<div class="remove-button"></div></div>','<div class="floorplanCoverLabel"><span>{LocationName}</span></div>','<tpl if="this.isSaved(values)">','</a>','</tpl>','</div>','</tpl>',{getOffset:this.getOffset,getPin:this.getPin,isSaved:this.isSaved});this.readOnly=Ext.create('Ext.XTemplate','<tpl for=".">','<div class="punchPinCover">','<img src="{PunchPinOverviewURL}">','<img src="{PunchPinZoomURL}">','<div class="floorplanCoverLabel"><span>{LocationName}</span></div>','</div>','</tpl>',{getOffset:this.getOffset,getPin:this.getPin,isSaved:this.isSaved});this.callParent(arguments)},getOffset:function(a){var b=-1*a.PushpinXCoordinate+133;var c=-1*a.PushpinYCoordinate+133;return b+'px '+c+'px'},getPin:function(a){return mdsData.FloorplanValues.iconTemplate.apply(floorplanList.PlanUtil.getPinValuesFromFeature({properties:{PunchItemID:a.PunchItemID,PushpinSymbol:a.PushpinSymbol,TextOverlay:a.TextOverlay}}))},isSaved:function(a){return customData.Util.isUUID(a.PushpinUID)}},1,0,0,0,0,0,[clientPunchlist.view.template,'PinnedLocation'],0);Ext.cmd.derive('clientPunchlist.view.location.PinnedLocationsDataView',Ext.view.View,{cls:'pinned-locations-view',itemSelector:'.punchPinCover',tpl:clientPunchlist.view.template.PinnedLocation.interactive},0,['pinnedlocationsdata'],['component','box','dataview','pinnedlocationsdata'],{'component':!0,'box':!0,'dataview':!0,'pinnedlocationsdata':!0},['widget.pinnedlocationsdata'],0,[clientPunchlist.view.location,'PinnedLocationsDataView'],0);Ext.cmd.derive('clientPunchlist.view.location.PinnedLocations',Ext.form.Panel,{fieldDefaults:{labelWidth:100},ui:'detail-form',layout:{type:'vbox'},viewModel:{formulas:{loading:function(a){return !a('unsaved')?!a('_pinsLoaded'):!1}}},bodyPadding:5,border:!0,tbar:{ui:'detail-form',items:[{xtype:'component',cls:'x-panel-header-title-detail-form',localized:{html:'TL_Pinned Locations'},margin:'0 0 0 15'},'->',{xtype:'button',ui:'orange',scale:'large',localized:{text:'TL_Add Pin'},minWidth:104,margin:'0 15 0 0',bind:{hidden:'{!canEdit}'},listeners:{click:'addPunchPinToPlan'}}]},items:[{xtype:'container',width:'100%',layout:{type:'auto'},items:{xtype:'pinnedlocationsdata',reference:'pinnedLocationsDataview',listeners:{itemclick:'deletePunchPin'},bind:{store:'{pins}'}}}],bind:{loading:'{loading}'}},0,['punchItemLocations'],['component','box','container','panel','form','punchItemLocations'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'punchItemLocations':!0},['widget.punchItemLocations'],0,[clientPunchlist.view.location,'PinnedLocations'],0);Ext.cmd.derive('clientPunchlist.view.punchlist.PunchlistController',Ext.app.ViewController,{filters:{statusFilters:{arr:[],fieldName:'PunchStatusID',filterFieldName:'PunchStatusID',fn:function(a){var b=this.getViewModel().get('ClosedItemsVisible');if((!this.filters.statusFilters.arr.length||Ext.Array.contains(this.filters.statusFilters.arr,a.get('PunchStatusID')))&&(b||a.get('PunchStatusID')!=mdsData.PunchlistValues.PUNCH_STATUS.CLOSED)){return !0}return !1}},categoryFilters:{arr:[],fieldName:'PunchlistCategoryID',filterFieldName:'PunchlistCategoryID'},locationFilters:{arr:[],filterFieldName:'FilterValue',fn:function(c){var b=c.get('PunchlistPlans');for(var a=0;a<b.length;a++){if(Ext.Array.contains(this.filters.locationFilters.arr,b[a].PunchlistPlanDescription)){return !0}}return !1}},assigneeFilters:{arr:[],filterFieldName:'AssigneeID',fn:function(c){var b=c.get('Assignees'),d=this.filters.assigneeFilters.arr;for(var a=0;a<b.length;a++){if(Ext.Array.contains(d,b[a].AssigneeID)){return !0}}return !1}},workStatusFilters:{arr:[],filterFieldName:'WorkStatusID',fieldName:'WorkStatusID'}},imgArray:[],loadedImgCount:0,punchitemsLoaded:function(h){var c=[],d=[],f=!1;for(var b=0;b<h.count();b++){f=!1;var e=h.getAt(b),l=e.get('PunchlistCategoryID'),o=mvstr['TLC_'+l]||e.get('CategoryLabel');for(var a=0;a<c.length;a++){if(c[a].CategoryLabel==o){f=!0;break}}if(!f){c.push({CategoryLabel:o,PunchlistCategoryID:l})}f=!1;var g=h.getAt(b).get('PunchlistPlans');if(g.length){for(var a=0;a<g.length;a++){if(!Ext.Array.contains(d,g[a].PunchlistPlanDescription)){d.push(g[a].PunchlistPlanDescription)}}}}var k=[];for(var s in d){k.push({FilterValue:d[s]})}this.getStore('categories').setData(c);this.getStore('locations').setData(k);var j=this.getViewModel(),m=j.get('punchitems'),r=m.getCount(),p=[],q=[];for(var b=0;b<r;b++){var e=m.getAt(b),i=e.get('Assignees');for(var a=0;a<i.length;a++){var n=clientPunchlist.model.Assignee.fieldsMap.Assignee.calculate(i[a]);if(!Ext.Array.contains(p,n)){p.push(n);q.push(i[a])}}}j.get('assignees').loadRawData(q);j.set('punchitemsStoreLoaded',!0)},updateFilter:function(d,b,e){var a=d.reference;if(b.get('isSelected')){this.filters[a].arr.push(b.get(this.filters[a].filterFieldName))}else {var c=this.filters[a].arr.indexOf(b.get(this.filters[a].filterFieldName));if(c>-1){this.filters[a].arr.splice(c,1)}}this.filterGrid()},onClearFiltersClick:function(){analytics.Ctrl.log('Cleared All Filters');for(var c in this.filters){this.filters[c].arr=[]}var b=Ext.ComponentQuery.query('filter');for(var a=0;a<b.length;a++){b[a].clearSelected()}this.filterGrid()},nonEmptyFilterExists:function(){for(var a in this.filters){if(this.filters[a].arr.length){return !0}}return !!this.searchValue},filterGrid:function(b){var a=this.getViewModel().getStore('punchitems');a.clearFilter();if(this.nonEmptyFilterExists()||this.getViewModel().get('ClosedItemsLoaded')&&!this.getViewModel().get('ClosedItemsVisible')){a.filter({filterFn:Ext.bind(function(a){for(var c in this.filters){if(c=='statusFilters'){if(!this.filters[c].fn.call(this,a)){return !1}}else {if(this.filters[c].arr.length){if(this.filters[c].fn){if(!this.filters[c].fn.call(this,a)){return !1}}else {if(!Ext.Array.contains(this.filters[c].arr,a.get(this.filters[c].fieldName))){return !1}}}}}if(!this.searchValue){return !0}var d=a.get('Description').toLowerCase(),g=a.get('PlanList').toLowerCase(),i=a.get('LocationDetail').toLowerCase(),f=a.get('AssigneeList').toLowerCase(),h=a.get('CreatorName').toLowerCase(),e=new Date(this.searchValue);return !!(mdsData.PunchlistValues.WORK_STATUS_LABELS[a.get('WorkStatusID')].toLowerCase()==this.searchValue||mdsData.PunchlistValues.PUNCH_STATUS_LABELS[a.get('PunchStatusID')].toLowerCase()==this.searchValue||a.get('ProjectPunchItemID')==this.searchValue||a.get('CategoryLabel').toLowerCase()==this.searchValue||a.get('CategoryAbbreviation').toLowerCase()==this.searchValue||d&&d.indexOf(this.searchValue)!=-1||g&&g.indexOf(this.searchValue)!=-1||i&&i.indexOf(this.searchValue)!=-1||f&&f.indexOf(this.searchValue)!=-1||h&&h.indexOf(this.searchValue)!=-1||Ext.Date.diff(e,a.get('DueDate'),Ext.Date.DAY)==0||Ext.Date.diff(e,a.get('CompletionDate'),Ext.Date.DAY)==0)},this)})}},onAddPinToExistingClick:function(c){var a=this.lookupReference('punchItemGrid').getSelection()[0].getData(),b=this.getViewModel().get('pinDescription');a.IsNewItem=0;if(b=='Pin'){app.fireEvent('startaddpunchpin',a)}else {if(b=='Photo'){app.fireEvent('startaddphototopunchitem',a)}}c.up('punchlistwindow').destroy()},loadImage:function(b){var a=new Image();a.onload=Ext.bind(this.imgOnLoad,this);a.onerror=Ext.bind(this.imgOnLoad,this);a.src=b},imgOnLoad:function(){this.loadedImgCount++;if(this.loadedImgCount==this.imgArray.length){this.onImagesReady()}},onImagesReady:Ext.emptyFn},0,0,0,0,['controller.punchlist'],0,[clientPunchlist.view.punchlist,'PunchlistController'],0);Ext.cmd.derive('clientPunchlist.view.punchlist.PunchlistModel',Ext.app.ViewModel,{data:{SNID1:'',SNID2:'',SAID1:'',SAID2:'',onTaskList:!1},stores:{punchstatus:{type:'punchstatus'},workstatus:{type:'workstatus'},punchitems:{type:'punchitems',autoLoad:!0,listeners:{load:'punchitemsLoaded'},proxy:{extraParams:{ProjectUID:'{ProjectUID}',ListTypeID:'{ListTypeID}',PunchStatusID:'{PunchStatusID}',SNID1:'{SNID1}',SNID2:'{SNID2}',SAID1:'{SAID1}',SAID2:'{SAID2}',onTaskList:'{onTaskList}'}}},locations:{fields:['FilterValue'],proxy:{type:'memory'},sorters:[{sorterFn:function(a,b){if(a.get('FilterValue')<b.get('FilterValue')){return -1}if(a.get('FilterValue')>b.get('FilterValue')){return 1}return 0}}]},categories:{fields:['FilterValue'],proxy:{type:'memory'},sorters:[{sorterFn:function(a,b){if(a.get('FilterValue')<b.get('FilterValue')){return -1}if(a.get('FilterValue')>b.get('FilterValue')){return 1}return 0}}]},assignees:{model:'clientPunchlist.model.Assignee',proxy:{type:'memory'}}},formulas:{ListTypeName:function(a){return a('ListTypeNameLong')},ListTypeNameLong:function(b){var a=b('ListTypeID');return a?mvstr['TL_Name_'+a]:''}}},0,0,0,0,['viewmodel.punchlist'],0,[clientPunchlist.view.punchlist,'PunchlistModel'],0);Ext.cmd.derive('planGrid.model.Project',Ext.data.Model,{fields:[{name:'uid',type:'string'},{name:'name',type:'string'}],idProperty:'uid'},0,0,0,0,0,0,[planGrid.model,'Project'],0);Ext.cmd.derive('planGrid.model.RFI',Ext.data.Model,{fields:[{name:'uid',type:'string'},{name:'number',type:'int'},{name:'title',type:'string'},{name:'displayField',type:'string',calculate:function(a){return '#'+a.number+' - '+a.title}},{name:'status'},{name:'statusLabel',convert:function(b,a){return a.get('status').label}}],idProperty:'uid'},0,0,0,0,0,0,[planGrid.model,'RFI'],0);Ext.cmd.derive('planGrid.model.RFIStatus',Ext.data.Model,{fields:[{name:'uid',type:'string'},{name:'color',type:'string'},{name:'label',type:'string'},{name:'name',type:'string',calculate:function(b){var a=b.label||'unnamed';return a.charAt(0).toUpperCase()+a.slice(1)}}],idProperty:'uid'},0,0,0,0,0,0,[planGrid.model,'RFIStatus'],0);Ext.cmd.derive('planGrid.model.User',Ext.data.Model,{fields:[{name:'uid',type:'string'},{name:'first_name',type:'string'},{name:'last_name',type:'string'},{name:'displayField',type:'string',calculate:function(a){var b=[];if(a.first_name){b.push(a.first_name)}if(a.last_name){b.push(a.last_name)}return b.join(' ')}}],idProperty:'uid'},0,0,0,0,0,0,[planGrid.model,'User'],0);Ext.cmd.derive('planGrid.store.RFIs',Ext.data.Store,{model:'planGrid.model.RFI',proxy:{url:'/index.cfm?fuseaction=aPlanGrid.getRFIs'},changeFilterValue:function(a){this.clearFilter();this.filter({filterFn:function(b){return b.get('status')==a}})}},0,0,0,0,0,0,[planGrid.store,'RFIs'],0);Ext.cmd.derive('planGrid.view.plangridwindow.PlanGridWindowModel',Ext.app.ViewModel,{stores:{planGridProjects:{model:'planGrid.model.Project',proxy:{url:'/index.cfm?fuseaction=aPlanGrid.getProjects'},autoLoad:!0,listeners:{load:'onProjectsLoad'}},integrationEntityTypes:{proxy:{type:'memory'},model:'formShared.model.IntegrationEntityType',data:[{id:'Document',name:'Document',createAction:'uploadDocuments'}]},planGridProjectUsers:{model:'planGrid.model.User',proxy:{url:'/index.cfm?fuseaction=aPlanGrid.getProjectUsers'}}},data:{private_planGridSetting_projectID:null,private_planGridSetting_entityType:null,private_planGridSetting_attachAsPhoto:null,private_planGridSetting_attachAs4View:null,private_planGridSetting_rfiAssignee:null,planGridSetting_rfiStatus:null,singlePhotoTitle:'',entityID:'',planGridUserID:0,entityStoreLoaded:!1,cardHeight:312,warningHeight:0,saving:!1,saveDone:!1,errorMessage:'',showAlertMessage:!1,rfiSentDate:null,rfiDueDate:null,projectsLoaded:!1,attachFloorplanOnly:!1},formulas:{planGridSetting_projectID:{get:function(b){var a=b('private_planGridSetting_projectID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getPlanGridSetting_projectID()},set:function(a){this.set('private_planGridSetting_projectID',a);mdsPreferences.ProjectPreferences.setPlanGridSetting_projectID(a)}},planGridSetting_entityType:{get:function(b){var a=b('private_planGridSetting_entityType'),c=b('integrationEntityTypes');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}a=mdsPreferences.ProjectPreferences.getPlanGridSetting_entityType();if(!c||c.find('id',a)==-1){return null}return a},set:function(a){this.set('private_planGridSetting_entityType',a);mdsPreferences.ProjectPreferences.setPlanGridSetting_entityType(a)}},planGridSetting_attachAsPhoto:{get:function(c){var a=c('private_planGridSetting_attachAsPhoto');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getPlanGridSetting_attachAsPhoto();return b===undefined?!1:b},set:function(a){this.set('private_planGridSetting_attachAsPhoto',a);mdsPreferences.ProjectPreferences.setPlanGridSetting_attachAsPhoto(a)}},planGridSetting_attachAs4View:{get:function(c){var a=c('private_planGridSetting_attachAs4View');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getPlanGridSetting_attachAs4View();return b===undefined?!0:b},set:function(a){this.set('private_planGridSetting_attachAs4View',a);mdsPreferences.ProjectPreferences.setPlanGridSetting_attachAs4View(a)}},planGridSetting_rfiAssignee:{get:function(b){var a=b('private_planGridSetting_rfiAssignee');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getPlanGridSetting_rfiAssignee()},set:function(a){this.set('private_planGridSetting_rfiAssignee',a);mdsPreferences.ProjectPreferences.setPlanGridSetting_rfiAssignee(a)}},entityType:function(a){return a('integrationEntityTypes').getById(a('planGridSetting_entityType'))},entity:function(a){var d=a('private_planGridSetting_entityType'),c=a('planGridUserID');if(!d||!c){return null}var b=a('entityStore');if(!b){return null}return b.getById(a('entityID'))},projectSelected:function(a){return a('projectsLoaded')&&a('planGridSetting_projectID')},multiplePhotosSelected:function(a){return this.getView().getPhotos().length>1},calculatedEntityID:function(a){return a('entityID')},submitReady:function(b){var a=b('entityType');if(!a){return !1}return !0},entityStoreID:function(b){var a=b('entityType'),c=b('planGridSetting_projectID');if(!a){return null}var d='planGrid_'+a.get('name').replace(' ','')+'_'+c;return d},entityStore:function(a){var h=a('entityType'),f=a('planGridUserID'),d=a('entityStoreType');if(!h||!f||!d){return Ext.create('Ext.data.Store',{proxy:'memory'})}var g=a('entityType').getId(),e=a('entityStoreID'),b=Ext.getStore(e),c=this.getView().lookupController();if(!b&&a('planGridSetting_projectID')){b=Ext.create(d,{storeId:e,autoLoad:!0,proxy:{extraParams:c.getEntityStoreParams(g)},listeners:{load:c.onEntityStoreLoad,scope:c}})}if(b){this.set('entityStoreLoaded',b.isLoaded())}return b},entityStoreType:function(c){var a=c('entityType');if(!a){return null}var b=a.get('storeType');if(!b){return null}return b},card:function(d){var a=this.getView().lookupController(),b=d('private_planGridSetting_entityType'),e=d('planGridSetting_projectID'),c=a.lookupReference('card_default');return e?a.lookupReference('card_'+b)||a.lookupReference('card_'+b)||c:c},itemDescription:function(a){return 'item'},lowercaseEntityName:function(c){var a=c('entityType');if(!a){return ''}var b=a.get('name');return b.toLowerCase()},emptyText:function(a){var b=a('entityStore'),c=a('entityStoreLoaded');if(a('submitReady')||!b||!c||b.getCount()){return '- Select -'}return 'No '+a('itemDescription')+'s available.'},noItemsAvailable:function(a){var b=a('entityStore'),c=a('entityStoreLoaded');return !(a('submitReady')||!b||!c||b.getCount())},warningMessage:function(a){var e=a('entityStore'),f=a('entityStoreLoaded'),h=a('entityType'),d=a('errorMessage'),b='',c=a('entityStoreType'),g=!!(a('showAlertMessage')||d);if(!g||a('submitReady')||c&&!e||c&&!f){b=''}else {if(c&&!e.getCount()){b='You cannot complete the '+a('lowercaseEntityName')+' submission because there are no '+a('itemDescription')+'s to select.'}else {if(c&&!a('calculatedEntityID')){b='You cannot complete the export process until you have selected a'+(a('itemDescription')=='item'?'n':'')+' '+a('itemDescription')+'.'}else {if(h.getId()=='Photo'&&!a('multiplePhotosSelected')&&!a('planGridPhotoPhotoTitle.value')){b='You cannot complete the export process until you have chosen a title'}else {if(!a('planGridSetting_attachAsPhoto')&&!a('planGridSetting_attachAs4View')){b='You cannot complete the export process until you have chosen what files to attach.'}}}}}if(b){this.set('errorMessage','')}else {this.set('warningHeight',0);if(d){b=d}}if(!b){this.set('showAlertMessage',!1)}return b},windowHeight:function(a){return a('cardHeight')+a('warningHeight')},planGridUsers:function(d){var a=d('planGridSetting_projectID');if(!a){return Ext.create('Ext.data.Store',{proxy:{type:'memory'}})}var b='planGridUsers-'+a,c=Ext.getStore(b);return c||Ext.create('Ext.data.Store',{model:'planGrid.model.User',proxy:{url:'/index.cfm?fuseaction=aPlanGrid.getProjectUsers',extraParams:{project_id:a}},mvAutoLoadVars:!0,autoLoad:!0,storeId:b})},planGridRFIStatuses:function(d){var a=d('planGridSetting_projectID');if(!a){return Ext.create('Ext.data.Store',{proxy:{type:'memory'}})}var b='planGridRFIStatuses-'+a,c=Ext.getStore(b);return c||Ext.create('Ext.data.Store',{model:'planGrid.model.RFIStatus',proxy:{url:'/index.cfm?fuseaction=aPlanGrid.getProjectRFIStatuses',extraParams:{project_id:a}},mvAutoLoadVars:!0,autoLoad:!0,storeId:b})}}},0,0,0,0,['viewmodel.planGridwindow'],0,[planGrid.view.plangridwindow,'PlanGridWindowModel'],0);Ext.cmd.derive('planGrid.view.plangridwindow.PlanGridWindowController',Ext.app.ViewController,{init:function(){var a=this.getViewModel();var b=a.bind({planGridUserID:'{planGridUserID}',projectsLoaded:'{projectsLoaded}'},function(a){if(a.projectsLoaded&&a.planGridUserID){this.onReady();b.destroy()}},this);a.bind('{card}',this.onCardChange,this);a.bind('{windowHeight}',this.onWindowHeightChange,this);a.bind({multiplePhotosSelected:'{multiplePhotosSelected}',ProjectUID:'{ProjectUID}'},function(c){var d=this.getView().getPhotos(),b=this.getView().getFileTitle();a.set('singlePhotoTitle',b);if(!c.multiplePhotosSelected&&!b){Ext.Ajax.request({url:'/index.cfm?fuseaction=aPlanGrid.getPhotoTitle',params:{ProjectUID:c.ProjectUID,photos:d[0]},successCallback:function(b){a.set('singlePhotoTitle',b)}})}},this);Ext.Ajax.request({url:'/index.cfm?fuseaction=aPlanGrid.getUser',successCallback:function(a){this.getViewModel().set('planGridUserID',a.uid)},afterFailMessageCallback:function(){this.getView().destroy()},scope:this});Ext.defer(function(){this.getView().showBy(Ext.getBody(),'t-t?',[0,this.getWindowY(Ext.getBody().getHeight())],!1)},1,this);Ext.getBody().addListener('resize',function(b,a){this.getView().setPosition(this.getWindowX(a.width),this.getWindowY(a.height),!1,!0)},this,{buffer:200})},onBoxReady:function(){this.lookupReference('cards').setLoading(!0)},getWindowX:function(a){return Math.max(0,(a-this.getView().el.getWidth())/2)},getWindowY:function(a){var b=(a-699)/2,c=this.getView().el.getHeight();if(b+c>a){b=(a-c)/2}return Math.max(0,b)},onReady:function(){var a=this.getViewModel().get('planGridSetting_projectID');if(a){this.lookupReference('projects').setValue(a)}this.lookupReference('cards').setLoading(!1)},onProjectChange:function(b,a){if(a){this.getViewModel().set('planGridSetting_projectID',a)}else {this.getViewModel().set('entityID','')}this.getViewModel().set('showAlertMessage',!1)},getEntityStoreId:function(c){var a=this.getStore('integrationEntityTypes').getById(c),d=this.getViewModel().get('planGridSetting_projectID');var b='planGrid_'+a.get('name').replace(' ','')+'_'+d;if(a.get('subCreateActions')){b+='_'+this.getViewModel().get('subType')}return b},getEntityStoreParams:function(c){var a=this.getViewModel(),b={project_id:a.get('planGridSetting_projectID')};if(a.get('planGridSetting_entityType')=='DailyLog'){b.log_date=Ext.Date.format(a.get('dailyLogDate'),'Y-m-d')}return b},getCreateAction:function(){var a=this.getStore('integrationEntityTypes').getById(this.getViewModel().get('planGridSetting_entityType')),c=this.getViewModel().get('subType'),b=a.get('subCreateActions');return b?a.get('subCreateActions')[c]:a.get('createAction')},getSubmitParams:function(){var b=this.getViewModel(),e=this.getView().getPhotos(),h=b.get('calculatedEntityID'),d=b.get('planGridSetting_entityType'),c=b.get('card'),f=b.get('entity'),g=f?f.get('displayField'):'',a={ProjectUID:b.get('ProjectUID'),photos:e.join(','),project_id:b.get('private_planGridSetting_projectID'),uid:h,dateString:Ext.Date.format(new Date(),'ymd'),includeAnnotations:this.getView().getIncludeAnnotations(),displayName:g,projectName:b.get('planGridProjects').getById(b.get('planGridSetting_projectID')).get('name')};if(d=='Photo'&&e.length==1){a.title=this.lookupReference('planGridPhotoPhotoTitle').getValue()}else {if(d=='Document'&&e.length==1){a.title=this.lookupReference('planGridDocumentPhotoTitle').getValue()}else {if(d=='CreateRFI'){a.question=c.down('#comments').getValue();a.title=this.lookupReference('planGridNewRFITitle').getValue();if(b.get('rfiDueDate')){a.dueDate=Ext.Date.dateFormat(b.get('rfiDueDate'),'C')}if(b.get('rfiSentDate')){a.sentDate=Ext.Date.dateFormat(b.get('rfiSentDate'),'C')}if(b.get('planGridSetting_rfiStatus')){a.status=b.get('planGridSetting_rfiStatus')}if(b.get('planGridSetting_rfiAssignee')){a.assignees=b.get('planGridSetting_rfiAssignee').join()}}}}if(d!='Photo'){a.attachAsPhoto=c.down('#attachPhoto').getValue();a.attachAs4View=c.down('#attachDetails').getValue()}a.attachAsFloorplan=this.getViewModel().get('attachFloorplanOnly');if(a.attachAsFloorplan){a.attachAsPhoto=a.attachAs4View=!1;a.FloorplanUID=b.get('FloorplanUID');a.displayHeader=c.down('#headerCheckbox').getValue();a.displayHotspots=c.down('#hotspotsCheckbox').getValue();a.displayPushpins=c.down('#pushpinsCheckbox').getValue();a.title=this.lookupReference('planGridDocumentPhotoTitle').getValue()}return a},submitPhotos:function(){var a=this.getViewModel();if(!a.get('submitReady')){a.set('showAlertMessage',!0);return}a.set('showAlertMessage',!1);a.set('saving',!0);if(a.get('subType')=='CreateNewAlbum'){this.createNewAlbum();return}var b=this.getSubmitParams();var c=a.get('account.features.uploadscenterVisible');b.asynchronous=c;Ext.Ajax.request({url:'/index.cfm?fuseaction=aPlanGrid.'+this.getCreateAction(),params:b,successCallback:function(d){if(c){window.app.fireEvent('reloadfileuploads',{sourceType:'integration',responseData:d,photos:b.photos.split(',')})}else {a.set('saveDone',!0)}if(d&&d.callback){d.callback()}Ext.defer(function(){this.getView().destroy()},1000,this)},afterFailMessageCallback:function(c,b){a.set('saving',!1);a.set('errorMessage',b?b:mvstr.G_UnexpectedError)},noAlert:!0,scope:this});this.logExportAnalyticsEvent(b)},logExportAnalyticsEvent:function(a){if(a.attachAsFloorplan){analytics.Ctrl.log('Exported Floorplan',{'Floorplan UID':a.FloorplanUID,'Integration':'Procore'})}else {var b='Photo Viewer Menu';if(location.href.toLowerCase().indexOf('clientphotolist')!==-1){b='Photo List Menu'}analytics.Ctrl.log('Exported Photo',{'Photo List':a.photos,'Photo Action Element':b,'Integration':'Procore'})}},onCardChange:function(a){if(a){this.lookupReference('cards').setActiveItem(a);this.getViewModel().set('cardHeight',a.getWindowHeight())}this.getViewModel().set('showAlertMessage',!1)},onWarningResize:function(a){this.getViewModel().set('warningHeight',a.el.getHeight())},onEntityStoreLoad:function(a){if(a==this.getViewModel().get('entityStore')){this.getViewModel().set('entityStoreLoaded',!0)}},onWindowHeightChange:function(a){this.getView().setHeight(a)},onProjectsLoad:function(){this.getViewModel().set('projectsLoaded',!0)}},0,0,0,0,['controller.planGridwindow'],0,[planGrid.view.plangridwindow,'PlanGridWindowController'],0);Ext.cmd.derive('planGrid.view.cards.Default',Ext.Container,{config:{windowHeight:312},reference:'card_default'},0,['plangriddefault'],['component','box','container','plangriddefault'],{'component':!0,'box':!0,'container':!0,'plangriddefault':!0},['widget.plangriddefault'],0,[planGrid.view.cards,'Default'],0);Ext.cmd.derive('planGrid.view.form.User',formShared.view.components.ComboMultiselect,{width:'100%',fieldLabel:'Assignee',queryMode:'local',displayField:'displayField',emptyText:'- Select -',valueField:'uid',editable:!1,bind:{store:'{planGridUsers}'}},0,['plangriduser'],['component','box','field','textfield','pickerfield','combobox','combo','tagfield','detailformmulticombo','plangriduser'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'tagfield':!0,'detailformmulticombo':!0,'plangriduser':!0},['widget.plangriduser'],0,[planGrid.view.form,'User'],0);Ext.cmd.derive('planGrid.view.cards.Document',Ext.Container,{reference:'card_Document',layout:'vbox',config:{windowHeight:390},items:[{xtype:'detailformtextfield',reference:'planGridDocumentPhotoTitle',fieldLabel:'Title',emptyText:'Enter title',margin:'0 0 28 0',width:'100%',publishes:'value',hidden:!0,bind:{hidden:'{multiplePhotosSelected}',value:'{singlePhotoTitle}'}},{xtype:'integrationattachment',photoBinding:'{planGridSetting_attachAsPhoto}',pdfBinding:'{planGridSetting_attachAs4View}'}]},0,['plangriddocument'],['component','box','container','plangriddocument'],{'component':!0,'box':!0,'container':!0,'plangriddocument':!0},['widget.plangriddocument'],0,[planGrid.view.cards,'Document'],0);Ext.cmd.derive('planGrid.view.cards.CreateRFI',Ext.Container,{reference:'card_CreateRFI',layout:'vbox',config:{windowHeight:662},items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 18 0',items:[{xtype:'detailformtextfield',width:202,reference:'planGridNewRFITitle',fieldLabel:'Title',emptyText:'Enter title',publishes:'value'},{xtype:'component',flex:1},{xtype:'detailformcombo',width:202,fieldLabel:'Status',emptyText:'- Select -',valueField:'uid',displayField:'name',bind:{store:'{planGridRFIStatuses}',value:'{planGridSetting_rfiStatus}'}}]},{xtype:'plangriduser',margin:'0 0 18 0',bind:{value:'{planGridSetting_rfiAssignee}'}},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 18 0',items:[{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',fieldLabel:'Sent Date',labelSeparator:'',bind:{value:'{rfiSentDate}'}},{xtype:'component',flex:1},{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',fieldLabel:'Due Date',labelSeparator:'',bind:{value:'{rfiDueDate}'}}]},{xtype:'integrationcomments',fieldLabel:'Question'},{xtype:'integrationattachment',photoBinding:'{planGridSetting_attachAsPhoto}',pdfBinding:'{planGridSetting_attachAs4View}'}]},0,['plangridcreaterfi'],['component','box','container','plangridcreaterfi'],{'component':!0,'box':!0,'container':!0,'plangridcreaterfi':!0},['widget.plangridcreaterfi'],0,[planGrid.view.cards,'CreateRFI'],0);Ext.cmd.derive('planGrid.view.cards.ExistingRFI',Ext.Container,{reference:'card_ExistingRFI',layout:'vbox',config:{windowHeight:768},items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 18 0',items:[{xtype:'detailformtextfield',width:202,fieldLabel:'Title',emptyText:'Enter title',publishes:'value'},{xtype:'component',flex:1},{xtype:'detailformcombo',width:202,fieldLabel:'Status',emptyText:'- Select -',valueField:'uid',displayField:'name',bind:{store:'{planGridRFIStatuses}',value:'{planGridSetting_rfiStatus}'}}]},{xtype:'plangriduser',margin:'0 0 18 0',bind:{value:'{planGridSetting_rfiAssignee}'}},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 18 0',items:[{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',fieldLabel:'Sent Date',labelSeparator:'',bind:{value:'{rfiSentDate}'}},{xtype:'component',flex:1},{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',fieldLabel:'Due Date',labelSeparator:'',bind:{value:'{rfiDueDate}'}}]},{xtype:'integrationcomments',margin:'0 0 18 0',fieldLabel:'Question'},{xtype:'integrationcomments',margin:'0 0 18 0',itemId:'answer',fieldLabel:'Answer'},{xtype:'integrationattachment',photoBinding:'{planGridSetting_attachAsPhoto}',pdfBinding:'{planGridSetting_attachAs4View}'}]},0,['plangridexistingrfi'],['component','box','container','plangridexistingrfi'],{'component':!0,'box':!0,'container':!0,'plangridexistingrfi':!0},['widget.plangridexistingrfi'],0,[planGrid.view.cards,'ExistingRFI'],0);Ext.cmd.derive('planGrid.view.plangridwindow.PlanGridWindow',Ext.window.Window,{ui:'orange',cls:'integration-window',modalMaskCls:'dark-mask',viewModel:{type:'planGridwindow'},controller:'planGridwindow',config:{photos:null,includeAnnotations:!0,attachFloorplanOnly:!1,fileTitle:''},updateAttachFloorplanOnly:function(a){this.getViewModel().set('attachFloorplanOnly',a)},width:488,modal:!0,title:'Add to PlanGrid',layout:{type:'fit'},bind:{height:'{windowHeight}',disabled:'{saving}'},dockedItems:[{xtype:'container',reference:'warning',dock:'top',cls:'warning',layout:{type:'hbox',align:'center'},minHeight:41,padding:10,hidden:!0,bind:{hidden:'{!warningMessage}'},listeners:{'resize':'onWarningResize','show':'onWarningResize'},items:[{xtype:'component',flex:1,bind:{html:'<span>{warningMessage}</span>'}}]}],items:[{xtype:'panel',padding:25,layout:'card',reference:'cards',loadMaskCls:'light-load-indicator',dockedItems:[{xtype:'container',dock:'top',layout:'hbox',margin:'0 0 18 0',items:[{xtype:'detailformcombo',width:202,reference:'projects',fieldLabel:'Project',emptyText:'- Select -',queryMode:'local',displayField:'name',valueField:'uid',bind:{store:'{planGridProjects}',value:'{procoreSetting_projectID}'},listeners:{change:'onProjectChange'}},{xtype:'component',flex:1},{xtype:'integrationtype',bind:{value:'{planGridSetting_entityType}',store:'{integrationEntityTypes}',disabled:'{!projectSelected}'}}]},{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},padding:'25 0 0 0',items:[{xtype:'button',scale:'medium',ui:'grey',text:'Cancel',margin:'0 12 0 12',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',bind:{processing:'{saving}',done:'{saveDone}'},margin:'0 12 0 12',listeners:{click:function(){this.lookupController().submitPhotos()}}}]}],items:[{xtype:'plangriddefault'},{xtype:'plangriddocument'},{xtype:'plangridcreaterfi'},{xtype:'plangridexistingrfi'}]}],doRealign:Ext.emptyFn,setPosition:function(c,d,b,a){if(a){return Ext.window.Window.prototype.setPosition.apply(this,arguments)}},listeners:{boxready:'onBoxReady'}},0,['plangridwindow'],['component','box','container','panel','window','plangridwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'plangridwindow':!0},['widget.plangridwindow'],0,[planGrid.view.plangridwindow,'PlanGridWindow'],0);Ext.cmd.derive('procore.model.AssigneeResponse',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'position',type:'int'},{name:'name',type:'string'},{name:'approved',type:'boolean'},{name:'displayField',type:'int',calculate:function(a){return '#'+a.position+' - '+a.name}}]},0,0,0,0,0,0,[procore.model,'AssigneeResponse'],0);Ext.cmd.derive('procore.model.ChangeEvent',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'number',type:'int'},{name:'title',type:'string'},{name:'displayField',type:'string',calculate:function(a){return '#'+a.number+' - '+a.title}}]},0,0,0,0,0,0,[procore.model,'ChangeEvent'],0);Ext.cmd.derive('procore.model.Company',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'is_active',type:'boolean'}]},0,0,0,0,0,0,[procore.model,'Company'],0);Ext.cmd.derive('procore.model.CostCode',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'name',type:'string'}]},0,0,0,0,0,0,[procore.model,'CostCode'],0);Ext.cmd.derive('procore.model.DeliveryLog',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'position',type:'int'},{name:'time_hour',type:'int'},{name:'time_minute',type:'int'},{name:'delivery_from',type:'string'},{name:'dateString',type:'string',calculate:function(a){return formShared.IntegrationsUtil.getDisplayDateString(a)}},{name:'displayField',calculate:function(a){var b='#'+a.position+' - '+a.dateString;if(a.delivery_from){b+=' - '+a.delivery_from}return b}}]},0,0,0,0,0,0,[procore.model,'DeliveryLog'],0);Ext.cmd.derive('procore.model.Location',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'name',type:'string'}]},0,0,0,0,0,0,[procore.model,'Location'],0);Ext.cmd.derive('procore.model.ManpowerLog',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'contact'},{name:'cost_code'},{name:'location'},{name:'num_hours',type:'number'},{name:'num_workers',type:'number'},{name:'position',type:'int'},{name:'contactName',calculate:function(a){return a.contact&&a.contact.name?a.contact.name:''}},{name:'locationName',calculate:function(a){return a.location&&a.location.name?a.location.name:''}},{name:'costCodeName',calculate:function(a){return a.cost_code&&a.cost_code.name?a.cost_code.name:''}},{name:'displayField',calculate:function(a){var b='#'+a.position;if(a.contactName){b+=' - '+a.contactName}if(a.locationName){b+=' - '+a.locationName}if(a.costCodeName){b+=' - '+a.costCodeName}return b}}]},0,0,0,0,0,0,[procore.model,'ManpowerLog'],0);Ext.cmd.derive('procore.model.ManpowerLogsVendorOption',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'name',type:'string'}]},0,0,0,0,0,0,[procore.model,'ManpowerLogsVendorOption'],0);Ext.cmd.derive('procore.model.Meeting',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'position',type:'int'},{name:'title',type:'string'},{name:'meeting_date',type:'string'},{name:'meeting_date_formatted',type:'string',calculate:function(a){return !a.meeting_date?'':Ext.Date.format(Ext.Date.parse(a.meeting_date,'Y-m-d'),'d/m/Y')}},{name:'displayField',type:'string',calculate:function(a){var b=['#'+a.position];if(a.title){b.push(a.title)}if(a.meeting_date_formatted){b.push(a.meeting_date_formatted)}return b.join(' - ')}}]},0,0,0,0,0,0,[procore.model,'Meeting'],0);Ext.cmd.derive('procore.model.NotesLog',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'position',type:'int'},{name:'location'},{name:'locationName',calculate:function(a){return a.location&&a.location.name?a.location.name:''}},{name:'displayField',mapping:'id'},{name:'dateString',type:'string',calculate:function(a){return formShared.IntegrationsUtil.getDisplayDateString(a)}},{name:'displayField',calculate:function(a){var b='#'+a.position;if(a.locationName){b+=' - '+a.locationName}return b}}]},0,0,0,0,0,0,[procore.model,'NotesLog'],0);Ext.cmd.derive('procore.model.Observation',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'number',type:'int'},{name:'name',type:'string'},{name:'type',type:'auto'},{name:'displayField',type:'string',calculate:function(a){return '#'+a.number+' - '+a.type.name+' - '+a.name}}]},0,0,0,0,0,0,[procore.model,'Observation'],0);Ext.cmd.derive('procore.model.ObservationType',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'category',type:'string'}]},0,0,0,0,0,0,[procore.model,'ObservationType'],0);Ext.cmd.derive('procore.model.PhotoCategory',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'displayField',type:'string',mapping:'name',persist:!1}]},0,0,0,0,0,0,[procore.model,'PhotoCategory'],0);Ext.cmd.derive('procore.model.Project',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'display_name',type:'string'},{name:'company',type:'auto'}]},0,0,0,0,0,0,[procore.model,'Project'],0);Ext.cmd.derive('procore.model.PunchItem',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'position',type:'int'},{name:'name',type:'string'},{name:'assignments',type:'auto'},{name:'due_date'},{name:'status'},{name:'assigneeNamesArray',calculate:function(d){var a=d.assignments,c=[];if(!a){return []}for(var b=0;b<a.length;b++){c.push(a[b].name)}return c}},{name:'vendorNamesArray',calculate:function(e){var a=e.assignments,c=[];if(!a){return []}for(var b=0;b<a.length;b++){var d=a[b].vendor;if(d){c.push(d.name)}}return c}},{name:'displayField',type:'int',calculate:function(a){return '#'+a.position+' - '+a.name}}]},0,0,0,0,0,0,[procore.model,'PunchItem'],0);Ext.cmd.derive('procore.model.RFI',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'number',type:'int'},{name:'subject',type:'string'},{name:'displayField',type:'string',calculate:function(a){return '#'+a.number+' - '+a.subject}},{name:'status',type:'string'}]},0,0,0,0,0,0,[procore.model,'RFI'],0);Ext.cmd.derive('procore.model.SafetyViolationLog',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'position',type:'int'},{name:'time_hour',type:'int'},{name:'time_minute',type:'int'},{name:'subject',type:'string'},{name:'dateString',type:'string',calculate:function(a){return formShared.IntegrationsUtil.getDisplayDateString(a)}},{name:'displayField',calculate:function(a){var b='#'+a.position+' - '+a.dateString;if(a.subject){b+=' - '+a.subject}return b}}]},0,0,0,0,0,0,[procore.model,'SafetyViolationLog'],0);Ext.cmd.derive('procore.model.User',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'number',type:'int'},{name:'subject',type:'string'}]},0,0,0,0,0,0,[procore.model,'User'],0);Ext.cmd.derive('procore.model.WeatherLog',Ext.data.Model,{fields:[{name:'id',type:'int'},{name:'displayField',mapping:'id'},{name:'position',type:'int'},{name:'time_hour',type:'int'},{name:'time_minute',type:'int'},{name:'temperature'},{name:'wind'},{name:'precipitation'},{name:'dateString',type:'string',calculate:function(a){return formShared.IntegrationsUtil.getDisplayDateString(a)}},{name:'displayField',calculate:function(a){return '#'+a.position+' - '+a.dateString}}]},0,0,0,0,0,0,[procore.model,'WeatherLog'],0);Ext.cmd.derive('procore.store.AssigneeResponses',Ext.data.Store,{model:'procore.model.AssigneeResponse',proxy:{url:'/index.cfm?fuseaction=aProcore.getPunchAssignments'}},0,0,0,0,0,0,[procore.store,'AssigneeResponses'],0);Ext.cmd.derive('procore.store.ChangeEvents',Ext.data.Store,{model:'procore.model.ChangeEvent',proxy:{url:'/index.cfm?fuseaction=aProcore.getChangeEvents'}},0,0,0,0,0,0,[procore.store,'ChangeEvents'],0);Ext.cmd.derive('procore.store.Companies',Ext.data.Store,{model:'procore.model.Company',proxy:{url:'/index.cfm?fuseaction=aProcore.getCompanies'}},0,0,0,0,['store.procorecompanies'],0,[procore.store,'Companies'],0);Ext.cmd.derive('procore.store.CostCodes',Ext.data.Store,{model:'procore.model.CostCode',pageSize:1000,proxy:{url:'/index.cfm?fuseaction=aProcore.getCostCodes'}},0,0,0,0,['store.procorecostcodes'],0,[procore.store,'CostCodes'],0);Ext.cmd.derive('procore.store.DeliveryLogs',Ext.data.Store,{model:'procore.model.DeliveryLog',proxy:{url:'/index.cfm?fuseaction=aProcore.getDeliveryLogs'}},0,0,0,0,0,0,[procore.store,'DeliveryLogs'],0);Ext.cmd.derive('procore.store.Locations',Ext.data.Store,{model:'procore.model.Location',pageSize:1000,proxy:{url:'/index.cfm?fuseaction=aProcore.getLocations'}},0,0,0,0,['store.procorelocations'],0,[procore.store,'Locations'],0);Ext.cmd.derive('procore.store.ManpowerLogs',Ext.data.Store,{model:'procore.model.ManpowerLog',proxy:{url:'/index.cfm?fuseaction=aProcore.getManpowerLogs'}},0,0,0,0,0,0,[procore.store,'ManpowerLogs'],0);Ext.cmd.derive('procore.store.ManpowerLogsVendorOptions',Ext.data.Store,{model:'procore.model.ManpowerLogsVendorOption',proxy:{url:'/index.cfm?fuseaction=aProcore.getManpowerLogsVendorOptions'}},0,0,0,0,['store.manpowerlogsvendoroptions'],0,[procore.store,'ManpowerLogsVendorOptions'],0);Ext.cmd.derive('procore.store.Meetings',Ext.data.Store,{model:'procore.model.Meeting',proxy:{url:'/index.cfm?fuseaction=aProcore.getMeetings'}},0,0,0,0,0,0,[procore.store,'Meetings'],0);Ext.cmd.derive('procore.store.NotesLogs',Ext.data.Store,{model:'procore.model.NotesLog',proxy:{url:'/index.cfm?fuseaction=aProcore.getNotesLogs'}},0,0,0,0,0,0,[procore.store,'NotesLogs'],0);Ext.cmd.derive('procore.store.ObservationTypes',Ext.data.Store,{model:'procore.model.ObservationType',proxy:{url:'/index.cfm?fuseaction=aProcore.getObservationTypes'}},0,0,0,0,['store.procoreobservationtypes'],0,[procore.store,'ObservationTypes'],0);Ext.cmd.derive('procore.store.Observations',Ext.data.Store,{model:'procore.model.Observation',proxy:{url:'/index.cfm?fuseaction=aProcore.getObservationItems'}},0,0,0,0,0,0,[procore.store,'Observations'],0);Ext.cmd.derive('procore.store.PhotoCategories',Ext.data.Store,{model:'procore.model.PhotoCategory',proxy:{api:{create:'/index.cfm?fuseaction=aProcore.createImageCategory',read:'/index.cfm?fuseaction=aProcore.getPhotoCategories'},writer:{writeAllFields:!1}}},0,0,0,0,0,0,[procore.store,'PhotoCategories'],0);Ext.cmd.derive('procore.store.Projects',Ext.data.Store,{model:'procore.model.Project',proxy:{url:'/index.cfm?fuseaction=aProcore.getProjects'}},0,0,0,0,['store.procoreprojects'],0,[procore.store,'Projects'],0);Ext.cmd.derive('procore.store.PunchItems',Ext.data.Store,{model:'procore.model.PunchItem',pageSize:25,proxy:{url:'/index.cfm?fuseaction=aProcore.getPunchListItems'}},0,0,0,0,0,0,[procore.store,'PunchItems'],0);Ext.cmd.derive('procore.store.RFIs',Ext.data.Store,{model:'procore.model.RFI',remoteFilter:!0,pageSize:25,proxy:{url:'/index.cfm?fuseaction=aProcore.getRFIs'}},0,0,0,0,0,0,[procore.store,'RFIs'],0);Ext.cmd.derive('procore.store.SafetyViolationLogs',Ext.data.Store,{model:'procore.model.SafetyViolationLog',proxy:{url:'/index.cfm?fuseaction=aProcore.getSafetyViolationLogs'}},0,0,0,0,0,0,[procore.store,'SafetyViolationLogs'],0);Ext.cmd.derive('procore.store.WeatherLogs',Ext.data.Store,{model:'procore.model.WeatherLog',proxy:{url:'/index.cfm?fuseaction=aProcore.getWeatherLogs'}},0,0,0,0,0,0,[procore.store,'WeatherLogs'],0);Ext.cmd.derive('procore.view.procorewindow.ProcoreWindowModel',Ext.app.ViewModel,{stores:{procoreCompanies:{type:'procorecompanies',autoLoad:!0,mvAutoLoadVars:!0},procoreProjects:{proxy:{type:'memory'}},manpowerLogsVendorOptions:{type:'manpowerlogsvendoroptions',mvAutoLoadVars:!0},locations:{type:'procorelocations',mvAutoLoadVars:!0},costCodes:{type:'procorecostcodes',mvAutoLoadVars:!0},observationTypes:{type:'procoreobservationtypes',mvAutoLoadVars:!0}},data:{private_procoreSetting_companyID:null,private_procoreSetting_projectID:null,private_procoreSetting_entityType:null,private_procoreSetting_attachAsPhoto:null,private_procoreSetting_attachAs4View:null,private_procoreSetting_dailyLogSubType:null,private_procoreSetting_punchlistAction:null,private_procoreSetting_observationAction:null,private_procoreSetting_photoAction:null,private_procoreSetting_photoCategoryID:null,private_procoreSetting_rfiFilterValue:null,entityID:'',projectsLoaded:!1,dailyLogDate:new Date(),procoreUserID:0,entityStoreLoaded:!1,cardHeight:312,saving:!1,saveDone:!1,warningMessage:'',attachFloorplanOnly:!1,_weatherLogConditions:'',_photoExifData:''},formulas:{procoreSetting_companyID:{get:function(b){var a=b('private_procoreSetting_companyID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getProcoreSetting_companyID()},set:function(a){this.set('private_procoreSetting_companyID',a);mdsPreferences.ProjectPreferences.setProcoreSetting_companyID(a)}},procoreSetting_projectID:{get:function(b){var a=b('private_procoreSetting_projectID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getProcoreSetting_projectID()},set:function(a){this.set('private_procoreSetting_projectID',a);mdsPreferences.ProjectPreferences.setProcoreSetting_projectID(a)}},integrationEntityType:{get:function(b){var a=b('private_procoreSetting_entityType');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}a=mdsPreferences.ProjectPreferences.getProcoreSetting_entityType();return b('integrationEntityTypes').getById(a)?a:''},set:function(a){this.set('private_procoreSetting_entityType',a);mdsPreferences.ProjectPreferences.setProcoreSetting_entityType(a)}},integrationAttachAsPhoto:{get:function(c){var a=c('private_procoreSetting_attachAsPhoto');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getProcoreSetting_attachAsPhoto();return b===undefined?!1:b},set:function(a){this.set('private_procoreSetting_attachAsPhoto',a);mdsPreferences.ProjectPreferences.setProcoreSetting_attachAsPhoto(a)}},integrationAttachAs4View:{get:function(c){var a=c('private_procoreSetting_attachAs4View');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getProcoreSetting_attachAs4View();return b===undefined?!0:b},set:function(a){this.set('private_procoreSetting_attachAs4View',a);mdsPreferences.ProjectPreferences.setProcoreSetting_attachAs4View(a)}},procoreSetting_dailyLogSubType:{get:function(b){var a=b('private_procoreSetting_dailyLogSubType');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getProcoreSetting_dailyLogSubType();return c||'WeatherLog'},set:function(a){this.set('private_procoreSetting_dailyLogSubType',a);mdsPreferences.ProjectPreferences.setProcoreSetting_dailyLogSubType(a)}},procoreSetting_punchlistAction:{get:function(b){var a=b('private_procoreSetting_punchlistAction');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getProcoreSetting_punchlistAction();return c||'AssigneeResponse'},set:function(a){this.set('private_procoreSetting_punchlistAction',a);mdsPreferences.ProjectPreferences.setProcoreSetting_punchlistAction(a)}},procoreSetting_observationAction:{get:function(b){var a=b('private_procoreSetting_observationAction');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getProcoreSetting_observationAction();return c||'ObservationCreate'},set:function(a){this.set('private_procoreSetting_observationAction',a);mdsPreferences.ProjectPreferences.setProcoreSetting_observationAction(a)}},procoreSetting_photoAction:{get:function(b){var a=b('private_procoreSetting_photoAction');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getProcoreSetting_photoAction();return c||'AddToExistingAlbum'},set:function(a){this.set('private_procoreSetting_photoAction',a);mdsPreferences.ProjectPreferences.setProcoreSetting_photoAction(a)}},procoreSetting_photoCategoryID:{get:function(b){var a=b('private_procoreSetting_photoCategoryID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getProcoreSetting_photoCategoryID()},set:function(a){this.set('private_procoreSetting_photoCategoryID',a);mdsPreferences.ProjectPreferences.setProcoreSetting_photoCategoryID(a)}},procoreSetting_rfiFilterValue:{get:function(b){var a=b('private_procoreSetting_rfiFilterValue');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getProcoreSetting_rfiFilterValue();return c||'open'},set:function(a){this.set('private_procoreSetting_rfiFilterValue',a);mdsPreferences.ProjectPreferences.setProcoreSetting_rfiFilterValue(a)}},entityType:function(a){return a('integrationEntityTypes').getById(a('integrationEntityType'))},entity:function(a){var d=a('integrationEntityType'),c=a('procoreUserID');if(!d||!c){return null}var b=a('entityStore');if(!b||!a('entityStoreLoaded')){return null}return b.getById(a('calculatedEntityID'))},projectSelected:function(a){return a('projectsLoaded')&&a('procoreSetting_projectID')},subType:function(a){var c=a('entityType');if(c){var b=c.getId();if(b=='DailyLog'){return a('procoreSetting_dailyLogSubType')}if(b=='PunchList'){return a('procoreSetting_punchlistAction')}if(b=='Observation'){return a('procoreSetting_observationAction')}if(b=='Photos'){return a('procoreSetting_photoAction')}}return null},calculatedEntityID:function(a){if(a('subType')=='AddToExistingAlbum'){return a('procoreSetting_photoCategoryID')}return a('entityID')},entityStoreID:function(b){var a=b('entityType'),d=b('procoreSetting_projectID');if(!a){return null}var c='procore_'+a.get('name').replace(' ','')+'_'+d;if(a.get('hasSubStores')){c+='_'+b('subType')}if(a.getId()=='DailyLog'){c+='_'+b('dailyLogDate')}return c},entityStore:function(a){var h=a('entityType'),f=a('procoreUserID'),d=a('entityStoreType');if(!h||!f||!d){return Ext.create('Ext.data.Store',{proxy:'memory'})}var g=a('entityType').getId(),e=a('entityStoreID'),b=Ext.getStore(e),c=this.getView().lookupController();if(!b&&a('procoreSetting_companyID')&&a('procoreSetting_projectID')){b=Ext.create(d,{storeId:e,autoLoad:!0,proxy:{extraParams:c.getEntityStoreParams(g)},listeners:{load:c.onEntityStoreLoad,scope:c}});c.entityStores.push(b)}if(b){this.set('entityStoreLoaded',b.isLoaded())}return b},procorePunchListAssignees:function(d){var a=d('procoreSetting_projectID');if(!a){return Ext.create('Ext.data.Store',{proxy:{type:'memory'}})}var b='procorePunchlistAssignees-'+a,c=Ext.getStore(b);return c||Ext.create('Ext.data.Store',{model:'procore.model.User',proxy:{url:'/index.cfm?fuseaction=aProcore.getPunchListAssignees',extraParams:{project_id:a}},mvAutoLoadVars:!0,autoLoad:!0,storeId:b})},procoreRFIAssignees:function(d){var a=d('procoreSetting_projectID');if(!a){return Ext.create('Ext.data.Store',{proxy:{type:'memory'}})}var b='procoreRFIAssignees-'+a,c=Ext.getStore(b);return c||Ext.create('Ext.data.Store',{model:'procore.model.User',proxy:{url:'/index.cfm?fuseaction=aProcore.getRFIAssignees',extraParams:{project_id:a}},mvAutoLoadVars:!0,autoLoad:!0,storeId:b})},entityStoreType:function(d){var b=d('entityType'),a=d('subType');if(!b){return null}var c=b.get('storeType');if(!c){if(!a||a.match('Create')){return null}return 'procore.store.'+a+'s'}return c},card:function(b){var a=this.getView().lookupController(),c=b('integrationEntityType'),f=b('subType'),e=b('procoreProject'),d=a.lookupReference('card_default');return e?a.lookupReference('card_'+c+'_'+f)||a.lookupReference('card_'+c)||d:d},subCard:function(a){var b=a('card');if(b.xtype=='procoredailylog'){return this.getView().lookupController().lookupReference('card_'+a('subType'))}return null},itemDescription:function(a){return a('integrationEntityType')=='DailyLog'?'sub log item':'item'},lowercaseEntityName:function(c){var b=c('entityType');if(!b){return ''}var a=b.get('name');return a==='RFI'?a:a.toLowerCase()},emptyText:function(b){var a=b('entityStore'),c=b('entityStoreLoaded');if(!a||!c||a.getCount()){return mvstr['G_Select']}return mvstr['INT_No items available.']},noItemsAvailable:function(b){var a=b('entityStore'),c=b('entityStoreLoaded');return !(!a||!c||a.getCount())},viewingManpowerLog:function(a){return !!a('procoreSetting_dailyLogSubType').match('ManpowerLog')},viewingNotesLog:function(a){return !!a('procoreSetting_dailyLogSubType').match('NotesLog')},entityClone:function(b){var a=b('entity');return a?a.clone():null},weatherLogConditions:function(a){if(!a('procoreSetting_projectID')||!a('procoreSetting_dailyLogSubType').match('WeatherLog')){return null}var b=a('_weatherLogConditions'),c=a('procoreSetting_projectID');if(b&&b.project_id==c){return b}Ext.Ajax.request({url:'/index.cfm?fuseaction=aProcore.getWeatherConditions',params:{project_id:c},successCallback:function(b){b.project_id=c;this.set('_weatherLogConditions',b)},afterFailMessageCallback:function(){this.set('warningMessage',mvstr['PRO_Could not load weathe'])},scope:this,noAlert:!0});return null},weatherTemperatures:function(b){var a=b('weatherLogConditions');if(!a){return null}return Ext.create('Ext.data.Store',{proxy:'memory',fields:['key','value'],data:a.temperature})},weatherWinds:function(b){var a=b('weatherLogConditions');if(!a){return null}return Ext.create('Ext.data.Store',{proxy:'memory',fields:['key','value'],data:a.wind})},noManpowerLogsVendorOptionsAvailable:function(b){var a=b('manpowerLogsVendorOptions'),c=b('_manpowerLogsVendorOptionsLoaded');return !(!a||!c||a.getCount())},manpowerLogsVendorOptionsEmptyText:function(a){return a('noManpowerLogsVendorOptionsAvailable')?mvstr['PRO_No companies availabl']:mvstr['G_Select']},noLocationsAvailable:function(b){var a=b('locations'),c=b('_locationsLoaded');return !(!a||!c||a.getCount())},locationsEmptyText:function(a){return a('noLocationsAvailable')?mvstr['PRO_No locations availabl']:mvstr['G_Select']},noCostCodesAvailable:function(b){var a=b('costCodes'),c=b('_costCodesLoaded');return !(!a||!c||a.getCount())},costCodesEmptyText:function(a){return a('noCostCodesAvailable')?mvstr['PRO_No cost codes availab']:mvstr['G_Select']},photoExifData:function(d){var c=this.getView().getPhotos(),b=this.getView().getDatePhoto();if(c.length!=1||this.getView().getPhotoDate()){return []}var a=d('_photoExifData');if(a){return a}Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoViewer.getExifData',params:{id:b?b.get('id'):c[0],projectUID:d('ProjectUID'),webcamUID:''},successCallback:function(a){this.set('_photoExifData',a)},afterFailMessageCallback:function(){return []},scope:this,noAlert:!0});return null},photoExifDateTime:function(e){var d=this.getView().getPhotoDate();if(!d){var a=e('photoExifData'),c=Ext.Date.format(new Date(),'Y-m-d H:i:s');if(!a){return null}for(var b=0;b<a.length;b++){if(Ext.Array.contains(['PhotoOriginalDate','Date/Time'],a[b].name)){c=a[b].description;break}}d=Ext.Date.parse(c,'Y-m-d H:i:s')||Ext.Date.parse(c,'Y:m:d H:i:s')}return d},photoExifDateTimeStr:function(a){return Ext.Date.format(a('photoExifDateTime'),'Y-m-d H:i:s')},procoreProject:function(a){var d=a('procoreSetting_companyID'),b=a('procoreSetting_projectID');if(!a('projectsLoaded')||!d||!b){return null}var c=a('procoreProjects');return c?c.getById(b):null},dailyLogLabel:function(b){var a=b('dailyLogDate');return mvstr['PRO_Logs for {x}'].replace('{x}',Ext.Date.format(a,mvstr['DATE_Short']))},integrationEntityTypes:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},model:'formShared.model.IntegrationEntityType',data:[{id:'ChangeEvent',name:mvstr['PRO_Change Event'],storeType:'procore.store.ChangeEvents',createAction:'submitToChangeEvent',searchFields:['number','title']},{id:'DailyLog',name:mvstr['PRO_Daily Log'],subCreateActions:{DeliveryLog:'submitToDeliveryLog',SafetyViolationLog:'submitToSafetyViolationLog',WeatherLog:'submitToWeatherLog',WeatherLogCreate:'createWeatherLog',ManpowerLog:'submitToManpowerLog',ManpowerLogCreate:'createManpowerLog',NotesLog:'submitToNotesLog',NotesLogCreate:'createNotesLog'},subSearchFields:{DeliveryLog:['position','dateString','delivery_from'],SafetyViolationLog:['position','dateString','subject'],WeatherLog:[],ManpowerLog:['position','contactName','locationName','costCodeName'],NotesLog:[]},hasSubStores:!0},{id:'Observation',name:mvstr['PRO_Observation'],storeType:'procore.store.Observations',subCreateActions:{ObservationCreate:'createObservation',ObservationItem:'submitToObservationItem',ObservationResponse:'submitToObservationResponse'},searchFields:['number','name','type']},{id:'Meeting',name:mvstr['PRO_Meeting'],storeType:'procore.store.Meetings',createAction:'submitToMeeting',searchFields:['position','title','meeting_date_formatted']},{id:'Photos',name:mvstr['PRO_Photos'],storeType:'procore.store.PhotoCategories',createAction:'submitToPhotoCategory',searchFields:['name']},{id:'PunchList',name:mvstr['PRO_Punch List - Update'],subCreateActions:{AssigneeResponse:'submitToPunchAssignment',PunchItem:'submitToPunchListItem'},subSearchFields:{AssigneeResponse:['position','name'],PunchItem:['position','name','assigneeNamesArray','vendorNamesArray']},hasSubStores:!0},{id:'PunchListCreateItem',name:mvstr['PRO_Punch List - Create'],createAction:'createPunchlistItem'},{id:'RFI',name:mvstr['PRO_RFI - Update'],storeType:'procore.store.RFIs',createAction:'submitToRFI',searchFields:['number','subject']},{id:'RFICreate',name:mvstr['PRO_RFI - Create'],createAction:'createRFI'}]})},procorePunchlistActions:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'PunchItem',name:mvstr['PRO_Update Status']},{id:'AssigneeResponse',name:mvstr['PRO_Update Response']}]})},procoreAssigneeResponseStatuses:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{name:mvstr['PRO_Unresolved'],value:!1},{name:mvstr['PRO_Resolved'],value:!0}]})},procorePunchItemStatuses:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'Open',name:mvstr['PRO_Open']},{id:'Closed',name:mvstr['PRO_Closed']}]})},procoreDailyLogTypes:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'DeliveryLog',name:mvstr['PRO_Delivery Log']},{id:'SafetyViolationLog',name:mvstr['PRO_Safety Violation Log']},{id:'WeatherLog',name:mvstr['PRO_Weather Log - Update']},{id:'WeatherLogCreate',name:mvstr['PRO_Weather Log - Create']},{id:'ManpowerLog',name:mvstr['PRO_Manpower Log - Update']},{id:'ManpowerLogCreate',name:mvstr['PRO_Manpower Log - Create']},{id:'NotesLog',name:mvstr['PRO_Notes Log - Update']},{id:'NotesLogCreate',name:mvstr['PRO_Notes Log - Create']}]})},procorePhotoActions:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'CreateNewAlbum',name:mvstr['PRO_Create New Album']},{id:'AddToExistingAlbum',name:mvstr['PRO_Add to Existing Album']}]})},procoreRFIFilters:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{value:mvstr['PRO_Open'],id:'open'},{value:mvstr['PRO_Closed'],id:'closed'},{value:mvstr['PRO_Draft'],id:'draft'}]})},procoreObservationActions:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'ObservationCreate',name:mvstr['PRO_Create']},{id:'ObservationResponse',name:mvstr['PRO_Add Comment']},{id:'ObservationItem',name:mvstr['PRO_Update Observation']}]})},procoreObservationStatuses:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'initiated',name:mvstr['PRO_Initiated']},{id:'ready_for_review',name:mvstr['PRO_Ready For Review']},{id:'not_accepted',name:mvstr['PRO_Not Accepted']},{id:'closed',name:mvstr['PRO_Closed']}]})},punchlistPriorities:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'low',name:mvstr['PRO_Low']},{id:'medium',name:mvstr['PRO_Medium']},{id:'high',name:mvstr['PRO_High']}]})},observationPriorities:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},data:[{id:'Low',name:mvstr['PRO_Low']},{id:'Medium',name:mvstr['PRO_Medium']},{id:'High',name:mvstr['PRO_High']},{id:'Urgent',name:mvstr['PRO_Urgent']}]})}}},0,0,0,0,['viewmodel.procorewindow'],0,[procore.view.procorewindow,'ProcoreWindowModel'],0);Ext.cmd.derive('procore.view.procorewindow.ProcoreWindowController',Ext.app.ViewController,{entityStores:[],init:function(){var a=this.getViewModel();a.bind('{procoreSetting_companyID}',this.onCompanyChange,this);a.bind({_procoreCompaniesLoaded:'{_procoreCompaniesLoaded}',procoreSetting_companyID:'{procoreSetting_companyID}',procoreUserID:'{procoreUserID}',photoExifData:'{photoExifData}'},function(a){if(a._procoreCompaniesLoaded&&a.procoreSetting_companyID!==null&&a.procoreUserID&&a.photoExifData){this.onWindowReady()}},this);a.bind({card:'{card}',subCard:'{subCard}'},this.onCardChange,this);a.bind({procoreSetting_rfiFilterValue:'{procoreSetting_rfiFilterValue}',entityStore:'{entityStore}'},function(d){var f=a.get('integrationEntityTypes').getById('RFI');if(d.entityStore&&d.entityStore.$className==f.get('storeType')){var c=d.procoreSetting_rfiFilterValue.rfiFilter;var e=d.entityStore.getProxy(),b=e.getExtraParams();if(c){b.status=typeof c=='object'?c.join(','):c;e.setExtraParams(b);this.lookupReference('procoreRFILookup').loadPage(1)}else {if(b.status){delete b.status;e.setExtraParams(b);this.lookupReference('procoreRFILookup').loadPage(1)}}}},this);a.bind({entityType:'{entityType}',entity:'{entity}'},function(a){if(a.entity&&a.entity.get('status')&&a.entityType.getId()==='RFI'){var b=a.entity.get('status');if(b!='draft'){this.getViewModel().get('procoreRFIFilters').filter({filterFn:function(b){return b.getId()!='draft'}})}else {this.getViewModel().get('procoreRFIFilters').clearFilter()}this.lookupReference('procoreRFIStatus').setValue(b)}},this);a.bind({viewingManpowerLog:'{viewingManpowerLog}',project_id:'{procoreSetting_projectID}',manpowerLogsVendorOptions:'{manpowerLogsVendorOptions}',costCodes:'{costCodes}'},function(a){if(a.viewingManpowerLog&&a.project_id){var c=[a.manpowerLogsVendorOptions,a.costCodes];for(var b=0;b<c.length;b++){if(c[b]){c[b].getProxy().setExtraParams({project_id:a.project_id});c[b].load()}}}},this);a.bind({viewingManpowerLog:'{viewingManpowerLog}',viewingNotesLog:'{viewingNotesLog}',project_id:'{procoreSetting_projectID}',locations:'{locations}'},function(a){if((a.viewingManpowerLog||a.viewingNotesLog)&&a.project_id&&a.locations&&a.locations.getProxy().getExtraParams().project_id!=a.project_id){a.locations.getProxy().setExtraParams({project_id:a.project_id});a.locations.load()}},this);a.bind({integrationEntityType:'{integrationEntityType}',project_id:'{procoreSetting_projectID}',observationTypes:'{observationTypes}'},function(c){if(c.integrationEntityType=='Observation'&&c.project_id){var b=[c.observationTypes];for(var a=0;a<b.length;a++){if(b[a]){b[a].getProxy().setExtraParams({project_id:c.project_id});b[a].load()}}}},this);Ext.Ajax.request({url:'/index.cfm?fuseaction=aProcore.getUser',successCallback:function(a){if(this.getViewModel()){this.getViewModel().set('procoreUserID',a.id)}},afterFailMessageCallback:function(){this.getView().destroy()},scope:this});Ext.getBody().addListener('resize',this.onBrowserResize,this);Ext.defer(function(){this.getView().showBy(Ext.getBody(),'t-t',[0,this.getWindowOffset()])},1,this)},onBoxReady:function(){this.getView().setLoading(!0)},onWindowReady:function(){this.getView().setLoading(!1)},onProjectsLoaded:function(c){var b=this.getViewModel(),a=b.get('procoreSetting_projectID');b.set('projectsLoaded',!0);if(a&&c.getById(a)){this.lookupReference('projects').setValue(a)}else {this.lookupReference('projects').setValue('')}},onCompanyChange:function(a){if(a){this.getViewModel().set('procoreProjects',this.getProjectStore(a))}this.getViewModel().set('warningMessage','')},onProjectChange:function(b,a){if(a){this.getViewModel().set('procoreSetting_projectID',a)}else {this.getViewModel().set('entityID','')}this.getViewModel().set('warningMessage','')},getProjectStoreID:function(a){return 'procoreProjectStore-'+a},getProjectStore:function(a){if(!a){return Ext.create('Ext.data.Store',{proxy:{type:'memory'}})}var c=this.getProjectStoreID(a),b=Ext.getStore(c);this.getViewModel().set('projectsLoaded',b&&b.isLoaded());return b||Ext.create('procore.store.Projects',{autoLoad:!0,proxy:{extraParams:{company_id:a}},listeners:{load:{fn:this.onProjectsLoaded,scope:this}}})},getEntityStoreId:function(c){var a=this.getViewModel().get('integrationEntityTypes').getById(c),d=this.getViewModel().get('procoreSetting_projectID');var b='procore_'+a.get('name').replace(' ','')+'_'+d;if(a.get('subCreateActions')){b+='_'+this.getViewModel().get('subType')}return b},getEntityStoreParams:function(c){var a=this.getViewModel(),b={project_id:a.get('procoreSetting_projectID')};if(a.get('integrationEntityType')=='DailyLog'){b.log_date=Ext.Date.format(a.get('dailyLogDate'),'Y-m-d')}return b},getCreateAction:function(){var a=this.getViewModel().get('integrationEntityTypes').getById(this.getViewModel().get('integrationEntityType')),c=this.getViewModel().get('subType'),b=a.get('subCreateActions');return b?a.get('subCreateActions')[c]:a.get('createAction')},getSubmitParams:function(c){var a=this.getViewModel(),j=this.getView().getPhotos(),f=c&&c.id?c.id:a.get('calculatedEntityID'),k=a.get('subCard')||a.get('card'),h=k,e=this.getView().getPushpinUID(),g=a.get('entity'),i=c&&c.displayField?c.displayField:g?g.get('displayField'):'',d=this.getView().getPhoto360ID(),b={ProjectUID:a.get('ProjectUID'),photos:j.join(','),project_id:a.get('private_procoreSetting_projectID'),dateString:Ext.Date.format(new Date(),'ymd'),includeAnnotations:this.getView().getIncludeAnnotations(),displayName:i,projectName:a.get('procoreProjects').getById(a.get('procoreSetting_projectID')).get('name'),asynchronous:this.isAsyncUpload(),time_zone:a.get('procoreProject.time_zone')};if(f){b.id=f}if(e){b.PushpinUID=e}if(d){b.Photo360ID=d}if(h.getValues){Ext.mergeIf(b,h.getValues())}b.attachAsFloorplan=this.getViewModel().get('attachFloorplanOnly');if(b.attachAsFloorplan){b.attachAsPhoto=b.attachAs4View=!1;b.FloorplanUID=a.get('FloorplanUID')}return b},isAsyncUpload:function(){var a=this.getViewModel(),b=a.get('entityType');if(!b){return !1}var d=b.getId(),c=a.get('account.features.uploadscenterVisible');if(Ext.Array.contains(['RFICreate','RFI'],d)&&(this.getView().getPhotos().length>1||a.get('integrationAttachAsPhoto')&&a.get('integrationAttachAs4View'))){c=!1}return c},submitPhotos:function(e){var a=this.getViewModel(),f=this.isAsyncUpload(),g=a.get('subCard')||a.get('card'),b='';if(!a.get('procoreProject')){b=mvstr['PROMSG_NoProject']}else {if(!a.get('integrationEntityType')){b=mvstr['INTMSG_NoType']}}var d=g.getErrors();if(d.length){b=d[0]}a.set('warningMessage',b);if(b){return}a.set('saving',!0);if(a.get('subType')=='CreateNewAlbum'&&!e){this.createNewAlbum();return}var c=this.getSubmitParams(e);Ext.Ajax.request({url:'/index.cfm?fuseaction=aProcore.'+this.getCreateAction(),params:c,successCallback:function(b){if(f){window.app.fireEvent('reloadfileuploads',{sourceType:'integration',responseData:b,photos:c.photos.split(',')})}else {a.set('saveDone',!0)}if(b&&b.callback){b.callback()}Ext.defer(function(){this.getView().destroy()},1000,this)},afterFailMessageCallback:function(c,b){a.set('saving',!1);a.set('warningMessage',b?b:mvstr.G_UnexpectedError)},noAlert:!0,scope:this});this.logExportAnalyticsEvent(c)},logExportAnalyticsEvent:function(a){if(a.attachAsFloorplan){analytics.Ctrl.log('Exported Floorplan',{'Floorplan UID':a.FloorplanUID,'Integration':'Procore'})}else {var b='Photo Viewer Menu';if(location.href.toLowerCase().indexOf('clientphotolist')!==-1){b='Photo List Menu'}analytics.Ctrl.log('Exported Photo',{'Photo List':a.photos,'Photo Action Element':b,'Integration':'Procore'})}},createNewAlbum:function(){var a=this.getViewModel(),c=a.get('entityStore'),b=Ext.create('procore.model.PhotoCategory',{name:this.lookupReference('procoreNewAlbumName').getValue()});c.add(b);c.sync({success:function(){var c=b.getId();this.submitPhotos({id:c,displayField:b.get('displayField'),callback:function(){a.set('procoreSetting_photoAction','AddToExistingAlbum');a.set('procoreSetting_photoCategoryID',c)}})},afterFailMessageCallback:function(d,b){c.rejectChanges();a.set('saving',!1);a.set('warningMessage',b?b:mvstr.G_UnexpectedError)},scope:this,noAlert:!0})},onCardChange:function(a){if(a.card){this.lookupReference('cards').setActiveItem(a.card);if(a.subCard){a.card.down('#subCards').setActiveItem(a.subCard)}}this.getViewModel().set('warningMessage','')},onEntityStoreLoad:function(a){if(a==this.getViewModel().get('entityStore')){this.getViewModel().set('entityStoreLoaded',!0)}},getWindowOffset:function(){return Math.min(102,Math.max(0,Ext.getBody().getHeight()-this.getView().el.getHeight()))},onBrowserResize:function(){var b=Ext.getBody().getHeight(),a=Math.min(this.getView().getDefaultHeight(),b);this.getView().setHeight(a);this.getView().alignTo(Ext.getBody(),'t-t',[0,this.getWindowOffset()])}},0,0,0,0,['controller.procorewindow'],0,[procore.view.procorewindow,'ProcoreWindowController'],0);Ext.cmd.derive('procore.view.cards.Default',Ext.form.Panel,{reference:'card_default',items:[{xtype:'integrationtype',hidden:!0,bind:{hidden:'{!procoreProject}'}}]},0,['procoredefault'],['component','box','container','panel','form','procoredefault'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoredefault':!0},['widget.procoredefault'],0,[procore.view.cards,'Default'],0);Ext.cmd.derive('procore.view.cards.ChangeEvent',Ext.form.Panel,{reference:'card_ChangeEvent',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationlookup'}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procorechangeevent'],['component','box','container','panel','form','procorechangeevent'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorechangeevent':!0},['widget.procorechangeevent'],0,[procore.view.cards,'ChangeEvent'],0);Ext.cmd.derive('procore.view.cards.DailyLog',Ext.form.Panel,{reference:'card_DailyLog',layout:'fit',dockedItems:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',dock:'top',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationssubtype',bind:{store:'{procoreDailyLogTypes}',value:'{procoreSetting_dailyLogSubType}'}}]}],items:[{xtype:'panel',itemId:'subCards',layout:'card',items:[{xtype:'procoredeliverylog'},{xtype:'procoresafetyviolationlog'},{xtype:'procoreweatherlog'},{xtype:'procoreweatherlogcreate'},{xtype:'procoremanpowerlog'},{xtype:'procoremanpowerlogcreate'},{xtype:'procorenoteslog'},{xtype:'procorenoteslogcreate'}]}]},0,['procoredailylog'],['component','box','container','panel','form','procoredailylog'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoredailylog':!0},['widget.procoredailylog'],0,[procore.view.cards,'DailyLog'],0);Ext.cmd.derive('procore.view.cards.Documents',Ext.form.Panel,{reference:'card_Documents',layout:'vbox',items:[{xtype:'integrationtype',margin:'0 0 28 0'},{xtype:'detailformtextfield',reference:'procoreDocumentTitle',localized:{fieldLabel:'PRO_Title',emptyText:'PRO_Enter title'},margin:'0 0 28 0',width:'100%',name:'title',allowBlank:!1},{xtype:'integrationattachment'}]},0,['procoredocuments'],['component','box','container','panel','form','procoredocuments'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoredocuments':!0},['widget.procoredocuments'],0,[procore.view.cards,'Documents'],0);Ext.cmd.derive('procore.view.cards.Meeting',Ext.form.Panel,{reference:'card_Meeting',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationlookup'}]},{xtype:'integrationattachment'}]},0,['procoremeeting'],['component','box','container','panel','form','procoremeeting'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoremeeting':!0},['widget.procoremeeting'],0,[procore.view.cards,'Meeting'],0);Ext.cmd.derive('procore.view.form.ObservationStatus',formShared.view.components.Combo,{width:202,localized:{fieldLabel:'PRO_Response Status',emptyText:'G_Select'},displayField:'name',valueField:'id',allowBlank:!0,name:'status',bind:{store:'{procoreObservationStatuses}'}},0,['procoreobservationstatus'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','procoreobservationstatus'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'procoreobservationstatus':!0},['widget.procoreobservationstatus'],0,[procore.view.form,'ObservationStatus'],0);Ext.cmd.derive('procore.view.cards.Observation',Ext.form.Panel,{layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationssubtype',bind:{store:'{procoreObservationActions}',value:'{procoreSetting_observationAction}'}}]},{xtype:'integrationlookup',width:'100%',margin:'0 0 28 0'},{xtype:'procoreobservationstatus',margin:'0 0 28 0',bind:{value:'{entityClone.status}'},name:'status'},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procoreobservation'],['component','box','container','panel','form','procoreobservation'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoreobservation':!0},['widget.procoreobservation'],0,[procore.view.cards,'Observation'],0);Ext.cmd.derive('procore.view.cards.ObservationCreate',Ext.form.Panel,{reference:'card_Observation_ObservationCreate',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationssubtype',bind:{store:'{procoreObservationActions}',value:'{procoreSetting_observationAction}'}}]},{layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformgroupedcombo',localized:{fieldLabel:'PRO_Type'},width:202,bind:{store:'{observationTypes}'},name:'type_id',allowBlank:!1},{xtype:'component',flex:1},{xtype:'procoreobservationstatus',localized:{fieldLabel:'PRO_Status'},value:'initiated',name:'status'}]},{layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformtextfield',localized:{fieldLabel:'PRO_Title'},width:202,name:'name',allowBlank:!1},{xtype:'component',flex:1},{xtype:'detailformcombo',width:202,localized:{fieldLabel:'PRO_Priority',emptyText:'G_Select'},displayField:'name',valueField:'id',allowBlank:!0,bind:{store:'{observationPriorities}'},name:'priority'}]},{layout:{type:'hbox',align:'bottom'},width:'100%',margin:'0 0 28 0',items:[{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',localized:{fieldLabel:'PRO_Due Date'},labelSeparator:'',value:new Date(),name:'due_date',submitFormat:'Y-m-d'},{xtype:'component',flex:1},{xtype:'checkboxfield',ui:'plain-16',localized:{boxLabel:'PRO_Private'},name:'personal',value:!0,inputValue:!0,uncheckedValue:!1}]},{xtype:'integrationcomments',localized:{fieldLabel:'PRO_Description'},name:'description',allowBlank:!1},{xtype:'integrationattachment'}]},0,['procoreobservationcreate'],['component','box','container','panel','form','procoreobservationcreate'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoreobservationcreate':!0},['widget.procoreobservationcreate'],0,[procore.view.cards,'ObservationCreate'],0);Ext.cmd.derive('procore.view.cards.PhotosExistingAlbum',Ext.form.Panel,{reference:'card_Photos_AddToExistingAlbum',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationssubtype',bind:{store:'{procorePhotoActions}',value:'{procoreSetting_photoAction}'}}]},{xtype:'integrationlookup',width:'100%',localized:{fieldLabel:'PRO_Album',emptyText:'G_Select'},bind:{value:'{procoreSetting_photoCategoryID}'}}]},0,['procorephotosexistingalbum'],['component','box','container','panel','form','procorephotosexistingalbum'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorephotosexistingalbum':!0},['widget.procorephotosexistingalbum'],0,[procore.view.cards,'PhotosExistingAlbum'],0);Ext.cmd.derive('procore.view.cards.PhotosNewAlbum',Ext.form.Panel,{reference:'card_Photos_CreateNewAlbum',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationssubtype',bind:{store:'{procorePhotoActions}',value:'{procoreSetting_photoAction}'}}]},{xtype:'detailformtextfield',reference:'procoreNewAlbumName',localized:{fieldLabel:'PRO_Name New Album',emptyText:'PRO_Enter new album name'},width:'100%',publishes:'value',allowBlank:!1}]},0,['procorephotosnewalbum'],['component','box','container','panel','form','procorephotosnewalbum'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorephotosnewalbum':!0},['widget.procorephotosnewalbum'],0,[procore.view.cards,'PhotosNewAlbum'],0);Ext.cmd.derive('procore.view.cards.PunchListAssignment',Ext.form.Panel,{reference:'card_PunchList_AssigneeResponse',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationssubtype',bind:{store:'{procorePunchlistActions}',value:'{procoreSetting_punchlistAction}'}}]},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationlookup'},{xtype:'component',flex:1},{xtype:'detailformcombo',reference:'procorePunchAssignmentStatus',width:202,localized:{fieldLabel:'PRO_Response Status'},displayField:'name',valueField:'value',bind:{store:'{procoreAssigneeResponseStatuses}',value:'{entityClone.approved}'},name:'approved'}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procorepunchlistassignment'],['component','box','container','panel','form','procorepunchlistassignment'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorepunchlistassignment':!0},['widget.procorepunchlistassignment'],0,[procore.view.cards,'PunchListAssignment'],0);Ext.cmd.derive('procore.view.cards.PunchListCreateItem',Ext.form.Panel,{reference:'card_PunchListCreateItem',layout:'vbox',items:[{xtype:'integrationtype',margin:'0 0 28 0'},{xtype:'container',layout:{type:'hbox',align:'bottom'},width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformtextfield',localized:{fieldLabel:'PRO_Title'},width:202,allowBlank:!1,name:'title'},{xtype:'component',flex:1},{xtype:'procoreuser',width:202,bind:{store:'{procorePunchListAssignees}'},name:'assignees'}]},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformcombo',width:202,localized:{fieldLabel:'PRO_Priority',emptyText:'G_Select'},displayField:'name',valueField:'id',bind:{store:'{punchlistPriorities}'},allowBlank:!1,name:'priority'},{xtype:'component',flex:1},{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',localized:{fieldLabel:'PRO_Due Date'},labelSeparator:'',value:new Date(),name:'dueDate',submitFormat:'Y-m-d'}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procorepunchlistcreateitem'],['component','box','container','panel','form','procorepunchlistcreateitem'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorepunchlistcreateitem':!0},['widget.procorepunchlistcreateitem'],0,[procore.view.cards,'PunchListCreateItem'],0);Ext.cmd.derive('procore.view.cards.PunchListUpdateItem',Ext.form.Panel,{reference:'card_PunchList_PunchItem',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'integrationtype'},{xtype:'component',flex:1},{xtype:'integrationssubtype',bind:{store:'{procorePunchlistActions}',value:'{procoreSetting_punchlistAction}'}}]},{xtype:'integrationremotelookup',localized:{fieldLabel:'PRO_Punch List Item'},width:'100%',margin:'0 0 28 0'},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformcombo',reference:'procorePunchItemStatus',width:202,localized:{fieldLabel:'PRO_Update Status'},displayField:'name',valueField:'id',bind:{store:'{procorePunchItemStatuses}',value:'{entityClone.status}'},name:'status'},{xtype:'component',flex:1},{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',localized:{fieldLabel:'PRO_Due Date'},labelSeparator:'',bind:{value:'{entityClone.due_date}'},name:'dueDate',submitFormat:'Y-m-d'}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procorepunchlistupdateitem'],['component','box','container','panel','form','procorepunchlistupdateitem'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorepunchlistupdateitem':!0},['widget.procorepunchlistupdateitem'],0,[procore.view.cards,'PunchListUpdateItem'],0);Ext.cmd.derive('procore.view.form.User',formShared.view.components.ComboMultiselect,{width:'100%',localized:{fieldLabel:'PRO_Assignee',emptyText:'G_Select'},queryMode:'local',displayField:'name',valueField:'id',editable:!0,typeAhead:!0,bind:{value:{bindTo:'{procoreUserID}',single:!0}},getSubmitData:function(){return {assignees:this.getValue().join()}}},0,['procoreuser'],['component','box','field','textfield','pickerfield','combobox','combo','tagfield','detailformmulticombo','procoreuser'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'tagfield':!0,'detailformmulticombo':!0,'procoreuser':!0},['widget.procoreuser'],0,[procore.view.form,'User'],0);Ext.cmd.derive('procore.view.cards.RFICreate',Ext.form.Panel,{reference:'card_RFICreate',layout:'vbox',items:[{xtype:'integrationtype',margin:'0 0 28 0'},{xtype:'container',layout:{type:'hbox',align:'bottom'},width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformtextfield',localized:{fieldLabel:'PRO_Subject'},width:202,allowBlank:!1,name:'title'},{xtype:'component',flex:1},{xtype:'procoreuser',width:202,bind:{store:'{procoreRFIAssignees}'},allowBlank:!1,name:'assignees'}]},{xtype:'container',layout:{type:'hbox',align:'bottom'},width:'100%',margin:'0 0 28 0',items:[{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',localized:{fieldLabel:'PRO_Due Date'},labelSeparator:'',name:'dueDate',submitFormat:'Y-m-d'},{xtype:'component',flex:1},{xtype:'checkboxfield',ui:'plain-16',localized:{boxLabel:'PRO_Draft'},checked:!0,margin:'0 28 0 0',inputValue:!0,uncheckedValue:!1,name:'draft'},{xtype:'checkboxfield',reference:'procoreRFIPrivate',ui:'plain-16',localized:{boxLabel:'PRO_Private'},inputValue:!0,uncheckedValue:!1,name:'private'}]},{xtype:'integrationcomments',localized:{fieldLabel:'PRO_Question'},reference:'procoreRFIQuestion',allowBlank:!1},{xtype:'integrationattachment'}]},0,['procorerficreate'],['component','box','container','panel','form','procorerficreate'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorerficreate':!0},['widget.procorerficreate'],0,[procore.view.cards,'RFICreate'],0);Ext.cmd.derive('procore.view.cards.RFIUpdate',Ext.form.Panel,{reference:'card_RFI',layout:'vbox',items:[{xtype:'integrationtype',margin:'0 0 28 0',width:202},{xtype:'container',layout:{type:'hbox',align:'bottom'},width:'100%',items:[{xtype:'label',text:'RFI',uiCls:'form-item-label-detail-form'},{xtype:'component',flex:1},{xtype:'checkboxgroup',localized:{fieldLabel:'PRO_Filter'},labelStyle:'font-family: Arial, sans-serif; padding-top: 2px;',labelWidth:40,padding:0,publishes:'rfiFilter.value',defaults:{name:'rfiFilter',ui:'plain-16',margin:'0 0 0 8'},items:[{localized:{boxLabel:'PRO_Open'},inputValue:'open'},{localized:{boxLabel:'PRO_Closed'},inputValue:'closed'},{localized:{boxLabel:'PRO_Draft'},inputValue:'draft'}],bind:{value:'{procoreSetting_rfiFilterValue}'}}]},{xtype:'integrationremotelookup',reference:'procoreRFILookup',margin:'0 0 28 0',width:'100%',fieldLabel:''},{xtype:'container',layout:{type:'hbox',align:'bottom'},width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformcombo',width:202,localized:{fieldLabel:'PRO_Update Status'},valueField:'id',displayField:'value',reference:'procoreRFIStatus',bind:{store:'{procoreRFIFilters}'},name:'status'},{xtype:'component',flex:1},{xtype:'checkboxfield',ui:'plain-16',localized:{boxLabel:'PRO_Official Response'},name:'replyOfficial',inputValue:!0,uncheckedValue:!1}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procorerfiupdate'],['component','box','container','panel','form','procorerfiupdate'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorerfiupdate':!0},['widget.procorerfiupdate'],0,[procore.view.cards,'RFIUpdate'],0);Ext.cmd.derive('procore.view.cards.dailylogs.DeliveryLog',Ext.form.Panel,{reference:'card_DeliveryLog',layout:'vbox',items:[{xtype:'procoreloglookup',margin:'0 0 11 0'},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procoredeliverylog'],['component','box','container','panel','form','procoredeliverylog'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoredeliverylog':!0},['widget.procoredeliverylog'],0,[procore.view.cards.dailylogs,'DeliveryLog'],0);Ext.cmd.derive('procore.view.cards.dailylogs.LogLookup',Ext.Container,{layout:'vbox',width:'100%',items:[{xtype:'container',layout:{type:'hbox',align:'bottom'},width:'100%',items:[{xtype:'integrationlookup',width:408,bind:{fieldLabel:'{dailyLogLabel}'},getErrors:function(){if(!this.getStore()||!this.getStore().getCount()){return [mvstr['INTMSG_NoItems']]}if(!this.getValue()){return [mvstr['PROMSG_NoSubLogItem']]}return []}},{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon no-date-display',width:30,ui:'detail-form',reference:'dailyLogDate',name:'date',submitFormat:'Y-m-d',maxValue:new Date(),bind:{value:'{dailyLogDate}'}}]},{xtype:'component',cls:'info-text',margin:'3 0 0 0',localized:{html:'PRO_select day to view lo'}}]},0,['procoreloglookup'],['component','box','container','procoreloglookup'],{'component':!0,'box':!0,'container':!0,'procoreloglookup':!0},['widget.procoreloglookup'],0,[procore.view.cards.dailylogs,'LogLookup'],0);Ext.cmd.derive('procore.view.cards.dailylogs.ManpowerLog',Ext.form.Panel,{reference:'card_ManpowerLog',items:[{xtype:'procoreloglookup',margin:'0 0 11 0'},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'procorelocation',bind:{value:'{entityClone.location.id}'}},{xtype:'component',flex:1},{xtype:'detailformcombo',name:'contact_id',editable:!0,forceSelection:!0,listConfig:{loadMask:!1},width:202,localized:{fieldLabel:'PRO_Company'},displayField:'name',valueField:'id',allowBlank:!0,bind:{store:'{manpowerLogsVendorOptions}',emptyText:'{manpowerLogsVendorOptionsEmptyText}',value:'{entityClone.contact.id}'}}]},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'container',layout:'hbox',width:202,defaults:{xtype:'detailformnumberfield',hideTrigger:!1,step:1,minValue:0,publishes:'value',flex:1},items:[{name:'num_workers',value:1,reference:'manpowerLogsWorkers',localized:{fieldLabel:'PRO_Workers'},bind:{value:'{entityClone.num_workers}'},margin:'0 14 0 0'},{name:'num_hours',value:8,reference:'manpowerLogsHours',localized:{fieldLabel:'PRO_Hours'},bind:{value:'{entityClone.num_hours}'}}]},{xtype:'component',flex:1},{xtype:'detailformcombo',name:'cost_code_id',editable:!0,forceSelection:!0,listConfig:{loadMask:!1},width:202,localized:{fieldLabel:'PRO_Cost Code'},displayField:'name',valueField:'id',allowBlank:!0,bind:{store:'{costCodes}',emptyText:'{costCodesEmptyText}',value:'{entityClone.cost_code.id}'}}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procoremanpowerlog'],['component','box','container','panel','form','procoremanpowerlog'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoremanpowerlog':!0},['widget.procoremanpowerlog'],0,[procore.view.cards.dailylogs,'ManpowerLog'],0);Ext.cmd.derive('procore.view.cards.dailylogs.ManpowerLogCreate',Ext.form.Panel,{reference:'card_ManpowerLogCreate',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'datefield',labelSeparator:'',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',localized:{fieldLabel:'PRO_Date'},name:'date',submitFormat:'Y-m-d',value:new Date()},{xtype:'component',flex:1},{xtype:'procorelocation'}]},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformcombo',name:'contact_id',editable:!0,forceSelection:!0,listConfig:{loadMask:!1},width:202,localized:{fieldLabel:'PRO_Company'},displayField:'name',valueField:'id',allowBlank:!0,bind:{store:'{manpowerLogsVendorOptions}',emptyText:'{manpowerLogsVendorOptionsEmptyText}',value:'{entityClone.contact.id}'}},{xtype:'component',flex:1},{xtype:'container',layout:'hbox',width:202,defaults:{xtype:'detailformnumberfield',hideTrigger:!1,step:1,minValue:0,publishes:'value',flex:1},items:[{name:'num_workers',value:1,reference:'manpowerLogsWorkers',localized:{fieldLabel:'PRO_Workers'},bind:{value:'{entityClone.num_workers}'},margin:'0 14 0 0'},{name:'num_hours',value:8,reference:'manpowerLogsHours',localized:{fieldLabel:'PRO_Hours'},bind:{value:'{entityClone.num_hours}'}}]}]},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformcombo',name:'cost_code_id',editable:!0,forceSelection:!0,listConfig:{loadMask:!1},width:202,localized:{fieldLabel:'PRO_Cost Code'},displayField:'name',valueField:'id',allowBlank:!0,bind:{store:'{costCodes}',emptyText:'{costCodesEmptyText}',value:'{entityClone.cost_code.id}'}}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procoremanpowerlogcreate'],['component','box','container','panel','form','procoremanpowerlogcreate'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoremanpowerlogcreate':!0},['widget.procoremanpowerlogcreate'],0,[procore.view.cards.dailylogs,'ManpowerLogCreate'],0);Ext.cmd.derive('procore.view.cards.dailylogs.NotesLog',Ext.form.Panel,{reference:'card_NotesLog',items:[{xtype:'procoreloglookup',margin:'0 0 11 0'},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'procorelocation',bind:{value:'{entityClone.location.id}'}}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procorenoteslog'],['component','box','container','panel','form','procorenoteslog'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorenoteslog':!0},['widget.procorenoteslog'],0,[procore.view.cards.dailylogs,'NotesLog'],0);Ext.cmd.derive('procore.view.cards.dailylogs.NotesLogCreate',Ext.form.Panel,{reference:'card_NotesLogCreate',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'datefield',labelSeparator:'',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',localized:{fieldLabel:'PRO_Date'},name:'date',submitFormat:'Y-m-d',value:new Date()},{xtype:'component',flex:1},{xtype:'procorelocation'}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procorenoteslogcreate'],['component','box','container','panel','form','procorenoteslogcreate'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procorenoteslogcreate':!0},['widget.procorenoteslogcreate'],0,[procore.view.cards.dailylogs,'NotesLogCreate'],0);Ext.cmd.derive('procore.view.cards.dailylogs.SafetyViolationLog',Ext.form.Panel,{reference:'card_SafetyViolationLog',items:[{xtype:'procoreloglookup',margin:'0 0 11 0'},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procoresafetyviolationlog'],['component','box','container','panel','form','procoresafetyviolationlog'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoresafetyviolationlog':!0},['widget.procoresafetyviolationlog'],0,[procore.view.cards.dailylogs,'SafetyViolationLog'],0);Ext.cmd.derive('procore.view.cards.dailylogs.WeatherLog',Ext.form.Panel,{reference:'card_WeatherLog',layout:'vbox',items:[{xtype:'procoreloglookup',margin:'0 0 11 0'},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformcombo',flex:1,editable:!0,forceSelection:!0,listConfig:{loadMask:!1},localized:{fieldLabel:'PRO_Temperature',emptyText:'G_Select'},name:'temperature',displayField:'value',valueField:'key',allowBlank:!0,bind:{store:'{weatherTemperatures}',value:'{entityClone.temperature}'}},{xtype:'detailformcombo',flex:1,margin:'0 0 0 10',editable:!0,forceSelection:!0,listConfig:{loadMask:!1},localized:{fieldLabel:'PRO_Wind',emptyText:'G_Select'},name:'wind',displayField:'value',valueField:'key',allowBlank:!0,bind:{store:'{weatherWinds}',value:'{entityClone.wind}'}},{xtype:'detailformtextfield',flex:1,margin:'0 0 0 10',name:'precipitation',localized:{fieldLabel:'PRO_Precipitation'},bind:{value:'{entityClone.precipitation}'}}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procoreweatherlog'],['component','box','container','panel','form','procoreweatherlog'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoreweatherlog':!0},['widget.procoreweatherlog'],0,[procore.view.cards.dailylogs,'WeatherLog'],0);Ext.cmd.derive('procore.view.cards.dailylogs.WeatherLogCreate',Ext.form.Panel,{reference:'card_WeatherLogCreate',layout:'vbox',items:[{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'datefield',mvPickerUI:'mds-light',cls:'with-icon',labelAlign:'top',width:202,ui:'detail-form',localized:{fieldLabel:'PRO_Date'},labelSeparator:'',name:'date',submitFormat:'Y-m-d',bind:{value:'{photoExifDateTime}'}},{xtype:'component',flex:1},{xtype:'container',layout:'hbox',width:202,defaults:{xtype:'timefield',ui:'detail-form',minValue:'12:00 AM',width:90,labelAlign:'top',labelSeparator:'',editable:!1,isFormField:!1,formatText:'',bind:{value:'{photoExifDateTime}'}},isFormField:!0,name:'time',isValid:function(){return !0},isDirty:function(){return !0},getSubmitData:function(){var b=Ext.Date.format(this.down('#hour').getValue(),'H'),a=Ext.Date.format(this.down('#minute').getValue(),'i');return {time:b+':'+a,timeString:formShared.IntegrationsUtil.getDisplayDateString({time_hour:b,time_minute:a})}},items:[{maxValue:'11:00 PM',itemId:'hour',increment:60,format:'g A',localized:{fieldLabel:'PRO_Time'},margin:'0 10 0 0',getErrors:function(){return []}},{maxValue:'12:59 AM',itemId:'minute',increment:5,format:'i',fieldLabel:'&nbsp;',getErrors:function(){return []}}]}]},{xtype:'container',layout:'hbox',width:'100%',margin:'0 0 28 0',items:[{xtype:'detailformcombo',flex:1,editable:!0,forceSelection:!0,listConfig:{loadMask:!1},localized:{fieldLabel:'PRO_Temperature',emptyText:'G_Select'},name:'temperature',displayField:'value',valueField:'key',allowBlank:!0,bind:{store:'{weatherTemperatures}',value:'{entityClone.temperature}'}},{xtype:'detailformcombo',flex:1,margin:'0 0 0 10',editable:!0,forceSelection:!0,listConfig:{loadMask:!1},localized:{fieldLabel:'PRO_Wind',emptyText:'G_Select'},name:'wind',displayField:'value',valueField:'key',allowBlank:!0,bind:{store:'{weatherWinds}',value:'{entityClone.wind}'}},{xtype:'detailformtextfield',flex:1,margin:'0 0 0 10',name:'precipitation',localized:{fieldLabel:'PRO_Precipitation'},bind:{value:'{entityClone.precipitation}'}}]},{xtype:'integrationcomments'},{xtype:'integrationattachment'}]},0,['procoreweatherlogcreate'],['component','box','container','panel','form','procoreweatherlogcreate'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'procoreweatherlogcreate':!0},['widget.procoreweatherlogcreate'],0,[procore.view.cards.dailylogs,'WeatherLogCreate'],0);Ext.cmd.derive('procore.view.form.Location',formShared.view.components.Combo,{name:'location_id',editable:!0,forceSelection:!0,listConfig:{loadMask:!1},width:202,localized:{fieldLabel:'PRO_Location'},displayField:'name',valueField:'id',allowBlank:!0,bind:{store:'{locations}',emptyText:'{locationsEmptyText}'}},0,['procorelocation'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','procorelocation'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'procorelocation':!0},['widget.procorelocation'],0,[procore.view.form,'Location'],0);Ext.cmd.derive('procore.view.form.ProjectAndCompany',Ext.container.Container,{layout:'hbox',margin:'0 0 28 0',padding:'25 0 0 25',width:463,items:[{xtype:'detailformcombo',width:202,localized:{fieldLabel:'PRO_Company',emptyText:'G_Select'},queryMode:'local',displayField:'name',valueField:'id',disabled:!0,bind:{store:'{procoreCompanies}',value:'{procoreSetting_companyID}',disabled:'{!_procoreCompaniesLoaded}'}},{xtype:'component',flex:1},{xtype:'detailformcombo',width:202,reference:'projects',localized:{fieldLabel:'PRO_Project',emptyText:'G_Select'},queryMode:'local',displayField:'name',valueField:'id',disabled:!0,bind:{store:'{procoreProjects}',disabled:'{!_procoreCompaniesLoaded}'},listeners:{change:'onProjectChange'}}]},0,['procoreprojectandcompany'],['component','box','container','procoreprojectandcompany'],{'component':!0,'box':!0,'container':!0,'procoreprojectandcompany':!0},['widget.procoreprojectandcompany'],0,[procore.view.form,'ProjectAndCompany'],0);Ext.cmd.derive('procore.view.procorewindow.ProcoreWindow',Ext.window.Window,{ui:'orange',cls:'integration-window separate-form-error-message',modalMaskCls:'dark-mask',loadMaskCls:'light-load-indicator',viewModel:{type:'procorewindow'},controller:'procorewindow',config:{photos:null,includeAnnotations:!0,PushpinUID:'',attachFloorplanOnly:!1,PhotoDate:null,width:488,defaultHeight:650,datePhoto:null,Photo360ID:null},updateAttachFloorplanOnly:function(a){this.getViewModel().set('attachFloorplanOnly',a)},padding:'0 0 25 0',defaultAlign:'t-t',modal:!0,localized:{title:'PRO_Add to Procore'},noRepositionFloatingItems:!0,layout:{type:'vbox'},scrollable:!0,bind:{disabled:'{saving}'},dockedItems:[{xtype:'container',reference:'warning',dock:'top',cls:'warning',layout:{type:'hbox',align:'center'},minHeight:41,padding:10,hidden:!0,bind:{hidden:'{!warningMessage}'},items:[{xtype:'component',flex:1,bind:{html:'<span>{warningMessage}</span>'}}]},{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},padding:'25 0 0 0',items:[{xtype:'button',scale:'medium',ui:'grey',text:'Cancel',margin:'0 12 0 12',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',bind:{processing:'{saving}',done:'{saveDone}'},margin:'0 12 0 12',listeners:{click:function(){this.lookupController().submitPhotos()}}}]}],items:[{xtype:'procoreprojectandcompany'},{xtype:'panel',width:463,padding:'0 0 0 25',layout:'card',reference:'cards',items:[{xtype:'procoredefault'},{xtype:'procorerfiupdate'},{xtype:'procorerficreate'},{xtype:'procoredailylog'},{xtype:'procorepunchlistassignment'},{xtype:'procorepunchlistupdateitem'},{xtype:'procorepunchlistcreateitem'},{xtype:'procorechangeevent'},{xtype:'procoreobservation',reference:'card_Observation_ObservationResponse'},{xtype:'procoreobservation',reference:'card_Observation_ObservationItem'},{xtype:'procoreobservationcreate'},{xtype:'procorephotosnewalbum'},{xtype:'procorephotosexistingalbum'},{xtype:'procoremeeting'}]}],listeners:{boxready:'onBoxReady'},destroy:function(){var b=this.lookupController().entityStores;for(var a=0;a<b.length;a++){b[a].destroy()}return Ext.window.Window.prototype.destroy.apply(this,arguments)}},0,['procorewindow'],['component','box','container','panel','window','procorewindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'procorewindow':!0},['widget.procorewindow'],0,[procore.view.procorewindow,'ProcoreWindow'],0);Ext.cmd.derive('procore.view.procorefloorplanexport.ProcoreFloorplanExportModel',procore.view.procorewindow.ProcoreWindowModel,{formulas:{submitReady:function(a){return !!a('procoreDocumentTitle.value')},warningMessage:function(b){var c=b('errorMessage'),a='',d=!!(b('showAlertMessage')||c);if(!d||b('submitReady')){a=''}else {if(!b('procoreDocumentTitle.value')){a='You cannot export the document because no title was specified.'}}if(a){this.set('errorMessage','')}else {if(c){a=c}}this.set('warningHeight',a?41:0);if(!a){this.set('showAlertMessage',!1)}return a},integrationEntityType:function(){return 'Documents'},entityStore:function(){return ''},subType:function(){return ''},integrationEntityTypes:function(){return Ext.create('Ext.data.Store',{proxy:{type:'memory'},model:'formShared.model.IntegrationEntityType',data:[{id:'Documents',name:'Documents',storeType:'procore.store.Documents',createAction:'submitToDocuments'}]})}}},0,0,0,0,['viewmodel.procorefloorplanexport'],0,[procore.view.procorefloorplanexport,'ProcoreFloorplanExportModel'],0);Ext.cmd.derive('procore.view.procorefloorplanexport.ProcoreFloorplanExportController',procore.view.procorewindow.ProcoreWindowController,{init:function(){procore.view.procorewindow.ProcoreWindowController.prototype.init.apply(this,arguments);this.lookupReference('procoreDocumentTitle').setValue(this.getView().getFileTitle())}},0,0,0,0,['controller.procorefloorplanexport'],0,[procore.view.procorefloorplanexport,'ProcoreFloorplanExportController'],0);Ext.cmd.derive('procore.view.procorefloorplanexport.ProcoreFloorplanExport',procore.view.procorewindow.ProcoreWindow,{viewModel:{type:'procorefloorplanexport'},config:{fileTitle:'',defaultHeight:478},controller:'procorefloorplanexport',items:[{xtype:'procoreprojectandcompany'},{xtype:'panel',width:463,padding:'0 0 0 25',layout:'card',reference:'cards',items:[{xtype:'procoredefault'},{xtype:'procoredocuments'}]}]},0,['procorewindow-floorplanexport'],['component','box','container','panel','window','procorewindow','procorewindow-floorplanexport'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'procorewindow':!0,'procorewindow-floorplanexport':!0},['widget.procorewindow-floorplanexport'],0,[procore.view.procorefloorplanexport,'ProcoreFloorplanExport'],0);Ext.cmd.derive('aconex.model.ListMail',Ext.data.Model,{idProperty:'mailId',fields:[{name:'mailId',type:'string'},{name:'reasonForIssue',type:'string'},{name:'subject',type:'string'},{name:'status',type:'string'},{name:'correspondenceType',type:'string'},{name:'fromUserId',type:'string'},{name:'mailNo',type:'string'},{name:'displayField',calculate:function(e){var c=e.subject;var f=/&#(\d+);|([^&])/g;var d;var b=[];while(d=f.exec(c)){if(d[1]!=null){b.push(d[1])}else {b.push(d[2].charCodeAt(0))}}if(b.length<2){var a=c.replace(/&/g,'&amp;');console.log(a);return e.mailNo+' - '+a}var a=String.fromCharCode.apply(null,b);c=a!=null?a:c;return e.mailNo+' - '+a}}]},0,0,0,0,0,0,[aconex.model,'ListMail'],0);Ext.cmd.derive('aconex.model.MandatoryFieldModel',Ext.data.Model,{idProperty:'id',fields:[{name:'id',type:'string'},{name:'name',type:'string'},{name:'type',type:'string'},{name:'values'},{name:'rules'},{name:'mailFormField',type:'boolean',defaultValue:!1},{name:'restrictedField',type:'boolean',defaultValue:!1}]},0,0,0,0,0,0,[aconex.model,'MandatoryFieldModel'],0);Ext.cmd.derive('aconex.model.MandatoryFieldValue',Ext.data.Model,{idProperty:'id',fields:[{name:'id',type:'string'},{name:'value',type:'string'}]},0,0,0,0,0,0,[aconex.model,'MandatoryFieldValue'],0);Ext.cmd.derive('aconex.model.Project',Ext.data.Model,{idProperty:'ProjectId',fields:[{name:'ProjectId',type:'int'},{name:'ProjectName',type:'string'},{name:'ExportTypes',type:'string'},{name:'MailTypes',type:'string'},{name:'StatusTypes',type:'string'},{name:'OfficialResponse',type:'boolean'}]},0,0,0,0,0,0,[aconex.model,'Project'],0);Ext.cmd.derive('aconex.model.User',Ext.data.Model,{idProperty:'UserId',fields:[{name:'UserId',type:'int'},{name:'UserName',type:'string'}]},0,0,0,0,0,0,[aconex.model,'User'],0);Ext.cmd.derive('aconex.view.aconexwindow.AconexWindowModel',Ext.app.ViewModel,{stores:{aconexProjects:{storeId:'loadedAconexProjects',model:'aconex.model.Project',proxy:{url:'/index.cfm?fuseaction=aAconex.getProjects'},autoLoad:!0,listeners:{load:'onProjectsLoaded'}},integrationEntityTypes:{proxy:{type:'memory'},model:'formShared.model.IntegrationEntityType',data:[{id:'Photo',name:'Photo',createAction:'uploadPhotos'},{id:'Document',name:'Document',createAction:'uploadDocuments'},{id:'RFICreate',name:'Mail - Create',createAction:'createRFI'},{id:'RFIUpdate',name:'Mail - Update',storeType:'aconex.model.ListMail',createAction:'submitToRFI',searchFields:['mailId','reasonForIssue','subject','status']}]},aconexUsers:{storeId:'aconexUsers',model:'aconex.model.User',proxy:{url:'/index.cfm?fuseaction=aAconex.getAconexUsers',extraParams:{project_id:'{aconexSetting_projectID}'}},autoLoad:!1,listeners:{load:'onUsersLoaded'}},aconexListMail:{storeId:'aconexListMail',model:'aconex.model.ListMail',proxy:{url:'/index.cfm?fuseaction=aAconex.listMailInBox',extraParams:{project_id:'{aconexSetting_projectID}'}},mvAutoLoadVars:!0,autoLoad:!1},aconexRFIFilters:{storeId:'aconexRFIFiltersStore',proxy:{type:'memory'},data:[{value:'N/A',id:'N/A'},{value:'Closed-Out',id:'Closed-Out'},{value:'Outstanding',id:'Outstanding'},{value:'Overdue',id:'Overdue'},{value:'Responded',id:'Responded'}]},documentMandatoryFields:{storeId:'documentMandatoryFields',model:'aconex.model.MandatoryFieldModel',proxy:{url:'/index.cfm?fuseaction=aAconex.getAconexDocumentFields',extraParams:{project_id:'{aconexSetting_projectID}'}},autoLoad:!1},rfiCreateMandatoryFields:{storeId:'rfiCreateMandatoryFields',model:'aconex.model.MandatoryFieldModel',proxy:{url:'/index.cfm?fuseaction=aAconex.getAconexCreateMailFields',timeout:180000},autoLoad:!1},rfiUpdateMandatoryFields:{storeId:'rfiUpdateMandatoryFields',model:'aconex.model.MandatoryFieldModel',proxy:{url:'/index.cfm?fuseaction=aAconex.getAconexReplyMailFields&loadMetadata=true'},autoLoad:!1}},data:{private_aconexSetting_projectID:null,private_aconexSetting_entityType:null,private_aconexSetting_attachAsPhoto:null,private_aconexSetting_attachAs4View:null,private_aconexSetting_rfiFilterValue:null,singlePhotoTitle:'',projectsLoaded:!1,usersLoaded:!1,saving:!1,saveDone:!1,errorMessage:'',recentMail:[],lastRfiQuery:'',lastQueryMail:[],rfiFilters:[],attachFloorplanOnly:!1,officialResponseHidden:!1,uiCustomizations:null},formulas:{aconexSetting_projectID:{get:function(b){var a=b('private_aconexSetting_projectID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getAconexSetting_projectID()},set:function(a){this.set('private_aconexSetting_projectID',a);mdsPreferences.ProjectPreferences.setAconexSetting_projectID(a)}},integrationEntityType:{get:function(b){var a=b('private_aconexSetting_entityType');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getAconexSetting_entityType()},set:function(a){this.set('private_aconexSetting_entityType',a);mdsPreferences.ProjectPreferences.setAconexSetting_entityType(a)}},aconexSetting_attachAsPhoto:{get:function(c){var a=c('private_aconexSetting_attachAsPhoto');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getAconexSetting_attachAsPhoto();return b===undefined?!1:b},set:function(a){this.set('private_aconexSetting_attachAsPhoto',a);mdsPreferences.ProjectPreferences.setAconexSetting_attachAsPhoto(a)}},aconexSetting_attachAs4View:{get:function(c){var a=c('private_aconexSetting_attachAs4View');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getAconexSetting_attachAs4View();return b===undefined?!0:b},set:function(a){this.set('private_aconexSetting_attachAs4View',a);mdsPreferences.ProjectPreferences.setAconexSetting_attachAs4View(a)}},aconexSetting_rfiFilterValue:{get:function(b){var a=b('private_aconexSetting_rfiFilterValue');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getAconexSetting_rfiFilterValue();return c||'open'},set:function(a){this.set('private_aconexSetting_rfiFilterValue',a);mdsPreferences.ProjectPreferences.setAconexSetting_rfiFilterValue(a)}},entityType:function(a){return a('integrationEntityTypes').getById(a('integrationEntityType'))},activeCardIndex:function(b){var a=b('integrationEntityType');if(a=='Photo'||a=='Document'){return 1}else {if(a=='RFICreate'){return 2}else {if(a=='RFIUpdate'){return 3}}}return 0},projectSelected:function(a){return a('projectsLoaded')&&a('aconexSetting_projectID')},singlePhotoSelected:function(a){return this.getView().getPhotos().length===1},multiplePhotosSelected:function(a){return this.getView().getPhotos().length>1},isPhotoEntityType:function(a){return a('integrationEntityType')=='Photo'},isDocumentEntityType:function(a){return a('integrationEntityType')=='Document'},commentsFieldLabel:function(a){if(a('integrationEntityType')=='RFICreate'){return 'Question'}return 'Comments'},submitReady:function(a){var b=a('projectsLoaded');var d=a('aconexSetting_projectID');var c=a('integrationEntityType');return b&&d>0&&c},saveDisabled:function(a){return !a('submitReady')}}},0,0,0,0,['viewmodel.aconexwindow'],0,[aconex.view.aconexwindow,'AconexWindowModel'],0);Ext.cmd.derive('aconex.view.aconexwindow.AconexWindowController',Ext.app.ViewController,{entityStores:[],init:function(){var a=this.getViewModel();window.awc=this;a.bind({singlePhotoSelected:'{singlePhotoSelected}',ProjectUID:'{ProjectUID}'},function(b){var c=this.getView().getPhotos();a.set('singlePhotoTitle','');if(b.singlePhotoSelected){Ext.Ajax.request({url:'/index.cfm?fuseaction=aAconex.getPhotoTitle',params:{ProjectUID:b.ProjectUID,photos:c[0]},successCallback:function(c){a.set('singlePhotoTitle',c)}})}},this);Ext.defer(function(){this.getView().showBy(Ext.getBody(),'t-t?',[0,this.getWindowY(Ext.getBody().getHeight())],!1)},1,this);Ext.getBody().addListener('resize',function(b,a){this.getView().setPosition(this.getWindowX(a.width),this.getWindowY(a.height),!1,!0)},this,{buffer:200})},aconexUIPreferences:function(a){var d=this.getViewModel();var b=a.get('ExportTypes').split(',');var c=a.get('StatusTypes').split(',');var i=a.get('MailTypes').split(',');var j=a.get('OfficialResponse');if(!j){d.set('officialResponseHidden',!0)}else {d.set('officialResponseHidden',!1)}var e=d.getStore('integrationEntityTypes');e.clearFilter();e.filterBy(function(c){if(b[0]===''){return !0}else {if(b.length==1&&b.includes(c.get('name'))){return !0}else {if(b.includes(c.get('name'))){return !0}}}return !1});var g=Ext.data.StoreManager.lookup('aconexRFIFiltersStore');g.clearFilter();g.filterBy(function(b){if(c[0]===''){return !0}else {if(c.length==1&&c.includes(b.get('value'))){return !0}else {if(c.includes(b.get('value'))){return !0}}}return !1});var h=[];var f=Ext.data.StoreManager.lookup('rfiCreateMandatoryFields');f.clearFilter();f.filterBy(function(b){if(i[0]===''){return !0}else {if(b.data.name==='Mail Type'){for(var c=0;c<b.data.values.length;c++){if(i.includes(b.data.values[c].value)){h.push(b.data.values[c])}}b.data.values=h;return !0}}})},getWindowX:function(a){return Math.max(0,(a-this.getView().el.getWidth())/2)},getWindowY:function(a){var b=(a-699)/2,c=this.getView().el.getHeight();if(b+c>a){b=(a-c)/2}return Math.max(0,b)},onBoxReady:function(){var a=this.getStore('aconexProjects');if(a&&a.isLoaded()){return}this.lookup('mainContainer').setLoading(!0)},onProjectsLoaded:function(c,i,f,g){this.lookup('mainContainer').setLoading(!1);if(f){var b=this.getViewModel();var a=b.get('aconexSetting_projectID');b.set('projectsLoaded',!0);var d=this.lookup('projects');if(a&&c.getById(a)){d.setValue(a);this.aconexUIPreferences(c.getById(a))}else {if(c.getCount()==1){var e=c.getAt(0);b.set('aconexSetting_projectID',e.id);d.setValue(e.id);this.aconexUIPreferences(e)}else {b.set('aconexSetting_projectID',0);d.clearValue()}}}else {var h=g.getError()||'Failed to load Aconex projects';Ext.Msg.alert('Error',h);this.getView().destroy()}},onUsersLoaded:function(c,b,a){this.getViewModel().set('usersLoaded',a)},onProjectChange:function(c,a){var b=this.getViewModel();b.set({aconexSetting_projectID:a,errorMessage:''});b.notify();if(a>0){this.getAconexUsers(a);this.getAconexDocumentFields(a);this.getAconexCreateMailFields(a);this.getAconexListMail(a);this.aconexUIPreferences(b.getStore('aconexProjects').getById(a))}},getAconexUsers:function(a){this.getStore('aconexUsers').load({scope:this,callback:function(e,d,c){if(!c){var b=this.getViewModel();if(b.get('integrationEntityType')==='RFICreate'){b.set('errorMessage','Failed to load aconex users');console.error('Failed to load Aconex users for project '+a)}}}})},getAconexDocumentFields:function(c){var a=this.getViewModel();var b=a.getStore('documentMandatoryFields');b.load({callback:function(e,d,b){if(!b){if(a.get('integrationEntityType')==='Photo'||a.get('integrationEntityType')==='Document'){a.set('errorMessage','Failed to load required fields')}}}})},getAconexListMail:function(b){var a=this.getStore('aconexListMail');a.removeAll();a.un('load',this.rfiMailLoaded,this);a.on('load',this.rfiMailLoaded,this);a.load({params:{project_id:b,searchText:''}})},mailBeforeQuery:function(a){var e=this.getViewModel();var f=e.get('lastRfiQuery');if(!a.query||f===a.query){var d=this.lookup('aconexListMailCombo');var c=this.getStore('aconexListMail');var b=e.get(a.query?'lastQueryMail':'recentMail');if(b&&b.length||c.isLoading()){d.lastQuery=f;if(b&&b.length&&!c.isLoading()){c.setData(b);c.totalCount=b.length}a.cancel=!0;d.getPicker().refresh();d.expand()}}e.set('lastRfiQuery',a.query);return a},rfiMailLoaded:function(g,c,f,e){var b=this.getViewModel();var a=b.get('lastRfiQuery');if(f){var d=this.lookup('aconexListMailCombo');if(d){d.lastQuery=a;if(c.length===1){d.setSelection(c[0])}}b.set(a?'lastQueryMail':'recentMail',c)}else {if(b.get('integrationEntityType')==='RFIUpdate'){b.set('errorMessage','Failed to '+(a?'search':'load')+' Aconex Mail')}console.error('Failed to '+(a?'search':'load')+' Aconex Mail ',e);console.log(e.getError().statusText)}},rfiMailChangeHandler:function(b,a){this.getAconexReplyMailFields(a)},rfiFilterChangeHandler:function(e,f){var d=this.getViewModel();var a=d.get('rfiFilters');var c=e.config.inputValue;if(f){a.push(c)}else {a.splice(a.indexOf(c),1)}var b=d.get('aconexListMail');if(b.isLoaded()){b.clearFilter();if(a.length>0){b.filter(function(b){return a.indexOf(b.get('status'))!=-1})}}},getAconexCreateMailFields:function(b){var a=this.getViewModel();var c=a.getStore('rfiCreateMandatoryFields');c.load({params:{project_id:b},scope:this,callback:function(f,d,h){if(h){for(var e=0;e<f.length;e++){var c=f[e];if(c.id==='MailTypeId'){var g=this.filterMailTypes(c.get('values'));c.set('values',g);break}}}else {if(a.get('integrationEntityType')==='RFICreate'){a.set('errorMessage','Failed to load required fields')}console.error('Failed to load rfi create required fields',d,b);console.log(d.getError().statusText);console.log('operation failure debug',d)}}})},getAconexReplyMailFields:function(b){var a=this.getViewModel();var d=a.getStore('rfiUpdateMandatoryFields');if(!b){d.removeAll();return}var c=a.get('aconexSetting_projectID');d.load({params:{project_id:c,mailId:b},scope:this,callback:function(f,g,i){if(i){for(var e=0;e<f.length;e++){var d=f[e];if(d.id==='MailTypeId'){var h=this.filterMailTypes(d.get('values'));d.set('values',h);break}}}else {if(a.get('integrationEntityType')==='RFIUpdate'){a.set('errorMessage','Failed to load required fields')}console.error('Failed to load RFI update required fields',g,c,b);console.log(g.getError().statusText)}}})},filterMailTypes:function(b){var d=b;if(b&&b.length){var e=this.getViewModel().get('uiCustomizations');if(e&&e.rfiMailTypes){var c=e.rfiMailTypes;d=[];for(var g=0;g<b.length;g++){var a=b[g];var f=!1;if(a.id in c&&c[a.id]===!0){f=!0}else {if(a.value in c&&c[a.value]===!0){f=!0}else {console.log('*** Skipping mail type',a)}}if(f){d.push(a)}}}}return d},findMailTypeMandatoryField:function(b){var c=0;for(var a=0;a<b.length;a++){var d=b[a];if(d.id==='MailTypeId'){c=d.value;break}}return c},getCreateAction:function(){var a=this.getViewModel().get('entityType');return a.get('createAction')},getSubmitParams:function(){var b=this.getViewModel(),j=this.getView().getPhotos(),c=b.get('integrationEntityType'),h=this.getView().getPushpinUID();var f=c=='Photo';var m=c=='Document';var k=c=='RFICreate';var l=c=='RFIUpdate';var e=b.get('aconexProjects');if(!e.isLoaded()||e.getCount()==0){b.set('errorMessage','There are no projects available');return null}var g=b.get('aconexSetting_projectID');var i=e.getById(g);if(!i){b.set('errorMessage','Please select a Project');return null}if(!c){b.set('errorMessage','Please select a Type');return null}var d=this.lookup('aconexAttachment');var a={ProjectUID:b.get('ProjectUID'),photos:j.join(','),project_id:g,includeAnnotations:this.getView().getIncludeAnnotations(),projectName:i.get('ProjectName'),attachAsPhoto:f||d.down('#attachPhoto').getValue(),attachAs4View:f?!1:d.down('#attachDetails').getValue(),attachAsFloorplan:this.getViewModel().get('attachFloorplanOnly'),comment:this.lookup('aconexComments').getValue()};if(a.attachAsFloorplan){a.attachAsPhoto=a.attachAs4View=!1;a.FloorplanUID=b.get('FloorplanUID');a.displayHeader=d.down('#headerCheckbox').getValue();a.displayHotspots=d.down('#hotspotsCheckbox').getValue();a.displayPushpins=d.down('#pushpinsCheckbox').getValue()}if(h){a.PushpinUID=h}if(f||m){a=this.addPhotoDocumentParams(a,j.length===1,c)}else {if(k){a=this.addRFICreateParams(a)}else {if(l){a=this.addRFIUpdateParams(a)}}}return a},addPhotoDocumentParams:function(a,e,f){var c=this.getViewModel();a.aconexProjectTypeId=0;a.mandatoryFields=this.lookup('documentMandatoryFields').getMandatoryValues();for(var b=0;b<a.mandatoryFields.length;b++){var d=a.mandatoryFields[b];if(d.id==='DocumentTypeId'){a.aconexProjectTypeId=d.value;a.mandatoryFields.splice(b,1);break}}if(!a.aconexProjectTypeId){c.set('errorMessage','Please select a Project Type');return null}if(e){a.title=c.get('singlePhotoTitle')}return a},addRFICreateParams:function(a){var c=this.getViewModel();var b=this.lookup('card_RFICreate');var g=b.down('#assignee').getValue();if(g.length===0){c.set('errorMessage','Must select an Assignee');return null}var e=this.lookup('rfiCreateMandatoryFields');var d=e.getMandatoryValues();var h=this.findMailTypeMandatoryField(d);if(!h){c.set('errorMessage','Please select a Mail Type');return null}var f=e.validateMandatoryFields(d);if(f){c.set('errorMessage','Must set a value for '+f.name);return null}if(!a.comment){c.set('errorMessage','A question must be provided.');return null}a.title=b.down('#subject').getValue();a.mandatoryFields=d;a.assignee=g;a.assigneecc=b.down('#assigneecc').getValue();a.assigneebcc=b.down('#assigneebcc').getValue();a.isPrivate=b.down('#private').getValue();var i=b.down('#draft').getValue();a.updateStatus=i?'DRAFT':'Outstanding';return a},addRFIUpdateParams:function(a){var b=this.getViewModel();var f=this.lookup('card_RFIUpdate');var j=f.down('#mailCombo');var e=j.getSelection();var k=j.getValue();if(!e||!k){b.set('errorMessage','Please select an RFI to update');return null}a.toUserId=e.get('fromUserId');var g=this.lookup('rfiUpdateMandatoryFields');var d=g.getMandatoryValues();var l=this.findMailTypeMandatoryField(d);if(!l){b.set('errorMessage','Please select a Mail Type');return null}var i=g.validateMandatoryFields(d);if(i){b.set('errorMessage','Must set a value for '+i.name);return null}var h=f.down('#updateStatus').getValue();if(!h){b.set('errorMessage','Please set the Update Status');return null}if(!a.comment){b.set('errorMessage','A comment must be provided.');return null}var c=e.get('subject')||'';if(c&&c.indexOf('Re: ')===-1){c='Re: '+c}a.title=c;a.mailId=k;a.updateStatus=h;a.officialResponse=f.down('#officialResponse').getValue();a.mandatoryFields=d;return a},submitPhotos:function(){var b=this.getViewModel();var a=this.getSubmitParams();if(!a){return}if(location.href.indexOf('test=true')!==-1){a.test=!0}var d=b.get('account.features.uploadscenterVisible'),c=this.getCreateAction();a.asynchronous=d;console.log('Uploading photos/documents',a);b.set({saving:!0,errorMessage:''});Ext.Ajax.request({url:'/index.cfm?fuseaction=aAconex.'+c,jsonData:a,successCallback:function(e){if(d){var g=a.photos.split(',');if(e.photoFinalActionProcessIds&&e.photoFinalActionProcessIds.length==1&&(c=='createRFI'||c=='submitToRFI')){var f=[];for(var h=0;h<g.length;h++){f.push(e.photoFinalActionProcessIds[0])}e.photoFinalActionProcessIds=f}window.app.fireEvent('reloadfileuploads',{sourceType:'integration',responseData:e,photos:g})}else {b.set('saveDone',!0)}if(e&&e.callback){e.callback()}Ext.defer(function(){b.set('saving',!1);this.getView().destroy()},1000,this)},afterFailMessageCallback:function(c,a){b.set({saving:!1,errorMessage:a||mvstr.G_UnexpectedError})},noAlert:!0,scope:this});this.logExportAnalyticsEvent(a)},logExportAnalyticsEvent:function(a){if(a.attachAsFloorplan){analytics.Ctrl.log('Exported Floorplan',{'Floorplan UID':a.FloorplanUID,'Integration':'Procore'})}else {var b='Photo Viewer Menu';if(location.href.toLowerCase().indexOf('clientphotolist')!==-1){b='Photo List Menu'}analytics.Ctrl.log('Exported Photo',{'Photo List':a.photos,'Photo Action Element':b,'Integration':'Aconex'})}}},0,0,0,0,['controller.aconexwindow'],0,[aconex.view.aconexwindow,'AconexWindowController'],0);Ext.cmd.derive('aconex.view.cards.Default',Ext.Container,{reference:'card_default'},0,['aconexdefault'],['component','box','container','aconexdefault'],{'component':!0,'box':!0,'container':!0,'aconexdefault':!0},['widget.aconexdefault'],0,[aconex.view.cards,'Default'],0);Ext.cmd.derive('aconex.view.form.SingleUser',formShared.view.components.Combo,{width:'100%',emptyText:'- Select -',displayField:'UserName',valueField:'UserId',editable:!1,publishes:'value',disabled:!0,bind:{disabled:'{!usersLoaded}',store:'{aconexUsers}'}},0,['aconexsingleuser'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','aconexsingleuser'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'aconexsingleuser':!0},['widget.aconexsingleuser'],0,[aconex.view.form,'SingleUser'],0);Ext.cmd.derive('aconex.view.cards.MandatoryFields',Ext.Container,{layout:'column',columnWidth:1,margin:0,cls:'mandatory-fields',fieldIdObjectMap:null,fieldIdComponentMap:null,presetFieldValues:null,fieldIdRulesMap:null,store:null,getStore:function(){return this.store},setStore:function(a){if(this.store){this.store.off('beforeload',this.storeBeforeLoad,this);this.store.off('load',this.storeLoaded,this)}this.store=a;if(this.store){this.store.on('beforeload',this.storeBeforeLoad,this);this.store.on('load',this.storeLoaded,this);if(this.store.isLoading()){this.setLoading()}}},createLoadingSpinner:function(){return {xtype:'component',html:'Loading required fields...',cls:'mandatory-fields-spinner',columnWidth:1}},storeBeforeLoad:function(){this.setLoading()},setLoading:function(){this.removeAll(!0);this.add(this.createLoadingSpinner())},storeLoaded:function(c,b,a){console.log(this.reference+' mandatory fields loaded',a,b);this.removeAll(!0);if(a){Ext.defer(function(){this.setMandatoryFields(c.getRange())},100,this)}},setMandatoryFields:function(b){this.fieldIdObjectMap={};this.fieldIdComponentMap={};this.presetFieldValues=[];this.fieldIdRulesMap={};var h=0.5;var i='0 12 15 12';if(b&&b.length>0){var k=[];var j=0;var g=0;for(var e=0;e<b.length;e++){var a=b[e].data||b[e];var d;var c=!0;if(a.rules&&a.rules.length){this.fieldIdRulesMap[a.id]=a.rules;g++;c=this.isMandatory(a.rules)}var f=a.values;if(f){if(f.length===1&&a.id!=='DocumentTypeId'&&a.id!=='MailTypeId'&&!a.rules){this.presetFieldValues.push({id:a.id,value:f[0].id});continue}d=this.createMultiValueField(a,c,h,i)}else {d=this.createSingleValueField(a,c,h,i)}this.fieldIdObjectMap[a.id]=a;this.fieldIdComponentMap[a.id]=d;if(!c){continue}k.push(d);j++}console.log(this.reference+' adding '+j+' mandatory fields, '+g+' conditional fields');this.add(k);this.addConditionalRuleListeners()}},createMultiValueField:function(a,f,e,j){var k='detailformcombo';if(a.type==='user'){return this.createSingleUserCombo(a,f,e,j)}var h=!1;var l=!1;var i=!1;if(a.id==='Attribute1'||a.id==='Attribute2'||a.id==='Attribute3'||a.id==='Attribute4'){k='detailformmulticombo';h=!0;l=!0;i=46}var c='';if(a.values.length>0){var b=[];for(var d=0;d<a.values.length;d++){var g=a.values[d];if(g.selected){b.push(g.id)}}if(b.length===0){b.push(a.values[0].id)}if(b.length>1){c=b}else {c=b[0]}}return Ext.create({xtype:k,columnWidth:e,margin:j,fieldLabel:a.name,queryMode:'local',displayField:'value',valueField:'id',hidden:!f,forceSelection:!0,typeAhead:h,grow:l,growMax:i,store:Ext.create('Ext.data.Store',{model:'aconex.model.MandatoryFieldValue',data:a.values}),value:c})},createSingleValueField:function(d,h,f,j){var g='detailformtextfield';var b=d.type;var a=d.value||'';var i=NaN;var l=!1;if(b==='boolean'){return this.createCheckBox(d,h,f,j)}else {if(b==='user'){return this.createSingleUserCombo(d,h,f,j)}}if(b==='int'||b==='integer'||b==='long'||b==='double'||b==='number'){g='detailformnumberfield';a=Ext.isNumeric(a)?a:0;l=b==='double'||b==='number'}else {if(b==='multi_line_text'){g='detailformtextarea';i=100;f=1}else {if(b==='date'){g='detailformdatefield';if(a){var m=a.match(/^\d{4}-\d\d-\d\d/);if(m){a=Ext.Date.parse(m[0],'Y-m-d')}else {a=new Date(a)}if(isNaN(a.getTime())){a=null}}if(!a){a=Ext.Date.add(new Date(),Ext.Date.DAY,1)}}}}var c={xtype:g,fieldLabel:d.name,columnWidth:f,margin:j,publishes:'value',allowBlank:!1,allowDecimals:l,value:a,hidden:!h};if(d.specs){for(var k=0;k<d.specs.length;k++){var e=d.specs[k];if(e.id==='minLength'){c.minLength=parseInt(e.value)}else {if(e.id==='maxLength'){c.maxLength=parseInt(e.value);c.enforceMaxLength=!0}else {if(e.id==='allowBlank'&&e.value){c.allowBlank=!0}}}}}if(c.allowBlank){c.labelClsExtra='optional-label'}if(!isNaN(i)){c.height=i}return Ext.create(c)},createCheckBox:function(d,b,a,c){return Ext.create({xtype:'checkboxfield',ui:'plain-16',boxLabel:d.name,labelSeparator:'',cls:'rfi-field-checkbox',checked:!1,columnWidth:a,margin:c,hidden:!b})},createSingleUserCombo:function(d,b,a,c){return Ext.create({xtype:'aconexsingleuser',fieldLabel:d.name,columnWidth:a,margin:c,hidden:!b,forceSelection:!0})},addConditionalRuleListeners:function(){var d={};var l=0;var i=[];for(var c in this.fieldIdRulesMap){var f=this.fieldIdRulesMap[c];if(c in this.fieldIdComponentMap){for(var h=0;h<f.length;h++){var j=f[h];var a=j.id;if(a&&a in this.fieldIdComponentMap){var b=this.fieldIdComponentMap[a];var g=b.getStore?b.getStore():null;if(!(a in d)){if(b.getValue()&&this.isMandatory(f)){i.push(this.fieldIdComponentMap[c])}b.on('change',function(a,d,b,c){this.checkRulesForTarget(a)}.bind(this,a));d[a]=[]}var k={};var e=j.values;if(e&&e.length){k[c]=e.map(function(b){var a=b.id||'';if(g&&g.getById(a)){return a+' - '+g.getById(a).get('value')}return a}).join(', ')}d[a].push(k);l++}}}}this.addConditionalFields(i)},checkRulesForTarget:function(g){var f=0;var e=[];for(var c in this.fieldIdRulesMap){var b=this.fieldIdRulesMap[c];for(var d=0;d<b.length;d++){var h=b[d];if(h.id===g){if(c in this.fieldIdComponentMap){var a=this.fieldIdComponentMap[c];if(a){if(this.isMandatory(b)){e.push(a)}else {this.removeConditionalField(a)}}}f++;break}}}this.addConditionalFields(e)},addConditionalFields:function(a){if(a.length>0){this.add(a);for(var b=0;b<a.length;b++){a[b].show()}}},removeConditionalField:function(a){a.hide();if(a.ownerCt){this.remove(a,{destroy:!1})}},isMandatory:function(j){var a=!1;for(var e=0;e<j.length;e++){var d=j[e];var c=d.id;if(c in this.fieldIdComponentMap){var b=this.fieldIdComponentMap[c];if(b){var i=b.getValue();if('values' in d){var g=d.values;for(var f=0;f<g.length;f++){var h=g[f];if('id' in h){var k=h.id;if(k==i){a=!0;break}}}}else {if(b.isVisible()){a=!!i}}}else {console.log('** No target comp for '+c)}}if(a){break}}return a},getMandatoryValues:function(){if(this.presetFieldValues==null){console.warn('Preset field values never set');return []}var b=this.presetFieldValues.slice(0);for(var g in this.fieldIdComponentMap){var d=this.fieldIdComponentMap[g];if(d.isVisible()){var c=d.getValue();if(d.xtype==='detailformdatefield'&&Ext.isDate(c)){c=Ext.Date.format(c,'Y-m-d')}var a={id:g,value:c};b.push(a)}}for(var e=0;e<b.length;e++){a=b[e];if(a.id in this.fieldIdObjectMap){var f=this.fieldIdObjectMap[a.id];if(f.mailFormField){a.mailFormField=!0}else {if(f.restrictedField){a.restrictedField=!0}}}}return b},validateMandatoryFields:function(c){for(var b=0;b<c.length;b++){var a=c[b];var e=a.value;if(Ext.isEmpty(a.value)){var d=this.getStore().getById(a.id);var f=d?d.get('name'):a.id;return {id:a.id,name:f,value:e}}}return null}},0,['mandatoryfields'],['component','box','container','mandatoryfields'],{'component':!0,'box':!0,'container':!0,'mandatoryfields':!0},['widget.mandatoryfields'],0,[aconex.view.cards,'MandatoryFields'],0);Ext.cmd.derive('aconex.view.cards.PhotoDocument',Ext.Container,{reference:'card_PhotoDocument',layout:'column',items:[{xtype:'detailformtextfield',reference:'aconexPhotoTitle',fieldLabel:'Title',emptyText:'Enter title',margin:'0 12 15 12',columnWidth:1,publishes:'value',hidden:!0,bind:{hidden:'{multiplePhotosSelected}',value:'{singlePhotoTitle}'}},{xtype:'mandatoryfields',reference:'documentMandatoryFields',bind:{store:'{documentMandatoryFields}'}}]},0,['aconexphotodocument'],['component','box','container','aconexphotodocument'],{'component':!0,'box':!0,'container':!0,'aconexphotodocument':!0},['widget.aconexphotodocument'],0,[aconex.view.cards,'PhotoDocument'],0);Ext.cmd.derive('aconex.view.form.User',formShared.view.components.ComboMultiselect,{width:'100%',emptyText:'- Select -',displayField:'UserName',valueField:'UserId',editable:!0,typeAhead:!0,publishes:'value',disabled:!0,grow:!0,bind:{disabled:'{!usersLoaded}',store:'{aconexUsers}'}},0,['aconexuser'],['component','box','field','textfield','pickerfield','combobox','combo','tagfield','detailformmulticombo','aconexuser'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'tagfield':!0,'detailformmulticombo':!0,'aconexuser':!0},['widget.aconexuser'],0,[aconex.view.form,'User'],0);Ext.cmd.derive('aconex.view.form.ExpandUserGroup',Ext.Container,{layout:{type:'vbox',align:'stretch'},items:[{xtype:'component',cls:'expand-user-group-link',html:'<a href="javascript:void(0)" class="cc" title="Show Cc field">Cc</a><a href="javascript:void(0)" class="bcc" title="Show Bcc field">Bcc</a>',height:0,liquidLayout:!0,listeners:{click:{fn:function(c,a){if(a.getAttribute('class')=='cc'){Ext.getCmp('aconexUserCc').show()}else {Ext.getCmp('aconexUserBcc').show()}var b=a.parentNode;a.parentNode.removeChild(a);if(b.children.length===0){b.parentNode.removeChild(b)}},element:'el',delegate:'a'}}},{xtype:'aconexuser',itemId:'assignee',fieldLabel:'Assignee',allowBlank:!1},{xtype:'aconexuser',fieldLabel:'Cc',hidden:!0,margin:'15 0 0 0',id:'aconexUserCc',itemId:'assigneecc'},{xtype:'aconexuser',fieldLabel:'Bcc',hidden:!0,margin:'15 0 0 0',id:'aconexUserBcc',itemId:'assigneebcc'}]},0,['expandusergroup'],['component','box','container','expandusergroup'],{'component':!0,'box':!0,'container':!0,'expandusergroup':!0},['widget.expandusergroup'],0,[aconex.view.form,'ExpandUserGroup'],0);Ext.cmd.derive('aconex.view.cards.RFICreate',Ext.Container,{reference:'card_RFICreate',layout:'column',defaults:{margin:'0 12 15 12',columnWidth:0.5},items:[{xtype:'detailformtextfield',reference:'aconexNewRFISubject',fieldLabel:'Subject',columnWidth:1,itemId:'subject',publishes:'value'},{xtype:'expandusergroup',columnWidth:1},{xtype:'mandatoryfields',columnWidth:1,margin:0,reference:'rfiCreateMandatoryFields',bind:{store:'{rfiCreateMandatoryFields}'}},{xtype:'container',layout:{type:'hbox',align:'bottom'},columnWidth:1,margin:'10 12 10 12',items:[{xtype:'checkboxfield',reference:'aconexRFIDraft',ui:'plain-16',boxLabel:'Draft',itemId:'draft',checked:!1,margin:'0 28 0 0'},{xtype:'checkboxfield',reference:'aconexRFIPrivate',ui:'plain-16',boxLabel:'Private',itemId:'private'}]}]},0,['aconexrficreate'],['component','box','container','aconexrficreate'],{'component':!0,'box':!0,'container':!0,'aconexrficreate':!0},['widget.aconexrficreate'],0,[aconex.view.cards,'RFICreate'],0);Ext.cmd.derive('aconex.view.cards.RFIUpdate',Ext.Container,{reference:'card_RFIUpdate',layout:'column',defaults:{margin:'0 12 15 12',columnWidth:1},items:[{xtype:'container',layout:{type:'hbox',align:'bottom'},margin:'0 12 0 12',items:[{xtype:'label',text:'Inbox',uiCls:'form-item-label-detail-form'},{xtype:'component',flex:1},{xtype:'button',text:'Filter',ui:'plain',cls:'rfi-filter-btn',menuAlign:'tr-br',menu:{plain:!0,scrollable:!1,shadow:!0,width:125,cls:'rfi-filter-menu',defaults:{xtype:'menucheckitem',checkHandler:'rfiFilterChangeHandler'},items:[{text:'N/A',inputValue:'N/A'},{text:'Closed-Out',inputValue:'Closed-Out'},{text:'Outstanding',inputValue:'Outstanding'},{text:'Overdue',inputValue:'Overdue'},{text:'Responded',inputValue:'Responded'}]}}]},{xtype:'detailformcombo',itemId:'mailCombo',reference:'aconexListMailCombo',emptyText:'- Select -',queryMode:'remote',queryDelay:600,queryCaching:!0,queryParam:'searchText',triggerAction:'last',minChars:4,displayField:'displayField',valueField:'mailId',editable:!0,disabled:!0,bind:{store:'{aconexListMail}',disabled:'{!projectsLoaded}'},listeners:{beforequery:'mailBeforeQuery',change:'rfiMailChangeHandler'}},{xtype:'mandatoryfields',columnWidth:1,margin:0,reference:'rfiUpdateMandatoryFields',bind:{store:'{rfiUpdateMandatoryFields}'}},{xtype:'detailformcombo',columnWidth:0.5,itemId:'updateStatus',fieldLabel:'Update Status',valueField:'id',displayField:'value',reference:'aconexRFIStatus',publishes:'value',bind:{store:'{aconexRFIFilters}'}},{xtype:'checkboxfield',itemId:'officialResponse',reference:'rfiOfficialResponse',ui:'plain-16',boxLabel:'Official Response',columnWidth:0.5,labelSeparator:'',cls:'rfi-field-checkbox',checked:!1,hidden:!0,bind:{hidden:'{officialResponseHidden}'}}]},0,['aconexrfiupdate'],['component','box','container','aconexrfiupdate'],{'component':!0,'box':!0,'container':!0,'aconexrfiupdate':!0},['widget.aconexrfiupdate'],0,[aconex.view.cards,'RFIUpdate'],0);Ext.cmd.derive('aconex.view.aconexwindow.AconexWindow',Ext.window.Window,{ui:'orange',cls:'integration-window',modalMaskCls:'dark-mask',viewModel:{type:'aconexwindow'},controller:'aconexwindow',config:{photos:null,includeAnnotations:!0,PushpinUID:'',attachFloorplanOnly:!1},updateAttachFloorplanOnly:function(a){this.getViewModel().set('attachFloorplanOnly',a)},width:532,maxHeight:710,modal:!0,title:'Add to Aconex',layout:{type:'vbox',align:'stretch'},bind:{disabled:'{saving}'},dockedItems:[{xtype:'container',reference:'warning',dock:'top',cls:'warning',layout:{type:'hbox',align:'center'},minHeight:41,padding:10,hidden:!0,bind:{hidden:'{!errorMessage}'},items:[{xtype:'component',flex:1,bind:{html:'<span>{errorMessage}</span>'}}]},{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},padding:'15 0 0 0',height:65,items:[{xtype:'button',scale:'medium',ui:'grey',text:'Cancel',margin:'0 10 0 0',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',disabled:!0,bind:{processing:'{saving}',done:'{saveDone}',disabled:'{saveDisabled}'},margin:'0 0 0 10',listeners:{click:'submitPhotos'}}]}],items:[{xtype:'container',layout:'column',defaults:{margin:'0 12 15 12',columnWidth:1},padding:'20 12 0 12',scrollable:'y',maxHeight:600,reference:'mainContainer',loadMaskCls:'light-load-indicator',items:[{xtype:'detailformcombo',reference:'projects',id:'projectsComboBox',fieldLabel:'Project',emptyText:'- Select -',queryMode:'local',displayField:'ProjectName',valueField:'ProjectId',disabled:!0,columnWidth:0.5,bind:{store:'{aconexProjects}',value:'{aconexSetting_projectID}',disabled:'{!projectsLoaded}'},listeners:{change:'onProjectChange'}},{xtype:'integrationtype',columnWidth:0.5},{xtype:'container',layout:'card',margin:0,items:[{xtype:'aconexdefault'},{xtype:'aconexphotodocument'},{xtype:'aconexrficreate'},{xtype:'aconexrfiupdate'}],bind:{activeItem:'{activeCardIndex}'}},{xtype:'integrationcomments',reference:'aconexComments',height:100,hidden:!0,allowBlank:!0,setAllowBlank:function(a){if(a!=this.allowBlank){this.allowBlank=a;if(a){this.validateValue(this.getValue())}}},bind:{hidden:'{isPhotoEntityType}',fieldLabel:'{commentsFieldLabel}',allowBlank:'{isDocumentEntityType}'}},{xtype:'integrationattachment',reference:'aconexAttachment',photoBinding:'{aconexSetting_attachAsPhoto}',pdfBinding:'{aconexSetting_attachAs4View}',hidden:!0,bind:{hidden:'{isPhotoEntityType}'}}]}],doRealign:Ext.emptyFn,listeners:{boxready:'onBoxReady'},setPosition:function(c,d,b,a){if(a){return Ext.window.Window.prototype.setPosition.apply(this,arguments)}},destroy:function(){var b=this.lookupController().entityStores;for(var a=0;a<b.length;a++){b[a].destroy()}return Ext.window.Window.prototype.destroy.apply(this,arguments)}},0,['aconexwindow'],['component','box','container','panel','window','aconexwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'aconexwindow':!0},['widget.aconexwindow'],0,[aconex.view.aconexwindow,'AconexWindow'],0);Ext.cmd.derive('bim360.model.Folder',Ext.data.Model,{fields:[{name:'id',type:'string'},{name:'attributes'},{name:'displayField',calculate:function(a){return a.attributes?a.attributes.name:''}}]},0,0,0,0,0,0,[bim360.model,'Folder'],0);Ext.cmd.derive('bim360.model.Hub',Ext.data.Model,{fields:[{name:'id',type:'string'},{name:'attributes'},{name:'name',calculate:function(a){return a.attributes?a.attributes.name:''}}]},0,0,0,0,0,0,[bim360.model,'Hub'],0);Ext.cmd.derive('bim360.model.Project',Ext.data.Model,{fields:[{name:'id',type:'string'},{name:'attributes'},{name:'name',calculate:function(a){return a.attributes.name}}]},0,0,0,0,0,0,[bim360.model,'Project'],0);Ext.cmd.derive('bim360.store.Folders',Ext.data.Store,{model:'bim360.model.Folder',proxy:{api:{create:'/index.cfm?fuseaction=aBim360.createFolder',read:'/index.cfm?fuseaction=aBim360.getProjectFilesFolders'},writer:{writeAllFields:!1}}},0,0,0,0,0,0,[bim360.store,'Folders'],0);Ext.cmd.derive('bim360.store.Projects',Ext.data.Store,{model:'bim360.model.Project',proxy:{url:'/index.cfm?fuseaction=aBim360.getProjects'}},0,0,0,0,0,0,[bim360.store,'Projects'],0);Ext.cmd.derive('bim360.view.bim360window.Bim360WindowModel',Ext.app.ViewModel,{stores:{bim360Hubs:{model:'bim360.model.Hub',autoLoad:!1,mvAutoLoadVars:!0,proxy:{url:'/index.cfm?fuseaction=aBim360.getDocsHubs'}},bim360Projects:{proxy:{type:'memory'}},integrationEntityTypes:{proxy:{type:'memory'},model:'formShared.model.IntegrationEntityType',data:[{id:'Documents',name:'Documents',createAction:'uploadDocuments',storeType:'bim360.store.Folders'}]},bim360DocumentActions:{proxy:{type:'memory'},data:[{id:'CreateNewFolder',name:'Create New Folder'},{id:'AddToExistingFolder',name:'Add to Existing Folder'}]}},data:{private_bim360Setting_hubID:null,private_bim360Setting_projectID:null,private_bim360Setting_entityType:null,private_integrationAttachAsPhoto:null,private_integrationAtachAs4View:null,private_bim360Setting_documentAction:null,private_bim360Setting_folderID:null,entityID:'',projectsLoaded:!1,bim360ObservationStatus:'',entityStoreLoaded:!1,cardHeight:500,warningHeight:0,saving:!1,saveDone:!1,errorMessage:'',showAlertMessage:!1,integrationEntityType:'Documents',attachFloorplanOnly:!1},formulas:{bim360Setting_hubID:{get:function(b){var a=b('private_bim360Setting_hubID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getBim360Setting_hubID()},set:function(a){this.set('private_bim360Setting_hubID',a);mdsPreferences.ProjectPreferences.setBim360Setting_hubID(a)}},bim360Setting_projectID:{get:function(b){var a=b('private_bim360Setting_projectID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getBim360Setting_projectID()},set:function(a){this.set('private_bim360Setting_projectID',a);mdsPreferences.ProjectPreferences.setBim360Setting_projectID(a)}},integrationAttachAsPhoto:{get:function(c){var a=c('private_integrationAttachAsPhoto');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getBim360Setting_attachAsPhoto();return b===undefined?!1:b},set:function(a){this.set('private_integrationAttachAsPhoto',a);mdsPreferences.ProjectPreferences.setBim360Setting_attachAsPhoto(a)}},integrationAtachAs4View:{get:function(c){var a=c('private_integrationAtachAs4View');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getBim360Setting_attachAs4View();return b===undefined?!0:b},set:function(a){this.set('private_integrationAtachAs4View',a);mdsPreferences.ProjectPreferences.setBim360Setting_attachAs4View(a)}},bim360Setting_documentAction:{get:function(b){var a=b('private_bim360Setting_documentAction');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getBim360Setting_documentAction();return c||'AddToExistingFolder'},set:function(a){this.set('private_bim360Setting_documentAction',a);mdsPreferences.ProjectPreferences.setBim360Setting_documentAction(a)}},bim360Setting_folderID:{get:function(b){var a=b('private_bim360Setting_folderID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}var c=mdsPreferences.ProjectPreferences.getBim360Setting_folderID();return c||undefined},set:function(b){var a=this.get('entityStore');if(a&&a.$className=='bim360.store.Folders'&&a.isLoaded()&&!a.getById(b)){return}this.set('private_bim360Setting_folderID',b);mdsPreferences.ProjectPreferences.setBim360Setting_folderID(b)}},entityType:function(a){return a('integrationEntityTypes').getById(a('integrationEntityType'))},entity:function(a){var c=a('integrationEntityType');if(!c){return null}var b=a('entityStore');if(!b||!a('entityStoreLoaded')){return null}return b.getById(a('calculatedEntityID'))},projectSelected:function(a){return a('projectsLoaded')&&a('bim360Setting_projectID')},subType:function(b){var a=b('entityType');if(a){var c=a.getId();if(c=='Documents'){return b('bim360Setting_documentAction')}}return null},calculatedEntityID:function(a){if(a('subType')=='AddToExistingFolder'){return a('bim360Setting_folderID')}return a('entityID')},dailyLogDateID:function(a){return Ext.Date.format(a('dailyLogDate'),'Ymd')},submitReady:function(a){var b=a('entityType'),c=a('subType');if(!b){return !1}if(b.getId()=='Documents'&&c=='CreateNewFolder'){return !!a('bim360NewFolderName.value')}return a('calculatedEntityID')&&(a('integrationAttachAsPhoto')||a('integrationAtachAs4View'))},entityStoreID:function(b){var a=b('entityType'),c=b('bim360Setting_projectID');if(!a){return null}var d='bim360_'+a.get('name').replace(' ','')+'_'+c;return d},entityStore:function(a){var g=a('entityType'),d=a('entityStoreType');if(!g||!d){return Ext.create('Ext.data.Store',{proxy:'memory'})}var f=a('entityType').getId(),e=a('entityStoreID'),b=Ext.getStore(e),c=this.getView().lookupController();if(!b&&a('bim360Setting_hubID')&&a('bim360Setting_projectID')){b=Ext.create(d,{storeId:e,autoLoad:!0,proxy:{extraParams:c.getEntityStoreParams(f)},listeners:{load:c.onEntityStoreLoad,scope:c}})}if(b){this.set('entityStoreLoaded',b.isLoaded())}return b},entityStoreType:function(c){var a=c('entityType');if(!a){return null}var b=a.get('storeType');if(!b){return 'bim360.store.'+a+'s'}return b},card:function(b){var a=this.getView().lookupController(),c=b('integrationEntityType'),f=b('subType'),e=b('bim360Setting_projectID'),d=a.lookupReference('card_default');return e?a.lookupReference('card_'+c+'_'+f)||a.lookupReference('card_'+c)||d:d},itemDescription:function(a){return 'item'},lowercaseEntityName:function(c){var a=c('entityType');if(!a){return ''}var b=a.get('name');return b.toLowerCase()},emptyText:function(a){var b=a('entityStore'),c=a('entityStoreLoaded');if(a('submitReady')||!b||!c||b.getCount()){return '- Select -'}return 'No '+a('itemDescription')+'s available.'},noItemsAvailable:function(a){var b=a('entityStore'),c=a('entityStoreLoaded');return !(a('submitReady')||!b||!c||b.getCount())},warningMessage:function(a){var d=a('entityStore'),f=a('entityStoreLoaded'),e=a('entityStoreType'),c=a('errorMessage'),b='',g=!!(a('showAlertMessage')||c);if(!g||a('submitReady')||e&&!d||e&&!f){b=''}else {if(!d.getCount()){b='You cannot complete the '+a('lowercaseEntityName')+' submission because there are no '+a('itemDescription')+'s to select.'}else {if(!a('integrationAttachAsPhoto')&&!a('integrationAtachAs4View')){b='You cannot complete the export process until you have chosen what files to attach.'}else {if(a('singlePhotoTitle').trim()==''){b='You cannot complete the export process until you have chosen a title.'}else {if(a('subType')=='AddToExistingFolder'&&!a('bim360Setting_folderID')){b='You cannot complete the export process until you have chosen a folder.'}}}}}if(b){this.set('errorMessage','')}else {if(c){b=c}}this.set('warningHeight',b?41:0);if(!b){this.set('showAlertMessage',!1)}return b},windowHeight:function(a){return a('cardHeight')+a('warningHeight')},multiplePhotosSelected:function(a){return this.getView().getPhotos().length>1}}},0,0,0,0,['viewmodel.bim360window'],0,[bim360.view.bim360window,'Bim360WindowModel'],0);Ext.cmd.derive('bim360.view.bim360window.Bim360WindowController',Ext.app.ViewController,{init:function(){var a=this.getViewModel();a.bind('{bim360Setting_hubID}',this.onHubChange,this);a.bind({_bim360HubsLoaded:'{_bim360HubsLoaded}',private_bim360Setting_hubID:'{bim360Setting_hubID}',singlePhotoTitle:'{singlePhotoTitle}'},function(a){if(a._bim360HubsLoaded&&a.bim360Setting_hubID!==null&&a.singlePhotoTitle){this.onDataReady()}},this);a.bind('{card}',this.onCardChange,this);a.bind('{windowHeight}',this.onWindowHeightChange,this);a.bind('{entityStore}',this.onEntityStoreChange,this);Ext.defer(function(){this.getView().showBy(Ext.getBody(),'t-t?',[0,this.getWindowY(Ext.getBody().getHeight())],!1)},1,this);Ext.getBody().addListener('resize',function(b,a){this.getView().setPosition(this.getWindowX(a.width),this.getWindowY(a.height),!1,!0)},this,{buffer:200});var d=this.getStore('bim360Hubs');d.load({callback:Ext.bind(function(e,b,c){var a=null;if(!c){try{a=Ext.decode(b.getResponse().responseText)}catch(f){}var d=a&&a.message?a.message:mvstr.G_UnexpectedError;Ext.Msg.alert('Error',d);this.getView().destroy()}},this)});var b=this.getView(),c=this.getView().getPhotos();if(c.length==1){Ext.Ajax.request({url:'/index.cfm?fuseaction=aPlanGrid.getPhotoTitle',params:{ProjectUID:this.getViewModel().get('ProjectUID'),photos:c[0]},successCallback:function(a){this.getViewModel().set('singlePhotoTitle',a)},scope:this})}else {this.getViewModel().set('singlePhotoTitle',b.fileTitle?b.fileTitle:'-1')}if(b.attachFloorplanOnly!==undefined){a.set('attachFloorplanOnly',b.attachFloorplanOnly)}},onBoxReady:function(){this.lookupReference('cards').setLoading(!0)},getWindowX:function(a){return Math.max(0,(a-this.getView().el.getWidth())/2)},getWindowY:function(a){var b=(a-699)/2,c=this.getView().el.getHeight();if(b+c>a){b=(a-c)/2}return Math.max(0,b)},onDataReady:function(){this.lookupReference('cards').setLoading(!1)},onProjectsLoaded:function(c){var b=this.getViewModel(),a=b.get('bim360Setting_projectID');b.set('projectsLoaded',!0);if(a&&c.getById(a)){this.lookupReference('projects').setValue(a)}else {this.lookupReference('projects').setValue('')}},onHubChange:function(a){if(a){this.getViewModel().set('bim360Projects',this.getProjectStore(a))}this.getViewModel().set('showAlertMessage',!1)},onProjectChange:function(b,a){if(a){this.getViewModel().set('bim360Setting_projectID',a)}else {this.getViewModel().set('entityID','')}this.getViewModel().set('showAlertMessage',!1)},getProjectStoreID:function(a){return 'bim360ProjectStore-'+a},getProjectStore:function(a){if(!a){return Ext.create('Ext.data.Store',{proxy:{type:'memory'}})}var c=this.getProjectStoreID(a),b=Ext.getStore(c);this.getViewModel().set('projectsLoaded',b&&b.isLoaded());return b||Ext.create('bim360.store.Projects',{autoLoad:!0,proxy:{extraParams:{hub_id:a}},listeners:{load:{fn:this.onProjectsLoaded,scope:this}}})},getEntityStoreId:function(c){var a=this.getStore('integrationEntityTypes').getById(c),d=this.getViewModel().get('bim360Setting_projectID');var b='bim360_'+a.get('name').replace(' ','')+'_'+d;if(a.get('subCreateActions')){b+='_'+this.getViewModel().get('subType')}return b},getEntityStoreParams:function(c){var a=this.getViewModel(),b={project_id:a.get('bim360Setting_projectID'),hub_id:a.get('bim360Setting_hubID')};return b},getCreateAction:function(){var a=this.getStore('integrationEntityTypes').getById(this.getViewModel().get('integrationEntityType')),c=this.getViewModel().get('subType'),b=a.get('subCreateActions');return b?a.get('subCreateActions')[c]:a.get('createAction')},getSubmitParams:function(c){var a=this.getViewModel(),i=this.getView().getPhotos(),h=c&&c.id?c.id:a.get('calculatedEntityID'),d=a.get('card'),e=this.getView().getPushpinUID(),f=a.get('entity'),g=c&&c.displayField?c.displayField:f?f.get('displayField'):'',b={ProjectUID:a.get('ProjectUID'),photos:i.join(','),hub_id:a.get('bim360Setting_hubID'),project_id:a.get('bim360Setting_projectID'),id:h,dateString:Ext.Date.format(new Date(),'ymd'),includeAnnotations:this.getView().getIncludeAnnotations(),displayName:g,projectName:a.get('bim360Projects').getById(a.get('bim360Setting_projectID')).get('name'),asynchronous:this.isAsyncUpload()};if(e){b.PushpinUID=e}if(!a.get('multiplePhotosSelected')){b.title=a.get('singlePhotoTitle')}b.attachAsPhoto=a.get('integrationAttachAsPhoto');b.attachAs4View=a.get('integrationAtachAs4View');b.attachAsFloorplan=a.get('attachFloorplanOnly');if(b.attachAsFloorplan){b.attachAsPhoto=b.attachAs4View=!1;b.FloorplanUID=a.get('FloorplanUID');b.displayHeader=d.down('#headerCheckbox').getValue();b.displayHotspots=d.down('#hotspotsCheckbox').getValue();b.displayPushpins=d.down('#pushpinsCheckbox').getValue()}return b},isAsyncUpload:function(){var b=this.getViewModel(),a=b.get('account.features.uploadscenterVisible');return a},submitPhotos:function(c){var a=this.getViewModel(),d=this.isAsyncUpload();if(!a.get('submitReady')){a.set('showAlertMessage',!0);return}a.set('showAlertMessage',!1);a.set('saving',!0);if(a.get('subType')=='CreateNewFolder'&&!c){this.createNewFolder();return}var b=this.getSubmitParams(c);Ext.Ajax.request({url:'/index.cfm?fuseaction=aBim360.'+this.getCreateAction(),params:b,successCallback:function(e){if(d){window.app.fireEvent('reloadfileuploads',{sourceType:'integration',responseData:e,photos:b.photos.split(',')})}else {a.set('saveDone',!0)}if(e&&e.callback){e.callback()}Ext.defer(function(){this.getView().destroy()},1000,this)},afterFailMessageCallback:function(d,b){a.set('saving',!1);a.set('errorMessage',b?b:mvstr.G_UnexpectedError)},noAlert:!0,scope:this})},createNewFolder:function(){var a=this.getViewModel(),c=a.get('entityStore'),b=Ext.create('bim360.model.Folder',{attributes:{name:this.lookupReference('bim360NewFolderName').getValue()}});c.add(b);c.sync({success:function(){var c=b.getId();this.submitPhotos({id:c,displayField:b.get('displayField'),callback:function(){a.set('bim360Setting_documentAction','AddToExistingFolder');a.set('bim360Setting_folderID',c)}})},afterFailMessageCallback:function(d,b){c.rejectChanges();a.set('saving',!1);a.set('errorMessage',b?b:mvstr.G_UnexpectedError)},scope:this,noAlert:!0})},onCardChange:function(a){if(a){this.lookupReference('cards').setActiveItem(a);this.getViewModel().set('cardHeight',a.getWindowHeight())}this.getViewModel().set('showAlertMessage',!1)},onWarningResize:function(a){this.getViewModel().set('warningHeight',a.el.getHeight())},onEntityStoreLoad:function(a){if(a==this.getViewModel().get('entityStore')){this.getViewModel().set('entityStoreLoaded',!0)}this.updateDefaultFolder()},updateDefaultFolder:function(){var a=this.getViewModel().get('entityStore');if(!a){return}if(a.$className=='bim360.store.Folders'){var e=this.getViewModel().get('bim360Setting_folderID');if(!a.getById(e)){var d=a.getCount();for(var b=0;b<d;b++){var c=a.getAt(b);if(c.get('displayField')=='Multivista'){this.getViewModel().set('bim360Setting_folderID',c.getId());break}}}}},onWindowHeightChange:function(a){this.getView().setHeight(a)},onEntityStoreChange:function(a){this.updateDefaultFolder()}},0,0,0,0,['controller.bim360window'],0,[bim360.view.bim360window,'Bim360WindowController'],0);Ext.cmd.derive('bim360.view.cards.DocumentsNewFolder',Ext.Container,{reference:'card_Documents_CreateNewFolder',layout:'vbox',getWindowHeight:function(){var a=this.up('bim360window').getPhotos();return a.length>1?531:561},items:[{xtype:'integrationssubtype',fieldLabel:'Action',margin:'0 0 28 0',bind:{store:'{bim360DocumentActions}',value:'{bim360Setting_documentAction}'}},{xtype:'detailformtextfield',reference:'bim360NewFolderName',fieldLabel:'Name New Folder',emptyText:'Enter new folder name',margin:'0 0 28 0',width:'100%',publishes:'value'},{xtype:'detailformtextfield',reference:'bim360DocumentTitleNew',fieldLabel:'Title',emptyText:'Enter title',margin:'0 0 28 0',width:'100%',publishes:'value',hidden:!0,bind:{hidden:'{multiplePhotosSelected}',value:'{singlePhotoTitle}'}},{xtype:'integrationattachment',photoBinding:'{integrationAttachAsPhoto}',pdfBinding:'{integrationAtachAs4View}'}]},0,['bim360documentsnewfolder'],['component','box','container','bim360documentsnewfolder'],{'component':!0,'box':!0,'container':!0,'bim360documentsnewfolder':!0},['widget.bim360documentsnewfolder'],0,[bim360.view.cards,'DocumentsNewFolder'],0);Ext.cmd.derive('bim360.view.cards.DocumentsExistingFolder',Ext.Container,{reference:'card_Documents_AddToExistingFolder',layout:'vbox',getWindowHeight:function(){var a=this.up('bim360window').getPhotos();return a.length>1?450:480},items:[{xtype:'container',layout:'hbox',width:'100%',items:[{xtype:'integrationssubtype',fieldLabel:'Action',margin:'0 0 28 0',bind:{store:'{bim360DocumentActions}',value:'{bim360Setting_documentAction}'}},{xtype:'component',flex:1},{xtype:'detailformcombo',width:202,fieldLabel:'Folder',emptyText:'Loading ...',displayField:'displayField',valueField:'id',bind:{value:'{bim360Setting_folderID}',store:'{entityStore}',disabled:'{!entityStoreLoaded}'}}]},{xtype:'detailformtextfield',reference:'bim360DocumentTitleExisting',fieldLabel:'Title',emptyText:'Enter title',margin:'0 0 28 0',width:'100%',publishes:'value',hidden:!0,bind:{hidden:'{multiplePhotosSelected}',value:'{singlePhotoTitle}'}},{xtype:'integrationattachment',photoBinding:'{integrationAttachAsPhoto}',pdfBinding:'{integrationAtachAs4View}'}]},0,['bim360documentsexistingfolder'],['component','box','container','bim360documentsexistingfolder'],{'component':!0,'box':!0,'container':!0,'bim360documentsexistingfolder':!0},['widget.bim360documentsexistingfolder'],0,[bim360.view.cards,'DocumentsExistingFolder'],0);Ext.cmd.derive('bim360.view.cards.Default',Ext.Container,{config:{windowHeight:312},reference:'card_default'},0,['bim360default'],['component','box','container','bim360default'],{'component':!0,'box':!0,'container':!0,'bim360default':!0},['widget.bim360default'],0,[bim360.view.cards,'Default'],0);Ext.cmd.derive('bim360.view.bim360window.Bim360Window',Ext.window.Window,{ui:'orange',cls:'integration-window',modalMaskCls:'dark-mask',viewModel:{type:'bim360window'},controller:'bim360window',config:{photos:null,includeAnnotations:!0,PushpinUID:''},width:488,modal:!0,title:'Add to BIM 360',layout:{type:'fit'},bind:{height:'{windowHeight}',disabled:'{saving}'},dockedItems:[{xtype:'container',reference:'warning',dock:'top',cls:'warning',layout:{type:'hbox',align:'center'},minHeight:41,padding:10,hidden:!0,bind:{hidden:'{!warningMessage}'},listeners:{'resize':'onWarningResize','show':'onWarningResize'},items:[{xtype:'component',flex:1,bind:{html:'<span>{warningMessage}</span>'}}]}],items:[{xtype:'panel',padding:25,layout:'card',reference:'cards',loadMaskCls:'light-load-indicator',dockedItems:[{xtype:'container',dock:'top',layout:'hbox',margin:'0 0 28 0',items:[{xtype:'detailformcombo',width:202,fieldLabel:'Company',emptyText:'- Select -',queryMode:'local',displayField:'name',valueField:'id',disabled:!0,bind:{store:'{bim360Hubs}',value:'{bim360Setting_hubID}',disabled:'{!_bim360HubsLoaded}'}},{xtype:'component',flex:1},{xtype:'detailformcombo',width:202,reference:'projects',fieldLabel:'Project',emptyText:'- Select -',queryMode:'local',displayField:'name',valueField:'id',disabled:!0,bind:{store:'{bim360Projects}',disabled:'{!_bim360HubsLoaded}'},listeners:{change:'onProjectChange'}}]},{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},padding:'25 0 0 0',items:[{xtype:'button',scale:'medium',ui:'grey',text:'Cancel',margin:'0 12 0 12',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',bind:{processing:'{saving}',done:'{saveDone}'},margin:'0 12 0 12',listeners:{click:function(){this.lookupController().submitPhotos()}}}]}],items:[{xtype:'bim360default'},{xtype:'bim360documentsexistingfolder'},{xtype:'bim360documentsnewfolder'}]}],doRealign:Ext.emptyFn,setPosition:function(c,d,b,a){if(a){return Ext.window.Window.prototype.setPosition.apply(this,arguments)}},listeners:{boxready:'onBoxReady'}},0,['bim360window'],['component','box','container','panel','window','bim360window'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'bim360window':!0},['widget.bim360window'],0,[bim360.view.bim360window,'Bim360Window'],0);Ext.cmd.derive('bluebeam.model.Project',Ext.data.Model,{idProperty:'Id',fields:[{name:'$id',type:'string'},{name:'Id',type:'string'},{name:'Guid',type:'string'},{name:'Name',type:'string'},{name:'Restricted',type:'boolean'},{name:'Created',type:'string'},{name:'OwnerEmail',type:'string'},{name:'PrimeId',type:'int'}]},0,0,0,0,0,0,[bluebeam.model,'Project'],0);Ext.cmd.derive('bluebeam.model.User',Ext.data.Model,{idProperty:'UserId',fields:[{name:'$id',type:'int'},{name:'UserId',type:'int'},{name:'Email',type:'int'},{name:'DisplayName',type:'int'},{name:'PrimeMemberRole',type:'int'},{name:'UserRole',type:'int'}]},0,0,0,0,0,0,[bluebeam.model,'User'],0);Ext.cmd.derive('bluebeam.view.bluebeamwindow.BluebeamWindowModel',Ext.app.ViewModel,{stores:{bluebeamProjects:{model:'bluebeam.model.Project',proxy:{url:'/index.cfm?fuseaction=aBluebeam.getProjects'},autoLoad:!0,listeners:{load:'onProjectsLoaded'}},integrationEntityTypes:{proxy:{type:'memory'},model:'formShared.model.IntegrationEntityType',data:[{id:'Photo',name:'Photo',createAction:'uploadPhotos'},{id:'Document',name:'Photo W/ Floorplan',createAction:'uploadDocuments'}]},bluebeamUsers:{storeId:'bluebeamUsers',model:'bluebeam.model.User',proxy:{url:'/index.cfm?fuseaction=aBluebeam.getUser'},autoLoad:!1,listeners:{load:'onUsersLoaded'}}},data:{private_bluebeamSetting_projectID:null,private_bluebeamSetting_entityType:null,private_bluebeamSetting_attachAsPhoto:null,private_bluebeamSetting_attachAs4View:null,private_bluebeamSetting_rfiFilterValue:null,singlePhotoTitle:'',projectsLoaded:!1,usersLoaded:!1,saving:!1,saveDone:!1,errorMessage:'',attachFloorplanOnly:!1,flooplanTitle:''},formulas:{bluebeamSetting_projectID:{get:function(b){var a=b('private_bluebeamSetting_projectID');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getBluebeamSetting_projectID()},set:function(a){this.set('private_bluebeamSetting_projectID',a);mdsPreferences.ProjectPreferences.setBluebeamSetting_projectID(a)}},integrationEntityType:{get:function(b){var a=b('private_bluebeamSetting_entityType');if(a!==null){return a}if(!b('globalPreferencesReady')){return null}return mdsPreferences.ProjectPreferences.getBluebeamSetting_entityType()},set:function(a){this.set('private_bluebeamSetting_entityType',a);mdsPreferences.ProjectPreferences.setBluebeamSetting_entityType(a)}},bluebeamSetting_attachAsPhoto:{get:function(c){var a=c('private_bluebeamSetting_attachAsPhoto');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getBluebeamSetting_attachAsPhoto();return b===undefined?!1:b},set:function(a){this.set('private_bluebeamSetting_attachAsPhoto',a);mdsPreferences.ProjectPreferences.setBluebeamSetting_attachAsPhoto(a)}},bluebeamSetting_attachAs4View:{get:function(c){var a=c('private_bluebeamSetting_attachAs4View');if(a!==null){return a}if(!c('globalPreferencesReady')){return null}var b=mdsPreferences.ProjectPreferences.getBluebeamSetting_attachAs4View();return b===undefined?!0:b},set:function(a){this.set('private_bluebeamSetting_attachAs4View',a);mdsPreferences.ProjectPreferences.setBluebeamSetting_attachAs4View(a)}},entityType:function(a){return a('integrationEntityTypes').getById(a('integrationEntityType'))},activeCardIndex:function(a){return 1},projectSelected:function(a){return a('projectsLoaded')&&a('bluebeamSetting_projectID')},singlePhotoSelected:function(a){return this.getView().getPhotos().length===1},multiplePhotosSelected:function(a){return this.getView().getPhotos().length>1},isPhotoEntityType:function(a){return a('integrationEntityType')=='Photo'},isDocumentEntityType:function(a){return a('integrationEntityType')=='Document'},submitReady:function(a){var b=a('projectsLoaded');var c=a('bluebeamSetting_projectID');return b&&c!==''},saveDisabled:function(a){return !a('submitReady')}}},0,0,0,0,['viewmodel.bluebeamwindow'],0,[bluebeam.view.bluebeamwindow,'BluebeamWindowModel'],0);Ext.cmd.derive('bluebeam.view.bluebeamwindow.BluebeamWindowController',Ext.app.ViewController,{entityStores:[],init:function(){window.bwc=this;var a=this.getViewModel();this.datePhotoWasTaken=Ext.Date.format(new Date(),'Y-m-d');a.bind({singlePhotoSelected:'{singlePhotoSelected}',ProjectUID:'{ProjectUID}'},function(b){var c=this.getView().getPhotos();a.set('singlePhotoTitle','');if(b.singlePhotoSelected){Ext.Ajax.request({url:'/index.cfm?fuseaction=aBluebeam.getPhotoTitle',params:{ProjectUID:b.ProjectUID,photos:c[0]},scope:this,successCallback:function(d){a.set('singlePhotoTitle',d);var c=d.split('-')[2].trim();this.datePhotoWasTaken='20'+c.substr(0,2)+'-'+c.substr(2,2)+'-'+c.substr(4)}})}},this);Ext.defer(function(){this.getAttachFloorplanOnly()},1,this);Ext.defer(function(){this.getView().showBy(Ext.getBody(),'t-t?',[0,this.getWindowY(Ext.getBody().getHeight())],!1)},1,this);Ext.getBody().addListener('resize',function(b,a){this.getView().setPosition(this.getWindowX(a.width),this.getWindowY(a.height),!1,!0)},this,{buffer:200})},getWindowX:function(a){return Math.max(0,(a-this.getView().el.getWidth())/2)},getWindowY:function(a){var b=(a-699)/2,c=this.getView().el.getHeight();if(b+c>a){b=(a-c)/2}return Math.max(0,b)},onBoxReady:function(){this.lookup('mainContainer').setLoading(!0)},onProjectsLoaded:function(d,i,f,h){this.lookup('mainContainer').setLoading(!1);if(f){var a=this.getViewModel();var b=a.get('bluebeamSetting_projectID');a.set('projectsLoaded',!0);var c=this.lookup('projects');if(b&&d.getById(b)){c.setValue(b)}else {if(d.getCount()==1){var e=d.getAt(0);a.set('bluebeamSetting_projectID',e.id);c.setValue(e.id)}else {a.set('bluebeamSetting_projectID',0);c.clearValue()}}}else {var g='Failed to load Bluebeam projects';Ext.Msg.alert('Error',g);this.getView().destroy()}},onUsersLoaded:function(c,b,a){this.getViewModel().set('usersLoaded',a)},onProjectChange:function(c,a){var b=this.getViewModel();b.set({bluebeamSetting_projectID:a,errorMessage:''});b.notify();if(a>0){this.getBluebeamUsers(a)}},getBluebeamUsers:function(a){this.getStore('bluebeamUsers').load({scope:this,callback:function(d,c,b){if(!b){var e=this.getViewModel()}}})},getCreateAction:function(){var a='uploadDocuments';return a},getSubmitParams:function(){var b=this.getViewModel(),h=this.getView().getPhotos(),f=this.getView().getPushpinUID();var d=b.get('bluebeamProjects');if(!d.isLoaded()||d.getCount()==0){b.set('errorMessage','There are no projects available');return null}var e=b.get('bluebeamSetting_projectID');var g=d.getById(e);if(!g){b.set('errorMessage','Please select a Project');return null}var c=this.lookup('bluebeamAttachment');var a={ProjectUID:b.get('ProjectUID'),photos:h.join(','),project_id:e,includeAnnotations:this.getView().getIncludeAnnotations(),projectName:g.get('Name'),attachAsPhoto:c.down('#attachPhoto').getValue(),attachAs4View:c.down('#attachDetails').getValue(),attachAsFloorplan:this.getViewModel().get('attachFloorplanOnly'),comment:this.lookup('bluebeamComments').getValue()};if(a.attachAsFloorplan){a.attachAsPhoto=a.attachAs4View=!1;a.FloorplanUID=b.get('FloorplanUID');a.displayHeader=c.down('#headerCheckbox').getValue();a.displayHotspots=c.down('#hotspotsCheckbox').getValue();a.displayPushpins=c.down('#pushpinsCheckbox').getValue();a.title=b.get('bluebeamPhotoTitle').value}if(f){a.PushpinUID=f}a=this.addPhotoDocumentParams(a,h.length===1);return a},addPhotoDocumentParams:function(a,b){var c=this.getViewModel();if(b){a.title=c.get('singlePhotoTitle')}return a},submitPhotos:function(){var a=this.getViewModel();var b=this.getSubmitParams();if(!b){return}if(location.href.indexOf('test=true')!==-1){b.test=!0}var c=a.get('account.features.uploadscenterVisible');b.asynchronous=c;console.log('Uploading photos/documents',b);a.set({saving:!0,errorMessage:''});Ext.Ajax.request({url:'/index.cfm?fuseaction=aBluebeam.'+this.getCreateAction(),jsonData:b,successCallback:function(b){if(c){app.fireEvent('reloadfileuploads')}else {a.set('saveDone',!0)}if(b&&b.callback){b.callback()}Ext.defer(function(){a.set('saving',!1);this.getView().destroy()},1000,this);this.getView().fireEvent('submissioncomplete')},afterFailMessageCallback:function(c,b){a.set({saving:!1,errorMessage:b||mvstr.G_UnexpectedError})},noAlert:!0,scope:this})},getAttachFloorplanOnly:function(){var a=this.getViewModel();var b=a.get('flooplanTitle');if(b){a.set('integrationEntityType','Document')}}},0,0,0,0,['controller.bluebeamwindow'],0,[bluebeam.view.bluebeamwindow,'BluebeamWindowController'],0);Ext.cmd.derive('bluebeam.view.cards.Default',Ext.Container,{reference:'card_default'},0,['bluebeamdefault'],['component','box','container','bluebeamdefault'],{'component':!0,'box':!0,'container':!0,'bluebeamdefault':!0},['widget.bluebeamdefault'],0,[bluebeam.view.cards,'Default'],0);Ext.cmd.derive('bluebeam.view.cards.PhotoDocument',Ext.Container,{reference:'card_PhotoDocument',layout:'column',items:[{xtype:'detailformtextfield',reference:'bluebeamPhotoTitle',fieldLabel:'Title',emptyText:'Enter title',margin:'0 12 15 12',columnWidth:1,publishes:'value',hidden:!0,bind:{hidden:'{multiplePhotosSelected}',value:['{singlePhotoTitle}{flooplanTitle}']}}]},0,['bluebeamphotodocument'],['component','box','container','bluebeamphotodocument'],{'component':!0,'box':!0,'container':!0,'bluebeamphotodocument':!0},['widget.bluebeamphotodocument'],0,[bluebeam.view.cards,'PhotoDocument'],0);Ext.cmd.derive('bluebeam.view.bluebeamwindow.BluebeamWindow',Ext.window.Window,{ui:'orange',cls:'integration-window',modalMaskCls:'dark-mask',viewModel:{type:'bluebeamwindow'},controller:'bluebeamwindow',config:{photos:null,includeAnnotations:!0,PushpinUID:'',attachFloorplanOnly:!1,flooplanTitle:''},updateAttachFloorplanOnly:function(a){this.getViewModel().set('attachFloorplanOnly',a)},updateFlooplanTitle:function(a){this.getViewModel().set('flooplanTitle',a)},width:532,maxHeight:710,modal:!0,title:'Add to Bluebeam Studio Project',layout:{type:'vbox',align:'stretch'},bind:{disabled:'{saving}'},dockedItems:[{xtype:'container',reference:'warning',dock:'top',cls:'warning',layout:{type:'hbox',align:'center'},minHeight:41,padding:10,hidden:!0,bind:{hidden:'{!errorMessage}'},items:[{xtype:'component',flex:1,bind:{html:'<span>{errorMessage}</span>'}}]},{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},padding:'15 0 0 0',height:65,items:[{xtype:'button',scale:'medium',ui:'grey',text:'Cancel',margin:'0 10 0 0',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',disabled:!0,bind:{processing:'{saving}',done:'{saveDone}',disabled:'{saveDisabled}'},margin:'0 0 0 10',listeners:{click:'submitPhotos'}}]}],items:[{xtype:'container',layout:'column',defaults:{margin:'0 12 15 12',columnWidth:1},padding:'20 12 0 12',scrollable:'y',maxHeight:600,reference:'mainContainer',loadMaskCls:'light-load-indicator',items:[{xtype:'detailformcombo',reference:'projects',id:'projectsComboBox',fieldLabel:'Studio Project',emptyText:'- Select -',queryMode:'local',displayField:'Name',valueField:'Id',disabled:!0,columnWidth:0.5,bind:{store:'{bluebeamProjects}',value:'{bluebeamSetting_projectID}',disabled:'{!projectsLoaded}'},listeners:{change:'onProjectChange'}},{xtype:'container',layout:'card',margin:0,items:[{xtype:'bluebeamdefault'},{xtype:'bluebeamphotodocument'}],bind:{activeItem:'{activeCardIndex}'}},{xtype:'integrationcomments',reference:'bluebeamComments',height:100,hidden:!0,bind:{hidden:'{isPhotoEntityType}',fieldLabel:'{commentsFieldLabel}'}},{xtype:'integrationattachment',reference:'bluebeamAttachment',photoBinding:'{bluebeamSetting_attachAsPhoto}',pdfBinding:'{bluebeamSetting_attachAs4View}',hidden:!0,bind:{hidden:'{isPhotoEntityType}'}}]}],doRealign:Ext.emptyFn,listeners:{boxready:'onBoxReady'},setPosition:function(c,d,b,a){if(a){return Ext.window.Window.prototype.setPosition.apply(this,arguments)}},destroy:function(){var b=this.lookupController().entityStores;for(var a=0;a<b.length;a++){b[a].destroy()}return Ext.window.Window.prototype.destroy.apply(this,arguments)}},0,['bluebeamwindow'],['component','box','container','panel','window','bluebeamwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'bluebeamwindow':!0},['widget.bluebeamwindow'],0,[bluebeam.view.bluebeamwindow,'BluebeamWindow'],0);Ext.cmd.derive('analytics.Ctrl',Ext.Base,{singleton:!0,_optionalDefaultEventProperties:{},_mandatoryDefaultEventProperties:{},_debugMode:!1,constructor:function(){this._mandatoryDefaultEventProperties['URL String']=window.location.href;this.callParent(arguments)},updateAmpProject:function(a){if(!window.amplitude){return}amplitude.getInstance().init(a.ampProject,null,null);amplitude.getInstance().setGroup('projectCompany',a.projectCompany);amplitude.getInstance().setGroup('projectTitle',a.projectTitle)},updateAmpProfile:function(a){if(!window.amplitude){return}var b=a.memberCompanies.split(',');amplitude.getInstance().setUserProperties(a);amplitude.getInstance().init(a.ampProject,null,null);amplitude.getInstance().setUserId(a.memberUID);amplitude.getInstance().setUserProperties(a);amplitude.getInstance().setGroup('memberCompany',b)},log:function(e,a,c){a=a||{};a=Ext.clone(a);for(var b in this._mandatoryDefaultEventProperties){if(a[b]===undefined){a[b]=this._mandatoryDefaultEventProperties[b]}}if(c){for(var d=0;d<c.length;d++){b=c[d];if(this._optionalDefaultEventProperties[b]===undefined){return}if(a[b]===undefined){a[b]=this._optionalDefaultEventProperties[b]}}}if(this._debugMode){console.log(e,a)}else {if(window.amplitude){amplitude.getInstance().logEvent(e,a)}}},setMandatoryDefaultEventProperties:function(a){if(this._debugMode){console.log('Setting analytics mandatory defaults',a)}for(var b in a){this._mandatoryDefaultEventProperties[b]=a[b]}},setOptionalDefaultEventProperties:function(a){if(this._debugMode){console.log('Setting analytics mandatory defaults',a)}for(var b in a){this._optionalDefaultEventProperties[b]=a[b]}},getDateString:function(a){return Ext.Date.format(a,'Y-m-d')}},1,0,0,0,0,0,[analytics,'Ctrl'],0);Ext.cmd.derive('floorplanViewer.FilesValues',Ext.Base,{singleton:!0,FILTERS:{'file':'Documents (.pdf,.doc,.docx)|*.pdf;*.doc;*.docx|Excel (.xls,.xlsx)|*.xls;*.xlsx|Powerpoint (.ppt,.pptx)|*.ppt;*.pptx|Images (.jpg,.png,.gif,.tif(f))|*.jpg;*.png;*.gif;*.tif;*.tiff|Autocad (.dwg,.dxf,.dwf)|*.dwg;*.dxf;*.dwf|Video (.mpg,.mp4,.avi,.mov)|*.mpg;*.mp4;*.avi;*.movRevit (.rvt)|*.rvt','photo':'Images (*.jpg, *.png, *.gif, *.tif, *.tiff)|*.jpg;*.png;*.gif;*.tif;*.tiff'},MAX_FILE_SIZE:{'file':100*1024*1024,'photo':10*1024*1024},ACCEPTED_FILES:{'file':'.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.tif,.tiff,.dwg,.dxf,.dwf,.mpg,.mp4,.avi,.mov,.rvt,.ifc','photo':'.jpg,.jpeg,.png,.gif,.tif,.tiff'},PHOTO_SELECTION_MODE:{'SELECT_BY_PHOTO':0,'SELECT_BY_FLOORPLAN':1}},0,0,0,0,0,0,[floorplanViewer,'FilesValues'],0);Ext.cmd.derive('floorplanViewer.PhotoSelectionData',Ext.Base,{maximumNumberOfPhotos:2100,warningLevelNumberOfPhotos:100,initialDrawPosition:null,layer:null,rectangle:null,selectionMade:!1,selectionMenuActive:!1,cancellable:!1,floorplanViewer:null,map:null,photosBeingSelected:!1,records:null,constructor:function(){this.callParent(arguments);this.mouseDownFunction=Ext.bind(function(a){if(this.selectionMade){if(this.rectangle.getBounds().contains(a.latlng)){return}this.map.removeLayer(this.rectangle);this.initialDrawPosition=null;this.cancellable=!1;this.layer.on('mouseup',this.mouseUpFunction);this.selectionMade=!1;var b=this.floorplanViewer.lookupController().lookupReference('selectHotspotsPopup');b.setHtml("<span class='selectedHotspotText'>"+mvstr['FV_Click and drag to sel']+'</span>');this.floorplanViewer.lookupController().lookupReference('selectHotspotsViewBtn').disable()}this.photosBeingSelected=!0;this.initialDrawPosition=a.latlng;var c=MVLeaflet.latLngBounds(this.initialDrawPosition,a.latlng);this.rectangle=MVLeaflet.rectangle(c,{color:'#ff7800',weight:1,className:'no-pointer-drag'});this.layer.addLayer(this.rectangle);var e=this.floorplanViewer.getEl();var d=e.select('.leaflet-clickable');d.setStyle('cursor','crosshair');this.layer.on('mousemove',this.dragFunction)},this);this.mouseClickFunction=Ext.bind(function(b){if(this.cancellable){this.map.removeLayer(this.rectangle);this.initialDrawPosition=null;this.cancellable=!1;this.layer.off('click',this.mouseClickFunction);this.enableDragging();this.selectionMade=!1;var a=this.floorplanViewer.lookupController().lookupReference('selectHotspotsPopup');a.setHtml("<span class='selectedHotspotText'>"+mvstr['FV_Click and drag to sel']+'</span>');this.floorplanViewer.lookupController().lookupReference('selectHotspotsViewBtn').disable()}else {this.cancellable=!0}},this);this.dragFunction=Ext.bind(function(b){var a=MVLeaflet.latLngBounds(this.initialDrawPosition,b.latlng);this.rectangle.setBounds(a)},this);this.mouseUpFunction=Ext.bind(function(g){this.removeListeners(!1);var a=this.getItemsInSelection();this.photosBeingSelected=!1;if(a==0){this.map.removeLayer(this.rectangle);this.layer.on('mouseup',this.mouseUpFunction);return}this.selectionMade=!0;var d=this.floorplanViewer.lookupController().lookupReference('selectHotspotsPopup');d.setHtml("<span class='selectedHotspotText'>"+mvstr['FV_{x} hotspots selected'].replace('{x}','<b>'+a.length+'</b>')+'</span>');this.floorplanViewer.lookupController().lookupReference('selectHotspotsViewBtn').enable();if(a.length!=0){var c=this;var b=function(a){c.rectangle.off('click',b);c.getIdsAndPost()};this.rectangle.on('click',b)}var f=this.floorplanViewer.getEl();var e=f.select('.no-pointer-drag');e.setStyle('cursor','pointer')},this)},removeListeners:function(a){if(this.layer!=null){this.layer.off('mousemove',this.dragFunction);this.layer.off('mouseup',this.mouseUpFunction);if(a){this.layer.off('mousedown',this.mouseDownFunction)}this.cancellable=!1}},enableDragging:function(){this.layer.on('mousedown',this.mouseDownFunction);this.layer.on('mouseup',this.mouseUpFunction)},getItemsInSelection:function(){var c=this.floorplanViewer.getHotspotsArray();var d=this.rectangle.getBounds();var b=[];for(var f in c){var a=c[f];var e=new MVLeaflet.LatLng(a.geometry.coordinates[1],a.geometry.coordinates[0]);if(d.contains(e)){b.push(a)}}return b},getPhotoIDs:function(e,g){var a=e.split(','),d=this.floorplanViewer.lookupViewModel();if(d.get('account.features.photoviewerVisible')){for(var b=0;b<a.length;b++){a[b]=Number(a[b])}var f=Ext.create('floorplanViewer.model.PhotoGroup',{IdentifierArray:a,Type:'I'}),c=f.getPhotoStore(d.get('ProjectUID'),d.get('storeSession'));if(!c.isLoading()&&!c.isLoaded()){c.load()}app.getMainView().add({xtype:'photoviewer',photoGroup:f}).show();return}Ext.define('PhotoID',{extend:'Ext.data.Model',fields:[{name:'photoID',type:'auto'}]});var h=Ext.create('Ext.data.Store',{model:'PhotoID',proxy:{type:'ajax',url:'/index.cfm?fuseaction=aClientFloorplanViewer.getPhotoIDsByHotspotIDs',actionMethods:{create:'POST'},reader:{type:'json',rootProperty:'users'}},autoLoad:!1});h.load({params:{hotspotIDs:e},callback:function(a,c,b){if(!b){console.error('error',a,c,b);return}if(a.length==0){}this.records=a;if(g){g(a,b)}},scope:this})},asyncGetSelectedHotspotPhotoIDs:function(b){if(this.selectionMade){var d=this.getItemsInSelection();var a=[];for(var e in d){a[e]=d[e].id}var c=a.join();if(a.length>this.maximumNumberOfPhotos){Ext.MessageBox.alert('Status',mvstr['FV_You have selected too'],function(a){})}else {if(a.length>this.warningLevelNumberOfPhotos){var f=mvstr['FV_You have selected {x}'].replace('{x}',a.length);Ext.MessageBox.confirm('Confirm',f,Ext.bind(function(a){if(a=='yes'){this.getPhotoIDs(c,b)}else {this.floorplanViewer.lookupController().resetPhotoSelectionMenu()}},this))}else {this.getPhotoIDs(c,b)}}}},getIdsAndPost:function(){if(this.selectionMade){this.asyncGetSelectedHotspotPhotoIDs(function(a){var b=[];for(var c in a){b[c]=a[c].get('photoID')}Ext.Ajax.postFormData(mdslink.clientPhotoViewer+'ProjectUID='+Ext.Object.fromQueryString(document.location.search).ProjectUID+'&PhotoGroupType=X',{PhotoIDs:b.join(','),UDEFPhotoUIDs:'',WebcamPhotoUIDs:''})})}else {Ext.log('no records selected')}this.floorplanViewer.lookupController().resetPhotoSelectionMenu()}},1,0,0,0,0,0,[floorplanViewer,'PhotoSelectionData'],0);Ext.cmd.derive('floorplanViewer.controller.HoverTimer',Ext.app.Controller,{constructor:function(){Ext.app.Controller.prototype.constructor.apply(this,arguments);this.TIMER_ENABLED=0;this.TIMER_DISABLED=1;this.map=null;this.status=this.TIMER_DISABLED;this.timer=null},setMap:function(a){this.map=a;this.addMouseEventsToPopupLayer()},clearPopupTimer:function(){clearTimeout(this.timer);this.status=this.TIMER_DISABLED;if(this.status==this.TIMER_ENABLED){}},addMouseEventsToPopupLayer:function(){var c=this,b=document.getElementsByClassName('leaflet-popup-pane');for(var a=0;a<b.length;a++){b[a].addEventListener('mouseover',function(){c.clearPopupTimer()});b[a].addEventListener('mouseleave',function(){c.closePopup(c.mouseout)})}},openPopup:function(b,c){this.clearPopupTimer();this.status=this.TIMER_ENABLED;var a=this;this.timer=setTimeout(function(){b();a.status=a.TIMER_DISABLED},c)},closePopup:function(b){this.clearPopupTimer();var a=this;if(b){this.status=this.TIMER_ENABLED;this.timer=setTimeout(function(){a.map.closePopup();a.status=a.TIMER_DISABLED},b)}else {if(this.map){this.map.closePopup()}}},getStatus:function(){return this.status},mouseover:250,mouseout:500,state:this.status},1,0,0,0,0,0,[floorplanViewer.controller,'HoverTimer'],0);Ext.cmd.derive('floorplanViewer.model.Floorplan',Ext.data.Model,{fields:['FloorplanUID','FPID','floorplanTitle',{name:'commentIcons'},{name:'overlayInt'},'imagePath','imageIntPath','imageType','imageWidth','imageHeight','tileSize','numTiles','IsWorkingPlan','ProjectShootTypeUID',{name:'CanHaveHotspots',mapping:function(a){return config.ISARCHIVE?!0:!!a.CanHaveHotspots}},{name:'CanHavePhotos',calculate:function(a){return a.CanHaveHotspots}}],idProperty:'FloorplanUID',proxy:{type:'jsonp',reader:{type:'json',rootProperty:'data'},api:{read:'index.cfm?fuseaction=aClientFloorplanViewer.getFloorplanDetail'}}},0,0,0,0,0,0,[floorplanViewer.model,'Floorplan'],0);Ext.cmd.derive('floorplanViewer.model.FloorplanLegend',Ext.data.Model,{fields:[{name:'type'},{name:'features'}]},0,0,0,0,0,0,[floorplanViewer.model,'FloorplanLegend'],0);Ext.cmd.derive('files.model.PhotoCategory',Ext.data.Model,{fields:[{name:'value',mapping:'text'},{name:'count'},{name:'text',convert:function(d,a){var b=a.get('type');var c=mvstr['PUL_PhotoCategory'+b]||d;if(b=='U'||b=='V'||b=='Y'||b=='P'){return "<span class='photoCategoryName' title='"+c+' ('+a.get('count')+" photos)'>"+c+"</span><span class='photoCategoryCount'> ("+a.get('count')+')</span>'}else {return "<span class='photoGroupName' title='"+c+' ('+a.get('count')+" photos)'>"+c+"</span><span class='photoCategoryCount'> ("+a.get('count')+')</span>'}}},'type','id',{name:'leaf',type:'boolean'},{name:'expanded',type:'boolean'},'photoURL']},0,0,0,0,0,0,[files.model,'PhotoCategory'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.Values',Ext.Base,{singleton:!0,PC_TYPES:{'ALL':'X','MULTIVISTA':'M','SHOOT_TYPE':'C','SECONDARY_SLIDESHOW_TYPE':'K','MY_ALBUMS':'Y','PROJECT_TEAM_ALBUMS':'P','PROJECT_TEAM_PHOTOS':'V','TEAM_MEMBER_PHOTOS':'Z','SHOOT':'D','HOTSPOT':'H','SECONDARY_SLIDESHOW':'L','ALBUM':'A','UDEFPHOTOS':'U','WEBCAM_PHOTOS':'W','PUSHPIN_PHOTOS':'N','SPECIAL':'S'}},0,0,0,0,0,0,[floorplanViewer.view.files.multivistaPhoto,'Values'],0);Ext.cmd.derive('floorplanViewer.store.MultivistaPhotos',Ext.data.Store,{model:'mdsData.model.Photo',proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'/index.cfm?fuseaction=aClientPhotoList.getPhotos2',actionMethods:{read:'POST'}},autoLoad:!1},0,0,0,0,0,0,[floorplanViewer.store,'MultivistaPhotos'],0);Ext.cmd.derive('floorplanViewer.model.PhotoGroup',Ext.data.Model,{fields:['Identifier',{name:'PhotoCount',mapping:'count',type:'int'},{name:'StartDate',type:'tzadate'},{name:'EndDate',type:'tzadate',mapping:function(a){return a.EndDate||a.StartDate}},{name:'Type'},{name:'Description'},{name:'GroupLabel',calculate:function(a){var b=a.Type;if(b==floorplanViewer.view.files.multivistaPhoto.Values.PC_TYPES.SHOOT_TYPE){return 'Multivista Photos'}else {if(b==floorplanViewer.view.files.multivistaPhoto.Values.PC_TYPES.SECONDARY_SLIDESHOW_TYPE){return 'Multivista - '+a.Description}}return 'Other Photos'}},{name:'IsMine',type:'boolean',defaultValue:!1},{name:'Ranking',mapping:function(c){var d=c.Type,b='',a=String(c.Ranking);while(a.length<4){a='0'+a}if(d==floorplanViewer.view.files.multivistaPhoto.Values.PC_TYPES.SHOOT_TYPE){b+='0'+a}if(d==floorplanViewer.view.files.multivistaPhoto.Values.PC_TYPES.SECONDARY_SLIDESHOW_TYPE){b+='1'+a}else {b+='6'}return b}},{name:'id',calculate:function(a){if(a.IdentifierArray&&a.IdentifierArray.length){return a.Type+'_'+Ext.Array.sort(a.IdentifierArray).join('_')}var b=a.Type+'_'+a.Identifier;if(a.StartDate&&a.Type!='H'){b+='_'+Ext.Date.format(a.StartDate,'Y-m-d')}if(a.ArchivePositionID){b+='_'+a.ArchivePositionID}if(a.SlideshowDetails){Ext.Object.eachValue(a.SlideshowDetails,function(c){if(c!==undefined){b+='_'+c}})}return b}},{name:'ImageURL',type:'string'},{name:'Title',type:'string'},{name:'Locations'},{name:'Title2',type:'string',calculate:function(a){var b=Ext.Date.format(a.StartDate,mvstr['DATE_Full']);if(a.Type=='D'&&a.Locations[0]){return a.Locations[0]+' - '+b}return b}},{name:'ProjectShootTypeUID'},{name:'IdentifierArray'},{name:'ArchivePositionID',defaultValue:0},{name:'SlideshowDetails'},{name:'ParentPhoto',defaultValue:null}],getPhotoGroupStoreId:function(){return 'photoGroup_'+this.getId()},getPhotoStore:function(g,f,d,h){var e=this.getPhotoGroupStoreId(),a=Ext.getStore(e);if(!a){var c={ProjectUID:g,Identifier:this.get('Identifier'),LookupDate:Ext.Date.format(this.get('StartDate'),'Y-m-d')},b=this.get('IdentifierArray');if(b&&b.length){c.Identifier=b.join(',')}if(this.get('ArchivePositionID')){if(this.get('SlideshowDetails')){c.SlideshowParams=Ext.JSON.encode(this.get('SlideshowDetails'))}}a=Ext.create('floorplanViewer.store.MultivistaPhotos',{storeId:e,session:f,proxy:{extraParams:c,reader:{transform:{fn:function(b){for(var c=0;c<b.data.length;c++){var a=b.data[c];if(!a.Description&&this.get('Title')){a.Description=this.get('Title')}if(this.get('Type')=='L'&&this.get('Description')){a.Description=this.get('Description')}if(!a.Location&&this.get('Locations')&&this.get('Locations').length){a.Location=this.get('Locations')[0]||''}if(!a.PhotoDate&&this.get('StartDate')){a.PhotoDate=this.get('StartDate')}if(this.get('Type')=='N'){a.PushpinUID=this.get('Identifier')}if(d&&d.getById(a.Identifier)){a.Selected=!0}}return b},scope:this}}},mvCanAbort:!0,listeners:h});a.record=this}if(this.get('Type')==='W'&&!this.get('StartDate')){a.addListener('load',function(){if(a.getCount()){this.set('StartDate',Ext.Date.format(a.getAt(0).get('PhotoDate'),'Y-m-d'));a.setStoreId(this.getPhotoGroupStoreId())}},this,{single:!0})}return a}},0,0,0,0,0,0,[floorplanViewer.model,'PhotoGroup'],0);Ext.cmd.derive('floorplanViewer.model.PushpinType',Ext.data.Model,{fields:[{name:'PushpinTypeID',type:'int'},{name:'PushpinTypeName',type:'string',convert:function(a){var b='FV_'+a;return mvstr[b]||a}},{name:'PushpinSymbol',type:'string'},{name:'PushpinTypeUID',type:'string'},{name:'OrderBy',type:'int'}],idProperty:'PushpinTypeID'},0,0,0,0,0,0,[floorplanViewer.model,'PushpinType'],0);Ext.cmd.derive('floorplanViewer.store.PhotoCategories',Ext.data.Store,{model:'floorplanViewer.model.PhotoGroup',proxy:{url:'/index.cfm?fuseaction=aClientPhotoList.getPhotoGroups2',extraParams:{SkipProtected:1}},sorters:[{property:'Ranking'}],getDateRange:function(){var c=this.getRange(),a={startDate:null,endDate:null};for(var b=0;b<c.length;b++){var d=c[b].get('StartDate'),e=c[b].get('EndDate');if(!a.startDate||d<a.startDate){a.startDate=d}if(!a.endDate||e>a.endDate){a.endDate=e}}return a},getLocations:function(){var a=[];this.each(function(b){a=Ext.Array.merge(a,b.get('Locations'))});return a}},0,0,0,0,['store.photocategories'],0,[floorplanViewer.store,'PhotoCategories'],0);Ext.cmd.derive('floorplanViewer.store.PhotoSelectionMode',Ext.data.Store,{proxy:{type:'memory'},constructor:function(){this.config.data=[{value:floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_PHOTO,text:mvstr['FVCPD_Select by photo']},{value:floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_FLOORPLAN,text:mvstr['FVCPD_Select by floorplan']}];Ext.data.Store.prototype.constructor.apply(this,arguments)}},1,0,0,0,['store.photoselectionmode'],0,[floorplanViewer.store,'PhotoSelectionMode'],0);Ext.cmd.derive('floorplanViewer.store.ProjectPhotos',Ext.data.Store,{model:'mdsData.model.Photo',proxy:{type:'ajax',url:'/index.cfm?fuseaction=aClientPhotoList.getPushpinDialogPhotos',rootProperty:'data'},statics:{getDefaultStoreId:function(b,a){return b+a}}},0,0,0,0,['store.projectphotos'],0,[floorplanViewer.store,'ProjectPhotos'],0);Ext.cmd.derive('floorplanViewer.store.PushpinTypes',Ext.data.Store,{proxy:{type:'jsonp',url:'/index.cfm?fuseaction=aClientFloorplanViewer.getPushpinTypesJSON',reader:{type:'json'}},model:'floorplanViewer.model.PushpinType',sortRoot:'OrderBy',sortOnLoad:!0,sorters:[{property:'OrderBy',direction:'ASC'}],autoLoad:!1},0,0,0,0,['store.pushpintypes'],0,[floorplanViewer.store,'PushpinTypes'],0);Ext.cmd.derive('floorplanViewer.view.ExportMenu',Ext.Container,{cls:'flyout-menu-wrap',floating:!0,shrinkWrap:3,hidden:!0,defaultType:'button',defaults:{width:110,scale:'medium',textAlign:'left',hidden:!0,listeners:{click:{fn:function(a){this.up('exportmenu').hide();this.lookupController().openExportWindow(a.text)}}}},renderTo:Ext.getBody(),x:69,y:143,layout:'vbox',padding:2,items:[{text:'Procore',icon:'mds/image/icon/procore_white.png',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',bind:{hidden:'{!account.procoreEnabled}'}},{text:'PlanGrid',icon:'mds/image/icon/plangrid_white.png',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',bind:{hidden:'{!account.planGridEnabled}'}},{text:'Aconex',icon:'mds/image/icon/aconex_white.png',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',bind:{hidden:'{!account.aconexEnabled}'}},{text:'BIM 360',cls:'bim-360',icon:'mds/image/icon/bim360_white.png',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',bind:{hidden:'{!account.bim360Enabled}'}},{text:'Bluebeam',icon:'mds/image/icon/bluebeam_white.png',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',bind:{hidden:'{!account.bluebeamEnabled}'}}]},0,['exportmenu'],['component','box','container','exportmenu'],{'component':!0,'box':!0,'container':!0,'exportmenu':!0},['widget.exportmenu'],0,[floorplanViewer.view,'ExportMenu'],0);Ext.cmd.derive('floorplanViewer.view.Floorplan',Ext.Container,{reference:'floorplanViewer',config:{map:null,tileLayer:null,miniTileLayer:null,highlightLayer:null,hotspotLayer:null,hotspotCommentLayer:null,hotspotMouseMoveEvent:null,hotspotMouseOutEvent:null,hotspotLayers:[],pushpinLayer:null,pushpinSelectionLayer:null,floorplanRecord:null,zoomControl:null,hotspotsArray:[],pushpinsArray:[],hotspotsLoaded:!1,pushpinsLoaded:!1,_selectedPushpin:{},_tilePathInt:'',_tilePath:'',_numbersVisible:!1,_floorplanViewerMode:{mode:'view'},deselectInteriorPanoHotspots:!1,highlightInteriorPanoHotspots:!0,zoomOutInteriorPanoHotspots:!1,showInteriorPanoHotspots:!0,panoScanLocations:[],panoScanMarkers:[],panoHotspotMarkers:{},animateOptions:null},listeners:{afterrender:function(d,c){var b=window.MVLeaflet;if(b==null){this.update('No leaflet library loaded')}else {this.map=null}var a='move';this.setStyle('cursor',a);this.lookupController().originalMouseCursor=a},onResize:function(e,d,c,b){var a=this.getMap();if(a){a.invalidateSize()}},map_click:'map_click',map_move_start:'map_move_start',map_ready:'map_ready',map_mouseover:'closeHover',map_move_end:'map_move_end',pin_mover_move:'pin_mover_move',pushpin_click:'pushpin_click',pushpin_mouseover:'pushpin_mouseover',pushpin_mouseout:'closeHover',pushpin_mousedown:'closeHover',pushpin_dragend:'closePopupAndMoveSelectedPushpin',pushpin_dragstart:'closePopupAndMoveSelectedPushpin',pushpin_drag:'moveSelectedPushpin',pushpin_new:'pushpin_new',update_pushpin_position:'update_pushpin_position',hotspot_click:'hotspot_click',hotspot_mouseover:'hotspot_mouseover',hotspot_mouseout:'hotspot_mouseout',backpack_marker_clicked:'backpackMarkerClicked',getHotspotColorsOrIcons:'getHotspotColorsOrIcons'},bind:{floorplan:'{floorplan}',commentsOn:'{toggleCommentsEnabled}'},setCoordinateSpace:function(a){MVLeaflet.CRS.Multivista=null;MVLeaflet.CRS.Multivista=MVLeaflet.extend({},MVLeaflet.CRS,{projection:MVLeaflet.Projection.LonLat,transformation:new MVLeaflet.Transformation(a,0,a,0),scale:function(b){return Math.pow(2,b)},distance:function(b,c){var d=c.lng-b.lng,e=c.lat-b.lat;return Math.sqrt(d*d+e*e)},infinite:!0})},setFloorplan:function(a){this.hotspotsLoaded=!1;if(!a||this.lookupViewModel().get('FloorplanUID')!=a.getId()){return}var b=this,e='';this.setFloorplanRecord(a);this._numbersVisible=a.get('overlayInt');this._tilePathInt=a.get('imageIntPath');this._tilePath=a.get('imagePath');if(this._numbersVisible){e=this._tilePathInt}else {e=this._tilePath}var d=a.get('imageWidth'),c=a.get('imageHeight'),f=a.get('tileSize'),g='.'+a.get('imageType'),i=Math.ceil(Math.log(Math.max(d,c)/f)/Math.log(2)),h=1/Math.pow(2,i);this.setCoordinateSpace(h);if(this.map!==null){this.map.remove();this.map=null}this.map=MVLeaflet.map(this.getId(),{zoomControl:!1,boxZoom:!0,touchZoom:!0,keyboard:!0,attributionControl:!1,fadeAnimation:!1,crs:MVLeaflet.CRS.Multivista,minZoom:0,bounceAtZoomLimits:!0});this.tileLayer=MVLeaflet.tileLayer.zoomify(e,{width:d,height:c,tileSize:f,tileExtension:g,tileMaxZoom:null,tolerance:0.8,attribution:'Photo: Multivista'});if(this.showMiniMap){this.miniTileLayer=MVLeaflet.tileLayer.zoomify(this._tilePath,{width:d,height:c,tileSize:f,tileExtension:g,tileMaxZoom:4,tolerance:0.8,attribution:'Photo: Multivista'})}this.tileLayer.once('loading',function(c){b.setDisabled(!0)});this.tileLayer.once('load',function(c){b.setDisabled(!1)});this.tileLayer.addTo(this.map);this.map.fitWorld();if(this.showHotspots){this.hotspotLayer=null;this.hotspotLayer=new MVLeaflet.layerGroup();this.hotspotLayer.addTo(this.map);if(this.showHotspotComments){this.hotspotCommentLayer=null;this.hotspotCommentLayer=new MVLeaflet.layerGroup();this.hotspotCommentLayer.addTo(this.map)}}this.pushpinLayer=null;this.pushpinLayer=new MVLeaflet.layerGroup();this.pushpinLayer.addTo(this.map);if(this.hasUnsavedPinLayer){this.unsavedPinLayer=null;this.unsavedPinLayer=new MVLeaflet.layerGroup();this.unsavedPinLayer.addTo(this.map)}if(this.showSelectionLayer){this.pushpinSelectionLayer=new MVLeaflet.layerGroup();this.pushpinSelectionLayer.addTo(this.map)}this.highlightLayer=null;this.highlightLayer=new MVLeaflet.layerGroup();this.highlightLayer.addTo(this.map);if(this.showZoomControls){this.tileLayer.options.maxZoom=this.map.getMaxZoom();this.map.options.maxZoom=this.map.getMaxZoom();this.zoomControl=new MVLeaflet.Control.Zoomslider({position:'topright'});this.map.addControl(this.zoomControl);Ext.select('.leaflet-top.leaflet-right').elements[0].style.zIndex=1}this.map.on('movestart',function(d){var c=b.map||this;b.fireEvent('map_move_start',d);c.closePopup()});this.map.on('moveend',function(c){b.fireEvent('map_move_end',c)});this.map.on('click',function(c){b.fireEvent('map_click',c)});this.map.on('mouseover',function(c){b.fireEvent('map_mouseover',c)});this.map.on('zoomend',this.mapZoomEndHandler.bind(this));if(this.showMiniMap){this.addMiniMap()}if(this.showHotspots){this.loadHotspots(a)}if(this.lookupViewModel().get('account.canRead')){this.pushpinsLoaded=!1;this.loadPushpins(a)}if(this.backpackPanoActiveInViewer){this.clearFloorplanLayersForBackpackPanos();this.lookupController().loadBackpackFloorplanLocations(this.backpackPanoActiveInViewer.walkID)}this.lookupViewModel().set('floorplanInitialized',!0);this.up('clientFloorplanViewerDisp').unmask();this.fireEvent('afterinitfloorplan')},loadPushpins:function(a){if(!a){a=this.getFloorplanRecord()}var b=this.lookupViewModel();if(this.hasUnsavedPinLayer){var d=this.lookupViewModel().get('ListTypeID'),c=function(){if(!b.get('unsaved')){this.highlightLayer.clearLayers();this.unsavedPinLayer.clearLayers();return}var c=b.get('pins').query('FloorplanUID',a.get('FloorplanUID'));this.addPinsFromData(floorplanList.PlanUtil.pinsToFeatures(c),d,undefined,undefined,this.unsavedPinLayer)},e=function(){c.call(this);this.lookupController().getView().unmask();this.onLoadPushpinSuccess()};if(!this.pushpinsLoaded){this.continueLoadingPushpins(b.get('ProjectUID'),a.get('FloorplanUID'),d,e)}else {c.call(this)}}else {this.continueLoadingPushpins(b.get('ProjectUID'),a.get('FloorplanUID'),this.lookupViewModel().get('ListTypeID'),this.onLoadPushpinSuccess,Ext.bind(this.pushpinAddEvent,this))}},onLoadPushpinSuccess:function(){if(this.getFloorplanViewerMode().mode==='dropNewPin'){this.setSelectedPushpin(this.getSelectedPushpin().pushpinID)}else {if(this.getFloorplanViewerMode().mode==='viewAfterUpload'&&this._selectedPushpin!==''){this.setFloorplanViewerMode('view');this.setSelectedPushpin(this.getSelectedPushpin().pushpinID)}}if(this.editPinOnLoad){this.lookupController().lookupReference('pushpinFlyout').lookupController().setPushpinFlyoutState('edit');this.editPinOnLoad=!1}if(this.getSelectedPushpin().pushpinID){this.setSelectedPushpin(this.getSelectedPushpin().pushpinID)}if(this.lookupController().getViewModel().get('punchpinsEnabled')||this.lookupViewModel().get('HidePushpins')){this.lookupController().updatePunchpinVisibility()}this.fireEvent('pinsloaded')},addPinsFromData:function(b,f,d,c,a){a=a||this.pushpinLayer;floorplanList.PlanUtil.filterPushpinData(b,!!f);if(this.highlightLayer){this.highlightLayer.clearLayers()}if(a){a.clearLayers()}var e={controller:this,style:function(e){return e.properties&&e.properties.style},pointToLayer:floorplanList.PlanUtil.pinPointToLayer};if(c){e.onEachFeature=c}MVLeaflet.geoJson([b],e).addTo(a);if(d){d.call(this,b)}},continueLoadingPushpins:function(e,c,b,f,d){var a=this;a.pushpinsArray=[];var g={floorplanUID:c};if(b){g.ListTypeID=b}mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientFloorplanViewer.getPushpinsByFloorplanGEOJSON&ProjectUID='+e+'&floorplanUID='+c,method:'GET',successCallback:function(g){if(a.isDestroyed){return}a.addPinsFromData(g,b,f,d);a.pushpinsLoaded=!0;if(a.checkMapReady){a.checkMapReady()}},failure:function(){Ext.Msg.alert('Error','Error loading Pushpin data.')},scope:a})},addMiniMap:function(){(new MVLeaflet.Control.MiniMap(this.miniTileLayer,{toggleDisplay:!0,width:250,height:250,hideText:mvstr['FV_Hide Mini-map'],showText:mvstr['FV_Show Mini-map']})).addTo(this.map)},addSeparateMiniMap:function(b){var a=this.getFloorplanRecord();this.miniTileLayer=MVLeaflet.tileLayer.zoomify(this._tilePath,{width:a.get('imageWidth'),height:a.get('imageHeight'),tileSize:a.get('tileSize'),tileExtension:'.'+a.get('imageType'),tileMaxZoom:4,tolerance:0.8,attribution:'Photo: Multivista',crs:MVLeaflet.CRS.Multivista});(new MVLeaflet.Control.MiniMapSeparate(this.miniTileLayer,{toggleDisplay:!0,mainMap:this.map,crs:MVLeaflet.CRS.Multivista})).addTo(b)},checkMapReady:function(){if((!this.lookupViewModel().get('account.canRead')||this.pushpinsLoaded)&&this.hotspotsLoaded){this.fireEvent('map_ready',this);this.up('clientFloorplanViewerDisp').setLegendPosition()}},loadPanoScanLocations:function(b){var a=this.lookupViewModel();a.set('hasPanoScanLocations',!1);mdsAjax.doAjaxRequest({url:'/index.cfm?fuseaction=aClientPanorama.getFloorplanInteriorPanos&floorplanUID='+b,success:function(g,h){try{var c=Ext.decode(g.responseText);if(c&&c.success){this.removePanoScanMarkers();var d=[];for(var e=0;e<c.data.length;e++){var f=c.data[e];if(f.photoThumbUrl==null){d.push(f)}}a.set('hasPanoScanLocations',d.length>0);this.setPanoScanLocations(d)}else {throw new Error('Error loading interior panorama hotspots: '+(c?c.message:'Unknown error'))}}catch(i){console.error('Error loading interior panorama hotspots',i.message);Ext.Msg.alert('Error','Unable to load interior panorama hotspots')}},failure:function(a){console.error(arguments);Ext.Msg.alert('Error','Failed to load interior panorama hotspots')},scope:this})},showPanoScanMarkers:function(){var b=this.getPanoScanLocations();var d=this.createPanoScanLayer();this.setPanoScanMarkers([]);for(var a=0;a<b.length;a++){var c=b[a];this.createPanoScanMarker(d,c.x,c.y)}},removePanoScanMarkers:function(){if(this.panoScanLayer&&this.hotspotLayer){this.hotspotLayer.removeLayer(this.panoScanLayer);this.panoScanLayer.clearLayers();this.panoScanLayer=null}},createPanoScanLayer:function(){if(this.panoScanLayer==null){this.panoScanLayer=new MVLeaflet.layerGroup();this.panoScanLayer.addTo(this.hotspotLayer)}else {this.panoScanLayer.clearLayers()}return this.panoScanLayer},createPanoScanMarker:function(c,d,e){var b=this.getPanoMarkerRadius();var a=MVLeaflet.panoScanMarker({lat:e,lng:d},{className:'panoMarker',radius:b,opacity:1,fillOpacity:1,fill:!0,clickable:!1,riseOnHover:!0});c.addLayer(a);this.getPanoScanMarkers().push(a);return a},createPanoHotspotMarker:function(b,d,e,c){var a=MVLeaflet.panoMarker({lat:e,lng:d},{radius:this.getPanoMarkerRadius(),color:'#E65E25',clickable:!1,layers:c});this.addPanoMarkerEventListeners(a);if(b){this.getPanoHotspotMarkers()[b]=a}return a},removePanoHotspotMarkers:function(){if(this.panoHotspotLayer&&this.hotspotLayer){this.hotspotLayer.removeLayer(this.panoHotspotLayer);this.panoHotspotLayer.clearLayers();this.panoHotspotLayer=null}},createPanoHotspotLayer:function(){if(this.panoHotspotLayer==null){this.panoHotspotLayer=new MVLeaflet.layerGroup();this.panoHotspotLayer.addTo(this.hotspotLayer)}else {this.panoHotspotLayer.clearLayers()}return this.panoHotspotLayer},setPanoHotspotLayerVisible:function(a){if(!this.panoHotspotLayer){return}if(a){this.panoHotspotLayer.addTo(this.hotspotLayer)}else {this.hotspotLayer.removeLayer(this.panoHotspotLayer)}},getPanoHotspotMarker:function(a){var b=this.getPanoHotspotMarkers();if(b.hasOwnProperty(a)){return b[a]}console.log("Warning - couldn't find pano marker for "+a);return null},addPanoMarkerEventListeners:function(a){a.on('mouseover',function(b){a.setRadius(this.getPanoMarkerRadius(!0));a.bringToFront()},this);a.on('mouseout',function(b){a.setRadius(this.getPanoMarkerRadius())},this)},getPanoMarkerRadius:function(b){var a=Math.min(15,6+this.map.getZoom()*3);if(b===!0){a=Math.round(a*1.2)}return a},mapZoomEndHandler:function(g){var h=g.target.getZoom();var d=this.getPanoMarkerRadius();var b=this.getPanoHotspotMarkers();for(var f in b){var e=b[f];e.setRadius(d)}var c=this.getPanoScanMarkers();for(var a=0;a<c.length;a++){c[a].setRadius(d)}},loadHotspots:function(b){var a=this;b=b||a.floorplanRecord;var c=b.get('FloorplanUID'),d=a.lookupViewModel().get('ProjectUID');a.hotspotsArray=[];a.setPanoHotspotMarkers({});mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientFloorplanViewer.getHotspotsByFloorplanGEOJSON&ProjectUID='+d+'&floorplanUID='+c,method:'GET',successCallback:function(c){var g=a;a.fireEvent('getHotspotColorsOrIcons',c);var e=[];if(c&&c.features){for(var d=c.features.length-1;d>=0;d--){var f=c.features[d];if(f.properties.hotspotType=='interiorPano'||f.properties.hotspotType=='mport'){e.push(c.features[d]);c.features.splice(d,1)}}}MVLeaflet.geoJson([c],{style:function(a){return a.properties&&a.properties.style},onEachFeature:Ext.bind(a.hotspotAddEvent,a),pointToLayer:function(f,e){var d=f.properties.hotspotType;var a=0;var h=0;var g=0;if(d=='arrow'||d=='m_arrow'){a=f.properties.media.split('_')[1];return MVLeaflet.hotspotMarker(e,{opacity:0,fillOpacity:0,halo:3,rotation:a})}else {if(d=='hotarea'){a=f.properties.rotation;h=f.properties.width;g=f.properties.height;return MVLeaflet.hotareaMarker(e,{opacity:0,fillOpacity:0,rotation:a,width:h,height:g})}else {if(d=='pano'){return MVLeaflet.hotCircleMarker(e,{radius:22,opacity:0,fillOpacity:0,halo:3,rotation:a})}else {if(d=='spherical'){return MVLeaflet.hotCircleMarker(e,{radius:22,opacity:0,fillOpacity:0,halo:3,rotation:a})}else {if(d=='360pano'){return MVLeaflet.hotCircleMarker(e,{radius:22,opacity:0,fillOpacity:0,halo:3,rotation:a})}else {if(d=='down'){return MVLeaflet.hotCircleMarker(e,{radius:16,opacity:0,fillOpacity:0,halo:3,rotation:a})}}}}}}}}).addTo(a.hotspotLayer);if(a.getShowInteriorPanoHotspots()){MVLeaflet.geoJson([{type:'FeatureCollection',features:e}],{style:function(a){return a.properties&&a.properties.style},onEachFeature:Ext.bind(a.hotspotAddEvent,a),pointToLayer:function(e,a){var f=0,d=MVLeaflet.hotCircleMarker(a,{radius:22,opacity:0,fillOpacity:0,halo:3,rotation:f});if(e.properties.panoDropSpot===!0){return g.createPanoHotspotMarker(e.properties.panoUuid,a.lng,a.lat,[d])}return d}}).addTo(a.createPanoHotspotLayer())}if(a.showHotspotComments){MVLeaflet.geoJson([c],{style:function(a){return a.properties&&a.properties.style},onEachFeature:Ext.bind(a.hotspotAddEvent,a),filter:function(a){return a.properties.numComments?!0:!1},pointToLayer:function(a,d){return MVLeaflet.marker(d,{icon:new MVLeaflet.NumberedDivIcon({number:a.properties.numComments})})}}).addTo(a.hotspotCommentLayer)}a.hotspotsLoaded=!0;a.fireEvent('hotspotsLoaded');a.checkMapReady()},useDefaultXhrHeader:!1,disableCaching:!0,withCredentials:!0,scope:a});if(a.getShowInteriorPanoHotspots()){}},hotspotAddEvent:function(a,b){Ext.Array.include(this.hotspotsArray,a);b.on('click',Ext.bind(function(c){if(a.properties.hotspotType=='hotarea'){this.fireEvent('hotspot_click',a,this);this.setSelectedHotarea(a)}else {this.fireEvent('hotspot_click',a,this);this.setSelectedHotspot(a.id)}},this));if(this.showHovers){if(this.hotspotMouseOverEvent==null){this.hotspotMouseOverEvent=Ext.bind(function(c){this.fireEvent('hotspot_mouseover',c)},this);this.hotspotMouseMoveEvent=Ext.bind(function(c){this.fireEvent('hotspot_mousemove',c)},this);this.hotspotMouseOutEvent=Ext.bind(function(c){this.fireEvent('hotspot_mouseout',c)},this)}b.on('mouseover',this.hotspotMouseOverEvent);b.on('mousemove',this.hotspotMouseMoveEvent);b.on('mouseout',this.hotspotMouseOutEvent)}if(this.hotspotLayers){this.hotspotLayers.push(b)}},dragend:function(a){a.target.setLatLng(a.target._latlng);a.target.update();this.fireEvent('pushpin_dragend',a);this.moveSelectedPushpin()},dragstart:function(a){this.highlightLayer.clearLayers();this.fireEvent('pushpin_dragstart',a)},drag:function(a){this.fireEvent('pushpin_drag',a);this.moveSelectedPushpin()},pushpinAddEvent:function(c,b){if(!this.pushpinsArray){return}Ext.Array.include(this.pushpinsArray,c);var a=this;b.on('click',Ext.bind(function(d){if(a.openPins&&a.lookupController().lookupReference('pushpinFlyout').isDisabled()){return}a.fireEvent('pushpin_click',d,c);a.setSelectedPushpin(c.id)},a));if(a.showHovers){b.on('mouseover',function(d){a.fireEvent('pushpin_mouseover',d)});b.on('mousemove',function(d){a.fireEvent('pushpin_mousemove',d)});b.on('mouseout',function(d){a.fireEvent('pushpin_mouseout',d)});b.on('mousedown',function(d){a.fireEvent('pushpin_mousedown',d)})}b.on('dragend',Ext.bind(a.dragend,a));b.on('dragstart',Ext.bind(a.dragstart,a));b.on('drag',Ext.bind(a.drag,a))},addNewPushpin:function(b,a){if(!a){a={}}if(!a.PushpinSymbol){a.PushpinSymbol='mds/module/clientFileManager/image/pin_red.png'}if(!a.iconAnchor){a.iconAnchor=[5,26]}var c=this;c.setFloorplanViewerMode('addNewPin');var b=b;var e=this.map.getCenter();var d={'type':'FeatureCollection','features':[{'properties':{'ShareMembers':'','PushpinLabel':'','ShareTypeID':2,'PushpinTypeUID':b,'PushpinType':b,'PushpinCreationDate':'March, 13 2015 13:05:43 -0700','PushpinSymbol':a.PushpinSymbol,'IsOwner':1},'id':'0000','type':'Feature','geometry':{'coordinates':[e.lng,e.lat],'type':'Point'}}]};if(a.PunchItemID){d.features[0].properties.PunchItemID=a.PunchItemID}if(a.IsNewItem){d.features[0].properties.IsNewItem=a.IsNewItem}MVLeaflet.geoJson([d],{style:function(c){return c.properties&&c.properties.style},onEachFeature:Ext.bind(function(d,c){Ext.Array.include(this.pushpinsArray,d);c.on('dragend',Ext.bind(this.dragend,this));c.on('dragstart',Ext.bind(this.dragstart,this));c.on('drag',Ext.bind(this.drag,this))},this),pointToLayer:function(f,i){var g=f.properties.PushpinType;var c=f.properties.PushpinSymbol;var e=[33,33];var d=a.iconAnchor;switch(g){case 1:e=[33,33];d=[5,26];c='mds/image/clientFileManager/pin_red.png';break;case 3:e=[33,33];d=[5,26];c='mds/image/clientFileManager/pin_green.png';break;case 4:e=[33,33];d=[5,26];c='mds/image/clientFileManager/pin_blue.png';break;case 2:e=[33,33];d=[5,26];c='mds/image/clientFileManager/pin_yellow.png';break;case 5:e=[33,33];d=[17,4];c='mds/image/clientFileManager/n_pink.png';break;case 6:e=[33,33];d=[29,17];c='mds/image/clientFileManager/e_pink.png';break;case 7:e=[33,33];d=[17,29];c='mds/image/clientFileManager/s_pink.png';break;case 8:e=[33,33];d=[4,17];c='mds/image/clientFileManager/w_pink.png';break;}var h=MVLeaflet.icon({iconUrl:c,iconSize:e,iconAnchor:d});return MVLeaflet.marker(i,{icon:h,draggable:!0})}}).addTo(this.hasUnsavedPinLayer?this.unsavedPinLayer:this.pushpinLayer);c.setSelectedPushpin('0000');c.moveSelectedPushpin();c.fireEvent('pushpin_new')},toggleTileLayer:function(){var a='';this._numbersVisible=!this._numbersVisible;if(this._numbersVisible){a=this._tilePathInt}else {a=this._tilePath}this.tileLayer.setUrl(a)},setSelectedHotspot:function(b){if(this.getFloorplanViewerMode().mode==='view'){var c=this.highlightLayer;this._selectedPushpin={};var a=null;Ext.Array.forEach(this.hotspotsArray,function(c){if(c.id==b){this.highlightMarker(c);a=c}},this);return a}},setSelectedHotarea:function(a){},getSelectedPushpin:function(){return this._selectedPushpin},setSelectedPushpin:function(b){this.lookupViewModel().set('PushpinUID',b);if(b===null){this._selectedPushpin='';this.highlightLayer.clearLayers();this.map.closePopup()}else {var a={};a.projectID=this.floorplanProjectID;a.pushpinID=b;a.floorplanID=this.getFloorplanRecord().get('FloorplanUID');Ext.Array.forEach(this.pushpinsArray,function(c){if(c.id===b){a.properties=c.properties;a.geometry=c.geometry;this.highlightMarker(c)}},this);this._selectedPushpin=a}},getSwirlyMarker:function(b){var a=MVLeaflet.icon({iconUrl:this.up('pinwizard')?'mds/image/clientFloorplanViewer/orange_selector.gif':'mds/image/clientFloorplanViewer/swirlyThing.gif',iconSize:[70,70],iconAnchor:[35,35],className:'add-pushpin-target'});return theMarker=MVLeaflet.marker(b,{icon:a,draggable:!0})},moveSelectedPushpin:function(){var a=this,b=this.highlightLayer,c=this.hasUnsavedPinLayer?this.unsavedPinLayer:this.pushpinLayer;c.eachLayer(function(c){c.eachLayer(function(d){if(d.feature.id===a.getSelectedPushpin().pushpinID){d.dragging.enable();d.setZIndexOffset(10000);b.clearLayers();var e=a.getSwirlyMarker(d._latlng);e.on('drag',function(b){d.setLatLng(b.target._latlng);d.update();a.fireEvent('pin_mover_move',b.target._latlng)});b.addLayer(e);a.fireEvent('pin_mover_move',d._latlng)}})})},updatePushpinPosition:function(){var c=this,d=this.getFloorplanRecord().get('FloorplanUID'),e=Ext.Object.fromQueryString(document.location.search).ProjectUID,a=this.map.getBounds().getCenter(),f='',g={},b=c.getSelectedPushpin();this.pushpinLayer.eachLayer(function(c){c.eachLayer(function(d){if(d.feature.id===b.pushpinID){a=d.getLatLng()}})});if(a.lng<this.getFloorplanRecord().get('imageWidth')&&a.lat<this.getFloorplanRecord().get('imageHeight')&&a.lng>0&&a.lat>0){if(this.getFloorplanViewerMode().mode==='movePin'){f='/index.cfm?fuseaction=aClientFloorplanViewer.updatePushpinPosition';g={FloorplanID:d,ProjectUID:e,PushpinID:b.pushpinID,PushpinTypeUID:b.properties.PushpinTypeUID,PushpinXCoordinate:a.lng,PushpinYCoordinate:a.lat}}else {if(this.getFloorplanViewerMode().mode==='addNewPin'){var h=this.up('clientviewport').getViewModel();f=b.properties.PunchItemID?'/index.cfm?fuseaction=aClientPunchlist.addPunchPinsToPunchItem':'/index.cfm?fuseaction=aClientFloorplanViewer.addPushpinToFloorplan';g=b.properties.PunchItemID?{ProjectUID:e,PunchItemID:b.properties.PunchItemID,FloorplanUID:d,PushpinXCoordinate:a.lng,PushpinYCoordinate:a.lat,IsNewItem:b.properties.IsNewItem?1:0}:{FloorplanUID:d,ProjectUID:e,PushpinID:b.pushpinID,PushpinTypeUID:b.properties.PushpinTypeUID,PushpinLabel:b.properties.PushpinLabel,PushpinXCoordinate:a.lng,PushpinYCoordinate:a.lat,ShareTypeID:h.get('selectedShareTypeID'),MemberList:h.get('selectedShareMemberUIDList')}}}mdsAjax.doAjaxRequest({url:f,successCallback:function(a){c.loadPushpins(c.getFloorplanRecord());c.setFloorplanViewerMode('view');c.fireEvent('update_pushpin_position',a.length?a[0]:a);a.length?c.setSelectedPushpin(a[0].PushpinUID):c.setSelectedPushpin(a.PushpinUID)},params:g})}else {var i='You cannot move a pushpin outside the edges of the floorplan.';alert('Outside range',i,function(){},this,'OK')}},setFloorplanViewerMode:function(a){this._floorplanViewerMode.mode=a;this.lookupViewModel().set('floorplanViewerMode',a)},getFloorplanViewerMode:function(){return this._floorplanViewerMode},highlight:function(b,c){var a=b.get('pushpin');this.highlight2(b.get('hotspotID'),a?a.PushpinUID:undefined,c)},highlight2:function(f,e,h){var a;if(f){Ext.Array.forEach(this.hotspotsArray,function(b,d,c){if(f==b.id){a=b}})}if(e){Ext.Array.forEach(this.pushpinsArray,function(b,d,c){if(e==b.id){a=b}})}if(a){var b=this.getZoomOutInteriorPanoHotspots();var d=a.properties.hotspotType;var c=d=='interiorPano'||d=='mport';this.highlightMarker(a);if(h||b&&c){var g=this.map.getMaxZoom();if(b&&c){g--}this.zoomToMarker(a,g)}}},zoomToMarker:function(a,c){var b=this.getAnimateOptions();if(b){this.map.setView({lon:a.geometry.coordinates[0],lat:a.geometry.coordinates[1]},c,b)}else {this.map.setView({lon:a.geometry.coordinates[0],lat:a.geometry.coordinates[1]},undefined,!0);this.map.setZoom(c,{animate:!1})}},highlightMarker:function(b){var a=b.properties.hotspotType;var c=a=='interiorPano'||a=='mport';var g=a=='pano'||c;var e=this.getHighlightInteriorPanoHotspots();if(c&&!e){return}var d=this.highlightLayer;d.clearLayers();var f=MVLeaflet.circleMarker({lon:b.geometry.coordinates[0],lat:b.geometry.coordinates[1]},{radius:g?22:16,color:'#E86FD2',clickable:!1,weight:6,fill:!0,fillOpacity:0.4});d.addLayer(f)},panToMarker:function(b,c,a){this.map.panTo({lon:b,lat:c},{animate:!!a})},setCommentsOn:function(a){if(this.hotspotCommentLayer){if(a){this.getMap().addLayer(this.hotspotCommentLayer)}else {this.getMap().removeLayer(this.hotspotCommentLayer)}}},addBackpackPanoMarker:function(g,h,a,c,d,e){var b=MVLeaflet.marker([g,h],{icon:this.backpackIcon,locationObj:a});if(this.backpackPanoActiveInViewer){b.on('click',function(b,j,k){var f=this.lookupViewModel();var i=f.get('ProjectUID');this.fireEvent('backpackPanoMarkerClick',b)}.bind(this,a,c,d))}else {var f=function(){var b=d+'/backpack/pano/'+c+'/'+a.ImageName+'_thumb.jpg';return '<div class="photoBubble_outer"><b>'+c+' - '+a.ImageName+'</b></br><img src="'+b+'" style="border-color: ##000000; border-width: 1;" width="300px" height="150px"></img></div>'};b.on('mouseover',function(){b.bindPopup(f()).openPopup()});b.on('click',function(b,j,k){var i=this.lookupViewModel();var f=i.get('ProjectUID');this.fireEvent('backpack_marker_clicked',b,j,k,f,e)}.bind(this,a,c,d))}b.addTo(this.backpackPanoLayer);this.panoMarkers.push()},clearFloorplanLayersForBackpackPanos:function(){if(this.hotspotLayer){this.hotspotLayer.eachLayer(function(a){this.getMap().removeLayer(a)}.bind(this))}this.highlightLayer.clearLayers();this.backpackPanoLayer=null;this.backpackPanoLayer=new MVLeaflet.layerGroup();this.backpackPanoLayer.addTo(this.getMap());this.panoMarkers=[];this.backpackIcon=MVLeaflet.icon({iconUrl:'resources/images/sm_orange_point.png',shadowUrl:null,iconSize:new MVLeaflet.Point(10,10),iconAnchor:new MVLeaflet.Point(5,5),popupAnchor:new MVLeaflet.Point(0,-10)})},resetFloorplanLayersAfterBackpackPanos:function(){this.hotspotLayer.eachLayer(function(a){this.getMap().addLayer(a)}.bind(this));this.getMap().removeLayer(this.backpackPanoLayer);this.panoMarkers=[]}},0,['fvFloorplanViewer'],['component','box','container','fvFloorplanViewer'],{'component':!0,'box':!0,'container':!0,'fvFloorplanViewer':!0},['widget.fvFloorplanViewer'],0,[floorplanViewer.view,'Floorplan'],0);Ext.cmd.derive('floorplanViewer.view.FloorplanExportWindow',Ext.window.Window,{ui:'orange',layout:'fit',width:420,height:280,modal:!0,localized:{title:'FV_Export Floorplan To P'},items:[{xtype:'container',layout:{type:'vbox',align:'stretch'},cls:'export-window-body',items:[{xtype:'component',localized:{html:'FV_The floorplan will be'},margin:'0 0 15 0'},{xtype:'checkboxfield',ui:'plain-16',localized:{boxLabel:'FV_Display project name '},itemId:'headerCheckbox',value:!0},{xtype:'checkboxfield',ui:'plain-16',localized:{boxLabel:'FV_Display Multivista co'},itemId:'hotspotsCheckbox',value:!0,hidden:!0,bind:{hidden:'{!account.MultivistaContentPermission}'}},{xtype:'checkboxfield',ui:'plain-16',localized:{boxLabel:'FV_Display user defined '},itemId:'pushpinsCheckbox',value:!0,hidden:!0,bind:{hidden:'{!account.canRead}'}}]}],dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',height:56,layout:{pack:'center',type:'hbox'},items:[{xtype:'button',ui:'grey',scale:'medium',localized:{text:'G_Cancel'},width:90,handler:function(){this.up('window').close()}},{xtype:'tbspacer',width:5},{xtype:'button',ui:'green',scale:'medium',localized:{text:'G_OK'},width:90,handler:function(e){var a=this.up('window');var d=a.down('#headerCheckbox').getValue();var b=a.down('#hotspotsCheckbox').getValue();var c=a.down('#pushpinsCheckbox').getValue();a.fireEvent('exportfloorplan',d,b,c);a.close()}}]}]},0,0,['component','box','container','panel','window'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0},0,0,[floorplanViewer.view,'FloorplanExportWindow'],0);Ext.cmd.derive('floorplanViewer.view.FloorplanLegend',Ext.panel.Panel,{width:138,floating:!0,cls:'floorplan-legend',closeAction:'hide',collapsible:!0,defaultAlign:'bl-bl',border:!0,layout:{type:'vbox',align:'stretch'},localized:{title:'FV_Legend'},header:{titleAlign:'center',cls:'floorplan-legend-header'},items:[{xtype:'button',localized:{text:'FV_Wall / Horizontal'},ui:'plain',iconCls:'toolicon-wall-horizontal',itemId:'orange',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_UAV Photos'},ui:'plain',iconCls:'toolicon-uav-photos',itemId:'green',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_Ceiling / Upward'},ui:'plain',iconCls:'toolicon-plain',itemId:'blue',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_Floor / Downward'},ui:'plain',iconCls:'toolicon-floor-down',itemId:'red',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_360 Immersive'},ui:'plain',iconCls:'toolicon-360-immersive',itemId:'pano_orange',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_UAV/Pano'},ui:'plain',iconCls:'toolicon-uav-pano',itemId:'pano_green',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_Aerial Downward'},ui:'plain',iconCls:'toolicon-aerial-downward',itemId:'down_green',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_360 Photo'},ui:'plain',iconCls:'toolicon-360-photo',itemId:'photo_360',hidden:!0,textAlign:'left'},{xtype:'button',localized:{text:'FV_360 Measurable'},ui:'plain',iconCls:'toolicon-360-measurable',itemId:'m_arrow',hidden:!0,textAlign:'left'}]},0,['fvLegend'],['component','box','container','panel','fvLegend'],{'component':!0,'box':!0,'container':!0,'panel':!0,'fvLegend':!0},['widget.fvLegend'],0,[floorplanViewer.view,'FloorplanLegend'],0);Ext.cmd.derive('floorplanViewer.view.FloorplanViewerTitle',Ext.Container,{layout:'hbox',items:[{xtype:'container',baseCls:'floorplanTitleListLink',margin:'0 0 0 5',bind:{hidden:'{!punchpinsEnabled}',html:"<a href='{backToPlansLink}'>&lt; {backToPlansText}</a>"}},{xtype:'container',flex:1,reference:'floorplanTitle',bind:{html:'{floorplanTitle}'}}]},0,['floorplanviewertitle'],['component','box','container','floorplanviewertitle'],{'component':!0,'box':!0,'container':!0,'floorplanviewertitle':!0},['widget.floorplanviewertitle'],0,[floorplanViewer.view,'FloorplanViewerTitle'],0);Ext.cmd.derive('floorplanViewer.view.MenuCheckItem',Ext.button.Button,{width:172,height:32,scale:'medium',textAlign:'left',cls:'toggle-enabled',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',setCheckboxStyle:function(a){if(a){this.addCls('toggle-enabled');this.removeCls('toggle-disabled')}else {this.addCls('toggle-disabled');this.removeCls('toggle-enabled')}}},0,['mvmenucheckitem'],['component','box','button','mvmenucheckitem'],{'component':!0,'box':!0,'button':!0,'mvmenucheckitem':!0},['widget.mvmenucheckitem'],0,[floorplanViewer.view,'MenuCheckItem'],0);Ext.cmd.derive('floorplanViewer.view.LayerMenuItem',Ext.Container,{defaultType:'button',layout:'hbox',defaults:{width:172,scale:'medium',textAlign:'left',itemCls:'toolmenu-item',overCls:'toolmenu-item-over'},listeners:{afterrender:function(){this.ownerCt.manageMouseEvents(this)}}},0,['layermenuitem'],['component','box','container','layermenuitem'],{'component':!0,'box':!0,'container':!0,'layermenuitem':!0},['widget.layermenuitem'],0,[floorplanViewer.view,'LayerMenuItem'],0);Ext.cmd.derive('floorplanViewer.view.LayerMenu',Ext.Container,{cls:'flyout-menu-wrap',floating:!0,shrinkWrap:3,hidden:!0,defaultType:'button',defaults:{width:200,scale:'medium',textAlign:'left'},renderTo:Ext.getBody(),x:69,y:140,layout:'vbox',padding:3,backgroundStyle:null,manageMouseEvents:function(b){var f='#454776';var e={'background':f,'background-repeat':'no-repeat'};b.items.items[0].relayEvents(b.items.items[1].getEl(),['click']);b.items.items[1].relayEvents(b.items.items[0].getEl(),['click']);var a=b.items.items[1].getEl();var c=b.items.items[0].getEl();if(this.backgroundStyle==null){this.backgroundStyle=c.getStyle('background')}var d={'background':this.backgroundStyle,'background-repeat':'no-repeat'};a.addListener('mouseenter',function(){c.setStyle({'background':f})});a.addListener('mouseleave',function(){c.setStyle({'background':this.backgroundStyle})});c.addListener('mouseenter',function(){e['background-image']=a.getStyle('background-image');a.setStyle(e)});c.addListener('mouseleave',function(){d['background-image']=a.getStyle('background-image');d['background']=this.backgroundStyle;a.setStyle(d)})},initComponent:function(){var a=[];var b=[{label:mvstr['FVTL_Overdue Pins'],iconCls:'toolicon-punchpin-overdue',value:'showOverduePunchpins'},{label:mvstr['FVTL_Not Started Pins'],iconCls:'toolicon-punchpin-notstarted',value:'showNotStartedPunchpins'},{label:mvstr['FVTL_In Progress Pins'],iconCls:'toolicon-punchpin-progress',value:'showInProgressPunchpins'},{label:mvstr['FVTL_Completed Pins'],iconCls:'toolicon-punchpin-complete',value:'showCompletedPunchpins'},{label:mvstr['FVTL_On-Hold Pins'],iconCls:'toolicon-punchpin-onhold',value:'showOnHoldPunchpins'},{label:mvstr['FVTL_Closed Pins'],iconCls:'toolicon-punchpin-closed',value:'showClosedPunchpins'}];Ext.each(b,function(b){a.push({xtype:'layermenuitem',bind:{hidden:'{!punchpinsEnabled}'},items:[{text:b.label,iconCls:b.iconCls,listeners:{click:{fn:'togglePunchpinVisibility',args:[b.value]}}},{xtype:'mvmenucheckitem',bind:{checkboxStyle:'{'+b.value+'}'}}]})});a.push({xtype:'layermenuitem',hidden:!0,bind:{hidden:'{!canSeeMVPhotos}'},items:[{localized:{text:'FV_Photo Numbers'},iconCls:'toolicon-numbervis',listeners:{click:'toggleNumberVisibility'}},{xtype:'mvmenucheckitem',itemId:'toggleNumbersEnabled',bind:{checkboxStyle:'{toggleNumbersEnabled}'}}]},{xtype:'layermenuitem',hidden:!0,bind:{hidden:'{!canSeeMVPhotosAndComments}'},items:[{localized:{text:'FV_Photo Comments'},iconCls:'toolicon-commentvis',listeners:{click:'toggleCommentsVisibility'}},{xtype:'mvmenucheckitem',itemId:'toggleCommentsEnabled',bind:{checkboxStyle:'{toggleCommentsEnabled}'}}]},{xtype:'layermenuitem',hidden:!0,bind:{hidden:'{!canTogglePushpins}'},items:[{iconCls:'toolicon-pushpinvis',localized:{text:'FV_Pushpins'},listeners:{click:'togglePinVisibility'}},{xtype:'mvmenucheckitem',itemId:'togglePushpinsEnabled',bind:{checkboxStyle:'{togglePushpinsEnabled}'}}]},{xtype:'layermenuitem',name:'backpackpano',hidden:!0,bind:{hidden:'{!toggleBackpackPanoEnabled}'},items:[{text:'Backpack Panos',iconCls:'toolicon-commentvis',listeners:{click:'toggleBackpackPanoVisibility'}},{xtype:'mvmenucheckitem',itemId:'toggleBackpackPanoEnabled',bind:{checkboxStyle:'{toggleBackpackPanoEnabled}'}}]},{xtype:'layermenuitem',bind:{visible:'{hasPanoScanLocations}'},items:[{iconCls:'toolicon-panovis',text:'Scan Locations',listeners:{click:'togglePanoVisibility'}},{xtype:'mvmenucheckitem',itemId:'togglePanosEnabled',bind:{checkboxStyle:'{togglePanosEnabled}'}}]});this.items=a;Ext.container.Container.prototype.initComponent.apply(this,arguments)}},0,['layermenu'],['component','box','container','layermenu'],{'component':!0,'box':!0,'container':!0,'layermenu':!0},['widget.layermenu'],0,[floorplanViewer.view,'LayerMenu'],0);Ext.cmd.derive('floorplanViewer.view.MapToolsMenu',Ext.toolbar.Toolbar,{floating:!0,x:12,y:11,padding:'1 0 1 0',shadow:!1,defaultType:'button',hidden:!0,viewModel:{formulas:{addPinVisible:function(a){return a('account.canWrite')&&!config.ISARCHIVE},exportVisible:function(b){var a=b('account');if(a&&a.features&&a.features.badgesVisible&&a.features.integrationsVisible&&!config.ISARCHIVE&&(a.procoreEnabled||a.planGridEnabled||a.aconexEnabled||a.bluebeamEnabled)){return !0}return !1},printVisible:function(a){return a('account.features.badgesVisible')&&!config.ISARCHIVE}}},defaults:{scale:'large',textAlign:'left',toggleGroup:'mapTools',width:53,height:58,cls:'toolmenu-tool',overCls:'toolmenu-tool-over',iconAlign:'top',listeners:{click:{fn:function(a){var c=this.up('clientFloorplanViewerDisp');var b=null;var f=null;var e=this.lookupController();if(a.itemId==='menu_vis_toggles'){b=c.down('layermenu')}else {if(a.itemId==='menu_add_pushpin'){if(!this.lookupViewModel().get('punchpinsEnabled')){this.lookupController().addPushPin(1)}else {console.log('adding pushpin');this.up('maptoolsmenu').fireEvent('startaddpunchpin')}}else {if(a.itemId==='menu_search'){b=c.down('searchcontainer')}else {if(a.itemId==='menu_select'){b=c.down('selectmenu')}else {if(a.itemId==='menu_print'){e.openPrintFloorplanWindow()}else {if(a.itemId==='menu_export'){b=c.down('exportmenu')}else {if(a.itemId==='menu_add_arrow'){if(!this.lookupViewModel().get('punchpinsEnabled')){b=c.down('pushpinmenu')}else {this.up('maptoolsmenu').fireEvent('startaddpunchpin')}}}}}}}}var d=!1;if(b!=null){d=!b.isVisible();if(d){b.showBy(a,'tl-tr',[2,0]);f=b}b.setVisible(d)}e.initPhotoSelection(a.itemId=='menu_select'?d:!1);e.setSelectedMapToolAndMenu(a.enableToggle&&a.pressed?a:null,f)}}}},layout:'vbox',items:[{itemId:'menu_export',reference:'menuExport',localized:{text:'FV_Export',tooltip:'FV_Export'},iconCls:'toolicon-export',hidden:!0,bind:{hidden:'{!exportVisible}'}},{itemId:'menu_print',reference:'menuPrint',localized:{text:'FV_Print',tooltip:'FV_Print'},iconCls:'toolicon-print',enableToggle:!1,toggleGroup:null,hidden:!0,bind:{hidden:'{!printVisible}'}},{itemId:'menu_vis_toggles',localized:{text:'FV_Visibility',tooltip:'FV_Visibility'},iconCls:'toolicon-layer'},{itemId:'menu_search',localized:{text:'FV_Search',tooltip:'FV_Search'},iconCls:'toolicon-search',hidden:!1},{itemId:'menu_select',reference:'menuSelect',localized:{text:'FV_Select',tooltip:'FV_Select'},iconCls:'toolicon-select',hidden:!0},{itemId:'menu_add_pushpin',reference:'menuAddPushpin',localized:{text:'FV_Add pin',tooltip:'FV_Add pin'},iconCls:'toolicon-pushpin',hidden:!0,bind:{hidden:'{!addPinVisible}'}},{itemId:'menu_add_arrow',reference:'menuAddArrow',localized:{text:'FV_Arrows',tooltip:'FV_Arrows'},iconCls:'toolicon-fp-arrow',hidden:!0,bind:{hidden:'{!addPinVisible}'}}],listeners:{startaddpunchpin:'startAddPunchPin'}},0,['maptoolsmenu'],['component','box','container','toolbar','maptoolsmenu'],{'component':!0,'box':!0,'container':!0,'toolbar':!0,'maptoolsmenu':!0},['widget.maptoolsmenu'],0,[floorplanViewer.view,'MapToolsMenu'],0);Ext.cmd.derive('floorplanViewer.view.PhotoThumbContainer',Ext.Container,{width:133,height:'100%',style:'background-color: #2D2D2D',overflowY:'auto',load:function(a){this.lookupViewModel().set('HotspotID',a.hotspotID)},initComponent:function(){this.items=[];this.items.push({xtype:'fvPhotoThumbDataView',cls:this.selectPhotoThumbs?'thumbsSelect':'thumbsView',selectPhotoThumbs:this.selectPhotoThumbs,bind:{store:'{hotspotPhotos}'}});Ext.container.Container.prototype.initComponent.apply(this,arguments)},viewModel:{formulas:{hotspotPhotoGroup:function(b){var a=b('HotspotID');return a?Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':a,'Type':'H'}):null},hotspotPhotos:function(b){var c=b('hotspotPhotoGroup');if(!c){return Ext.create('Ext.data.Store',{proxy:'memory'})}var a=c.getPhotoStore(b('ProjectUID'),b('storeSession'));a.sort({property:'PhotoDate',direction:'DESC'});if(!a.isLoaded()&&!a.isLoading()){a.load()}return a}}}},0,['photothumbcontainer'],['component','box','container','photothumbcontainer'],{'component':!0,'box':!0,'container':!0,'photothumbcontainer':!0},['widget.photothumbcontainer'],0,[floorplanViewer.view,'PhotoThumbContainer'],0);Ext.cmd.derive('floorplanViewer.view.PinPositionDialog',Ext.Container,{floating:!0,shadow:!1,x:800,y:400,layout:{type:'hbox'},initComponent:function(){this.items=[{xtype:'container',layout:'hbox',shadow:!0,defaults:{xtype:'button',ui:'pin-action',scale:'large',overCls:'',height:42},items:[Ext.merge({cls:'cancel',localized:{text:'G_Cancel',width:{de:90,es:85,'default':63}},listeners:{click:'cancelPinPosition'}},this.cancelConf||{}),Ext.merge({cls:'save',localized:{text:'G_Save',width:{de:90,es:85,'default':63}},margin:'0 0 0 3',listeners:{click:'savePinPosition'}},this.saveConf||{})]}];Ext.container.Container.prototype.initComponent.apply(this,arguments)},listeners:{show:function(){var a=this.getWidth()/2;app.fireEvent('pinPositionOffsetXReady',a)}}},0,['pinpositiondialog'],['component','box','container','pinpositiondialog'],{'component':!0,'box':!0,'container':!0,'pinpositiondialog':!0},['widget.pinpositiondialog'],0,[floorplanViewer.view,'PinPositionDialog'],0);Ext.cmd.derive('floorplanViewer.view.PunchItemSummary',Ext.Component,{viewModel:{data:{},mvRecords:{PunchItem:{idName:['PunchItemID','ProjectUID'],modelName:'clientPunchlist.model.PunchItem'}}},bind:{data:'{PunchItem}'},tpl:['<div><span class="field-label">mvstr[TL_Category]:</span> {CategoryLabel}</div>','<div><span class="field-label">mvstr[TL_Description]:</span> {Description}</div>','<div><span class="field-label">mvstr[TL_Assignees]:</span> {AssigneeList}</div>','<div><span class="field-label">mvstr[TL_Item Status]:</span> {PunchStatusLabel}</div>','<div><span class="field-label">mvstr[TL_Work Status]:</span> {WorkStatusLabel}</div>','<div><span class="field-label">mvstr[TL_Due Date]:</span> {DueDate:date(mvstr["DATE_Full"])}</div>']},0,['punchitemsummary'],['component','box','punchitemsummary'],{'component':!0,'box':!0,'punchitemsummary':!0},['widget.punchitemsummary'],0,[floorplanViewer.view,'PunchItemSummary'],0);Ext.cmd.derive('floorplanViewer.view.punchlistLocation.PinWizardController',Ext.app.ViewController,{init:function(){this.control({clientFloorplanViewerDisp:{pinsave:function(){var g=this.getViewModel(),b=this.getView().down('fvFloorplanViewer'),c=b.getFloorplanRecord().getData(),f=c['FloorplanUID'],a=b.map.getBounds().getCenter(),d=this.getView();b.unsavedPinLayer.eachLayer(function(c){c.eachLayer(function(d){if(d.feature.id===b.getSelectedPushpin().pushpinID){a=d.getLatLng()}})});if(a.lng<c['imageWidth']&&a.lng>0&&a.lat<c['imageHeight']&&a.lat>0){var e=c.floorplanTitle.split(' - '),j=Ext.create('mdsData.model.Pushpin',{PunchItemID:g.get('PunchItem.PunchItemID'),FloorplanUID:f,PushpinXCoordinate:a.lng,PushpinYCoordinate:a.lat,floorplanImage:(c.imageIntPath.replace('/int_','/int_tile_')+'.png').replace('/.png','.png'),LocationName:e.length>1?e[1]:''});var i=this.getViewModel().get('pins');i.add(j);var h=function(a){b.highlightLayer.clearLayers();b.setFloorplanViewerMode('view');d.fireEvent('updated');this.getViewModel().set('addingPin',!1);d.unmask()};h.call(this)}else {Ext.Msg.alert('Outside range','You cannot move a pin outside the edges of the plan.')}}}})},loadPunchlistPlan:function(c,b){this.getViewModel().set('pinsReady',!1);this.getView().mask('Loading');var a=this.getView().down('fvFloorplanViewer');this.getView().setActiveItem(this.lookupReference('floorplanPage'));a.lookupViewModel().set('_recordfloorplan',null);a.lookupViewModel().set('FloorplanUID',null);a.lookupViewModel().notify();a.lookupViewModel().set('FloorplanUID',b.get('FloorplanUID'))},addPunchPin:function(){var a=this.getViewModel().get('PunchItem').getData();a.iconAnchor=mdsData.FloorplanValues.PUNCHPIN_ICON_ANCHOR;this.getView().down('fvFloorplanViewer').addNewPushpin(this.getViewModel().get('PunchItem').get('PushpinTypeID'),a);this.getViewModel().set('addingPin',!0)},afterPinPositionCancel:function(){this.getViewModel().set('addingPin',!1)},onPinsLoaded:function(){this.getViewModel().set('pinsReady',!0);this.getView().unmask()}},0,0,0,0,['controller.pinwizard'],0,[floorplanViewer.view.punchlistLocation,'PinWizardController'],0);Ext.cmd.derive('floorplanViewer.view.punchlistLocation.PinWizardModel',Ext.app.ViewModel,{data:{pinsReady:!1,addingPin:!1},formulas:{canAddPin:function(a){return a('pinsReady')&&!a('addingPin')}}},0,0,0,0,['viewmodel.pinwizard'],0,[floorplanViewer.view.punchlistLocation,'PinWizardModel'],0);Ext.cmd.derive('floorplanViewer.view.punchlistLocation.PinWizard',Ext.Container,{layout:'card',viewModel:{type:'pinwizard'},controller:'pinwizard',initComponent:function(){var a={xtype:'panel',layout:'fit',reference:'floorplanListPage',items:[{xtype:'floorplanoverview',padding:'0 10 0 15',bind:{store:'{punchplans}'},noLink:!0,scrollable:{x:!1,y:!0},listeners:{'itemclick':'loadPunchlistPlan'}}]};if(this.showFPListBackButton){a.bbar={padding:'5 5 8 5',layout:{type:'hbox',pack:'start'},items:[{xtype:'button',ui:'grey',scale:'medium',text:'Back',height:31,listeners:{click:{fn:function(){this.getView().up().lookupController().closePinWizard()},scope:'controller'}}}]}}this.items=[a,{xtype:'panel',reference:'floorplanPage',layout:'fit',items:[{xtype:'plFloorPlan',reference:'floorplan',listeners:{pinsloaded:'onPinsLoaded',afterpinpositioncancel:'afterPinPositionCancel'}},{xtype:'toolbar',reference:'maptoolsMenu',cls:'maptoolsMenu',floating:!0,shadow:!1,x:10,y:10,height:62,maxWidth:57,layout:'vbox',autoShow:!0,items:[{localized:{text:'FV_Add pin'},iconCls:'toolicon-pushpin',scale:'large',width:53,cls:'toolmenu-tool',overCls:'toolmenu-tool-over',iconAlign:'top',listeners:{click:'addPunchPin'},bind:{disabled:'{!canAddPin}'}}]}],bbar:{padding:'5 5 8 5',items:[{xtype:'button',scale:'medium',ui:'grey',height:31,localized:{text:'G_Back'},listeners:{click:{fn:function(){this.getView().up().down('fvFloorplanViewer').lookupController().cancelPinPosition();this.getView().setActiveItem(this.lookupReference('floorplanListPage'))},scope:'controller'}}},'->',{xtype:'button',scale:'medium',localized:{text:'G_Done'},ui:'green',height:31,listeners:{click:{fn:function(){this.getView().up().doneAddingPins()},scope:'controller'}}}]}}];Ext.container.Container.prototype.initComponent.apply(this,arguments)}},0,['pinwizard'],['component','box','container','pinwizard'],{'component':!0,'box':!0,'container':!0,'pinwizard':!0},['widget.pinwizard'],0,[floorplanViewer.view.punchlistLocation,'PinWizard'],0);Ext.cmd.derive('floorplanViewer.view.PunchlistWindow',Ext.window.Window,{layout:{type:'fit'},width:1000,height:600,modal:!0,loadMaskCls:'light-load-indicator',viewModel:{data:{PunchItemID:''},formulas:{listItemDesc:function(a){return mvstr['TL_ListItemDesc_'+a('ListTypeID')]||mvstr['TL_ListItemDesc']},addToExistingText:function(b){var a=b('pinDescription');return a=='Photo'?mvstr['FVTL_Save to selected item']:mvstr['FVTL_Attach pin to this it']}}},initComponent:function(){var a=this;a.setBind({'title':mvstr['FVTL_Select {listItemDesc}']});a.items=[{xtype:'tabpanel',items:[{xtype:'panel',layout:'card',controller:'detailform',viewModel:{type:'punchitemdetail',data:{objectDescription:'item'}},photos:this.photos,items:[{xtype:'punchitemdetails',reference:'punchItemDetails',padding:5,scrollable:{x:!1,y:!0}},{xtype:'pinwizard',reference:'pinWizard',layout:'card',showFPListBackButton:!0}],bind:{title:mvstr['FVTL_Add to new {listItemD']},doneAddingPins:function(){this.setActiveItem(this.lookupController().lookupReference('punchItemDetails'))}},{bind:{title:mvstr['FVTL_Add to existing {list']},viewModel:{type:'punchlist',data:{PunchStatusID:0}},controller:'punchlist',scrollable:{x:!1,y:!0},layout:{type:'hbox',align:'stretchmax'},items:[{xtype:'punchitemfilters',width:175},{xtype:'grid',buffered:!0,purgePageCount:0,flex:1,reference:'punchItemGrid',bind:{store:'{punchitems}'},viewConfig:{enableTextSelection:!0,markDirty:!1},columns:[{dataIndex:'CategoryLabel',localized:{text:'TL_Category'},width:90},{dataIndex:'Description',localized:{text:'TL_Description'},flex:1},{dataIndex:'AssigneeList',localized:{text:'TL_Assignees'},width:110},{dataIndex:'WorkStatusLabel',localized:{text:'TL_Work Status'},width:100},{dataIndex:'DueDate',localized:{text:'TL_Due Date'},width:80,xtype:'templatecolumn',tpl:'{DueDate:date("DATE_Medium2")}'},{dataIndex:'PunchStatusLabel',localized:{text:'TL_Item Status'},width:80}]}],fbar:[{xtype:'button',bind:{disabled:'{!punchItemGrid.selection}',text:'{addToExistingText}'},listeners:{click:'onAddPinToExistingClick'}}]}]}];Ext.window.Window.prototype.initComponent.apply(this,arguments);a.mon(Ext.getBody(),'click',function(b,c){a.close(a.closeAction)},a,{delegate:'.x-mask'})}},0,['punchlistwindow'],['component','box','container','panel','window','punchlistwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'punchlistwindow':!0},['widget.punchlistwindow'],0,[floorplanViewer.view,'PunchlistWindow'],0);Ext.cmd.derive('floorplanViewer.view.pushpinFlyout.PinSelection',Ext.form.field.ComboBox,{viewModel:{stores:{pushpinTypes:{type:'pushpintypes'}}},config:{width:245,height:22,fieldLabelSeparator:':',labelAlign:'left',labelWidth:50,valueField:'PushpinTypeID',displayField:'PushpinTypeName',queryMode:'local',editable:!1},bind:{store:'{pushpinTypes}',value:'{pushpin.PushpinType}'},fieldSubTpl:['<div id="{id}" data-ref="inputEl"  role="{role}"','<tpl if="fieldStyle"> style="{fieldStyle}"</tpl> ','class="{fieldCls} {typeCls} {typeCls}-{ui} {editableCls}">','</div>'],setRawValue:function(a){var b=this;a=a?a:'';b.rawValue=a;if(b.inputEl){b.inputEl.dom.innerHTML=a}return a},getRawValue:function(){if(!this.inputEl||!this.inputEl.dom||!this.inputEl.dom.lastChild){return ''}return this.inputEl.dom.lastChild.innerHTML},constructor:function(a){var b='<img src="{PushpinSymbol}"/><span>{PushpinTypeName}</span>';a.fieldLabel=mvstr['FV_Pin'];a.displayTpl=['<tpl for=".">'+b+'</tpl>'];a.listConfig={tpl:Ext.create('Ext.XTemplate','<ul class="x-list-plain"><tpl for=".">','<li role="option" class="x-boundlist-item">'+b+'</li>','</tpl></ul>')};Ext.form.field.ComboBox.prototype.constructor.apply(this,arguments)},getValue:function(){var c=this.getRawValue(),b=this.getStore(),a=b.find(this.getDisplayField(),c);return a!=-1?b.getAt(a).get(this.getValueField()):undefined}},1,['pinselection'],['component','box','field','textfield','pickerfield','combobox','combo','pinselection'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'pinselection':!0},['widget.pinselection'],0,[floorplanViewer.view.pushpinFlyout,'PinSelection'],0);Ext.cmd.derive('floorplanViewer.view.PushpinEdit',Ext.container.Container,{items:[{xtype:'container',layout:'hbox',padding:5,items:[{xtype:'textfield',itemId:'labelField',reference:'pushpinLabelField',localized:{fieldLabel:'FV_Label'},allowBlank:!1,grow:!1,labelWidth:50,width:243},{xtype:'shareWithButton',reference:'pushpinShareButton',itemId:'pushpinShareButton',fieldLabel:'Shared with',margins:'0 0 0 0',ownerUID:'newfolder'}],bind:{hidden:'{punchpinsEnabled}'}},{xtype:'pinselection',margin:'0 0 0 5',bind:{hidden:'{punchpinsEnabled}'}},{xtype:'container',margin:'10 0 0 0',layout:{align:'stretch',type:'hbox'},items:[{xtype:'container',flex:1,layout:{align:'stretch',padding:5,type:'hbox'},items:[{xtype:'button',localized:{text:'FV_Delete'},icon:'mds/image/icon/delete.png',listeners:{click:'deletePushpin'}},{xtype:'button',localized:{text:'FV_Move'},icon:'mds/image/icon/move.png',listeners:{click:'movePushpin'}}]},{xtype:'container',flex:1,padding:0,layout:{align:'stretch',pack:'end',padding:5,type:'hbox'},items:[{xtype:'button',localized:{text:'G_Cancel'},icon:'mds/image/icon/cancel.png',listeners:{click:'cancelPushpin'}},{xtype:'button',localized:{text:'G_Save'},icon:'mds/image/icon/disk_blue.png',bind:{hidden:'{punchpinsEnabled}'},listeners:{click:'savePushpin'}}]}]}]},0,['fvPushpinEdit'],['component','box','container','fvPushpinEdit'],{'component':!0,'box':!0,'container':!0,'fvPushpinEdit':!0},['widget.fvPushpinEdit'],0,[floorplanViewer.view,'PushpinEdit'],0);Ext.cmd.derive('floorplanViewer.view.PushpinMenu',Ext.Container,{cls:'flyout-menu-wrap',floating:!0,shrinkWrap:3,hidden:!0,defaultType:'button',defaults:{width:200,scale:'medium',textAlign:'left',listeners:{click:{fn:function(a){this.up('pushpinmenu').hide()}}}},renderTo:Ext.getBody(),x:69,y:315,layout:'vbox',padding:2,items:[{localized:{text:'FV_North Arrow'},iconCls:'pinicon-northpin',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',listeners:{click:function(){this.lookupController().addPushPin(5);this.up('pushpinmenu').hide()}}},{localized:{text:'FV_East Arrow'},iconCls:'pinicon-eastpin',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',listeners:{click:function(){this.lookupController().addPushPin(6);this.up('pushpinmenu').hide()}}},{localized:{text:'FV_South Arrow'},iconCls:'pinicon-southpin',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',listeners:{click:function(){this.lookupController().addPushPin(7);this.up('pushpinmenu').hide()}}},{localized:{text:'FV_West Arrow'},iconCls:'pinicon-westpin',itemCls:'toolmenu-item',overCls:'toolmenu-item-over',listeners:{click:function(){this.lookupController().addPushPin(8);this.up('pushpinmenu').hide()}}}]},0,['pushpinmenu'],['component','box','container','pushpinmenu'],{'component':!0,'box':!0,'container':!0,'pushpinmenu':!0},['widget.pushpinmenu'],0,[floorplanViewer.view,'PushpinMenu'],0);Ext.cmd.derive('floorplanViewer.view.files.BaseViewer',Ext.panel.Panel,{},0,0,['component','box','container','panel'],{'component':!0,'box':!0,'container':!0,'panel':!0},0,0,[floorplanViewer.view.files,'BaseViewer'],0);Ext.cmd.derive('floorplanViewer.view.files.FileList',Ext.view.View,{border:!0,padding:0,cls:'documentList',itemSelector:'.document',bind:{store:'{files}'},tpl:['<tpl for=".">','<div class="document fileviewer-item">','<div class="photoRight">','<div class="fileListRemoveButton">','<button type=button id="{DocumentUID}" class="remove-button">x</button>','</div>','<img class="documentSymbol" src="{DocumentSymbol}">','</div>','<div class="photoLeft">','<div class="desc-line-1">{DocumentFilename}</div>','<div class="desc-line-2">{DocumentCreatorName}</div>','<div class="photoLeftFooter">','<span class="photoSize">{DocumentFileSize:fileSize}</span>','<span class="desc-line-3">{DocumentLastEditedDate:date("M d Y")}</span>','</div>','</div>','<div class="x-clear"></div>','</div>','</tpl>'],getMaskTarget:function(){return this.up().el}},0,['filelist'],['component','box','dataview','filelist'],{'component':!0,'box':!0,'dataview':!0,'filelist':!0},['widget.filelist'],0,[floorplanViewer.view.files,'FileList'],0);Ext.cmd.derive('floorplanViewer.view.files.FolderFileList',Ext.view.View,{border:!0,padding:0,cls:'documentList',itemSelector:'.document',bind:{store:'{folderFiles}'},tpl:['<tpl for=".">','<div class="document fileviewer-item">','<div class="photoRight">','<img class="documentSymbol" src="{DocumentSymbol}">','</div>','<div class="photoLeft">','<div class="desc-line-1">{DocumentFilename}</div>','<div class="desc-line-2">{DocumentCreatorName}</div>','<div class="photoLeftFooter">','<span class="photoSize">{DocumentFileSize:fileSize}</span>','<span class="desc-line-3">{DocumentLastEditedDate:date("M d Y")}</span>','</div>','</div>','<div class="x-clear"></div>','</div>','</tpl>'],getMaskTarget:function(){return this.up().el}},0,['folderfilelist'],['component','box','dataview','folderfilelist'],{'component':!0,'box':!0,'dataview':!0,'folderfilelist':!0},['widget.folderfilelist'],0,[floorplanViewer.view.files,'FolderFileList'],0);Ext.cmd.derive('floorplanViewer.view.files.fileViewer.FileNavModel',Ext.app.ViewModel,{data:{folderNameStack:[]},formulas:{folderTrail:function(d){var c='',b=d('folderNameStack');for(var a=0;a<=b.length-1;a++){if(a===b.length-1){c+='<b>'+b[a]+'<b>'}else {c+=b[a]+'/'}}return c},upButtonVisible:function(b){var a=b('folderNameStack');return a&&a.length?!0:!1}}},0,0,0,0,['viewmodel.filenav'],0,[floorplanViewer.view.files.fileViewer,'FileNavModel'],0);Ext.cmd.derive('floorplanViewer.view.files.fileViewer.FileViewerModel',floorplanViewer.view.files.fileViewer.FileNavModel,{stores:{projectFiles:{type:'files',proxy:{api:{read:'/index.cfm?fuseaction=aClientFileManager.getProjectFilesLite'}},listeners:{load:'onProjectFilesStoreLoad',beforeload:'beforeProjectFilesStoreLoad'}},folderFiles:{type:'files',proxy:{api:{read:'/index.cfm?fuseaction=aClientFileManager.getProjectFilesLite'},extraParams:{ProjectUID:'{ProjectUID}'}},listeners:{load:'onFolderFilesStoreLoad',beforeload:'beforeFolderFilesStoreLoad'}}},data:{nFiles:0,itemDesc:'file',itemDescPlural:'files'}},0,0,0,0,['viewmodel.fileviewer'],0,[floorplanViewer.view.files.fileViewer,'FileViewerModel'],0);Ext.cmd.derive('floorplanViewer.view.files.PhotoDialogTree',Ext.tree.Panel,{rootVisible:!1,useArrows:!0,frame:!1,border:!1,hideHeaders:!0,cls:'no-leaf-icons no-parent-icons sideNavPanel',bind:{store:'{projectPhotoCategories}'},listeners:{viewready:{fn:'onPhotoDialogTreeReady',delay:1},select:'onPhotoCategorySelect'}},0,['pushpinDialogTree'],['component','box','container','panel','tablepanel','treepanel','pushpinDialogTree'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tablepanel':!0,'treepanel':!0,'pushpinDialogTree':!0},['widget.pushpinDialogTree'],0,[floorplanViewer.view.files,'PhotoDialogTree'],0);Ext.cmd.derive('floorplanViewer.view.files.PhotoDialogDataView',Ext.grid.Panel,{id:'pushpinDialogDataView',viewConfig:{emptyText:'No Photos',deferEmptyText:!1,style:{'text-align':'center'}},selModel:{selType:'checkboxmodel',mode:'SIMPLE',injectCheckbox:'last',allowDeselect:!0},columns:[{localized:{text:'FVCPD_Image'},width:136,dataIndex:'ImageURLThumb',renderer:function(a){return '<img src="'+a+'"/>'}},{localized:{text:'FVCPD_File Name'},flex:1,dataIndex:'FileName'},{localized:{text:'FVCPD_Created By'},width:136,dataIndex:'CreatorName'},{localized:{text:'FVCPD_Photo Date'},width:134,dataIndex:'PhotoDate',renderer:function(a){return Ext.Date.format(a,mvstr['DATE_Medium']+' - g:i a')}}]},0,['pushpinDialogDataView'],['component','box','container','panel','tablepanel','gridpanel','grid','pushpinDialogDataView'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tablepanel':!0,'gridpanel':!0,'grid':!0,'pushpinDialogDataView':!0},['widget.pushpinDialogDataView'],0,[floorplanViewer.view.files,'PhotoDialogDataView'],0);Ext.cmd.derive('floorplanViewer.view.files.ChoosePhotoFBar',Ext.toolbar.Toolbar,{padding:10,initComponent:function(){var a=this.addPhotosButtonConf||{},b=this.backButtonConf||{};this.items=[{xtype:'container',layout:{type:'hbox'},flex:1,items:[Ext.merge({xtype:'button',ui:'grey',text:mvstr['G_Back'],height:31,scale:'medium',hideMode:'visibility',hidden:!0},b)]},{xtype:'container',layout:{type:'hbox',pack:'end'},flex:1,items:[Ext.merge({xtype:'button',ui:'green',text:mvstr['G_Done'],height:31,scale:'medium',hideMode:'visibility'},a)]}];Ext.toolbar.Toolbar.prototype.initComponent.apply(this,arguments)}},0,['choosephotofbar'],['component','box','container','toolbar','choosephotofbar'],{'component':!0,'box':!0,'container':!0,'toolbar':!0,'choosephotofbar':!0},['widget.choosephotofbar'],0,[floorplanViewer.view.files,'ChoosePhotoFBar'],0);Ext.cmd.derive('floorplanViewer.view.files.ChoosePhotoWindow',Ext.window.Window,{localized:{title:'FVCPD_Choose Photo'},modal:!0,uploadConfig:{},resizable:!0,layout:'fit',height:700,width:1050,canChooseMultivistaPhotos:!1,renderTo:Ext.getBody(),initComponent:function(){var b=this;var a=[{xtype:'uploadPanel',id:'choosePhotoUpload',localized:{title:'FVCPD_Upload New Photo'},style:'background-color: white',uploadConfig:Ext.apply({},b.uploadConfig,{localized:{uploadMessage:'FVCPDU_Drop photos here or c',addFilesLabel:'FVCPDU_Add Photo'}}),fbar:{xtype:'choosephotofbar',addPhotosButtonConf:{listeners:{click:function(b){var c=Ext.getStore('pushPinFlyOutDialogPhotosStore');c.load();var a=Ext.ComponentQuery.query('photofilelist');a.refresh;b.up('window').destroy()}}}}},{xtype:'panel',itemId:'chooseProjectPhotos',localized:{title:'FVCPD_Choose From Project T'},requires:['Ext.panel.Panel','Ext.resizer.Splitter'],layout:'border',items:[{xtype:'pushpinDialogTree',width:196,style:'background-color: white',autoScroll:!0,region:'west',split:!0},{xtype:'pushpinDialogDataView',itemId:'pushpinDialogDataView',reference:'projectFileGrid',flex:1,region:'center',bind:{store:'{projectPhotos}'}}],fbar:{xtype:'choosephotofbar',addPhotosButtonConf:{itemId:'addSelectedFiles',hidden:!1,bind:{disabled:'{!projectFileGrid.selection}'}}}}];if(this.canChooseMultivistaPhotos){a.push({xtype:'multivistaphoto',localized:{title:'FVCPD_Choose A Multivista P'}})}Ext.applyIf(b,{items:[{xtype:'tabpanel',activeTab:0,items:a}]});Ext.window.Window.prototype.initComponent.apply(this,arguments)}},0,['choosePhotoWindow'],['component','box','container','panel','window','choosePhotoWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'choosePhotoWindow':!0},['widget.choosePhotoWindow'],0,[floorplanViewer.view.files,'ChoosePhotoWindow'],0);Ext.cmd.derive('floorplanViewer.view.files.ProjectFileList',Ext.grid.Panel,{bind:{store:'{projectFiles}'},sortOnLoad:!0,rowLines:!0,selModel:{selType:'checkboxmodel',mode:'SIMPLE',injectCheckbox:'last',allowDeselect:!0},viewConfig:{loadMask:!0},listeners:{cellclick:function(d,g,e,c,h,f,a){var b=a.getTarget(null,1,!0).hasCls('x-file-icon')||a.getTarget(null,1,!0).hasCls('x-file-name');if(b){this.getSelectionModel().deselectAll();this.fireEvent('fileclicked',d,c)}},selectionChange:function(c,a,d){var b=this.down('#addSelectedFiles');b.setDisabled(a.length==0)}},columns:[{text:'',width:40,sortable:!1,hideable:!1,menuDisabled:!0,renderer:function(a){return '<img class="x-file-icon" src="'+a+'">'},dataIndex:'DocumentSymbol'},{localized:{text:'FVCFD_File Name'},dataIndex:'DocumentFilename',flex:1,renderer:function(a){return '<a class="x-file-name">'+a+'</a>'}},{localized:{text:'FVCFD_Updated date'},dataIndex:'DocumentLastEditedDate',xtype:'datecolumn',width:180,renderer:function(a){return Ext.Date.format(a,mvstr['DATE_Medium']+' - g:i a')}},{localized:{text:'FVCFD_Created by'},dataIndex:'DocumentCreatorName',width:120},{localized:{text:'FVCFD_File type'},dataIndex:'DocumentTypeName'},{localized:{text:'FVCFD_Size'},dataIndex:'DocumentFileSize',renderer:Ext.util.Format.fileSize}],initComponent:function(){var a=this;Ext.grid.Panel.prototype.initComponent.apply(this,arguments)}},0,['projectfilegrid'],['component','box','container','panel','tablepanel','gridpanel','grid','projectfilegrid'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tablepanel':!0,'gridpanel':!0,'grid':!0,'projectfilegrid':!0},['widget.projectfilegrid'],0,[floorplanViewer.view.files,'ProjectFileList'],0);Ext.cmd.derive('floorplanViewer.view.files.FileNavToolbar',Ext.toolbar.Toolbar,{items:[{xtype:'tbtext',padding:10,style:{backgroundColor:'#eeeeee'},bind:{text:'{folderTrail}'}}]},0,['filenavtoolbar'],['component','box','container','toolbar','filenavtoolbar'],{'component':!0,'box':!0,'container':!0,'toolbar':!0,'filenavtoolbar':!0},['widget.filenavtoolbar'],0,[floorplanViewer.view.files,'FileNavToolbar'],0);Ext.cmd.derive('floorplanViewer.view.files.ChooseFileWindow',Ext.window.Window,{localized:{title:'FVCFD_Choose File'},modal:!0,uploadConfig:{},resizable:!0,layout:'fit',height:500,width:820,renderTo:Ext.getBody(),initComponent:function(){var a=this;Ext.applyIf(a,{items:[{xtype:'tabpanel',activeTab:0,items:[{xtype:'uploadPanel',id:'chooseFileUpload',localized:{title:'FVCFD_Upload new file'},uploadConfig:a.uploadConfig},{xtype:'panel',localized:{title:'FVCFD_Choose from project f'},itemId:'projectListPanel',layout:'fit',viewModel:{type:'filenav'},tbar:{xtype:'filenavtoolbar'},items:[{xtype:'projectfilegrid',reference:'projectFileGrid',style:'background-color: white',dock:'bottom',bbar:[{xtype:'button',ui:'grey',height:31,width:60,margin:'5 5 8 5',scale:'medium',localized:{text:'G_Back'},itemId:'folderUp',hidden:!0,bind:{hidden:'{!upButtonVisible}'}},'->',{xtype:'button',itemId:'addSelectedFiles',ui:'green',height:31,width:60,margin:'5 5 8 5',scale:'medium',localized:{text:'G_Done'},bind:{disabled:'{!projectFileGrid.selection}'}}]}]}]}]});Ext.window.Window.prototype.initComponent.apply(this,arguments)},destroy:function(){1;Ext.window.Window.prototype.destroy.apply(this,arguments)}},0,['chooseFileWindow'],['component','box','container','panel','window','chooseFileWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'chooseFileWindow':!0},['widget.chooseFileWindow'],0,[floorplanViewer.view.files,'ChooseFileWindow'],0);Ext.cmd.derive('floorplanViewer.view.files.fileViewer.FileViewerController',Ext.app.ViewController,{init:function(){this.drilling=!1;this.pushpinFolderStack=[];this.folderStack=[];this.photoStores=[];this.control({'#chooseFileWindow':{close:this.onChooseFileWindowClose},'#chooseFileWindow #projectListPanel':{activate:this.onProjectListPanelActivate},'#chooseFileWindow #addSelectedFiles':{click:this.onAddSelectedFilesClick},'#chooseFileWindow #folderUp':{click:this.onProjectFilesFolderUp},'projectfilegrid':{fileclicked:this.openProjectFolder},'#fileViewerNavToolbar #folderUp':{click:'onFolderUpClick'},'#chooseFileUpload':{addUploadFormData:this.addUploadFormData,fileUploadedAndAccepted:this.onFileUploadedAndAccepted},'#choosePhotoUpload':{addUploadFormData:this.addUploadFormData,fileUploadedAndAccepted:this.onFileUploadedAndAccepted}});Ext.defer(this.addStoreListeners,1,this)},getRootFileStore:function(){var a=this.getViewModel(),c=a.get('itemDescPlural');while(a&&a.getParent()){var b=a.getParent().getStore(c);if(b){return b}a=a.getParent()}return null},addStoreListeners:function(){if(!this.getView()){return}var a=this.getRootFileStore();if(!a){return}a.addListener('beforeload',this.beforeFilesStoreLoad,this);a.addListener('datachanged',this.onFilesStoreDataChanged,this)},onFilesStoreDataChanged:function(a){this.getViewModel().set('nFiles',a.getCount())},beforeFilesStoreLoad:function(){this.drilling=!1;this.drillParent=0;var a=this.lookupReference('folderFileList');if(a){a.hide();this.lookupReference('fileList').show();this.getViewModel().set('folderNameStack',[])}},getRootZipURL:function(){var a=this.getViewModel(),f=a.get('PushpinUID'),e=a.get('ProjectUID'),c=a.get('PunchItemID'),d=Ext.String.capitalize(a.get('itemDescPlural')),b='/index.cfm?fuseaction=';if(c){b+='aClientPunchlist.zipPunchItem'+d+'&PunchItemID='+c}else {b+='aClientFloorplanViewer.zipPushpin'+d+'&PushpinID='+f}return b+'&ProjectUID='+e},onZipFilesClick:function(){var e=this.getViewModel(),d=this.getRootFileStore(),a=e.get('itemDescPlural');if(d.getCount()){Ext.MessageBox.alert('Preparing '+a+'...','The selected '+a+' are being zipped up, and your download will begin automatically when finished.');var b='';if(!this.drilling){b=mdslink.server+this.getRootZipURL()}else {var c=this.pushpinFolderStack[this.pushpinFolderStack.length-1];b=mdslink.server+'/index.cfm?fuseaction=aClientFloorplanViewer.zipFolderFiles&ProjectUID='+ProjectUID+'&Documents='+c}window.location=b}else {Ext.MessageBox.alert('No '+a+' found','No '+a+' are currently attached to this marker.')}},onZipSingleItemSelected:function(c){var f=this.getViewModel(),e=this.getRootFileStore(),a=f.get('itemDescPlural');if(e.getCount()){Ext.MessageBox.alert('Preparing '+a+'...','The selected '+a+' are being zipped up, and your download will begin automatically when finished.');var b='';if(!this.drilling){b=mdslink.server+this.getRootZipURL()+'&PhotoUID='+c}else {var d=this.pushpinFolderStack[this.pushpinFolderStack.length-1];b=mdslink.server+'/index.cfm?fuseaction=aClientFloorplanViewer.zipFolderFiles&ProjectUID='+ProjectUID+'&Documents='+d}window.location=b}else {Ext.MessageBox.alert('No '+a+' found','No '+a+' are currently attached to this marker.')}},openFileUpload:function(){var b=this.getViewModel(),a=b.get('itemDesc');multiupload.Panel.doUploaderCheck(function(){var c=this.getView().add({xtype:'choose'+Ext.String.capitalize(a)+'Window',uploadConfig:{fileFilters:floorplanViewer.FilesValues.FILTERS[a],uploadUrl:'/index.cfm?fuseaction=aClientFloorplanViewer.uploadFile',acceptedFiles:floorplanViewer.FilesValues.ACCEPTED_FILES[a],dropzoneUploadUrl:mdslink.server+'/index.cfm?fuseaction=aClientFloorplanViewer.uploadAndAcceptFile',maxFileSize:floorplanViewer.FilesValues.MAX_FILE_SIZE[a],maxQueueLength:20},canChooseMultivistaPhotos:!!(b.get('PunchItem')||b.get('PunchItemID')),reference:'chooseFileWindow',itemId:'chooseFileWindow'});c.showBy(this.getView().up('clientviewport'),'c-c?')},this)},onFolderFilesStoreLoad:function(a){if(this.pushpinFolderStack[this.pushpinFolderStack.length-1]!=a.getProxy().extraParams.parentFolderID){this.pushpinFolderStack.push(a.getProxy().extraParams.parentFolderID)}this.getViewModel().set('nFiles',a.getCount())},beforeFolderFilesStoreLoad:function(a){this.lookupReference('folderFileList').show();this.lookupReference('fileList').hide();if(typeof a.getProxy().extraParams.parentFolderID==='undefined'){a.getProxy().setExtraParam('parentFolderID',0)}},onFileItemClick:function(l,d,n,m,i){var a=this;var e=Ext.fly(i.getTarget());var f=a.getViewModel(),b=f.get('itemDesc'),h=b=='file'?'file/folder':b,g=b=='file'?'file repository':'project',c=Ext.bind(function(){a.getRootFileStore().remove(d);a.doRemoveSync()},a);if(e.hasCls('remove-button')){if(a.checkSave()){Ext.Msg.confirm('Confirm','Are you sure you want to remove this '+h+' from the '+f.get('objectDescription')+'?'+(b=='file'?' <br>(The file will remain in your '+g+')':''),Ext.bind(function(a){if(a=='yes'){c()}},a))}else {c()}return !1}else {if(e.hasCls('download-button')){var j=d.get('UDEFPhotoUID');a.onZipSingleItemSelected(j);return !1}else {if(e.hasCls('dotted-menu')){i.stopEvent();var k=Ext.create('Ext.menu.Menu',{bodyStyle:'backgroundColor: #ffffff; padding: 0px;',showSeparator:!1,floating:!0,width:'70px',items:[{text:'download',plain:!0,style:{'text-align':'left','line-height':'24px','padding':'0px 5px 0px 5px','background-image':'none'},cls:'menu-item',handler:function(){var b=d.get('UDEFPhotoUID');a.onZipSingleItemSelected(b)}},{text:'delete',plain:!0,style:{'text-align':'left','line-height':'24px','padding':'0px 5px 0px 5px','margin-bottom':'0px','background-image':'none'},cls:'menu-item',handler:function(){if(a.checkSave()){Ext.Msg.confirm('Confirm','Are you sure you want to remove this '+h+' from the '+f.get('objectDescription')+'?'+(b=='file'?' <br>(The file will remain in your '+g+')':''),Ext.bind(function(a){if(a=='yes'){c()}},a))}else {c()}}}]});k.showBy(e,'tr-br',[-8,-6]);return !1}}}a.chooseFile(d,!0)},onFolderFileItemClick:function(b,a){this.chooseFile(a,!1)},onChooseFileWindowClose:function(){for(var a=0;a<this.photoStores.length;a++){this.photoStores[a].destroy()}this.photoStores=[]},onProjectFilesStoreLoad:function(a){this.folderStack.push(a.getProxy().extraParams.parentFolderID)},beforeProjectFilesStoreLoad:function(a){if(typeof a.getProxy().extraParams.parentFolderID==='undefined'){a.getProxy().setExtraParam('parentFolderID',0)}},storeHasParams:function(){var b=this.getRootFileStore(),a=b.getProxy().getExtraParams();for(var c in a){if(a[c]===''){return !1}}return !0},checkSave:function(){return this.getRootFileStore().allowAutoSave!==!1&&this.storeHasParams()},onAddSelectedFilesClick:function(b){this.addSelectedFiles(this.lookupReference('projectFileGrid').getSelectionModel().getSelection());var a=Ext.getStore('pushPinFlyOutDialogPhotosStore');if(a){a.load()}b.up('window').destroy()},addSelectedFiles:function(a){var d=this.getRootFileStore(),c=[];for(var b=0;b<a.length;b++){if(d.getById(a[b].getId())){continue}var e=a[b].copy();e.phantom=!0;c.push(e)}if(!c.length){return}d.add(c);this.doAddSync(a.length)},doAddSync:function(a){this.doSync(a,'add')},doRemoveSync:function(a){this.doSync(a,'remove')},doSync:function(f,d){if(!this.checkSave()){return}var a=this.getRootFileStore(),b=this.getView(),c=this.getViewModel(),e=Ext.String.capitalize(f==1?c.get('itemDesc'):c.get('itemDescPlural'));b.mask('Saving ...');a.sync({failure:function(){b.unmask();a.rejectChanges();var c=a.getProxy().getReader().mvMessage;if(!c){c=mvstr.G_UnexpectedError+' Unable to '+d+' '+e.toLowerCase()}Ext.Msg.alert('Error',c)},success:function(){b.unmask()},scope:this})},onProjectFilesFolderUp:function(a){this.goUpAFolder(this.getViewModel().get('projectFiles'),this.folderStack,a.lookupViewModel())},onFolderUpClick:function(){var a=this.getViewModel(),c=a.get('ProjectUID');if(this.pushpinFolderStack[this.pushpinFolderStack.length-1]===this.drillParent){var b=a.get('files');b.getProxy().setExtraParam('ProjectUID',c);b.load()}else {if(this.drilling){this.goUpAFolder(a.get('folderFiles'),this.pushpinFolderStack,a)}}},goUpAFolder:function(c,a,b){a.pop();b.doArrayPop('folderNameStack');this.loadFolder(c,a.pop())},chooseFile:function(a,p){var b=this.getViewModel(),g=b.get('ProjectUID');if(!a.get('DocumentUID')){var h=b.get('PushpinUID'),d=b.get('PunchItemID'),c=b.get('ListTypeID');if(h){if(b.get('account.features.photoviewerVisible')){app.getMainView().add({xtype:'photoviewer',photoId:a.get('id'),ListTypeID:c,photoGroup:Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':h,'Type':'N'})}).show()}else {var e=mdslink.clientPhotoViewer+'ProjectUID='+g+'&PhotoGroupType=P&PushpinUID='+h;if(d){e+='&PunchItemID='+d}if(c){e+='&ListTypeID='+c}e+='#SelectedPhotoID='+a.get('UDEFPhotoID');window.location=e}return}var l=this.getRootFileStore(),s=l.getCount(),r=[],o=[],n=[];for(var j=0;j<s;j++){var i=l.getAt(j),q=i.get('UDEFPhotoUID');var m=i.get('Type'),k=i.get('Identifier');if(m=='P'){r.push(k)}else {if(m=='W'){n.push(k)}else {o.push(q)}}}if(this.storeHasParams()){if(b.get('account.features.photoviewerVisible')){app.getMainView().add({xtype:'photoviewer',photoId:a.get('id'),ListTypeID:c,photoGroup:Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':d,'Type':'Q'})}).show()}else {window.location=mdslink.clientPhotoViewer+'ProjectUID='+g+'&PhotoGroupType=Q&PunchItemID='+d+(c?'&ListTypeID='+c:'')}}return}if(a.get('DocumentMimeType')==='folder'){b.doArrayPush('folderNameStack',a.get('DocumentFilename'));if(p){this.pushpinFolderStack=[];this.drilling=!0;this.drillParent=a.get('DocumentUID');var f=this.getView();if(!f.getScrollable()){f.setHeight(f.el.getHeight());f.setScrollable(!0)}}this.loadFolder(b.get('folderFiles'),a.get('DocumentUID'))}else {if(this.storeHasParams()){if(!config.ISARCHIVE){window.location=mdslink.server+'/index.cfm'+a.get('DocumentURL')}else {window.location=mdslink.clientFileManager+'ProjectUID='+g}}}},onProjectListPanelActivate:function(){this.loadFolder(this.getViewModel().get('projectFiles'),0)},openProjectFolder:function(b,a){if(a.get('DocumentMimeType')==='folder'){b.lookupViewModel().doArrayPush('folderNameStack',a.get('DocumentFilename'));this.loadFolder(this.getViewModel().get('projectFiles'),a.get('DocumentUID'))}},loadFolder:function(a,b){a.getProxy().setExtraParam('ProjectUID',this.getViewModel().get('ProjectUID'));a.getProxy().setExtraParam('parentFolderID',b);a.removeAll();a.load()},addUploadFormData:function(a){var c=this.getViewModel(),g=c.get('ProjectUID'),b=c.get('PushpinUID'),e=c.get('PunchItemID'),f=this.lookupReference('chooseFileWindow').down('#fileUploadShareWithButton'),d=0;if(this.drilling){b=0;d=this.pushpinFolderStack[this.pushpinFolderStack.length-1]}a.ProjectUID=g;if(b){a.PushpinUID=b}if(e&&!b&&this.getRootFileStore().allowAutoSave!==!1){a.PunchItemID=e}a.ShareTypeID=f.getSelectedShareType();a.MemberList=f.getSelectedMemberList();a.ParentFolderID=d;a.IsPhoto=c.get('itemDesc')=='photo'?!0:!1},getContextualFileStore:function(){return this.drilling?this.getViewModel().get('folderFiles'):this.getRootFileStore()},loadContextualFileStore:function(){this.getContextualFileStore().load()},onPhotoDialogTreeReady:function(a){var e=a.getRootNode(),c=e.getChildAt(0),b=this.getViewModel(),f=b.get('projectPhotos'),d=c.getPath();a.selectPath(d)},onPhotoCategorySelect:function(j,g){var h=this.getViewModel(),c=this.lookupReference('projectFileGrid'),i=c.getStore(),d=g.get('id'),b=g.get('type'),f=floorplanViewer.store.ProjectPhotos.getDefaultStoreId(b,d),e=Ext.getStore(f);if(e){c.bindStore(e)}else {var a=Ext.create('floorplanViewer.store.ProjectPhotos',{storeId:f});this.photoStores.push(a);a.getProxy().setExtraParams({ProjectUID:h.get('ProjectUID'),Identifier:b==='V'?'':d,Type:b});c.bindStore(a);a.load()}},onFileUploadedAndAccepted:function(c){var b=this.getRootFileStore(),a=Ext.create(b.config.model,c);a.phantom=!0;b.add(a);this.doAddSync(1)},onListViewRender:function(){console.log('viewModel:\t',this.getViewModel());this.onImagesButtonClick()},onImagesButtonClick:function(){var a=Ext.getStore('pushPinFlyOutDialogPhotosStore');if(a){this.photoStoreFilter(a,'images')}},on360ButtonClick:function(){var a=Ext.getStore('pushPinFlyOutDialogPhotosStore');if(a){this.photoStoreFilter(a,'360')}},photoStoreFilter:function(b,a){b.clearFilter();b.filterBy(function(e){var c=!1;var d=e.get('IsThreeSixty');if(a==='images'&&!d){c=!0}else {if(a==='360'&&d){c=!0}}return c})},onButtonsRendered:function(a,b){if(a.id==='imagesButton'){a.btnInnerEl.setStyle('color','black')}if(a.id==='images360Button'){a.btnInnerEl.setStyle('color','blue')}},onButtonToggled:function(b,e){var a=b.id;b.btnInnerEl.setStyle('color','black');if(a==='imagesButton'){var c=Ext.getCmp('images360Button');c.btnInnerEl.setStyle('color','blue')}else {if(a==='images360Button'){var d=Ext.getCmp('imagesButton');d.btnInnerEl.setStyle('color','blue')}}}},0,0,0,0,['controller.fileviewer'],0,[floorplanViewer.view.files.fileViewer,'FileViewerController'],0);Ext.cmd.derive('floorplanViewer.view.files.fileViewer.FileViewer',floorplanViewer.view.files.BaseViewer,{controller:'fileviewer',viewModel:{type:'fileviewer',formulas:{viewHeight:{bind:{_filesDataChanged:'{_filesDataChanged}',files:'{files}'},get:function(a){return a.files.getCount()?302:104}}}},height:302,bind:{height:'{viewHeight}'},localized:{title:'FV_Files'},scrollable:{x:!1,y:!0},fileList:{xtype:'filelist'},folderFileList:{xtype:'folderfilelist'},addButton:{xtype:'button',localized:{text:'FVCFD_Add files'},icon:'mds/image/clientFileManager/icons/folder_new.png'},showDownloadButton:!0,showTbarTitle:!1,initComponent:function(){this.addButton.itemId='openPhotoUpload';this.addButton.listeners={click:'openFileUpload'};this.addButton.bind=this.addButton.bind||{};if(!this.addButton.bind.hidden){this.addButton.bind.hidden='{!account.canWrite}'}this.fileList.reference='fileList';this.fileList.listeners={itemclick:'onFileItemClick'};this.folderFileList.reference='folderFileList';this.folderFileList.listeners={itemclick:'onFolderFileItemClick'};var a={xtype:'toolbar',items:['->',this.addButton]},b={xtype:'filenavtoolbar',reference:'fileViewerNavToolbar',itemId:'fileViewerNavToolbar'};if(this.ui){a.ui=this.ui;b.ui=this.ui}if(this.showDownloadButton&&!config.ISARCHIVE){a.items.unshift({xtype:'button',localized:{text:'FV_Download All'},reference:'zipFiles',icon:'mds/image/clientFileManager/icons/download.png',listeners:{click:'onZipFilesClick'},bind:{hidden:'{!nFiles}'}})}if(this.showTbarTitle){a.items.unshift({xtype:'component',cls:'x-panel-header-title-detail-form',html:mvstr['TL_Files']})}var c={xtype:'container',layout:{type:'vbox',align:'stretch'},width:'100%',items:[a,b],dock:'top'};this.tbar={};if(this.ui){this.tbar.ui=this.ui}this.tbar.items=[c];this.items=[this.fileList,this.folderFileList];floorplanViewer.view.files.BaseViewer.prototype.initComponent.apply(this,arguments)},repositionFloatingItems:Ext.emptyFn},0,['fileviewer'],['component','box','container','panel','fileviewer'],{'component':!0,'box':!0,'container':!0,'panel':!0,'fileviewer':!0},['widget.fileviewer'],0,[floorplanViewer.view.files.fileViewer,'FileViewer'],0);Ext.cmd.derive('floorplanViewer.view.PushpinView',Ext.tab.Panel,{id:'fvPushpinTabPanelView',height:350,initComponent:function(){var a=[{xtype:'photofileviewer',includeBBar:!0},{xtype:'fileviewer'}];if(this.lookupViewModel().get('ListTypeID')){a.unshift({xtype:'panel',localized:{title:'FV_Punch Item'},layout:{type:'fit'},scrollable:{x:!1,y:!0},items:[{xtype:'punchitemsummary',padding:10,width:'100%',reference:'punchItemSummary'}],tbar:[{xtype:'button',localized:{text:'FV_Go to Punch Item Entr'},icon:'mds/image/icon/edit_task.png',bind:{href:'{mdslink_clientPunchlistEntry}ListTypeID={ListTypeID}&ProjectUID={ProjectUID}&PunchItemID={PunchItemID}'}}]})}else {a.push({xtype:'panel',localized:{title:'FV_Followers'},reference:'pushpinFollowers',layout:{type:'fit'},scrollable:{x:!1,y:!0},tabBar:{bind:{hidden:'{!followControlsVisible}'}},items:[{xtype:'followerGrid'}]})}Ext.applyIf(this,{items:a});Ext.tab.Panel.prototype.initComponent.apply(this,arguments)},bind:{activeTab:'{defaultPushpinViewTab}'}},0,['fvPushpinView'],['component','box','container','panel','tabpanel','fvPushpinView'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tabpanel':!0,'fvPushpinView':!0},['widget.fvPushpinView'],0,[floorplanViewer.view,'PushpinView'],0);Ext.cmd.derive('floorplanViewer.view.SearchContainer',Ext.Container,{floating:!0,shrinkWrap:3,hidden:!0,style:{background:'#0D014D'},defaults:{width:125,textAlign:'left'},renderTo:Ext.getBody(),x:69,y:198,width:204,height:90,layout:'vbox',padding:16,items:[{xtype:'combo',reference:'searchCombo',itemId:'searchCombo',width:'100%',localized:{fieldLabel:'FV_Go to photo number'},labelAlign:'top',valueField:'itemId',displayField:'itemLabel',typeAhead:!0,caseSensitive:!1,valueNotFoundText:'not found',forceSelection:!0,queryMode:'local',labelStyle:{color:'#999999',fontSize:'18px',fontWeight:'bold'},listeners:{beforequery:function(a){if(a.query){var b=a.query.length;a.query=new RegExp(Ext.String.escapeRegex(a.query),'i');a.query.length=b}},select:'onSelectSearchPhoto'}}]},0,['searchcontainer'],['component','box','container','searchcontainer'],{'component':!0,'box':!0,'container':!0,'searchcontainer':!0},['widget.searchcontainer'],0,[floorplanViewer.view,'SearchContainer'],0);Ext.cmd.derive('floorplanViewer.view.SelectMenu',Ext.Container,{cls:'flyout-menu-wrap',floating:!0,shrinkWrap:!0,hidden:!0,renderTo:Ext.getBody(),x:69,y:256,layout:{type:'vbox',align:'stretchmax'},padding:2,constructor:function(){this.items=[{xtype:'container',reference:'selectHotspotsPopup',cls:'selectedHotspotText',padding:4,html:"<span class='selectedHotspotText'>"+mvstr['FV_Click and drag to sel']+'</span>'},{xtype:'container',layout:'hbox',defaults:{xtype:'button',height:30,flex:1},items:[{text:mvstr['G_Cancel'],ui:'red',listeners:{click:'resetPhotoSelectionMenu'}},{reference:'selectHotspotsViewBtn',disabled:!0,text:mvstr['G_View'],ui:'green',listeners:{click:function(){var a=this.lookupController().photoSelectionData;a.getIdsAndPost()}}}]}];Ext.container.Container.prototype.constructor.apply(this,arguments)}},1,['selectmenu'],['component','box','container','selectmenu'],{'component':!0,'box':!0,'container':!0,'selectmenu':!0},['widget.selectmenu'],0,[floorplanViewer.view,'SelectMenu'],0);Ext.cmd.derive('floorplanViewer.view.ThumbDataView',Ext.view.View,{itemSelector:'.thumbContainer',layout:'fit',selectionModel:{type:'dataviewmodel',mode:'SIMPLE'},config:{tooltips:[]},constructor:function(){this.tpl=new Ext.XTemplate('<tpl for="."><div class="thumbContainer {Orientation}" id="tmb_{id}"><tpl if="HasAnnotations"><div class="annotation" title="Photo has annotations"></div></tpl><div class="comment" style="{[this.getCommentStyle(values)]}" title="{CommentCount:this.getCommentTooltip}"><span>{CommentCount}</span></div><tpl if="IsPano"><div class="pano" title="This is an aerial panorama"></div></tpl><tpl if="IsInteriorPano"><div class="pano" title="This is an interior panorama"></div></tpl><a href="{[this.getPhotoViewerURL(values)]}">{[this.wrapperStart(values)]}<img src="{ImageURLThumb}" alt="" title="{PhotoDate:date("DATE_Medium")} - mvstr[FV_Click to open]" class="imgTmb" />{[this.wrapperEnd()]}</a></div><div class="thumbInfo">{PhotoDate:date("DATE_Medium")}</div></tpl>',{getCommentStyle:function(a){if(a.CommentCount>0&&a.HasAnnotations>0){return 'left:20px !important;'}else {if(a.CommentCount>0&&!a.HasAnnotations){return 'left:2px !important;'}}return 'display:none;'},getCommentTooltip:function(a){if(a==1){return mvstr['FV_Photo has 1 comment']}else {return mvstr['FV_Photo has {x} comment'].replace('{x}',a)}},getPhotoViewerURL:function(a){if(Ext.ComponentQuery.query('fvPhotoThumbDataView')[0].lookupViewModel().get('account.features.photoviewerVisible')){return '#'}if(this.selectPhotoThumbs){return '#'}var b=Ext.Object.fromQueryString(document.location.search).ProjectUID;return mdslink.clientPhotoViewer+'ProjectUID='+b+'&PhotoGroupType=s&ShootUID='+a.ShootUID+'&SelectedPhotoID='+a.Identifier},wrapperStart:function(b){if(this.selectPhotoThumbs){var a='';return '<div class="wrapper" '+a+'>'}return ''},wrapperEnd:function(){if(this.selectPhotoThumbs){return '</div>'}return ''}});Ext.view.View.prototype.constructor.apply(this,arguments)},listeners:{beforerender:function(){this.tpl.selectPhotoThumbs=this.selectPhotoThumbs},itemmouseenter:function(d,b,a,c){if(!this.selectPhotoThumbs){Ext.fly(a).addCls('thumbHover')}},itemmouseleave:function(d,b,a,c){if(!this.selectPhotoThumbs){Ext.fly(a).removeCls('thumbHover')}},itemmousedown:function(e,b,d,c){var a=b.getPhotoEventProperties();a['Shoot UID']=b.get('ShootUID');analytics.Ctrl.log('Clicked on Thumbnail',a)},select:function(f,a){var c=this.lookupViewModel();if(this.selectPhotoThumbs){var d='tmb_'+a.get('id');var e=Ext.getElementById(d).className.indexOf('landscape')>-1?'landscape':'portrait';Ext.ComponentQuery.query('multivistaphoto')[0].controller.onPhotoSelect(0,a);Ext.fly(Ext.getElementById(d)).addCls(e)}else {if(c.get('account.features.photoviewerVisible')){var b=c.get('floorplan');app.getMainView().add({xtype:'photoviewer',photoId:a.get('id'),storeSession:c.get('storeSession'),photoGroup:Ext.create('floorplanViewer.model.PhotoGroup',{Identifier:b.get('ProjectShootTypeUID'),StartDate:a.get('PhotoDate'),'Type':'D',Title:b.get('ProjectShootTypeDisplayLabel'),Locations:b.get('floorplanTitle')?[b.get('floorplanTitle')]:[],ShootUID:a.get('ShootUID')})}).show()}}},deselect:function(b,a){if(this.selectPhotoThumbs){Ext.ComponentQuery.query('multivistaphoto')[0].controller.onPhotoDeselect(0,a)}},refresh:function(c){var b=c.all.elements,g=this.getTooltips(),f=this.selectPhotoThumbs?this.up('choosePhotoWindow').down('fvFloorplanViewer').getEl():null,e=c.getStore();if(this.selectPhotoThumbs){this.destroyTooltips()}for(var a=0;a<b.length;a++){var d=Ext.select('#'+b[a].id+' img').elements[0];if(d){d.onload=Ext.bind(c.onImageLoad,d,[this,e.getAt(a)])}if(this.selectPhotoThumbs){var h=e.getAt(a),i=Ext.create('Ext.tip.ToolTip',{target:Ext.fly(b[a]),trackMouse:!1,anchor:'right',renderTo:f,constrain:!0,html:'<img src='+h.get('ImageURLMedium')+'>',showDelay:300});g.push(i)}}},destroy:function(){this.destroyTooltips()}},onImageLoad:function(f,c){var a=this,d=a.naturalWidth,b=a.naturalHeight;if(!d||!b){var e=new Image();e.onload=function(){a.naturalWidth=this.width;a.naturalHeight=this.height;Ext.bind(f.onImageLoad,a)()};e.src=a.src;return}if(d>b){c.set('Orientation','landscape')}else {c.set('Orientation','portrait')}},destroyTooltips:function(){var b=this.getTooltips();for(var a=0;a<b.length;a++){b[a].destroy()}}},1,['fvPhotoThumbDataView'],['component','box','dataview','fvPhotoThumbDataView'],{'component':!0,'box':!0,'dataview':!0,'fvPhotoThumbDataView':!0},['widget.fvPhotoThumbDataView'],0,[floorplanViewer.view,'ThumbDataView'],0);Ext.cmd.derive('floorplanViewer.view.files.PhotoFileList',Ext.view.View,{border:!0,padding:0,cls:'documentList',itemSelector:'.photo',bind:{store:'{photos}'},tpl:['<tpl for=".">','<div class="photo fileviewer-item type-cls-{Type}">','<div class="photoLeft">','<div class="desc-line-1">{DescLine1}</div>','<div class="desc-line-2">{DescLine2}</div>','<div class="photoLeftFooter">','<span class="photoSize">{FileSize:fileSize}</span>','<span class="desc-line-3">{DescLine3}</span>','</div>','</div>','<div class="photoRight">','<img class="photoThumb" src="{ImageURLThumb}" alt="Open in Photo Viewer">','</div>','<div class="fileListRemoveButton" id="dotted-menu"  style="vertical-align: middle;position:relative;">','<div style="font-size: 40px;vertical-align: middle;position:absolute;top:5px;font-family: mv-icons-font; margin-right: 24px; margin-top: 10px;">','<img class="dotted-menu" src="mds/image/icon/pin_widget_menu.svg" alt="dotted menu" style="padding: 10px;">','</div>','</div>','</div>','</tpl>']},0,['photofilelist'],['component','box','dataview','photofilelist'],{'component':!0,'box':!0,'dataview':!0,'photofilelist':!0},['widget.photofilelist'],0,[floorplanViewer.view.files,'PhotoFileList'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.MultivistaPhotoModel',Ext.app.ViewModel,{data:{thumbSize:'medium',activeSelectionMode:floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_PHOTO,dateFilter:{overallDateRange:{startDate:null,endDate:null},contextDateRange:{startDate:null,endDate:null},filterDateRange:{startDate:null,endDate:null}},selectedPhotos:null,showButtons:null},stores:{selectionMode:{type:'photoselectionmode'},photoCategories:{type:'photocategories',proxy:{extraParams:{ProjectUID:'{ProjectUID}'}},autoLoad:!0,mvAutoLoadVars:!0},photoGroups:{model:'floorplanViewer.model.PhotoGroup',proxy:{url:'index.cfm?fuseaction=aClientPhotoList.getPhotoGroups2',extraParams:{ProjectUID:'{ProjectUID}',Type:'{photoGroupType}',Identifier:'{photoGroupIdentifier}'}},autoLoad:!0},locations:{type:'locations'},progressions:{},floorplans:{type:'floorplans',proxy:{extraParams:{ProjectUID:'{ProjectUID}'}},autoLoad:!0,listeners:{load:'onFloorplansLoaded'}}},formulas:{photoFilterEnabled:function(a){return a('activeSelectionMode')==floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_PHOTO&&a('_photoCategoriesLoaded')},selectByShootTypeEnabled:function(a){return a('activeSelectionMode')==floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_FLOORPLAN},hideFooterButtons:function(a){return !a('showButtons')}}},0,0,0,0,['viewmodel.multivistaphoto'],0,[floorplanViewer.view.files.multivistaPhoto,'MultivistaPhotoModel'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.PhotoList',Ext.view.View,{loadMask:!1,selectionModel:{type:'dataviewmodel',mode:'SIMPLE'},tpl:['<tpl for=".">','<tpl if="LoadedImage">','<div class="photo thumb"><div class="wrapper"><img src="{LoadedImage}"></div></div>','<tpl elseif="LoadedImage===0">','<div class="photo thumb error">','<div class="message">mvstr[PT_Failed to load image]</div>','</div>','<tpl else>','<div class="photo thumb">','<div class="loading"></div>','</div>','</tpl>','</tpl>'],itemSelector:'.photo',listeners:{beforeselect:function(b,a){if(!a.get('LoadedImage')){return !1}return !0}}},0,['photolist'],['component','box','dataview','photolist'],{'component':!0,'box':!0,'dataview':!0,'photolist':!0},['widget.photolist'],0,[floorplanViewer.view.files.multivistaPhoto,'PhotoList'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.PhotoGroup',Ext.Container,{store:null,margin:'0 0 10 10',initComponent:function(){this.viewLoaded=!1;var a=[{xtype:'component',cls:'photo-group-header mds-light-bg-list-header',html:this.record.get('Title')+' - '+Ext.Date.format(this.record.get('StartDate'),'F j, Y')}];Ext.applyIf(this,{items:a});Ext.container.Container.prototype.initComponent.apply(this,arguments)},addView:function(){this.add({xtype:'photolist',store:this.store});if(!this.store.isLoaded()&&!this.store.isLoading()){this.store.load()}this.viewLoaded=!0}},0,['photogroup'],['component','box','container','photogroup'],{'component':!0,'box':!0,'container':!0,'photogroup':!0},['widget.photogroup'],0,[floorplanViewer.view.files.multivistaPhoto,'PhotoGroup'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.SelectByPhotoList',Ext.panel.Panel,{reference:'photos',itemId:'photos',scrollable:{y:!0,listeners:{scroll:{fn:function(){Ext.ComponentQuery.query('selectbyphoto')[0].lookupController().fireEvent('checkqueue')}}}},listeners:{destroy:'onLeaveSelectByPhoto'}},0,['selectbyphotolist'],['component','box','container','panel','selectbyphotolist'],{'component':!0,'box':!0,'container':!0,'panel':!0,'selectbyphotolist':!0},['widget.selectbyphotolist'],0,[floorplanViewer.view.files.multivistaPhoto,'SelectByPhotoList'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.MultivistaPhotoController',Ext.app.ViewController,{statics:{MAX_PHOTO_LOADS:18,PEEK_THRESHOLD:600},init:function(){this.photoFilters=[];this.getViewModel().bind('{_photoCategoriesLoaded}',this.onPhotoCategoriesLoaded,this);this.addListener('checkqueue',this.checkQueue,this,{buffer:100});this.getViewModel().bind('{dateFilter.filterDateRange}',this.onDateChange,this);this.control({'photolist':{select:this.onPhotoSelect,deselect:this.onPhotoDeselect}})},onPhotoCategoriesLoaded:function(h){if(!h){return}var g=this.getStore('photoCategories'),e=g.getDateRange(),f=this.getStore('locations'),d=g.getLocations(),c=[{Location:mvstr['FVCPD_All Locations']}];this.getViewModel().set('dateFilter.overallDateRange',{startDate:e.startDate,endDate:e.endDate});for(var b=0;b<d.length;b++){c.push({Location:d[b]})}f.loadRawData(c);var a=this.lookupReference('locationsCombo');a.suspendEvent('change');a.setStore(f);a.setValue(mvstr['FVCPD_All Locations']);a.resumeEvent('change')},onFloorplansLoaded:function(f,d){var a=[];for(var c=d.length-1;c>=0;c--){var e=d[c].get('ProjectShootTypeLabel');var g=d[c].get('FloorplanDescription');if(a.indexOf(e)===-1){a.splice(0,0,e)}}a.splice(0,0,mvstr['FVCPD_All Progressions']);var b=this.lookupReference('progressionCombo');b.suspendEvent('change');b.setStore(a);b.setValue(mvstr['FVCPD_All Progressions']);b.resumeEvent('change')},resetPhotoList:function(){this.photoStores=[];this.photoArray=[];this.photoLoads=[];this.startedPhotoChecks=!1;this.photoLoadCancelled=!1;this.photoGroupViewArray=[];this.loadingPhotoDataviews=[]},onChoosePhotoCategory:function(c,a){this.resetPhotoList();this.getView().mask('Loading ...');this.photoGroupStore=this.getPhotoGroupStore(a);this.enteredPhotoListByFilter=!1;this.photoFilters=[];var b=this.getViewModel();b.set('dateFilter.contextDateRange',{startDate:a.get('StartDate'),endDate:a.get('EndDate')});b.set('dateFilter.filterDateRange',{startDate:null,endDate:null});if(!this.photoGroupStore.isLoaded()){this.photoGroupStore.addListener('load',this.onPhotoGroupsLoad,this,{single:!0});this.photoGroupStore.load()}else {this.onPhotoGroupsLoad(this.photoGroupStore)}this.getStore('locations').filter({filterFn:function(b){return !!(b.get('Location')==mvstr['FVCPD_All Locations']||Ext.Array.contains(a.get('Locations'),b.get('Location')))}})},getPhotoGroupStore:function(b){var d=this.getViewModel(),c='photoCategory_'+b.getId(),a=Ext.getStore(c);if(!a){a=Ext.create('Ext.data.Store',{model:'floorplanViewer.model.PhotoGroup',storeId:c,proxy:{url:'/index.cfm?fuseaction=aClientPhotoList.getPhotoGroups2',extraParams:{ProjectUID:d.get('ProjectUID'),Type:b.get('Type'),Identifier:b.get('Identifier')}}})}a.clearFilter();a.addFilter(this.photoFilters);return a},onPhotoGroupsLoad:function(){this.getViewModel().set('showButtons',!0);if(this.photoLoadCancelled){return}var e=this.photoGroupStore,g=e.getCount(),i=this.getViewModel().get('ProjectUID'),c=[];for(var d=0;d<g;d++){var a=e.getAt(d),f='photoGroup_'+a.getId(),b=Ext.getStore(f);if(!b){b=Ext.create('floorplanViewer.store.MultivistaPhotos',{storeId:f,proxy:{extraParams:{ProjectUID:i,Identifier:a.get('Identifier'),LookupDate:a.get('StartDate')}},mvCanAbort:!0})}this.photoStores.push(b);var a=Ext.create('floorplanViewer.view.files.multivistaPhoto.PhotoGroup',{store:b,record:a,itemId:b.getId()});b.photoGroup=a;c.push(a);this.photoGroupViewArray.push(a)}var j=Ext.create('floorplanViewer.view.files.multivistaPhoto.SelectByPhotoList',{items:c}),h=this.lookupReference('selectByPhoto');h.add(j);this.lookupReference('selectByPhoto').setActiveItem(this.lookupReference('photos'));if(c.length){this.fireEvent('checkqueue')}else {this.getView().unmask()}},loadPhotoStore:function(b,c){if(this.photoLoadCancelled){return}var a=this.photoStores[b];if(!a){return}if(a.isLoaded()){this.onPhotoStoreLoad(a)}else {if(!a.isLoading()){a.addListener('load',this.onPhotoStoreLoad,this,{single:!0});a.load()}}if(!c){this.loadPhotoStore(b-1,!0);this.loadPhotoStore(b+1,!0)}},onPhotoStoreLoad:function(b){if(this.photoLoadCancelled){return}if(!this.startedPhotoChecks){this.startedPhotoChecks=!0;this.getView().unmask()}var c=b.photoGroup,e=c.down('dataview');var d=b.getCount();for(var a=0;a<d;a++){this.photoArray.push({record:b.getAt(a),index:a,view:c})}this.fireEvent('checkqueue')},checkQueue:function(){if(this.photoLoadCancelled){return}if(this.photoLoads.length>=this.self.MAX_PHOTO_LOADS){return}for(var a=0;a<this.photoGroupViewArray.length;a++){if(!this.photoGroupViewArray[a].isHidden()&&!this.photoGroupViewArray[a].viewLoaded&&this.elInView(this.photoGroupViewArray[a].el)){this.photoGroupViewArray[a].addListener('resize',function(){this.fireEvent('checkqueue')},this,{single:!0});this.photoGroupViewArray[a].addView();this.loadPhotoStore(a);return}}var b=[],d=this.self.MAX_PHOTO_LOADS-this.photoLoads.length,f=[];for(var a=0;a<this.photoArray.length&&b.length<d;a++){var e=this.photoArray[a];if(this.photoInView(e)){b.push(e);f.push(a);if(b.length==d){this.nextPhoto=this.photoArray[a+1]}}}for(var c=0;c<b.length;c++){if(!b[c].record.get('LoadedImage')){this.addPhotoLoad(b[c])}}this.photoArray=Ext.Array.difference(this.photoArray,b)},photoInView:function(a){if(!a||this.photoLoadCancelled||a.view.isHidden()){return !1}if(!a.el&&a.view.getEl()){var b=a.view.getEl().select('.photo',!0).elements;if(!b[a.index]){return}a.el=b[a.index];a.index=undefined}return this.elInView(a.el)},elInView:function(a){if(!a||!a.dom){return !1}var d=this.lookupReference('selectByPhoto'),b=d.getBox(),c=a.getBox();return !!(c.top<=b.bottom+this.self.PEEK_THRESHOLD&&c.bottom>=b.top-this.self.PEEK_THRESHOLD)},addPhotoLoad:function(c){var a=c.view.down('dataview');if(!Ext.Array.contains(this.loadingPhotoDataviews,a)){a.suspendLayouts()}this.loadingPhotoDataviews.push(a);var b=new Image(),d=c.record.get('ImageURLMedium'),e=Ext.bind(function(){Ext.Array.remove(this.photoLoads,b);Ext.Array.removeAt(this.loadingPhotoDataviews,Ext.Array.indexOf(this.loadingPhotoDataviews,a));if(!Ext.Array.contains(this.loadingPhotoDataviews,a)){a.resumeLayouts(!0)}if(!this.photoLoads.length){if(this.photoInView(this.nextPhoto)){this.fireEvent('checkqueue')}}},this),f=!0;b.onload=Ext.bind(function(){c.record.set('LoadedImage',d);e()},this);b.onerror=Ext.bind(function(){if(f){d=c.record.get('ImageURLThumb');b.src=d;f=!1}else {c.record.set('LoadedImage',0);e()}},this);this.photoLoads.push(b);b.src=d},onLeaveSelectByPhoto:function(){this.photoLoadCancelled=!0;if(!this.photoGroupStore){return}this.photoGroupStore.clearListeners();if(!this.photoGroupStore.storeId){this.photoGroupStore.destroy()}this.photoGroupStore=null;for(var a=0;a<this.photoStores.length;a++){this.photoStores[a].mvAbort()}this.photoStores=[];for(var a=0;a<this.photoLoads.length;a++){this.photoLoads[a].onload=null;this.photoLoads[a].onerror=null;this.photoLoads[a].src=''}this.getStore('locations').clearFilter();this.getViewModel().set('selectedPhotos',null);if(!this.reenteringPhotoList){var c=this.getViewModel();c.set('dateFilter.contextDateRange',{startDate:null,endDate:null});c.set('dateFilter.filterDateRange',{startDate:null,endDate:null});var b=this.lookupReference('locationsCombo');if(b){b.setRawValue(mvstr['FVCPD_All Locations'])}this.photoFilters=[]}},isInDateRange:function(a,b,c,d){return !!(c<=a&&d>=a||c>=a&&d<=b||c<=b&&d>=b)},onDateChange:function(b){var c=b.startDate,d=b.endDate,a={filterFn:Ext.bind(function(a){return this.isInDateRange(c,d,a.get('StartDate'),a.get('EndDate'))},this),id:'date'};if(!c||!d){return}if(this.photoGroupStore){if(this.enteredPhotoListByFilter){this.reenterPhotoListWithFilter(a);return}this.applyPhotoListFilter(a)}else {this.enterPhotosViaFilter(a)}},reenterPhotoListWithFilter:function(a){this.getView().mask('Loading ...');this.reenteringPhotoList=!0;this.lookupReference('photos').destroy();Ext.defer(function(){this.enteredPhotoListByFilter=!1;this.reenteringPhotoList=!1;this.enterPhotosViaFilter(a)},1,this)},noPhotosAlert:function(){var a=Ext.Msg.alert(mvstr['PUL_No Photos Found'],mvstr['PUL_No photos match the f']);Ext.defer(function(){a.alignTo(this.getView(),'c-c?')},1,this)},onLocationChange:function(b,a){if(this.getViewModel().get('activeSelectionMode')==floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_PHOTO){this.onSelectByPhotoLocationChange(a)}else {this.onSelectByFloorplanLocationChange(a)}},onProgressionChange:function(c,a){var b=this.getStore('floorplans');if(a==mvstr['FVCPD_All Progressions']){b.removeFilter('progression')}else {b.addFilter({id:'progression',property:'ProjectShootTypeLabel',value:a})}},onSelectionModeChange:function(b,a){if(a==floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_PHOTO){this.lookupReference('selectByPhoto').setActiveItem(0)}this.lookupReference('locationsCombo').setValue(mvstr['FVCPD_All Locations']);this.getViewModel().set('selectedPhotos',null);this.getViewModel().set('showButtons',null)},onSelectByPhotoLocationChange:function(b){var a={filterFn:Ext.bind(function(d){if(b==mvstr['FVCPD_All Locations']){return !0}var c=d.get('Locations');for(var a=0;a<c.length;a++){if(c[a]==b){return !0}}return !1},this),id:'location'};if(this.photoGroupStore){if(this.enteredPhotoListByFilter){this.reenterPhotoListWithFilter(a);return}this.applyPhotoListFilter(a)}else {this.enterPhotosViaFilter(a)}},applyPhotoListFilter:function(h){this.lookupReference('photos').getScrollable().scrollTo(0,0);var b=[],c=[],g=0,d=this.photoFilters;this.addFilter(d,h);for(var a=0;a<this.photoGroupViewArray.length;a++){var i=this.photoGroupViewArray[a].record,f=!0;for(var e=0;e<d.length;e++){if(!d[e].filterFn(i)){f=!1;break}}if(f){g++;if(this.photoGroupViewArray[a].isHidden()){c.push(this.photoGroupViewArray[a])}}else {if(!this.photoGroupViewArray[a].isHidden()){b.push(this.photoGroupViewArray[a])}}}if(!g){this.noPhotosAlert()}if(c.length||b.length){Ext.suspendLayouts();for(var a=0;a<c.length;a++){c[a].show()}for(var a=0;a<b.length;a++){b[a].hide()}Ext.resumeLayouts()}this.fireEvent('checkqueue')},enterPhotosViaFilter:function(f){this.addFilter(this.photoFilters,f);this.resetPhotoList();var e=this.getStore('photoCategories'),a=[];e.each(function(c){for(var b=0;b<this.photoFilters.length;b++){if(!this.photoFilters[b].filterFn(c)){return}}a.push(this.getPhotoGroupStore(c))},this);var d=0,c=Ext.bind(function(){d++;if(d>=a.length){var g=[];for(var b=0;b<a.length;b++){var e=a[b].getRange();for(var c=0;c<e.length;c++){g.push(e[c])}}this.photoGroupStore=Ext.create('Ext.data.Store',{model:'floorplanViewer.model.PhotoGroup',proxy:{type:'memory'},data:g});this.enteredPhotoListByFilter=!0;this.photoGroupStore.sort([{property:'StartDate',direction:'DESC'}]);this.onPhotoGroupsLoad()}},this);if(!a.length){c();this.noPhotosAlert();return}this.getView().mask('Loading ...');for(var b=0;b<a.length;b++){if(a[b].isLoaded()){c()}else {a[b].load({callback:c})}}},mvPhotoBackBtnClick:function(a){this.getViewModel().set('showButtons',null);this.getViewModel().set('selectedPhotos',null);if(this.getViewModel().get('activeSelectionMode')==floorplanViewer.FilesValues.PHOTO_SELECTION_MODE.SELECT_BY_PHOTO){this.lookupReference('selectByPhoto').setActiveItem(0)}else {this.getView().down('fvPhotoThumbDataView').getStore().removeAll();this.lookupReference('multivistaPhotoTBar').show();this.lookupReference('selectByFloorplan').setActiveItem(0)}},addFilter:function(a,c){for(var b=0;b<a.length;b++){if(a[b].id==c.id){a[b]=c;return}}a.push(c)},onPhotoSelect:function(c,b){if(!b.get('PhotoDate')){b.set('PhotoDate',b.store.getProxy().getExtraParams().LookupDate)}var a=this.getViewModel().get('selectedPhotos');if(!a){a=[]}Ext.Array.include(a,b);this.getViewModel().set('selectedPhotos',a)},onPhotoDeselect:function(c,b){var a=this.getViewModel().get('selectedPhotos');Ext.Array.remove(a,b);if(!a.length){a=null}this.getViewModel().set('selectedPhotos',a)},addPhotos:function(){var a=this.getViewModel().get('selectedPhotos');if(a){this.getView().up('window').lookupController().addSelectedFiles(a)}this.getView().up('window').destroy()},onSelectByFloorplanLocationChange:function(a){var b=this.getStore('floorplans');if(a==mvstr['FVCPD_All Locations']){b.removeFilter('location')}else {b.addFilter({id:'location',property:'FloorplanDescription',value:a})}},onChooseFloorplan:function(d,c){this.lookupReference('multivistaPhotoTBar').hide();this.getViewModel().set('showButtons',!0);var b=this.lookupReference('floorplanViewer'),a=b.lookupViewModel();if(a.get('FloorplanUID')){b.mask('Loading');a.set('_recordfloorplan',null);a.set('FloorplanUID',null);a.notify()}a.set('FloorplanUID',c.get('FloorplanUID'));this.lookupReference('selectByFloorplan').setActiveItem(b)}},0,0,0,0,['controller.multivistaphoto'],0,[floorplanViewer.view.files.multivistaPhoto,'MultivistaPhotoController'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.SelectByPhotoView',Ext.view.View,{scrollable:!0,groupField:'GroupLabel',groupTpl:"<div class='mds-light-bg-list-header'>{GroupLabel}</div>",tpl:['<tpl for=".">','<div class="photo-category">','<div class="photo thumb"><img src="{ImageURLMedium}"></div>','<div class="title">{Title}</div>','</div>','</tpl>'],itemSelector:'.photo-category',listeners:{'itemclick':'onChoosePhotoCategory'}},0,['selectbyphotoview'],['component','box','dataview','selectbyphotoview'],{'component':!0,'box':!0,'dataview':!0,'selectbyphotoview':!0},['widget.selectbyphotoview'],0,[floorplanViewer.view.files.multivistaPhoto,'SelectByPhotoView'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.SelectByPhoto',Ext.Container,{layout:{type:'card'},items:[{xtype:'panel',layout:{type:'fit'},items:[{xtype:'selectbyphotoview',bind:'{photoCategories}',margin:'0 0 10 10'}]}]},0,['selectbyphoto'],['component','box','container','selectbyphoto'],{'component':!0,'box':!0,'container':!0,'selectbyphoto':!0},['widget.selectbyphoto'],0,[floorplanViewer.view.files.multivistaPhoto,'SelectByPhoto'],0);Ext.cmd.derive('floorplanViewer.view.pushpinFlyout.PushpinFlyoutController',Ext.app.ViewController,{init:function(){var a=this.getViewModel();a.bind('{pushpin}',this.onPushpinLoaded,this);a.bind('{floorplanInitialized}',this.onPushpinLoaded,this);a.bind('{followControlsVisible}',this.onFollowControlsVisibilityChange,this);a.bind('{_photosLoaded}',function(b){if(b){a.set('nPushpinPhotos',a.get('photos').getCount())}},this)},setPushpinFlyoutState:function(c){var a=this.getView(),b=this.getViewModel().get('pushpin');this.recordClone=this.getViewModel().get('pushpin').clone();if(this.newPushpin){c='edit';this.newPushpin=undefined}switch(c){case 'edit':a.setActiveItem(1);var d=this.lookupReference('pushpinShareButton');this.lookupReference('pushpinShareButton').initialize(b.get('ShareTypeID'),b.get('MemberList'));this.lookupReference('pushpinLabelField').setValue(a.title);if(!b.get('IsOwner')){d.disable()};break;default:a.setActiveItem(0);}a.showAt(this.pinCoords)},onPushpinEdit:function(){this.setPushpinFlyoutState('edit')},hidePushpinFlyout:function(){this.getView().hide()},deletePushpin:function(){var a=this.getViewModel().get('pushpin'),b=a.get('PushpinUID');Ext.MessageBox.confirm('Confirm Delete','Are you sure you want to delete this pin? This action cannot be undone. <br> NOTE: Attached photos and files will not be deleted from the system.',function(c){if(c==='yes'){a.erase({success:function(){this.getView().fireEvent('pushpindestroy',b)},scope:this});this.hidePushpinFlyout()}},this)},movePushpin:function(){var a=this.getFloorplanViewer();this.hidePushpinFlyout();this.getView().disable();if(a){a.setFloorplanViewerMode('movePin');a.moveSelectedPushpin();a.lookupController().positionPinMover(new MVLeaflet.LatLng(a.getSelectedPushpin().geometry.coordinates[1],a.getSelectedPushpin().geometry.coordinates[0]))}else {this.getView().fireEvent('movepushpin',this.getViewModel().get('pushpin'))}},savePushpin:function(){var b=this.lookupReference('pushpinLabelField').value;if(b==='(New pushpin)'||b===''){b=' '}var a=this.getViewModel().get('pushpin'),c=this.lookupReference('pushpinShareButton');a.set('PushpinLabel',b);a.set('ShareTypeID',c.getSelectedShareType());a.set('MemberList',c.getSelectedMemberList());if(!a.dirty){this.cancelEditPushpin();this.getView().enable()}else {a.save({success:function(a){this.getView().setTitle(a.get('PushpinLabel'));this.setPushpinFlyoutState('view');this.getView().fireEvent('pushpinupdate',a)},scope:this})}},onPushpinLoaded:function(){var f=this.getFloorplanViewer().getMap();var a=this.getViewModel().get('pushpin');if(!a||!f){return}if(!this.pinCoords){var c=this.getFloorplanViewer().getMap().latLngToContainerPoint(new MVLeaflet.LatLng(a.get('PushpinYCoordinate'),a.get('PushpinXCoordinate')));this.pinCoords=[c.x+25,c.y-25]}this.getViewModel().set('PunchItemID',a.get('PunchItemID'));var e=this.getView(),d=a.get('PushpinLabel'),b=this.getFloorplanViewer();if(d.toString()==''){e.setTitle('(New pushpin)');this.setPushpinFlyoutState('edit')}else {e.setTitle(d)}if(!b||b.lookupController().alreadyLoaded){this.setPushpinFlyoutState('view')}this.getViewModel().set('isPhotos360Enabled',this.getViewModel().get('isPhotos360Enabled'))},cancelEditPushpin:function(){if(this.getViewModel().get('pushpin')){record=this.getViewModel().get('pushpin');record.set('PushpinType',this.recordClone.get('PushpinType'));this.setPushpinFlyoutState('view')}},showPushpinFlyout:function(f,e){var d=this.getView();d.show();d.hide();var b=Ext.getCmp('fvPushpinTabPanelView');if(b){b.setActiveTab(0)}if(e){this.pinCoords=e}else {this.pinCoords=undefined}var a=this.getViewModel();a.set('_recordpushpin',null);a.set('PushpinUID',f.pushpinUID);var c=this.lookupReference('punchItemSummary');if(c){a.notify();c.getViewModel().set('_recordPunchItem',null)}},updatePushpinPosition:function(a){this.getView().enable();var b={pushpinUID:a.PushpinUID};this.showPushpinFlyout(b);this.newPushpin=!0},getFloorplanViewer:function(){var a=this.getView().up('clientFloorplanViewerDisp');return a?a.down('fvFloorplanViewer'):null},cancelPushpin:function(){this.cancelEditPushpin();this.getView().enable()},onFollowersLoad:function(d){var a=this.getViewModel(),c=a.get('account.MemberUID'),b=d.getById(c);if(!b){b=Ext.create('sharedLookup.model.Follower',{MemberUID:c,IsSubscriber:a.get('pushpin.IsSubscriber'),IsCreator:a.get('pushpin.IsOwner'),NoAccess:!1,MemberFirstName:a.get('account.MemberUsername')});d.add(b)}a.set('userFollowerModel',b)},onFollowClick:function(){var c=this.getViewModel(),a=c.get('userFollowerModel'),b=a.get('IsSubscriber');a.set('IsSubscriber',!b)},onFollowControlsVisibilityChange:function(d){var c=this.getViewModel().get('defaultPushpinViewTab'),b=this.getView().down('fvPushpinView'),a=this.lookupReference('pushpinFollowers');if(!a){return}if(d){a.tab.show()}else {b.setActiveTab(c);a.tab.hide()}}},0,0,0,0,['controller.pushpinflyout'],0,[floorplanViewer.view.pushpinFlyout,'PushpinFlyoutController'],0);Ext.cmd.derive('floorplanViewer.view.pushpinFlyout.PushpinFlyoutModel',Ext.app.ViewModel,{config:{mvRecords:{pushpin:{idName:['pushpinID','ProjectUID'],modelName:'mdsData.model.Pushpin'}}},data:{userFollowerModel:null},formulas:{canEditPin:function(a){return a('account.canWrite')&&a('pushpin.IsOwner')},pushpinID:function(a){return a('PushpinUID')},defaultPushpinViewTab:function(a){return 0},followControlsVisible:function(a){return !!(a('project.pushpinAlbumFollowEnabled')&&a('account.canWrite'))},followDisabled:function(a){return !a('project.pushpinAlbumFollowEnabled')||a('pushpin.IsOwner')},isFollower:function(a){return !!a('userFollowerModel.IsFollower')},_triggerLoad:function(a){if(a('PushpinUID')&&a('ProjectUID')){if(a('PushpinUID')==='0000'){return}a('files').load();a('photos').load()}},isPhotos360Enabled:function(a){return a('project.isPhotos360Enabled')}},stores:{files:{type:'files',proxy:{type:'jsonp',api:{create:'/index.cfm?fuseaction=aClientFloorplanViewer.addDocumentsToPushpin',read:'/index.cfm?fuseaction=aClientFloorplanViewer.getPushpinFiles',destroy:'/index.cfm?fuseaction=aClientFloorplanViewer.removeDocumentsFromPushpin'},extraParams:{PushpinUID:'{PushpinUID}',ProjectUID:'{ProjectUID}'}}},photos:{model:'mdsData.model.Photo',proxy:{type:'jsonp',api:{create:'/index.cfm?fuseaction=aClientFloorplanViewer.addPhotosToPushpin',read:'/index.cfm?fuseaction=aClientFloorplanViewer.getPushpinPhotos',destroy:'/index.cfm?fuseaction=aClientFloorplanViewer.removePhotosFromPushpin',zip:'/index.cfm?fuseaction=aClientFloorplanViewer.zipFolderFiles'},extraParams:{PushpinUID:'{PushpinUID}',ProjectUID:'{ProjectUID}'}},mvAutoLoadVars:!0,storeId:'pushPinFlyOutDialogPhotosStore'},followers:{model:'sharedLookup.model.Follower',proxy:{api:{read:'/index.cfm?fuseaction=aClientFloorplanViewer.getPushpinFollowers',update:'/index.cfm?fuseaction=aClientFloorplanViewer.updatePushpinFollowers'},extraParams:{PushpinID:'{PushpinUID}',PushpinUID:'{PushpinUID}',ProjectUID:'{ProjectUID}'}},listeners:{update:function(){this.sync({silentSuccess:!0})},load:'onFollowersLoad'}}}},0,0,0,0,['viewmodel.pushpinflyout'],0,[floorplanViewer.view.pushpinFlyout,'PushpinFlyoutModel'],0);Ext.cmd.derive('floorplanViewer.view.pushpinFlyout.PushpinFlyout',Ext.window.Window,{controller:'pushpinflyout',viewModel:{type:'pushpinflyout'},layout:'card',title:'',anchor:'left',closeAction:'hide',width:341,maxHeight:400,autoHide:!1,constrain:!0,tools:[{xtype:'tool',type:'pushpin-edit',itemId:'pushpinEditTool',localized:{tooltip:'FV_Settings'},width:15,height:15,cls:'pushpin-edit',renderTpl:['<img data-ref="toolEl" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="x-tool-img x-tool-gear" role="presentation">'],listeners:{click:'onPushpinEdit'},bind:{hidden:'{!canEditPin}'}},{xtype:'tool',type:'pushpin-close',localized:{tooltip:'G_Close'},width:15,height:15,cls:'pushpin-close',renderTpl:['<img data-ref="toolEl" src="data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" class="x-tool-img x-tool-close" role="presentation">'],listeners:{click:'hidePushpinFlyout'}}],closable:!1,items:[{xtype:'fvPushpinView'},{xtype:'fvPushpinEdit'}]},0,['fvPushpinFlyout'],['component','box','container','panel','window','fvPushpinFlyout'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'fvPushpinFlyout':!0},['widget.fvPushpinFlyout'],0,[floorplanViewer.view.pushpinFlyout,'PushpinFlyout'],0);Ext.cmd.derive('floorplanViewer.view.floorplanViewer.FloorplanViewerController',Ext.app.ViewController,{hoverTimer:Ext.create('floorplanViewer.controller.HoverTimer'),photoSelectionData:Ext.create('floorplanViewer.PhotoSelectionData'),init:function(){var a=this.getViewModel();a.bind('{floorplan}',this.floorplanLoaded,this);if(app.getName()=='clientFloorplanViewer'){app.addListener('startaddpunchpin',this.onStartAddPunchPin,this)}new Ext.util.KeyMap(Ext.getBody(),[{key:Ext.event.Event.ESC,handler:function(){var b=this.lookupReference('floorplanViewer');if(b.getFloorplanViewerMode().mode!=='view'){b.setFloorplanViewerMode('view');b.loadPushpins(a.get('floorplan'));this.lookupReference('pinPositionDialog').hide();this.cancelPinPosition()}},defaultEventAction:'preventDefault',scope:this}]);app.addListener('photoviewerdestroy',this.onPhotoViewerDestroy,this);app.addListener('pinPositionOffsetXReady',this.setPinPositionOffsetX,this)},floorplanLoaded:function(a){if(!a){return}var b=this.getViewModel();b.set('toggleNumbersEnabled',a.get('overlayInt'));b.set('toggleCommentsEnabled',a.get('commentIcons'))},'map_click':function(){if(this.getView().openPins){this.lookupReference('pushpinFlyout').hide()}},'map_ready':function(i){var f=this.getViewModel(),b=f.get('HotspotID'),c=f.get('PushpinUID'),a=this.lookupReference('floorplanViewer');if(!this.alreadyLoaded){if(b&&b!=0){var g=a.setSelectedHotspot(b);a.getMap().setZoom(2,{animate:!1});a.getMap().panTo({lon:g.geometry.coordinates[0],lat:g.geometry.coordinates[1]});var d={};d.hotspotID=Number(b);d.projectID=a.lookupViewModel().get('floorplan').get('FPID');this.loadHotspotPhotos(d)}if(c&&c!=0){a.setSelectedPushpin(c);var e=a.getSelectedPushpin();if(e.geometry!==undefined){a.getMap().setZoom(2,{animate:!1});a.getMap().panTo({lon:e.geometry.coordinates[0],lat:e.geometry.coordinates[1]});var h={pushpinUID:c};Ext.defer(function(){this.showPushpinFlyout(h);this.alreadyLoaded=!0},500,this)}}else {this.alreadyLoaded=!0}}this.hoverTimer.setMap(a.getMap())},map_move_start:function(){this.lookupReference('pinPositionDialog').hide();if(this.getView().openPins){this.lookupReference('pushpinFlyout').hide()}},'map_move_end':function(){var a=this.lookupReference('floorplanViewer');if(a.getFloorplanViewerMode().mode!=='view'){a.moveSelectedPushpin()}},'pin_mover_move':function(a){this.positionPinMover(a)},'pushpin_click':function(a){if(!this.getView().openPins||!this.lookupReference('pushpinFlyout').isDisabled()){this.floorplanPushpinClick(a)}},'pushpin_mouseover':function(c){if(this.photoSelectionData.photosBeingSelected){return}var a=c.target.feature.properties.PushpinLabel,b=this.lookupReference('floorplanViewer');a=!a||!a.match(/[^\s]+/)?mvstr['FV_No Label']:a;if(b.getFloorplanViewerMode().mode==='view'){this.hoverTimer.openPopup(Ext.bind(function(){(new MVLeaflet.Rrose({offset:new MVLeaflet.Point(0,20),closeButton:!1,autoPan:!1})).setContent(a).setLatLng(c.latlng).openOn(b.getMap())},this),500)}},closeHover:function(){this.hoverTimer.closePopup()},moveSelectedPushpin:function(){this.lookupReference('floorplanViewer').moveSelectedPushpin()},closePopupAndMoveSelectedPushpin:function(){var a=this.lookupReference('floorplanViewer');a.getMap().closePopup();this.moveSelectedPushpin()},'pushpin_new':function(){var a=this.lookupReference('floorplanViewer');if(this.getView().openPins){this.lookupReference('pushpinFlyout').disable()}this.positionPinMover(a.getMap().getCenter());a.getMap().closePopup()},'update_pushpin_position':function(a){this.lookupReference('pushpinFlyout').lookupController().updatePushpinPosition(a)},'hotspot_click':function(b){var a={};a.hotspotID=b.id;a.projectID=this.lookupReference('floorplanViewer').lookupViewModel().get('floorplan').get('FPID');if(b.properties.hotspotType=='hotarea'){var c=b.properties.url,d=Ext.Object.fromQueryString(c.toLowerCase()),e=Ext.Object.getKeys(d)[0];if(e.toLowerCase().indexOf('http')>-1){window.open(c)}else {window.location=c}}else {this.loadHotspotPhotos(a)}if(this.getView().openPins){this.lookupReference('pushpinFlyout').hide()}if(this.lookupReference('floorplanViewer').selectPhotoThumbs){Ext.ComponentQuery.query('multivistaphoto')[0].getViewModel().set('selectedPhotos',null)}},'hotspot_mouseover':function(c){var a=this;var d=c.target.feature,b=c.target.feature.geometry;a.hoverTimer.openPopup(Ext.bind(function(){this.hotspotBubble=(new MVLeaflet.Rrose({offset:new MVLeaflet.Point(0,10),closeButton:!1,autoPan:!1,minWidth:300})).setContent('loading...').setLatLng([b.coordinates[1],b.coordinates[0]]);this.openHotspotBubble(d)},a),a.hoverTimer.mouseover)},'hotspot_mouseout':function(){this.hoverTimer.closePopup(this.hoverTimer.mouseout)},loadHotspotPhotos:function(a){if(this.getView().showPhotoThumbs){this.lookupReference('photoThumbContainer').load(a)}},showPushpinFlyout:function(b){var a=this.lookupReference('pushpinFlyout');if(a){a.lookupController().showPushpinFlyout(b)}},openHotspotBubble:function(c){var a=this;var g=c.id,d=a.lookupReference('floorplanViewer'),b=d.lookupViewModel(),e=d.lookupViewModel().get('ProjectUID');if(a.hoverTimer.getStatus()==a.hoverTimer.TIMER_DISABLED){return}if(d.getFloorplanViewerMode().mode==='view'){if(c.properties.hotspotType==='hotarea'){var f='<div class="photoBubble_outer"><b>'+c.properties.toolTip+'</b></div>';a.hoverTimer.openPopup(Ext.bind(function(){(new MVLeaflet.Rrose({offset:new MVLeaflet.Point(c.properties.width/2,40),closeButton:!1,autoPan:!1})).setContent(f).setLatLng(new MVLeaflet.latLng(c.geometry.coordinates[1],c.geometry.coordinates[0])).openOn(d.getMap())},a),500)}else {mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientFloorplanViewer.viewlastphotoJSON&hotspotID='+g+'&ProjectUID='+e,successCallback:function(f){if(!f.photoID){a.hoverTimer.closePopup();return}if(a.hoverTimer.getStatus()===a.hoverTimer.TIMER_DISABLED){var i=new Ext.XTemplate('<b>mvstr[FV_Photo Number] {HotspotOrder} - {ShootDate:date("DATE_Full")}</b>','<a class="hotspotBubblePV" href="{[this.getPhotoViewerURL(values)]}"><img class="hotspotBubblePV" width="{NewWidth}"  height="{NewHeight}" src="{ImageURL}"></a>','<tpl for="comments">','<div class="hotspotCommentPreview">','<b>{MemberFirstName} {MemberLastName}</b><br>','{CommentEntryDateTime:date("DATE_Full")}<br>','{CommentEntryText}','</div>','</tpl>','<tpl if="commentCount &gt; 3">','<a class="hotspotBubblePV" href="{[this.getPhotoViewerURL(values)]}">View More</a>','</tpl>',{getPhotoViewerURL:function(a){if(b.get('account.features.photoviewerVisible')){return '#'}return mdslink.clientPhotoViewer+'ProjectUID='+e+'&PhotoGroupType=s&ShootUID='+a.ShootUID+'&SelectedPhotoID='+a.photoID}});var g=new Image();g.onload=function(){var e=300;var h=e*(g.height/g.width);f.NewWidth=e;f.NewHeight=h;a.hotspotBubble.setContent(i.apply(f)).openOn(d.getMap());a.hotspotBubble._contentNode.addEventListener('click',function(e){var a=b.get('account.features.photoviewerVisible');var d=e.target.className.indexOf('hotspotBubblePV')>-1;if(a&&d){app.getMainView().add({xtype:'photoviewer',photoId:'P'+f.photoID,photoGroup:Ext.create('floorplanViewer.model.PhotoGroup',{Identifier:b.get('floorplan.ProjectShootTypeUID'),StartDate:f.ShootDate,'Type':'D',Title:b.get('floorplan.ProjectShootTypeDisplayLabel'),Locations:b.get('floorplan.floorplanTitle')?[b.get('floorplan.floorplanTitle')]:[]})}).show()}})};g.src=f.ImageURL}var h=f.photoID;window.openHotspotBubblePhotoID=h},scope:a})}}},positionPinMover:function(c){var a=this.lookupReference('floorplanViewer');if(a.getFloorplanViewerMode().mode=='view'){return}var d=a.getMap(),b=d.latLngToContainerPoint(c),e=b.x-a.pinPositionOffsetX,f=b.y+a.pinPositionOffsetY;this.lookupReference('pinPositionDialog').showAt(e,f)},floorplanPushpinClick:function(a){if(this.getView().openPins){this.showPushpinFlyout({pushpinUID:a.target.feature.id,xMouse:a.originalEvent.x,yMouse:a.originalEvent.y})}},initPhotoSelection:function(f){var a=this.lookupReference('floorplanViewer');this.photoSelectionData.floorplanViewer=a;this.photoSelectionData.map=a.getMap();var h=f&&!this.photoSelectionData.selectionMenuActive;if(h){var c=a.hotspotLayers;for(var b=0;b<c.length;++b){c[b].off('mouseover',a.hotspotMouseOverEvent);c[b].off('mousemove',a.hotspotMouseMoveEvent);c[b].off('mouseout',a.hotspotMouseOutEvent)}var d=this.lookupReference('floorplanViewer').getEl();var g=d.select('.leaflet-clickable');g.setStyle('cursor','crosshair');this.photoSelectionData.selectionMenuActive=!0;d.setStyle('cursor','crosshair');var e=a.getMap();if(e){e.dragging.disable()}this.photoSelectionData.layer=a.getMap().addLayer(a.pushpinSelectionLayer);this.photoSelectionData.enableDragging()}else {this.resetPhotoSelectionMenu()}},resetPhotoSelectionMenu:function(){this.photoSelectionData.removeListeners(!0);if(this.originalMouseCursor!=null){this.lookupReference('floorplanViewer').getEl().setStyle('cursor',this.originalMouseCursor)}var c=this.lookupReference('floorplanViewer');var b=c.hotspotLayers;for(var a=0;a<b.length;++a){b[a].on('mouseover',c.hotspotMouseOverEvent);b[a].on('mousemove',c.hotspotMouseMoveEvent);b[a].on('mouseout',c.hotspotMouseOutEvent)}var g=this.lookupReference('floorplanViewer').getEl();var f=g.select('.leaflet-clickable');f.setStyle('cursor','pointer');var d=this.lookupReference('floorplanViewer').getMap();if(d){d.dragging.enable()}if(this.photoSelectionData.rectangle!=null){this.lookupReference('floorplanViewer').getMap().removeLayer(this.photoSelectionData.rectangle)}this.lookupReference('floorplanViewer').getMap().removeLayer(this.lookupReference('floorplanViewer').pushpinSelectionLayer);this.lookupReference('menuSelect').toggle(!1);this.lookupReference('selectMenu').hide();this.photoSelectionData.selectionMenuActive=!1;this.photoSelectionData.selectionMade=!1;var e=this.lookupReference('selectHotspotsPopup');e.setHtml("<span class='selectedHotspotText'>"+mvstr['FV_Click and drag to sel']+'</span>');this.lookupReference('selectHotspotsViewBtn').disable()},addPushPin:function(d,a){var c=this.lookupReference('floorplanViewer'),b=this.getViewModel();if(!b.get('togglePushpinsEnabled')){c.getMap().addLayer(c.pushpinLayer);b.set('togglePushpinsEnabled',!0)}if(a&&a.WorkStatusID){if(a.WorkStatusID===mdsData.PunchlistValues.WORK_STATUS.NOT_STARTED){b.set('showNotStartedPunchpins',!0)}else {if(a.WorkStatusID===mdsData.PunchlistValues.WORK_STATUS.IN_PROGRESS){b.set('showInProgressPunchpins',!0)}else {if(a.WorkStatusID===mdsData.PunchlistValues.WORK_STATUS.COMPLETE){b.set('showCompletedPunchpins',!0)}else {if(a.WorkStatusID===mdsData.PunchlistValues.WORK_STATUS.ON_HOLD){b.set('showOnHoldPunchpins',!0)}}}}}c.addNewPushpin(d,a)},savePinPosition:function(){this.lookupReference('pinPositionDialog').hide();if(!this.lookupReference('floorplanViewer').hasUnsavedPinLayer){this.lookupReference('floorplanViewer').updatePushpinPosition();this.lookupReference('pushpinFlyout').enable()}else {this.getView().fireEvent('pinsave')}},cancelPinPosition:function(){this.cancelPositionPushpin();if(this.getView().openPins){this.lookupReference('pushpinFlyout').enable()}},onSearchContainerShow:function(){var b=this.lookupReference('floorplanViewer'),c=b.getHotspotsArray(),d=b.getPushpinsArray(),a=[];Ext.Array.forEach(c,function(b){a.push({itemLabel:mvstr['FV_Photo Number {x}'].replace('{x}',b.properties.name),itemType:'hotspot',itemId:b.id})});Ext.Array.forEach(d,function(b){a.push({itemLabel:b.properties.PushpinLabel,itemType:'pushpin',itemId:b.id})});this.hotspotsStore=new Ext.data.Store({fields:[{name:'itemLabel'},{name:'itemType'},{name:'itemId'}],data:a});this.lookupReference('searchCombo').bindStore(this.hotspotsStore)},onSelectSearchPhoto:function(h,f,g){var a=f.getData(),d={},b=this.lookupReference('floorplanViewer');var e=b.getMap();var c=null;if(a.itemType==='hotspot'){d.hotspotID=a.itemId;c=b.setSelectedHotspot(a.itemId);this.loadHotspotPhotos(d)}else {if(a.itemType==='pushpin'){b.setSelectedPushpin(a.itemId);c=b.getSelectedPushpin()}else {console.warn('** Unexpected item type: '+a.itemType);return}}e.setZoom(2,{animate:!1});e.panTo({lon:c.geometry.coordinates[0],lat:c.geometry.coordinates[1]})},toggleNumberVisibility:function(){var b=this.lookupReference('floorplanViewer'),a=b.lookupViewModel();a.set('toggleNumbersEnabled',!a.get('toggleNumbersEnabled'));this.lookupReference('floorplanViewer').toggleTileLayer()},displayBackpackMenuItem:function(c){var b=Ext.ComponentQuery.query('layermenu')[0];var a=b.query('layermenuitem[name="backpackpano"]')[0];a.setVisible(c)},loadBackpackFloorplanLocations:function(b){var a=this;var c=a.lookupReference('floorplanViewer');mdsAjax.doAjaxRequest({url:'/index.cfm?fuseaction=aBackpackPano.getFloorplanLocations&BackpackWalkID='+b,method:'GET',success:function(g){var h=JSON.parse(g.responseText);var f=h.data;for(var d=0;d<f.length;++d){var e=f[d];c.addBackpackPanoMarker(e.Lat,e.Lng,e,a.floorplanWalks[0].WalkName,a.floorplanWalks[0].UrlPrefix,b)}}.bind(a),failure:function(a){console.error(a)}.bind(a)})},toggleBackpackPanoVisibility:function(){var b=function(e){var d=Ext.ComponentQuery.query('layermenu')[0];var c=d.query('layermenuitem');for(var b=0;b<c.length;++b){var a=c[b];if(a.name&&a.name=='backpackpano'){continue}a.setDisabled(!e)}};b();var c=this.lookupReference('floorplanViewer');var a=c.lookupViewModel();var d=a.get('toggleBackpackPanoEnabled');if(!d){c.clearFloorplanLayersForBackpackPanos();this.pushpinsWereVisible=a.get('togglePushpinsEnabled');this.commentsWereVisible=a.get('toggleCommentsEnabled');this.numbersWereVisible=a.get('toggleNumbersEnabled');if(this.pushpinsWereVisible){this.togglePinVisibility()}if(this.commentsWereVisible){this.toggleCommentsVisibility()}if(this.numbersWereVisible){this.toggleNumberVisibility()}b(!1);this.loadBackpackFloorplanLocations(this.floorplanWalks[0].BackpackWalkID)}else {c.resetFloorplanLayersAfterBackpackPanos();if(this.pushpinsWereVisible){this.togglePinVisibility()}if(this.commentsWereVisible){this.toggleCommentsVisibility()}if(this.numbersWereVisible){this.toggleNumberVisibility()}b(!0)}a.set('toggleBackpackPanoEnabled',!d)},backpackMarkerClicked:function(b,e,f,c,a){var d='/index.cfm?fuseaction=aClientPhotoViewer.view&ProjectUID='+c+'&PhotoGroupType=B&backpackWalkID='+a+'&selectedImageID='+b.SphereImageID;window.location=d},togglePinVisibility:function(){var a=this.lookupReference('floorplanViewer'),c=a.lookupViewModel(),b=!c.get('togglePushpinsEnabled');c.set('togglePushpinsEnabled',b);if(!b){a.getMap().removeLayer(a.pushpinLayer)}else {a.getMap().addLayer(a.pushpinLayer)}},togglePanoVisibility:function(){var a=this.lookupReference('floorplanViewer');var c=a.lookupViewModel();var b=!c.get('togglePanosEnabled');c.set('togglePanosEnabled',b);if(b){a.showPanoScanMarkers()}else {a.removePanoScanMarkers()}},toggleCommentsVisibility:function(){var a=this.lookupReference('floorplanViewer'),b=a.lookupViewModel();b.set('toggleCommentsEnabled',!b.get('toggleCommentsEnabled'));if(this._hotspotCommentsVisible){a.getMap().removeLayer(a.hotspotCommentLayer)}else {a.getMap().addLayer(a.hotspotCommentLayer)}this._hotspotCommentsVisible=!this._hotspotCommentsVisible},togglePunchpinVisibility:function(b){var c=this.lookupReference('floorplanViewer'),a=c.lookupViewModel(),d='';a.set(b,!a.get(b));this.updatePunchpinVisibility()},updatePunchpinVisibility:function(){var a=this.lookupReference('floorplanViewer'),b=a.lookupViewModel(),c=a.pushpinLayer.getLayers()[0].getLayers();Ext.Array.forEach(c,function(b){a.getMap().removeLayer(b)});Ext.Array.forEach(c,function(c){var d=c.feature.properties.PushpinType;if(d===9&&b.get('showNotStartedPunchpins')){a.getMap().addLayer(c)}else {if(d===10&&b.get('showInProgressPunchpins')){a.getMap().addLayer(c)}else {if(d===11&&b.get('showCompletedPunchpins')){a.getMap().addLayer(c)}else {if(d===12&&b.get('showOnHoldPunchpins')){a.getMap().addLayer(c)}else {if(d===14&&b.get('showOverduePunchpins')){a.getMap().addLayer(c)}else {if(d===13&&b.get('showClosedPunchpins')){a.getMap().addLayer(c)}}}}}}})},startAddPunchPin:function(){this.getView().add({xtype:'punchlistwindow',renderTo:Ext.getBody(),listeners:{destroy:function(){this.lookupReference('menuAddPushpin').toggle()},scope:this}}).showBy(Ext.getBody(),'c-c')},onStartAddPunchPin:function(a){if(Ext.ComponentQuery.query('photoviewer').length){return}this.addPushPin(a.PushpinTypeID,{PushpinSymbol:a.PushpinSymbol,iconAnchor:mdsData.FloorplanValues.PUNCHPIN_ICON_ANCHOR,PunchItemID:a.PunchItemID,WorkStatusID:a.WorkStatusID?a.WorkStatusID:0,IsNewItem:a.IsNewItem?1:0})},cancelPositionPushpin:function(){var a=this.lookupReference('floorplanViewer');if(a.getFloorplanViewerMode().mode!=='view'){a.setFloorplanViewerMode('view');a.loadPushpins(a.lookupViewModel().get('floorplan'));this.lookupReference('pinPositionDialog').hide()}this.getView().fireEvent('afterpinpositioncancel')},reloadPins:function(){this.lookupReference('floorplanViewer').loadPushpins(this.getViewModel().get('floorplan'))},openPrintFloorplanWindow:function(){var a=Ext.create('floorplanViewer.view.FloorplanExportWindow');a.show();a.on('exportfloorplan',function(d,b,c){var a=Ext.Object.fromQueryString(location.search);var f=mdslink.server+'/index.cfm?fuseaction=aClientFloorplanViewer.floorplanExport2PDF&ProjectUID='+a.ProjectUID+'&FloorplanUID='+a.FloorplanUID;var e={displayHeader:d,displayHotspots:b,displayPushpins:c};Ext.Ajax.postFormData(f,e,{target:'_blank'})})},getExportFileTitle:function(){var a=this.getViewModel();return Ext.Date.format(new Date(),'ymd')+' - Multivista - '+a.get('project.ProjectTitle')+' - '+a.get('floorplanTitle')},openExportWindow:function(a){if(a==='Procore'){this.openExportToProcoreWindow()}else {if(a==='PlanGrid'){this.openExportToPlanGridWindow()}else {if(a==='Aconex'){this.openExportToAconexWindow()}else {if(a==='BIM 360'){this.openBim360Window()}else {if(a==='Bluebeam'){this.openExportToBluebeamWindow()}}}}}},openExportToProcoreWindow:function(){this.getView().add({xtype:'procorewindow-floorplanexport',renderTo:Ext.getBody(),photos:[],attachFloorplanOnly:!0,fileTitle:this.getExportFileTitle()})},openExportToPlanGridWindow:function(){this.getView().add({xtype:'plangridwindow',renderTo:Ext.getBody(),photos:[],attachFloorplanOnly:!0,fileTitle:this.getExportFileTitle()})},openExportToAconexWindow:function(){this.getView().add({xtype:'aconexwindow',renderTo:Ext.getBody(),photos:[],attachFloorplanOnly:!0,fileTitle:this.getExportFileTitle()})},openExportToBluebeamWindow:function(){var a=this.lookupReference('floorplanTitle');var b=a.html;this.getView().add({xtype:'bluebeamwindow',renderTo:Ext.getBody(),photos:[],attachFloorplanOnly:!0,flooplanTitle:b})},openBim360Window:function(){this.getView().add({xtype:'bim360window',renderTo:Ext.getBody(),photos:[],attachFloorplanOnly:!0,fileTitle:this.getExportFileTitle()})},setSelectedMapToolAndMenu:function(a,b){if(this.selectedMapTool!=null&&this.selectedMapTool!=a){this.selectedMapTool.setPressed(!1)}this.selectedMapTool=a;if(this.selectedMapToolMenu!=null&&this.selectedMapToolMenu!=b){this.selectedMapToolMenu.setVisible(!1)}this.selectedMapToolMenu=b},floorplanMapClickHandler:function(){var a=this.lookup('searchCombo');if(a){a.collapse()}if(!this.selectedMapToolMenu||this.selectedMapToolMenu.xtype!='selectmenu'){this.setSelectedMapToolAndMenu(null,null)}},getHotspotPhotoNumber:function(b){var a=b.properties.name;return a},'getHotspotColorsOrIcons':function(c){var b=[];var a=Ext.ComponentQuery.query('#legendImage');if(a.length==0){return}var d=c.features;d.forEach(function(a){if(a.properties.hotspotType=='360pano'){b.push('360')}else {if(a.properties.hotspotType=='m_arrow'){b.push('m_arrow')}else {b.push(a.properties.hotspotArrowColor)}}});b.forEach(function(b){switch(b){case 'green':a[0].down('#green').setConfig({'hidden':!1});break;case 'red':a[0].down('#red').setConfig({'hidden':!1});break;case 'blue':a[0].down('#blue').setConfig({'hidden':!1});break;case 'orange':a[0].down('#orange').setConfig({'hidden':!1});break;case 'pano_green':a[0].down('#pano_green').setConfig({'hidden':!1});break;case 'pano_orange':a[0].down('#pano_orange').setConfig({'hidden':!1});break;case 'mport_green':a[0].down('#pano_green').setConfig({'hidden':!1});break;case 'custom':break;case 'extra_pics':break;case 'down':a[0].down('#down_green').setConfig({'hidden':!1});break;case '360':a[0].down('#photo_360').setConfig({'hidden':!1});break;case 'm_arrow':a[0].down('#m_arrow').setConfig({'hidden':!1});break;default:}})},onPhotoViewerDestroy:function(){this.lookupReference('floorplanViewer').loadHotspots()},setPinPositionOffsetX:function(a){var b=this.lookupReference('floorplanViewer');b.pinPositionOffsetX=a}},0,0,0,0,['controller.floorplanviewer'],0,[floorplanViewer.view.floorplanViewer,'FloorplanViewerController'],0);Ext.cmd.derive('floorplanViewer.view.floorplanViewer.FloorplanViewerModel',Ext.app.ViewModel,{data:{FloorplanUID:'',ProjectUID:'',PushpinUID:'',nPushpinPhotos:0,ListTypeID:'',PunchItemID:null,toggleNumbersEnabled:!0,toggleCommentsEnabled:!0,togglePushpinsEnabled:!0,toggleBackpackPanoEnabled:!1,togglePanosEnabled:!1,hasPanoScanLocations:!1,showNotStartedPunchpins:!0,showInProgressPunchpins:!0,showCompletedPunchpins:!0,showOnHoldPunchpins:!0,showClosedPunchpins:!1,showOverduePunchpins:!0,HotspotID:'',floorplanViewerMode:'view',floorplanInitialized:!1,storeSession:Ext.create('Ext.data.Session')},config:{mvRecords:{floorplan:{idName:['FloorplanUID','ProjectUID'],modelName:'floorplanViewer.model.Floorplan'}}},formulas:{punchpinsEnabled:function(a){return !!a('ListTypeID')},ListTypeName:function(b){var a=b('ListTypeID');return a?mdsData.PunchlistValues.LIST_DESC[a]:''},backToPlansLink:function(a){return mdslink.clientPunchlistPlans+'ListTypeID='+a('ListTypeID')+'&ProjectUID='+a('ProjectUID')},backToPlansText:function(a){return mvstr['TL_Back_to_Plans_'+a('ListTypeID')]},floorplanTitle:function(f){var b=f('floorplan'),e=f('ListTypeName'),d,a,c;if(b){if(b.get){d=b.get('ProjectShootTypeDisplayLabel');a=b.get('floorplanTitle');c=b.get('ProjectShootTypeLabel')}else {if(b.floorplanTitle){a=b.floorplanTitle}}}a=c?a?c+' - '+a:c:a;if(config.ISARCHIVE){return a}if(e){a=e+' - '+a}else {if(d==='Working Plans'){a=d+' - '+a}}return a},objIsPunchItem:function(a){return a('punchpinsEnabled')},pinDescription:function(a){return a('objIsPunchItem')?'Pin':'Pushpin'},_triggerPunchItemsLoad:function(a){if(a('PunchItemID')){a('punchItems').load()}},objectDescription:function(a){return a('objIsPunchItem')?'item':'pushpin'},addingPushpin:function(a){return a('floorplanViewerMode')=='addNewPin'},canSeeMVPhotos:function(a){return a('floorplan.CanHavePhotos')&&a('account.MultivistaContentPermission')},canSeeMVPhotosAndComments:function(a){return a('canSeeMVPhotos')&&a('account.canRead')},canTogglePushpins:function(a){return !a('punchpinsEnabled')&&a('account.canRead')}},stores:{planGridProjects:{model:'planGrid.model.Project',proxy:{url:'/index.cfm?fuseaction=aPlanGrid.getProjects'},autoLoad:!1,listeners:{load:function(a){console.log('PlanGrid projects loaded',a)}}}}},0,0,0,0,['viewmodel.floorplanviewer'],0,[floorplanViewer.view.floorplanViewer,'FloorplanViewerModel'],0);Ext.cmd.derive('floorplanViewer.view.floorplanViewer.FloorplanViewer',Ext.container.Container,{controller:'floorplanviewer',viewModel:{type:'floorplanviewer'},originalMouseCursor:null,showHotspots:!0,showHotspotComments:!0,hasUnsavedPinLayer:!1,showMiniMap:!0,showSelectionLayer:!0,showZoomControls:!0,showHovers:!0,showMapTools:!0,showPhotoThumbs:!0,showTitle:!0,showLegend:!0,openPins:!0,pinPositionOffsetY:164,pinPositionOffsetX:0,animateOptions:null,selectPhotoThumbs:!1,flex:1,layout:{type:'vbox',align:'stretch'},listeners:{boxready:function(){this.setLegendPosition()},resize:function(d,c,b,a){this.setLegendPosition()}},bind:{legendPosition:'{!floorplan.CanHaveHotspots}',mapToolsVisible:'{floorplan}'},setLegendPosition:function(a){if(a||!this.showLegend){return}},setMapToolsVisible:function(a){if(a&&this.showMapTools){this.down('maptoolsmenu').show()}},initComponent:function(){var b=[];var a=this;if(a.openPins){b.push({xtype:'fvPushpinFlyout',reference:'pushpinFlyout',listeners:{close:'cancelEditPushpin',pushpindestroy:'reloadPins',pushpinupdate:'reloadPins'}})}if(a.showLegend){b.push({xtype:'fvLegend',itemId:'legendImage',renderTo:Ext.getBody()})}Ext.Array.push(b,[{xtype:'fvFloorplanViewer',style:'background-color: white',itemId:'floorplanViewer',height:'100%',flex:1,listeners:{map_click:'floorplanMapClickHandler',pinsloaded:function(){this.up('clientFloorplanViewerDisp').fireEvent('pinsloaded')}},showHotspots:this.showHotspots,showHotspotComments:this.showHotspotComments,hasUnsavedPinLayer:this.hasUnsavedPinLayer,showMiniMap:this.showMiniMap,showSelectionLayer:this.showSelectionLayer,showZoomControls:this.showZoomControls,showHovers:this.showHovers,showMapTools:this.showMapTools,openPins:this.openPins,pinPositionOffsetY:this.pinPositionOffsetY,pinPositionOffsetX:this.pinPositionOffsetX,selectPhotoThumbs:this.selectPhotoThumbs,animateOptions:this.animateOptions}]);if(a.showPhotoThumbs){b.push({xtype:'photothumbcontainer',reference:'photoThumbContainer',selectPhotoThumbs:this.selectPhotoThumbs,bind:{hidden:'{!floorplan.CanHavePhotos}'}})}Ext.Array.push(b,[{xtype:'layermenu'},{xtype:'selectmenu',reference:'selectMenu'},{xtype:'pushpinmenu'},{xtype:'exportmenu'},{xtype:'searchcontainer',listeners:{show:'onSearchContainerShow'}},{xtype:'pinpositiondialog',reference:'pinPositionDialog',renderTo:Ext.getBody(),hidden:!0}]);var c={xtype:'container',layout:{type:'hbox',align:'stretch'},flex:1,style:'background-color: grey',items:b};if(a.showMapTools){c.items.push({xtype:'maptoolsmenu',reference:'mapToolsMenu',hidden:!0,bind:{hidden:'{!floorplan}',disabled:'{addingPushpin}'}})}a.items=[];if(a.showTitle){a.items.push({xtype:'floorplanviewertitle'})}a.items.push(c);a.callParent(arguments)}},0,['clientFloorplanViewerDisp'],['component','box','container','clientFloorplanViewerDisp'],{'component':!0,'box':!0,'container':!0,'clientFloorplanViewerDisp':!0},['widget.clientFloorplanViewerDisp'],0,[floorplanViewer.view.floorplanViewer,'FloorplanViewer'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.SelectByFloorplan',Ext.panel.Panel,{layout:{type:'card'},items:[{xtype:'panel',layout:'fit',reference:'floorplanListPage',items:[{xtype:'panel',layout:'fit',items:[{xtype:'floorplanoverview',margin:'0 0 10 10',bind:{store:'{floorplans}'},noLink:!0,scrollable:{x:!1,y:!0},listeners:{itemclick:'onChooseFloorplan'}}]},{reference:'flooplanViewerPage',xtype:'panel',layout:'fit',items:[{xtype:'clientFloorplanViewerDisp',reference:'floorplanViewer',showMiniMap:!1,selectPhotoThumbs:!0,showLegend:!1,viewModel:{data:{_recordfloorplan:null,FloorplanUID:null,_recordpushpin:null,PushpinUID:null,ListTypeID:0,HidePushpins:!0}}}]}]}]},0,['selectbyfloorplan'],['component','box','container','panel','selectbyfloorplan'],{'component':!0,'box':!0,'container':!0,'panel':!0,'selectbyfloorplan':!0},['widget.selectbyfloorplan'],0,[floorplanViewer.view.files.multivistaPhoto,'SelectByFloorplan'],0);Ext.cmd.derive('floorplanViewer.view.files.multivistaPhoto.MultivistaPhoto',Ext.Panel,{controller:'multivistaphoto',viewModel:{type:'multivistaphoto'},tbar:{ui:'white',padding:'0 20 10 10',reference:'multivistaPhotoTBar',items:[{xtype:'combo',valueField:'value',editable:!1,localized:{fieldLabel:'FVCPD_Selection Mode'},labelSeparator:'',labelAlign:'top',reference:'selectionModeCombo',bind:{store:'{selectionMode}',value:'{activeSelectionMode}'},listeners:{change:'onSelectionModeChange'},margin:'25 10 0 0'},{xtype:'combo',localized:{fieldLabel:'FVCPD_Progression'},labelSeparator:'',labelAlign:'top',reference:'progressionCombo',editable:!1,cls:'combo-empty-black',bind:{hidden:'{!selectByShootTypeEnabled}'},listeners:{change:'onProgressionChange'}},'->',{xtype:'dateselectorwrapper',reference:'dateSelectorWrapper',selectorConfig:{cls:'combo-empty-black',localized:{fieldLabel:'FVCPD_Date'},labelSeparator:'',labelAlign:'top',width:170,bind:{hidden:'{!photoFilterEnabled}'}},margin:'0 10 0 0'},{xtype:'combo',reference:'locationsCombo',queryMode:'local',localized:{fieldLabel:'FVCPD_Location',defaultValue:'FVCPD_All Locations'},labelSeparator:'',labelAlign:'top',editable:!1,displayField:'Location',valueField:'Location',bind:{hidden:'{!photoFilterEnabled}'},listeners:{change:'onLocationChange'}}]},fbar:{xtype:'choosephotofbar',reference:'multivistaPhotoFBar',backButtonConf:{hidden:!0,reference:'mvPhotoBackBtn',bind:{hidden:'{hideFooterButtons}'},listeners:{click:'mvPhotoBackBtnClick'}},addPhotosButtonConf:{hidden:!0,reference:'mvPhotoAddBtn',bind:{hidden:'{hideFooterButtons}'},listeners:{click:'addPhotos'}}},layout:{type:'card'},items:[{xtype:'selectbyphoto',reference:'selectByPhoto'},{xtype:'selectbyfloorplan',reference:'selectByFloorplan'}],bind:{activeItem:'{selectionModeCombo.selection.value}',cls:'photo-list size-{thumbSize}'},setCls:function(a){if(!this.el){this.addListener('afterrender',Ext.bind(this.setCls,this,[a]),this,{single:!0});return}if(this.cls){this.el.removeCls(this.cls)}this.cls=a;this.el.addCls(this.cls)}},0,['multivistaphoto'],['component','box','container','panel','multivistaphoto'],{'component':!0,'box':!0,'container':!0,'panel':!0,'multivistaphoto':!0},['widget.multivistaphoto'],0,[floorplanViewer.view.files.multivistaPhoto,'MultivistaPhoto'],0);Ext.cmd.derive('floorplanViewer.view.files.photoFileViewer.PhotoFileViewerModel',Ext.app.ViewModel,{data:{Identifier:'',Type:'U',itemDesc:'photo',itemDescPlural:'photos',nFiles:0},stores:{projectPhotoCategories:{type:'tree',model:'files.model.PhotoCategory',proxy:{type:'jsonp',url:'index.cfm?fuseaction=aClientPhotoList.getPushpinDialogTree',extraParams:{ProjectUID:'{ProjectUID}'}},autoLoad:!1,root:{text:'All Photos',expanded:!0,loaded:!1,type:'X',id:'X',cls:'photoCategoryRoot'}}}},0,0,0,0,['viewmodel.photofileviewer'],0,[floorplanViewer.view.files.photoFileViewer,'PhotoFileViewerModel'],0);Ext.cmd.derive('floorplanViewer.view.files.photoFileViewer.PhotoFileViewer',floorplanViewer.view.files.BaseViewer,{viewModel:{type:'photofileviewer',formulas:{viewHeight:{bind:{_photosDataChanged:'{_photosDataChanged}',photos:'{photos}'},get:function(a){return a.photos.getCount()?370:104}}}},height:370,bind:{height:'{viewHeight}'},controller:'fileviewer',localized:{title:'FV_Photos'},layout:'fit',scrollable:{x:!1,y:!0},listView:{xtype:'photofilelist'},addButton:{xtype:'button',localized:{text:'SP_Add Photo'},ui:'orange'},addDownloadAllButton:{xtype:'button',localized:{text:'FV_Download All'},reference:'zipPhotos',itemId:'downloadAllButton',ui:'plain',iconCls:'icon-download-all',iconAlign:'right',listeners:{click:'onZipFilesClick'},bind:{hidden:'{!nFiles}'}},showDownloadButton:!0,tbarTitle:'',initComponent:function(){this.addButton.itemId='openPhotoUpload';this.addButton.listeners={click:'openFileUpload'};this.addButton.bind=this.addButton.bind||{};if(!this.addButton.bind.hidden){this.addButton.bind.hidden='{!account.canWrite}'}this.listView.reference='fileList';this.listView.listeners={itemclick:'onFileItemClick',beforerender:'onListViewRender'};this.tbar={items:['->',this.addButton]};if(!!this.config.includeBBar){this.bbar={items:['->',this.addDownloadAllButton]}}this.items=[this.listView];if(this.ui){this.tbar.ui=this.ui}if(this.showDownloadButton&&!config.ISARCHIVE){this.tbar.items.unshift({xtype:'button',localized:{text:'FV_Images'},id:'imagesButton',ui:'plain',toggleGroup:'images360Toggle',listeners:{click:'onImagesButtonClick',afterrender:'onButtonsRendered'},toggleHandler:'onButtonToggled'},{xtype:'tbseparator',cls:'floorplanSpecific'},{xtype:'button',text:'360',id:'images360Button',ui:'plain',toggleGroup:'images360Toggle',listeners:{click:'on360ButtonClick',afterrender:'onButtonsRendered'},toggleHandler:'onButtonToggled',bind:{hidden:'{!isPhotos360Enabled}'}})}if(this.tbarTitle){this.tbar.items.unshift({xtype:'component',cls:'x-panel-header-title-detail-form',html:this.tbarTitle})}floorplanViewer.view.files.BaseViewer.prototype.initComponent.apply(this,arguments)},repositionFloatingItems:Ext.emptyFn},0,['photofileviewer'],['component','box','container','panel','photofileviewer'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photofileviewer':!0},['widget.photofileviewer'],0,[floorplanViewer.view.files.photoFileViewer,'PhotoFileViewer'],0);Ext.cmd.derive('floorplanViewer.view.punchlistLocation.Floorplan',floorplanViewer.view.floorplanViewer.FloorplanViewer,{showHotspots:!1,hasUnsavedPinLayer:!0,showMiniMap:!1,showSelectionLayer:!1,showHovers:!1,showMapTools:!1,showPhotoThumbs:!1,showTitle:!1,showLegend:!1,openPins:!1,pinPositionOffsetY:37},0,['plFloorPlan'],['component','box','container','clientFloorplanViewerDisp','plFloorPlan'],{'component':!0,'box':!0,'container':!0,'clientFloorplanViewerDisp':!0,'plFloorPlan':!0},['widget.plFloorPlan'],0,[floorplanViewer.view.punchlistLocation,'Floorplan'],0);Ext.cmd.derive('photoActions.Msg',Ext.window.Window,{ui:'msgbox',buttonUi:{ok:'orange',yes:'orange',no:'orange',cancel:'grey',action:'green'},alwaysOnTop:2,OK:1,YES:2,NO:4,CANCEL:8,OKCANCEL:9,YESNO:6,YESNOCANCEL:14,ACTION:16,CANCELACTION:24,INFO:'x-message-box-info',WARNING:'x-message-box-warning',QUESTION:'x-message-box-question',ERROR:'x-message-box-error',hideMode:'offsets',closeAction:'hide',resizable:!1,scrollable:!0,title:'&#160;',defaultMinWidth:250,defaultMaxWidth:600,defaultMinHeight:110,defaultMaxHeight:500,minWidth:null,maxWidth:null,minHeight:null,maxHeight:null,constrain:!0,cls:['x-message-box','x-hidden-offsets'],layout:{type:'vbox',align:'stretch'},shrinkWrapDock:!0,defaultTextHeight:75,minProgressWidth:250,minPromptWidth:250,buttonText:{ok:'OK',yes:'Yes',no:'No',cancel:'Cancel',action:'Go'},buttonIds:['ok','yes','no','cancel','action'],titleText:{confirm:'Confirm',prompt:'Prompt',wait:'Loading...',alert:'Attention'},baseIconCls:'x-message-box-icon',ariaRole:'alertdialog',makeButton:function(b){var a=this.buttonIds[b];return new Ext.button.Button({handler:this.btnCallback,itemId:a,scope:this,text:this.buttonText[a],ui:this.buttonUi[a],margin:'0 10 0 10',height:27,minWidth:57})},btnCallback:function(e,b){var a=this,d,c;if(b&&b.type==='keydown'&&!b.isSpecialKey()){b.getTarget(null,null,!0).on({keyup:function(c){a.btnCallback(e,c)},single:!0});return}if(a.cfg.prompt||a.cfg.multiline){if(a.cfg.multiline){c=a.textArea}else {c=a.textField}d=c.getValue();c.reset()}a.hide();a.userCallback(e.itemId,d,a.cfg)},hide:function(){var a=this,b=a.cfg?a.cfg.cls:'';a.progressBar.reset();if(b){a.removeCls(b)}Ext.window.Window.prototype.hide.apply(this,arguments)},constructor:function(b){var a=this;Ext.window.Window.prototype.constructor.apply(this,arguments);a.minWidth=a.defaultMinWidth=a.minWidth||a.defaultMinWidth;a.maxWidth=a.defaultMaxWidth=a.maxWidth||a.defaultMaxWidth;a.minHeight=a.defaultMinHeight=a.minHeight||a.defaultMinHeight;a.maxHeight=a.defaultMaxHeight=a.maxHeight||a.defaultMaxHeight},initComponent:function(e){var a=this,b=a.id,d,c;a.title=a.title||'&#160;';a.iconCls=a.iconCls||'';a.topContainer=new Ext.container.Container({layout:'hbox',padding:10,style:{overflow:'hidden'},items:[a.iconComponent=new Ext.Component({cls:a.baseIconCls}),a.promptContainer=new Ext.container.Container({flex:1,layout:{type:'vbox',align:'stretch'},items:[a.msg=new Ext.Component({id:b+'-msg',cls:a.baseCls+'-text'}),a.textField=new Ext.form.field.Text({id:b+'-textfield',enableKeyEvents:!0,ariaAttributes:{'aria-labelledby':a.msg.id},listeners:{keydown:a.onPromptKey,scope:a}}),a.textArea=new Ext.form.field.TextArea({id:b+'-textarea',height:75,ariaAttributes:{'aria-labelledby':a.msg.id}})]})]});a.progressBar=new Ext.ProgressBar({id:b+'-progressbar',margin:'0 10 10 10'});a.items=[a.topContainer,a.progressBar];a.msgButtons=[];for(d=0;d<5;d++){c=a.makeButton(d);a.msgButtons[c.itemId]=c;a.msgButtons.push(c)}a.bottomTb=new Ext.toolbar.Toolbar({id:b+'-toolbar',ui:'footer',dock:'bottom',enableFocusableContainer:!1,ariaRole:null,layout:{pack:'center'},items:[a.msgButtons[0],a.msgButtons[1],a.msgButtons[2],a.msgButtons[3],a.msgButtons[4]]});a.dockedItems=[a.bottomTb];a.on('close',a.onClose,a);Ext.window.Window.prototype.initComponent.apply(this,arguments)},afterRender:function(){var a=this;Ext.window.Window.prototype.afterRender.apply(this,arguments);a.textField.labelEl.dom.removeAttribute('for');a.textArea.labelEl.dom.removeAttribute('for')},onClose:function(){var a=this.msgButtons[3];if(a){this.btnCallback(a)}},onPromptKey:function(c,b){var a=this;if(b.keyCode===b.RETURN||b.keyCode===10){if(a.msgButtons.ok.isVisible()){a.msgButtons.ok.handler.call(a,a.msgButtons.ok)}else {if(a.msgButtons.yes.isVisible()){a.msgButtons.yes.handler.call(a,a.msgButtons.yes)}}}},reconfigure:function(b){var a=this,k=0,s=!0,w=a.buttonText,g=a.resizer,c=a.header,u=c&&!c.isHeader,v=b&&(b.message||b.msg),t=b.buttonTips,p,n,i,q,o,e,d,f,l,j,m,h,r;a.updateButtonText();a.cfg=b=b||{};h=b.wait;if(b.width){q=b.width}if(b.height){o=b.height}a.minWidth=b.minWidth||a.defaultMinWidth;a.maxWidth=b.maxWidth||a.defaultMaxWidth;a.minHeight=b.minHeight||a.defaultMinHeight;a.maxHeight=b.maxHeight||a.defaultMaxHeight;if('maskClickAction' in b){a.maskClickAction=b.maskClickAction}else {delete a.maskClickAction}if(g){i=g.resizeTracker;g.minWidth=i.minWidth=a.minWidth;g.maxWidth=i.maxWidth=a.maxWidth;g.minHeight=i.minHeight=a.minHeight;g.maxHeight=i.maxHeight=a.maxHeight}delete a.defaultFocus;if(b.defaultFocus){a.defaultFocus=b.defaultFocus}a.animateTarget=b.animateTarget||undefined;a.modal=b.modal!==!1;if(b.title!=null){p=b.title}else {if(u&&c.title!=null){p=c.title}else {p=a.title}}if(b.iconCls!=null){n=b.iconCls}else {if(u&&c.iconCls!=null){n=c.iconCls}else {n=a.iconCls}}a.setTitle(p);a.setIconCls(n);if(Ext.isObject(b.buttons)){a.buttonText=b.buttons;k=0}else {a.buttonText=b.buttonText||a.buttonText;k=Ext.isNumber(b.buttons)?b.buttons:0}Ext.each(a.buttonIds,function(c){a.msgButtons[c].setTooltip(t&&t[c]||null)});k=k|a.updateButtonText();a.buttonText=w;Ext.suspendLayouts();a.width=a.height=null;if(q||o){if(q){a.setWidth(q)}if(o){a.setHeight(o)}}if(!a.rendered){a.render(Ext.getBody())}a.closable=b.closable!==!1&&!h;c=a.header;if(c){r=c.child('[type=close]');if(r){r.setVisible(a.closable)}if(!b.title&&!a.closable&&!b.iconCls){c.hide()}else {c.show()}}a.liveDrag=!b.proxyDrag;a.userCallback=Ext.Function.bindCallback(b.callback||b.fn||Ext.emptyFn,b.scope||Ext.global);a.setIcon(b.icon);l=a.msg;if(v){l.setHtml(v);l.show();a.ariaEl.dom.setAttribute('aria-describedby',l.id)}else {l.hide();a.ariaEl.dom.removeAttribute('aria-describedby')}d=a.textArea;f=a.textField;if(b.prompt||b.multiline){a.multiline=b.multiline;if(b.multiline){d.setValue(b.value);d.setHeight(b.defaultTextHeight||a.defaultTextHeight);d.show();f.hide();a.defaultFocus=d}else {f.setValue(b.value);d.hide();f.show();a.defaultFocus=f}a.ariaEl.dom.removeAttribute('aria-describedby')}else {d.hide();f.hide()}j=a.progressBar;if(b.progress||h){j.show();a.updateProgress(0,b.progressText);a.defaultFocus=j;if(h){j.wait(h===!0?b.waitConfig:h)}}else {j.hide()}m=a.msgButtons;for(e=0;e<5;e++){if(k&Math.pow(2,e)){if(!a.defaultFocus){a.defaultFocus=m[e]}m[e].show();s=!1}else {m[e].hide()}}if(s){a.bottomTb.hide()}else {a.bottomTb.show()}if(b.transparentModal){this.modalMaskCls='modal-transparent';if(this.zIndexManager.mask){this.zIndexManager.mask.addCls('modal-transparent')}}else {this.modalMaskCls='dark-mask';if(this.zIndexManager.mask){this.zIndexManager.mask.removeCls('modal-transparent')}}Ext.resumeLayouts(!0)},updateButtonText:function(){var b=this,c=b.buttonText,e=0,a,d;for(a in c){if(c.hasOwnProperty(a)){d=b.msgButtons[a];if(d){if(b.cfg&&b.cfg.buttonText){e=e|Math.pow(2,Ext.Array.indexOf(b.buttonIds,a))}if(d.text!==c[a]){d.setText(c[a])}}}}return e},show:function(a){a=a||{};if(a.icon=='warning'){this.addCls('left-align')}else {this.removeCls('left-align')}var b=this,c;a=a||{};if(Ext.Component.layoutSuspendCount){Ext.on({resumelayouts:function(){b.show(a)},single:!0});return b}b.reconfigure(a);if(a.cls){b.addCls(a.cls)}c=b.query('textfield:not([hidden]),textarea:not([hidden]),button:not([hidden])');b.preventFocusOnActivate=!c.length;Ext.window.Window.prototype.show.call(this);return b},onShow:function(){Ext.window.Window.prototype.onShow.apply(this,arguments);this.center()},updateText:function(a){this.msg.setHtml(a)},setIcon:function(e,d,c){var b=this,a=b.iconComponent,f=b.messageIconCls;if(f){a.removeCls(f)}if(e){a.show();if(d||c){a.setSize(d||a.getWidth(),c||a.getHeight())}a.addCls('x-dlg-icon');a.addCls(b.messageIconCls=e)}else {a.removeCls('x-dlg-icon');a.hide()}return b},updateProgress:function(c,b,a){this.progressBar.updateProgress(c,b);if(a){this.updateText(a)}return this},onEsc:function(){if(this.closable!==!1){Ext.window.Window.prototype.onEsc.apply(this,arguments)}},confirm:function(a,b,d,c){if(Ext.isString(a)){a={title:a,icon:this.QUESTION,message:b,buttons:this.YESNO,callback:d,scope:c}}return this.show(a)},prompt:function(a,c,f,d,b,e){if(Ext.isString(a)){a={prompt:!0,title:a,minWidth:this.minPromptWidth,message:c,buttons:this.OKCANCEL,callback:f,scope:d,multiline:b,value:e}}return this.show(a)},wait:function(a,c,b){if(Ext.isString(a)){a={title:c,message:a,closable:!1,wait:!0,modal:!0,minWidth:this.minProgressWidth,waitConfig:b}}return this.show(a)},alert:function(a,b,d,c){if(Ext.isString(a)){a={title:a,message:b,buttons:this.OK,fn:d,scope:c,minWidth:this.minWidth}}return this.show(a)},progress:function(a,c,b){if(Ext.isString(a)){a={title:a,message:c,progress:!0,progressText:b}}return this.show(a)}},1,['mdsmessagebox'],['component','box','container','panel','window','mdsmessagebox'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'mdsmessagebox':!0},['widget.mdsmessagebox'],0,[photoActions,'Msg'],function(a){Ext.onInternalReady(function(){Ext.namespace('MDS');MDS.Msg=new a()})});Ext.cmd.derive('photoActions.view.widget.PrintSelectionWindow',Ext.window.Window,{id:'printSelectionWindow',config:{action:'print'},localized:{title:'PUL_Select Export Layout'},modal:!0,modalMaskCls:'dark-mask',resizable:!1,layout:{type:'hbox',pack:'stretch'},closeAction:'hide',defaults:{xtype:'panel',layout:{type:'vbox',align:'center'},style:'cursor: pointer'},alwaysOnTop:2,items:[{localized:{title:'PUL_Photo Only'},items:[{xtype:'label',localized:{text:'PUL_Photo with caption'},margin:10},{xtype:'image',src:'mds/image/pdftype_standard.png',width:274,height:265,margin:'0 10px 10px 10px'}]},{localized:{title:'PUL_Photo & Info'},items:[{xtype:'label',localized:{text:'PUL_Siteplan / Floorplan '},margin:10},{xtype:'image',src:'mds/image/pdftype_4view.png',width:247,height:265,margin:'0 0 10px 0'}]}],listeners:{afterrender:function(a){a.items.getAt(0).el.addListener('click',function(){a.fireEvent('choosetype','standard',a)});a.items.getAt(1).el.addListener('click',function(){a.fireEvent('choosetype','4view',a)})}}},0,0,['component','box','container','panel','window'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0},0,0,[photoActions.view.widget,'PrintSelectionWindow'],0);Ext.cmd.derive('photoActions.model.Album',Ext.data.Model,{fields:[{name:'AlbumUID',type:'string',defaultValue:''},{name:'AlbumName',type:'string'},{name:'AlbumDescription',type:'string',defaultValue:''},{name:'photos',type:'auto',defaultValue:[]},{name:'ShareTypeID',type:'int',defaultValue:1},{name:'MemberArray',type:'auto',defaultValue:[]},{name:'IsSystemAlbum',type:'boolean'},{name:'IsFavouritesAlbum',type:'boolean'},{name:'IsUserAlbum',type:'boolean'}],idProperty:'AlbumUID',proxy:{api:{create:'/index.cfm?fuseaction=aClientPhotoList.createAlbum',update:'/index.cfm?fuseaction=aClientPhotoList.updateAlbum'},writer:{writeAllFields:!0}}},0,0,0,0,0,0,[photoActions.model,'Album'],0);Ext.cmd.derive('photoActions.view.widget.CreateAlbumWindow',Ext.window.Window,{id:'createAlbumWindow',title:'Album Settings',layout:{type:'vbox',align:'stretch'},modal:!0,modalMaskCls:'dark-mask',closeAction:'destroy',bodyPadding:5,defaults:{labelWidth:110},items:[{id:'newAlbumName',itemId:'albumName',xtype:'textfield',fieldLabel:'Album Name',allowBlank:!1,maxLength:255,enforceMaxLength:!0,width:380},{id:'newAlbumDescription',itemId:'albumDescription',xtype:'textareafield',fieldLabel:'Album Description',maxLength:255,enforceMaxLength:!0,width:380},{xtype:'container',layout:'hbox',margin:'10 0 10 0',items:[{xtype:'component',html:'Sharing Settings:',margin:'2 20 0 0'},{xtype:'shareWithButton',id:'shareWithButton',fieldLabel:'Sharing Settings'}]},{xtype:'container',layout:{type:'hbox',align:'stretch'},margin:'5 0 0 0',items:[{id:'deleteAlbumAction',xtype:'button',text:'Delete Album',icon:'mds/image/icon/delete.png',hidden:!0},{xtype:'tbfill'},{id:'saveNewAlbumAction',xtype:'button',text:'Save',icon:'mds/image/icon/disk_blue.png'}]}],constructor:function(a){Ext.window.Window.prototype.constructor.apply(this,arguments);var b={'Object Type':'Album','Context':'Album Settings Dialog (New Album)'};if(a&&a.album){b['Context']='Album Settings Dialog (Existing Album)';this.down('#albumName').setValue(a.album.get('AlbumName'));this.down('#albumDescription').setValue(a.album.get('AlbumDescription'));this.down('shareWithButton').initialize(a.album.get('ShareTypeID'),a.album.get('MemberArray'))}analytics.Ctrl.setOptionalDefaultEventProperties(b)}},1,['createAlbumWindow'],['component','box','container','panel','window','createAlbumWindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'createAlbumWindow':!0},['widget.createAlbumWindow'],0,[photoActions.view.widget,'CreateAlbumWindow'],0);Ext.cmd.derive('photoActions.view.photosettings.PhotoSettingsModel',Ext.app.ViewModel,{data:{saving:!1,saveDone:!1,_photoDate:-1,shareSettingsDirty:!1},formulas:{photoDate:{get:function(b){var a=b('_photoDate');if(a!=-1){return a}return b('initialDate')},set:function(a){this.set('_photoDate',a)}},initialDate:function(f){var a=f('selectedPhotos'),c=a.getCount();if(!c){return null}var d=a.getAt(0).get('PhotoDate');for(var b=1;b<c;b++){var e=a.getAt(b).get('PhotoDate');if(!Ext.Date.isEqual(d,e)){return null}}return d},dateEntryOK:function(a){if(!a('dateEntry.dirty')){return !0}return a('dateEntry.valid')},hasChanges:function(a){return !!(a('dateEntry.dirty')||a('shareSettingsDirty'))},canSave:function(a){return a('hasChanges')&&a('dateEntryOK')}}},0,0,0,0,['viewmodel.photosettings'],0,[photoActions.view.photosettings,'PhotoSettingsModel'],0);Ext.cmd.derive('photoActions.view.photosettings.PhotoSettingsController',Ext.app.ViewController,{config:{initialShareTypeID:null,initialMemberUIDList:null},init:function(){analytics.Ctrl.setOptionalDefaultEventProperties({'Object Type':'Photo','Context':'Edit Date and Sharing Dialog'});var a=this.getViewModel().bind('{selectedPhotos}',function(b){if(!b){return}var f=b.getCount();if(!f){return}var d=b.getAt(0).get('ShareTypeID'),e=b.getAt(0).get('MemberUIDs')||[];for(var c=1;c<f;c++){var g=b.getAt(c).get('ShareTypeID');if(g!=d){d=-1}var h=b.getAt(c).get('MemberUIDs')||[];if(!Ext.Array.equals(Ext.Array.sort(e),Ext.Array.sort(h))){e=[]}}this.setInitialShareTypeID(d);this.setInitialMemberUIDList(e.join(','));a.destroy()},this)},updateInitialShareTypeID:function(a){this.lookupReference('shareWithButton').getViewModel().set('initialShareTypeID',a)},updateInitialMemberUIDList:function(a){this.lookupReference('shareWithButton').getViewModel().set('initalShareMemberList',a)},onShareTypeSelectionChange:function(b){var c=b.selectedShareType,a=b.selectedMemberList;a=a||'';a=Ext.Array.sort(a.split(','));this.getViewModel().set('shareSettingsDirty',!!(c!=this.getInitialShareTypeID()||a!=this.getInitialMemberUIDList()))},save:function(){var b=this.getViewModel(),a={},d={};if(b.get('shareSettingsDirty')){var g=this.lookupReference('shareWithButton'),c=g.getSelectedMemberArray();a.ShareTypeID=g.getSelectedShareType();if(a.ShareTypeID==3){a.MemberUIDs=Ext.encode(c)}else {c=[]}d=permissions.Values.getPermissionEventProperties(a.ShareTypeID);if(c.length){d['Member UIDs']=c.join(',')}}var f=this.lookupReference('dateEntry').getDate();if(b.get('dateEntry.dirty')){a.UDEFPhotoDate=Ext.Date.format(f,'Y-m-d');d['Date']=analytics.Ctrl.getDateString(f)}var e=[];b.get('selectedPhotos').each(function(a){e.push(a.get('Identifier'))});a.UDEFPhotoUIDs=Ext.encode(e);analytics.Ctrl.log('Confirmed Photo Properties',d);b.set('saving',!0);Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoList.updatePhotos',params:a,successCallback:function(){b.set('saveDone',!0);this.getView().fireEvent('changedphotos',{date:a.UDEFPhotoDate?f:null,photoIdentifiers:e,ShareTypeID:a.ShareTypeID,MemberUIDs:a.ShareTypeID?c:null});Ext.defer(function(){var a=this.getView();if(a){a.destroy()}},1000,this)},afterFailMessageCallback:function(c,a){b.set('saving',!1);b.set('errorMessage',a?a:mvstr.G_UnexpectedError)},scope:this})}},0,0,0,0,['controller.photosettings'],0,[photoActions.view.photosettings,'PhotoSettingsController'],0);Ext.cmd.derive('photoActions.view.photosettings.PhotoSettings',Ext.window.Window,{viewModel:{type:'photosettings'},controller:'photosettings',ui:'orange',cls:'photo-actions-window',title:'Edit Date and Sharing',modal:!0,padding:'28 20 24 20',width:426,height:336,layout:{type:'hbox'},items:[{xtype:'container',height:'100%',width:230,layout:{type:'vbox'},items:[{xtype:'component',cls:'instructions',html:"<b>Set a new date</b><br/><div>This will make the date of the photos you've selected the same.</div>",width:230,margin:'0 0 30 0'},{xtype:'textdate',margin:'0 0 45 0',reference:'dateEntry',bind:{date:'{photoDate}',initialDate:'{initialDate}'}},{xtype:'container',layout:{type:'hbox'},items:[{xtype:'component',html:'<b>Share Settings</b>',padding:'2 0 0 0'},{xtype:'shareWithButton',reference:'shareWithButton',menuUi:'white',ui:'plain',margin:'0 0 0 25',listeners:{selectionChange:'onShareTypeSelectionChange'}}],width:230}]},{xtype:'container',width:154,items:[{xtype:'photoselectionthumb'}]}],dockedItems:[{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},padding:'25 0 0 0',items:[{xtype:'button',scale:'medium',ui:'grey',text:'Cancel',margin:'0 12 0 12',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',bind:{processing:'{saving}',done:'{saveDone}',disabled:'{!canSave}'},margin:'0 12 0 12',listeners:{click:'save'}}]}]},0,['photosettings'],['component','box','container','panel','window','photosettings'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'photosettings':!0},['widget.photosettings'],0,[photoActions.view.photosettings,'PhotoSettings'],0);Ext.cmd.derive('photoActions.controller.ToolbarActions',Ext.app.Controller,{MAXSAVEDPHOTOS:Infinity,MAXEXPORTPHOTOS:25,MAXPRINTPHOTOS:Infinity,MAXDIRECTEXPORTPHOTOS:10,MAXDIRECTSAVEPHOTOS:10,MAXINTEGRATIONPHOTOS:10,statics:{PHOTOSPERPDF:100,PHOTOSPERZIP:1000,getTimeEstimate:function(f){var b=Math.floor(f/3600),a=Math.ceil((f-b*3600)/60),c='',d='',e=[];if(a==1){c='1 min'}if(a>1&&a!=60){c=a+' mins'}if(a==60){b++}if(b==1){d='1 hr'}if(b>1){d=b+' hrs'}if(d){e.push(d)}if(c){e.push(c)}return e.join(' ')},doEmailPDF:function(e,b){var a=mvstr['PA_The photo export PDF ']+'<br><br>'+mvstr['PA_Estimated time']+': ',c=photoActions.controller.ToolbarActions.PHOTOSPERPDF;if(b.photos&&b.photos.length>c){var d=Math.ceil(b.photos.length/c);a=mvstr['PA_The photo export PDFs']+'<br>'+mvstr['PA_Because a high number'].replace('{x}',d)+'<br><br>'+mvstr['PA_Estimated time']+': '}if(b.photos){b.photos=b.photos.join(',')}Ext.Ajax.request({url:e,jsonData:b,successCallback:function(c){var f=photoActions.controller.ToolbarActions.getTimeEstimate(c.TotalTimeEstimate);if(c.AlreadyExists){a=mvstr['PA_Please wait for your ']+'<br><br>'+mvstr['PA_Estimated time for al']+': '+f}else {a=a+f}if(d>1){a+='<br><i>'+mvstr['PA_BatchDelayWarning']+'</i>'}else {if(c.Priority>1){a+='<br><i>'+mvstr['PA_QueueDelayWarning']+'</i>'}}photoActions.controller.ToolbarActions.showOrangeMessage(mvstr['PA_Emailing Large Photo '],a)}})},doEmailZip:function(e,b){var a=mvstr['PA_The photos will be em']+'<br><br>'+mvstr['PA_Estimated time']+': ',c=photoActions.controller.ToolbarActions.PHOTOSPERZIP;if(b.photos&&b.photos.length>c){var d=Math.ceil(b.photos.length/c);a=mvstr['PA_The photos will be em']+'<br>'+mvstr['PA_LargeZIPMessage'].replace('{x}',d)+'<br><br>'+mvstr['PA_Estimated time']+': '}if(b.photos){b.photos=b.photos.join(',')}Ext.Ajax.request({url:e,jsonData:b,successCallback:function(c){if(c.AlreadyExists){a=mvstr['PA_Please wait for your ']+'<br><br>'+mvstr['PA_Estimated time for al']+': '+photoActions.controller.ToolbarActions.getTimeEstimate(c.TotalTimeEstimate)}else {a=a+photoActions.controller.ToolbarActions.getTimeEstimate(c.TotalTimeEstimate)}if(d>1){a+='<br><i>'+mvstr['PA_BatchDelayWarning']+'</i>'}else {if(c.Priority>1){a+='<br><i>'+mvstr['PA_QueueDelayWarning']+'</i>'}}photoActions.controller.ToolbarActions.showOrangeMessage(mvstr['PA_EmailPhotoZIP'],a)}})},showOrangeMessage:function(d,c,b,a){b=b||{ok:Ext.Msg.buttonText.ok};a=a||1;Ext.Msg.show({title:d,message:c,buttonText:b,buttons:a})},showLimitMessage:function(b,d,a){var c=d-a;Ext.Msg.alert(mvstr['PA_Limit Exceeded'],mvstr['PA_Limit_'+b].replace('{x}',a)+' Please remove '+c+' photos and try again.')}},init:function(){this.control({'#emailPhotosAction':{click:function(){var b=this.interfaceControl.getSelectedPhotoIDs();var a=b.length;if(a>this.MAXEXPORTPHOTOS){this.self.showLimitMessage('email',a,this.MAXEXPORTPHOTOS);return}this.getExportWindow('email').show()}},'#printPhotosAction':{click:function(){var c=this.interfaceControl.getSelectedPhotoIDs();var a=c.length;if(a>this.MAXPRINTPHOTOS){this.self.showLimitMessage('print',a,this.MAXPRINTPHOTOS);return}var b=this.getExportWindow('print');b.show()}},'#printSelectionWindow':{choosetype:function(e,b){var f=this.interfaceControl.getSelectedPhotoIDs();var c=this.getSnapshotType();var d=b.action;b.hide();if(c){var a={};if(c=='360Pano'){a.PhotoID=f[0];var g=this.interfaceControl.getPannellumViewerAngle();if(Ext.isNumber(g)){a.FOVAngle=g}}this.saveSnapshotToUDEF('',function(c,f){if(c){this.performPrintAction(d,e,f,a)}}.bind(this))}else {this.performPrintAction(d,e,f)}}},'#viewPhotosAction':{click:function(){Ext.Ajax.postFormData(mdslink.clientPhotoViewer+'ProjectUID='+this.getView().getViewModel().get('ProjectUID')+'&PhotoGroupType=X',{PhotoIDs:this.interfaceControl.getPhotoIDsByType('P').join(','),UDEFPhotoUIDs:this.interfaceControl.getPhotoIDsByType('U').join(','),WebcamPhotoUIDs:this.interfaceControl.getPhotoIDsByType('W').join(',')})}},'#saveToAlbumAction':{click:function(){if(!this.checkSnapshotMaxPhotos('save')){return}var a=this.getViewport().lookupViewModel().get('account.features.photoviewerVisible');if(this.interfaceControl.albumStore.hasNonSystemAlbums()){if(a){this.getViewport().add({xtype:'photovieweralbumadd',store:this.interfaceControl.albumStore}).show()}else {var b=this.getViewport().add({xtype:'addphotostoalbum',store:this.interfaceControl.albumStore});b.show()}}else {if(a){this.getViewport().add({xtype:'photovieweralbumadd',store:this.interfaceControl.albumStore}).show()}else {this.makeAlbum()}}}},'#saveNewAlbumAction':{click:function(){if(this.albumSettingsAreValid()){this.saveAlbum()}}},'#shareWithButton':{selectionChange:function(a){this.interfaceControl.editAlbum.set('MemberArray',a.selectedMemberList?a.selectedMemberList.split(','):[]);this.interfaceControl.editAlbum.set('ShareTypeID',a.selectedShareType)}},'#saveToComputerAction':{click:function(){if(!this.checkSnapshotMaxPhotos('save')){return}var a=this.savePhotoToComputer.bind(this);if(this.isWebcamLiveStream()){this.interfaceControl.saveWebcamStreamSnapshot(a)}else {if(this.isInteriorPano()){this.interfaceControl.saveInteriorPanoSnapshotToComputer(a)}else {if(this.is360Pano()){this.interfaceControl.save360PanoSnapshotToComputer(a)}else {this.interfaceControl.getSelectedPhotoIDs(a)}}}}},'#saveTimelapseAction':{click:function(){var b=this.interfaceControl.getViewModel(),a=b.get('activeTimelapse');if(!a){return}Ext.Ajax.postFormData(mdslink.server+'/index.cfm?fuseaction=aClientWebcam.saveTimelapse',{ProjectUID:b.get('ProjectUID'),PhotoGroupType:'W',WebcamUID:a.get('WebcamUID'),ArchivePositionID:a.get('ArchivePositionID')})}},'#saveMenu [cls="add-to-list-report-action"]':{click:this.onAddToListReportClick},'#procoreButton':{click:function(){this.openIntegrationWindow('procorewindow')}},'#aconexButton':{click:function(){this.openIntegrationWindow('aconexwindow')}},'#planGridButton':{click:function(){this.openIntegrationWindow('plangridwindow')}},'#bim360Button':{click:function(){this.openIntegrationWindow('bim360window')}},'#bluebeamButton':{click:function(){this.openIntegrationWindow('bluebeamwindow')}},'#addCommentAction':{click:'openAddComment'},'#editDateAndSharingAction':{click:function(){this.openPhotoSettings()}},'#deleteAction':{click:function(){this.deletePhotosWithCheck()}},'#photoListSettings':{click:function(){this.openAlbumSettings(this.interfaceControl.getOpenAlbum())}}});app.addListener('startaddphototopunchitem',this.savePhotosToPunchItem,this);app.addListener('startaddpunchpin',function(){if(!this.isInteriorPano()&&!this.is360Pano()){Ext.Msg.alert(mvstr['G_Success'],mvstr['G_SuccessMsgShort'])}},this);app.addListener('savingnewpunchitem',this.savingNewPunchItem,this);app.addListener('savednewpunchitem',this.savedNewPunchItem,this)},checkSnapshotMaxPhotos:function(e){if(!this.canSnapshot()||this.isWebcamLiveStream()){return !0}var d=this.interfaceControl.getActivePhoto(),a=this.interfaceControl.getSelectedPhotos(),c=!1;for(var b=0;b<a.length;b++){if(a[b].get('CanSnapshot')){c=!0;break}}if(c){if(a.length>1){Ext.Msg.alert(mvstr['PA_Limit Exceeded'],mvstr['PA_Limit1_'+e]);return !1}if(a[0].getId()!=d.getId()){Ext.Msg.alert(mvstr['PA_Photo Selection'],mvstr['PA_Please view the selec']);return !1}}return !0},performPrintAction:function(d,c,a,e){var b=this.getView().getViewModel().get('ProjectUID');if(d=='print'){if(this.interfaceControl.print){this.interfaceControl.print(c,a,this.MAXDIRECTEXPORTPHOTOS)}else {if(c=='4view'){if(a.length<=this.MAXDIRECTEXPORTPHOTOS){Ext.Ajax.postFormData('/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+b,{photos:a},{target:'_blank'})}else {photoActions.controller.ToolbarActions.doEmailPDF('/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+b,{photos:a})}}else {if(a.length<=this.MAXDIRECTEXPORTPHOTOS){Ext.Ajax.postFormData('/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+b+'&forcePhotoOnly=true',{photos:a},{target:'_blank'})}else {photoActions.controller.ToolbarActions.doEmailPDF('/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+b+'&forcePhotoOnly=true',{photos:a})}}}this.logAnalyticsEvent('Printed Photos',a)}else {if(d=='email'){this.requestEmailExport(c,a,e);this.logAnalyticsEvent('Emailed Photos',a)}}},requestEmailExport:function(k,j,i){var f=this,d=this.getView().getViewModel().get('PushpinUID'),g=this.interfaceControl.getSelectedPhotos(),b=g[0],c=b.get('title'),h=f.getViewport().getViewModel().get('project.ProjectTitle'),a=h,e=b.get('Type');if(c){if(e=='P'){a=a+' - '+c.replace(/ - Photo \d+$/,'')}else {if(e=='W'){a=a+' - '+c.replace(b.get('DescLine3'),Ext.Date.format(b.get('PhotoDate'),'M d Y'))}else {a=a+' - '+mvstr['PAE_Photo Export']+' - '+Ext.Date.format(b.get('PhotoDate'),'M d Y')}}}else {a=mvstr['PAE_Multivista Photo Expo']}a=encodeURIComponent(a);Ext.Ajax.request({useDefaults:!0,url:'/index.cfm?fuseaction=aClientPhotoList.requestEmailExport',params:{ProjectUID:this.getView().getViewModel().get('ProjectUID'),PushpinUID:d?d:'',photos:j,Photo360:Ext.JSON.encode(i),type:k},successCallback:function(b){f.continueEmailExport(this.params.ProjectUID,this.params.PushpinUID,b.photoExportID,this.params.photos,this.params.type,this.params.Photo360);photoActions.controller.ToolbarActions.showOrangeMessage(mvstr['PAE_Export Successful!'],mvstr['PAE_Your image may be vie']+': <br/><br/><a href="'+b.URL+'" target="_blank">'+b.URL+'</a><br/><br/><a href="mailto:?body=Dear%20Colleague,%0A%0AThis%20link%20will%20take%20you%20to%20a%20photo%20of%20our%20project%20currently%20under%20construction:%0A%0A'+b.URL+'&subject='+a+'" target="_blank">'+mvstr['PAE_Click here to send th']+'</a>')}})},continueEmailExport:function(b,c,a,e,f,d){Ext.Ajax.request({url:'/index.cfm',params:{fuseaction:'aClientPhotoList.continueEmailExport',ProjectUID:b,PushpinUID:c,photoExportID:a,photos:e,Photo360:d,type:f}})},getExportWindow:function(b){var a=Ext.getCmp('printSelectionWindow');if(!a){a=Ext.create('photoActions.view.widget.PrintSelectionWindow',{action:b})}else {a.action=b}return a},isWebcamLiveStream:function(){return !!this.interfaceControl.getViewModel().get('activeStream')},isInteriorPano:function(){return this.interfaceControl.isInteriorPano?this.interfaceControl.isInteriorPano():!1},is360Pano:function(){return this.interfaceControl.is360Pano?this.interfaceControl.is360Pano():!1},getSnapshotType:function(){if(this.isInteriorPano()){return 'InteriorPano'}if(this.is360Pano()){return '360Pano'}return ''},saveSnapshotToUDEF:function(a,b){var c=this.getSnapshotType();this.turnLoadingOn(mvstr['PA_Saving snapshot...']);this.interfaceControl['save'+c+'SnapshotToUDEF'](a||'',function(f,c){this.turnLoadingOff();var d;if(f&&c&&c.PhotoID>0){d=['U'+c.PhotoID]}else {var e=Ext.isString(c)?c:mvstr['PA_Error saving snapshot'];Ext.Msg.alert(mvstr['G_Error'],e);d=e}b(f,d)}.bind(this))},makeAlbum:function(b){var c=Ext.getCmp('addPhotosToAlbumWindow');if(c){c.destroy()}var a=this;var d=function(e){var c={};c.photos=e;if(b){c.AlbumUID=b}a.interfaceControl.editAlbum=Ext.create('photoActions.model.Album',c);var d=a.getViewport().lookupViewModel().get('account.features.photoviewerVisible');if(!b){if(d){if(a.albumSettingsAreValid()){a.saveAlbum()}}else {a.getViewport().add({xtype:'createAlbumWindow'}).show()}}else {a.saveAlbum()}};a.interfaceControl.getSelectedPhotoIDs(d)},albumSettingsAreValid:function(){if(!Ext.getCmp('newAlbumName').isValid()){Ext.Msg.alert(mvstr['PA_Invalid Input'],mvstr['PA_Please enter a valid ']);return !1}this.interfaceControl.editAlbum.set('AlbumName',Ext.getCmp('newAlbumName').value);if(Ext.getCmp('newAlbumDescription')){this.interfaceControl.editAlbum.set('AlbumDescription',Ext.getCmp('newAlbumDescription').value)}return !0},saveAlbum:function(){var a=this,b=Ext.getCmp('createAlbumWindow')||Ext.ComponentQuery.query('photovieweralbumadd')[0];if(b){this.turnLoadingOn(mvstr['G_Saving ...'],b)}if(this.interfaceControl.editAlbum.phantom){var c=a.getViewport().getViewModel(),d=c.get('selectedShareMemberUIDList');this.interfaceControl.editAlbum.set('ShareTypeID',c.get('account.canShare')?c.get('selectedShareTypeID'):2);this.interfaceControl.editAlbum.set('MemberArray',d?d.split(','):[])}var e=this.isInteriorPano();var g=this.is360Pano();if(e||g){this.interfaceControl.editAlbum.set('photos',[])}var h=this.interfaceControl.editAlbum.get('photos');var f=this.interfaceControl.editAlbum.phantom;this.interfaceControl.editAlbum.getProxy().setExtraParams({ProjectUID:this.getViewport().getViewModel().get('ProjectUID')});this.interfaceControl.editAlbum.save({success:function(d,i,c){if(b){a.turnLoadingOff(b)}var g=c.AlbumUID?c.AlbumUID:a.interfaceControl.editAlbum.get('AlbumUID');if(a.getSnapshotType()){a.saveSnapshotToUDEF(g,function(b){a.albumSaved(g,d,c,b)})}else {a.albumSaved(c.AlbumUID,d,c,!0)}if(b){b.destroy()}var e=Ext.getCmp('addPhotosToAlbumWindow');if(e){e.destroy()}a.logAnalyticsEvent(f?'Saved Photos to New Album':'Saved Photos to Existing Album',h,{'Album UID':d.get('AlbumUID'),'Album Name':d.get('AlbumName')})},afterFailMessageCallback:function(){if(b){a.turnLoadingOff(b)}}})},albumSaved:function(d,a,e,g){var b,c;if(d){a.set('AlbumUID',d);this.getApplication().fireEvent('newalbum',a,e);b=mvstr['PA_Album was successfull'];c=mvstr['PA_Album created']}else {var f=this.mainView.getViewModel().get('account.canShare');b=mvstr['PA_AlbumUpdatedMsg'];c=mvstr['PA_Album updated'];if(!f){if(a.get('ShareTypeID')!=2){b=mvstr['GSS_This user account can'];c=mvstr['GSS_Sharing not changed']}a.set('ShareTypeID',2)}this.getApplication().fireEvent('updatedalbum',a,e)}if(g){this.showAddPhotosConfirm(d,b,c)}if(this.interfaceControl.albumStore){this.interfaceControl.albumStore.load()}},showAddPhotosConfirm:function(a,e,b){b=b||' ';var c={ok:mvstr['PA_View Album'],cancel:Ext.Msg.buttonText.ok},d=Ext.MessageBox.OKCANCEL;if(!a){c={cancel:Ext.Msg.buttonText.ok};d=Ext.MessageBox.CANCEL}Ext.MessageBox.show({title:b,msg:e,buttons:d,buttonText:c,fn:Ext.bind(function(d){if(d=='ok'){var c=this.getViewport().lookupViewModel().get('account.features.photoviewerVisible');if(c&&this.interfaceControl.openNewAlbumInViewer){this.interfaceControl.openNewAlbumInViewer(a)}else {document.location=mdslink.clientPhotoViewer+'ProjectUID='+this.getView().getViewModel().get('ProjectUID')+'&PhotoGroupType=A&AlbumUID='+a}}},this)})},getView:function(){var a=Ext.ComponentQuery.query('photoviewer')[0];if(!a){a=Ext.ComponentQuery.query('clientPhotoViewer')[0]}if(!a){a=Ext.ComponentQuery.query("component[xtype^='clientWebcamLive']")[0]}if(!a){a=Ext.ComponentQuery.query('clientPhotoList')[0]}return a},getViewport:function(){var a=Ext.ComponentQuery.query('clientviewport')[0];if(!a){a=this.getView()}if(!a){a=this.mainView}return a},onAddToListReportClick:function(e){var f=this.interfaceControl.getSelectedPhotos(),a=e.ListTypeID,b=this.getSnapshotType();if(b){if(this.checkSnapshotMaxPhotos('save')){delete this.panoPhotoRecord;this.turnLoadingOn(mvstr['PA_Taking snapshot...']);var d=Ext.bind(this.interfaceControl['take'+b+'SnapshotForPunchlist'],this.interfaceControl);d(function(d,b,c){this.turnLoadingOff();if(d){this.panoPhotoRecord=Ext.create('viewerPhoto.model.Photo',{med:b,dateTaken:new Date(),panoUuid:c});this.showAddToPunchlistWindow(a,[this.panoPhotoRecord])}else {Ext.Msg.alert(mvstr['G_Error'],b)}}.bind(this))}}else {if(this.isWebcamLiveStream()){var c=Ext.bind(this.interfaceControl.saveWebcamStreamSnapshot,this.interfaceControl);c(function(b){this.showAddToPunchlistWindow(a,[b]);this.interfaceControl.getViewModel().set('webcamStreamSnapshot',b)}.bind(this),!0)}else {this.showAddToPunchlistWindow(a,f)}}},showAddToPunchlistWindow:function(a,b){this.getView().add({xtype:'punchlistwindow',renderTo:Ext.getBody(),photos:b,viewModel:{data:{ListTypeID:a,onPhotoPage:!0}}}).showBy(Ext.getBody(),'c-c?')},savingNewPunchItem:function(a){if(this.isInteriorPano()){a.remove(a.getNewRecords())}},savedNewPunchItem:function(a){if(this.isInteriorPano()){this.savePanoUDEFPhotoThenAddToPunchItem(a)}else {if(this.is360Pano()){this.save360PanoUDEFPhotoThenAddToPunchItem(a)}}},savePanoUDEFPhotoThenAddToPunchItem:function(a){var b={base64Photo:this.panoPhotoRecord.get('med'),PanoUUID:this.panoPhotoRecord.get('panoUuid')};Ext.getBody().mask(mvstr['PA_Saving snapshot...']);this.interfaceControl.saveBase64ToUDEFPhoto(b,function(e,b){Ext.getBody().unmask();if(e&&b&&b.PhotoID>0){var d='U'+b.PhotoID;this.savePhotoIdsToPunchItem(a,d)}else {var c=Ext.isString(b)?b:mvstr['PA_Error saving snapshot'];Ext.Msg.alert(mvstr['G_Error'],c)}}.bind(this));delete this.panoPhotoRecord},save360PanoUDEFPhotoThenAddToPunchItem:function(a){var b={base64Photo:this.panoPhotoRecord.get('med'),PanoUUID:this.panoPhotoRecord.get('panoUuid')};Ext.getBody().mask(mvstr['PA_Saving snapshot...']);this.interfaceControl.saveBase64ToUDEFPhoto(b,function(e,b){Ext.getBody().unmask();if(e&&b&&b.PhotoID>0){var d='U'+b.PhotoID;this.savePhotoIdsToPunchItem(a,d)}else {var c=Ext.isString(b)?b:mvstr['PA_Error saving snapshot'];Ext.Msg.alert(mvstr['G_Error'],c)}}.bind(this));delete this.panoPhotoRecord},savePhotosToPunchItem:function(a){if(this.isInteriorPano()){this.savePanoUDEFPhotoThenAddToPunchItem(a.PunchItemID)}else {if(this.is360Pano()){this.save360PanoUDEFPhotoThenAddToPunchItem(a.PunchItemID)}else {if(this.isWebcamLiveStream()){var b=this.interfaceControl.getViewModel().get('webcamStreamSnapshot');this.savePhotoIdsToPunchItem(a.PunchItemID,b.get('id'))}else {this.savePhotoIdsToPunchItem(a.PunchItemID,this.interfaceControl.getSelectedPhotoIDs().join(','))}}}},savePhotoIdsToPunchItem:function(b,a){console.log('Saving photo ids to punch item',a);Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPunchlist.addPhotosToPunchItem',jsonData:{PunchItemID:b,ProjectUID:this.getView().getViewModel().get('ProjectUID'),Photos:a},successCallback:function(){Ext.Msg.alert(mvstr['G_Success'],mvstr['G_SuccessMsgShort'])}})},openIntegrationWindow:function(a){if(!this.checkSnapshotMaxPhotos('export')){return}this.getSelectedPhotoIDs().then(Ext.bind(function(d){var f=d.length;if(f>this.MAXINTEGRATIONPHOTOS){this.self.showLimitMessage('export',f,this.MAXINTEGRATIONPHOTOS);return}var g=this.getView(),e=this.getViewport().getViewModel().get('annoProps.toggledOn'),c={xtype:a,renderTo:Ext.getBody(),photos:d,includeAnnotations:e===null?!0:e,PushpinUID:this.getView().getViewModel().get('PushpinUID'),datePhoto:null},b=this.interfaceControl.getSelectedPhotos();if(b.length==1&&b[0].get('Type')=='W'&&b[0].get('PhotoDate')){c.PhotoDate=b[0].get('PhotoDate')}else {if(b.length==1&&b[0].get('Is360Pano')){c.datePhoto=b[0];if(b[0].get('Type')==='P'){c.Photo360ID=Number(b[0].getId())}}}g.add(c)},this))},savePhotosToAlbums:function(a,h,e){var c=a?a.join(','):'';var b=[];if(a.length<1){Ext.Msg.alert(mvstr['G_Error'],mvstr['PA_No album selected.']);return}if(a&&a.length&&this.interfaceControl.albumStore){for(var d=0;d<a.length;d++){var i=a[d];var f=this.interfaceControl.albumStore.getById(i);if(f){b.push(f.get('AlbumName'))}}}b=b.join(',');if(this.getSnapshotType()){h.destroy();var g=(new Date()).getTime();this.saveSnapshotToUDEF(c,Ext.bind(function(d,f){if(d){if(a.length===1){this.showAddPhotosConfirm(a[0],mvstr['PA_The photo was success'],mvstr['PA_Photo added'])}else {Ext.Msg.alert('',mvstr['PA_AddedToAlbums'].replace('{x}',a.length))}console.log('Saved snapshot, took '+((new Date()).getTime()-g)+' ms');this.logAnalyticsEvent('Saved Photos to Existing Album',f,{'Album UIDs':c,'Album Names':b})}},this))}else {if(this.isWebcamLiveStream()){this.interfaceControl.saveWebcamStreamSnapshot(e)}else {this.interfaceControl.getSelectedPhotoIDs(function(d){e(d);this.logAnalyticsEvent('Saved Photos to Existing Album',d,{'Album UIDs':c,'Album Names':b})}.bind(this))}}},logAnalyticsEvent:function(c,b,a){if(Ext.isArray(b)){b=b.join(', ')}if(this.isInteriorPano()){if(!a){a={}}a['Site Walk 360']=!0}if(this.interfaceControl.$className=='clientPhotoListNew.view.main.MainController'){analytics.Ctrl.log(c,Ext.apply({'Photo List':b},a),['Photo Action Element'])}else {analytics.Ctrl.log(c,Ext.apply({'Photo List':b,'Photo Action Element':'Photo Viewer Menu'},a))}},openAddComment:function(){var a=this.interfaceControl.getViewModel().get('selectedPhotos').getRange(),b=a.length;if(b>comments.view.batchaddcomment.AddCommentController.MAX_PHOTOS){photoActions.controller.ToolbarActions.showLimitMessage('comment',b,comments.view.batchaddcomment.AddCommentController.MAX_PHOTOS);return}this.getView().add({xtype:'batchaddcomment',listeners:{changedphotos:{fn:function(c){for(var b=0;b<a.length;b++){a[b].set('CommentCount',a[b].get('CommentCount')+1)}if(this.interfaceControl.onBatchAddComments){this.interfaceControl.onBatchAddComments(a)}if(this.interfaceControl.onSelectedPhotosChange){this.interfaceControl.onSelectedPhotosChange()}},scope:this}}}).show()},openPhotoSettings:function(){var a=this.interfaceControl.getViewModel().get('selectedPhotos').getRange();this.getView().add({xtype:'photosettings',listeners:{changedphotos:{fn:function(b){if(this.interfaceControl.reloadPhotosAfterGroupChange){this.interfaceControl.reloadPhotosAfterGroupChange(b)}for(var c=0;c<a.length;c++){if(b.date){a[c].set('PhotoDate',b.date)}if(b.ShareTypeID){a[c].set('ShareTypeID',b.ShareTypeID)}if(b.MemberUIDs){a[c].set('MemberUIDs',b.MemberUIDs)}}if(this.interfaceControl.onSelectedPhotosChange){this.interfaceControl.onSelectedPhotosChange()}},scope:this}}}).show()},deletePhotosWithCheck:function(){var c=this.interfaceControl.getViewModel().get('selectedPhotos'),d=c.getCount(),b=!1;for(var a=0;a<d;a++){if(!c.getAt(a).get('IsOwnedByUser')){b=!0;break}}if(b){MDS.Msg.show({xtype:'mmvmsgbox',title:mvstr['PA_Delete Photos'],message:'<b>'+mvstr["PA_Some photos you've se"]+'</b><br/>'+mvstr['PA_You are only able to '],buttonText:{action:mvstr['PA_Delete Photos'],cancel:mvstr['G_Cancel']},icon:'warning',maxWidth:435,fn:function(a){if(a=='action'){this.deletePhotosNoCheck()}},scope:this,transparentModal:!0})}else {this.deletePhotosNoCheck()}},deletePhotosNoCheck:function(){var a=[],b=this.interfaceControl.getViewModel().get('selectedPhotos');b.each(function(b){if(b.get('Type')=='U'&&b.get('IsOwnedByUser')){a.push(b.getId())}});analytics.Ctrl.log('Deleted Photos',{},['Photo List','Photo Action Element']);Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoList.deletePhotos',params:{UDEFPhotoUIDs:Ext.encode(a)},successCallback:function(b){if(b.UDEFPhotoUIDs.length!=a.length){if(b.UDEFPhotoUIDs.length&&b.UDEFPhotoUIDs.length<a.length){Ext.Msg.alert(mvstr['G_Warning'],mvstr['PA_Not all photos could '])}else {Ext.Msg.alert(mvstr['G_Error'],mvstr['PA_No photos could be de']);return}}if(this.interfaceControl.onPhotosDeleted){this.interfaceControl.onPhotosDeleted(b)}if(this.interfaceControl.onSelectedPhotosChange){this.interfaceControl.onSelectedPhotosChange()}if(this.interfaceControl.reloadPhotosAfterGroupChange){this.interfaceControl.reloadPhotosAfterGroupChange({photoIdentifiers:a,remove:!0})}},scope:this})},openAlbumSettings:function(a){var b=a.get('memberList');this.interfaceControl.editAlbum=a.$className=='clientPhotoListNew.model.PhotoCategory'?Ext.create('photoActions.model.Album',{AlbumUID:a.get('Identifier'),AlbumName:a.get('rawText'),AlbumDescription:a.get('description'),ShareTypeID:a.get('ShareTypeID'),MemberArray:b?b.split(','):[]}):a;var c=this.getView().add({xtype:'plcreateAlbumWindow',album:this.interfaceControl.editAlbum});c.show();if(this.interfaceControl.$className=='clientPhotoListNew.view.main.MainController'){Ext.getCmp('deleteAlbumAction').show()}},savePhotoToComputer:function(a,f){var c=a.length,e=this.getView()||this.getViewport(),b=e.getViewModel().get('ProjectUID'),d=e.getViewModel().get('activeStream');if(c>this.MAXSAVEDPHOTOS){this.self.showLimitMessage('download',c,this.MAXSAVEDPHOTOS);return}if(c>this.MAXDIRECTSAVEPHOTOS){photoActions.controller.ToolbarActions.doEmailZip('/index.cfm?fuseaction=aClientPhotoList.savePhotos&ProjectUID='+b,{photos:a})}else {if(d||app.getName().indexOf('WebcamLive')!==-1){var g=this.interfaceControl.WebcamUID||d.WebcamUID;Ext.Ajax.postFormData('/index.cfm?fuseaction=aClientPhotoViewer.downloadCurrentImage',{id:a,projectUID:b,webcamUID:g})}else {Ext.Ajax.postFormData(mdslink.server+'/index.cfm?fuseaction=aClientPhotoList.savePhotos',{photos:a,base64Photo:f,ProjectUID:b})}}this.logAnalyticsEvent('Save Photos To Computer',a)},saveSinglePhoto:function(b){var a=this.savePhotoToComputer.bind(this);if(this.isInteriorPano()){this.interfaceControl.saveInteriorPanoSnapshotToComputer(a,[b])}else {a([b])}},turnLoadingOn:function(b,a){if(this.getView().xtype=='photoviewer'){a=a||this.getView();a.setLoading(!0)}else {a=a||Ext.getBody();a.mask(b)}},turnLoadingOff:function(a){if(this.getView().xtype=='photoviewer'){a=a||this.getView();a.setLoading(!1)}else {a=a||Ext.getBody();a.unmask()}},getSelectedPhotoIDs:function(){return new Ext.Promise(Ext.bind(function(a,c){var b=this.getSnapshotType();if(b){this.saveSnapshotToUDEF('',Ext.bind(function(b,d){if(b){a(d)}else {c()}},this))}else {a(this.interfaceControl.getSelectedPhotoIDs())}},this))},canSnapshot:function(){return this.interfaceControl.canSnapshot}},0,0,0,0,0,0,[photoActions.controller,'ToolbarActions'],0);Ext.cmd.derive('photoActions.store.Albums',Ext.data.Store,{model:'photoActions.model.Album',proxy:{type:'ajax',url:'/index.cfm?fuseaction=aClientPhotoViewer.getAccessibleAlbums',reader:{type:'json'}},filters:[{property:'IsSystemAlbum',value:!1},function(b){var a=Ext.Object.fromQueryString(document.location.search).AlbumUID;return a&&a==b.get('AlbumUID')?!1:!0}],hasNonSystemAlbums:function(){return this.count()?!0:!1},doInit:function(a,b){var c=a.getRange();this.account=b;this.addRecords(c);a.addListener('add',function(d,c){this.addRecords(c)},this)},addRecords:function(b){var c=this.account.canShare;for(var a=0;a<b.length;a++){if(b[a].parentNode.get('value')=='My Albums'||c&&b[a].parentNode.get('value')=='Project Team Albums'){this.add({AlbumUID:b[a].get('id'),AlbumName:b[a].get('value'),IsSystemAlbum:b[a].get('type')=='S',IsFavouritesAlbum:b[a].get('type')=='S'&&b[a].get('value')=='My Favorites',IsUserAlbum:b[a].parentNode.get('value')=='My Albums'})}}this.loadCount++},reinit:function(a){this.removeAll();this.doInit(a,this.account)}},0,0,0,0,['store.albums'],0,[photoActions.store,'Albums'],0);Ext.cmd.derive('photoActions.view.IntegrationMenuItemDark',Ext.menu.Item,{cls:'save-button',localized:{text:'PUL_Export'},iconCls:'',iconAlign:'left',menuAlign:'tr-tl?',config:{menu:{xtype:'menu',cls:'photo-actions-menu',ui:'dark2',itemId:'integrationMenu',showSeparator:!1,shadow:!1,items:[{itemId:'procoreButton',cls:'has-icon procore',icon:'mds/image/icon/procore_white.png',text:'Procore',bind:{hidden:'{!account.procoreEnabled}'}},{itemId:'planGridButton',cls:'has-icon plangrid',icon:'mds/image/icon/plangrid_white.png',text:'PlanGrid',hidden:!0,bind:{hidden:'{!account.planGridEnabled}'}},{itemId:'aconexButton',cls:'has-icon',icon:'mds/image/icon/aconex_white.png',text:'Aconex',bind:{hidden:'{!account.aconexEnabled}'}},{itemId:'bim360Button',cls:'has-icon bim360',icon:'mds/image/icon/bim360_white.png',text:'BIM 360',hidden:!0,bind:{hidden:'{!account.bim360Enabled}'}},{itemId:'bluebeamButton',cls:'has-icon',icon:'mds/image/icon/bluebeam_white.png',text:'Bluebeam',bind:{hidden:'{!account.bluebeamEnabled}'}}],scrollable:!1}}},0,['integrationmenuitemdark'],['component','box','menuitem','integrationmenuitemdark'],{'component':!0,'box':!0,'menuitem':!0,'integrationmenuitemdark':!0},['widget.integrationmenuitemdark'],0,[photoActions.view,'IntegrationMenuItemDark'],0);Ext.cmd.derive('photoActions.view.SaveMenuItemDark',Ext.menu.Item,{cls:'save-button',ui:'plain',localized:{text:'PUL_Save'},iconAlign:'left',menuAlign:'tr-tl?',config:{menu:{xtype:'menu',ui:'dark2',cls:'photo-actions-menu',itemId:'saveMenu',showSeparator:!1,shadow:!1,items:[{itemId:'saveToComputerAction',localized:{text:'PUL_To Computer'},listeners:{}},{itemId:'saveToAlbumAction',localized:{text:'PUL_To Album'},hidden:!0,bind:{hidden:'{!account.canWrite}'}}],scrollable:!1}},bind:{listsAndReports:'{writeableListsAndReports}'},setListsAndReports:function(b){var c=[];for(var a=0;a<b.length;a++){c.push({cls:'add-to-list-report-action',text:mvstr['PUL_To_Task_List_'+b[a].get('ListTypeID')],ListTypeID:b[a].get('ListTypeID')})}this.menu.add(c)}},0,['photosavemenuitemdark'],['component','box','menuitem','photosavemenuitemdark'],{'component':!0,'box':!0,'menuitem':!0,'photosavemenuitemdark':!0},['widget.photosavemenuitemdark'],0,[photoActions.view,'SaveMenuItemDark'],0);Ext.cmd.derive('photoActions.view.addPhotosToAlbum.AddPhotosToAlbumModel',Ext.app.ViewModel,{data:{albumChoice:{createNewAlbum:!1},lastAlbumUIDChange:null},formulas:{selectedAlbumUIDs:{get:function(d){if(!d('preferencesReady')){return null}var f=d('lastAlbumUIDChange'),a=mdsPreferences.ProjectPreferences.getAlbumUIDArray(),b=[],e=this.getView().store;for(var c=0;c<a.length;c++){if(e.getById(a[c])){b.push(a[c])}}if(b.length!=a.length){mdsPreferences.ProjectPreferences.setAlbumUIDArray(b)}return b},set:function(a){mdsPreferences.ProjectPreferences.setAlbumUIDArray(a);this.set('lastAlbumUIDChange',(new Date()).getTime())}},nextButtonText:function(a){return a('albumChoice.createNewAlbum')?mvstr['G_Next']+' >':mvstr['G_Save']},nextButtonEnabled:function(a){var b=a('albumChoice.createNewAlbum'),c=a('selectedAlbumUIDs');return !!(b||c.length)}}},0,0,0,0,['viewmodel.addphotostoalbum'],0,[photoActions.view.addPhotosToAlbum,'AddPhotosToAlbumModel'],0);Ext.cmd.derive('photoActions.view.addPhotosToAlbum.AddPhotosToAlbumController',Ext.app.ViewController,{onExistingAlbumClick:function(e,f,c,h,d,g){if(d.getTarget().tagName!='INPUT'){var b=Ext.fly(c).select('input').elements[0];b.checked=!b.checked}var a=this.getView().getSelectedAlbumUIDs();if(a.length){this.lookupReference('addPhotosToAlbumNextAction').enable()}else {this.lookupReference('addPhotosToAlbumNextAction').disable()}this.getViewModel().set('selectedAlbumUIDs',a)},onAddPhotosToAlbumNextActionClick:function(){var a=this.getViewModel();if(a.get('albumChoice.createNewAlbum')){this.getToolbarActionsController().makeAlbum()}else {this.savePhotosToAlbums()}},savePhotosToAlbums:function(d){var c=this.getViewModel(),a=this.getView(),b=c.get('selectedAlbumUIDs');if(!d){this.getToolbarActionsController().savePhotosToAlbums(b,a,this.savePhotosToAlbums.bind(this));return}Ext.getBody().mask();a.mask('Saving ...');Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoList.savePhotosToAlbums',params:{ProjectUID:c.get('ProjectUID'),albumUIDs:b.join(','),photos:d.join(',')},successCallback:function(b){this.afterAddPhotosToAlbum(b);Ext.Msg.alert(mvstr['PA_Photos added'],mvstr['PA_The photos were succe']);Ext.getBody().unmask();a.destroy()},afterFailMessageCallback:function(b){this.afterAddPhotosToAlbum(b);Ext.getBody().unmask();a.unmask()},scope:this})},afterAddPhotosToAlbum:function(b){if(!b){return}var d=this.getToolbarActionsController().interfaceControl;if(!d.afterAddPhotosToAlbum){return}for(var c=0;c<b.length;c++){var a=b[c],e=a.data.count?a.data.count:0;d.afterAddPhotosToAlbum(a.AlbumUID,e)}},getToolbarActionsController:function(){return app.getController('photoActions.controller.ToolbarActions')}},0,0,0,0,['controller.addphotostoalbum'],0,[photoActions.view.addPhotosToAlbum,'AddPhotosToAlbumController'],0);Ext.cmd.derive('photoActions.view.addPhotosToAlbum.AddPhotosToAlbum',Ext.window.Window,{id:'addPhotosToAlbumWindow',bind:{selectedAlbumUIDs:'{selectedAlbumUIDs}'},viewModel:{type:'addphotostoalbum'},controller:'addphotostoalbum',localized:{title:'PUL_Add Photos To Album'},layout:{type:'vbox',align:'stretchmax'},modal:!0,modalMaskCls:'dark-mask',bodyPadding:5,items:[{xtype:'radiogroup',layout:'vbox',columns:2,bind:{value:'{albumChoice}'},defaults:{name:'createNewAlbum'},items:[{localized:{boxLabel:'PUL_Create New Album'},inputValue:!0},{localized:{boxLabel:'PUL_Add to Existing Album'},inputValue:!1}]},{xtype:'panel',layout:'fit',width:500,height:200,items:[{id:'existingAlbumsCheckboxes',xtype:'dataview',itemSelector:'.album',reference:'existingAlbums',cls:'choose-album-view',itemId:'existingAlbums',tpl:['<tpl for=".">','    <div class="album">','        <div class="lhs"><input type="checkbox"></div>','        <div class="rhs">{AlbumName}</div>','    </div>    ','</tpl>'],autoScroll:!0,listeners:{itemclick:'onExistingAlbumClick'}}],bind:{disabled:'{albumChoice.createNewAlbum}'}},{xtype:'container',flex:1,layout:{type:'hbox',pack:'end'},margin:'5 0 0 0',items:[{reference:'addPhotosToAlbumNextAction',xtype:'button',bind:{text:'{nextButtonText}',disabled:'{!nextButtonEnabled}'},listeners:{click:'onAddPhotosToAlbumNextActionClick'}}]}],constructor:function(a){Ext.window.Window.prototype.constructor.apply(this,arguments);this.down('#existingAlbums').setStore(a.store)},getSelectedAlbumUIDs:function(){var c=this.lookupReference('existingAlbums'),e=c.getStore().getRange(),b=c.el.select('input').elements,d=[];for(var a=0;a<b.length;a++){if(b[a].checked){d.push(e[a].get('AlbumUID'))}}return d},setSelectedAlbumUIDs:function(d){var c=this.lookupReference('existingAlbums'),e=c.getStore().getRange(),b=c.el.select('input').elements;for(var a=0;a<b.length;a++){b[a].checked=Ext.Array.contains(d,e[a].get('AlbumUID'))}}},1,['addphotostoalbum'],['component','box','container','panel','window','addphotostoalbum'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'addphotostoalbum':!0},['widget.addphotostoalbum'],0,[photoActions.view.addPhotosToAlbum,'AddPhotosToAlbum'],0);Ext.cmd.derive('webcamShared.view.PTZ.PTZStreamMask',Ext.Component,{controller:'ptzstreammask',autoEl:{tag:'canvas'},style:{position:'absolute',cursor:'crosshair',zIndex:2},listeners:{afterrender:'ptzMaskRendered',resize:'ptzMaskResize'}},0,['ptzstreammask'],['component','box','ptzstreammask'],{'component':!0,'box':!0,'ptzstreammask':!0},['widget.ptzstreammask'],0,[webcamShared.view.PTZ,'PTZStreamMask'],0);Ext.cmd.derive('webcamShared.view.PTZ.PTZStreamMaskController',Ext.app.ViewController,{startX:null,startY:null,isDrawing:!1,getStream:function(){return this.getView().lookupViewModel().get('activeStream')},ptzMaskRendered:function(){this.initPTZMask()},ptzMaskResize:function(){var a=this.getView(),b=a.getEl().dom;b.width=a.getWidth();b.height=a.getHeight()},initPTZMask:function(){var a=this.getView(),c=a.getEl().dom,b=c.getContext('2d'),d=this;c.onmousedown=function(e){e.stopPropagation();this.isDrawing=!0;this.startX=e.clientX-a.getX();this.startY=e.clientY-a.getY();c.onmousemove=function(c){if(this.isDrawing){var f=parseInt(c.clientX-a.getX()-this.startX);var d=parseInt(c.clientY-a.getY()-this.startY);b.clearRect(0,0,a.getWidth(),a.getHeight());b.beginPath();b.strokeStyle='#E47911';b.lineWidth=2;b.rect(this.startX,this.startY,f,d);b.stroke()}};c.onmouseup=function(c){if(this.isDrawing){this.isDrawing=!1;var f=Math.abs(this.startX-(c.clientX-a.getX()));var g=Math.abs(this.startY-(c.clientY-a.getY()));if(f<10||g<10){d.ptzMaskPanTilt(c.clientX-a.getX(),c.clientY-a.getY())}else {var i=(c.clientX+this.startX-a.getX())/2;var j=(c.clientY+this.startY-a.getY())/2;var h=(Math.abs(f)/a.getWidth()+Math.abs(g)/a.getHeight())/2;d.ptzMaskZoom(i,j,100/h)}b.clearRect(0,0,a.getWidth(),a.getHeight())}}};c.onmouseout=function(){this.isDrawing=!1;b.clearRect(0,0,a.getWidth(),a.getHeight())}},ptzMaskPanTilt:function(d,e){analytics.Ctrl.setOptionalDefaultEventProperties({'Method':'Stream Interaction','Sub Method':'Click'});var c=this.getView().getWidth(),b=this.getView().getHeight(),a=this.getStream();Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.move&center='+Math.round(d)+','+Math.round(e)+'&imagewidth='+Math.floor(c)+'&imageheight='+Math.floor(b),params:{WebcamUID:a.WebcamUID,ProjectUID:a.ProjectUID},successCallback:this.onPTZRequestSuccess},this)},ptzMaskZoom:function(e,f,d){analytics.Ctrl.setOptionalDefaultEventProperties({'Method':'Stream Interaction','Sub Method':'Box Zoom'});var c=this.getView().getWidth(),b=this.getView().getHeight(),a=this.getStream();Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.move&areazoom='+Math.round(e)+','+Math.round(f)+','+d+'&imagewidth='+Math.floor(c)+'&imageheight='+Math.floor(b),params:{WebcamUID:a.WebcamUID,ProjectUID:a.ProjectUID},successCallback:this.onPTZRequestSuccess},this)},onPTZRequestSuccess:function(){setTimeout(function(){app.fireEvent('forceupdateptzposition')},2500)}},0,0,0,0,['controller.ptzstreammask'],0,[webcamShared.view.PTZ,'PTZStreamMaskController'],0);Ext.cmd.derive('webcamShared.view.Stream',Ext.container.Container,{config:{showFullscreenButton:!0},layout:{type:'absolute'},items:[{xtype:'button',ui:'plain',itemId:'webcamFullscreenBtn',cls:'webcam-fullscreen-btn',hidden:!0,handler:function(a){a.up('webcamlivestream').requestFullScreen()}},{xtype:'container',itemId:'wcLiveStreamContainer',items:[{xtype:'component',itemId:'wcLiveStream',cls:'webcam-stream no-volume no-mute',width:'100%',height:'100%',listeners:{resize:function(){var a=this.up('webcamlivestream');if(a.down('#ptzMask').isVisible()){a.down('#ptzMask').alignTo(this.getEl(),'tl?');a.down('#ptzMask').setSize(this.getSize())}}}},{xtype:'ptzstreammask',itemId:'ptzMask',hidden:!0}]}],Webcam:null,Image:null,params:null,localScale:100,loadAttempts:0,httpImageTimeout:null,load:function(b,i,g,e){var a=Ext.getCmp(this.getId());a.Webcam=b;a.HTTPStreamParams=Ext.clone(i);a.viewport=g;if(!e){a.resize()}var c=Ext.Object.fromQueryString(document.location.search),h=c.fuseaction?c.fuseaction.split('.')[0]:document.location.pathname.match('clientWebcam')?'aClientWebcam':document.location.pathname.match('publicWebcam')?'aPublicWebcam':'';a.HTTPStreamParams.fuseaction=h+'.getHTTPStream';if(b.WebcamStreamType=='RTSP'){this.clearImage();if(b.ForceFlashStream){this.loadFlowplayer()}else {this.loadH5Live()}}else {var f=Ext.create('Ext.Img',{renderTo:a.down('#wcLiveStream').el,src:a.Webcam.ImageURL,centered:!0,listeners:{afterrender:function(a){Ext.getCmp(this.getId()).mask('Loading ...')}}});b.isPlaying=!0;a.Image=f.el.dom;a.Image.onload=function(){a.fireEvent('imageload')};a.loadImage();var d=Ext.getCmp('fullscreenBtn');if(d&&this.canRequestFullscreen()&&this.getShowFullscreenButton()){d.show()}}},loadH5Live:function(){var a=this;var e=a.down('#wcLiveStream').getId();var c=this.Webcam;var b={h5live:{server:{websocket:'wss://bintu-play.nanocosmos.de:443/h5live/stream',hls:'https://bintu-play.nanocosmos.de:443/h5live/http/playlist.m3u8',progressive:'https://bintu-play.nanocosmos.de:443/h5live/http/stream.mp4'},token:'{"type":"token1","key":"mvis9174hf-ltohd"}',rtmp:{url:c.RTMPURL,streamname:c.StreamName}}};if(this.h5livePlayer){this.h5livePlayer.updateSource(b)}else {var d={source:b,playback:{autoplay:!0,muted:!0},style:{controls:!1},events:{onReady:function(){a.setH5LivePoster()},onPlay:function(){a.Webcam.isPlaying=!0;a.setPTZMaskVisibility(!0);var c=a.h5livePlayer._view._mediaElement;c.style.removeProperty('background-image');app.fireEvent('flowplayerReady');a.setupTimeout(a.h5livePlayer);var b=a.down('#webcamFullscreenBtn');if(b&&a.getShowFullscreenButton()&&a.canRequestFullscreen()){b.show()}},onPause:function(){},onLoading:function(){a.setH5LivePoster()}}};this.h5livePlayer=new NanoPlayer(e);this.h5livePlayer.setup(d).then(function(a){},function(a){alert(a.message)})}},setH5LivePoster:function(){var b=this.Webcam;var a=this.h5livePlayer;var c=a._view._mediaElement;c.poster=b.ImageURL},loadFlowplayer:function(){var c=document.getElementById(this.getId()),b=this.Webcam,a=this,e='$131119724416338';if(location.href.indexOf('localhost')!=-1){e='$863732616083910'}var d=flowplayer(c,{key:e,autoplay:!0,clip:{live:!0,sources:[{type:'video/flash',src:b.RTMPURL+'/'+b.StreamName}]},wmode:'transparent',fullscreen:!0,embed:!1,poster:b.ImageURL}).on('ready',function(f,d,e){a.loadAttempts=0;a.setupTimeout(d);b.isPlaying=!0;a.setPTZMaskVisibility(!0);app.fireEvent('flowplayerReady');var c=a.down('#webcamFullscreenBtn');if(c&&a.canRequestFullscreen()&&a.getShowFullscreenButton()){c.show()}}).on('pause',function(c,a){if(b.isPlaying){a.play()}else {Ext.select('.fp-ui').elements[0].style=''}}).on('resume',function(d,c){if(!b.isPlaying){a.setupTimeout(c);Ext.select('.fp-ui').elements[0].style='background: none;';b.isPlaying=!0;a.setPTZMaskVisibility(!0)}}).on('error',function(e,b,d){console.log('Error loading video');console.log(d);a.loadAttempts++;if(a.loadAttempts<5){b.error=b.loading=!1;c.className=c.className.replace(/\bis-offline\b/,'');c.className=c.className.replace(/\bis-error\b/,'');b.load(b.conf.clip)}else {console.log('Error - Attempts to connect exceeded 5')}});a.flowplayerApi=d;setTimeout(function(){if(!d.ready){d.loading=!1}},5000)},setupTimeout:function(j){var i=this,h=this.Webcam,f=h.DefaultStreamTimeout*60*1000,b=h.StreamTimeouts,d=new Date();if(b){var g=Ext.Date.add(d,Ext.Date.DAY,1);for(var e=b.length-1;e>=0;e--){var c=new Date(),a=new Date();c.setHours(Math.floor(b[e].StartTimeMinutes/60),b[e].StartTimeMinutes%60);a.setHours(Math.floor(b[e].EndTimeMinutes/60),b[e].EndTimeMinutes%60);if(a<c){a=Ext.Date.add(a,Ext.Date.DAY,1)}if(a<d){a=Ext.Date.add(a,Ext.Date.DAY,1);c=Ext.Date.add(c,Ext.Date.DAY,1)}if(d>=c&&d<a){f=b[e].TimeoutLength===0?a-d:Math.min(b[e].TimeoutLength*60*1000,a-d)}if(d<c&&c<g){g=c}f=Math.min(f,g-d)}}if(f){Ext.defer(function(){var a=document.getElementById('ptzMask');if(a){a.parentNode.removeChild(a)}h.isPlaying=!1;i.setPTZMaskVisibility(!0);j.pause()},f)}},resize:function(){var a=this;var g=!!a.up('photoviewer');if(!a.Webcam){return}a.staticHSpace=a.viewport.getStaticHSpace();a.staticVSpace=a.viewport.getStaticVSpace();var e=(a.viewport.body?a.viewport.body.getWidth():a.viewport.getWidth())-a.staticHSpace;var d=(a.viewport.body?a.viewport.body.getHeight():a.viewport.getHeight())-a.staticVSpace;var b=Math.min(d,a.Webcam.StreamHeight);var c=b/this.Webcam.StreamHeight*this.Webcam.StreamWidth;if(c>e){c=e;b=c/a.Webcam.StreamWidth*a.Webcam.StreamHeight}if(b>d){b=d;c=b/a.Webcam.StreamHeight*a.Webcam.StreamWidth}if(g&&c<e&&b<d){var h=c/b<e/d;if(h){b=d;c=b/a.Webcam.StreamHeight*a.Webcam.StreamWidth}else {c=e;b=c/a.Webcam.StreamWidth*a.Webcam.StreamHeight}}var f=Ext.getCmp('streamWrapper');if(f){f.el.dom.style.overflow=a.localScale==100?'hidden':'scroll';f.setSize(c,b)}a.down('#wcLiveStream').setSize(c*(a.localScale/100),b*(a.localScale/100));a.down('#wcLiveStreamContainer').setSize(c*(a.localScale/100),b*(a.localScale/100));if(g){b=Math.max(d,b*(a.localScale/100));c=c*(a.localScale/100);a.setSize(c,b)}else {a.setSize(c,b)}},clearImage:function(){var a=Ext.getCmp(this.getId());if(a.Image){a.Image.src=''}},loadImage:function(){var a=Ext.getCmp(this.getId());a.Image.src=mdslink.server+'/index.cfm?'+Ext.Object.toQueryString(a.HTTPStreamParams)+'&dc='+(new Date()).getTime()},zoom:function(b){var a=this.localScale;if(b>0){a*=1.25}else {a/=1.25}a=Math.max(100,a);this.localZoom(a)},localZoom:function(a){this.localScale=a;this.resize()},requestFullScreen:function(){if(this.flowplayerApi){this.flowplayerApi.fullscreen();return}var a=this.down('#wcLiveStream').el.dom;var b=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullScreen;if(b){b.call(a)}else {if(typeof window.ActiveXObject!=='undefined'){var c=new ActiveXObject('WScript.Shell');if(c!==null){c.SendKeys('{F11}')}}}},canRequestFullscreen:function(){var a=this.el.dom;return (a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullScreen)&&!Ext.isIE?!0:!1},cleanup:function(){if(this.h5livePlayer){this.h5livePlayer.destroy()}clearTimeout(this.httpImageTimeout)},listeners:{imageload:function(){clearTimeout(this.httpImageTimeout);this.httpImageTimeout=Ext.defer(this.loadImage,this.Webcam.StreamRefreshRate*1000,this)},beforedestroy:function(){this.cleanup()},hide:function(){this.cleanup()}},requestFullscreenRTSP:function(){var c=document.getElementById(this.getId());var b=c.querySelector('video');if(b){this.requestFullScreen()}var a=document.getElementById('ptzMask');if(a){a.parentNode.removeChild(a)}},setPTZMaskVisibility:function(c){var a=!!this.up('photoviewer'),b=this.lookupViewModel().get('PTZPosition');if(a&&b&&c){this.down('#ptzMask').show();this.down('#wcLiveStream').fireEvent('resize')}else {this.down('#ptzMask').hide()}}},0,['webcamlivestream'],['component','box','container','webcamlivestream'],{'component':!0,'box':!0,'container':!0,'webcamlivestream':!0},['widget.webcamlivestream'],0,[webcamShared.view,'Stream'],0);Ext.cmd.derive('Ext.draw.ContainerBase',Ext.panel.Panel,{previewTitleText:'Chart Preview',previewAltText:'Chart preview',layout:'container',addElementListener:function(){var a=this,b=arguments;if(a.rendered){a.el.on.apply(a.el,b)}else {a.on('render',function(){a.el.on.apply(a.el,b)})}},removeElementListener:function(){var a=this,b=arguments;if(a.rendered){a.el.un.apply(a.el,b)}},afterRender:function(){Ext.panel.Panel.prototype.afterRender.apply(this,arguments);this.initAnimator()},getItems:function(){var a=this,b=a.items;if(!b||!b.isMixedCollection){a.initItems()}return a.items},onRender:function(){Ext.panel.Panel.prototype.onRender.apply(this,arguments);this.element=this.el;this.innerElement=this.body},setItems:function(a){this.items=a;return a},setSurfaceSize:function(b,a){this.resizeHandler({width:b,height:a});this.renderFrame()},onResize:function(b,a,e,d){var c=this;Ext.panel.Panel.prototype.onResize.call(this,b,a,e,d);c.handleResize({width:b,height:a},!c.size)},preview:function(){var a=this.getImage(),b;if(Ext.isIE8){return !1}if(a.type==='svg-markup'){b={xtype:'container',html:a.data}}else {b={xtype:'image',mode:'img',cls:'x-chart-image',alt:this.previewAltText,src:a.data,listeners:{afterrender:function(){var b=this,c=b.imgEl.dom,d=a.type==='svg'?1:window['devicePixelRatio']||1,e;if(!c.naturalWidth||!c.naturalHeight){c.onload=function(){var e=c.naturalWidth,a=c.naturalHeight;b.setWidth(Math.floor(e/d));b.setHeight(Math.floor(a/d))}}else {e=b.getSize();b.setWidth(Math.floor(e.width/d));b.setHeight(Math.floor(e.height/d))}}}}}new Ext.window.Window({title:this.previewTitleText,closeable:!0,renderTo:Ext.getBody(),autoShow:!0,maximizeable:!0,maximized:!0,border:!0,layout:{type:'hbox',pack:'center',align:'middle'},items:{xtype:'container',items:b}})},privates:{getTargetEl:function(){return this.innerElement},reattachToBody:function(){var a=this;if(a.pendingDetachSize){a.handleResize()}a.pendingDetachSize=!1;Ext.panel.Panel.prototype.reattachToBody.call(this)}}},0,0,['component','box','container','panel'],{'component':!0,'box':!0,'container':!0,'panel':!0},0,0,[Ext.draw,'ContainerBase'],0);Ext.cmd.derive('Ext.draw.SurfaceBase',Ext.Widget,{getOwnerBody:function(){return this.ownerCt.body}},0,0,['widget'],{'widget':!0},0,0,[Ext.draw,'SurfaceBase'],0);Ext.cmd.derive('Ext.draw.sprite.AnimationParser',Ext.Base,function(){function compute(a,c,b){return a+(c-a)*b}return {singleton:!0,attributeRe:/^url\(#([a-zA-Z\-]+)\)$/,color:{parseInitial:function(a,b){if(Ext.isString(a)){a=Ext.util.Color.create(a)}if(Ext.isString(b)){b=Ext.util.Color.create(b)}if(a&&a.isColor&&(b&&b.isColor)){return [[a.r,a.g,a.b,a.a],[b.r,b.g,b.b,b.a]]}else {return [a||b,b||a]}},compute:function(a,b,c){if(!Ext.isArray(a)||!Ext.isArray(b)){return b||a}else {return [compute(a[0],b[0],c),compute(a[1],b[1],c),compute(a[2],b[2],c),compute(a[3],b[3],c)]}},serve:function(a){var b=Ext.util.Color.fly(a[0],a[1],a[2],a[3]);return b.toString()}},number:{parse:function(a){return a===null?null:+a},compute:function(a,b,c){if(!Ext.isNumber(a)||!Ext.isNumber(b)){return b||a}else {return compute(a,b,c)}}},angle:{parseInitial:function(b,a){if(a-b>Math.PI){a-=Math.PI*2}else {if(a-b<-Math.PI){a+=Math.PI*2}}return [b,a]},compute:function(a,b,c){if(!Ext.isNumber(a)||!Ext.isNumber(b)){return b||a}else {return compute(a,b,c)}}},path:{parseInitial:function(m,l){var e=m.toStripes(),c=l.toStripes(),a,i,f=e.length,g=c.length,j,h,k,d=c[g-1],b=[d[d.length-2],d[d.length-1]];for(a=f;a<g;a++){e.push(e[f-1].slice(0))}for(a=g;a<f;a++){c.push(b.slice(0))}k=e.length;c.path=l;c.temp=new Ext.draw.Path();for(a=0;a<k;a++){j=e[a];h=c[a];f=j.length;g=h.length;c.temp.commands.push('M');for(i=g;i<f;i+=6){h.push(b[0],b[1],b[0],b[1],b[0],b[1])}d=c[c.length-1];b=[d[d.length-2],d[d.length-1]];for(i=f;i<g;i+=6){j.push(b[0],b[1],b[0],b[1],b[0],b[1])}for(a=0;a<h.length;a++){h[a]-=j[a]}for(a=2;a<h.length;a+=6){c.temp.commands.push('C')}}return [e,c]},compute:function(e,b,f){if(f>=1){return b.path}var c=0,k=e.length,a=0,g,d,h,i=b.temp.params,j=0;for(;c<k;c++){d=e[c];h=b[c];g=d.length;for(a=0;a<g;a++){i[j++]=h[a]*f+d[a]}}return b.temp}},data:{compute:function(e,i,j,a){var g=e.length-1,h=i.length-1,f=Math.max(g,h),d,c,b;if(!a||a===e){a=[]}a.length=f+1;for(b=0;b<=f;b++){d=e[Math.min(b,g)];c=i[Math.min(b,h)];if(Ext.isNumber(d)){if(!Ext.isNumber(c)){c=0}a[b]=(c-d)*j+d}else {a[b]=c}}return a}},text:{compute:function(b,c,a){return b.substr(0,Math.round(b.length*(1-a)))+c.substr(Math.round(c.length*(1-a)))}},limited:'number',limited01:'number'}},0,0,0,0,0,0,[Ext.draw.sprite,'AnimationParser'],0);(function(){if(!Ext.global.Float32Array){var a=function(a){if(typeof a==='number'){this.length=a}else {if('length' in a){this.length=a.length;for(var b=0,c=a.length;b<c;b++){this[b]=+a[b]}}}};a.prototype=[];Ext.global.Float32Array=a}})();Ext.cmd.derive('Ext.draw.Draw',Ext.Base,{singleton:!0,radian:Math.PI/180,pi2:Math.PI*2,reflectFn:function(a){return a},rad:function(a){return a%360*this.radian},degrees:function(a){return a/this.radian%360},isBBoxIntersect:function(a,b,c){c=c||0;return Math.max(a.x,b.x)-c>Math.min(a.x+a.width,b.x+b.width)||Math.max(a.y,b.y)-c>Math.min(a.y+a.height,b.y+b.height)},isPointInBBox:function(b,c,a){return !!a&&b>=a.x&&b<=a.x+a.width&&c>=a.y&&c<=a.y+a.height},spline:function(c){var a,e,i=c.length,g,j,k,d,h=0,b=new Float32Array(c.length),f=new Float32Array(c.length*3-2);b[0]=0;b[i-1]=0;for(a=1;a<i-1;a++){b[a]=c[a+1]+c[a-1]-2*c[a]-b[a-1];h=1/(4-h);b[a]*=h}for(a=i-2;a>0;a--){h=3.732050807568877+48.248711305964385/(-13.928203230275537+Math.pow(0.07179676972449123,a));b[a]-=b[a+1]*h}d=c[0];g=d-b[0];for(a=0,e=0;a<i-1;e+=3){k=d;j=g;a++;d=c[a];g=d-b[a];f[e]=k;f[e+1]=(g+2*j)/3;f[e+2]=(g*2+j)/3}f[e]=d;return f},getAnchors:function(s,c,f,a,r,b,m){m=m||4;var j=Math.PI,q=j/2,n=Math.abs,v=Math.sin,u=Math.cos,t=Math.atan,o,p,d,e,k,g,l,h,i;o=(f-s)/m;p=(r-f)/m;if(a>=c&&a>=b||a<=c&&a<=b){d=e=q}else {d=t((f-s)/n(a-c));if(c<a){d=j-d}e=t((r-f)/n(a-b));if(b<a){e=j-e}}i=q-(d+e)%(j*2)/2;if(i>q){i-=j}d+=i;e+=i;k=f-o*v(d);g=a+o*u(d);l=f+p*v(e);h=a+p*u(e);if(a>c&&g<c||a<c&&g>c){k+=n(c-g)*(k-f)/(g-a);g=c}if(a>b&&h<b||a<b&&h>b){l-=n(b-h)*(l-f)/(h-a);h=b}return {x1:k,y1:g,x2:l,y2:h}},smooth:function(i,j,p){var o=i.length,m,n,c,d,k,l,e,f,g=[],h=[],a,b;for(a=0;a<o-1;a++){m=i[a];n=j[a];if(a===0){e=m;f=n;g.push(e);h.push(f);if(o===1){break}}c=i[a+1];d=j[a+1];k=i[a+2];l=j[a+2];if(!(Ext.isNumber(k)&&Ext.isNumber(l))){g.push(e,c,c);h.push(f,d,d);break}b=this.getAnchors(m,n,c,d,k,l,p);g.push(e,b.x1,c);h.push(f,b.y1,d);e=b.x2;f=b.y2}return {smoothX:g,smoothY:h}},beginUpdateIOS:Ext.os.is.iOS?function(){this.iosUpdateEl=Ext.getBody().createChild({style:'position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px; background: rgba(0,0,0,0.001); z-index: 100000'})}:Ext.emptyFn,endUpdateIOS:function(){this.iosUpdateEl=Ext.destroy(this.iosUpdateEl)}},0,0,0,0,0,0,[Ext.draw,'Draw'],0);Ext.cmd.derive('Ext.draw.gradient.Gradient',Ext.Base,{isGradient:!0,config:{stops:[]},applyStops:function(e){var d=[],f=e.length,c,b,a;for(c=0;c<f;c++){b=e[c];a=b.color;if(!(a&&a.isColor)){a=Ext.util.Color.fly(a||Ext.util.Color.NONE)}d.push({offset:Math.min(1,Math.max(0,'offset' in b?b.offset:b.position||0)),color:a.toString()})}d.sort(function(a,b){return a.offset-b.offset});return d},onClassExtended:function(b,a){if(!a.alias&&a.type){a.alias='gradient.'+a.type}},constructor:function(a){this.initConfig(a)},generateGradient:Ext.emptyFn},1,0,0,0,0,0,[Ext.draw.gradient,'Gradient'],0);Ext.cmd.derive('Ext.draw.gradient.GradientDefinition',Ext.Base,{singleton:!0,urlStringRe:/^url\(#([\w\-]+)\)$/,gradients:{},add:function(c){var e=this.gradients,b,d,a;for(b=0,d=c.length;b<d;b++){a=c[b];if(Ext.isString(a.id)){e[a.id]=a}}},get:function(b){var d=this.gradients,a=b.match(this.urlStringRe),c;if(a&&a[1]&&(c=d[a[1]])){return c||b}return b}},0,0,0,0,0,0,[Ext.draw.gradient,'GradientDefinition'],0);Ext.cmd.derive('Ext.draw.sprite.AttributeParser',Ext.Base,{singleton:!0,attributeRe:/^url\(#([a-zA-Z\-]+)\)$/,'default':Ext.identityFn,string:function(a){return String(a)},number:function(a){if(Ext.isNumber(+a)){return a}},angle:function(a){if(Ext.isNumber(a)){a%=Math.PI*2;if(a<-Math.PI){a+=Math.PI*2}else {if(a>=Math.PI){a-=Math.PI*2}}return a}},data:function(a){if(Ext.isArray(a)){return a.slice()}else {if(a instanceof Float32Array){return new Float32Array(a)}}},bool:function(a){return !!a},color:function(a){if(a&&a.isColor){return a.toString()}else {if(a&&a.isGradient){return a}else {if(!a){return Ext.util.Color.NONE}else {if(Ext.isString(a)){if(a.substr(0,3)==='url'){a=Ext.draw.gradient.GradientDefinition.get(a);if(Ext.isString(a)){return a}}else {return Ext.util.Color.fly(a).toString()}}}}}if(a.type==='linear'){return Ext.create('Ext.draw.gradient.Linear',a)}else {if(a.type==='radial'){return Ext.create('Ext.draw.gradient.Radial',a)}else {if(a.type==='pattern'){return Ext.create('Ext.draw.gradient.Pattern',a)}else {return Ext.util.Color.NONE}}}},limited:function(a,b){return function(c){c=+c;return Ext.isNumber(c)?Math.min(Math.max(c,a),b):undefined}},limited01:function(a){a=+a;return Ext.isNumber(a)?Math.min(Math.max(a,0),1):undefined},enums:function(){var b={},c=Array.prototype.slice.call(arguments,0),a,d;for(a=0,d=c.length;a<d;a++){b[c[a]]=!0}return function(a){return a in b?a:undefined}}},0,0,0,0,0,0,[Ext.draw.sprite,'AttributeParser'],0);Ext.cmd.derive('Ext.draw.sprite.AttributeDefinition',Ext.Base,{config:{defaults:{$value:{},lazy:!0},aliases:{},animationProcessors:{},processors:{$value:{},lazy:!0},dirtyTriggers:{},triggers:{},updaters:{}},inheritableStatics:{processorFactoryRe:/^(\w+)\(([\w\-,]*)\)$/},spriteClass:null,constructor:function(a){var b=this;b.initConfig(a)},applyDefaults:function(b,a){a=Ext.apply(a||{},this.normalize(b));return a},applyAliases:function(b,a){return Ext.apply(a||{},b)},applyProcessors:function(g,j){this.getAnimationProcessors();var h=j||{},b=Ext.draw.sprite.AttributeParser,i=this.self.processorFactoryRe,f={},e,d,c,a;for(d in g){a=g[d];if(typeof a==='string'){c=a.match(i);if(c){a=b[c[1]].apply(b,c[2].split(','))}else {if(b[a]){f[d]=a;e=!0;a=b[a]}}}h[d]=a}if(e){this.setAnimationProcessors(f)}return h},applyAnimationProcessors:function(e,b){var d=Ext.draw.sprite.AnimationParser,c,a;if(!b){b={}}for(c in e){a=e[c];if(a==='none'){b[c]=null}else {if(Ext.isString(a)&&!(c in b)){if(a in d){while(Ext.isString(d[a])){a=d[a]}b[c]=d[a]}}else {if(Ext.isObject(a)){b[c]=a}}}}return b},updateDirtyTriggers:function(a){this.setTriggers(a)},applyTriggers:function(b,a){if(!a){a={}}for(var c in b){a[c]=b[c].split(',')}return a},applyUpdaters:function(b,a){return Ext.apply(a||{},b)},batchedNormalize:function(d,n){if(!d){return {}}var j=this.getProcessors(),k=this.getAliases(),h=d.translation||d.translate,a={},i,o,c,f,b,e,l,m,g;if('rotation' in d){b=d.rotation}else {b='rotate' in d?d.rotate:undefined}if('scaling' in d){e=d.scaling}else {e='scale' in d?d.scale:undefined}if(typeof e!=='undefined'){if(Ext.isNumber(e)){a.scalingX=e;a.scalingY=e}else {if('x' in e){a.scalingX=e.x}if('y' in e){a.scalingY=e.y}if('centerX' in e){a.scalingCenterX=e.centerX}if('centerY' in e){a.scalingCenterY=e.centerY}}}if(typeof b!=='undefined'){if(Ext.isNumber(b)){b=Ext.draw.Draw.rad(b);a.rotationRads=b}else {if('rads' in b){a.rotationRads=b.rads}else {if('degrees' in b){if(Ext.isArray(b.degrees)){a.rotationRads=Ext.Array.map(b.degrees,function(a){return Ext.draw.Draw.rad(a)})}else {a.rotationRads=Ext.draw.Draw.rad(b.degrees)}}}if('centerX' in b){a.rotationCenterX=b.centerX}if('centerY' in b){a.rotationCenterY=b.centerY}}}if(typeof h!=='undefined'){if('x' in h){a.translationX=h.x}if('y' in h){a.translationY=h.y}}if('matrix' in d){l=Ext.draw.Matrix.create(d.matrix);g=l.split();a.matrix=l;a.rotationRads=g.rotation;a.rotationCenterX=0;a.rotationCenterY=0;a.scalingX=g.scaleX;a.scalingY=g.scaleY;a.scalingCenterX=0;a.scalingCenterY=0;a.translationX=g.translateX;a.translationY=g.translateY}for(c in d){f=d[c];if(typeof f==='undefined'){continue}else {if(Ext.isArray(f)){if(c in k){c=k[c]}if(c in j){a[c]=[];for(i=0,o=f.length;i<o;i++){m=j[c].call(this,f[i]);if(typeof m!=='undefined'){a[c][i]=m}}}else {if(n){a[c]=f}}}else {if(c in k){c=k[c]}if(c in j){f=j[c].call(this,f);if(typeof f!=='undefined'){a[c]=f}}else {if(n){a[c]=f}}}}}return a},normalize:function(c,l){if(!c){return {}}var j=this.getProcessors(),k=this.getAliases(),h=c.translation||c.translate,a={},e,f,b,d,i,g;if('rotation' in c){b=c.rotation}else {b='rotate' in c?c.rotate:undefined}if('scaling' in c){d=c.scaling}else {d='scale' in c?c.scale:undefined}if(h){if('x' in h){a.translationX=h.x}if('y' in h){a.translationY=h.y}}if(typeof d!=='undefined'){if(Ext.isNumber(d)){a.scalingX=d;a.scalingY=d}else {if('x' in d){a.scalingX=d.x}if('y' in d){a.scalingY=d.y}if('centerX' in d){a.scalingCenterX=d.centerX}if('centerY' in d){a.scalingCenterY=d.centerY}}}if(typeof b!=='undefined'){if(Ext.isNumber(b)){b=Ext.draw.Draw.rad(b);a.rotationRads=b}else {if('rads' in b){a.rotationRads=b.rads}else {if('degrees' in b){a.rotationRads=Ext.draw.Draw.rad(b.degrees)}}if('centerX' in b){a.rotationCenterX=b.centerX}if('centerY' in b){a.rotationCenterY=b.centerY}}}if('matrix' in c){i=Ext.draw.Matrix.create(c.matrix);g=i.split();a.matrix=i;a.rotationRads=g.rotation;a.rotationCenterX=0;a.rotationCenterY=0;a.scalingX=g.scaleX;a.scalingY=g.scaleY;a.scalingCenterX=0;a.scalingCenterY=0;a.translationX=g.translateX;a.translationY=g.translateY}for(e in c){f=c[e];if(typeof f==='undefined'){continue}if(e in k){e=k[e]}if(e in j){f=j[e].call(this,f);if(typeof f!=='undefined'){a[e]=f}}else {if(l){a[e]=f}}}return a},setBypassingNormalization:function(c,a,b){return a.pushDown(c,b)},set:function(c,b,a){a=this.normalize(a);return this.setBypassingNormalization(c,b,a)}},1,0,0,0,0,0,[Ext.draw.sprite,'AttributeDefinition'],0);Ext.cmd.derive('Ext.draw.Matrix',Ext.Base,{isMatrix:!0,statics:{createAffineMatrixFromTwoPair:function(f,g,n,o,j,k,l,m){var b=n-f,c=o-g,h=l-j,i=m-k,a=1/(b*b+c*c),d=b*h+c*i,e=h*c-b*i,p=-d*f-e*g,q=e*f-d*g;return new this(d*a,-e*a,e*a,d*a,p*a+j,q*a+k)},createPanZoomFromTwoPair:function(b,c,l,m,f,h,g,i){if(arguments.length===2){return this.createPanZoomFromTwoPair.apply(this,b.concat(c))}var j=l-b,k=m-c,p=(b+l)*0.5,q=(c+m)*0.5,d=g-f,e=i-h,n=(f+g)*0.5,o=(h+i)*0.5,s=j*j+k*k,r=d*d+e*e,a=Math.sqrt(r/s);return new this(a,0,0,a,n-a*p,o-a*q)},fly:function(){var a=null,b=function(b){a.elements=b;return a};return function(c){if(!a){a=new Ext.draw.Matrix()}a.elements=c;Ext.draw.Matrix.fly=b;return a}}(),create:function(a){if(a instanceof this){return a}return new this(a)}},constructor:function(a,d,e,f,b,c){if(a&&a.length===6){this.elements=a.slice()}else {if(a!==undefined){this.elements=[a,d,e,f,b,c]}else {this.elements=[1,0,0,1,0,0]}}},prepend:function(b,c,d,e,l,m){var a=this.elements,h=a[0],i=a[1],j=a[2],k=a[3],f=a[4],g=a[5];a[0]=b*h+d*i;a[1]=c*h+e*i;a[2]=b*j+d*k;a[3]=c*j+e*k;a[4]=b*f+d*g+l;a[5]=c*f+e*g+m;return this},prependMatrix:function(a){return this.prepend.apply(this,a.elements)},append:function(h,i,j,k,f,g){var a=this.elements,b=a[0],c=a[1],d=a[2],e=a[3],l=a[4],m=a[5];a[0]=h*b+i*d;a[1]=h*c+i*e;a[2]=j*b+k*d;a[3]=j*c+k*e;a[4]=f*b+g*d+l;a[5]=f*c+g*e+m;return this},appendMatrix:function(a){return this.append.apply(this,a.elements)},set:function(d,e,f,g,b,c){var a=this.elements;a[0]=d;a[1]=e;a[2]=f;a[3]=g;a[4]=b;a[5]=c;return this},inverse:function(i){var a=this.elements,b=a[0],c=a[1],d=a[2],e=a[3],g=a[4],h=a[5],f=1/(b*e-c*d);b*=f;c*=f;d*=f;e*=f;if(i){i.set(e,-c,-d,b,d*h-e*g,c*g-b*h);return i}else {return new Ext.draw.Matrix(e,-c,-d,b,d*h-e*g,c*g-b*h)}},translate:function(a,b,c){if(c){return this.prepend(1,0,0,1,a,b)}else {return this.append(1,0,0,1,a,b)}},scale:function(d,c,a,b,f){var e=this;if(c==null){c=d}if(a===undefined){a=0}if(b===undefined){b=0}if(f){return e.prepend(d,0,0,c,a-a*d,b-b*c)}else {return e.append(d,0,0,c,a-a*d,b-b*c)}},rotate:function(e,b,c,g){var f=this,a=Math.cos(e),d=Math.sin(e);b=b||0;c=c||0;if(g){return f.prepend(a,d,-d,a,b-a*b+c*d,c-a*c-b*d)}else {return f.append(a,d,-d,a,b-a*b+c*d,c-a*c-b*d)}},rotateFromVector:function(c,d,g){var e=this,f=Math.sqrt(c*c+d*d),a=c/f,b=d/f;if(g){return e.prepend(a,b,-b,a,0,0)}else {return e.append(a,b,-b,a,0,0)}},clone:function(){return new Ext.draw.Matrix(this.elements)},flipX:function(){return this.append(-1,0,0,1,0,0)},flipY:function(){return this.append(1,0,0,-1,0,0)},skewX:function(a){return this.append(1,0,Math.tan(a),1,0,0)},skewY:function(a){return this.append(1,Math.tan(a),0,1,0,0)},shearX:function(a){return this.append(1,0,a,1,0,0)},shearY:function(a){return this.append(1,a,0,1,0,0)},reset:function(){return this.set(1,0,0,1,0,0)},precisionCompensate:function(a,b){var c=this.elements,d=c[0],f=c[1],g=c[2],e=c[3],h=c[4],i=c[5],j=f*g-d*e;b.b=a*f/d;b.c=a*g/e;b.d=a;b.xx=d/a;b.yy=e/a;b.dx=(i*d*g-h*d*e)/j/a;b.dy=(h*f*e-i*d*e)/j/a},precisionCompensateRect:function(a,b){var c=this.elements,d=c[0],e=c[1],j=c[2],f=c[3],h=c[4],i=c[5],g=j/d;b.b=a*e/d;b.c=a*g;b.d=a*f/d;b.xx=d/a;b.yy=d/a;b.dx=(i*j-h*f)/(e*g-f)/a;b.dy=-(i*d-h*e)/(e*g-f)/a},x:function(b,c){var a=this.elements;return b*a[0]+c*a[2]+a[4]},y:function(b,c){var a=this.elements;return b*a[1]+c*a[3]+a[5]},get:function(a,b){return +this.elements[a+b*2].toFixed(4)},transformPoint:function(b){var a=this.elements,c,d;if(b.isPoint){c=b.x;d=b.y}else {c=b[0];d=b[1]}return [c*a[0]+d*a[2]+a[4],c*a[1]+d*a[3]+a[5]]},transformBBox:function(h,e,b){var a=this.elements,p=h.x,q=h.y,d=h.width*0.5,c=h.height*0.5,j=a[0],k=a[1],l=a[2],m=a[3],n=p+d,o=q+c,g,f,i;if(e){d-=e;c-=e;i=[Math.sqrt(a[0]*a[0]+a[2]*a[2]),Math.sqrt(a[1]*a[1]+a[3]*a[3])];g=Math.abs(d*j)+Math.abs(c*l)+Math.abs(i[0]*e);f=Math.abs(d*k)+Math.abs(c*m)+Math.abs(i[1]*e)}else {g=Math.abs(d*j)+Math.abs(c*l);f=Math.abs(d*k)+Math.abs(c*m)}if(!b){b={}}b.x=n*j+o*l+a[4]-g;b.y=n*k+o*m+a[5]-f;b.width=g+g;b.height=f+f;return b},transformList:function(d){var a=this.elements,h=a[0],j=a[2],e=a[4],i=a[1],k=a[3],f=a[5],g=d.length,c,b;for(b=0;b<g;b++){c=d[b];d[b]=[c[0]*h+c[1]*j+e,c[0]*i+c[1]*k+f]}return d},isIdentity:function(){var a=this.elements;return a[0]===1&&a[1]===0&&a[2]===0&&a[3]===1&&a[4]===0&&a[5]===0},isEqual:function(c){var b=c&&c.isMatrix?c.elements:c,a=this.elements;return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]&&a[4]===b[4]&&a[5]===b[5]},equals:function(a){return this.isEqual(a)},toArray:function(){var a=this.elements;return [a[0],a[2],a[4],a[1],a[3],a[5]]},toVerticalArray:function(){return this.elements.slice()},toString:function(){var a=this;return [a.get(0,0),a.get(0,1),a.get(1,0),a.get(1,1),a.get(2,0),a.get(2,1)].join(',')},toContext:function(a){a.transform.apply(a,this.elements);return this},toSvg:function(){var a=this.elements;return 'matrix('+a[0].toFixed(9)+','+a[1].toFixed(9)+','+a[2].toFixed(9)+','+a[3].toFixed(9)+','+a[4].toFixed(9)+','+a[5].toFixed(9)+')'},getScaleX:function(){var a=this.elements;return Math.sqrt(a[0]*a[0]+a[2]*a[2])},getScaleY:function(){var a=this.elements;return Math.sqrt(a[1]*a[1]+a[3]*a[3])},getXX:function(){return this.elements[0]},getXY:function(){return this.elements[1]},getYX:function(){return this.elements[2]},getYY:function(){return this.elements[3]},getDX:function(){return this.elements[4]},getDY:function(){return this.elements[5]},split:function(){var b=this.elements,c=b[0],d=b[1],e=b[3],a={translateX:b[4],translateY:b[5]};a.rotate=a.rotation=Math.atan2(d,c);a.scaleX=c/Math.cos(a.rotate);a.scaleY=e/c*a.scaleX;return a}},3,0,0,0,0,0,[Ext.draw,'Matrix'],function(){function registerName(b,c,a){b[c]={get:function(){return this.elements[a]},set:function(d){this.elements[a]=d}}}if(Object.defineProperties){var a={};registerName(a,'a',0);registerName(a,'b',1);registerName(a,'c',2);registerName(a,'d',3);registerName(a,'e',4);registerName(a,'f',5);Object.defineProperties(this.prototype,a)}this.prototype.multiply=this.prototype.appendMatrix});Ext.cmd.derive('Ext.draw.modifier.Modifier',Ext.Base,{config:{lower:null,upper:null,sprite:null},constructor:function(a){this.mixins.observable.constructor.call(this,a)},updateUpper:function(a){if(a){a.setLower(this)}},updateLower:function(a){if(a){a.setUpper(this)}},prepareAttributes:function(a){if(this._lower){this._lower.prepareAttributes(a)}},popUp:function(a,b){if(this._upper){this._upper.popUp(a,b)}else {Ext.apply(a,b)}},pushDown:function(c,a){if(this._lower){return this._lower.pushDown(c,a)}else {for(var b in a){if(a[b]===c[b]){delete a[b]}}return a}}},1,0,0,0,0,[['observable',Ext.mixin.Observable]],[Ext.draw.modifier,'Modifier'],0);Ext.cmd.derive('Ext.draw.modifier.Target',Ext.draw.modifier.Modifier,{statics:{uniqueId:0},prepareAttributes:function(a){if(this._lower){this._lower.prepareAttributes(a)}a.attributeId='attribute-'+Ext.draw.modifier.Target.uniqueId++;if(!a.hasOwnProperty('canvasAttributes')){a.bbox={plain:{dirty:!0},transform:{dirty:!0}};a.dirty=!0;a.pendingUpdaters={};a.canvasAttributes={};a.matrix=new Ext.draw.Matrix();a.inverseMatrix=new Ext.draw.Matrix()}},applyChanges:function(b,h){Ext.apply(b,h);var f=this.getSprite(),g=b.pendingUpdaters,n=f.self.def.getTriggers(),m,k,e,a,l,d,c,j,i;for(a in h){l=!0;if(m=n[a]){f.scheduleUpdaters(b,m,[a])}if(b.template&&h.removeFromInstance&&h.removeFromInstance[a]){delete b[a]}}if(!l){return}if(g.canvas){d=g.canvas;delete g.canvas;for(c=0,i=d.length;c<i;c++){a=d[c];b.canvasAttributes[a]=b[a]}}if(b.hasOwnProperty('children')){k=b.children;for(c=0,i=k.length;c<i;c++){e=k[c];Ext.apply(e.pendingUpdaters,g);if(d){for(j=0;j<d.length;j++){a=d[j];e.canvasAttributes[a]=e[a]}}f.callUpdaters(e)}}f.setDirty(!0);f.callUpdaters(b)},popUp:function(b,a){this.applyChanges(b,a)},pushDown:function(b,a){if(this._lower){a=this._lower.pushDown(b,a)}this.applyChanges(b,a);return a}},0,0,0,0,['modifier.target'],0,[Ext.draw.modifier,'Target'],0);Ext.cmd.derive('Ext.draw.TimingFunctions',Ext.Base,function(){var b=Math.pow,k=Math.sin,j=Math.cos,i=Math.sqrt,h=Math.PI,f=['quad','cube','quart','quint'],d={pow:function(a,c){return b(a,c||6)},expo:function(a){return b(2,8*(a-1))},circ:function(a){return 1-i(1-a*a)},sine:function(a){return 1-k((1-a)*h/2)},back:function(b,a){a=a||1.616;return b*b*((a+1)*b-a)},bounce:function(d){for(var c=0,a=1;1;c+=a,a/=2){if(d>=(7-4*c)/11){return a*a-b((11-6*c-11*d)/4,2)}}},elastic:function(a,c){return b(2,10*--a)*j(20*a*h*(c||1)/3)}},a={},e,g,c;function createPoly(a){return function(c){return b(c,a)}}function addEasing(c,b){a[c+'In']=function(a){return b(a)};a[c+'Out']=function(a){return 1-b(1-a)};a[c+'InOut']=function(a){return a<=0.5?b(2*a)/2:(2-b(2*(1-a)))/2}}for(c=0,g=f.length;c<g;++c){d[f[c]]=createPoly(c+2)}for(e in d){addEasing(e,d[e])}a.linear=Ext.identityFn;a.easeIn=a.quadIn;a.easeOut=a.quadOut;a.easeInOut=a.quadInOut;return {singleton:!0,easingMap:a}},0,0,0,0,0,0,[Ext.draw,'TimingFunctions'],function(a){Ext.apply(a,a.easingMap)});Ext.cmd.derive('Ext.draw.Animator',Ext.Base,{singleton:!0,frameCallbacks:{},frameCallbackId:0,scheduled:0,frameStartTimeOffset:Ext.now(),animations:[],running:!1,animationTime:function(){return Ext.AnimationQueue.frameStartTime-this.frameStartTimeOffset},add:function(a){var b=this;if(!b.contains(a)){b.animations.push(a);b.ignite();if('fireEvent' in a){a.fireEvent('animationstart',a)}}},remove:function(a){var d=this,c=d.animations,b=0,e=c.length;for(;b<e;++b){if(c[b]===a){c.splice(b,1);if('fireEvent' in a){a.fireEvent('animationend',a)}return}}},contains:function(a){return Ext.Array.indexOf(this.animations,a)>-1},empty:function(){return this.animations.length===0},step:function(e){var f=this,c=f.animations,a,b=0,d=c.length;for(;b<d;b++){a=c[b];a.step(e);if(!a.animating){c.splice(b,1);b--;d--;if(a.fireEvent){a.fireEvent('animationend',a)}}}},schedule:function(a,b){b=b||this;var c='frameCallback'+this.frameCallbackId++;if(Ext.isString(a)){a=b[a]}Ext.draw.Animator.frameCallbacks[c]={fn:a,scope:b,once:!0};this.scheduled++;Ext.draw.Animator.ignite();return c},scheduleIf:function(a,b){b=b||this;var d=Ext.draw.Animator.frameCallbacks,c,e;if(Ext.isString(a)){a=b[a]}for(e in d){c=d[e];if(c.once&&c.fn===a&&c.scope===b){return null}}return this.schedule(a,b)},cancel:function(a){if(Ext.draw.Animator.frameCallbacks[a]&&Ext.draw.Animator.frameCallbacks[a].once){this.scheduled--;delete Ext.draw.Animator.frameCallbacks[a];Ext.draw.Draw.endUpdateIOS()}},clear:function(){this.animations.length=0;this.running=!1;Ext.draw.Animator.frameCallbacks={};Ext.draw.Draw.endUpdateIOS()},addFrameCallback:function(a,b){b=b||this;if(Ext.isString(a)){a=b[a]}var c='frameCallback'+this.frameCallbackId++;Ext.draw.Animator.frameCallbacks[c]={fn:a,scope:b};return c},removeFrameCallback:function(a){delete Ext.draw.Animator.frameCallbacks[a]},fireFrameCallbacks:function(){var c=this.frameCallbacks,d,b,a;for(d in c){a=c[d];b=a.fn;if(Ext.isString(b)){b=a.scope[b]}b.call(a.scope);if(c[d]&&a.once){this.scheduled--;delete c[d]}}},handleFrame:function(){var a=this;a.step(a.animationTime());a.fireFrameCallbacks();if(!a.scheduled&&a.empty()){Ext.AnimationQueue.stop(a.handleFrame,a);a.running=!1;Ext.draw.Draw.endUpdateIOS()}},ignite:function(){if(!this.running){this.running=!0;Ext.AnimationQueue.start(this.handleFrame,this);Ext.draw.Draw.beginUpdateIOS()}}},0,0,0,0,0,0,[Ext.draw,'Animator'],0);Ext.cmd.derive('Ext.draw.modifier.Animation',Ext.draw.modifier.Modifier,{config:{easing:Ext.identityFn,duration:0,customEasings:{},customDurations:{}},constructor:function(b){var a=this;a.anyAnimation=a.anySpecialAnimations=!1;a.animating=0;a.animatingPool=[];Ext.draw.modifier.Modifier.prototype.constructor.call(this,b)},prepareAttributes:function(a){if(!a.hasOwnProperty('timers')){a.animating=!1;a.timers={};a.animationOriginal=Ext.Object.chain(a);a.animationOriginal.prototype=a}if(this._lower){this._lower.prepareAttributes(a.animationOriginal)}},updateSprite:function(a){this.setConfig(a.config.fx)},updateDuration:function(a){this.anyAnimation=a>0},applyEasing:function(a){if(typeof a==='string'){a=Ext.draw.TimingFunctions.easingMap[a]}return a},applyCustomEasings:function(g,b){b=b||{};var e,f,d,a,c,h;for(f in g){e=!0;a=g[f];d=f.split(',');if(typeof a==='string'){a=Ext.draw.TimingFunctions.easingMap[a]}for(c=0,h=d.length;c<h;c++){b[d[c]]=a}}if(e){this.anySpecialAnimations=e}return b},setEasingOn:function(a,d){a=Ext.Array.from(a).slice();var c={},e=a.length,b=0;for(;b<e;b++){c[a[b]]=d}this.setCustomEasings(c)},clearEasingOn:function(a){a=Ext.Array.from(a,!0);var b=0,c=a.length;for(;b<c;b++){delete this._customEasings[a[b]]}},applyCustomDurations:function(f,a){a=a||{};var d,e,g,c,b,h;for(e in f){d=!0;g=f[e];c=e.split(',');for(b=0,h=c.length;b<h;b++){a[c[b]]=g}}if(d){this.anySpecialAnimations=d}return a},setDurationOn:function(a,d){a=Ext.Array.from(a).slice();var c={},b=0,e=a.length;for(;b<e;b++){c[a[b]]=d}this.setCustomDurations(c)},clearDurationOn:function(a){a=Ext.Array.from(a,!0);var b=0,c=a.length;for(;b<c;b++){delete this._customDurations[a[b]]}},setAnimating:function(c,d){var b=this,a=b.animatingPool;if(c.animating!==d){c.animating=d;if(d){a.push(c);if(b.animating===0){Ext.draw.Animator.add(b)}b.animating++}else {for(var e=a.length;e--;){if(a[e]===c){a.splice(e,1)}}b.animating=a.length}}},setAttrs:function(h,c){var g=this,j=h.timers,t=g._sprite.self.def._animationProcessors,s=g._easing,r=g._duration,m=g._customDurations,n=g._customEasings,o=g.anySpecialAnimations,u=g.anyAnimation||o,k=h.animationOriginal,q=!1,b,a,e,d,f,l,i;if(!u){for(a in c){if(h[a]===c[a]){delete c[a]}else {h[a]=c[a]}delete k[a];delete j[a]}return c}else {for(a in c){e=c[a];d=h[a];if(e!==d&&d!==undefined&&d!==null&&(f=t[a])){l=s;i=r;if(o){if(a in n){l=n[a]}if(a in m){i=m[a]}}if(d&&d.isGradient||e&&e.isGradient){i=0}if(i){if(!j[a]){j[a]={}}b=j[a];b.start=0;b.easing=l;b.duration=i;b.compute=f.compute;b.serve=f.serve||Ext.identityFn;b.remove=c.removeFromInstance&&c.removeFromInstance[a];if(f.parseInitial){var p=f.parseInitial(d,e);b.source=p[0];b.target=p[1]}else {if(f.parse){b.source=f.parse(d);b.target=f.parse(e)}else {b.source=d;b.target=e}}k[a]=e;delete c[a];q=!0;continue}else {delete k[a]}}else {delete k[a]}delete j[a]}}if(q&&!h.animating){g.setAnimating(h,!0)}return c},updateAttributes:function(c){if(!c.animating){return {}}var d={},i=!1,e=c.timers,h=c.animationOriginal,g=Ext.draw.Animator.animationTime(),b,a,f;if(c.lastUpdate===g){return null}for(b in e){a=e[b];if(!a.start){a.start=g;f=0}else {f=(g-a.start)/a.duration}if(f>=1){d[b]=h[b];delete h[b];if(e[b].remove){d.removeFromInstance=d.removeFromInstance||{};d.removeFromInstance[b]=!0}delete e[b]}else {d[b]=a.serve(a.compute(a.source,a.target,a.easing(f),c[b]));i=!0}}c.lastUpdate=g;this.setAnimating(c,i);return d},pushDown:function(b,a){a=Ext.draw.modifier.Modifier.prototype.pushDown.call(this,b.animationOriginal,a);return this.setAttrs(b,a)},popUp:function(a,b){a=a.prototype;b=this.setAttrs(a,b);if(this._upper){return this._upper.popUp(a,b)}else {return Ext.apply(a,b)}},step:function(g){var a=this,e=a.animatingPool.slice(),f=e.length,d=0,c,b;for(;d<f;d++){c=e[d];b=a.updateAttributes(c);if(b&&a._upper){a._upper.popUp(c,b)}}},stop:function(){this.step();var a=this,c=a.animatingPool,b,d;for(b=0,d=c.length;b<d;b++){c[b].animating=!1}a.animatingPool.length=0;a.animating=0;Ext.draw.Animator.remove(a)},destroy:function(){Ext.draw.Animator.remove(this);Ext.draw.modifier.Modifier.prototype.destroy.call(this)}},1,0,0,0,['modifier.animation'],0,[Ext.draw.modifier,'Animation'],0);Ext.cmd.derive('Ext.draw.modifier.Highlight',Ext.draw.modifier.Modifier,{config:{enabled:!1,highlightStyle:null},preFx:!0,applyHighlightStyle:function(b,a){a=a||{};if(this.getSprite()){Ext.apply(a,this.getSprite().self.def.normalize(b))}else {Ext.apply(a,b)}return a},prepareAttributes:function(a){if(!a.hasOwnProperty('highlightOriginal')){a.highlighted=!1;a.highlightOriginal=Ext.Object.chain(a);a.highlightOriginal.prototype=a;a.highlightOriginal.removeFromInstance={}}if(this._lower){this._lower.prepareAttributes(a.highlightOriginal)}},updateSprite:function(a,b){if(a){if(this.getHighlightStyle()){this._highlightStyle=a.self.def.normalize(this.getHighlightStyle())}this.setHighlightStyle(a.config.highlight)}a.self.def.setConfig({defaults:{highlighted:!1},processors:{highlighted:'bool'}});this.setSprite(a)},filterChanges:function(c,b){var f=this,d=c.highlightOriginal,e=f.getHighlightStyle(),a;if(c.highlighted){for(a in b){if(e.hasOwnProperty(a)){d[a]=b[a];delete b[a]}}}return b},pushDown:function(d,a){var e=this.getHighlightStyle(),c=d.highlightOriginal,g=c.removeFromInstance,f,b,h,i;if(a.hasOwnProperty('highlighted')){f=a.highlighted;delete a.highlighted;if(this._lower){a=this._lower.pushDown(c,a)}a=this.filterChanges(d,a);if(f!==d.highlighted){if(f){for(b in e){if(b in a){c[b]=a[b]}else {h=d.template&&d.template.ownAttr;if(h&&!d.prototype.hasOwnProperty(b)){g[b]=!0;c[b]=h.animationOriginal[b]}else {i=c.timers[b];if(i&&i.remove){g[b]=!0}c[b]=d[b]}}if(c[b]!==e[b]){a[b]=e[b]}}}else {for(b in e){if(!(b in a)){a[b]=c[b]}delete c[b]}a.removeFromInstance=a.removeFromInstance||{};Ext.apply(a.removeFromInstance,g);c.removeFromInstance={}}a.highlighted=f}}else {if(this._lower){a=this._lower.pushDown(c,a)}a=this.filterChanges(d,a)}return a},popUp:function(b,a){a=this.filterChanges(b,a);Ext.draw.modifier.Modifier.prototype.popUp.call(this,b,a)}},0,0,0,0,['modifier.highlight'],0,[Ext.draw.modifier,'Highlight'],0);Ext.cmd.derive('Ext.draw.sprite.Sprite',Ext.Base,{isSprite:!0,statics:{defaultHitTestOptions:{fill:!0,stroke:!0}},inheritableStatics:{def:{processors:{strokeStyle:'color',fillStyle:'color',strokeOpacity:'limited01',fillOpacity:'limited01',lineWidth:'number',lineCap:'enums(butt,round,square)',lineJoin:'enums(round,bevel,miter)',lineDash:'data',lineDashOffset:'number',miterLimit:'number',shadowColor:'color',shadowOffsetX:'number',shadowOffsetY:'number',shadowBlur:'number',globalAlpha:'limited01',globalCompositeOperation:'enums(source-over,destination-over,source-in,destination-in,source-out,destination-out,source-atop,destination-atop,lighter,xor,copy)',hidden:'bool',transformFillStroke:'bool',zIndex:'number',translationX:'number',translationY:'number',rotationRads:'number',rotationCenterX:'number',rotationCenterY:'number',scalingX:'number',scalingY:'number',scalingCenterX:'number',scalingCenterY:'number',constrainGradients:'bool'},aliases:{'stroke':'strokeStyle','fill':'fillStyle','color':'fillStyle','stroke-width':'lineWidth','stroke-linecap':'lineCap','stroke-linejoin':'lineJoin','stroke-miterlimit':'miterLimit','text-anchor':'textAlign','opacity':'globalAlpha',translateX:'translationX',translateY:'translationY',rotateRads:'rotationRads',rotateCenterX:'rotationCenterX',rotateCenterY:'rotationCenterY',scaleX:'scalingX',scaleY:'scalingY',scaleCenterX:'scalingCenterX',scaleCenterY:'scalingCenterY'},defaults:{hidden:!1,zIndex:0,strokeStyle:'none',fillStyle:'none',lineWidth:1,lineDash:[],lineDashOffset:0,lineCap:'butt',lineJoin:'miter',miterLimit:10,shadowColor:'none',shadowOffsetX:0,shadowOffsetY:0,shadowBlur:0,globalAlpha:1,strokeOpacity:1,fillOpacity:1,transformFillStroke:!1,translationX:0,translationY:0,rotationRads:0,rotationCenterX:null,rotationCenterY:null,scalingX:1,scalingY:1,scalingCenterX:null,scalingCenterY:null,constrainGradients:!1},triggers:{zIndex:'zIndex',globalAlpha:'canvas',globalCompositeOperation:'canvas',transformFillStroke:'canvas',strokeStyle:'canvas',fillStyle:'canvas',strokeOpacity:'canvas',fillOpacity:'canvas',lineWidth:'canvas',lineCap:'canvas',lineJoin:'canvas',lineDash:'canvas',lineDashOffset:'canvas',miterLimit:'canvas',shadowColor:'canvas',shadowOffsetX:'canvas',shadowOffsetY:'canvas',shadowBlur:'canvas',translationX:'transform',translationY:'transform',rotationRads:'transform',rotationCenterX:'transform',rotationCenterY:'transform',scalingX:'transform',scalingY:'transform',scalingCenterX:'transform',scalingCenterY:'transform',constrainGradients:'canvas'},updaters:{bbox:'bboxUpdater',zIndex:function(a){a.dirtyZIndex=!0},transform:function(a){a.dirtyTransform=!0;a.bbox.transform.dirty=!0}}}},config:{parent:null,surface:null},onClassExtended:function(a,b){var c=a.superclass.self.def.initialConfig,d=b.inheritableStatics&&b.inheritableStatics.def,e;if(d){e=Ext.Object.merge({},c,d);a.def=new Ext.draw.sprite.AttributeDefinition(e);delete b.inheritableStatics.def}else {a.def=new Ext.draw.sprite.AttributeDefinition(c)}a.def.spriteClass=a},constructor:function(b){var a=this,d=a.self.def,e=d.getDefaults(),c;b=Ext.isObject(b)?b:{};a.id=b.id||Ext.id(null,'ext-sprite-');a.attr={};a.mixins.observable.constructor.apply(a,arguments);c=Ext.Array.from(b.modifiers,!0);a.prepareModifiers(c);a.initializeAttributes();a.setAttributes(e,!0);a.setAttributes(b)},updateSurface:function(b,a){if(a){a.remove(this)}},getDirty:function(){return this.attr.dirty},setDirty:function(b){this.attr.dirty=b;if(b){var a=this.getParent();if(a){a.setDirty(!0)}}},addModifier:function(a,c){var b=this;if(!(a instanceof Ext.draw.modifier.Modifier)){a=Ext.factory(a,null,null,'modifier')}a.setSprite(b);if(a.preFx||a.config&&a.config.preFx){if(b.fx._lower){b.fx._lower.setUpper(a)}a.setUpper(b.fx)}else {b.topModifier._lower.setUpper(a);a.setUpper(b.topModifier)}if(c){b.initializeAttributes()}return a},prepareModifiers:function(c){var a=this,b,d;a.topModifier=new Ext.draw.modifier.Target({sprite:a});a.fx=new Ext.draw.modifier.Animation({sprite:a});a.fx.setUpper(a.topModifier);for(b=0,d=c.length;b<d;b++){a.addModifier(c[b],!1)}},getAnimation:function(){return this.fx},setAnimation:function(a){this.fx.setConfig(a)},initializeAttributes:function(){this.topModifier.prepareAttributes(this.attr)},callUpdaters:function(d){d=d||this.attr;var b=this,f=d.pendingUpdaters,i=b.self.def.getUpdaters(),e=!1,g=!1,h,c,a;b.callUpdaters=Ext.emptyFn;do{e=!1;for(c in f){e=!0;h=f[c];delete f[c];a=i[c];if(typeof a==='string'){a=b[a]}if(a){a.call(b,d,h)}}g=g||e}while(e);delete b.callUpdaters;if(g){b.setDirty(!0)}},callUpdater:function(a,c,b){this.scheduleUpdater(a,c,b);this.callUpdaters(a)},scheduleUpdaters:function(d,c,b){var a;d=d||this.attr;if(b){for(var e=0,f=c.length;e<f;e++){a=c[e];this.scheduleUpdater(d,a,b)}}else {for(a in c){b=c[a];this.scheduleUpdater(d,a,b)}}},scheduleUpdater:function(d,c,a){a=a||[];d=d||this.attr;var b=d.pendingUpdaters;if(c in b){if(a.length){b[c]=Ext.Array.merge(b[c],a)}}else {b[c]=a}},setAttributes:function(b,d,e){var c=this,a;if(d){if(e){a=b}else {a=Ext.apply({},b)}}else {a=c.self.def.normalize(b)}c.topModifier.pushDown(c.attr,a)},setAttributesBypassingNormalization:function(b,a){return this.setAttributes(b,!0,a)},bboxUpdater:function(a){var d=a.rotationRads!==0,e=a.scalingX!==1||a.scalingY!==1,b=a.rotationCenterX===null||a.rotationCenterY===null,c=a.scalingCenterX===null||a.scalingCenterY===null;a.bbox.plain.dirty=!0;a.bbox.transform.dirty=!0;if(d&&b||e&&c){this.scheduleUpdater(a,'transform')}},getBBox:function(e){var c=this,f=c.attr,d=f.bbox,a=d.plain,b=d.transform;if(a.dirty){c.updatePlainBBox(a);a.dirty=!1}if(!e){c.applyTransformations();if(b.dirty){c.updateTransformedBBox(b,a);b.dirty=!1}return b}return a},updatePlainBBox:Ext.emptyFn,updateTransformedBBox:function(a,b){this.attr.matrix.transformBBox(b,0,a)},getBBoxCenter:function(b){var a=this.getBBox(b);if(a){return [a.x+a.width*0.5,a.y+a.height*0.5]}else {return [0,0]}},hide:function(){this.attr.hidden=!0;this.setDirty(!0);return this},show:function(){this.attr.hidden=!1;this.setDirty(!0);return this},useAttributes:function(a,i){this.applyTransformations(this.isSpriteInstance);var h=this.attr,b=h.canvasAttributes,d=b.strokeStyle,e=b.fillStyle,g=b.lineDash,f=b.lineDashOffset,c;if(d){if(d.isGradient){a.strokeStyle='black';a.strokeGradient=d}else {a.strokeGradient=!1}}if(e){if(e.isGradient){a.fillStyle='black';a.fillGradient=e}else {a.fillGradient=!1}}if(g){a.setLineDash(g)}if(Ext.isNumber(f)&&Ext.isNumber(a.lineDashOffset)){a.lineDashOffset=f}for(c in b){if(b[c]!==undefined&&b[c]!==a[c]){a[c]=b[c]}}this.setGradientBBox(a,i)},setGradientBBox:function(c,a){var b=this.attr;if(b.constrainGradients){c.setGradientBBox({x:a[0],y:a[1],width:a[2],height:a[3]})}else {c.setGradientBBox(this.getBBox(b.transformFillStroke))}},applyTransformations:function(q){if(!q&&!this.attr.dirtyTransform){return}var p=this,a=p.attr,m=p.getBBoxCenter(!0),k=m[0],l=m[1],r=a.translationX,s=a.translationY,d=a.scalingX,e=a.scalingY===null?a.scalingX:a.scalingY,n=a.scalingCenterX===null?k:a.scalingCenterX,o=a.scalingCenterY===null?l:a.scalingCenterY,h=a.rotationRads,i=a.rotationCenterX===null?k:a.rotationCenterX,j=a.rotationCenterY===null?l:a.rotationCenterY,b=Math.cos(h),c=Math.sin(h),f,g;if(d===1&&e===1){n=0;o=0}if(h===0){i=0;j=0}f=n*(1-d)-i;g=o*(1-e)-j;a.matrix.elements=[b*d,c*d,-c*e,b*e,b*f-c*g+i+r,c*f+b*g+j+s];a.matrix.inverse(a.inverseMatrix);a.dirtyTransform=!1;a.bbox.transform.dirty=!0},transform:function(a,e){var b=this.attr,c=b.matrix,d;if(a&&a.isMatrix){d=a.elements}else {d=a}c.prepend.apply(c,d.slice());c.inverse(b.inverseMatrix);if(e){this.updateTransformAttributes()}b.dirtyTransform=!1;b.bbox.transform.dirty=!0;this.setDirty(!0);return this},updateTransformAttributes:function(){var a=this.attr,b=a.matrix.split();a.rotationRads=b.rotate;a.rotationCenterX=0;a.rotationCenterY=0;a.scalingX=b.scaleX;a.scalingY=b.scaleY;a.scalingCenterX=0;a.scalingCenterY=0;a.translationX=b.translateX;a.translationY=b.translateY},resetTransform:function(b){var a=this.attr;a.matrix.reset();a.inverseMatrix.reset();if(!b){this.updateTransformAttributes()}a.dirtyTransform=!1;a.bbox.transform.dirty=!0;this.setDirty(!0);return this},setTransform:function(b,a){this.resetTransform(!0);this.transform.call(this,b,a);return this},preRender:Ext.emptyFn,render:Ext.emptyFn,hitTest:function(b,f){if(this.isVisible()){var c=b[0],d=b[1],a=this.getBBox(),e=a&&c>=a.x&&c<=a.x+a.width&&d>=a.y&&d<=a.y+a.height;if(e){return {sprite:this}}}return null},isVisible:function(){var a=this.attr,b=this.getParent(),e=b&&(b.isSurface||b.isVisible()),h=e&&!a.hidden&&a.globalAlpha,c=Ext.util.Color.NONE,d=Ext.util.Color.RGBA_NONE,g=a.fillOpacity&&a.fillStyle!==c&&a.fillStyle!==d,f=a.strokeOpacity&&a.strokeStyle!==c&&a.strokeStyle!==d,i=h&&(g||f);return !!i},repaint:function(){var a=this.getSurface();if(a){a.renderFrame()}},remove:function(){var a=this.getSurface();if(a&&a.isSurface){return a.remove(this)}return null},destroy:function(){var a=this,b=a.topModifier,c;while(b){c=b;b=b._lower;c.destroy()}delete a.attr;a.remove();if(a.fireEvent('beforedestroy',a)!==!1){a.fireEvent('destroy',a)}a.callParent()}},1,0,0,0,['sprite.sprite'],[['observable',Ext.mixin.Observable]],[Ext.draw.sprite,'Sprite'],function(){this.def=new Ext.draw.sprite.AttributeDefinition(this.def);this.def.spriteClass=this});Ext.cmd.derive('Ext.draw.Path',Ext.Base,{statics:{pathRe:/,?([achlmqrstvxz]),?/gi,pathRe2:/-/gi,pathSplitRe:/\s|,/g},svgString:'',constructor:function(b){var a=this;a.commands=[];a.params=[];a.cursor=null;a.startX=0;a.startY=0;if(b){a.fromSvgString(b)}},clear:function(){var a=this;a.params.length=0;a.commands.length=0;a.cursor=null;a.startX=0;a.startY=0;a.dirt()},dirt:function(){this.svgString=''},moveTo:function(b,c){var a=this;if(!a.cursor){a.cursor=[b,c]}a.params.push(b,c);a.commands.push('M');a.startX=b;a.startY=c;a.cursor[0]=b;a.cursor[1]=c;a.dirt()},lineTo:function(b,c){var a=this;if(!a.cursor){a.cursor=[b,c];a.params.push(b,c);a.commands.push('M')}else {a.params.push(b,c);a.commands.push('L')}a.cursor[0]=b;a.cursor[1]=c;a.dirt()},bezierCurveTo:function(b,c,f,g,d,e){var a=this;if(!a.cursor){a.moveTo(b,c)}a.params.push(b,c,f,g,d,e);a.commands.push('C');a.cursor[0]=d;a.cursor[1]=e;a.dirt()},quadraticCurveTo:function(b,c,d,e){var a=this;if(!a.cursor){a.moveTo(b,c)}a.bezierCurveTo((2*b+a.cursor[0])/3,(2*c+a.cursor[1])/3,(2*b+d)/3,(2*c+e)/3,d,e)},closePath:function(){var a=this;if(a.cursor){a.cursor=null;a.commands.push('Z');a.dirt()}},arcTo:function(l,m,e,f,d,b,n){var i=this;if(b===undefined){b=d}if(n===undefined){n=0}if(!i.cursor){i.moveTo(l,m);return}if(d===0||b===0){i.lineTo(l,m);return}e-=l;f-=m;var g=i.cursor[0]-l,h=i.cursor[1]-m,q=e*h-f*g,j,k,x,z,y,A,v=Math.sqrt(g*g+h*h),w=Math.sqrt(e*e+f*f),t,c,a;if(q===0){i.lineTo(l,m);return}if(b!==d){j=Math.cos(n);k=Math.sin(n);x=j/d;z=k/b;y=-k/d;A=j/b;var u=x*g+z*h;h=y*g+A*h;g=u;u=x*e+z*f;f=y*e+A*f;e=u}else {g/=d;h/=b;e/=d;f/=b}c=g*w+e*v;a=h*w+f*v;t=1/(Math.sin(Math.asin(Math.abs(q)/(v*w))*0.5)*Math.sqrt(c*c+a*a));c*=t;a*=t;var B=(c*g+a*h)/(g*g+h*h),C=(c*e+a*f)/(e*e+f*f);var r=g*B-c,s=h*B-a,D=e*C-c,E=f*C-a,o=Math.atan2(s,r),p=Math.atan2(E,D);if(q>0){if(p<o){p+=Math.PI*2}}else {if(o<p){o+=Math.PI*2}}if(b!==d){c=j*c*d-k*a*b+l;a=k*a*b+j*a*b+m;i.lineTo(j*d*r-k*b*s+c,k*d*r+j*b*s+a);i.ellipse(c,a,d,b,n,o,p,q<0)}else {c=c*d+l;a=a*b+m;i.lineTo(d*r+c,b*s+a);i.ellipse(c,a,d,b,n,o,p,q<0)}},ellipse:function(j,k,h,i,g,d,e,l){var b=this,a=b.params,o=a.length,m,c,f;if(e-d>=Math.PI*2){b.ellipse(j,k,h,i,g,d,d+Math.PI,l);b.ellipse(j,k,h,i,g,d+Math.PI,e,l);return}if(!l){if(e<d){e+=Math.PI*2}m=b.approximateArc(a,j,k,h,i,g,d,e)}else {if(d<e){d+=Math.PI*2}m=b.approximateArc(a,j,k,h,i,g,e,d);for(c=o,f=a.length-2;c<f;c+=2,f-=2){var n=a[c];a[c]=a[f];a[f]=n;n=a[c+1];a[c+1]=a[f+1];a[f+1]=n}}if(!b.cursor){b.cursor=[a[a.length-2],a[a.length-1]];b.commands.push('M')}else {b.cursor[0]=a[a.length-2];b.cursor[1]=a[a.length-1];b.commands.push('L')}for(c=2;c<m;c+=6){b.commands.push('C')}b.dirt()},arc:function(e,f,a,c,d,b){this.ellipse(e,f,a,a,0,c,d,b)},rect:function(b,c,e,d){if(e==0||d==0){return}var a=this;a.moveTo(b,c);a.lineTo(b+e,c);a.lineTo(b+e,c+d);a.lineTo(b,c+d);a.closePath()},approximateArc:function(s,f,g,q,r,y,t,a){var m=Math.cos(y),n=Math.sin(y),k=Math.cos(t),l=Math.sin(t),z=m*k*q-n*l*r,B=-m*l*q-n*k*r,A=n*k*q+m*l*r,C=-n*l*q+m*k*r,x=Math.PI/2,u=2,d=z,b=B,e=A,c=C,p=0.547443256150549,o,i,h,j,v,w;a-=t;if(a<0){a+=Math.PI*2}s.push(z+f,A+g);while(a>=x){s.push(d+b*p+f,e+c*p+g,d*p+b+f,e*p+c+g,b+f,c+g);u+=6;a-=x;o=d;d=b;b=-o;o=e;e=c;c=-o}if(a){i=(0.3294738052815987+0.012120855841304373*a)*a;h=Math.cos(a);j=Math.sin(a);v=h+i*j;w=j-i*h;s.push(d+b*i+f,e+c*i+g,d*v+b*w+f,e*v+c*w+g,d*h+b*j+f,e*h+c*j+g);u+=6}return u},arcSvg:function(b,c,i,y,m,v,x){if(b<0){b=-b}if(c<0){c=-c}var n=this,u=n.cursor[0],w=n.cursor[1],q=(u-v)/2,r=(w-x)/2,g=Math.cos(i),h=Math.sin(i),o=q*g+r*h,p=-q*h+r*g,k=o/b,l=p/c,a=k*k+l*l,s=(u+v)*0.5,t=(w+x)*0.5,e=0,f=0;if(a>=1){a=Math.sqrt(a);b*=a;c*=a}else {a=Math.sqrt(1/a-1);if(y===m){a=-a}e=a*b*l;f=-a*c*k;s+=g*e-h*f;t+=h*e+g*f}var j=Math.atan2((p-f)/c,(o-e)/b),d=Math.atan2((-p-f)/c,(-o-e)/b)-j;if(m){if(d<=0){d+=Math.PI*2}}else {if(d>=0){d-=Math.PI*2}}n.ellipse(s,t,b,c,i,j,j+d,1-m)},fromSvgString:function(k){if(!k){return}var e=this,b,g={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0,A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},h='',i,j,c=0,d=0,l=!1,a,f,m;if(Ext.isString(k)){b=k.replace(Ext.draw.Path.pathRe,' $1 ').replace(Ext.draw.Path.pathRe2,' -').split(Ext.draw.Path.pathSplitRe)}else {if(Ext.isArray(k)){b=k.join(',').split(Ext.draw.Path.pathSplitRe)}}for(a=0,f=0;a<b.length;a++){if(b[a]!==''){b[f++]=b[a]}}b.length=f;e.clear();for(a=0;a<b.length;){h=l;l=b[a];m=l.toUpperCase()!==l;a++;switch(l){case 'M':e.moveTo(c=+b[a],d=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c=+b[a],d=+b[a+1]);a+=2};break;case 'L':e.lineTo(c=+b[a],d=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c=+b[a],d=+b[a+1]);a+=2};break;case 'A':while(a<f&&!g.hasOwnProperty(b[a])){e.arcSvg(+b[a],+b[a+1],+b[a+2]*Math.PI/180,+b[a+3],+b[a+4],c=+b[a+5],d=+b[a+6]);a+=7};break;case 'C':while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(+b[a],+b[a+1],i=+b[a+2],j=+b[a+3],c=+b[a+4],d=+b[a+5]);a+=6};break;case 'Z':e.closePath();break;case 'm':e.moveTo(c+=+b[a],d+=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c+=+b[a],d+=+b[a+1]);a+=2};break;case 'l':e.lineTo(c+=+b[a],d+=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c+=+b[a],d+=+b[a+1]);a+=2};break;case 'a':while(a<f&&!g.hasOwnProperty(b[a])){e.arcSvg(+b[a],+b[a+1],+b[a+2]*Math.PI/180,+b[a+3],+b[a+4],c+=+b[a+5],d+=+b[a+6]);a+=7};break;case 'c':while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(c+ +b[a],d+ +b[a+1],i=c+ +b[a+2],j=d+ +b[a+3],c+=+b[a+4],d+=+b[a+5]);a+=6};break;case 'z':e.closePath();break;case 's':if(!(h==='c'||h==='C'||h==='s'||h==='S')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(c+c-i,d+d-j,i=c+ +b[a],j=d+ +b[a+1],c+=+b[a+2],d+=+b[a+3]);a+=4};break;case 'S':if(!(h==='c'||h==='C'||h==='s'||h==='S')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(c+c-i,d+d-j,i=+b[a],j=+b[a+1],c=+b[a+2],d=+b[a+3]);a+=4};break;case 'q':while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=c+ +b[a],j=d+ +b[a+1],c+=+b[a+2],d+=+b[a+3]);a+=4};break;case 'Q':while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=+b[a],j=+b[a+1],c=+b[a+2],d=+b[a+3]);a+=4};break;case 't':if(!(h==='q'||h==='Q'||h==='t'||h==='T')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=c+c-i,j=d+d-j,c+=+b[a+1],d+=+b[a+2]);a+=2};break;case 'T':if(!(h==='q'||h==='Q'||h==='t'||h==='T')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=c+c-i,j=d+d-j,c=+b[a+1],d=+b[a+2]);a+=2};break;case 'h':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c+=+b[a],d);a++};break;case 'H':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c=+b[a],d);a++};break;case 'v':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c,d+=+b[a]);a++};break;case 'V':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c,d=+b[a]);a++};break;}}},clone:function(){var b=this,a=new Ext.draw.Path();a.params=b.params.slice(0);a.commands=b.commands.slice(0);a.cursor=b.cursor?b.cursor.slice(0):null;a.startX=b.startX;a.startY=b.startY;a.svgString=b.svgString;return a},transform:function(a){if(a.isIdentity()){return}var i=a.getXX(),k=a.getYX(),f=a.getDX(),j=a.getXY(),l=a.getYY(),g=a.getDY(),c=this.params,b=0,h=c.length,d,e;for(;b<h;b+=2){d=c[b];e=c[b+1];c[b]=d*i+e*k+f;c[b+1]=d*j+e*l+g}this.dirt()},getDimension:function(a){if(!a){a={}}if(!this.commands||!this.commands.length){a.x=0;a.y=0;a.width=0;a.height=0;return a}a.left=Infinity;a.top=Infinity;a.right=-Infinity;a.bottom=-Infinity;var f=0,b=0,g=this.commands,c=this.params,h=g.length,d,e;for(;f<h;f++){switch(g[f]){case 'M':case 'L':d=c[b];e=c[b+1];a.left=Math.min(d,a.left);a.top=Math.min(e,a.top);a.right=Math.max(d,a.right);a.bottom=Math.max(e,a.bottom);b+=2;break;case 'C':this.expandDimension(a,d,e,c[b],c[b+1],c[b+2],c[b+3],d=c[b+4],e=c[b+5]);b+=6;break;}}a.x=a.left;a.y=a.top;a.width=a.right-a.left;a.height=a.bottom-a.top;return a},getDimensionWithTransform:function(d,a){if(!this.commands||!this.commands.length){if(!a){a={}}a.x=0;a.y=0;a.width=0;a.height=0;return a}a.left=Infinity;a.top=Infinity;a.right=-Infinity;a.bottom=-Infinity;var i=d.getXX(),k=d.getYX(),g=d.getDX(),j=d.getXY(),l=d.getYY(),h=d.getDY(),m=0,b=0,n=this.commands,c=this.params,o=n.length,e,f;for(;m<o;m++){switch(n[m]){case 'M':case 'L':e=c[b]*i+c[b+1]*k+g;f=c[b]*j+c[b+1]*l+h;a.left=Math.min(e,a.left);a.top=Math.min(f,a.top);a.right=Math.max(e,a.right);a.bottom=Math.max(f,a.bottom);b+=2;break;case 'C':this.expandDimension(a,e,f,c[b]*i+c[b+1]*k+g,c[b]*j+c[b+1]*l+h,c[b+2]*i+c[b+3]*k+g,c[b+2]*j+c[b+3]*l+h,e=c[b+4]*i+c[b+5]*k+g,f=c[b+4]*j+c[b+5]*l+h);b+=6;break;}}if(!a){a={}}a.x=a.left;a.y=a.top;a.width=a.right-a.left;a.height=a.bottom-a.top;return a},expandDimension:function(a,l,n,h,j,i,k,m,o){var c=this,e=a.left,f=a.right,g=a.top,d=a.bottom,b=c.dim||(c.dim=[]);c.curveDimension(l,h,i,m,b);e=Math.min(e,b[0]);f=Math.max(f,b[1]);c.curveDimension(n,j,k,o,b);g=Math.min(g,b[0]);d=Math.max(d,b[1]);a.left=e;a.right=f;a.top=g;a.bottom=d},curveDimension:function(e,g,j,h,k){var l=3*(-e+3*(g-j)+h),i=6*(e-2*g+j),m=-3*(e-g),a,b,d=Math.min(e,h),c=Math.max(e,h),f;if(l===0){if(i===0){k[0]=d;k[1]=c;return}else {a=-m/i;if(0<a&&a<1){b=this.interpolate(e,g,j,h,a);d=Math.min(d,b);c=Math.max(c,b)}}}else {f=i*i-4*l*m;if(f>=0){f=Math.sqrt(f);a=(f-i)/2/l;if(0<a&&a<1){b=this.interpolate(e,g,j,h,a);d=Math.min(d,b);c=Math.max(c,b)}if(f>0){a-=f/l;if(0<a&&a<1){b=this.interpolate(e,g,j,h,a);d=Math.min(d,b);c=Math.max(c,b)}}}}k[0]=d;k[1]=c},interpolate:function(c,e,f,d,a){if(a===0){return c}if(a===1){return d}var b=(1-a)/a;return a*a*a*(d+b*(3*f+b*(3*e+b*c)))},fromStripes:function(e){var a=this,c=0,g=e.length,d,f,b;a.clear();for(;c<g;c++){b=e[c];a.params.push.apply(a.params,b);a.commands.push('M');for(d=2,f=b.length;d<f;d+=6){a.commands.push('C')}}if(!a.cursor){a.cursor=[]}a.cursor[0]=a.params[a.params.length-2];a.cursor[1]=a.params[a.params.length-1];a.dirt()},toStripes:function(m){var j=m||[],g,e,f,c,d,k,l,h,a,i=this.commands,b=this.params,n=i.length;for(h=0,a=0;h<n;h++){switch(i[h]){case 'M':g=[k=c=b[a++],l=d=b[a++]];j.push(g);break;case 'L':e=b[a++];f=b[a++];g.push((c+c+e)/3,(d+d+f)/3,(c+e+e)/3,(d+f+f)/3,c=e,d=f);break;case 'C':g.push(b[a++],b[a++],b[a++],b[a++],c=b[a++],d=b[a++]);break;case 'Z':e=k;f=l;g.push((c+c+e)/3,(d+d+f)/3,(c+e+e)/3,(d+f+f)/3,c=e,d=f);break;}}return j},updateSvgString:function(){var c=[],e=this.commands,b=this.params,f=e.length,d=0,a=0;for(;d<f;d++){switch(e[d]){case 'M':c.push('M'+b[a]+','+b[a+1]);a+=2;break;case 'L':c.push('L'+b[a]+','+b[a+1]);a+=2;break;case 'C':c.push('C'+b[a]+','+b[a+1]+' '+b[a+2]+','+b[a+3]+' '+b[a+4]+','+b[a+5]);a+=6;break;case 'Z':c.push('Z');break;}}this.svgString=c.join('')},toString:function(){if(!this.svgString){this.updateSvgString()}return this.svgString}},3,0,0,0,0,0,[Ext.draw,'Path'],0);Ext.define('Ext.draw.overrides.hittest.Path',{override:'Ext.draw.Path',rayOrigin:{x:-10000,y:-10000},isPointInPath:function(j,k){var m=this,n=m.commands,h=Ext.draw.PathUtil,c=m.rayOrigin,b=m.params,o=n.length,f=null,l=null,d=0,e=0,g=0,i,a;for(i=0,a=0;i<o;i++){switch(n[i]){case 'M':if(f!==null){if(h.linesIntersection(f,l,d,e,c.x,c.y,j,k)){g+=1}};f=d=b[a];l=e=b[a+1];a+=2;break;case 'L':if(h.linesIntersection(d,e,b[a],b[a+1],c.x,c.y,j,k)){g+=1};d=b[a];e=b[a+1];a+=2;break;case 'C':g+=h.cubicLineIntersections(d,b[a],b[a+2],b[a+4],e,b[a+1],b[a+3],b[a+5],c.x,c.y,j,k).length;d=b[a+4];e=b[a+5];a+=6;break;case 'Z':if(f!==null){if(h.linesIntersection(f,l,d,e,c.x,c.y,j,k)){g+=1}};break;}}return g%2===1},isPointOnPath:function(h,i){var l=this,k=l.commands,f=Ext.draw.PathUtil,b=l.params,m=k.length,e=null,j=null,c=0,d=0,g,a;for(g=0,a=0;g<m;g++){switch(k[g]){case 'M':if(e!==null){if(f.pointOnLine(e,j,c,d,h,i)){return !0}};e=c=b[a];j=d=b[a+1];a+=2;break;case 'L':if(f.pointOnLine(c,d,b[a],b[a+1],h,i)){return !0};c=b[a];d=b[a+1];a+=2;break;case 'C':if(f.pointOnCubic(c,b[a],b[a+2],b[a+4],d,b[a+1],b[a+3],b[a+5],h,i)){return !0};c=b[a+4];d=b[a+5];a+=6;break;case 'Z':if(e!==null){if(f.pointOnLine(e,j,c,d,h,i)){return !0}};break;}}return !1},getSegmentIntersections:function(h,j,i,k,o,q,p,r){var u=this,n=arguments.length,g=Ext.draw.PathUtil,t=u.commands,b=u.params,v=t.length,l=null,m=null,e=0,f=0,d=[],s,a,c;for(s=0,a=0;s<v;s++){switch(t[s]){case 'M':if(l!==null){switch(n){case 4:c=g.linesIntersection(l,m,e,f,h,j,i,k);if(c){d.push(c)};break;case 8:c=g.cubicLineIntersections(h,i,o,p,j,k,q,r,l,m,e,f);d.push.apply(d,c);break;}};l=e=b[a];m=f=b[a+1];a+=2;break;case 'L':switch(n){case 4:c=g.linesIntersection(e,f,b[a],b[a+1],h,j,i,k);if(c){d.push(c)};break;case 8:c=g.cubicLineIntersections(h,i,o,p,j,k,q,r,e,f,b[a],b[a+1]);d.push.apply(d,c);break;};e=b[a];f=b[a+1];a+=2;break;case 'C':switch(n){case 4:c=g.cubicLineIntersections(e,b[a],b[a+2],b[a+4],f,b[a+1],b[a+3],b[a+5],h,j,i,k);d.push.apply(d,c);break;case 8:c=g.cubicsIntersections(e,b[a],b[a+2],b[a+4],f,b[a+1],b[a+3],b[a+5],h,i,o,p,j,k,q,r);d.push.apply(d,c);break;};e=b[a+4];f=b[a+5];a+=6;break;case 'Z':if(l!==null){switch(n){case 4:c=g.linesIntersection(l,m,e,f,h,j,i,k);if(c){d.push(c)};break;case 8:c=g.cubicLineIntersections(h,i,o,p,j,k,q,r,l,m,e,f);d.push.apply(d,c);break;}};break;}}return d},getIntersections:function(e){var l=this,k=l.commands,b=l.params,m=k.length,h=null,j=null,f=0,g=0,c=[],i,a,d;for(i=0,a=0;i<m;i++){switch(k[i]){case 'M':if(h!==null){d=e.getSegmentIntersections.call(e,h,j,f,g);c.push.apply(c,d)};h=f=b[a];j=g=b[a+1];a+=2;break;case 'L':d=e.getSegmentIntersections.call(e,f,g,b[a],b[a+1]);c.push.apply(c,d);f=b[a];g=b[a+1];a+=2;break;case 'C':d=e.getSegmentIntersections.call(e,f,g,b[a],b[a+1],b[a+2],b[a+3],b[a+4],b[a+5]);c.push.apply(c,d);f=b[a+4];g=b[a+5];a+=6;break;case 'Z':if(h!==null){d=e.getSegmentIntersections.call(e,h,j,f,g);c.push.apply(c,d)};break;}}return c}});Ext.cmd.derive('Ext.draw.sprite.Path',Ext.draw.sprite.Sprite,{type:'path',isPath:!0,inheritableStatics:{def:{processors:{path:function(a,b){if(!(a instanceof Ext.draw.Path)){a=new Ext.draw.Path(a)}return a}},aliases:{d:'path'},triggers:{path:'bbox'},updaters:{path:function(b){var a=b.path;if(!a||a.bindAttr!==b){a=new Ext.draw.Path();a.bindAttr=b;b.path=a}a.clear();this.updatePath(a,b);this.scheduleUpdater(b,'bbox',['path'])}}}},updatePlainBBox:function(a){if(this.attr.path){this.attr.path.getDimension(a)}},updateTransformedBBox:function(a){if(this.attr.path){this.attr.path.getDimensionWithTransform(this.attr.matrix,a)}},render:function(d,b){var c=this.attr.matrix,a=this.attr;if(!a.path||a.path.params.length===0){return}c.toContext(b);b.appendPath(a.path);b.fillStroke(a)},updatePath:function(b,a){}},0,0,0,0,['Ext.draw.Sprite','sprite.path'],0,[Ext.draw.sprite,'Path'],0);Ext.define('Ext.draw.overrides.hittest.sprite.Path',{override:'Ext.draw.sprite.Path',isPointInPath:function(e,f){var a=this.attr;if(a.fillStyle===Ext.util.Color.RGBA_NONE){return this.isPointOnPath(e,f)}var b=a.path,g=a.matrix,c,d;if(!g.isIdentity()){c=b.params.slice(0);b.transform(a.matrix)}d=b.isPointInPath(e,f);if(c){b.params=c}return d},isPointOnPath:function(f,g){var c=this.attr,a=c.path,e=c.matrix,b,d;if(!e.isIdentity()){b=a.params.slice(0);a.transform(c.matrix)}d=a.isPointOnPath(f,g);if(b){a.params=b}return d},hitTest:function(i,a){var e=this,d=e.attr,b=d.path,l=d.matrix,f=i[0],g=i[1],k=(arguments.callee.$previous||Ext.draw.sprite.Sprite.prototype.hitTest).call(this,i,a),c=null,h,j;if(!k){return c}a=a||Ext.draw.sprite.Sprite.defaultHitTestOptions;if(!l.isIdentity()){h=b.params.slice(0);b.transform(d.matrix)}if(a.fill&&a.stroke){j=d.fillStyle!==Ext.util.Color.NONE&&d.fillStyle!==Ext.util.Color.RGBA_NONE;if(j){if(b.isPointInPath(f,g)){c={sprite:e}}}else {if(b.isPointInPath(f,g)||b.isPointOnPath(f,g)){c={sprite:e}}}}else {if(a.stroke&&!a.fill){if(b.isPointOnPath(f,g)){c={sprite:e}}}else {if(a.fill&&!a.stroke){if(b.isPointInPath(f,g)){c={sprite:e}}}}}if(h){b.params=h}return c},getIntersections:function(g){if(!(g.isSprite&&g.isPath)){return []}var e=this.attr,f=g.attr,a=e.path,b=f.path,i=e.matrix,j=f.matrix,c,d,h;if(!i.isIdentity()){c=a.params.slice(0);a.transform(e.matrix)}if(!j.isIdentity()){d=b.params.slice(0);b.transform(f.matrix)}h=a.getIntersections(b);if(c){a.params=c}if(d){b.params=d}return h}});Ext.cmd.derive('Ext.draw.sprite.Circle',Ext.draw.sprite.Path,{type:'circle',inheritableStatics:{def:{processors:{cx:'number',cy:'number',r:'number'},aliases:{radius:'r',x:'cx',y:'cy',centerX:'cx',centerY:'cy'},defaults:{cx:0,cy:0,r:4},triggers:{cx:'path',cy:'path',r:'path'}}},updatePlainBBox:function(b){var c=this.attr,d=c.cx,e=c.cy,a=c.r;b.x=d-a;b.y=e-a;b.width=a+a;b.height=a+a},updateTransformedBBox:function(a){var c=this.attr,f=c.cx,g=c.cy,h=c.r,b=c.matrix,i=b.getScaleX(),j=b.getScaleY(),d,e;d=i*h;e=j*h;a.x=b.x(f,g)-d;a.y=b.y(f,g)-e;a.width=d+d;a.height=e+e},updatePath:function(b,a){b.arc(a.cx,a.cy,a.r,0,Math.PI*2,!1)}},0,0,0,0,['sprite.circle'],0,[Ext.draw.sprite,'Circle'],0);Ext.cmd.derive('Ext.draw.sprite.Arc',Ext.draw.sprite.Circle,{type:'arc',inheritableStatics:{def:{processors:{startAngle:'number',endAngle:'number',anticlockwise:'bool'},aliases:{from:'startAngle',to:'endAngle',start:'startAngle',end:'endAngle'},defaults:{startAngle:0,endAngle:Math.PI*2,anticlockwise:!1},triggers:{startAngle:'path',endAngle:'path',anticlockwise:'path'}}},updatePath:function(b,a){b.arc(a.cx,a.cy,a.r,a.startAngle,a.endAngle,a.anticlockwise)}},0,0,0,0,['sprite.arc'],0,[Ext.draw.sprite,'Arc'],0);Ext.cmd.derive('Ext.draw.sprite.Arrow',Ext.draw.sprite.Path,{inheritableStatics:{def:{processors:{x:'number',y:'number',size:'number'},defaults:{x:0,y:0,size:4},triggers:{x:'path',y:'path',size:'path'}}},updatePath:function(c,b){var a=b.size*1.5,d=b.x-b.lineWidth/2,e=b.y;c.fromSvgString('M'.concat(d-a*0.7,',',e-a*0.4,'l',[a*0.6,0,0,-a*0.4,a,a*0.8,-a,a*0.8,0,-a*0.4,-a*0.6,0],'z'))}},0,0,0,0,['sprite.arrow'],0,[Ext.draw.sprite,'Arrow'],0);Ext.cmd.derive('Ext.draw.sprite.Composite',Ext.draw.sprite.Sprite,{type:'composite',isComposite:!0,config:{sprites:[]},constructor:function(a){this.sprites=[];this.map={};Ext.draw.sprite.Sprite.prototype.constructor.call(this,a)},addSprite:function(a){var d=0,c;if(Ext.isArray(a)){c=[];while(d<a.length){c.push(this.addSprite(a[d++]))}return c}if(a&&a.type&&!a.isSprite){a=Ext.create('sprite.'+a.type,a)}if(!a||!a.isSprite||a.isComposite){return null}a.setSurface(null);a.setParent(this);var b=this.attr,e=a.applyTransformations;a.applyTransformations=function(c){if(a.attr.dirtyTransform){b.dirtyTransform=!0;b.bbox.plain.dirty=!0;b.bbox.transform.dirty=!0}e.call(a,c)};this.sprites.push(a);this.map[a.id]=a.getId();b.bbox.plain.dirty=!0;b.bbox.transform.dirty=!0;return a},add:function(a){return this.addSprite(a)},removeSprite:function(a,e){var b=this,c,d;if(a){if(a.charAt){a=b.map[a]}if(!a||!a.isSprite){return null}if(a.destroyed||a.destroying){return a}c=a.getId();d=b.map[c];delete b.map[c];if(e){a.destroy()}if(!d){return a}a.setParent(null);Ext.Array.remove(b.sprites,a);b.dirtyZIndex=!0;b.setDirty(!0)}return a||null},addAll:function(a){if(a.isSprite||a.type){this.add(a)}else {if(Ext.isArray(a)){var b=0;while(b<a.length){this.add(a[b++])}}}},updatePlainBBox:function(b){var j=this,c=Infinity,h=-Infinity,d=Infinity,f=-Infinity,g,a,e,i;for(e=0,i=j.sprites.length;e<i;e++){g=j.sprites[e];g.applyTransformations();a=g.getBBox();if(c>a.x){c=a.x}if(h<a.x+a.width){h=a.x+a.width}if(d>a.y){d=a.y}if(f<a.y+a.height){f=a.y+a.height}}b.x=c;b.y=d;b.width=h-c;b.height=f-d},isVisible:function(){var b=this.attr,a=this.getParent(),c=a&&(a.isSurface||a.isVisible()),d=c&&!b.hidden&&b.globalAlpha;return !!d},render:function(d,f,e){var a=this,i=a.attr,g=a.attr.matrix,c=a.sprites,h=c.length,b=0;g.toContext(f);for(;b<h;b++){d.renderSprite(c[b],e)}},destroy:function(){var d=this,b=d.sprites,c=b.length,a;for(a=0;a<c;a++){b[a].destroy()}b.length=0;Ext.draw.sprite.Sprite.prototype.destroy.call(this)}},1,0,0,0,['sprite.composite'],0,[Ext.draw.sprite,'Composite'],0);Ext.cmd.derive('Ext.draw.sprite.Cross',Ext.draw.sprite.Path,{inheritableStatics:{def:{processors:{x:'number',y:'number',size:'number'},defaults:{x:0,y:0,size:4},triggers:{x:'path',y:'path',size:'path'}}},updatePath:function(c,b){var a=b.size/1.7,d=b.x-b.lineWidth/2,e=b.y;c.fromSvgString('M'.concat(d-a,',',e,'l',[-a,-a,a,-a,a,a,a,-a,a,a,-a,a,a,a,-a,a,-a,-a,-a,a,-a,-a,'z']))}},0,0,0,0,['sprite.cross'],0,[Ext.draw.sprite,'Cross'],0);Ext.cmd.derive('Ext.draw.sprite.Diamond',Ext.draw.sprite.Path,{inheritableStatics:{def:{processors:{x:'number',y:'number',size:'number'},defaults:{x:0,y:0,size:4},triggers:{x:'path',y:'path',size:'path'}}},updatePath:function(c,b){var a=b.size*1.25,d=b.x-b.lineWidth/2,e=b.y;c.fromSvgString(['M',d,e-a,'l',a,a,-a,a,-a,-a,a,-a,'z'])}},0,0,0,0,['sprite.diamond'],0,[Ext.draw.sprite,'Diamond'],0);Ext.cmd.derive('Ext.draw.sprite.Ellipse',Ext.draw.sprite.Path,{type:'ellipse',inheritableStatics:{def:{processors:{cx:'number',cy:'number',rx:'number',ry:'number',axisRotation:'number'},aliases:{radius:'r',x:'cx',y:'cy',centerX:'cx',centerY:'cy',radiusX:'rx',radiusY:'ry'},defaults:{cx:0,cy:0,rx:1,ry:1,axisRotation:0},triggers:{cx:'path',cy:'path',rx:'path',ry:'path',axisRotation:'path'}}},updatePlainBBox:function(a){var b=this.attr,e=b.cx,f=b.cy,c=b.rx,d=b.ry;a.x=e-c;a.y=f-d;a.width=c+c;a.height=d+d},updateTransformedBBox:function(c){var b=this.attr,m=b.cx,j=b.cy,k=b.rx,p=b.ry,l=p/k,a=b.matrix.clone(),d,e,f,g,n,o,i,h;a.append(1,0,0,l,0,j*(1-l));d=a.getXX();f=a.getYX();n=a.getDX();e=a.getXY();g=a.getYY();o=a.getDY();i=Math.sqrt(d*d+f*f)*k;h=Math.sqrt(e*e+g*g)*k;c.x=m*d+j*f+n-i;c.y=m*e+j*g+o-h;c.width=i+i;c.height=h+h},updatePath:function(b,a){b.ellipse(a.cx,a.cy,a.rx,a.ry,a.axisRotation,0,Math.PI*2,!1)}},0,0,0,0,['sprite.ellipse'],0,[Ext.draw.sprite,'Ellipse'],0);Ext.cmd.derive('Ext.draw.sprite.EllipticalArc',Ext.draw.sprite.Ellipse,{type:'ellipticalArc',inheritableStatics:{def:{processors:{startAngle:'number',endAngle:'number',anticlockwise:'bool'},aliases:{from:'startAngle',to:'endAngle',start:'startAngle',end:'endAngle'},defaults:{startAngle:0,endAngle:Math.PI*2,anticlockwise:!1},triggers:{startAngle:'path',endAngle:'path',anticlockwise:'path'}}},updatePath:function(b,a){b.ellipse(a.cx,a.cy,a.rx,a.ry,a.axisRotation,a.startAngle,a.endAngle,a.anticlockwise)}},0,0,0,0,['sprite.ellipticalArc'],0,[Ext.draw.sprite,'EllipticalArc'],0);Ext.cmd.derive('Ext.draw.sprite.Rect',Ext.draw.sprite.Path,{type:'rect',inheritableStatics:{def:{processors:{x:'number',y:'number',width:'number',height:'number',radius:'number'},aliases:{},triggers:{x:'path',y:'path',width:'path',height:'path',radius:'path'},defaults:{x:0,y:0,width:8,height:8,radius:0}}},updatePlainBBox:function(a){var b=this.attr;a.x=b.x;a.y=b.y;a.width=b.width;a.height=b.height},updateTransformedBBox:function(a,b){this.attr.matrix.transformBBox(b,this.attr.radius,a)},updatePath:function(e,g){var a=g.x,b=g.y,f=g.width,d=g.height,c=Math.min(g.radius,Math.abs(d)*0.5,Math.abs(f)*0.5);if(c===0){e.rect(a,b,f,d)}else {e.moveTo(a+c,b);e.arcTo(a+f,b,a+f,b+d,c);e.arcTo(a+f,b+d,a,b+d,c);e.arcTo(a,b+d,a,b,c);e.arcTo(a,b,a+c,b,c)}}},0,0,0,0,['sprite.rect'],0,[Ext.draw.sprite,'Rect'],0);Ext.cmd.derive('Ext.draw.sprite.Image',Ext.draw.sprite.Rect,{type:'image',statics:{imageLoaders:{}},inheritableStatics:{def:{processors:{src:'string'},triggers:{src:'src'},updaters:{src:'updateSource'},defaults:{src:'',width:null,height:null}}},updateSurface:function(a){if(a){this.updateSource(this.attr)}},updateSource:function(e){var g=this,f=e.src,d=g.getSurface(),a=Ext.draw.sprite.Image.imageLoaders[f],i=e.width,h=e.height,c,b;if(!d){return}if(!a){c=new Image();a=Ext.draw.sprite.Image.imageLoaders[f]={image:c,done:!1,pendingSprites:[g],pendingSurfaces:[d]};c.width=i;c.height=h;c.onload=function(){var c;if(!a.done){a.done=!0;for(b=0;b<a.pendingSprites.length;b++){c=a.pendingSprites[b];if(!c.destroyed){c.setDirty(!0)}}for(b=0;b<a.pendingSurfaces.length;b++){c=a.pendingSurfaces[b];if(!c.destroyed){c.renderFrame()}}}};c.src=f}else {Ext.Array.include(a.pendingSprites,g);Ext.Array.include(a.pendingSurfaces,d)}},render:function(d,e){var j=this,b=j.attr,h=b.matrix,i=b.src,k=b.x,l=b.y,g=b.width,f=b.height,c=Ext.draw.sprite.Image.imageLoaders[i],a;if(c&&c.done){h.toContext(e);a=c.image;e.drawImage(a,k,l,g||(a.naturalWidth||a.width)/d.devicePixelRatio,f||(a.naturalHeight||a.height)/d.devicePixelRatio)}},isVisible:function(){var b=this.attr,a=this.getParent(),c=a&&(a.isSurface||a.isVisible()),d=c&&!b.hidden&&b.globalAlpha;return !!d}},0,0,0,0,['sprite.image'],0,[Ext.draw.sprite,'Image'],0);Ext.cmd.derive('Ext.draw.sprite.Instancing',Ext.draw.sprite.Sprite,{type:'instancing',isInstancing:!0,config:{template:null,instances:null},instances:null,applyTemplate:function(a){if(!a.isSprite){if(!a.xclass&&!a.type){a.type='circle'}a=Ext.create(a.xclass||'sprite.'+a.type,a)}var b=a.getSurface();if(b){b.remove(a)}a.setParent(this);return a},updateTemplate:function(a,b){if(b){delete b.ownAttr}a.setSurface(this.getSurface());a.ownAttr=a.attr;this.clearAll()},updateInstances:function(a){this.clearAll();if(Ext.isArray(a)){for(var b=0,c=a.length;b<c;b++){this.add(a[b])}}},updateSurface:function(b){var a=this.getTemplate();if(a&&!a.destroyed){a.setSurface(b)}},get:function(a){return this.instances[a]},getCount:function(){return this.instances.length},clearAll:function(){var a=this.getTemplate();a.attr.children=this.instances=[];this.position=0},createInstance:function(c,a,b){return this.add(c,a,b)},add:function(f,d,e){var a=this.getTemplate(),c=a.attr,b=Ext.Object.chain(c);a.topModifier.prepareAttributes(b);a.attr=b;a.setAttributes(f,d,e);b.template=a;this.instances.push(b);a.attr=c;this.position++;return b},getBBox:function(){return null},getBBoxFor:function(e,c){var a=this.getTemplate(),d=a.attr,b;a.attr=this.instances[e];b=a.getBBox(c);a.attr=d;return b},isVisible:function(){var c=this.attr,a=this.getParent(),b;b=a&&a.isSurface&&!c.hidden&&c.globalAlpha;return !!b},isInstanceVisible:function(b){var d=this,a=d.getTemplate(),f=a.attr,e=d.instances,c=!1;if(!Ext.isNumber(b)||b<0||b>=e.length||!d.isVisible()){return c}a.attr=e[b];c=a.isVisible(point,options);a.attr=f;return c},render:function(e,b,h){var d=this,a=d.getTemplate(),f=e.getRect(),j=d.attr.matrix,i=a.attr,g=d.instances,k=d.position,c;j.toContext(b);a.preRender(e,b,h);a.useAttributes(b,f);a.isSpriteInstance=!0;for(c=0;c<k;c++){if(g[c].hidden){continue}b.save();a.attr=g[c];a.useAttributes(b,f);a.render(e,b,h);b.restore()}a.isSpriteInstance=!1;a.attr=i},setAttributesFor:function(f,b,d){var a=this.getTemplate(),e=a.attr,c=this.instances[f];if(!c){return}a.attr=c;if(d){b=Ext.apply({},b)}else {b=a.self.def.normalize(b)}a.topModifier.pushDown(c,b);a.attr=e},destroy:function(){var b=this,a=b.getTemplate();b.instances=null;if(a){a.destroy()}Ext.draw.sprite.Sprite.prototype.destroy.call(this)}},0,0,0,0,['sprite.instancing'],0,[Ext.draw.sprite,'Instancing'],0);Ext.define('Ext.draw.overrides.hittest.sprite.Instancing',{override:'Ext.draw.sprite.Instancing',hitTest:function(h,g){var e=this,c=e.getTemplate(),f=c.attr,d=e.instances,i=d.length,b=0,a=null;if(!e.isVisible()){return a}for(;b<i;b++){c.attr=d[b];a=c.hitTest(h,g);if(a){a.isInstance=!0;a.template=a.sprite;a.sprite=this;a.instance=d[b];a.index=b;return a}}c.attr=f;return a}});Ext.cmd.derive('Ext.draw.sprite.Line',Ext.draw.sprite.Sprite,{type:'line',inheritableStatics:{def:{processors:{fromX:'number',fromY:'number',toX:'number',toY:'number'},defaults:{fromX:0,fromY:0,toX:1,toY:1,strokeStyle:'black'},aliases:{x1:'fromX',y1:'fromY',x2:'toX',y2:'toY'}}},updateLineBBox:function(d,q,g,i,h,j){var p=this.attr,n=p.matrix,m=p.lineWidth/2,b,c,e,f,k,l,a;if(q){a=n.transformPoint([g,i]);g=a[0];i=a[1];a=n.transformPoint([h,j]);h=a[0];j=a[1]}b=Math.min(g,h);e=Math.max(g,h);c=Math.min(i,j);f=Math.max(i,j);var o=Math.atan2(e-b,f-c),s=Math.sin(o),r=Math.cos(o),k=m*r,l=m*s;b-=k;c-=l;e+=k;f+=l;d.x=b;d.y=c;d.width=e-b;d.height=f-c},updatePlainBBox:function(b){var a=this.attr;this.updateLineBBox(b,!1,a.fromX,a.fromY,a.toX,a.toY)},updateTransformedBBox:function(b,c){var a=this.attr;this.updateLineBBox(b,!0,a.fromX,a.fromY,a.toX,a.toY)},render:function(d,a){var b=this.attr,c=this.attr.matrix;c.toContext(a);a.beginPath();a.moveTo(b.fromX,b.fromY);a.lineTo(b.toX,b.toY);a.stroke()}},0,0,0,0,['sprite.line'],0,[Ext.draw.sprite,'Line'],0);Ext.cmd.derive('Ext.draw.sprite.Plus',Ext.draw.sprite.Path,{inheritableStatics:{def:{processors:{x:'number',y:'number',size:'number'},defaults:{x:0,y:0,size:4},triggers:{x:'path',y:'path',size:'path'}}},updatePath:function(c,b){var a=b.size/1.3,d=b.x-b.lineWidth/2,e=b.y;c.fromSvgString('M'.concat(d-a/2,',',e-a/2,'l',[0,-a,a,0,0,a,a,0,0,a,-a,0,0,a,-a,0,0,-a,-a,0,0,-a,'z']))}},0,0,0,0,['sprite.plus'],0,[Ext.draw.sprite,'Plus'],0);Ext.cmd.derive('Ext.draw.sprite.Sector',Ext.draw.sprite.Path,{type:'sector',inheritableStatics:{def:{processors:{centerX:'number',centerY:'number',startAngle:'number',endAngle:'number',startRho:'number',endRho:'number',margin:'number'},aliases:{rho:'endRho'},triggers:{centerX:'path,bbox',centerY:'path,bbox',startAngle:'path,bbox',endAngle:'path,bbox',startRho:'path,bbox',endRho:'path,bbox',margin:'path,bbox'},defaults:{centerX:0,centerY:0,startAngle:0,endAngle:0,startRho:0,endRho:150,margin:0,path:'M 0,0'}}},getMidAngle:function(){return this.midAngle||0},updatePath:function(g,a){var b=Math.min(a.startAngle,a.endAngle),e=Math.max(a.startAngle,a.endAngle),j=this.midAngle=(b+e)*0.5,i=a.margin,c=a.centerX,d=a.centerY,f=Math.min(a.startRho,a.endRho),h=Math.max(a.startRho,a.endRho);if(i){c+=i*Math.cos(j);d+=i*Math.sin(j)}g.moveTo(c+f*Math.cos(b),d+f*Math.sin(b));g.lineTo(c+h*Math.cos(b),d+h*Math.sin(b));g.arc(c,d,h,b,e,!1);g.lineTo(c+f*Math.cos(e),d+f*Math.sin(e));g.arc(c,d,f,e,b,!0)}},0,0,0,0,['sprite.sector'],0,[Ext.draw.sprite,'Sector'],0);Ext.cmd.derive('Ext.draw.sprite.Square',Ext.draw.sprite.Path,{inheritableStatics:{def:{processors:{x:'number',y:'number',size:'number'},defaults:{x:0,y:0,size:4},triggers:{x:'path',y:'path',size:'size'}}},updatePath:function(d,a){var c=a.size*1.2,b=c*2,e=a.x-a.lineWidth/2,f=a.y;d.fromSvgString('M'.concat(e-c,',',f-c,'l',[b,0,0,b,-b,0,0,-b,'z']))}},0,0,0,0,['sprite.square'],0,[Ext.draw.sprite,'Square'],0);Ext.cmd.derive('Ext.draw.TextMeasurer',Ext.Base,{singleton:!0,measureDiv:null,measureCache:{},precise:Ext.isIE8,measureDivTpl:{id:'ext-draw-text-measurer',tag:'div',style:{overflow:'hidden',position:'relative','float':'left',width:0,height:0},children:{tag:'div',style:{display:'block',position:'absolute',x:-100000,y:-100000,padding:0,margin:0,'z-index':-100000,'white-space':'nowrap'}}},actualMeasureText:function(g,e){var f=Ext.draw.TextMeasurer,a=f.measureDiv,b=100000,c;if(!a){var d=Ext.Element.create({style:{'overflow':'hidden','position':'relative','float':'left','width':0,'height':0}});f.measureDiv=a=Ext.Element.create({style:{'position':'absolute','x':b,'y':b,'z-index':-b,'white-space':'nowrap','display':'block','padding':0,'margin':0}});Ext.getBody().appendChild(d);d.appendChild(a)}if(e){a.setStyle({font:e,lineHeight:'normal'})}a.setText('('+g+')');c=a.getSize();a.setText('()');c.width-=a.getSize().width;return c},measureTextSingleLine:function(b,c){if(this.precise){return this.preciseMeasureTextSingleLine(b,c)}b=b.toString();var a=this.measureCache,h=b.split(''),i=0,g=0,d,e,f,k,j;if(!a[c]){a[c]={}}a=a[c];if(a[b]){return a[b]}for(f=0,k=h.length;f<k;f++){e=h[f];if(!(d=a[e])){j=this.actualMeasureText(e,c);d=a[e]=j}i+=d.width;g=Math.max(g,d.height)}return a[b]={width:i,height:g}},preciseMeasureTextSingleLine:function(a,c){a=a.toString();var b=this.measureDiv||(this.measureDiv=Ext.getBody().createChild(this.measureDivTpl).down('div'));b.setStyle({font:c||''});return Ext.util.TextMetrics.measure(b,a)},measureText:function(h,g){var f=h.split('\n'),i=f.length,e=0,d=0,a,b,c;if(i===1){return this.measureTextSingleLine(h,g)}c=[];for(b=0;b<i;b++){a=this.measureTextSingleLine(f[b],g);c.push(a);e+=a.height;d=Math.max(d,a.width)}return {width:d,height:e,sizes:c}}},0,0,0,0,0,0,[Ext.draw,'TextMeasurer'],0);Ext.cmd.derive('Ext.draw.sprite.Text',Ext.draw.sprite.Sprite,function(){var d={'xx-small':!0,'x-small':!0,'small':!0,'medium':!0,'large':!0,'x-large':!0,'xx-large':!0};var c={normal:!0,bold:!0,bolder:!0,lighter:!0,100:!0,200:!0,300:!0,400:!0,500:!0,600:!0,700:!0,800:!0,900:!0};var a={start:'start',left:'start',center:'center',middle:'center',end:'end',right:'end'};var b={top:'top',hanging:'hanging',middle:'middle',center:'middle',alphabetic:'alphabetic',ideographic:'ideographic',bottom:'bottom'};return {type:'text',lineBreakRe:/\r?\n/g,inheritableStatics:{def:{animationProcessors:{text:'text'},processors:{x:'number',y:'number',text:'string',fontSize:function(a){if(Ext.isNumber(+a)){return a+'px'}else {if(a.match(Ext.dom.Element.unitRe)){return a}else {if(a in d){return a}}}},fontStyle:'enums(,italic,oblique)',fontVariant:'enums(,small-caps)',fontWeight:function(a){if(a in c){return String(a)}else {return ''}},fontFamily:'string',textAlign:function(b){return a[b]||'center'},textBaseline:function(a){return b[a]||'alphabetic'},font:'string'},aliases:{'font-size':'fontSize','font-family':'fontFamily','font-weight':'fontWeight','font-variant':'fontVariant','text-anchor':'textAlign'},defaults:{fontStyle:'',fontVariant:'',fontWeight:'',fontSize:'10px',fontFamily:'sans-serif',font:'10px sans-serif',textBaseline:'alphabetic',textAlign:'start',strokeStyle:'rgba(0, 0, 0, 0)',fillStyle:'#000',x:0,y:0,text:''},triggers:{fontStyle:'fontX,bbox',fontVariant:'fontX,bbox',fontWeight:'fontX,bbox',fontSize:'fontX,bbox',fontFamily:'fontX,bbox',font:'font,bbox,canvas',textBaseline:'bbox',textAlign:'bbox',x:'bbox',y:'bbox',text:'bbox'},updaters:{fontX:'makeFontShorthand',font:'parseFontShorthand'}}},config:{preciseMeasurement:undefined},constructor:function(a){if(a&&a.font){a=Ext.clone(a);for(var b in a){if(b!=='font'&&b.indexOf('font')===0){delete a[b]}}}Ext.draw.sprite.Sprite.prototype.constructor.call(this,a)},fontValuesMap:{'italic':'fontStyle','oblique':'fontStyle','small-caps':'fontVariant','bold':'fontWeight','bolder':'fontWeight','lighter':'fontWeight',100:'fontWeight',200:'fontWeight',300:'fontWeight',400:'fontWeight',500:'fontWeight',600:'fontWeight',700:'fontWeight',800:'fontWeight',900:'fontWeight','xx-small':'fontSize','x-small':'fontSize','small':'fontSize','medium':'fontSize','large':'fontSize','x-large':'fontSize','xx-large':'fontSize'},makeFontShorthand:function(a){var b=[];if(a.fontStyle){b.push(a.fontStyle)}if(a.fontVariant){b.push(a.fontVariant)}if(a.fontWeight){b.push(a.fontWeight)}if(a.fontSize){b.push(a.fontSize)}if(a.fontFamily){b.push(a.fontFamily)}this.setAttributes({font:b.join(' ')},!0)},parseFontShorthand:function(i){var e=i.font,j=e.length,b={},h=this.fontValuesMap,c=0,d,f,a,g;while(c<j&&d!==-1){d=e.indexOf(' ',c);if(d<0){a=e.substr(c)}else {if(d>c){a=e.substr(c,d-c)}else {continue}}f=a.indexOf('/');if(f>0){a=a.substr(0,f)}else {if(f===0){continue}}if(a!=='normal'&&a!=='inherit'){g=h[a];if(g){b[g]=a}else {if(a.match(Ext.dom.Element.unitRe)){b.fontSize=a}else {b.fontFamily=e.substr(c);break}}}c=d+1}if(!b.fontStyle){b.fontStyle=''}if(!b.fontVariant){b.fontVariant=''}if(!b.fontWeight){b.fontWeight=''}this.setAttributes(b,!0)},fontProperties:{fontStyle:!0,fontVariant:!0,fontWeight:!0,fontSize:!0,fontFamily:!0},setAttributes:function(a,d,e){var b,c;if(a&&a.font){c={};for(b in a){if(!(b in this.fontProperties)){c[b]=a[b]}}a=c}Ext.draw.sprite.Sprite.prototype.setAttributes.call(this,a,d,e)},getBBox:function(d){var b=this,a=b.attr.bbox.plain,c=b.getSurface();if(a.dirty){b.updatePlainBBox(a);a.dirty=!1}if(c&&c.getInherited().rtl&&c.getFlipRtlText()){b.updatePlainBBox(a,!0)}return Ext.draw.sprite.Sprite.prototype.getBBox.call(this,d)},rtlAlignments:{start:'end',center:'center',end:'start'},updatePlainBBox:function(l,u){var c=this,b=c.attr,h=b.x,n=b.y,m=[],w=b.font,x=b.text,v=b.textBaseline,o=b.textAlign,s=c.getPreciseMeasurement(),g,r;if(u&&c.oldSize){g=c.oldSize}else {r=Ext.draw.TextMeasurer.precise;if(Ext.isBoolean(s)){Ext.draw.TextMeasurer.precise=s}g=c.oldSize=Ext.draw.TextMeasurer.measureText(x,w);Ext.draw.TextMeasurer.precise=r}var j=c.getSurface(),k=j&&j.getInherited().rtl||!1,t=k&&j.getFlipRtlText(),f=g.sizes,i=g.height,d=g.width,q=f?f.length:0,e,p,a=0;switch(v){case 'hanging':case 'top':break;case 'ideographic':case 'bottom':n-=i;break;case 'alphabetic':n-=i*0.8;break;case 'middle':n-=i*0.5;break;}if(t){p=j.getRect();h=p[2]-p[0]-h;o=c.rtlAlignments[o]}switch(o){case 'start':if(k){for(;a<q;a++){e=f[a].width;m.push(-(d-e))}};break;case 'end':h-=d;if(k){break};for(;a<q;a++){e=f[a].width;m.push(d-e)};break;case 'center':h-=d*0.5;for(;a<q;a++){e=f[a].width;m.push((k?-1:1)*(d-e)*0.5)};break;}b.textAlignOffsets=m;l.x=h;l.y=n;l.width=d;l.height=i},setText:function(a){this.setAttributes({text:a},!0)},render:function(k,d,n){var g=this,b=g.attr,m=Ext.draw.Matrix.fly(b.matrix.elements.slice(0)),l=g.getBBox(!0),j=b.textAlignOffsets,i=Ext.util.Color.RGBA_NONE,f,h,a,c,e;if(b.text.length===0){return}c=b.text.split(g.lineBreakRe);e=l.height/c.length;f=b.bbox.plain.x;h=b.bbox.plain.y+e*0.78;m.toContext(d);if(k.getInherited().rtl){f+=b.bbox.plain.width}for(a=0;a<c.length;a++){if(d.fillStyle!==i){d.fillText(c[a],f+(j[a]||0),h+e*a)}if(d.strokeStyle!==i){d.strokeText(c[a],f+(j[a]||0),h+e*a)}}}}},1,0,0,0,['sprite.text'],0,[Ext.draw.sprite,'Text'],0);Ext.cmd.derive('Ext.draw.sprite.Tick',Ext.draw.sprite.Line,{inheritableStatics:{def:{processors:{x:'number',y:'number',size:'number'},defaults:{x:0,y:0,size:4},triggers:{x:'tick',y:'tick',size:'tick'},updaters:{tick:function(a){var c=a.size*1.5,b=a.lineWidth/2,d=a.x,e=a.y;this.setAttributes({fromX:d-b,fromY:e-c,toX:d-b,toY:e+c})}}}}},0,0,0,0,['sprite.tick'],0,[Ext.draw.sprite,'Tick'],0);Ext.cmd.derive('Ext.draw.sprite.Triangle',Ext.draw.sprite.Path,{inheritableStatics:{def:{processors:{x:'number',y:'number',size:'number'},defaults:{x:0,y:0,size:4},triggers:{x:'path',y:'path',size:'path'}}},updatePath:function(c,b){var a=b.size*2.2,d=b.x,e=b.y;c.fromSvgString('M'.concat(d,',',e,'m0-',a*0.48,'l',a*0.5,',',a*0.87,'-',a,',0z'))}},0,0,0,0,['sprite.triangle'],0,[Ext.draw.sprite,'Triangle'],0);Ext.cmd.derive('Ext.draw.gradient.Linear',Ext.draw.gradient.Gradient,{type:'linear',config:{degrees:0,radians:0},applyRadians:function(a,b){if(Ext.isNumber(a)){return a}return b},applyDegrees:function(a,b){if(Ext.isNumber(a)){return a}return b},updateRadians:function(a){this.setDegrees(Ext.draw.Draw.degrees(a))},updateDegrees:function(a){this.setRadians(Ext.draw.Draw.rad(a))},generateGradient:function(m,e){var g=this.getRadians(),k=Math.cos(g),l=Math.sin(g),d=e.width,a=e.height,i=e.x+d*0.5,j=e.y+a*0.5,h=this.getStops(),n=h.length,f,c,b;if(Ext.isNumber(i)&&Ext.isNumber(j)&&a>0&&d>0){c=Math.sqrt(a*a+d*d)*Math.abs(Math.cos(g-Math.atan(a/d)))/2;f=m.createLinearGradient(i+k*c,j+l*c,i-k*c,j-l*c);for(b=0;b<n;b++){f.addColorStop(h[b].offset,h[b].color)}return f}return Ext.util.Color.NONE}},0,0,0,0,0,0,[Ext.draw.gradient,'Linear'],0);Ext.cmd.derive('Ext.draw.gradient.Radial',Ext.draw.gradient.Gradient,{type:'radial',config:{start:{x:0,y:0,r:0},end:{x:0,y:0,r:1}},applyStart:function(a,c){if(!c){return a}var b={x:c.x,y:c.y,r:c.r};if('x' in a){b.x=a.x}else {if('centerX' in a){b.x=a.centerX}}if('y' in a){b.y=a.y}else {if('centerY' in a){b.y=a.centerY}}if('r' in a){b.r=a.r}else {if('radius' in a){b.r=a.radius}}return b},applyEnd:function(a,c){if(!c){return a}var b={x:c.x,y:c.y,r:c.r};if('x' in a){b.x=a.x}else {if('centerX' in a){b.x=a.centerX}}if('y' in a){b.y=a.y}else {if('centerY' in a){b.y=a.centerY}}if('r' in a){b.r=a.r}else {if('radius' in a){b.r=a.radius}}return b},generateGradient:function(k,d){var e=this.getStart(),g=this.getEnd(),c=d.width*0.5,a=d.height*0.5,i=d.x+c,j=d.y+a,h=k.createRadialGradient(i+e.x*c,j+e.y*a,e.r*Math.max(c,a),i+g.x*c,j+g.y*a,g.r*Math.max(c,a)),f=this.getStops(),l=f.length,b;for(b=0;b<l;b++){h.addColorStop(f[b].offset,f[b].color)}return h}},0,0,0,0,0,0,[Ext.draw.gradient,'Radial'],0);Ext.cmd.derive('Ext.draw.Surface',Ext.draw.SurfaceBase,{devicePixelRatio:window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI,deprecated:{'5.1.0':{statics:{methods:{stableSort:function(a){return Ext.Array.sort(a,function(b,c){return b.attr.zIndex-c.attr.zIndex})}}}}},cls:'x-surface',config:{rect:null,background:null,items:[],dirty:!1,flipRtlText:!1},isSurface:!0,isPendingRenderFrame:!1,dirtyPredecessorCount:0,constructor:function(b){var a=this;a.predecessors=[];a.successors=[];a.map={};Ext.draw.SurfaceBase.prototype.constructor.call(this,b);a.matrix=new Ext.draw.Matrix();a.inverseMatrix=a.matrix.inverse()},roundPixel:function(a){return Math.round(this.devicePixelRatio*a)/this.devicePixelRatio},waitFor:function(a){var b=this,c=b.predecessors;if(!Ext.Array.contains(c,a)){c.push(a);a.successors.push(b);if(a.getDirty()){b.dirtyPredecessorCount++}}},updateDirty:function(d){var c=this.successors,e=c.length,b=0,a;for(;b<e;b++){a=c[b];if(d){a.dirtyPredecessorCount++;a.setDirty(!0)}else {a.dirtyPredecessorCount--;if(a.dirtyPredecessorCount===0&&a.isPendingRenderFrame){a.renderFrame()}}}},applyBackground:function(a,b){this.setDirty(!0);if(Ext.isString(a)){a={fillStyle:a}}return Ext.factory(a,Ext.draw.sprite.Rect,b)},applyRect:function(a,b){if(b&&a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]){return}if(Ext.isArray(a)){return [a[0],a[1],a[2],a[3]]}else {if(Ext.isObject(a)){return [a.x||a.left,a.y||a.top,a.width||a.right-a.left,a.height||a.bottom-a.top]}}},updateRect:function(a){var d=this,b=a[0],c=a[1],h=b+a[2],g=c+a[3],e=d.getBackground(),f=d.element;f.setLocalXY(Math.floor(b),Math.floor(c));f.setSize(Math.ceil(h-Math.floor(b)),Math.ceil(g-Math.floor(c)));if(e){e.setAttributes({x:0,y:0,width:Math.ceil(h-Math.floor(b)),height:Math.ceil(g-Math.floor(c))})}d.setDirty(!0)},resetTransform:function(){this.matrix.set(1,0,0,1,0,0);this.inverseMatrix.set(1,0,0,1,0,0);this.setDirty(!0)},get:function(a){return this.map[a]||this.getItems()[a]},add:function(){var d=this,h=Array.prototype.slice.call(arguments),j=Ext.isArray(h[0]),i=d.map,e=[],b,c,a,f,g,k;b=Ext.Array.clean(j?h[0]:h);if(!b.length){return e}for(g=0,k=b.length;g<k;g++){c=b[g];if(!c||c.destroyed){continue}a=null;if(c.isSprite&&!i[c.getId()]){a=c}else {if(!i[c.id]){a=this.createItem(c)}}if(a){i[a.getId()]=a;e.push(a);f=a.getSurface();if(f&&f.isSurface){f.remove(a)}a.setParent(d);a.setSurface(d);d.onAdd(a)}}b=d.getItems();if(b){b.push.apply(b,e)}d.dirtyZIndex=!0;d.setDirty(!0);if(!j&&e.length===1){return e[0]}else {return e}},onAdd:Ext.emptyFn,remove:function(a,f){var b=this,e=b.clearing,d,c;if(a){if(a.charAt){a=b.map[a]}if(!a||!a.isSprite){return null}d=a.id;c=b.map[d];delete b.map[d];if(a.destroyed||a.destroying){if(c&&!e){Ext.Array.remove(b.getItems(),a)}return a}if(!c){if(f){a.destroy()}return a}a.setParent(null);a.setSurface(null);if(f){a.destroy()}if(!e){Ext.Array.remove(b.getItems(),a);b.dirtyZIndex=!0;b.setDirty(!0)}}return a||null},removeAll:function(e){var a=this,d=a.getItems(),b,f,c;a.clearing=!!e;for(c=d.length-1;c>=0;c--){b=d[c];if(e){b.destroy()}else {b.setParent(null);b.setSurface(null)}}a.clearing=!1;d.length=0;a.map={};a.dirtyZIndex=!0;if(!a.destroying){a.setDirty(!0)}},applyItems:function(a){if(this.getItems()){this.removeAll(!0)}return Ext.Array.from(this.add(a))},createItem:function(a){return Ext.create(a.xclass||'sprite.'+a.type,a)},getBBox:function(b,i){b=Ext.Array.from(b);var c=Infinity,g=-Infinity,d=Infinity,f=-Infinity,j=b.length,h,a,e;for(e=0;e<j;e++){h=b[e];a=h.getBBox(i);if(c>a.x){c=a.x}if(g<a.x+a.width){g=a.x+a.width}if(d>a.y){d=a.y}if(f<a.y+a.height){f=a.y+a.height}}return {x:c,y:d,width:g-c,height:f-d}},emptyRect:[0,0,0,0],getEventXY:function(i){var b=this,h=b.getInherited().rtl,c=i.getXY(),f=b.getOwnerBody(),e=f.getXY(),d=b.getRect()||b.emptyRect,a=[],g;if(h){g=f.getWidth();a[0]=e[0]-c[0]-d[0]+g}else {a[0]=c[0]-e[0]-d[0]}a[1]=c[1]-e[1]-d[1];return a},clear:Ext.emptyFn,orderByZIndex:function(){var e=this,b=e.getItems(),d=!1,a,c;if(e.getDirty()){for(a=0,c=b.length;a<c;a++){if(b[a].attr.dirtyZIndex){d=!0;break}}if(d){Ext.Array.sort(b,function(a,b){return a.attr.zIndex-b.attr.zIndex});this.setDirty(!0)}for(a=0,c=b.length;a<c;a++){b[a].attr.dirtyZIndex=!1}}},repaint:function(){var a=this;a.repaint=Ext.emptyFn;Ext.defer(function(){delete a.repaint;a.element.repaint()},1)},renderFrame:function(){var a=this;if(!(a.element&&a.getDirty()&&a.getRect())){return}if(a.dirtyPredecessorCount>0){a.isPendingRenderFrame=!0;return}var d=a.getBackground(),e=a.getItems(),c,b,f;a.orderByZIndex();if(a.getDirty()){a.clear();a.clearTransform();if(d){a.renderSprite(d)}for(b=0,f=e.length;b<f;b++){c=e[b];if(a.renderSprite(c)===!1){return}c.attr.textPositionCount=a.textPosition}a.setDirty(!1)}},renderSprite:Ext.emptyFn,clearTransform:Ext.emptyFn,destroy:function(){var a=this;a.destroying=!0;a.removeAll(!0);a.destroying=!1;a.predecessors=a.successors=null;if(a.hasListeners.destroy){a.fireEvent('destroy',a)}Ext.draw.SurfaceBase.prototype.destroy.call(this)}},1,['surface'],['widget','surface'],{'widget':!0,'surface':!0},['widget.surface'],0,[Ext.draw,'Surface'],0);Ext.define('Ext.draw.overrides.hittest.Surface',{override:'Ext.draw.Surface',hitTest:function(f,b){var g=this,e=g.getItems(),a,d,c;b=b||Ext.draw.sprite.Sprite.defaultHitTestOptions;for(a=e.length-1;a>=0;a--){d=e[a];if(d.hitTest){c=d.hitTest(f,b);if(c){return c}}}return null},hitTestEvent:function(b,a){var c=this.getEventXY(b);return this.hitTest(c,a)}});Ext.cmd.derive('Ext.draw.engine.SvgContext',Ext.Base,{toSave:['strokeOpacity','strokeStyle','fillOpacity','fillStyle','globalAlpha','lineWidth','lineCap','lineJoin','lineDash','lineDashOffset','miterLimit','shadowOffsetX','shadowOffsetY','shadowBlur','shadowColor','globalCompositeOperation','position','fillGradient','strokeGradient'],strokeOpacity:1,strokeStyle:'none',fillOpacity:1,fillStyle:'none',lineDas:[],lineDashOffset:0,globalAlpha:1,lineWidth:1,lineCap:'butt',lineJoin:'miter',miterLimit:10,shadowOffsetX:0,shadowOffsetY:0,shadowBlur:0,shadowColor:'none',globalCompositeOperation:'src',urlStringRe:/^url\(#([\w\-]+)\)$/,constructor:function(b){var a=this;a.surface=b;a.state=[];a.matrix=new Ext.draw.Matrix();a.path=null;a.clear()},clear:function(){this.group=this.surface.mainGroup;this.position=0;this.path=null},getElement:function(a){return this.surface.getSvgElement(this.group,a,this.position++)},save:function(){var d=this.toSave,c={},e=this.getElement('g'),a,b;for(b=0;b<d.length;b++){a=d[b];if(a in this){c[a]=this[a]}}this.position=0;c.matrix=this.matrix.clone();this.state.push(c);this.group=e;return e},restore:function(){var e=this.toSave,d=this.state.pop(),c=this.group,f=c.dom.childNodes,a,b;while(f.length>this.position){c.last().destroy()}for(b=0;b<e.length;b++){a=e[b];if(a in d){this[a]=d[a]}else {delete this[a]}}this.setTransform.apply(this,d.matrix.elements);this.group=c.getParent()},transform:function(c,e,d,f,a,b){if(this.path){var g=Ext.draw.Matrix.fly([c,e,d,f,a,b]).inverse();this.path.transform(g)}this.matrix.append(c,e,d,f,a,b)},setTransform:function(c,e,d,f,a,b){if(this.path){this.path.transform(this.matrix)}this.matrix.reset();this.transform(c,e,d,f,a,b)},scale:function(a,b){this.transform(a,0,0,b,0,0)},rotate:function(a){var b=Math.cos(a),d=Math.sin(a),c=-Math.sin(a),e=Math.cos(a);this.transform(b,d,c,e,0,0)},translate:function(a,b){this.transform(1,0,0,1,a,b)},setGradientBBox:function(a){this.bbox=a},beginPath:function(){this.path=new Ext.draw.Path()},moveTo:function(a,b){if(!this.path){this.beginPath()}this.path.moveTo(a,b);this.path.element=null},lineTo:function(a,b){if(!this.path){this.beginPath()}this.path.lineTo(a,b);this.path.element=null},rect:function(a,b,d,c){this.moveTo(a,b);this.lineTo(a+d,b);this.lineTo(a+d,b+c);this.lineTo(a,b+c);this.closePath()},strokeRect:function(c,d,b,a){this.beginPath();this.rect(c,d,b,a);this.stroke()},fillRect:function(c,d,b,a){this.beginPath();this.rect(c,d,b,a);this.fill()},closePath:function(){if(!this.path){this.beginPath()}this.path.closePath();this.path.element=null},arcSvg:function(d,e,a,b,c,f,g){if(!this.path){this.beginPath()}this.path.arcSvg(d,e,a,b,c,f,g);this.path.element=null},arc:function(e,f,d,b,c,a){if(!this.path){this.beginPath()}this.path.arc(e,f,d,b,c,a);this.path.element=null},ellipse:function(g,h,e,f,d,b,c,a){if(!this.path){this.beginPath()}this.path.ellipse(g,h,e,f,d,b,c,a);this.path.element=null},arcTo:function(d,f,e,g,b,c,a){if(!this.path){this.beginPath()}this.path.arcTo(d,f,e,g,b,c,a);this.path.element=null},bezierCurveTo:function(a,d,b,e,c,f){if(!this.path){this.beginPath()}this.path.bezierCurveTo(a,d,b,e,c,f);this.path.element=null},strokeText:function(c,d,e){c=String(c);if(this.strokeStyle){var b=this.getElement('text'),a=this.surface.getSvgElement(b,'tspan',0);this.surface.setElementAttributes(b,{'x':d,'y':e,'transform':this.matrix.toSvg(),'stroke':this.strokeStyle,'fill':'none','opacity':this.globalAlpha,'stroke-opacity':this.strokeOpacity,'style':'font: '+this.font,'stroke-dasharray':this.lineDash.join(','),'stroke-dashoffset':this.lineDashOffset});if(this.lineDash.length){this.surface.setElementAttributes(b,{'stroke-dasharray':this.lineDash.join(','),'stroke-dashoffset':this.lineDashOffset})}if(a.dom.firstChild){a.dom.removeChild(a.dom.firstChild)}this.surface.setElementAttributes(a,{'alignment-baseline':'alphabetic'});a.dom.appendChild(document.createTextNode(Ext.String.htmlDecode(c)))}},fillText:function(b,d,e){b=String(b);if(this.fillStyle){var c=this.getElement('text'),a=this.surface.getSvgElement(c,'tspan',0);this.surface.setElementAttributes(c,{'x':d,'y':e,'transform':this.matrix.toSvg(),'fill':this.fillStyle,'opacity':this.globalAlpha,'fill-opacity':this.fillOpacity,'style':'font: '+this.font});if(a.dom.firstChild){a.dom.removeChild(a.dom.firstChild)}this.surface.setElementAttributes(a,{'alignment-baseline':'alphabetic'});a.dom.appendChild(document.createTextNode(Ext.String.htmlDecode(b)))}},drawImage:function(b,j,k,d,c,o,p,n,i){var a=this,e=a.getElement('image'),l=j,m=k,h=typeof d==='undefined'?b.width:d,g=typeof c==='undefined'?b.height:c,f=null;if(typeof i!=='undefined'){f=j+' '+k+' '+d+' '+c;l=o;m=p;h=n;g=i}e.dom.setAttributeNS('http://www.w3.org/1999/xlink','href',b.src);a.surface.setElementAttributes(e,{viewBox:f,x:l,y:m,width:h,height:g,opacity:a.globalAlpha,transform:a.matrix.toSvg()})},fill:function(){var a=this;if(!a.path){return}if(a.fillStyle){var f,d=a.fillGradient,b=a.path.element,e=a.bbox,c;if(!b){f=a.path.toString();b=a.path.element=a.getElement('path');a.surface.setElementAttributes(b,{'d':f,'transform':a.matrix.toSvg()})}if(d&&e){c=d.generateGradient(a,e)}else {c=a.fillStyle}a.surface.setElementAttributes(b,{'fill':c,'fill-opacity':a.fillOpacity*a.globalAlpha})}},stroke:function(){var a=this;if(!a.path){return}if(a.strokeStyle){var d,e=a.strokeGradient,b=a.path.element,f=a.bbox,c;if(!b||!a.path.svgString){d=a.path.toString();if(!d){return}b=a.path.element=a.getElement('path');a.surface.setElementAttributes(b,{'fill':'none','d':d,'transform':a.matrix.toSvg()})}if(e&&f){c=e.generateGradient(a,f)}else {c=a.strokeStyle}a.surface.setElementAttributes(b,{'stroke':c,'stroke-linecap':a.lineCap,'stroke-linejoin':a.lineJoin,'stroke-width':a.lineWidth,'stroke-opacity':a.strokeOpacity*a.globalAlpha,'stroke-dasharray':a.lineDash.join(','),'stroke-dashoffset':a.lineDashOffset});if(a.lineDash.length){a.surface.setElementAttributes(b,{'stroke-dasharray':a.lineDash.join(','),'stroke-dashoffset':a.lineDashOffset})}}},fillStroke:function(c,b){var a=this,g=a.fillStyle,f=a.strokeStyle,e=a.fillOpacity,d=a.strokeOpacity;if(b===undefined){b=c.transformFillStroke}if(!b){c.inverseMatrix.toContext(a)}if(g&&e!==0){a.fill()}if(f&&d!==0){a.stroke()}},appendPath:function(a){this.path=a.clone()},setLineDash:function(a){this.lineDash=a},getLineDash:function(){return this.lineDash},createLinearGradient:function(d,f,e,g){var a=this,c=a.surface.getNextDef('linearGradient'),b;a.surface.setElementAttributes(c,{'x1':d,'y1':f,'x2':e,'y2':g,'gradientUnits':'userSpaceOnUse'});b=new Ext.draw.engine.SvgContext.Gradient(a,a.surface,c);return b},createRadialGradient:function(f,h,e,g,i,d){var a=this,c=a.surface.getNextDef('radialGradient'),b;a.surface.setElementAttributes(c,{'fx':f,'fy':h,'cx':g,'cy':i,'r':d,'gradientUnits':'userSpaceOnUse'});b=new Ext.draw.engine.SvgContext.Gradient(a,a.surface,c,e/d);return b}},1,0,0,0,0,0,[Ext.draw.engine,'SvgContext'],0);Ext.cmd.derive('Ext.draw.engine.SvgContext.Gradient',Ext.Base,{isGradient:!0,constructor:function(e,d,c,b){var a=this;a.ctx=e;a.surface=d;a.element=c;a.position=0;a.compression=b||0},addColorStop:function(d,c){var a=this,e=a.surface.getSvgElement(a.element,'stop',a.position++),b=a.compression;a.surface.setElementAttributes(e,{'offset':(((1-b)*d+b)*100).toFixed(2)+'%','stop-color':c,'stop-opacity':Ext.util.Color.fly(c).a.toFixed(15)})},toString:function(){var a=this.element.dom.childNodes;while(a.length>this.position){Ext.fly(a[a.length-1]).destroy()}return 'url(#'+this.element.getId()+')'}},3,0,0,0,0,0,[Ext.draw.engine.SvgContext,'Gradient'],0);Ext.cmd.derive('Ext.draw.engine.Svg',Ext.draw.Surface,{isSVG:!0,config:{highPrecision:!1},getElementConfig:function(){return {reference:'element',style:{position:'absolute'},children:[{reference:'innerElement',style:{width:'100%',height:'100%',position:'relative'},children:[{tag:'svg',reference:'svgElement',namespace:'http://www.w3.org/2000/svg',width:'100%',height:'100%',version:1.1}]}]}},constructor:function(b){var a=this;Ext.draw.Surface.prototype.constructor.call(this,b);a.mainGroup=a.createSvgNode('g');a.defsElement=a.createSvgNode('defs');a.svgElement.appendChild(a.mainGroup);a.svgElement.appendChild(a.defsElement);a.ctx=new Ext.draw.engine.SvgContext(a)},createSvgNode:function(b){var a=document.createElementNS('http://www.w3.org/2000/svg',b);return Ext.get(a)},getSvgElement:function(e,f,b){var c=e.dom.childNodes,d=c.length,a;if(b<d){a=c[b];if(a.tagName===f){return Ext.get(a)}else {Ext.destroy(a)}}else {if(b>d){Ext.raise('Invalid position.')}}a=Ext.get(this.createSvgNode(f));if(b===0){e.insertFirst(a)}else {a.insertAfter(Ext.fly(c[b-1]))}a.cache={};return a},setElementAttributes:function(d,c){var f=d.dom,e=d.cache,a,b;for(a in c){b=c[a];if(e[a]!==b){e[a]=b;f.setAttribute(a,b)}}},getNextDef:function(a){return this.getSvgElement(this.defsElement,a,this.defsPosition++)},clearTransform:function(){var a=this;a.mainGroup.set({transform:a.matrix.toSvg()})},clear:function(){this.ctx.clear();this.removeSurplusDefs();this.defsPosition=0},removeSurplusDefs:function(){var b=this.defsElement,c=b.dom.childNodes,d=c.length,a;for(a=d-1;a>this.defsPosition;a--){b.removeChild(c[a])}},renderSprite:function(a){var d=this,c=d.getRect(),b=d.ctx;if(a.attr.hidden||a.attr.globalAlpha===0){b.save();b.restore();return}a.element=b.save();a.preRender(this);a.useAttributes(b,c);if(!1===a.render(this,b,[0,0,c[2],c[3]])){return !1}a.setDirty(!1);b.restore()},toSVG:function(f,e){var g=Ext.getClassName(this),a,b,d,c;a='<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg" width="'+f.width+'" height="'+f.height+'">';for(c=0;c<e.length;c++){b=e[c];if(Ext.getClassName(b)!==g){continue}d=b.getRect();a+='<g transform="translate('+d[0]+','+d[1]+')">';a+=this.serializeNode(b.svgElement.dom);a+='</g>'}a+='</svg>';return a},flatten:function(c,b){var a='<?xml version="1.0" standalone="yes"?>';a+=this.toSVG(c,b);return {data:'data:image/svg+xml;utf8,'+encodeURIComponent(a),type:'svg'}},serializeNode:function(a){var c='',b,d,e,f;if(a.nodeType===document.TEXT_NODE){return a.nodeValue}c+='<'+a.nodeName;if(a.attributes.length){for(b=0,d=a.attributes.length;b<d;b++){e=a.attributes[b];c+=' '+e.name+'="'+e.value+'"'}}c+='>';if(a.childNodes&&a.childNodes.length){for(b=0,d=a.childNodes.length;b<d;b++){f=a.childNodes[b];c+=this.serializeNode(f)}}c+='</'+a.nodeName+'>';return c},destroy:function(){var a=this;a.ctx.destroy();a.mainGroup.destroy();a.defsElement.destroy();delete a.mainGroup;delete a.defsElement;delete a.ctx;Ext.draw.Surface.prototype.destroy.call(this)},remove:function(a,b){if(a&&a.element){a.element.destroy();a.element=null}Ext.draw.Surface.prototype.remove.apply(this,arguments)}},1,0,['widget','surface'],{'widget':!0,'surface':!0},0,0,[Ext.draw.engine,'Svg'],0);Ext.draw||(Ext.draw={});Ext.draw.engine||(Ext.draw.engine={});Ext.draw.engine.excanvas=!0;if(!document.createElement('canvas').getContext){(function(){var f=Math;var b=f.round;var n=f.sin;var m=f.cos;var t=f.abs;var s=f.sqrt;var c=10;var e=c/2;var u=+navigator.userAgent.match(/MSIE ([\d.]+)?/)[1];function getContext(){return this.context_||(this.context_=new CanvasRenderingContext2D_(this))}var p=Array.prototype.slice;function bind(c,a,d){var b=p.call(arguments,2);return function(){return c.apply(a,b.concat(p.call(arguments)))}}function encodeHtmlAttribute(a){return String(a).replace(/&/g,'&amp;').replace(/"/g,'&quot;')}function addNamespace(b,a,c){Ext.onReady(function(){if(!b.namespaces[a]){b.namespaces.add(a,c,'#default#VML')}})}function addNamespacesAndStylesheet(a){addNamespace(a,'g_vml_','urn:schemas-microsoft-com:vml');addNamespace(a,'g_o_','urn:schemas-microsoft-com:office:office');if(!a.styleSheets['ex_canvas_']){var b=a.createStyleSheet();b.owningElement.id='ex_canvas_';b.cssText='canvas{display:inline-block;overflow:hidden;text-align:left;width:300px;height:150px}'}}addNamespacesAndStylesheet(document);var o={init:function(b){var a=b||document;a.createElement('canvas');a.attachEvent('onreadystatechange',bind(this.init_,this,a))},init_:function(c){var b=c.getElementsByTagName('canvas');for(var a=0;a<b.length;a++){this.initElement(b[a])}},initElement:function(a){if(!a.getContext){a.getContext=getContext;addNamespacesAndStylesheet(a.ownerDocument);a.innerHTML='';a.attachEvent('onpropertychange',onPropertyChange);a.attachEvent('onresize',onResize);var b=a.attributes;if(b.width&&b.width.specified){a.style.width=b.width.nodeValue+'px'}else {a.width=a.clientWidth}if(b.height&&b.height.specified){a.style.height=b.height.nodeValue+'px'}else {a.height=a.clientHeight}}return a}};function onPropertyChange(b){var a=b.srcElement;switch(b.propertyName){case 'width':a.getContext().clearRect();a.style.width=a.attributes.width.nodeValue+'px';a.firstChild.style.width=a.clientWidth+'px';break;case 'height':a.getContext().clearRect();a.style.height=a.attributes.height.nodeValue+'px';a.firstChild.style.height=a.clientHeight+'px';break;}}function onResize(b){var a=b.srcElement;if(a.firstChild){a.firstChild.style.width=a.clientWidth+'px';a.firstChild.style.height=a.clientHeight+'px'}}o.init();var h=[];for(var i=0;i<16;i++){for(var j=0;j<16;j++){h[i*16+j]=i.toString(16)+j.toString(16)}}function createMatrixIdentity(){return [[1,0,0],[0,1,0],[0,0,1]]}function matrixMultiply(f,g){var d=createMatrixIdentity();for(var a=0;a<3;a++){for(var b=0;b<3;b++){var e=0;for(var c=0;c<3;c++){e+=f[a][c]*g[c][b]}d[a][b]=e}}return d}function copyState(a,b){b.fillStyle=a.fillStyle;b.lineCap=a.lineCap;b.lineJoin=a.lineJoin;b.lineDash=a.lineDash;b.lineWidth=a.lineWidth;b.miterLimit=a.miterLimit;b.shadowBlur=a.shadowBlur;b.shadowColor=a.shadowColor;b.shadowOffsetX=a.shadowOffsetX;b.shadowOffsetY=a.shadowOffsetY;b.strokeStyle=a.strokeStyle;b.globalAlpha=a.globalAlpha;b.font=a.font;b.textAlign=a.textAlign;b.textBaseline=a.textBaseline;b.arcScaleX_=a.arcScaleX_;b.arcScaleY_=a.arcScaleY_;b.lineScale_=a.lineScale_}var r={aliceblue:'#F0F8FF',antiquewhite:'#FAEBD7',aquamarine:'#7FFFD4',azure:'#F0FFFF',beige:'#F5F5DC',bisque:'#FFE4C4',black:'#000000',blanchedalmond:'#FFEBCD',blueviolet:'#8A2BE2',brown:'#A52A2A',burlywood:'#DEB887',cadetblue:'#5F9EA0',chartreuse:'#7FFF00',chocolate:'#D2691E',coral:'#FF7F50',cornflowerblue:'#6495ED',cornsilk:'#FFF8DC',crimson:'#DC143C',cyan:'#00FFFF',darkblue:'#00008B',darkcyan:'#008B8B',darkgoldenrod:'#B8860B',darkgray:'#A9A9A9',darkgreen:'#006400',darkgrey:'#A9A9A9',darkkhaki:'#BDB76B',darkmagenta:'#8B008B',darkolivegreen:'#556B2F',darkorange:'#FF8C00',darkorchid:'#9932CC',darkred:'#8B0000',darksalmon:'#E9967A',darkseagreen:'#8FBC8F',darkslateblue:'#483D8B',darkslategray:'#2F4F4F',darkslategrey:'#2F4F4F',darkturquoise:'#00CED1',darkviolet:'#9400D3',deeppink:'#FF1493',deepskyblue:'#00BFFF',dimgray:'#696969',dimgrey:'#696969',dodgerblue:'#1E90FF',firebrick:'#B22222',floralwhite:'#FFFAF0',forestgreen:'#228B22',gainsboro:'#DCDCDC',ghostwhite:'#F8F8FF',gold:'#FFD700',goldenrod:'#DAA520',grey:'#808080',greenyellow:'#ADFF2F',honeydew:'#F0FFF0',hotpink:'#FF69B4',indianred:'#CD5C5C',indigo:'#4B0082',ivory:'#FFFFF0',khaki:'#F0E68C',lavender:'#E6E6FA',lavenderblush:'#FFF0F5',lawngreen:'#7CFC00',lemonchiffon:'#FFFACD',lightblue:'#ADD8E6',lightcoral:'#F08080',lightcyan:'#E0FFFF',lightgoldenrodyellow:'#FAFAD2',lightgreen:'#90EE90',lightgrey:'#D3D3D3',lightpink:'#FFB6C1',lightsalmon:'#FFA07A',lightseagreen:'#20B2AA',lightskyblue:'#87CEFA',lightslategray:'#778899',lightslategrey:'#778899',lightsteelblue:'#B0C4DE',lightyellow:'#FFFFE0',limegreen:'#32CD32',linen:'#FAF0E6',magenta:'#FF00FF',mediumaquamarine:'#66CDAA',mediumblue:'#0000CD',mediumorchid:'#BA55D3',mediumpurple:'#9370DB',mediumseagreen:'#3CB371',mediumslateblue:'#7B68EE',mediumspringgreen:'#00FA9A',mediumturquoise:'#48D1CC',mediumvioletred:'#C71585',midnightblue:'#191970',mintcream:'#F5FFFA',mistyrose:'#FFE4E1',moccasin:'#FFE4B5',navajowhite:'#FFDEAD',oldlace:'#FDF5E6',olivedrab:'#6B8E23',orange:'#FFA500',orangered:'#FF4500',orchid:'#DA70D6',palegoldenrod:'#EEE8AA',palegreen:'#98FB98',paleturquoise:'#AFEEEE',palevioletred:'#DB7093',papayawhip:'#FFEFD5',peachpuff:'#FFDAB9',peru:'#CD853F',pink:'#FFC0CB',plum:'#DDA0DD',powderblue:'#B0E0E6',rosybrown:'#BC8F8F',royalblue:'#4169E1',saddlebrown:'#8B4513',salmon:'#FA8072',sandybrown:'#F4A460',seagreen:'#2E8B57',seashell:'#FFF5EE',sienna:'#A0522D',skyblue:'#87CEEB',slateblue:'#6A5ACD',slategray:'#708090',slategrey:'#708090',snow:'#FFFAFA',springgreen:'#00FF7F',steelblue:'#4682B4',tan:'#D2B48C',thistle:'#D8BFD8',tomato:'#FF6347',turquoise:'#40E0D0',violet:'#EE82EE',wheat:'#F5DEB3',whitesmoke:'#F5F5F5',yellowgreen:'#9ACD32'};function getRgbHslContent(a){var c=a.indexOf('(',3);var d=a.indexOf(')',c+1);var b=a.substring(c+1,d).split(',');if(b.length!=4||a.charAt(3)!='a'){b[3]=1}return b}function percent(a){return parseFloat(a)/100}function clamp(c,b,a){return Math.min(a,Math.max(b,c))}function hslToRgb(e){var j,g,f,b,c,a;b=parseFloat(e[0])/360%360;if(b<0){b++}c=clamp(percent(e[1]),0,1);a=clamp(percent(e[2]),0,1);if(c==0){j=g=f=a}else {var d=a<0.5?a*(1+c):a+c-a*c;var i=2*a-d;j=hueToRgb(i,d,b+1/3);g=hueToRgb(i,d,b);f=hueToRgb(i,d,b-1/3)}return '#'+h[Math.floor(j*255)]+h[Math.floor(g*255)]+h[Math.floor(f*255)]}function hueToRgb(b,c,a){if(a<0){a++}if(a>1){a--}if(6*a<1){return b+(c-b)*6*a}else {if(2*a<1){return c}else {if(3*a<2){return b+(c-b)*(2/3-a)*6}else {return b}}}}var k={};function processStyle(a){if(a in k){return k[a]}var c,e=1;a=String(a);if(a.charAt(0)=='#'){c=a}else {if(/^rgb/.test(a)){var b=getRgbHslContent(a);var c='#',f;for(var d=0;d<3;d++){if(b[d].indexOf('%')!=-1){f=Math.floor(percent(b[d])*255)}else {f=+b[d]}c+=h[clamp(f,0,255)]}e=+b[3]}else {if(/^hsl/.test(a)){var b=getRgbHslContent(a);c=hslToRgb(b);e=b[3]}else {c=r[a]||a}}}return k[a]={color:c,alpha:e}}var g={style:'normal',variant:'normal',weight:'normal',size:10,family:'sans-serif'};var l={};function processFontStyle(b){if(l[b]){return l[b]}var c=document.createElement('div');var a=c.style;try{a.font=b}catch(v){}return l[b]={style:a.fontStyle||g.style,variant:a.fontVariant||g.variant,weight:a.fontWeight||g.weight,size:a.fontSize||g.size,family:a.fontFamily||g.family}}function getComputedStyle(b,f){var a={};for(var e in b){a[e]=b[e]}var d=parseFloat(f.currentStyle.fontSize),c=parseFloat(b.size);if(typeof b.size=='number'){a.size=b.size}else {if(b.size.indexOf('px')!=-1){a.size=c}else {if(b.size.indexOf('em')!=-1){a.size=d*c}else {if(b.size.indexOf('%')!=-1){a.size=d/100*c}else {if(b.size.indexOf('pt')!=-1){a.size=c/0.75}else {a.size=d}}}}}a.size*=0.981;return a}function buildStyle(a){return a.style+' '+a.variant+' '+a.weight+' '+a.size+'px '+a.family}var q={'butt':'flat','round':'round'};function processLineCap(a){return q[a]||'square'}function CanvasRenderingContext2D_(a){this.m_=createMatrixIdentity();this.mStack_=[];this.aStack_=[];this.currentPath_=[];this.strokeStyle='#000';this.fillStyle='#000';this.lineWidth=1;this.lineJoin='miter';this.lineDash=[];this.lineCap='butt';this.miterLimit=c*1;this.globalAlpha=1;this.font='10px sans-serif';this.textAlign='left';this.textBaseline='alphabetic';this.canvas=a;var e='width:'+a.clientWidth+'px;height:'+a.clientHeight+'px;overflow:hidden;position:absolute';var b=a.ownerDocument.createElement('div');b.style.cssText=e;a.appendChild(b);var d=b.cloneNode(!1);d.style.backgroundColor='red';d.style.filter='alpha(opacity=0)';a.appendChild(d);this.element_=b;this.arcScaleX_=1;this.arcScaleY_=1;this.lineScale_=1}var a=CanvasRenderingContext2D_.prototype;a.clearRect=function(){if(this.textMeasureEl_){this.textMeasureEl_.removeNode(!0);this.textMeasureEl_=null}this.element_.innerHTML=''};a.beginPath=function(){this.currentPath_=[]};a.moveTo=function(b,c){var a=getCoords(this,b,c);this.currentPath_.push({type:'moveTo',x:a.x,y:a.y});this.currentX_=a.x;this.currentY_=a.y};a.lineTo=function(b,c){var a=getCoords(this,b,c);this.currentPath_.push({type:'lineTo',x:a.x,y:a.y});this.currentX_=a.x;this.currentY_=a.y};a.bezierCurveTo=function(a,b,c,d,g,h){var i=getCoords(this,g,h);var e=getCoords(this,a,b);var f=getCoords(this,c,d);bezierCurveTo(this,e,f,i)};function bezierCurveTo(b,c,d,a){b.currentPath_.push({type:'bezierCurveTo',cp1x:c.x,cp1y:c.y,cp2x:d.x,cp2y:d.y,x:a.x,y:a.y});b.currentX_=a.x;b.currentY_=a.y}a.quadraticCurveTo=function(d,e,g,h){var c=getCoords(this,d,e);var b=getCoords(this,g,h);var a={x:this.currentX_+2/3*(c.x-this.currentX_),y:this.currentY_+2/3*(c.y-this.currentY_)};var f={x:a.x+(b.x-this.currentX_)/3,y:a.y+(b.y-this.currentY_)/3};bezierCurveTo(this,a,f,b)};a.arc=function(d,f,a,g,i,h){a*=c;var p=h?'at':'wa';var b=d+m(g)*a-e;var q=f+n(g)*a-e;var l=d+m(i)*a-e;var r=f+n(i)*a-e;if(b==l&&!h){b+=0.125}var o=getCoords(this,d,f);var j=getCoords(this,b,q);var k=getCoords(this,l,r);this.currentPath_.push({type:p,x:o.x,y:o.y,radius:a,xStart:j.x,yStart:j.y,xEnd:k.x,yEnd:k.y})};a.rect=function(a,b,d,c){this.moveTo(a,b);this.lineTo(a+d,b);this.lineTo(a+d,b+c);this.lineTo(a,b+c);this.closePath()};a.strokeRect=function(a,b,d,c){var e=this.currentPath_;this.beginPath();this.moveTo(a,b);this.lineTo(a+d,b);this.lineTo(a+d,b+c);this.lineTo(a,b+c);this.closePath();this.stroke();this.currentPath_=e};a.fillRect=function(a,b,d,c){var e=this.currentPath_;this.beginPath();this.moveTo(a,b);this.lineTo(a+d,b);this.lineTo(a+d,b+c);this.lineTo(a,b+c);this.closePath();this.fill();this.currentPath_=e};a.createLinearGradient=function(b,d,c,e){var a=new CanvasGradient_('gradient');a.x0_=b;a.y0_=d;a.x1_=c;a.y1_=e;return a};a.createRadialGradient=function(d,f,b,e,g,c){var a=new CanvasGradient_('gradientradial');a.x0_=d;a.y0_=f;a.r0_=b;a.x1_=e;a.y1_=g;a.r1_=c;return a};a.drawImage=function(a,u){var j,k,i,h,d,e,m,l;var t=a.runtimeStyle.width;var s=a.runtimeStyle.height;a.runtimeStyle.width='auto';a.runtimeStyle.height='auto';var g=a.width;var f=a.height;a.runtimeStyle.width=t;a.runtimeStyle.height=s;if(arguments.length==3){j=arguments[1];k=arguments[2];d=e=0;m=i=g;l=h=f}else {if(arguments.length==5){j=arguments[1];k=arguments[2];i=arguments[3];h=arguments[4];d=e=0;m=g;l=f}else {if(arguments.length==9){d=arguments[1];e=arguments[2];m=arguments[3];l=arguments[4];j=arguments[5];k=arguments[6];i=arguments[7];h=arguments[8]}else {throw Error('Invalid number of arguments')}}}var r=getCoords(this,j,k);var o=[];var q=10;var p=10;var n=this.m_;o.push(' <g_vml_:group',' coordsize="',c*q,',',c*p,'"',' coordorigin="0,0"',' style="width:',b(q*n[0][0]),'px;height:',b(p*n[1][1]),'px;position:absolute;','top:',b(r.y/c),'px;left:',b(r.x/c),'px; rotation:',b(Math.atan(n[0][1]/n[1][1])*180/Math.PI),';');o.push('" >','<g_vml_:image src="',a.src,'"',' style="width:',c*i,'px;',' height:',c*h,'px"',' cropleft="',d/g,'"',' croptop="',e/f,'"',' cropright="',(g-d-m)/g,'"',' cropbottom="',(f-e-l)/f,'"',' />','</g_vml_:group>');this.element_.insertAdjacentHTML('BeforeEnd',o.join(''))};a.setLineDash=function(a){if(a.length===1){a=a.slice();a[1]=a[0]}this.lineDash=a};a.getLineDash=function(){return this.lineDash};a.stroke=function(g){var d=[];var j=10;var i=10;d.push('<g_vml_:shape',' filled="',!!g,'"',' style="position:absolute;width:',j,'px;height:',i,'px;left:0px;top:0px;"',' coordorigin="0,0"',' coordsize="',c*j,',',c*i,'"',' stroked="',!g,'"',' path="');var f={x:null,y:null};var e={x:null,y:null};for(var h=0;h<this.currentPath_.length;h++){var a=this.currentPath_[h];var k;switch(a.type){case 'moveTo':k=a;d.push(' m ',b(a.x),',',b(a.y));break;case 'lineTo':d.push(' l ',b(a.x),',',b(a.y));break;case 'close':d.push(' x ');a=null;break;case 'bezierCurveTo':d.push(' c ',b(a.cp1x),',',b(a.cp1y),',',b(a.cp2x),',',b(a.cp2y),',',b(a.x),',',b(a.y));break;case 'at':case 'wa':d.push(' ',a.type,' ',b(a.x-this.arcScaleX_*a.radius),',',b(a.y-this.arcScaleY_*a.radius),' ',b(a.x+this.arcScaleX_*a.radius),',',b(a.y+this.arcScaleY_*a.radius),' ',b(a.xStart),',',b(a.yStart),' ',b(a.xEnd),',',b(a.yEnd));break;}if(a){if(f.x==null||a.x<f.x){f.x=a.x}if(e.x==null||a.x>e.x){e.x=a.x}if(f.y==null||a.y<f.y){f.y=a.y}if(e.y==null||a.y>e.y){e.y=a.y}}}d.push(' ">');if(!g){appendStroke(this,d)}else {appendFill(this,d,f,e)}d.push('</g_vml_:shape>');this.element_.insertAdjacentHTML('beforeEnd',d.join(''))};function appendStroke(a,e){var d=processStyle(a.strokeStyle);var f=d.color;var c=d.alpha*a.globalAlpha;var b=a.lineScale_*a.lineWidth;if(b<1){c*=b}e.push('<g_vml_:stroke',' opacity="',c,'"',' joinstyle="',a.lineJoin,'"',' dashstyle="',a.lineDash.join(' '),'"',' miterlimit="',a.miterLimit,'"',' endcap="',processLineCap(a.lineCap),'"',' weight="',b,'px"',' color="',f,'" />')}function appendFill(b,m,g,v){var a=b.fillStyle;var h=b.arcScaleX_;var i=b.arcScaleY_;var k=v.x-g.x;var j=v.y-g.y;if(a instanceof CanvasGradient_){var e=0;var o={x:0,y:0};var p=0;var s=1;if(a.type_=='gradient'){var I=a.x0_/h;var K=a.y0_/i;var J=a.x1_/h;var L=a.y1_/i;var l=getCoords(b,I,K);var w=getCoords(b,J,L);var G=w.x-l.x;var H=w.y-l.y;e=Math.atan2(G,H)*180/Math.PI;if(e<0){e+=360}if(e<1.0E-6){e=0}}else {var l=getCoords(b,a.x0_,a.y0_);o={x:(l.x-g.x)/k,y:(l.y-g.y)/j};k/=h*c;j/=i*c;var r=f.max(k,j);p=2*a.r0_/r;s=2*a.r1_/r-p}var d=a.colors_;d.sort(function(a,c){return a.offset-c.offset});var n=d.length;var D=d[0].color;var E=d[n-1].color;var A=d[0].alpha*b.globalAlpha;var B=d[n-1].alpha*b.globalAlpha;var t=[];for(var q=0;q<n;q++){var u=d[q];t.push(u.offset*s+p+' '+u.color)}m.push('<g_vml_:fill type="',a.type_,'"',' method="none" focus="100%"',' color="',D,'"',' color2="',E,'"',' colors="',t.join(','),'"',' opacity="',B,'"',' g_o_:opacity2="',A,'"',' angle="',e,'"',' focusposition="',o.x,',',o.y,'" />')}else {if(a instanceof CanvasPattern_){if(k&&j){var y=-g.x;var z=-g.y;m.push('<g_vml_:fill',' position="',y/k*h*h,',',z/j*i*i,'"',' type="tile"',' src="',a.src_,'" />')}}else {var x=processStyle(b.fillStyle);var F=x.color;var C=x.alpha*b.globalAlpha;m.push('<g_vml_:fill color="',F,'" opacity="',C,'" />')}}}a.fill=function(){this.$stroke(!0)};a.closePath=function(){this.currentPath_.push({type:'close'})};function getCoords(f,b,d){var a=f.m_;return {x:c*(b*a[0][0]+d*a[1][0]+a[2][0])-e,y:c*(b*a[0][1]+d*a[1][1]+a[2][1])-e}}a.save=function(){var a={};copyState(this,a);this.aStack_.push(a);this.mStack_.push(this.m_)};a.restore=function(){if(this.aStack_.length){copyState(this.aStack_.pop(),this);this.m_=this.mStack_.pop()}};function matrixIsFinite(a){return isFinite(a[0][0])&&isFinite(a[0][1])&&isFinite(a[1][0])&&isFinite(a[1][1])&&isFinite(a[2][0])&&isFinite(a[2][1])}function setM(b,a,c){if(!matrixIsFinite(a)){return}b.m_=a;if(c){var d=a[0][0]*a[1][1]-a[0][1]*a[1][0];b.lineScale_=s(t(d))}}a.translate=function(a,b){var c=[[1,0,0],[0,1,0],[a,b,1]];setM(this,matrixMultiply(c,this.m_),!1)};a.rotate=function(a){var b=m(a);var c=n(a);var d=[[b,c,0],[-c,b,0],[0,0,1]];setM(this,matrixMultiply(d,this.m_),!1)};a.scale=function(a,b){this.arcScaleX_*=a;this.arcScaleY_*=b;var c=[[a,0,0],[0,b,0],[0,0,1]];setM(this,matrixMultiply(c,this.m_),!0)};a.transform=function(a,b,c,d,e,f){var g=[[a,b,0],[c,d,0],[e,f,1]];setM(this,matrixMultiply(g,this.m_),!0)};a.setTransform=function(a,b,c,d,e,f){var g=[[a,b,0],[c,d,0],[e,f,1]];setM(this,g,!0)};a.drawText_=function(q,r,s,t,j){var i=this.m_,k=1000,e=0,h=k,g={x:0,y:0},d=[];var f=getComputedStyle(processFontStyle(this.font),this.element_);var n=buildStyle(f);var l=this.element_.currentStyle;var a=this.textAlign.toLowerCase();switch(a){case 'left':case 'center':case 'right':break;case 'end':a=l.direction=='ltr'?'right':'left';break;case 'start':a=l.direction=='rtl'?'right':'left';break;default:a='left';}switch(this.textBaseline){case 'hanging':case 'top':g.y=f.size/1.75;break;case 'middle':break;default:case null:case 'alphabetic':case 'ideographic':case 'bottom':g.y=-f.size/3;break;}switch(a){case 'right':e=k;h=0.05;break;case 'center':e=h=k/2;break;}var m=getCoords(this,r+g.x,s+g.y);d.push('<g_vml_:line from="',-e,' 0" to="',h,' 0.05" ',' coordsize="100 100" coordorigin="0 0"',' filled="',!j,'" stroked="',!!j,'" style="position:absolute;width:1px;height:1px;left:0px;top:0px;">');if(j){appendStroke(this,d)}else {appendFill(this,d,{x:-e,y:0},{x:h,y:f.size})}var p=i[0][0].toFixed(3)+','+i[1][0].toFixed(3)+','+i[0][1].toFixed(3)+','+i[1][1].toFixed(3)+',0,0';var o=b(m.x/c)+','+b(m.y/c);d.push('<g_vml_:skew on="t" matrix="',p,'" ',' offset="',o,'" origin="',e,' 0" />','<g_vml_:path textpathok="true" />','<g_vml_:textpath on="true" string="',encodeHtmlAttribute(q),'" style="v-text-align:',a,';font:',encodeHtmlAttribute(n),'" /></g_vml_:line>');this.element_.insertAdjacentHTML('beforeEnd',d.join(''))};a.fillText=function(b,c,d,a){this.drawText_(b,c,d,a,!1)};a.strokeText=function(b,c,d,a){this.drawText_(b,c,d,a,!0)};a.measureText=function(a){if(!this.textMeasureEl_){var c='<span style="position:absolute;top:-20000px;left:0;padding:0;margin:0;border:none;white-space:pre;"></span>';this.element_.insertAdjacentHTML('beforeEnd',c);this.textMeasureEl_=this.element_.lastChild}var b=this.element_.ownerDocument;this.textMeasureEl_.innerHTML='';this.textMeasureEl_.style.font=this.font;this.textMeasureEl_.appendChild(b.createTextNode(a));return {width:this.textMeasureEl_.offsetWidth}};a.clip=function(){};a.arcTo=function(){};a.createPattern=function(b,a){return new CanvasPattern_(b,a)};function CanvasGradient_(a){this.type_=a;this.x0_=0;this.y0_=0;this.r0_=0;this.x1_=0;this.y1_=0;this.r1_=0;this.colors_=[]}CanvasGradient_.prototype.addColorStop=function(b,a){a=processStyle(a);this.colors_.push({offset:b,color:a.color,alpha:a.alpha})};function CanvasPattern_(a,b){assertImageIsValid(a);switch(b){case 'repeat':case null:case '':this.repetition_='repeat';break;case 'repeat-x':case 'repeat-y':case 'no-repeat':this.repetition_=b;break;default:throwException('SYNTAX_ERR');}this.src_=a.src;this.width_=a.width;this.height_=a.height}function throwException(a){throw new DOMException_(a)}function assertImageIsValid(a){if(!a||a.nodeType!=1||a.tagName!='IMG'){throwException('TYPE_MISMATCH_ERR')}if(a.readyState!='complete'){throwException('INVALID_STATE_ERR')}}function DOMException_(a){this.code=this[a];this.message=a+': DOM Exception '+this.code}var d=DOMException_.prototype=new Error();d.INDEX_SIZE_ERR=1;d.DOMSTRING_SIZE_ERR=2;d.HIERARCHY_REQUEST_ERR=3;d.WRONG_DOCUMENT_ERR=4;d.INVALID_CHARACTER_ERR=5;d.NO_DATA_ALLOWED_ERR=6;d.NO_MODIFICATION_ALLOWED_ERR=7;d.NOT_FOUND_ERR=8;d.NOT_SUPPORTED_ERR=9;d.INUSE_ATTRIBUTE_ERR=10;d.INVALID_STATE_ERR=11;d.SYNTAX_ERR=12;d.INVALID_MODIFICATION_ERR=13;d.NAMESPACE_ERR=14;d.INVALID_ACCESS_ERR=15;d.VALIDATION_ERR=16;d.TYPE_MISMATCH_ERR=17;G_vmlCanvasManager=o;CanvasRenderingContext2D=CanvasRenderingContext2D_;CanvasGradient=CanvasGradient_;CanvasPattern=CanvasPattern_;DOMException=DOMException_})()}Ext.cmd.derive('Ext.draw.engine.Canvas',Ext.draw.Surface,{isCanvas:!0,config:{highPrecision:!1},statics:{contextOverrides:{setGradientBBox:function(a){this.bbox=a},fill:function(){var d=this.fillStyle,b=this.fillGradient,a=this.fillOpacity,e=this.globalAlpha,c=this.bbox;if(d!==Ext.util.Color.RGBA_NONE&&a!==0){if(b&&c){this.fillStyle=b.generateGradient(this,c)}if(a!==1){this.globalAlpha=e*a}this.$fill();if(a!==1){this.globalAlpha=e}if(b&&c){this.fillStyle=d}}},stroke:function(){var d=this.strokeStyle,b=this.strokeGradient,a=this.strokeOpacity,e=this.globalAlpha,c=this.bbox;if(d!==Ext.util.Color.RGBA_NONE&&a!==0){if(b&&c){this.strokeStyle=b.generateGradient(this,c)}if(a!==1){this.globalAlpha=e*a}this.$stroke();if(a!==1){this.globalAlpha=e}if(b&&c){this.strokeStyle=d}}},fillStroke:function(d,b){var a=this,j=this.fillStyle,f=this.fillOpacity,h=this.strokeStyle,e=this.strokeOpacity,g=a.shadowColor,i=a.shadowBlur,c=Ext.util.Color.RGBA_NONE;if(b===undefined){b=d.transformFillStroke}if(!b){d.inverseMatrix.toContext(a)}if(j!==c&&f!==0){a.fill();a.shadowColor=c;a.shadowBlur=0}if(h!==c&&e!==0){a.stroke()}a.shadowColor=g;a.shadowBlur=i},setLineDash:function(a){if(this.$setLineDash){this.$setLineDash(a)}},getLineDash:function(){if(this.$getLineDash){return this.$getLineDash()}},ellipse:function(e,f,c,d,g,i,j,h){var a=Math.cos(g),b=Math.sin(g);this.transform(a*c,b*c,-b*d,a*d,e,f);this.arc(0,0,1,i,j,h);this.transform(a/c,-b/d,b/c,a/d,-(a*e+b*f)/c,(b*e-a*f)/d)},appendPath:function(f){var c=this,d=0,a=0,e=f.commands,b=f.params,g=e.length;c.beginPath();for(;d<g;d++){switch(e[d]){case 'M':c.moveTo(b[a],b[a+1]);a+=2;break;case 'L':c.lineTo(b[a],b[a+1]);a+=2;break;case 'C':c.bezierCurveTo(b[a],b[a+1],b[a+2],b[a+3],b[a+4],b[a+5]);a+=6;break;case 'Z':c.closePath();break;}}},save:function(){var c=this.toSave,e=c.length,d=e&&{},b=0,a;for(;b<e;b++){a=c[b];if(a in this){d[a]=this[a]}}this.state.push(d);this.$save()},restore:function(){var b=this.state.pop(),a;if(b){for(a in b){this[a]=b[a]}}this.$restore()}}},splitThreshold:3000,toSave:['fillGradient','strokeGradient'],element:{reference:'element',children:[{reference:'innerElement',style:{width:'100%',height:'100%',position:'relative'}}]},createCanvas:function(){var b=Ext.Element.create({tag:'canvas',cls:'x-surface-canvas'});if(window['G_vmlCanvasManager']){G_vmlCanvasManager.initElement(b.dom);this.isVML=!0}var c=Ext.draw.engine.Canvas.contextOverrides,a=b.dom.getContext('2d'),d;if(a.ellipse){delete c.ellipse}a.state=[];a.toSave=this.toSave;for(d in c){a['$'+d]=a[d]}Ext.apply(a,c);if(this.getHighPrecision()){this.enablePrecisionCompensation(a)}else {this.disablePrecisionCompensation(a)}this.innerElement.appendChild(b);this.canvases.push(b);this.contexts.push(a)},updateHighPrecision:function(d){var c=this.contexts,e=c.length,a,b;for(a=0;a<e;a++){b=c[a];if(d){this.enablePrecisionCompensation(b)}else {this.disablePrecisionCompensation(b)}}},precisionNames:['rect','fillRect','strokeRect','clearRect','moveTo','lineTo','arc','arcTo','save','restore','updatePrecisionCompensate','setTransform','transform','scale','translate','rotate','quadraticCurveTo','bezierCurveTo','createLinearGradient','createRadialGradient','fillText','strokeText','drawImage'],disablePrecisionCompensation:function(e){var d=Ext.draw.engine.Canvas.contextOverrides,c=this.precisionNames,f=c.length,a,b;for(a=0;a<f;a++){b=c[a];if(!(b in d)){delete e[b]}}this.setDirty(!0)},enablePrecisionCompensation:function(k){var h=this,a=1,c=1,d=0,e=0,g=new Ext.draw.Matrix(),j=[],f={},i=Ext.draw.engine.Canvas.contextOverrides,b=k.constructor.prototype;var l={toSave:h.toSave,rect:function(h,i,g,f){return b.rect.call(this,h*a+d,i*c+e,g*a,f*c)},fillRect:function(h,i,g,f){this.updatePrecisionCompensateRect();b.fillRect.call(this,h*a+d,i*c+e,g*a,f*c);this.updatePrecisionCompensate()},strokeRect:function(h,i,g,f){this.updatePrecisionCompensateRect();b.strokeRect.call(this,h*a+d,i*c+e,g*a,f*c);this.updatePrecisionCompensate()},clearRect:function(h,i,g,f){return b.clearRect.call(this,h*a+d,i*c+e,g*a,f*c)},moveTo:function(f,g){return b.moveTo.call(this,f*a+d,g*c+e)},lineTo:function(f,g){return b.lineTo.call(this,f*a+d,g*c+e)},arc:function(i,j,h,f,g,c){this.updatePrecisionCompensateRect();b.arc.call(this,i*a+d,j*a+e,h*a,f,g,c);this.updatePrecisionCompensate()},arcTo:function(g,i,h,j,f){this.updatePrecisionCompensateRect();b.arcTo.call(this,g*a+d,i*c+e,h*a+d,j*c+e,f*a);this.updatePrecisionCompensate()},save:function(){j.push(g);g=g.clone();i.save.call(this);b.save.call(this)},restore:function(){g=j.pop();i.restore.call(this);b.restore.call(this);this.updatePrecisionCompensate()},updatePrecisionCompensate:function(){g.precisionCompensate(h.devicePixelRatio,f);a=f.xx;c=f.yy;d=f.dx;e=f.dy;b.setTransform.call(this,h.devicePixelRatio,f.b,f.c,f.d,0,0)},updatePrecisionCompensateRect:function(){g.precisionCompensateRect(h.devicePixelRatio,f);a=f.xx;c=f.yy;d=f.dx;e=f.dy;b.setTransform.call(this,h.devicePixelRatio,f.b,f.c,f.d,0,0)},setTransform:function(c,d,e,f,a,b){g.set(c,d,e,f,a,b);this.updatePrecisionCompensate()},transform:function(c,d,e,f,a,b){g.append(c,d,e,f,a,b);this.updatePrecisionCompensate()},scale:function(a,b){this.transform(a,0,0,b,0,0)},translate:function(a,b){this.transform(1,0,0,1,a,b)},rotate:function(a){var b=Math.cos(a),c=Math.sin(a);this.transform(b,c,-c,b,0,0)},quadraticCurveTo:function(f,g,h,i){b.quadraticCurveTo.call(this,f*a+d,g*c+e,h*a+d,i*c+e)},bezierCurveTo:function(f,g,h,i,j,l){b.bezierCurveTo.call(this,f*a+d,g*c+e,h*a+d,i*c+e,j*a+d,l*c+e)},createLinearGradient:function(g,i,h,j){this.updatePrecisionCompensateRect();var f=b.createLinearGradient.call(this,g*a+d,i*c+e,h*a+d,j*c+e);this.updatePrecisionCompensate();return f},createRadialGradient:function(h,j,f,i,l,g){this.updatePrecisionCompensateRect();var c=b.createLinearGradient.call(this,h*a+d,j*a+e,f*a,i*a+d,l*a+e,g*a);this.updatePrecisionCompensate();return c},fillText:function(c,d,e,a){b.setTransform.apply(this,g.elements);if(typeof a==='undefined'){b.fillText.call(this,c,d,e)}else {b.fillText.call(this,c,d,e,a)}this.updatePrecisionCompensate()},strokeText:function(c,d,e,a){b.setTransform.apply(this,g.elements);if(typeof a==='undefined'){b.strokeText.call(this,c,d,e)}else {b.strokeText.call(this,c,d,e,a)}this.updatePrecisionCompensate()},fill:function(){var a=this.fillGradient,c=this.bbox;this.updatePrecisionCompensateRect();if(a&&c){this.fillStyle=a.generateGradient(this,c)}b.fill.call(this);this.updatePrecisionCompensate()},stroke:function(){var a=this.strokeGradient,c=this.bbox;this.updatePrecisionCompensateRect();if(a&&c){this.strokeStyle=a.generateGradient(this,c)}b.stroke.call(this);this.updatePrecisionCompensate()},drawImage:function(f,g,h,i,j,l,m,o,n){switch(arguments.length){case 3:return b.drawImage.call(this,f,g*a+d,h*c+e);case 5:return b.drawImage.call(this,f,g*a+d,h*c+e,i*a,j*c);case 9:return b.drawImage.call(this,f,g,h,i,j,l*a+d,m*c*e,o*a,n*c);}}};Ext.apply(k,l);this.setDirty(!0)},updateRect:function(c){Ext.draw.Surface.prototype.updateRect.call(this,c);var a=this,s=Math.floor(c[0]),u=Math.floor(c[1]),t=Math.ceil(c[0]+c[2]),r=Math.ceil(c[1]+c[3]),f=a.devicePixelRatio,g=a.canvases,q=t-s,p=r-u,d=Math.round(a.splitThreshold/f),n=a.xSplits=Math.ceil(q/d),o=a.ySplits=Math.ceil(p/d),l,m,e,h,i,b,k,j;for(m=0,i=0;m<o;m++,i+=d){for(l=0,h=0;l<n;l++,h+=d){e=m*n+l;if(e>=g.length){a.createCanvas()}b=g[e].dom;b.style.left=h+'px';b.style.top=i+'px';j=Math.min(d,p-i);if(j*f!==b.height){b.height=j*f;b.style.height=j+'px'}k=Math.min(d,q-h);if(k*f!==b.width){b.width=k*f;b.style.width=k+'px'}a.applyDefaults(a.contexts[e])}}a.activeCanvases=e=n*o;while(g.length>e){g.pop().destroy()}a.clear()},clearTransform:function(){var a=this,g=a.xSplits,j=a.ySplits,i=a.contexts,f=a.splitThreshold,e=a.devicePixelRatio,b,c,h,d;for(b=0;b<g;b++){for(c=0;c<j;c++){h=c*g+b;d=i[h];d.translate(-f*b,-f*c);d.scale(e,e);a.matrix.toContext(d)}}},renderSprite:function(b){var c=this,p=c.getRect(),u=c.matrix,d=b.getParent(),n=Ext.draw.Matrix.fly([1,0,0,1,0,0]),f=c.splitThreshold/c.devicePixelRatio,q=c.xSplits,v=c.ySplits,g,h,e,a,o,m,i=0,s,j=0,r,x=p[2],w=p[3],k,l,t;while(d&&d.isSprite){n.prependMatrix(d.matrix||d.attr&&d.attr.matrix);d=d.getParent()}n.prependMatrix(u);a=b.getBBox();if(a){a=n.transformBBox(a)}b.preRender(c);if(b.attr.hidden||b.attr.globalAlpha===0){b.setDirty(!1);return}for(l=0,h=0;l<v;l++,h+=f){for(k=0,g=0;k<q;k++,g+=f){t=l*q+k;e=c.contexts[t];o=Math.min(f,x-g);m=Math.min(f,w-h);i=g;s=i+o;j=h;r=j+m;if(a){if(a.x>s||a.x+a.width<i||a.y>r||a.y+a.height<j){continue}}e.save();b.useAttributes(e,p);if(!1===b.render(c,e,[i,j,o,m])){return !1}e.restore()}}b.setDirty(!1)},flatten:function(j,i){var b=document.createElement('canvas'),k=Ext.getClassName(this),d=this.devicePixelRatio,l=b.getContext('2d'),a,c,g,e,f,h;b.width=Math.ceil(j.width*d);b.height=Math.ceil(j.height*d);for(e=0;e<i.length;e++){a=i[e];if(Ext.getClassName(a)!==k){continue}g=a.getRect();for(f=0;f<a.canvases.length;f++){c=a.canvases[f];h=c.getOffsetsTo(c.getParent());l.drawImage(c.dom,(g[0]+h[0])*d,(g[1]+h[1])*d)}}return {data:b.toDataURL(),type:'png'}},applyDefaults:function(a){var b=Ext.util.Color.RGBA_NONE;a.strokeStyle=b;a.fillStyle=b;a.textAlign='start';a.textBaseline='alphabetic';a.miterLimit=1},clear:function(){var b=this,e=b.activeCanvases,a,c,d;for(a=0;a<e;a++){c=b.canvases[a].dom;d=b.contexts[a];d.setTransform(1,0,0,1,0,0);d.clearRect(0,0,c.width,c.height)}b.setDirty(!0)},destroy:function(){var b=this,c=b.canvases,d=c.length,a;for(a=0;a<d;a++){b.contexts[a]=null;c[a].destroy();c[a]=null}b.contexts=b.canvases=null;Ext.draw.Surface.prototype.destroy.call(this)},privates:{initElement:function(){var a=this;Ext.draw.Surface.prototype.initElement.call(this);a.canvases=[];a.contexts=[];a.activeCanvases=a.xSplits=a.ySplits=0}}},0,0,['widget','surface'],{'widget':!0,'surface':!0},0,0,[Ext.draw.engine,'Canvas'],function(){var c=this,b=c.prototype,a=1.0E10;if(Ext.os.is.Android4&&Ext.browser.is.Chrome){a=3000}else {if(Ext.is.iOS){a=2200}}b.splitThreshold=a});Ext.cmd.derive('Ext.draw.Container',Ext.draw.ContainerBase,{alternateClassName:'Ext.draw.Component',defaultType:'surface',isDrawContainer:!0,engine:'Ext.draw.engine.Canvas',config:{cls:['x-draw-container','x-unselectable'],resizeHandler:null,sprites:null,gradients:[],touchAction:{panX:!1,panY:!1,pinchZoom:!1,doubleTapZoom:!1},surfaceZIndexes:{main:1}},defaultDownloadServerUrl:'http://svg.sencha.io',supportedFormats:['png','pdf','jpeg','gif'],supportedOptions:{version:Ext.isNumber,data:Ext.isString,format:function(a){return Ext.Array.indexOf(this.supportedFormats,a)>=0},filename:Ext.isString,width:Ext.isNumber,height:Ext.isNumber,scale:Ext.isNumber,pdf:Ext.isObject,jpeg:Ext.isObject},initAnimator:function(){this.frameCallbackId=Ext.draw.Animator.addFrameCallback('renderFrame',this)},applyGradients:function(d){var b=[],c,f,a,e;if(!Ext.isArray(d)){return b}for(c=0,f=d.length;c<f;c++){a=d[c];if(!Ext.isObject(a)){continue}if(typeof a.type!=='string'){a.type='linear'}if(a.angle){a.degrees=a.angle;delete a.angle}if(Ext.isObject(a.stops)){a.stops=function(c){var b=[],a;for(e in c){a=c[e];a.offset=e/100;b.push(a)}return b}(a.stops)}b.push(a)}Ext.draw.gradient.GradientDefinition.add(b);return b},applySprites:function(c){if(!c){return}c=Ext.Array.from(c);var f=c.length,e=[],d,a,b;for(d=0;d<f;d++){b=c[d];a=b.surface;if(!(a&&a.isSurface)){if(Ext.isString(a)){a=this.getSurface(a);delete b.surface}else {a=this.getSurface('main')}}b=a.add(b);e.push(b)}return e},resizeDelay:500,resizeTimerId:0,size:null,handleResize:function(b,f){var a=this,d=a.element,e=a.getResizeHandler()||a.defaultResizeHandler,c;if(!d){return}b=b||d.getSize();if(!(b.width&&b.height)){return}a.size=b;a.stopResizeTimer();if(!f){a.resizeTimerId=Ext.defer(a.handleResize,a.resizeDelay,a,[b,!0]);return}a.fireEvent('bodyresize',a,b);c=e.call(a,b);if(c!==!1){a.renderFrame()}},stopResizeTimer:function(){if(this.resizeTimerId){clearTimeout(this.resizeTimerId);this.resizeTimerId=0}},defaultResizeHandler:function(a){this.getItems().each(function(b){b.setRect([0,0,a.width,a.height])})},getSurface:function(b,a){b=b||'main';a=a||b;var c=this,e=c.getItems(),g=e.getCount(),f=c.getSurfaceZIndexes(),d;d=c.createSurface(b);if(a in f){d.element.setStyle('zIndex',f[a])}if(e.getCount()>g){c.handleResize(null,!0)}return d},createSurface:function(a){a=this.getId()+'-'+(a||'main');var c=this,d=c.getItems(),b=d.get(a);if(!b){b=c.add({xclass:c.engine,id:a})}return b},renderFrame:function(){var e=this,c=e.getItems(),a,d,b;for(a=0,d=c.length;a<d;a++){b=c.items[a];if(b.isSurface){b.renderFrame()}}},getImage:function(h){var j=this.innerElement.getSize(),a=Array.prototype.slice.call(this.items.items),g=this.getSurfaceZIndexes(),b,f,d,e,c,i;for(e=1;e<a.length;e++){c=a[e];i=g[c.type];d=e-1;while(d>=0&&g[a[d].type]>i){a[d+1]=a[d];d--}a[d+1]=c}c=a[0];if((Ext.isIE||Ext.isEdge)&&c.isSVG){b={data:c.toSVG(j,a),type:'svg-markup'}}else {b=c.flatten(j,a);if(h==='image'){f=new Image();f.src=b.data;b.data=f;return b}if(h==='stream'){b.data=b.data.replace(/^data:image\/[^;]+/,'data:application/octet-stream');return b}}return b},download:function(a){var d=this,e=[],f,b,c;if(Ext.isIE8){return !1}a=Ext.apply({version:2,data:d.getImage().data},a);for(b in a){if(a.hasOwnProperty(b)){c=a[b];if(b in d.supportedOptions){if(d.supportedOptions[b].call(d,c)){e.push({tag:'input',type:'hidden',name:b,value:Ext.String.htmlEncode(Ext.isObject(c)?Ext.JSON.encode(c):c)})}}}}f=Ext.dom.Helper.markup({tag:'html',children:[{tag:'head'},{tag:'body',children:[{tag:'form',method:'POST',action:a.url||d.defaultDownloadServerUrl,children:e},{tag:'script',type:'text/javascript',children:'document.getElementsByTagName("form")[0].submit();'}]}]});window.open('','ImageDownload_'+Date.now()).document.write(f)},destroy:function(){var b=this,a=b.frameCallbackId;if(a){Ext.draw.Animator.removeFrameCallback(a)}b.stopResizeTimer();Ext.draw.ContainerBase.prototype.destroy.call(this)}},0,['draw'],['component','box','container','panel','draw'],{'component':!0,'box':!0,'container':!0,'panel':!0,'draw':!0},['widget.draw'],0,[Ext.draw,'Container',Ext.draw,'Component'],function(){if(location.search.match('svg')){Ext.draw.Container.prototype.engine='Ext.draw.engine.Svg'}else {if(Ext.os.is.BlackBerry&&Ext.os.version.getMajor()===10||Ext.browser.is.AndroidStock4&&(Ext.os.version.getMinor()===1||Ext.os.version.getMinor()===2||Ext.os.version.getMinor()===3)){Ext.draw.Container.prototype.engine='Ext.draw.engine.Svg'}}});Ext.cmd.derive('Ext.draw.PathUtil',Ext.Base,function(){var a=Math.abs,c=Math.pow,d=Math.cos,f=Math.acos,b=Math.sqrt,e=Math.PI;return {singleton:!0,cubicRoots:function(n){var q=n[0],u=n[1],v=n[2],w=n[3];if(q===0){return this.quadraticRoots(u,v,w)}var h=u/q,t=v/q,x=w/q,l=(3*t-c(h,2))/9,i=(9*h*t-27*x-2*c(h,3))/54,k=c(l,3)+c(i,2),g=[],o,p,s,m,j,r=Ext.Number.sign;if(k>=0){o=r(i+b(k))*c(a(i+b(k)),1/3);p=r(i-b(k))*c(a(i-b(k)),1/3);g[0]=-h/3+(o+p);g[1]=-h/3-(o+p)/2;g[2]=g[1];s=a(b(3)*(o-p)/2);if(s!==0){g[1]=-1;g[2]=-1}}else {m=f(i/b(-c(l,3)));g[0]=2*b(-l)*d(m/3)-h/3;g[1]=2*b(-l)*d((m+2*e)/3)-h/3;g[2]=2*b(-l)*d((m+4*e)/3)-h/3}for(j=0;j<3;j++){if(g[j]<0||g[j]>1){g[j]=-1}}return g},quadraticRoots:function(e,c,h){var f,g,a,d;if(e===0){return this.linearRoot(c,h)}f=c*c-4*e*h;if(f===0){a=[-c/(2*e)]}else {if(f>0){g=b(f);a=[(-c-g)/(2*e),(-c+g)/(2*e)]}else {return []}}for(d=0;d<a.length;d++){if(a[d]<0||a[d]>1){a[d]=-1}}return a},linearRoot:function(b,c){var a=-c/b;if(b===0||a<0||a>1){return []}return [a]},bezierCoeffs:function(b,c,d,e){var a=[];a[0]=-b+3*c-3*d+e;a[1]=3*b-6*c+3*d;a[2]=-3*b+3*c;a[3]=b;return a},cubicLineIntersections:function(s,t,u,v,w,x,y,z,d,e,h,p){var f=[],r=[],i=e-p,j=h-d,A=d*(p-e)-e*(h-d),a=this.bezierCoeffs(s,t,u,v),b=this.bezierCoeffs(w,x,y,z),k,q,l,c,g,m,n,o;f[0]=i*a[0]+j*b[0];f[1]=i*a[1]+j*b[1];f[2]=i*a[2]+j*b[2];f[3]=i*a[3]+j*b[3]+A;q=this.cubicRoots(f);for(k=0;k<q.length;k++){c=q[k];if(c<0||c>1){continue}g=c*c;m=g*c;n=a[0]*m+a[1]*g+a[2]*c+a[3];o=b[0]*m+b[1]*g+b[2]*c+b[3];if(h-d!==0){l=(n-d)/(h-d)}else {l=(o-e)/(p-e)}if(!(l<0||l>1)){r.push([n,o])}}return r},splitCubic:function(d,e,f,g,a){var h=a*a,k=a*h,b=a-1,c=b*b,j=b*c,i=k*g-3*h*b*f+3*a*c*e-j*d;return [[d,a*e-b*d,h*f-2*a*b*e+c*d,i],[i,h*g-2*a*b*f+c*e,a*g-b*f,g]]},cubicDimension:function(f,h,k,i){var l=3*(-f+3*(h-k)+i),j=6*(f-2*h+k),m=-3*(f-h),a,c,e=Math.min(f,i),d=Math.max(f,i),g;if(l===0){if(j===0){return [e,d]}else {a=-m/j;if(0<a&&a<1){c=this.interpolateCubic(f,h,k,i,a);e=Math.min(e,c);d=Math.max(d,c)}}}else {g=j*j-4*l*m;if(g>=0){g=b(g);a=(g-j)/2/l;if(0<a&&a<1){c=this.interpolateCubic(f,h,k,i,a);e=Math.min(e,c);d=Math.max(d,c)}if(g>0){a-=g/l;if(0<a&&a<1){c=this.interpolateCubic(f,h,k,i,a);e=Math.min(e,c);d=Math.max(d,c)}}}}return [e,d]},interpolateCubic:function(c,e,f,d,a){if(a===0){return c}if(a===1){return d}var b=(1-a)/a;return a*a*a*(d+b*(3*f+b*(3*e+b*c)))},cubicsIntersections:function(h,l,m,i,j,k,n,o,p,q,r,s,t,u,v,w){var b=this,x=b.cubicDimension(h,l,m,i),y=b.cubicDimension(j,k,n,o),z=b.cubicDimension(p,q,r,s),A=b.cubicDimension(t,u,v,w),d,e,f,g,c=[];if(x[0]>z[1]||x[1]<z[0]||y[0]>A[1]||y[1]<A[0]){return []}if(a(j-k)<1&&a(n-o)<1&&a(h-i)<1&&a(l-m)<1&&a(t-u)<1&&a(v-w)<1&&a(p-s)<1&&a(q-r)<1){return [[(h+i)*0.5,(j+k)*0.5]]}d=b.splitCubic(h,l,m,i,0.5);e=b.splitCubic(j,k,n,o,0.5);f=b.splitCubic(p,q,r,s,0.5);g=b.splitCubic(t,u,v,w,0.5);c.push.apply(c,b.cubicsIntersections.apply(b,d[0].concat(e[0],f[0],g[0])));c.push.apply(c,b.cubicsIntersections.apply(b,d[0].concat(e[0],f[1],g[1])));c.push.apply(c,b.cubicsIntersections.apply(b,d[1].concat(e[1],f[0],g[0])));c.push.apply(c,b.cubicsIntersections.apply(b,d[1].concat(e[1],f[1],g[1])));return c},linesIntersection:function(a,b,g,h,d,e,j,k){var i=(g-a)*(k-e)-(h-b)*(j-d),c,f;if(i===0){return null}c=((j-d)*(b-e)-(a-d)*(k-e))/i;f=((g-a)*(b-e)-(h-b)*(a-d))/i;if(c>=0&&c<=1&&f>=0&&f<=1){return [a+c*(g-a),b+c*(h-b)]}return null},pointOnLine:function(c,d,e,f,h,i){var g,b;if(a(e-c)<a(f-d)){b=c;c=d;d=b;b=e;e=f;f=b;b=h;h=i;i=b}g=(h-c)/(e-c);if(g<0||g>1){return !1}return a(d+g*(f-d)-i)<4},pointOnCubic:function(j,k,l,m,n,o,p,q,r,s){var b=this,h=b.bezierCoeffs(j,k,l,m),i=b.bezierCoeffs(n,o,p,q),c,d,f,g,e;h[3]-=r;i[3]-=s;f=b.cubicRoots(h);g=b.cubicRoots(i);for(c=0;c<f.length;c++){e=f[c];for(d=0;d<g.length;d++){if(e>=0&&e<=1&&a(e-g[d])<0.05){return !0}}}return !1}}},0,0,0,0,0,0,[Ext.draw,'PathUtil'],0);Ext.cmd.derive('Ext.draw.overrides.hittest.All',Ext.Base,{},0,0,0,0,0,0,[Ext.draw.overrides.hittest,'All'],0);Ext.cmd.derive('Ext.draw.plugin.SpriteEvents',Ext.plugin.Abstract,{mouseMoveEvents:{mousemove:!0,mouseover:!0,mouseout:!0},spriteMouseMoveEvents:{spritemousemove:!0,spritemouseover:!0,spritemouseout:!0},init:function(b){var a='handleEvent';this.drawContainer=b;b.addElementListener({click:a,dblclick:a,mousedown:a,mousemove:a,mouseup:a,mouseover:a,mouseout:a,priority:1001,scope:this})},hasSpriteMouseMoveListeners:function(){var b=this.drawContainer.hasListeners,a;for(a in this.spriteMouseMoveEvents){if(a in b){return !0}}return !1},hitTestEvent:function(e){var d=this.drawContainer.getItems(),c,b,a;for(a=d.length-1;a>=0;a--){c=d.get(a);b=c.hitTestEvent(e);if(b){return b}}return null},handleEvent:function(c){var b=this,d=b.drawContainer,f=c.type in b.mouseMoveEvents,e=b.lastSprite,a;if(f&&!b.hasSpriteMouseMoveListeners()){return}a=b.hitTestEvent(c);if(f&&!Ext.Object.equals(a,e)){if(e){d.fireEvent('spritemouseout',e,c)}if(a){d.fireEvent('spritemouseover',a,c)}}if(a){d.fireEvent('sprite'+c.type,a,c)}b.lastSprite=a}},0,0,0,0,['plugin.spriteevents'],0,[Ext.draw.plugin,'SpriteEvents'],0);Ext.cmd.derive('photoViewer.Values',Ext.Base,{singleton:!0,MSR_ZERO_POINTS:0,MSR_ONE_POINTS:1,MSR_TWO_POINTS:2,MSR_CALCULATING:3,MSR_DONE:4,DRAW_OFF:0,DRAW_ANNOTATING:1,DRAW_MEASURING:2,VIEW_TRUVIEW:1,VIEW_SITEWALK360:2},0,0,0,0,0,0,[photoViewer,'Values'],0);Ext.cmd.derive('photoViewer.controller.PanoramaMarkerController',Ext.app.Controller,{config:{markerLayer:null,directionMarker:null,directionArrow:null},getFloorplan:function(){return Ext.ComponentQuery.query('photoviewer')[0].getController().getFloorplan()},createMarkerLayer:function(){if(this.getMarkerLayer()==null&&!!this.map){var a=MVLeaflet||L;this.setMarkerLayer(new a.layerGroup());this.map.addLayer(this.getMarkerLayer());this.mapZoomHandler=this.mapZoomEndHandler.bind(this);this.map.on('zoomend',this.mapZoomHandler)}else {this.removeMarkerLayer()}return this.getMarkerLayer()},removeMarkerLayer:function(a){this.setDirectionMarker(null);if(this.getMarkerLayer()){this.getMarkerLayer().clearLayers();if(a){this.setMarkerLayer(null)}}},mapZoomEndHandler:function(c){if(!this.getMarkerLayer()){return}var b=c.target.getZoom();var a=this.getDirectionArrow();if(a&&a.classList){if(b==0){a.classList.add('small')}else {a.classList.remove('small')}}this.updateMarkerFOV()},getHotspot:function(){var e=this.getViewModel(),c=this.getFloorplan(),b=c.getHotspotsArray(),d=e.get('activePhoto.HotspotID');var a=Ext.Array.findBy(b,function(a){return a.id==d});if(!a){return}return a},getHotspotLatLng:function(){var a=this.getHotspot();if(!a){return}return {lng:a.geometry.coordinates[0],lat:a.geometry.coordinates[1]}},checkFloorplanReady:function(){var a=this.getFloorplan();if(a.map){this.map=a.map;if(!a.hotspotsLoaded){a.on({hotspotsLoaded:{fn:function(){this.checkFloorplanReady()},scope:this,single:!0}});return}this.floorplanReady()}else {a.on({afterinitfloorplan:{fn:function(){this.checkFloorplanReady()},scope:this,single:!0}})}},floorplanReady:function(){this.createMarkerLayer();this.updateMarkerFOV()},updateMarkerFOV:function(){var b=this.getHotspotLatLng();var a=this.getViewerAngle();if(Ext.isNumber(a)){this.updateDirectionMarkerOnFloorplan(b,a)}else {this.removeMarkerLayer()}},addDirectionMarkerToLayer:function(d,c){var b=MVLeaflet||L;var f=this.map?this.map.getZoom():0;var e=b.divIcon({className:'matterportDirectionMarker',div:!0,html:'<div class="matterportDirectionArrow'+(f==0?' small':'')+'"></div>'});var a=b.marker(c,{clickable:!1,icon:e});d.addLayer(a);return a},updateDirectionMarkerOnFloorplan:function(b,d){try{var a=this.getDirectionMarker();if(!a){a=this.addDirectionMarkerToLayer(this.getMarkerLayer(),b);this.setDirectionMarker(a);this.setDirectionArrow(a._icon.firstChild)}else {var c=a.getLatLng();c.lat=b.lat;c.lng=b.lng;a.setLatLng(c)}this.rotateMarker(d)}catch(e){console.log('Error placing direction marker on floorplan');console.log(e.message)}},rotateMarker:function(a){while(a<0){a+=360}var b=this.getDirectionArrow();if(b){var d='rotate('+a+'deg)';if(d!=b.style.transform){b.style.transform=d;var c=15;var e=Math.round(c*Math.sin(this.toRadians(a)));var f=Math.round(-c*Math.cos(this.toRadians(a))+c);b.style.marginLeft=e+'px';b.style.marginTop=f+'px'}}},toDegrees:function(a){return 180*a/Math.PI},toRadians:function(a){return Math.PI*a/180}},0,0,0,0,0,0,[photoViewer.controller,'PanoramaMarkerController'],0);Ext.cmd.derive('photoViewer.controller.SiteWalk360Controller',Ext.app.Controller,{config:{panos:[],activePano:null,panoMarkersMap:{},directionMarker:null,currentRotation:null,floorplanTheta:0,viewerReady:!1,truViewModel:null,matterportModel:null,primaryModelIsTruView:!1,currentScanUuid:null,currentModelId:null},init:function(){this.showcaseSDK=Ext.create('siteWalk360.MatterportShowcaseSDK');this.showcaseSDK.on('panoselect',this.panoSelected,this);this.showcaseSDK.on('panoselect',this.logViewPhotoEvent,this,{buffer:1});this.showcaseSDK.on('rotationchange',this.rotationChanged,this);this.showcaseSDK.on('showcaseconnected',this.showcaseConnected,this);this.showcaseSDK.on('initialpanosload',this.initialPanosLoaded,this);this.truViewSDK=Ext.create('siteWalk360.TruViewSDK');this.truViewSDK.on('scanviewerready',this.truViewScanViewerReady,this);this.truViewSDK.on('panoselect',this.panoSelected,this);this.truViewSDK.on('rotationchange',this.rotationChanged,this);window.sw360c=this},getViewModel:function(){if(!this.viewModel){this.viewModel=Ext.getCmp('mainView').getViewModel()}return this.viewModel},useImperial:function(){return !!(this.getViewModel().get('account.MeasurePreferenceID')==mdsData.PreferenceValues.MEASURE_PREFERENCE_IMPERIAL)},isTruView:function(){return this.getViewModel().get('photoState.isTruView')},setTruView:function(a){this.getViewModel().set('photoState.isTruView',a===!0)},isMatterport:function(){return !this.getViewModel().get('photoState.isTruView')},clearAll:function(){this.clearFloorplan();this.clearModels();this.clearViewer()},clearFloorplan:function(){this.debug('Clearing floorplan');this.setPanos([]);this.selectPano(null);this.setActivePano(null);this.setPanoMarkersMap({});this.removeDirectionMarker();this.setCurrentRotation(null);this.setFloorplanTheta(0);this.removePanoLayer()},clearModels:function(){this.setTruViewModel(null);this.setMatterportModel(null);this.setPrimaryModelIsTruView(!1);this.setCurrentScanUuid(null);this.setCurrentModelId(null)},clearViewer:function(){if(this.isTruView()){this.truViewSDK.clear()}else {this.showcaseSDK.clear()}this.setViewerReady(!1);this.removeDirectionMarker()},takeScreenShot:function(a){if(this.isTruView()){return this.truViewSDK.takeScreenShot()}return this.showcaseSDK.takeScreenShot(a)},getPose:function(){if(this.isTruView()){return new Promise(function(b,a){a('Not supported in TruView')})}return this.showcaseSDK.getPose()},switchViewer:function(f){var a=f?this.getTruViewModel():this.getMatterportModel();if(!a){return}var d=null;var h=this.getActivePano();var c=null;if(h){c=this.findNearestPano(h,a.panos);d=c?c.uuid:null}var b=this.getCurrentRotation();var e=f?this.getMatterportModel():this.getTruViewModel();if(e&&e.floorplanTheta!=a.floorplanTheta){var g=a.floorplanTheta-e.floorplanTheta;if(b){b.y=this.constrainAngle(b.y+g);this.debug('Adjusting current rotation by '+g+' degrees',b)}}if(c){this.setActivePano(c)}this.clearFloorplan();this.setCurrentRotation(b);if(f){this.setupTruView(a,d)}else {this.setupMatterportFrame(a,d)}},setupViewer:function(a){Ext.Ajax.request({url:mdslink.server+'/index.cfm?fuseaction=aClientPanorama.getModelValues&photoId='+a,success:function(c,d){try{var b=Ext.decode(c.responseText);if(b&&b.success&&b.data){this.debug('Interior pano model values',b);this.setModelValues(b.data)}else {throw new Error(mvstr['SW360_Failed to set up Site']+': '+(b?b.message:mvstr['G_UnexpectedError']))}}catch(e){this.error(e.message);Ext.Msg.alert(mvstr['G_Error'],e.message)}},failure:function(b){this.error(arguments);Ext.Msg.alert(mvstr['G_Error'],mvstr['SW360_Failed to set up Site']);this.clearFloorplan();this.clearModels()},scope:this})},setModelValues:function(a){this.debug('Loaded TruView/Matterport details',a);var b=this.getViewModel();var c=!!a.isTruView;var d=b.get('photoState.isTruView')!==c;b.set('photoState.isTruView',c);if(c){this.setTruViewModel(a.truViewModel);this.setPrimaryModelIsTruView(!0);if(!d){this.setupTruView(a.truViewModel)}this.setMatterportModel(a.matterportModel||null);b.set('hasMatterportAndTruView',a.matterportModel!=null)}else {this.setMatterportModel(a.matterportModel);this.setPrimaryModelIsTruView(!1);this.setupMatterportFrame(a.matterportModel);this.setTruViewModel(a.truViewModel||null);b.set('hasMatterportAndTruView',a.truViewModel!=null)}},setupMatterportFrame:function(c,a){var b=Ext.ComponentQuery.query('photoviewer')[0];if(!b){return this.setupMatterportFrame2(c,a)}if(this.matterportScriptLoaded){return this.setupMatterportFrame2(c,a)}b.setLoading(!0);Ext.Loader.loadScript({url:'https://static.matterport.com/showcase-sdk/1.2.0-0-g1d0799d/sdk.js',onLoad:function(){this.matterportScriptLoaded=!0;b.setLoading(!1);this.setupMatterportFrame(c,a)},scope:this})},setupMatterportFrame2:function(a,b){Ext.Loader.loadScript({url:'https://static.matterport.com/showcase-sdk/1.2.0-0-g1d0799d/sdk.js'});var f=a.modelId;var c=a.modelStart;if(!b&&c&&c.uuid){b=c.uuid}var i=this.getViewModel();var e=!0;var h=this.getCurrentModelId();if(h==f){this.debug('Matterport model already loaded: '+f);e=!1}if(e){this.showcaseSDK.clear()}this.debug('Matterport floorplan theta',a.floorplanTheta);this.setFloorplanTheta(a.floorplanTheta);var g=!1;if(a.panos){if(this.getPanos().length===0){g=!0}this.setPanos(a.panos)}var d=this.getCurrentRotation();if(c&&c.hasOwnProperty('camera_quaternion')){d=this.quaternionToEulerAngles(c.camera_quaternion);this.setCurrentRotation(d);this.debug('Starting rotation',d)}if(e){this.displayPanoMarkersOnFloorplan(b);this.debug('Loading new Matterport model: '+h+' -> '+f);this.showcaseSDK.addInteriorPanoIframeLoadListener(this.getInteriorPanoFrame());i.set('interiorPanoUrl',a.url);this.setCurrentModelId(a.modelId);this.setActivePano(this.getPanoFromUuid(b))}else {if(g){this.displayPanoMarkersOnFloorplan(b)}if(b){this.showcaseSDK.moveToPano(b,d,this.showcaseSDK.getInstantTransition())}this.getInteriorPanoFrame().focus()}},getInteriorPanoFrame:function(){return document.getElementById('interiorPanoFrame-iframeEl')},showcaseConnected:function(a){this.debug('Showcase connected',a);this.setViewerReady(a);this.updateDirectionMarkerOnFloorplan();this.fireEvent('showcaseconnected',a)},initialPanosLoaded:function(b){var a=this.getActivePano();if(a){this.showcaseSDK.moveToPano(a.uuid,this.getCurrentRotation(),this.showcaseSDK.getInstantTransition());this.updateDirectionMarkerOnFloorplan();this.panToMarker(a.x,a.y,!1)}else {this.showcaseSDK.getPose().then(function(a){if(a&&a.rotation&&a.sweep){this.rotationChanged(a.rotation,a.sweep);var c=this.getActivePano();if(c){this.panToMarker(c.x,c.y,!1)}this.logViewPhotoEvent()}return a}.bind(this))}},setupTruView:function(b,a){var c=Ext.ComponentQuery.query('photoviewer')[0];if(!c){return this.setupTruView2(b,a)}if(this.truViewViewerScriptLoaded&&this.truViewMapScriptLoaded){return this.setupTruView2(b,a)}c.setLoading(!0);Ext.Loader.loadScript({url:'https://multivista.truView-cloud.com/scripts/dist/viewer.js',onLoad:function(){this.truViewViewerScriptLoaded=!0;if(this.truViewMapScriptLoaded){this.setupTruView(b,a)}},scope:this});Ext.Loader.loadScript({url:'https://multivista.truView-cloud.com/scripts/dist/map.js',onLoad:function(){this.truViewMapScriptLoaded=!0;if(this.truViewViewerScriptLoaded){this.setupTruView(b,a)}},scope:this})},setupTruView2:function(b,f){var a=f||b.scanUuid;var d=!0;var e=this.getCurrentScanUuid();if(a&&e==a){this.debug('TruView scan already loaded: '+a);d=!1}this.setFloorplanTheta(b.floorplanTheta);var c=!1;if(b.panos){if(this.getPanos().length===0){c=!0}this.setPanos(b.panos)}if(d){this.setCurrentScanUuid(a);this.displayPanoMarkersOnFloorplan(a);this.debug('Loading new TruView scan:',a);this.loadTruViewScan(a)}else {if(c){this.displayPanoMarkersOnFloorplan(a);this.logViewPhotoEvent()}}},loadTruViewScan:function(a){this.setViewerReady(!1);this.setTruView(!0);this.truViewSDK.showScanViewer('truViewComponent',a,this.getCurrentRotation(),this.useImperial())},truViewScanViewerReady:function(b,a){if(a){this.error('Failed to load TruView Viewer',a);return}this.debug('TruView viewer ready',b);this.setViewerReady(!0);this.updateDirectionMarkerOnFloorplan();this.logViewPhotoEvent()},panoSelected:function(a){this.selectPanoByUuid(a,!1,!0)},rotationChanged:function(b,c){var a=this.getActivePano();if(a&&a.uuid===c){this.setCurrentRotation(b);this.updateDirectionMarkerOnFloorplan()}},getPanoFromUuid:function(b){if(b){var c=this.getPanos();for(var a=0;a<c.length;a++){var d=c[a];if(d.uuid==b){return d}}}return null},selectPanoInViewer:function(b,a,c){a=a||this.getCurrentRotation();if(a!=null){this.setCurrentRotation(a)}if(this.isTruView()){this.loadTruViewScan(b)}else {this.showcaseSDK.moveToPano(b,a,c)}},selectPano:function(a,e,f,h){var b=this.getFloorplan().map?this.getFloorplan().map.activePano:null;if(a!=b||h){var c=this.getPanoMarkersMap();if(b){this.removeMarkerClass(c[b.uuid],'active')}this.setActivePano(a);if(this.map){this.map.activePano=a}if(a){this.addMarkerClass(c[a.uuid],'active');var d=this.getFloorplan();if(d.highlightLayer){d.highlightLayer.clearLayers()}if(e){var g=a.rotation?this.quaternionToEulerAngles(a.rotation):null;this.selectPanoInViewer(a.uuid,g)}this.updateDirectionMarkerOnFloorplan();this.panToMarker(a.x,a.y,f)}}},selectPanoByUuid:function(d,b,c){var a=this.getPanoFromUuid(d);this.selectPano(a,b,c);return a},getFloorplan:function(){return Ext.ComponentQuery.query('photoviewer')[0].getController().getFloorplan()},displayPanoMarkersOnFloorplan:function(a){a=a||(this.getActivePano()?this.getActivePano().uuid:null);var b=this.getFloorplan();if(b.map){this.map=b.map;if(!b.hotspotsLoaded){this.debug('Waiting for hotspots to be loaded...');b.on({hotspotsLoaded:{fn:function(){this.displayPanoMarkersOnFloorplan(a)},scope:this,single:!0}});return}var c=this.getPanos();this.debug('Displaying '+c.length+' panos');var h=this.createPanoLayer();var g=this.getPanoMarkerRadius();this.setPanoMarkersMap({});for(var d=0;d<c.length;d++){var e=c[d];var f=e.uuid===a;this.createPanoMarker(h,e,f,g)}}else {this.debug('Floorplan not ready');b.on({afterinitfloorplan:{fn:function(){this.displayPanoMarkersOnFloorplan(a)},scope:this,single:!0}})}},createPanoMarker:function(f,b,d,e){var a;if(b.photoId>0){return}else {a=this.addPanoScanMarker(f,b.x,b.y,{radius:e,className:'panoMarker'});a.scan=!0}a.pano=b;var c=this.getPanoMarkersMap();c[b.uuid]=a;if(d){this.selectPano(b,!1,!0,!0)}this.addPanoMarkerEventListeners(a);return a},addPanoMarkerEventListeners:function(a){a.on('click',function(c){var b=c.target.pano;this.selectPano(b,!0)},this);a.on('mouseover',function(b){a.setRadius(this.getPanoMarkerRadius(!0));a.bringToFront()},this);a.on('mouseout',function(b){a.setRadius(this.getPanoMarkerRadius())},this)},getDirectionMarker:function(){return this.getFloorplan().map?this.getFloorplan().map.directionMarker:null},setDirectionMarker:function(b){var a=this.getFloorplan().map;if(a){a.directionMarker=b}},getPanoScanLayer:function(){return this.getFloorplan().map?this.getFloorplan().map.panoScanLayer:null},setPanoScanLayer:function(b){var a=this.getFloorplan().map;if(a){a.panoScanLayer=b}},getDirectionArrow:function(){return this.getFloorplan().map?this.getFloorplan().map.directionArrow:null},setDirectionArrow:function(b){var a=this.getFloorplan().map;if(a){a.directionArrow=b}},panoHasPhoto:function(){if(!this.getActivePano()){return !1}if(!this.getPrimaryModelIsTruView()&&this.isTruView()&&this.getMatterportModel()){var a=this.findNearestPano(this.getActivePano(),this.getMatterportModel().panos);if(a){return !!a.photoId}}else {return !!this.getActivePano().photoId}return !1},logViewPhotoEvent:function(){if(this.panoHasPhoto()){if(this.isMatterport()){analytics.Ctrl.log('Viewed Photo',{'Photo Type':'SW360'},['Photo ID','Photo ID with Prefix'])}else {analytics.Ctrl.log('Viewed Photo',{'Photo Type':'TruView'},['Photo ID','Photo ID with Prefix'])}}}},0,0,0,0,0,[[siteWalk360.SW360Util.prototype.mixinId||siteWalk360.SW360Util.$className,siteWalk360.SW360Util],[SiteWalk360.FloorplanPanoUtil.prototype.mixinId||SiteWalk360.FloorplanPanoUtil.$className,SiteWalk360.FloorplanPanoUtil]],[photoViewer.controller,'SiteWalk360Controller'],0);Ext.cmd.derive('photoViewer.model.Annotation',Ext.data.Model,{fields:[{name:'AnnotationUID',type:'string'},{name:'Type',type:'string'},{name:'Attr0',type:'auto',defaultValue:undefined},{name:'Attr1',type:'auto',defaultValue:undefined},{name:'Attr2',type:'auto',defaultValue:undefined},{name:'Attr3',type:'auto',defaultValue:undefined},{name:'Attr4',type:'auto',defaultValue:undefined},{name:'Attr5',type:'auto',convert:function(b,c){var a=c.get('Type');if(a&&a.substr&&a.substr(0,4)=='text'){return String(b)}return b},depends:['Type'],persist:!0},{name:'Attr6',type:'auto',defaultValue:undefined},{name:'Attr7',type:'auto',defaultValue:undefined},{name:'Attr8',type:'auto',defaultValue:undefined},{name:'Attr9',type:'auto',defaultValue:undefined},{name:'Attr10',type:'auto',defaultValue:undefined},{name:'Attr11',type:'auto',defaultValue:undefined},{name:'Attr12',type:'auto',defaultValue:undefined,convert:function(a){return a&&isNaN(a)?Number(a.match(/^\d+/)[0]):a}},{name:'ShareTypeID',type:'int',defaultValue:1},{name:'MemberUIDArray',defaultValue:[]},{name:'ReadOnly',type:'boolean',defaultValue:!1},{name:'Color',type:'string',calculate:function(a){return a.Attr4}},{name:'MemberFirstName',type:'string',persist:!1},{name:'MemberLastName',type:'string',persist:!1},{name:'Title'},{name:'MemberInitials',calculate:function(a){var b=[];if(a.MemberFirstName){b.push(a.MemberFirstName.charAt(0).toUpperCase())}if(a.MemberLastName){b.push(a.MemberLastName.charAt(0).toUpperCase())}return b.join('')}},{name:'MemberName',calculate:function(a){return Ext.String.trim(a.MemberFirstName+' '+a.MemberLastName)}},{name:'Visible',type:'boolean',persist:!1,defaultValue:!0},{name:'CanEdit',calculate:function(a){return !a.ReadOnly}},{name:'Length',calculate:function(a){return a.Type=='measure'&&a.Attr7?Number(a.Attr7):0}},{name:'MeasurementString',calculate:function(a){if(a.Type!='measure'||!a.Length){return ''}if(a.IsMetric){return ''+a.Length.toFixed(3)+'m'}var e=a.Length*3.28084,c=Math.floor(e),f=(e-c)*12,d=Math.inchesToString(f,32),b=[];if(c){b.push(''+c+"'")}if(d!='0'||!b.length){b.push(''+d+'"')}return b.join(' ')}},{name:'TitleDisplayValue',calculate:function(a){if(a.Type=='measure'){var b=a.TitleDisplayName;if(a.MeasurementString){return b+' ('+a.MeasurementString+')'}else {return mvstr['PM_Pending Measurement']}}return a.Title}},{name:'TitleDisplayName',calculate:function(a){return a.Title||mvstr['PM_Measurement']}},{name:'IsMetric',type:'boolean',persist:!1}],idProperty:'AnnotationUID',setShape:function(a){this.shape=a;a.record=this;this.set('Type',a.getType());this.updateFields();a.addListener('datachanged',this.updateFields,this)},updateFields:function(){if(this.get('ReadOnly')){return}var b=this.store&&this.store.getProxy().type!='memory';if(b){this.store.suspendAutoSync()}var e=!1;for(var a=0;a<this.shape.shapeAttributes.length;a++){if(Ext.Array.contains(this.shape.dataAttributes,this.shape.shapeAttributes[a])){continue}var d='Attr'+a,c=this.shape.getAttribute(this.shape.shapeAttributes[a]);if(this.get(d)!==c){e=!0;this.set(d,c)}}if(b){this.store.resumeAutoSync(e)}},destroy:function(){if(this.shape){this.shape.destroy()}},redraw:function(){if(this.shape){var a=this.shape.drawComponent;this.shape.destroy();this.createShape(a)}},createShape:function(c){var a={};a.model=this;a.drawComponent=c;var b=this.get('Type');var d=b.substring(0,1).toUpperCase()+b.substring(1);this.shape=Ext.create('photoViewer.view.annotations.shapes.'+d,a);this.shape.addListener('datachanged',this.updateFields,this)},set:function(a,b){Ext.data.Model.prototype.set.apply(this,arguments);if(this.shape){if(a=='Title'){this.shape.onTitleChange(b)}else {if(a=='IsMetric'){this.shape.onIsMetricChange(b)}}}},getRecordValueByAttrName:function(a){return this.shape.getRecordValueByAttrName(a)},getAttrFieldName:function(a){return this.shape.getAttrFieldName(a)},setAttr:function(a,b){this.set(this.getAttrFieldName(a),b)},setAttrs:function(c){var b={};for(var a in c){b[this.getAttrFieldName(a)]=c[a]}this.set(b)}},0,0,0,0,0,0,[photoViewer.model,'Annotation'],0);Ext.cmd.derive('photoViewer.model.Timelapse',Ext.data.Model,{fields:[{name:'WebcamUID',type:'string'},{name:'ArchivePositionID',type:'int'},{name:'TimelapseURL',type:'string'}]},0,0,0,0,0,0,[photoViewer.model,'Timelapse'],0);Ext.cmd.derive('photoViewer.model.Webcam',Ext.data.Model,{fullWebcamData:null,PTZLimits:null,fields:[{name:'WebcamUID',type:'string'},{name:'MostRecentPhotoDate',type:'tzadate'},{name:'FirstPhotoDate',type:'tzadate'},{name:'WebcamLabel',type:'string'},{name:'WebcamIsStreaming',type:'int'},{name:'TimelapseURL',type:'string'},{name:'TimelapseIsAvailable',convert:function(a){return a?1:0}},{name:'PTZPresets'},{name:'ArchivePositions'}],idProperty:'WebcamUID',getFullWebcamData:function(b){var a=this;var c=a.get('WebcamUID');return new Ext.Promise(Ext.bind(function(d,e){if(a.fullWebcamData){d(a.fullWebcamData)}else {mdsAjax.doAjaxRequest({url:'/index.cfm?fuseaction=aClientWebcam.getWebcam&ProjectUID='+b+'&WebcamUID='+c,successCallback:function(c){c.ProjectUID=b;c.WebcamUID=a.getId();a.fullWebcamData=c;d(a.fullWebcamData)},afterFailMessageCallback:function(){e()},noResponseCallback:function(){Ext.Msg.alert('','Webcam is currently unavailable');e()},scope:a})}},a))}},0,0,0,0,0,0,[photoViewer.model,'Webcam'],0);Ext.cmd.derive('photoViewer.store.Annotations',Ext.data.Store,{model:'photoViewer.model.Annotation',autoSync:!0,statics:{getDefaultAnnotationTitle:function(b,a){return mvstr['PAN_'+b]+' '+a}},constructor:function(b){var a=this;this.config.proxy={type:'jsonp',api:{create:'/index.cfm?fuseaction=aClientPhotoViewer.addAnnotations',read:'/index.cfm?fuseaction=aClientPhotoViewer.getAnnotations',update:'/index.cfm?fuseaction=aClientPhotoViewer.updateAnnotations',destroy:'/index.cfm?fuseaction=aClientPhotoViewer.deleteAnnotations'},reader:{type:'json',rootProperty:'data',transform:{fn:function(e){var d={};for(var g=0;g<e.data.length;g++){var c=e.data[g];c.IsMetric=!!a.usingMetric;if(!c.Title){var f;do{d[c.Type]=d[c.Type]?d[c.Type]+1:1;f=photoViewer.store.Annotations.getDefaultAnnotationTitle(c.Type,d[c.Type])}while(a.isInDataOrStore(e.data,'Title',f));c.Title=f}else {c.HasDefaultTitle=!1}}return e},scope:a}},writer:{writeAllFields:!0}};a.callParent(arguments)},isInDataOrStore:function(d,b,c){if(this.findExact(b,c)!=-1){return !0}for(var a=0;a<d.length;a++){if(d[a][b]==c){return !0}}return !1},sync:function(a){a=a||{};a.silentSuccess=!0;if(this.isSyncing){if(this.syncListener){this.syncListener.destroy()}this.syncListener=this.addListener('datachanged',Ext.bind(this.sync,this,[a]),this,{destroyable:!0})}else {var e=this.getProxy().getExtraParams().photo,b=this.getModifiedRecords(),c=b.length?'Annotated Photo':'';for(var d=0;d<b.length;d++){if(b[d].get('Type')=='measure'){c='Saved New Measurement'}}if(c){this.fireEvent('logevent',e,c)}Ext.data.Store.prototype.sync.call(this,a)}},destroyShapes:function(){this.each(function(a){if(a.shape){a.shape.destroy()}})}},1,0,0,0,['store.photoviewerannotations'],0,[photoViewer.store,'Annotations'],0);Ext.cmd.derive('photoViewer.store.ExifData',Ext.data.Store,{proxy:{type:'ajax',url:'/index.cfm?fuseaction=aClientPhotoViewer.getExifData',reader:{type:'json',rootProperty:'data'}},fields:[{name:'name'},{name:'description'}],tagFilter:new Ext.util.Filter({id:'tagFilter',filterFn:function(b){var a=['photooriginaldate','photometeringmode','make','model','exposure comp','exposure program','iso','focusmode','focus mode','shootingmode','shooting mode','af type','afareamode','af-area mode','focallength','focal length','flash','shuttercount','shutter count','serialnumber','serial number','body serial number','camera serial number','quality','quality & file format','whitebalance','white balance','copyright','artist','imagecomment','image comment'];return a.indexOf(b.data.name.toLowerCase())!=-1}}),filterTags:function(){this.addFilter(this.tagFilter);this.refreshFilters()},unFilterTags:function(){this.removeFilter('tagFilter');this.refreshFilters()}},0,0,0,0,['store.exifdata'],0,[photoViewer.store,'ExifData'],0);Ext.cmd.derive('photoViewer.store.Webcams',Ext.data.Store,{model:'photoViewer.model.Webcam',autoLoad:!1,proxy:{type:'jsonp',url:'/index.cfm?fuseaction=aClientWebcam.getWebcams',reader:{type:'json',rootProperty:'data'}}},0,0,0,0,['store.pvwebcams'],0,[photoViewer.store,'Webcams'],0);Ext.cmd.derive('photoViewer.dd.DragDropManager',Ext.Base,{singleton:!0,alternateClassName:['Ext.dd.DragDropMgr','Ext.dd.DDM'],ids:{},handleIds:{},dragCurrent:null,dragOvers:{},deltaX:0,deltaY:0,preventDefault:!0,stopPropagation:!0,initialized:!1,locked:!1,init:function(){this.initialized=!0},POINT:0,INTERSECT:1,mode:0,notifyOccluded:!1,dragCls:'x-dd-drag-current',_execOnAll:function(f,g){var c=this.ids,d,e,b,a;for(d in c){if(c.hasOwnProperty(d)){a=c[d];for(e in a){if(a.hasOwnProperty(e)){b=a[e];if(!this.isTypeOfDD(b)){continue}b[f].apply(b,g)}}}}},addListeners:function(){var a=this;a.init();Ext.getDoc().on({mouseup:{fn:a.handleMouseUp,capture:!1,priority:-1000},mousemove:{fn:a.handleMouseMove,capture:!1},dragstart:a.preventDrag,drag:a.preventDrag,dragend:a.preventDrag,capture:!0,scope:a});Ext.getWin().on({unload:a._onUnload,resize:a._onResize,scope:a})},preventDrag:function(a){if(this.isMouseDown){a.stopPropagation()}},_onResize:function(a){this._execOnAll('resetConstraints',[])},lock:function(){this.locked=!0},unlock:function(){this.locked=!1},isLocked:function(){return this.locked},locationCache:{},useCache:!0,clickPixelThresh:8,dragThreshMet:!1,clickTimeout:null,startX:0,startY:0,regDragDrop:function(b,a){if(!this.initialized){this.init()}if(!this.ids[a]){this.ids[a]={}}this.ids[a][b.id]=b},removeDDFromGroup:function(c,a){if(!this.ids[a]){this.ids[a]={}}var b=this.ids[a];if(b&&b[c.id]){delete b[c.id]}},_remove:function(b,f){var a=this,d=a.ids,e=b.groups,c;if(a.clearingAll){return}if(a.dragCurrent===b){a.dragCurrent=null}for(c in e){if(e.hasOwnProperty(c)){if(f){delete d[c]}else {if(d[c]){delete d[c][b.id]}}}}delete a.handleIds[b.id];delete a.locationCache[b.id]},regHandle:function(a,b){if(!this.handleIds[a]){this.handleIds[a]={}}this.handleIds[a][b]=b},isDragDrop:function(a){return this.getDDById(a)?!0:!1},getRelated:function(f,e){var b=[],c,d,a;for(c in f.groups){for(d in this.ids[c]){a=this.ids[c][d];if(!this.isTypeOfDD(a)){continue}if(!e||a.isTarget){b[b.length]=a}}}return b},isLegalTarget:function(e,d){var b=this.getRelated(e,!0),a,c;for(a=0,c=b.length;a<c;++a){if(b[a].id===d.id){return !0}}return !1},isTypeOfDD:function(a){return a&&a.__ygDragDrop},isHandle:function(a,b){return this.handleIds[a]&&this.handleIds[a][b]},getDDById:function(d,c){var b,a;for(b in this.ids){a=this.ids[b][d];if(a instanceof photoViewer.dd.DDTarget||c){return a}}return null},handleMouseDown:function(b,e){var a=this,d,c;a.isMouseDown=!0;if(Ext.quickTipsActive){Ext.tip.QuickTipManager.ddDisable()}a.currentPoint=b.getPoint();if(a.dragCurrent){a.handleMouseUp(b)}a.mousedownEvent=b;a.currentTarget=b.getTarget();a.dragCurrent=e;c=e.getEl();Ext.fly(c).setCapture();d=b.getXY();a.startX=d[0];a.startY=d[1];a.offsetX=a.offsetY=0;a.deltaX=a.startX-c.offsetLeft;a.deltaY=a.startY-c.offsetTop;a.dragThreshMet=!1},startDrag:function(d,e){var b=this,c=b.dragCurrent,a;clearTimeout(b.clickTimeout);if(c){c.b4StartDrag(d,e);c.startDrag(d,e);a=Ext.fly(c.getDragEl());if(a){a.addCls(b.dragCls);if(a.shim){a.shim.el.addCls(b.dragCls)}}}b.dragThreshMet=!0},handleMouseUp:function(b){var a=this;a.isMouseDown=!1;if(Ext.quickTipsActive){Ext.tip.QuickTipManager.ddEnable()}if(!a.dragCurrent){return}if(Ext.isIE&&document.releaseCapture){document.releaseCapture()}clearTimeout(a.clickTimeout);if(a.dragThreshMet){a.fireEvents(b,!0)}a.stopDrag(b);if(a.dragThreshMet){a.stopEvent(b)}a.mousedownEvent=a.currentTarget=null},stopEvent:function(a){if(this.stopPropagation){a.stopPropagation()}if(this.preventDefault){a.preventDefault()}},stopDrag:function(d){var a=this,c=a.dragCurrent,b;if(c){if(a.dragThreshMet){b=Ext.fly(c.getDragEl());if(b){b.removeCls(a.dragCls);if(b.shim){b.shim.el.removeCls(a.dragCls)}}c.b4EndDrag(d);c.endDrag(d)}a.dragCurrent.onMouseUp(d)}a.dragCurrent=null;a.dragOvers={}},handleMouseMove:function(b){var a=this,c=a.dragCurrent,f=a.currentPoint=b.getPoint(),g=f.x,h=f.y,d,e;a.offsetX=g-a.startX;a.offsetY=h-a.startY;if(!c){return !0}if(!a.dragThreshMet){d=Math.abs(a.offsetX);e=Math.abs(a.offsetY);if(d>a.clickPixelThresh||e>a.clickPixelThresh){a.startDrag(a.startX,a.startY)}}if(a.dragThreshMet){c.b4Drag(b);c.onDrag(b);if(!c.moveOnly){a.fireEvents(b,!1)}}a.stopEvent(b);return !0},fireEvents:function(e,s){var d=this,v=Ext.supports.Touch,c=d.dragCurrent,l=d.currentPoint,t=l.x,u=l.y,j=[],r=[],h=[],i=[],g=[],k=[],p,b,o,q,a,f,n,m;if(!c||c.isLocked()){return}m=!(c.deltaX<0||c.deltaY<0);if(v||!d.notifyOccluded&&(!Ext.supports.CSSPointerEvents||Ext.isIE10m||Ext.isOpera)&&m){p=c.getDragEl();if(m){p.style.visibility='hidden'}e.target=d.elementFromPoint(t,u)||document.documentElement;if(m){p.style.visibility='visible'}}for(a in d.dragOvers){b=d.dragOvers[a];delete d.dragOvers[a];if(!d.isTypeOfDD(b)||b.destroyed){continue}if(d.notifyOccluded){if(!this.isOverTarget(l,b,d.mode)){h.push(b)}}else {if(!e.within(b.getEl())){h.push(b)}}r[a]=!0}for(n in c.groups){if('string'!==typeof n){continue}for(a in d.ids[n]){b=d.ids[n][a];if(d.isTypeOfDD(b)&&(o=b.getEl())&&b.isTarget&&!b.isLocked()&&Ext.fly(o).isVisible(!0)&&(b!==c||c.ignoreSelf===!1)){if(d.notifyOccluded){if((b.zIndex=d.getZIndex(o))!==-1){q=!0}j.push(b)}else {if(e.within(b.getEl())){j.push(b);break}}}}}if(q){Ext.Array.sort(j,d.byZIndex)}for(a=0,f=j.length;a<f;a++){b=j[a];if(d.isOverTarget(l,b,d.mode)){if(s){g.push(b)}else {if(!r[b.id]){k.push(b)}else {i.push(b)}d.dragOvers[b.id]=b}if(!d.notifyOccluded){break}}}if(d.mode){if(h.length){c.b4DragOut(e,h);c.onDragOut(e,h)}if(k.length){c.onDragEnter(e,k)}if(i.length){c.b4DragOver(e,i);c.onDragOver(e,i)}if(g.length){c.b4DragDrop(e,g);c.onDragDrop(e,g)}}else {for(a=0,f=h.length;a<f;++a){c.b4DragOut(e,h[a].id);c.onDragOut(e,h[a].id)}for(a=0,f=k.length;a<f;++a){c.onDragEnter(e,k[a].id)}for(a=0,f=i.length;a<f;++a){c.b4DragOver(e,i[a].id);c.onDragOver(e,i[a].id)}for(a=0,f=g.length;a<f;++a){c.b4DragDrop(e,g[a].id);c.onDragDrop(e,g[a].id)}}if(s&&!g.length){c.onInvalidDrop(e)}},elementFromPoint:function(a,b){if(Ext.rootInheritedState.rtl){a=Ext.Element.getViewportWidth()-a}return document.elementFromPoint(a,b)},getZIndex:function(a){var d=document.body,c,b=-1;a=Ext.getDom(a);while(a!==d){if(!isNaN(c=Number(Ext.fly(a).getStyle('zIndex')))){b=c}a=a.parentNode}return b},byZIndex:function(a,b){return a.zIndex<b.zIndex},getBestMatch:function(d){var a=null,e=d.length,c,b;if(e===1){a=d[0]}else {for(c=0;c<e;++c){b=d[c];if(b.cursorIsOver){a=b;break}else {if(!a||a.overlap.getArea()<b.overlap.getArea()){a=b}}}}return a},refreshCache:function(e){var b,d,a,c;for(b in e){if('string'!==typeof b){continue}for(d in this.ids[b]){a=this.ids[b][d];if(this.isTypeOfDD(a)){c=this.getLocation(a);if(c){this.locationCache[a.id]=c}else {delete this.locationCache[a.id]}}}}},verifyEl:function(a){return Ext.getBody().contains(a)},getLocation:function(a){if(!this.isTypeOfDD(a)){return null}if(a.getRegion){return a.getRegion()}var c=a.getEl(),b,d,f,e,g,k,j,h,i;try{b=Ext.fly(c).getXY()}catch(l){}if(!b){return null}d=b[0];f=d+c.offsetWidth;e=b[1];g=e+c.offsetHeight;k=e-a.padding[0];j=f+a.padding[1];h=g+a.padding[2];i=d-a.padding[3];return new Ext.util.Region(k,j,h,i)},isOverTarget:function(g,a,i){var c=this.locationCache[a.id],b,d,f,h,e;if(!c||!this.useCache){c=this.getLocation(a);this.locationCache[a.id]=c}if(!c){return !1}a.cursorIsOver=c.contains(g);b=this.dragCurrent;if(!b||!b.getTargetCoord||!i&&!b.constrainX&&!b.constrainY){return a.cursorIsOver}a.overlap=null;d=b.getTargetCoord(g.x,g.y);f=b.getDragEl();h=new Ext.util.Region(d.y,d.x+f.offsetWidth,d.y+f.offsetHeight,d.x);e=h.intersect(c);if(e){a.overlap=e;return i?!0:a.cursorIsOver}else {return !1}},_onUnload:function(b,a){photoViewer.dd.DragDropManager.unregAll()},unregAll:function(){var a=this,b=a.elementCache,c;if(a.dragCurrent){a.stopDrag();a.dragCurrent=null}a.clearingAll=!0;a._execOnAll('unreg',[]);delete a.clearingAll;for(c in b){delete b[c]}a.elementCache={};a.ids={};a.handleIds={}},elementCache:{},getElWrapper:function(b){var a=this.elementCache[b];if(!a||!a.el){a=this.elementCache[b]=new this.ElementWrapper(Ext.getDom(b))}return a},getElement:function(a){return Ext.getDom(a)},getCss:function(b){var a=Ext.getDom(b);return a?a.style:null},ElementWrapper:function(a){this.el=a||null;this.id=this.el&&a.id;this.css=this.el&&a.style},getPosX:function(a){return Ext.fly(a).getX()},getPosY:function(a){return Ext.fly(a).getY()},swapNode:function(a,b){if(a.swapNode){a.swapNode(b)}else {var c=b.parentNode,d=b.nextSibling;if(d===a){c.insertBefore(a,b)}else {if(b===a.nextSibling){c.insertBefore(b,a)}else {a.parentNode.replaceChild(b,a);c.insertBefore(a,d)}}}},getScroll:function(){var e=window.document,a=e.documentElement,b=e.body,d=0,c=0;if(a&&(a.scrollTop||a.scrollLeft)){d=a.scrollTop;c=a.scrollLeft}else {if(b){d=b.scrollTop;c=b.scrollLeft}}return {top:d,left:c}},getStyle:function(b,a){return Ext.fly(b).getStyle(a)},getScrollTop:function(){return this.getScroll().top},getScrollLeft:function(){return this.getScroll().left},moveToEl:function(c,a){var b=Ext.fly(a).getXY();Ext.fly(c).setXY(b)},numericSort:function(a,b){return a-b},handleWasClicked:function(b,c){if(this.isHandle(c,b.id)){return !0}else {var a=b.parentNode;while(a){if(this.isHandle(c,a.id)){return !0}else {a=a.parentNode}}}return !1}},0,0,0,0,0,0,[photoViewer.dd,'DragDropManager',Ext.dd,'DragDropMgr',Ext.dd,'DDM'],function(a){Ext.onInternalReady(function(){a.addListeners()})});Ext.cmd.derive('photoViewer.dd.DragDrop',Ext.Base,{constructor:function(a,c,b){if(a){this.init(a,c,b)}},id:null,config:null,dragElId:null,handleElId:null,invalidHandleTypes:null,invalidHandleIds:null,invalidHandleClasses:null,startPageX:0,startPageY:0,groups:null,locked:!1,lock:function(){this.locked=!0},moveOnly:!1,unlock:function(){this.locked=!1},isTarget:!0,padding:null,_domRef:null,__ygDragDrop:!0,constrainX:!1,constrainY:!1,minX:0,maxX:0,minY:0,maxY:0,maintainOffset:!1,xTicks:null,yTicks:null,primaryButtonOnly:!0,available:!1,hasOuterHandles:!1,triggerEvent:'mousedown',b4StartDrag:function(a,b){},startDrag:function(a,b){},b4Drag:function(a){},onDrag:function(a){},onDragEnter:function(b,a){},b4DragOver:function(a){},onDragOver:function(b,a){},b4DragOut:function(a){},onDragOut:function(b,a){},b4DragDrop:function(a){},onDragDrop:function(b,a){},onInvalidDrop:function(a){},b4EndDrag:function(a){},endDrag:function(a){},b4MouseDown:function(a){},onMouseDown:function(a){},onMouseUp:function(a){},onAvailable:function(){},defaultPadding:{left:0,right:0,top:0,bottom:0},constrainTo:function(j,a,k){if(Ext.isNumber(a)){a={left:a,right:a,top:a,bottom:a}}a=a||this.defaultPadding;var c=Ext.get(this.getEl()).getBox(),e=Ext.get(j),i=e.getScroll(),b,d=e.dom,h,g,f;if(d===document.body){b={x:i.left,y:i.top,width:Ext.Element.getViewportWidth(),height:Ext.Element.getViewportHeight()}}else {h=e.getXY();b={x:h[0],y:h[1],width:d.clientWidth,height:d.clientHeight}}g=c.y-b.y;f=c.x-b.x;this.resetConstraints();this.setXConstraint(f-(a.left||0),b.width-f-c.width-(a.right||0),this.xTickSize);this.setYConstraint(g-(a.top||0),b.height-g-c.height-(a.bottom||0),this.yTickSize)},getEl:function(){if(!this._domRef){this._domRef=Ext.getDom(this.id)}return this._domRef},getDragEl:function(){return Ext.getDom(this.dragElId)},init:function(b,d,c){var a=this;a.el=a.el||Ext.get(b);a.initTarget(b,d,c);Ext.get(a.id).on(a.triggerEvent,a.handleMouseDown,a);if(Ext.supports.Touch&&a.triggerEvent==='longpress'){Ext.get(a.id).swallowEvent('contextmenu',!0)}},initTarget:function(a,b,c){this.config=c||{};this.DDMInstance=photoViewer.dd.DragDropManager;this.groups={};if(typeof a!=='string'){a=Ext.id(a)}this.id=a;this.addToGroup(b?b:'default');this.handleElId=a;this.setDragElId(a);this.invalidHandleTypes={A:'A'};this.invalidHandleIds={};this.invalidHandleClasses=[];this.applyConfig();this.handleOnAvailable()},applyConfig:function(){this.padding=this.config.padding||[0,0,0,0];this.isTarget=this.config.isTarget!==!1;this.maintainOffset=this.config.maintainOffset;this.primaryButtonOnly=this.config.primaryButtonOnly!==!1},handleOnAvailable:function(){this.available=!0;this.resetConstraints();this.onAvailable()},setPadding:function(a,b,c,d){if(!b&&0!==b){this.padding=[a,a,a,a]}else {if(!c&&0!==c){this.padding=[a,b,a,b]}else {this.padding=[a,b,c,d]}}},setInitPosition:function(e,f){var d=this.getEl(),b,c,a;if(!this.DDMInstance.verifyEl(d)){return}b=e||0;c=f||0;a=Ext.fly(d).getXY();this.initPageX=a[0]-b;this.initPageY=a[1]-c;this.lastPageX=a[0];this.lastPageY=a[1];this.setStartPosition(a)},setStartPosition:function(b){var a=b||Ext.fly(this.getEl()).getXY();this.deltaSetXY=null;this.startPageX=a[0];this.startPageY=a[1]},addToGroup:function(a){this.groups[a]=!0;this.DDMInstance.regDragDrop(this,a)},removeFromGroup:function(a){if(this.groups[a]){delete this.groups[a]}this.DDMInstance.removeDDFromGroup(this,a)},setDragElId:function(a){this.dragElId=a},setHandleElId:function(a){if(typeof a!=='string'){a=Ext.id(a)}this.handleElId=a;this.DDMInstance.regHandle(this.id,a)},setOuterHandleElId:function(a){if(typeof a!=='string'){a=Ext.id(a)}Ext.get(a).on(this.triggerEvent,this.handleMouseDown,this);this.setHandleElId(a);this.hasOuterHandles=!0},unreg:function(){var a=this,b;if(a._domRef){b=Ext.fly(a.id);if(b){b.un(a.triggerEvent,a.handleMouseDown,a)}}a._domRef=null;a.DDMInstance._remove(a,a.autoGroup)},destroy:function(){this.unreg();this.callParent()},isLocked:function(){return this.DDMInstance.isLocked()||this.locked},handleMouseDown:function(b,c){var a=this;if(a.primaryButtonOnly&&b.button||a.isLocked()){return}a.DDMInstance.refreshCache(a.groups);if(a.hasOuterHandles||a.DDMInstance.isOverTarget(b.getPoint(),a)){if(a.clickValidator(b)){a.setStartPosition();a.b4MouseDown(b);a.onMouseDown(b);a.DDMInstance.handleMouseDown(b,a);a.DDMInstance.stopEvent(b)}}},clickValidator:function(b){var a=b.getTarget();return this.isValidHandleChild(a)&&(this.id===this.handleElId||this.DDMInstance.handleWasClicked(a,this.id))},addInvalidHandleType:function(b){var a=b.toUpperCase();this.invalidHandleTypes[a]=a},addInvalidHandleId:function(a){if(typeof a!=='string'){a=Ext.id(a)}this.invalidHandleIds[a]=a},addInvalidHandleClass:function(a){this.invalidHandleClasses.push(a)},removeInvalidHandleType:function(a){var b=a.toUpperCase();delete this.invalidHandleTypes[b]},removeInvalidHandleId:function(a){if(typeof a!=='string'){a=Ext.id(a)}delete this.invalidHandleIds[a]},removeInvalidHandleClass:function(c){var b=this.invalidHandleClasses,d=b.length,a;for(a=0;a<d;++a){if(b[a]===c){delete b[a]}}},isValidHandleChild:function(b){var a=!0,d,c,e;try{d=b.nodeName.toUpperCase()}catch(f){d=b.nodeName}a=a&&!this.invalidHandleTypes[d];a=a&&!this.invalidHandleIds[b.id];for(c=0,e=this.invalidHandleClasses.length;a&&c<e;++c){a=!Ext.fly(b).hasCls(this.invalidHandleClasses[c])}return a},setXTicks:function(d,c){this.xTicks=[];this.xTickSize=c;var b={},a;for(a=this.initPageX;a>=this.minX;a=a-c){if(!b[a]){this.xTicks[this.xTicks.length]=a;b[a]=!0}}for(a=this.initPageX;a<=this.maxX;a=a+c){if(!b[a]){this.xTicks[this.xTicks.length]=a;b[a]=!0}}Ext.Array.sort(this.xTicks,this.DDMInstance.numericSort)},setYTicks:function(d,c){this.yTicks=[];this.yTickSize=c;var b={},a;for(a=this.initPageY;a>=this.minY;a=a-c){if(!b[a]){this.yTicks[this.yTicks.length]=a;b[a]=!0}}for(a=this.initPageY;a<=this.maxY;a=a+c){if(!b[a]){this.yTicks[this.yTicks.length]=a;b[a]=!0}}Ext.Array.sort(this.yTicks,this.DDMInstance.numericSort)},setXConstraint:function(c,b,a){this.leftConstraint=c;this.rightConstraint=b;this.minX=this.initPageX-c;this.maxX=this.initPageX+b;if(a){this.setXTicks(this.initPageX,a)}this.constrainX=!0},clearConstraints:function(){this.constrainX=!1;this.constrainY=!1;this.clearTicks()},clearTicks:function(){this.xTicks=null;this.yTicks=null;this.xTickSize=0;this.yTickSize=0},setYConstraint:function(c,b,a){this.topConstraint=c;this.bottomConstraint=b;this.minY=this.initPageY-c;this.maxY=this.initPageY+b;if(a){this.setYTicks(this.initPageY,a)}this.constrainY=!0},resetConstraints:function(){if(this.initPageX||this.initPageX===0){var a=this.maintainOffset?this.lastPageX-this.initPageX:0,b=this.maintainOffset?this.lastPageY-this.initPageY:0;this.setInitPosition(a,b)}else {this.setInitPosition()}if(this.constrainX){this.setXConstraint(this.leftConstraint,this.rightConstraint,this.xTickSize)}if(this.constrainY){this.setYConstraint(this.topConstraint,this.bottomConstraint,this.yTickSize)}},getTick:function(d,a){if(!a){return d}else {if(a[0]>=d){return a[0]}else {var b,g,c,e,f;for(b=0,g=a.length;b<g;++b){c=b+1;if(a[c]&&a[c]>=d){e=d-a[b];f=a[c]-d;return f>e?a[b]:a[c]}}return a[a.length-1]}}},toString:function(){return 'DragDrop '+this.id}},3,0,0,0,0,0,[photoViewer.dd,'DragDrop'],0);Ext.cmd.derive('photoViewer.dd.DD',photoViewer.dd.DragDrop,{constructor:function(a,c,b){if(a){this.init(a,c,b)}},scroll:!0,autoOffset:function(a,b){var c=a-this.startPageX,d=b-this.startPageY;this.setDelta(c,d)},setDelta:function(a,b){this.deltaX=a;this.deltaY=b},setDragElPos:function(a,b){var c=this.getDragEl();this.alignElWithMouse(c,a,b)},alignElWithMouse:function(d,j,k){var a=this.getTargetCoord(j,k),c=d.dom?d:Ext.fly(d,'_dd'),e=c.getSize(),i=Ext.Element,b,g,f,h;if(!this.deltaSetXY){b=this.cachedViewportSize={width:i.getDocumentWidth(),height:i.getDocumentHeight()};g=[Math.max(0,Math.min(a.x,b.width-e.width)),Math.max(0,Math.min(a.y,b.height-e.height))];c.setXY(g);f=this.getLocalX(c);h=c.getLocalY();this.deltaSetXY=[f-a.x,h-a.y]}else {b=this.cachedViewportSize;this.setLocalXY(c,Math.max(0,Math.min(a.x+this.deltaSetXY[0],b.width-e.width)),Math.max(0,Math.min(a.y+this.deltaSetXY[1],b.height-e.height)))}this.cachePosition(a.x,a.y);this.autoScroll(a.x,a.y,d.offsetHeight,d.offsetWidth);return a},cachePosition:function(b,c){if(b){this.lastPageX=b;this.lastPageY=c}else {var a=Ext.fly(this.getEl()).getXY();this.lastPageX=a[0];this.lastPageY=a[1]}},autoScroll:function(e,f,m,n){if(this.scroll){var g=Ext.Element.getViewportHeight(),h=Ext.Element.getViewportWidth(),b=this.DDMInstance.getScrollTop(),a=this.DDMInstance.getScrollLeft(),l=m+f,j=n+e,k=g+b-f-this.deltaY,i=h+a-e-this.deltaX,d=40,c=document.all?80:30;if(l>g&&k<d){window.scrollTo(a,b+c)}if(f<b&&b>0&&f-b<d){window.scrollTo(a,b-c)}if(j>h&&i<d){window.scrollTo(a+c,b)}if(e<a&&a>0&&e-a<d){window.scrollTo(a-c,b)}}},getTargetCoord:function(c,d){var a=c-this.deltaX,b=d-this.deltaY;if(this.constrainX){if(a<this.minX){a=this.minX}if(a>this.maxX){a=this.maxX}}if(this.constrainY){if(b<this.minY){b=this.minY}if(b>this.maxY){b=this.maxY}}a=this.getTick(a,this.xTicks);b=this.getTick(b,this.yTicks);return {x:a,y:b}},applyConfig:function(){photoViewer.dd.DragDrop.prototype.applyConfig.call(this);this.scroll=this.config.scroll!==!1},b4MouseDown:function(b){var a=b.getXY();this.autoOffset(a[0],a[1])},b4Drag:function(b){var a=b.getXY();this.setDragElPos(a[0],a[1])},toString:function(){return 'DD '+this.id},getLocalX:function(a){return a.getLocalX()},setLocalXY:function(a,b,c){a.setLocalXY(b,c)}},3,0,0,0,0,0,[photoViewer.dd,'DD'],0);Ext.cmd.derive('photoViewer.dd.DDProxy',photoViewer.dd.DD,{statics:{dragElId:'ygddfdiv'},constructor:function(a,c,b){if(a){this.init(a,c,b);this.initFrame()}},resizeFrame:!0,centerFrame:!1,createFrame:function(){var d=this,c=document.body,a,b;if(!c||!c.firstChild){Ext.defer(function(){d.createFrame()},50);return}a=this.getDragEl();if(!a){a=document.createElement('div');a.id=this.dragElId;a.setAttribute('role','presentation');b=a.style;b.position='absolute';b.visibility='hidden';b.cursor='move';b.border='2px solid #aaa';b.zIndex=999;c.insertBefore(a,c.firstChild)}},initFrame:function(){this.createFrame()},applyConfig:function(){photoViewer.dd.DD.prototype.applyConfig.call(this);this.resizeFrame=this.config.resizeFrame!==!1;this.centerFrame=this.config.centerFrame;this.setDragElId(this.config.dragElId||photoViewer.dd.DDProxy.dragElId)},showFrame:function(d,e){var a=this,b=a.getDragEl(),c=b.style;a._resizeProxy();if(a.centerFrame){a.setDelta(Math.round(parseInt(c.width,10)/2),Math.round(parseInt(c.height,10)/2))}a.setDragElPos(d,e);Ext.fly(b).show()},_resizeProxy:function(){if(this.resizeFrame){var a=this.getEl();Ext.fly(this.getDragEl()).setSize(a.offsetWidth,a.offsetHeight)}},b4MouseDown:function(d){var a=d.getXY(),b=a[0],c=a[1];this.autoOffset(b,c);this.setDragElPos(b,c)},b4StartDrag:function(a,b){this.showFrame(a,b)},b4EndDrag:function(a){Ext.fly(this.getDragEl()).hide()},endDrag:function(c){var b=this.getEl(),a=this.getDragEl();a.style.visibility='';this.beforeMove();b.style.visibility='hidden';Ext.dd.DDM.moveToEl(b,a);a.style.visibility='hidden';b.style.visibility='';this.afterDrag()},beforeMove:function(){},afterDrag:function(){},toString:function(){return 'DDProxy '+this.id}},3,0,0,0,0,0,[photoViewer.dd,'DDProxy'],0);Ext.cmd.derive('photoViewer.dd.DDTarget',photoViewer.dd.DragDrop,{constructor:function(a,c,b){if(a){this.initTarget(a,c,b)}},getDragEl:Ext.emptyFn,isValidHandleChild:Ext.emptyFn,startDrag:Ext.emptyFn,endDrag:Ext.emptyFn,onDrag:Ext.emptyFn,onDragDrop:Ext.emptyFn,onDragEnter:Ext.emptyFn,onDragOut:Ext.emptyFn,onDragOver:Ext.emptyFn,onInvalidDrop:Ext.emptyFn,onMouseDown:Ext.emptyFn,onMouseUp:Ext.emptyFn,setXConstraint:Ext.emptyFn,setYConstraint:Ext.emptyFn,resetConstraints:Ext.emptyFn,clearConstraints:Ext.emptyFn,clearTicks:Ext.emptyFn,setInitPosition:Ext.emptyFn,setDragElId:Ext.emptyFn,setHandleElId:Ext.emptyFn,setOuterHandleElId:Ext.emptyFn,addInvalidHandleClass:Ext.emptyFn,addInvalidHandleId:Ext.emptyFn,addInvalidHandleType:Ext.emptyFn,removeInvalidHandleClass:Ext.emptyFn,removeInvalidHandleId:Ext.emptyFn,removeInvalidHandleType:Ext.emptyFn,toString:function(){return 'DDTarget '+this.id}},3,0,0,0,0,0,[photoViewer.dd,'DDTarget'],0);Ext.cmd.derive('photoViewer.dd.StatusProxy',Ext.Component,{animRepair:!1,childEls:['ghost'],renderTpl:['<div class="x-dd-drop-icon" role="presentation"></div><div id="{id}-ghost" data-ref="ghost" class="x-dd-drag-ghost" role="presentation"></div>'],repairCls:'x-dd-drag-repair',ariaRole:'presentation',skipLayout:!0,alignOnScroll:!1,constructor:function(a){var b=this;a=a||{};Ext.apply(b,{hideMode:'visibility',hidden:!0,floating:!0,id:b.id||Ext.id(),cls:'x-dd-drag-proxy '+this.dropNotAllowed,shadow:a.shadow||!1,renderTo:Ext.getDetachedBody()});Ext.Component.prototype.constructor.apply(this,arguments);this.dropStatus=this.dropNotAllowed},dropAllowed:'x-dd-drop-ok',dropNotAllowed:'x-dd-drop-nodrop',setStatus:function(a){a=a||this.dropNotAllowed;if(this.dropStatus!==a){this.el.replaceCls(this.dropStatus,a);this.dropStatus=a}},reset:function(c){var a=this,b='x-dd-drag-proxy ';a.el.replaceCls(b+a.dropAllowed,b+a.dropNotAllowed);a.dropStatus=a.dropNotAllowed;if(c){a.ghost.setHtml('')}},update:function(a){if(typeof a==='string'){this.ghost.setHtml(a)}else {this.ghost.setHtml('');a.style.margin='0';this.ghost.dom.appendChild(a)}var b=this.ghost.dom.firstChild;if(b){Ext.fly(b).setStyle('float','none')}},getGhost:function(){return this.ghost},hide:function(a){Ext.Component.prototype.hide.call(this);if(a){this.reset(!0)}},stop:function(){if(this.anim&&this.anim.isAnimated&&this.anim.isAnimated()){this.anim.stop()}},sync:function(){this.el.syncUnderlays()},repair:function(b,c,d){var a=this;a.callback=c;a.scope=d;if(b&&a.animRepair!==!1){a.el.addCls(a.repairCls);a.el.setUnderlaysVisible(!1);a.anim=a.el.animate({duration:a.repairDuration||500,easing:'ease-out',to:{x:b[0],y:b[1]},stopAnimation:!0,callback:a.afterRepair,scope:a})}else {a.afterRepair()}},afterRepair:function(){var a=this;a.hide(!0);a.el.removeCls(a.repairCls);if(typeof a.callback==='function'){a.callback.call(a.scope||a)}delete a.callback;delete a.scope}},1,0,['component','box'],{'component':!0,'box':!0},0,0,[photoViewer.dd,'StatusProxy'],0);Ext.cmd.derive('photoViewer.dd.DragSource',photoViewer.dd.DDProxy,{dropAllowed:'x-dd-drop-ok',dropNotAllowed:'x-dd-drop-nodrop',animRepair:!0,repairHighlightColor:'c3daf9',constructor:function(b,a){this.el=Ext.get(b);if(!this.dragData){this.dragData={}}Ext.apply(this,a);if(!this.proxy){this.proxy=new photoViewer.dd.StatusProxy({id:this.el.id+'-drag-status-proxy',animRepair:this.animRepair})}photoViewer.dd.DDProxy.prototype.constructor.call(this,this.el.dom,this.ddGroup||this.group,{dragElId:this.proxy.id,resizeFrame:!1,isTarget:!1,scroll:this.scroll===!0});this.dragging=!1},getDragData:function(a){return this.dragData},onDragEnter:function(c,b){var a=photoViewer.dd.DragDropManager.getDDById(b),d;this.cachedTarget=a;if(this.beforeDragEnter(a,c,b)!==!1){if(a.isNotifyTarget){d=a.notifyEnter(this,c,this.dragData);this.proxy.setStatus(d)}else {this.proxy.setStatus(this.dropAllowed)}if(this.afterDragEnter){this.afterDragEnter(a,c,b)}}},beforeDragEnter:function(a,c,b){return !0},onDragOver:function(c,b){var a=this.cachedTarget||photoViewer.dd.DragDropManager.getDDById(b),d;if(this.beforeDragOver(a,c,b)!==!1){if(a.isNotifyTarget){d=a.notifyOver(this,c,this.dragData);this.proxy.setStatus(d)}if(this.afterDragOver){this.afterDragOver(a,c,b)}}},beforeDragOver:function(a,c,b){return !0},onDragOut:function(c,b){var a=this.cachedTarget||photoViewer.dd.DragDropManager.getDDById(b);if(this.beforeDragOut(a,c,b)!==!1){if(a.isNotifyTarget){a.notifyOut(this,c,this.dragData)}this.proxy.reset();if(this.afterDragOut){this.afterDragOut(a,c,b)}}this.cachedTarget=null},beforeDragOut:function(a,c,b){return !0},onDragDrop:function(c,b){var a=this.cachedTarget||photoViewer.dd.DragDropManager.getDDById(b);if(this.beforeDragDrop(a,c,b)!==!1){if(a.isNotifyTarget){if(a.notifyDrop(this,c,this.dragData)!==!1){this.onValidDrop(a,c,b)}else {this.onInvalidDrop(a,c,b)}}else {this.onValidDrop(a,c,b)}if(this.afterDragDrop){this.afterDragDrop(a,c,b)}}delete this.cachedTarget},beforeDragDrop:function(a,c,b){return !0},onValidDrop:function(a,c,b){this.hideProxy();if(this.afterValidDrop){this.afterValidDrop(a,c,b)}},getRepairXY:function(b,a){return this.el.getXY()},onInvalidDrop:function(c,b,d){var a=this;if(!b){b=c;c=null;d=b.getTarget().id}if(a.beforeInvalidDrop(c,b,d)!==!1){if(a.cachedTarget){if(a.cachedTarget.isNotifyTarget){a.cachedTarget.notifyOut(a,b,a.dragData)}a.cacheTarget=null}a.proxy.repair(a.getRepairXY(b,a.dragData),a.afterRepair,a);if(a.afterInvalidDrop){a.afterInvalidDrop(b,d)}}},afterRepair:function(){var a=this;if(Ext.enableFx){a.el.highlight(a.repairHighlightColor)}a.dragging=!1},beforeInvalidDrop:function(a,c,b){return !0},handleMouseDown:function(b){if(this.dragging){return}var a=this.getDragData(b);if(a&&this.onBeforeDrag(a,b)!==!1){this.dragData=a;this.proxy.stop();photoViewer.dd.DDProxy.prototype.handleMouseDown.apply(this,arguments)}},onBeforeDrag:function(a,b){return !0},onStartDrag:Ext.emptyFn,alignElWithMouse:function(){this.proxy.ensureAttachedToBody(!0);return photoViewer.dd.DDProxy.prototype.alignElWithMouse.apply(this,arguments)},startDrag:function(a,b){this.proxy.reset();this.proxy.hidden=!1;this.dragging=!0;this.proxy.update('');this.onInitDrag(a,b);this.proxy.show()},onInitDrag:function(b,c){var a=this.el.dom.cloneNode(!0);a.id=Ext.id();this.proxy.update(a);this.onStartDrag(b,c);return !0},getProxy:function(){return this.proxy},hideProxy:function(){this.proxy.hide();this.proxy.reset(!0);this.dragging=!1},triggerCacheRefresh:function(){Ext.dd.DDM.refreshCache(this.groups)},b4EndDrag:function(a){},endDrag:function(a){this.onEndDrag(this.dragData,a)},onEndDrag:function(a,b){},autoOffset:function(a,b){this.setDelta(-12,-20)},destroy:function(){photoViewer.dd.DDProxy.prototype.destroy.call(this);Ext.destroy(this.proxy)}},1,0,0,0,0,0,[photoViewer.dd,'DragSource'],0);Ext.cmd.derive('photoViewer.dd.DragTracker',Ext.Base,{active:!1,trackOver:!1,tolerance:5,autoStart:!1,constructor:function(b){var a=this;Ext.apply(a,b);a.dragRegion=new Ext.util.Region(0,0,0,0);if(a.el){a.initEl(a.el)}a.mixins.observable.constructor.call(a);if(a.disabled){a.disable()}},initEl:function(b){var a=this,c=a.delegate;a.el=b=Ext.get(b);if(c&&c.isElement){a.handle=c}a.delegate=a.handle?undefined:a.delegate;if(!a.handle){a.handle=b}a.handleListeners={scope:a,delegate:a.delegate,mousedown:a.onMouseDown,dragstart:a.onDragStart};if(!Ext.supports.TouchEvents&&(a.trackOver||a.overCls)){Ext.apply(a.handleListeners,{mouseover:a.onMouseOver,mouseout:a.onMouseOut})}a.mon(a.handle,a.handleListeners);a.keyNav=new Ext.util.KeyNav({target:b,up:a.onResizeKeyDown,left:a.onResizeKeyDown,right:a.onResizeKeyDown,down:a.onResizeKeyDown,scope:a})},disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},destroy:function(){var a=this;a.endDrag({});a.el=a.handle=a.onBeforeStart=a.onStart=a.onDrag=a.onEnd=a.onCancel=null;a.callParent()},onMouseOver:function(d,h){var a=this,f,b,e,g,c;if(!a.disabled){if(d.within(d.target,!0,!0)||a.delegate){f=a.handleCls;a.mouseIsOut=!1;if(f){for(e=0,g=a.handleEls.length;e<g;e++){b=a.handleEls[e];c=b.delegateCls;if(!c){c=b.delegateCls=[f,'-',b.region,'-over'].join('')}b.addCls([c,a.overCls])}}a.fireEvent('mouseover',a,d,a.delegate?d.getTarget(a.delegate,h):a.handle)}}},onMouseOut:function(e){var a=this,c,b,d;if(a.mouseIsDown){a.mouseIsOut=!0}else {if(a.handleCls){for(b=0,d=a.handleEls.length;b<d;b++){c=a.handleEls[b];c.removeCls([c.delegateCls,a.overCls])}}a.fireEvent('mouseout',a,e)}},onMouseDown:function(b,c){var a=this;if(a.disabled||b.dragTracked){return}a.dragTarget=a.delegate?c:a.handle.dom;a.startXY=a.lastXY=b.getXY();a.startRegion=Ext.fly(a.dragTarget).getRegion();if(a.fireEvent('mousedown',a,b)===!1||a.fireEvent('beforedragstart',a,b)===!1||a.onBeforeStart(b)===!1){return}a.mouseIsDown=!0;b.dragTracked=!0;a.el.setCapture();b.stopPropagation();if(a.preventDefault!==!1){b.preventDefault()}Ext.getDoc().on({scope:a,capture:!0,mouseup:a.onMouseUp,mousemove:a.onMouseMove,selectstart:a.stopSelect});a.dragEnded=!1;if(!a.tolerance){a.triggerStart()}else {if(a.autoStart){a.timer=Ext.defer(a.triggerStart,a.autoStart===!0?1000:a.autoStart,a,[b])}}},onMouseMove:function(b,e){var a=this,c=b.getXY(),d=a.startXY;b.stopPropagation();if(a.preventDefault!==!1){b.preventDefault()}if(a.dragEnded){return}a.lastXY=c;if(!a.active){if(Math.max(Math.abs(d[0]-c[0]),Math.abs(d[1]-c[1]))>a.tolerance){a.triggerStart(b)}else {return}}if(a.fireEvent('mousemove',a,b)===!1){a.onMouseUp(b)}else {a.onDrag(b);a.fireEvent('drag',a,b)}},onMouseUp:function(b){var a=this;a.mouseIsDown=!1;if(a.mouseIsOut){a.mouseIsOut=!1;a.onMouseOut(b)}if(a.preventDefault!==!1){b.preventDefault()}if(Ext.isIE&&document.releaseCapture){document.releaseCapture()}a.fireEvent('mouseup',a,b);a.endDrag(b)},endDrag:function(b){var a=this,c=a.active;Ext.getDoc().un({mousemove:a.onMouseMove,mouseup:a.onMouseUp,selectstart:a.stopSelect,capture:!0,scope:a});a.clearStart();a.active=!1;a.dragEnded=!0;if(c){a.onEnd(b);a.fireEvent('dragend',a,b)}else {a.onCancel(b)}a._constrainRegion=null},triggerStart:function(b){var a=this;a.clearStart();a.active=!0;a.onStart(b);a.fireEvent('dragstart',a,b)},clearStart:function(){var a=this.timer;if(a){clearTimeout(a);this.timer=null}},stopSelect:function(a){a.stopEvent();return !1},onBeforeStart:function(a){},onStart:function(a){},onDrag:function(a){},onCancel:function(a){},onEnd:function(a){},getDragTarget:function(){return this.dragTarget},getDragCt:function(){return this.el},getConstrainRegion:function(){var a=this;if(a.constrainTo){if(a.constrainTo instanceof Ext.util.Region){return a.constrainTo}if(!a._constrainRegion){a._constrainRegion=Ext.fly(a.constrainTo).getViewRegion()}}else {if(!a._constrainRegion){a._constrainRegion=a.getDragCt().getViewRegion()}}return a._constrainRegion},getXY:function(a){return a?this.constrainModes[a](this,this.lastXY):this.lastXY},getOffset:function(c){var a=this.getXY(c),b=this.startXY;return [a[0]-b[0],a[1]-b[1]]},onDragStart:function(a){a.stopPropagation()},constrainModes:{point:function(d,b){var a=d.dragRegion,c=d.getConstrainRegion();if(!c){return b}a.x=a.left=a[0]=a.right=b[0];a.y=a.top=a[1]=a.bottom=b[1];a.constrainTo(c);return [a.left,a.top]},dragTarget:function(e,c){var f=e.startXY,a=e.startRegion.copy(),b=e.getConstrainRegion(),d;if(!b){return c}a.translateBy(c[0]-f[0],c[1]-f[1]);if(a.right>b.right){c[0]+=d=b.right-a.right;a.left+=d}if(a.left<b.left){c[0]+=b.left-a.left}if(a.bottom>b.bottom){c[1]+=d=b.bottom-a.bottom;a.top+=d}if(a.top<b.top){c[1]+=b.top-a.top}return c}}},1,0,0,0,0,[['observable',Ext.util.Observable]],[photoViewer.dd,'DragTracker'],0);Ext.cmd.derive('photoViewer.dd.DragZone',photoViewer.dd.DragSource,{constructor:function(a,d){var c=this,b;photoViewer.dd.DragSource.prototype.constructor.call(this,a,d);b=c.containerScroll;if(b){a=c.scrollEl||a;a=Ext.get(a);if(Ext.isObject(b)){a.ddScrollConfig=b}photoViewer.dd.ScrollManager.register(a)}},getDragData:function(a){return photoViewer.dd.Registry.getHandleFromEvent(a)},onInitDrag:function(a,b){this.proxy.update(this.dragData.ddel.cloneNode(!0));this.onStartDrag(a,b);return !0},getRepairXY:function(a){return Ext.fly(this.dragData.ddel).getXY()},destroy:function(){photoViewer.dd.DragSource.prototype.destroy.call(this);if(this.containerScroll){photoViewer.dd.ScrollManager.unregister(this.scrollEl||this.el)}}},1,0,0,0,0,0,[photoViewer.dd,'DragZone'],0);Ext.cmd.derive('photoViewer.dd.ScrollManager',Ext.Base,{singleton:!0,dirTrans:{up:-1,left:-1,down:1,right:1},constructor:function(){var a=photoViewer.dd.DragDropManager;a.fireEvents=Ext.Function.createSequence(a.fireEvents,this.onFire,this);a.stopDrag=Ext.Function.createSequence(a.stopDrag,this.onStop,this);this.doScroll=this.doScroll.bind(this);this.ddmInstance=a;this.els={};this.dragEl=null;this.proc={}},onStop:function(b){var a=photoViewer.dd.ScrollManager;a.dragEl=null;a.clearProc()},triggerRefresh:function(){if(this.ddmInstance.dragCurrent){this.ddmInstance.refreshCache(this.ddmInstance.dragCurrent.groups)}},doScroll:function(){var d=this;if(d.ddmInstance.dragCurrent){var b=d.proc,h=b.el,g=b.component,c=b.el.ddScrollConfig,e=c&&c.increment?c.increment:d.increment,a=c&&'animate' in c?c.animate:d.animate,f=function(){d.triggerRefresh()};if(a){if(a===!0){a={callback:f}}else {a.callback=a.callback?Ext.Function.createSequence(a.callback,f):f}}if(g){e=e*d.dirTrans[b.dir];if(b.dir==='up'||b.dir==='down'){g.scrollBy(0,e,a)}else {g.scrollBy(e,0,a)}}else {h.scroll(b.dir,e,a)}if(!a){f()}}},clearProc:function(){var a=this.proc;if(a.id){clearInterval(a.id)}a.id=0;a.el=null;a.dir=''},startProc:function(a,f){var b=this,d=b.proc,c,e;b.clearProc();d.el=a;d.dir=f;c=a.ddScrollConfig?a.ddScrollConfig.ddGroup:undefined;e=a.ddScrollConfig&&a.ddScrollConfig.frequency?a.ddScrollConfig.frequency:b.frequency;if(c===undefined||b.ddmInstance.dragCurrent.ddGroup===c){d.id=Ext.interval(b.doScroll,e)}},onFire:function(j,i){var a=this,d,f,g,h,b,c,e;if(i||!a.ddmInstance.dragCurrent){return}if(!a.dragEl||a.dragEl!==a.ddmInstance.dragCurrent){a.dragEl=a.ddmInstance.dragCurrent;a.refreshCache()}d=j.getPoint();f=a.proc;g=a.els;for(h in g){b=g[h];c=b._region;e=b.ddScrollConfig||a;if(c&&c.contains(d)&&b.isScrollable()){if(c.bottom-d.y<=e.vthresh){if(f.el!==b){a.startProc(b,'down')}return}else {if(c.right-d.x<=e.hthresh){if(f.el!==b){a.startProc(b,'right')}return}else {if(d.y-c.top<=e.vthresh){if(f.el!==b){a.startProc(b,'up')}return}else {if(d.x-c.left<=e.hthresh){if(f.el!==b){a.startProc(b,'left')}return}}}}}}a.clearProc()},register:function(a){if(Ext.isArray(a)){for(var b=0,c=a.length;b<c;b++){this.register(a[b])}}else {a=Ext.get(a);this.els[a.id]=a}},unregister:function(a){if(Ext.isArray(a)){for(var b=0,c=a.length;b<c;b++){this.unregister(a[b])}}else {a=Ext.get(a);delete this.els[a.id]}},vthresh:25*(window.devicePixelRatio||1),hthresh:25*(window.devicePixelRatio||1),increment:100,frequency:500,animate:!0,animDuration:0.4,ddGroup:undefined,refreshCache:function(){var a=this.els,b;for(b in a){if(typeof a[b]==='object'){a[b]._region=a[b].getRegion()}}}},1,0,0,0,0,0,[photoViewer.dd,'ScrollManager'],0);Ext.cmd.derive('photoViewer.dd.DropTarget',photoViewer.dd.DDTarget,{constructor:function(b,a){this.el=Ext.get(b);Ext.apply(this,a);if(this.containerScroll){photoViewer.dd.ScrollManager.register(this.el)}photoViewer.dd.DDTarget.prototype.constructor.call(this,this.el.dom,this.ddGroup||this.group,{isTarget:!0})},containerScroll:!1,dropAllowed:'x-dd-drop-ok',dropNotAllowed:'x-dd-drop-nodrop',isTarget:!0,isNotifyTarget:!0,notifyEnter:function(b,c,a){if(this.overClass){this.el.addCls(this.overClass)}return this.dropAllowed},notifyOver:function(b,c,a){return this.dropAllowed},notifyOut:function(b,c,a){if(this.overClass){this.el.removeCls(this.overClass)}},notifyDrop:function(b,c,a){if(this.overClass){this.el.removeCls(this.overClass)}return !1},destroy:function(){photoViewer.dd.DDTarget.prototype.destroy.call(this);if(this.containerScroll){photoViewer.dd.ScrollManager.unregister(this.el)}}},1,0,0,0,0,0,[photoViewer.dd,'DropTarget'],0);Ext.cmd.derive('photoViewer.dd.Registry',Ext.Base,{singleton:!0,constructor:function(){this.elements={};this.handles={};this.autoIdSeed=0},getId:function(a,c){if(typeof a==='string'){return a}var b=a.id;if(!b&&c!==!1){b='extdd-'+ ++this.autoIdSeed;a.id=b}return b},register:function(b,a){a=a||{};if(typeof b==='string'){b=document.getElementById(b)}a.ddel=b;this.elements[this.getId(b)]=a;if(a.isHandle!==!1){this.handles[a.ddel.id]=a}if(a.handles){var e=a.handles,c,d;for(c=0,d=e.length;c<d;c++){this.handles[this.getId(e[c])]=a}}},unregister:function(f){var e=this.getId(f,!1),b=this.elements[e],c,a,d;if(b){delete this.elements[e];if(b.handles){c=b.handles;for(a=0,d=c.length;a<d;a++){delete this.handles[this.getId(c[a],!1)]}}}},getHandle:function(a){if(typeof a!=='string'){a=a.id}return this.handles[a]},getHandleFromEvent:function(b){var a=b.getTarget();return a?this.handles[a.id]:null},getTarget:function(a){if(typeof a!=='string'){a=a.id}return this.elements[a]},getTargetFromEvent:function(b){var a=b.getTarget();return a?this.elements[a.id]||this.handles[a.id]:null}},1,0,0,0,0,0,[photoViewer.dd,'Registry'],0);Ext.cmd.derive('photoViewer.dd.DropZone',photoViewer.dd.DropTarget,{getTargetFromEvent:function(a){return photoViewer.dd.Registry.getTargetFromEvent(a)},onNodeEnter:function(d,b,c,a){},onNodeOver:function(d,b,c,a){return this.dropAllowed},onNodeOut:function(d,b,c,a){},onNodeDrop:function(d,b,c,a){return !1},onContainerOver:function(b,c,a){return this.dropNotAllowed},onContainerDrop:function(b,c,a){return !1},notifyEnter:function(b,c,a){return this.dropNotAllowed},notifyOver:function(d,b,c){var a=this,e=a.getTargetFromEvent(b);if(!e){if(a.lastOverNode){a.onNodeOut(a.lastOverNode,d,b,c);a.lastOverNode=null}return a.onContainerOver(d,b,c)}if(a.lastOverNode!==e){if(a.lastOverNode){a.onNodeOut(a.lastOverNode,d,b,c)}a.onNodeEnter(e,d,b,c);a.lastOverNode=e}return a.onNodeOver(e,d,b,c)},notifyOut:function(b,c,a){if(this.lastOverNode){this.onNodeOut(this.lastOverNode,b,c,a);this.lastOverNode=null}},notifyDrop:function(d,b,c){var a=this,e=a.getTargetFromEvent(b),f=e?a.onNodeDrop(e,d,b,c):a.onContainerDrop(d,b,c);if(a.lastOverNode){a.onNodeOut(a.lastOverNode,d,b,c);a.lastOverNode=null}return f},triggerCacheRefresh:function(){Ext.dd.DDM.refreshCache(this.groups)}},0,0,0,0,0,0,[photoViewer.dd,'DropZone'],0);Ext.cmd.derive('photoViewer.draw.Color',Ext.Base,{isColor:!0,colorToHexRe:/(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/,rgbRe:/\s*rgb\s*\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)\s*\)\s*/,hexRe:/\s*#([0-9a-fA-F][0-9a-fA-F]?)([0-9a-fA-F][0-9a-fA-F]?)([0-9a-fA-F][0-9a-fA-F]?)\s*/,lightnessFactor:0.2,constructor:function(e,c,d){var b=this,a=Ext.Number.constrain;b.r=a(e,0,255);b.g=a(c,0,255);b.b=a(d,0,255)},getRed:function(){return this.r},getGreen:function(){return this.g},getBlue:function(){return this.b},getRGB:function(){var a=this;return [a.r,a.g,a.b]},getHSL:function(){var h=this,f=h.r/255,e=h.g/255,g=h.b/255,b=Math.max(f,e,g),d=Math.min(f,e,g),c=b-d,a,j=0,i=0.5*(b+d);if(d!=b){j=i<=0.5?c/(b+d):c/(2-b-d);if(f==b){a=60*(e-g)/c}else {if(e==b){a=120+60*(g-f)/c}else {a=240+60*(f-e)/c}}if(a<0){a+=360}if(a>=360){a-=360}}return [a,j,i]},getHSV:function(){var g=this,d=g.r/255,c=g.g/255,f=g.b/255,b=Math.max(d,c,f),i=Math.min(d,c,f),e=b-i,a,j=0,h=b;if(i!=b){j=h?e/h:0;if(d===b){a=60*(c-f)/e}else {if(c===b){a=60*(f-d)/e+120}else {a=60*(d-c)/e+240}}if(a<0){a+=360}if(a>=360){a-=360}}return [a,j,h]},getLighter:function(b){var a=this.getHSL();b=b||this.lightnessFactor;a[2]=Ext.Number.constrain(a[2]+b,0,1);return this.fromHSL(a[0],a[1],a[2])},getDarker:function(a){a=a||this.lightnessFactor;return this.getLighter(-a)},toString:function(){var e=this,d=Math.round,c=d(e.r).toString(16),b=d(e.g).toString(16),a=d(e.b).toString(16);c=c.length==1?'0'+c:c;b=b.length==1?'0'+b:b;a=a.length==1?'0'+a:a;return ['#',c,b,a].join('')},toHex:function(a){if(Ext.isArray(a)){a=a[0]}if(!Ext.isString(a)){return ''}if(a.substr(0,1)==='#'){return a}var b=this.colorToHexRe.exec(a),e,c,d,f;if(Ext.isArray(b)){e=parseInt(b[2],10);c=parseInt(b[3],10);d=parseInt(b[4],10);f=d|c<<8|e<<16;return b[1]+'#'+('000000'+f.toString(16)).slice(-6)}else {return a}},fromString:function(b){var a,c,e,d,h=parseInt,g=b.substr(0,1),f;if(g!='#'){f=photoViewer.draw.Color.cssColors[b];if(f){b=f;g=b.substr(0,1)}}if((b.length==4||b.length==7)&&g==='#'){a=b.match(this.hexRe);if(a){c=h(a[1],16)>>0;e=h(a[2],16)>>0;d=h(a[3],16)>>0;if(b.length==4){c+=c*16;e+=e*16;d+=d*16}}}else {a=b.match(this.rgbRe);if(a){c=a[1];e=a[2];d=a[3]}}return typeof c=='undefined'?undefined:new photoViewer.draw.Color(c,e,d)},getGrayscale:function(){return this.r*0.3+this.g*0.59+this.b*0.11},fromHSL:function(e,h,d){var b,c,f,a=[],g=Math.abs;if(h==0||e==null){a=[d,d,d]}else {e/=60;b=h*(1-g(2*d-1));c=b*(1-g(e%2-1));f=d-b/2;switch(Math.floor(e)){case 0:a=[b,c,0];break;case 1:a=[c,b,0];break;case 2:a=[0,b,c];break;case 3:a=[0,c,b];break;case 4:a=[c,0,b];break;case 5:a=[b,0,c];break;}a=[a[0]+f,a[1]+f,a[2]+f]}return new photoViewer.draw.Color(a[0]*255,a[1]*255,a[2]*255)},fromHSV:function(e,g,d){var b,c,f,a=[];if(g==0||e==null){a=[d,d,d]}else {e/=60;b=d*g;c=b*(1-Math.abs(e%2-1));f=d-b;switch(Math.floor(e)){case 0:a=[b,c,0];break;case 1:a=[c,b,0];break;case 2:a=[0,b,c];break;case 3:a=[0,c,b];break;case 4:a=[c,0,b];break;case 5:a=[b,0,c];break;}a=[a[0]+f,a[1]+f,a[2]+f]}return new photoViewer.draw.Color(a[0]*255,a[1]*255,a[2]*255)}},3,0,0,0,0,0,[photoViewer.draw,'Color'],function(){var b=this.prototype,c=['fromHSL','fromHSV','fromString','toHex'],a={};Ext.Array.each(c,function(c){a[c]=function(){return b[c].apply(b,arguments)}});a.cssColors={aliceblue:'#F0F8FF',antiquewhite:'#FAEBD7',aqua:'#00FFFF',aquamarine:'#7FFFD4',azure:'#F0FFFF',beige:'#F5F5DC',bisque:'#FFE4C4',black:'#000000',blanchedalmond:'#FFEBCD',blue:'#0000FF',blueviolet:'#8A2BE2',brown:'#A52A2A',burlywood:'#DEB887',cadetblue:'#5F9EA0',chartreuse:'#7FFF00',chocolate:'#D2691E',coral:'#FF7F50',cornflowerblue:'#6495ED',cornsilk:'#FFF8DC',crimson:'#DC143C',cyan:'#00FFFF',darkblue:'#00008B',darkcyan:'#008B8B',darkgoldenrod:'#B8860B',darkgray:'#A9A9A9',darkgreen:'#006400',darkgrey:'#A9A9A9',darkkhaki:'#BDB76B',darkmagenta:'#8B008B',darkolivegreen:'#556B2F',darkorange:'#FF8C00',darkorchid:'#9932CC',darkred:'#8B0000',darksalmon:'#E9967A',darkseagreen:'#8FBC8F',darkslateblue:'#483D8B',darkslategray:'#2F4F4F',darkslategrey:'#2F4F4F',darkturquoise:'#00CED1',darkviolet:'#9400D3',deeppink:'#FF1493',deepskyblue:'#00BFFF',dimgray:'#696969',dimgrey:'#696969',dodgerblue:'#1E90FF',firebrick:'#B22222',floralwhite:'#FFFAF0',forestgreen:'#228B22',fuchsia:'#FF00FF',gainsboro:'#DCDCDC',ghostwhite:'#F8F8FF',gold:'#FFD700',goldenrod:'#DAA520',gray:'#808080',grey:'#808080',green:'#008000',greenyellow:'#ADFF2F',honeydew:'#F0FFF0',hotpink:'#FF69B4',indianred:'#CD5C5C',indigo:'#4B0082',ivory:'#FFFFF0',khaki:'#F0E68C',lavender:'#E6E6FA',lavenderblush:'#FFF0F5',lawngreen:'#7CFC00',lemonchiffon:'#FFFACD',lightblue:'#ADD8E6',lightcoral:'#F08080',lightcyan:'#E0FFFF',lightgoldenrodyellow:'#FAFAD2',lightgray:'#D3D3D3',lightgreen:'#90EE90',lightgrey:'#D3D3D3',lightpink:'#FFB6C1',lightsalmon:'#FFA07A',lightseagreen:'#20B2AA',lightskyblue:'#87CEFA',lightslategray:'#778899',lightslategrey:'#778899',lightsteelblue:'#B0C4DE',lightyellow:'#FFFFE0',lime:'#00FF00',limegreen:'#32CD32',linen:'#FAF0E6',magenta:'#FF00FF',maroon:'#800000',mediumaquamarine:'#66CDAA',mediumblue:'#0000CD',mediumorchid:'#BA55D3',mediumpurple:'#9370DB',mediumseagreen:'#3CB371',mediumslateblue:'#7B68EE',mediumspringgreen:'#00FA9A',mediumturquoise:'#48D1CC',mediumvioletred:'#C71585',midnightblue:'#191970',mintcream:'#F5FFFA',mistyrose:'#FFE4E1',moccasin:'#FFE4B5',navajowhite:'#FFDEAD',navy:'#000080',oldlace:'#FDF5E6',olive:'#808000',olivedrab:'#6B8E23',orange:'#FFA500',orangered:'#FF4500',orchid:'#DA70D6',palegoldenrod:'#EEE8AA',palegreen:'#98FB98',paleturquoise:'#AFEEEE',palevioletred:'#DB7093',papayawhip:'#FFEFD5',peachpuff:'#FFDAB9',peru:'#CD853F',pink:'#FFC0CB',plum:'#DDA0DD',powderblue:'#B0E0E6',purple:'#800080',red:'#FF0000',rosybrown:'#BC8F8F',royalblue:'#4169E1',saddlebrown:'#8B4513',salmon:'#FA8072',sandybrown:'#F4A460',seagreen:'#2E8B57',seashell:'#FFF5EE',sienna:'#A0522D',silver:'#C0C0C0',skyblue:'#87CEEB',slateblue:'#6A5ACD',slategray:'#708090',slategrey:'#708090',snow:'#FFFAFA',springgreen:'#00FF7F',steelblue:'#4682B4',tan:'#D2B48C',teal:'#008080',thistle:'#D8BFD8',tomato:'#FF6347',turquoise:'#40E0D0',violet:'#EE82EE',wheat:'#F5DEB3',white:'#FFFFFF',whitesmoke:'#F5F5F5',yellow:'#FFFF00',yellowgreen:'#9ACD32'};this.addStatics(a)});Ext.cmd.derive('photoViewer.draw.CompositeSprite',Ext.util.MixedCollection,{autoDestroy:!1,isCompositeSprite:!0,constructor:function(b){var a=this;a.myConfig=b;Ext.apply(a,b);a.id=Ext.id(null,'ext-sprite-group-');Ext.util.MixedCollection.prototype.constructor.call(this)},onClick:function(a){this.fireEvent('click',a)},onMouseUp:function(a){this.fireEvent('mouseup',a)},onMouseDown:function(a){this.fireEvent('mousedown',a)},onMouseOver:function(a){this.fireEvent('mouseover',a)},onMouseOut:function(a){this.fireEvent('mouseout',a)},attachEvents:function(b){var a=this;b.on({scope:a,mousedown:a.onMouseDown,mouseup:a.onMouseUp,mouseover:a.onMouseOver,mouseout:a.onMouseOut,click:a.onClick})},add:function(b,c){var a=Ext.util.MixedCollection.prototype.add.apply(this,arguments);this.attachEvents(a);return a},insert:function(a,b,c){return Ext.util.MixedCollection.prototype.insert.apply(this,arguments)},remove:function(b){var a=this;b.un({scope:a,mousedown:a.onMouseDown,mouseup:a.onMouseUp,mouseover:a.onMouseOver,mouseout:a.onMouseOut,click:a.onClick});return Ext.util.MixedCollection.prototype.remove.apply(this,arguments)},getBBox:function(){var h=0,c,a,i=this.items,j=this.length,b=Infinity,d=b,f=-b,e=b,g=-b,l,k;for(;h<j;h++){c=i[h];if(c.el&&!c.bboxExcluded){a=c.getBBox();d=Math.min(d,a.x);e=Math.min(e,a.y);f=Math.max(f,a.height+a.y);g=Math.max(g,a.width+a.x)}}return {x:d,y:e,height:f-e,width:g-d}},setAttributes:function(c,b){var a=0,d=this.items,e=this.length;for(;a<e;a++){d[a].setAttributes(c,b)}return this},hide:function(b){var a=0,c=this.items,d=this.length;for(;a<d;a++){c[a].hide(b)}return this},show:function(b){var a=0,c=this.items,d=this.length;for(;a<d;a++){c[a].show(b)}return this},redraw:function(){var a=this,b=0,d=a.items,c=a.getSurface(),e=a.length;if(c){for(;b<e;b++){c.renderItem(d[b])}}return a},setStyle:function(f){var b=0,d=this.items,e=this.length,c,a;for(;b<e;b++){c=d[b];a=c.el;if(a){a.setStyle(f)}}},addCls:function(e){var a=0,c=this.items,b=this.getSurface(),d=this.length;if(b){for(;a<d;a++){b.addCls(c[a],e)}}},removeCls:function(e){var a=0,c=this.items,b=this.getSurface(),d=this.length;if(b){for(;a<d;a++){b.removeCls(c[a],e)}}},getSurface:function(){var a=this.first();if(a){return a.surface}return null},destroy:function(){var a=this,c=a.getSurface(),d=a.autoDestroy,b;if(c){while(a.getCount()>0){b=a.first();a.remove(b);c.remove(b,d)}}a.clearListeners()}},1,0,0,0,0,[['animate',Ext.util.Animate]],[photoViewer.draw,'CompositeSprite'],0);Ext.cmd.derive('photoViewer.draw.Surface',Ext.Base,{separatorRe:/[, ]+/,enginePriority:['Svg','Vml'],statics:{create:function(c,a){a=a||this.prototype.enginePriority;var b=0,d=a.length;for(;b<d;b++){if(Ext.supports[a[b]]){return Ext.create('photoViewer.draw.engine.'+a[b],c)}}return !1},save:function(d,a){a=a||{};var b={'image/png':'Image','image/jpeg':'Image','image/svg+xml':'Svg'},e=b[a.type]||'Svg',c=photoViewer.draw.engine[e+'Exporter'];return c.generate(d,a)}},availableAttrs:{blur:0,'clip-rect':'0 0 1e9 1e9',cursor:'default',cx:0,cy:0,'dominant-baseline':'auto',fill:'none','fill-opacity':1,font:'10px "Arial"','font-family':'"Arial"','font-size':'10','font-style':'normal','font-weight':400,gradient:'',height:0,hidden:!1,href:'http://sencha.com/',opacity:1,path:'M0,0',radius:0,rx:0,ry:0,scale:'1 1',src:'',stroke:'none','stroke-dasharray':'','stroke-linecap':'butt','stroke-linejoin':'butt','stroke-miterlimit':0,'stroke-opacity':1,'stroke-width':1,target:'_blank',text:'','text-anchor':'middle',title:'Ext Draw',width:0,x:0,y:0,zIndex:0},container:undefined,height:352,width:512,x:0,y:0,orderSpritesByZIndex:!0,constructor:function(b){var a=this;b=b||{};Ext.apply(a,b);a.domRef=Ext.getDoc().dom;a.customAttributes={};a.mixins.observable.constructor.call(a);a.getId();a.initGradients();a.initItems();if(a.renderTo){a.render(a.renderTo);delete a.renderTo}a.initBackground(b.background)},initSurface:Ext.emptyFn,renderItem:Ext.emptyFn,renderItems:Ext.emptyFn,setViewBox:function(c,d,b,a){if(isFinite(c)&&isFinite(d)&&isFinite(b)&&isFinite(a)){this.viewBox={x:c,y:d,width:b,height:a};this.applyViewBox()}},addCls:Ext.emptyFn,removeCls:Ext.emptyFn,setStyle:Ext.emptyFn,initGradients:function(){if(this.hasOwnProperty('gradients')){var b=this.gradients,d=this.addGradient,a,c;if(b){for(a=0,c=b.length;a<c;a++){if(d.call(this,b[a],a,c)===!1){break}}}}},initItems:function(){var a=this.items;this.items=new photoViewer.draw.CompositeSprite();this.items.autoDestroy=!0;this.groups=new photoViewer.draw.CompositeSprite();if(a){this.add(a)}},initBackground:function(a){var b=this,e=b.width,d=b.height,f,c;if(Ext.isString(a)){a={fill:a}}if(a){if(a.gradient){c=a.gradient;f=c.id;b.addGradient(c);b.background=b.add({type:'rect',isBackground:!0,x:0,y:0,width:e,height:d,fill:'url(#'+f+')',zIndex:-1})}else {if(a.fill){b.background=b.add({type:'rect',isBackground:!0,x:0,y:0,width:e,height:d,fill:a.fill,zIndex:-1})}else {if(a.image){b.background=b.add({type:'image',isBackground:!0,x:0,y:0,width:e,height:d,src:a.image,zIndex:-1})}}}b.background.bboxExcluded=!0}},setSize:function(b,a){this.applyViewBox()},scrubAttrs:function(e){var a,b={},d={},c=e.attr;for(a in c){if(this.translateAttrs.hasOwnProperty(a)){b[this.translateAttrs[a]]=c[a];d[this.translateAttrs[a]]=!0}else {if(this.availableAttrs.hasOwnProperty(a)&&!d[a]){b[a]=c[a]}}}return b},onClick:function(a){this.processEvent('click',a)},onDblClick:function(a){this.processEvent('dblclick',a)},onMouseUp:function(a){this.processEvent('mouseup',a)},onMouseDown:function(a){this.processEvent('mousedown',a)},onMouseOver:function(a){this.processEvent('mouseover',a)},onMouseOut:function(a){this.processEvent('mouseout',a)},onMouseMove:function(a){this.fireEvent('mousemove',a)},onMouseEnter:Ext.emptyFn,onMouseLeave:Ext.emptyFn,addGradient:Ext.emptyFn,add:function(){var a=Array.prototype.slice.call(arguments),b,g=a.length>1,f,e,d,h,c;if(g||Ext.isArray(a[0])){f=g?a:a[0];e=[];for(d=0,h=f.length;d<h;d++){c=f[d];c=this.add(c);e.push(c)}return e}b=this.prepareItems(a[0],!0)[0];this.insertByZIndex(b);this.onAdd(b);return b},insertByZIndex:function(i){var h=this,b=h.items.items,f=b.length,j=Math.ceil,c=i.attr.zIndex,a=f,d=a-1,g=0,e;if(h.orderSpritesByZIndex&&f&&c<b[d].attr.zIndex){while(g<=d){a=j((g+d)/2);e=b[a].attr.zIndex;if(e>c){d=a-1}else {if(e<c){g=a+1}else {break}}}while(a<f&&b[a].attr.zIndex<=c){a++}}h.items.insert(a,i);return a},onAdd:function(a){var b=a.group,f=a.draggable,d,e,c;if(b){d=[].concat(b);e=d.length;for(c=0;c<e;c++){b=d[c];this.getGroup(b).add(a)}delete a.group}if(f){a.initDraggable()}},remove:function(a,d){if(a){this.items.remove(a);var c=[].concat(this.groups.items),e=c.length,b;for(b=0;b<e;b++){c[b].remove(a)}a.onRemove();if(d===!0){a.destroy()}}},removeAll:function(c){var b=this.items.items,d=b.length,a;for(a=d-1;a>-1;a--){this.remove(b[a],c)}},onRemove:Ext.emptyFn,onDestroy:Ext.emptyFn,applyViewBox:function(){var b=this,e=b.viewBox,d=b.width||1,c=b.height||1,h,i,g,f,j,k,a;if(e&&(d||c)){h=e.x;i=e.y;g=e.width;f=e.height;j=c/f;k=d/g;a=Math.min(k,j);if(g*a<d){h-=(d-g*a)/2/a}if(f*a<c){i-=(c-f*a)/2/a}b.viewBoxShift={dx:-h,dy:-i,scale:a};if(b.background){b.background.setAttributes(Ext.apply({},{x:h,y:i,width:d/a,height:c/a},{hidden:!1}),!0)}}else {if(b.background&&d&&c){b.background.setAttributes(Ext.apply({x:0,y:0,width:d,height:c},{hidden:!1}),!0)}}},getBBox:function(a,c){var b=this['getPath'+a.type](a);if(c){a.bbox.plain=a.bbox.plain||photoViewer.draw.Draw.pathDimensions(b);return a.bbox.plain}if(a.dirtyTransform){this.applyTransformations(a,!0)}a.bbox.transform=a.bbox.transform||photoViewer.draw.Draw.pathDimensions(photoViewer.draw.Draw.mapPath(b,a.matrix));return a.bbox.transform},transformToViewBox:function(b,c){if(this.viewBoxShift){var d=this,a=d.viewBoxShift;return [b/a.scale-a.dx,c/a.scale-a.dy]}else {return [b,c]}},applyTransformations:function(a,d){if(a.type=='text'){a.bbox.transform=0;this.transform(a,!1)}a.dirtyTransform=!1;var c=this,b=a.attr;if(b.translation.x!=null||b.translation.y!=null){c.translate(a)}if(b.scaling.x!=null||b.scaling.y!=null){c.scale(a)}if(b.rotation.degrees!=null){c.rotate(a)}a.bbox.transform=0;this.transform(a,d);a.transformations=[]},rotate:function(c){var d,e=c.attr.rotation.degrees,a=c.attr.rotation.x,b=c.attr.rotation.y;if(!Ext.isNumber(a)||!Ext.isNumber(b)){d=this.getBBox(c,!0);a=!Ext.isNumber(a)?d.x+d.width/2:a;b=!Ext.isNumber(b)?d.y+d.height/2:b}c.transformations.push({type:'rotate',degrees:e,x:a,y:b})},translate:function(a){var b=a.attr.translation.x||0,c=a.attr.translation.y||0;a.transformations.push({type:'translate',x:b,y:c})},scale:function(a){var d,e=a.attr.scaling.x||1,f=a.attr.scaling.y||1,b=a.attr.scaling.centerX,c=a.attr.scaling.centerY;if(!Ext.isNumber(b)||!Ext.isNumber(c)){d=this.getBBox(a,!0);b=!Ext.isNumber(b)?d.x+d.width/2:b;c=!Ext.isNumber(c)?d.y+d.height/2:c}a.transformations.push({type:'scale',x:e,y:f,centerX:b,centerY:c})},rectPath:function(d,e,b,c,a){if(a){return [['M',d+a,e],['l',b-a*2,0],['a',a,a,0,0,1,a,a],['l',0,c-a*2],['a',a,a,0,0,1,-a,a],['l',a*2-b,0],['a',a,a,0,0,1,-a,-a],['l',0,a*2-c],['a',a,a,0,0,1,a,-a],['z']]}return [['M',d,e],['l',b,0],['l',0,c],['l',-b,0],['z']]},ellipsePath:function(c,d,b,a){if(a==null){a=b}return [['M',c,d],['m',0,-a],['a',b,a,0,1,1,0,2*a],['a',b,a,0,1,1,0,-2*a],['z']]},getPathpath:function(a){return a.attr.path},getPathcircle:function(b){var a=b.attr;return this.ellipsePath(a.x,a.y,a.radius,a.radius)},getPathellipse:function(b){var a=b.attr;return this.ellipsePath(a.x,a.y,a.radiusX||a.width/2||0,a.radiusY||a.height/2||0)},getPathrect:function(b){var a=b.attr;return this.rectPath(a.x||0,a.y||0,a.width||0,a.height||0,a.r||0)},getPathimage:function(b){var a=b.attr;return this.rectPath(a.x||0,a.y||0,a.width,a.height)},getPathtext:function(b){var a=this.getBBoxText(b);return this.rectPath(a.x,a.y,a.width,a.height)},createGroup:function(b){var a=this.groups.get(b);if(!a){a=new photoViewer.draw.CompositeSprite({surface:this});a.id=b||Ext.id(null,'ext-surface-group-');this.groups.add(a)}return a},getGroup:function(b){var a;if(typeof b=='string'){a=this.groups.get(b);if(!a){a=this.createGroup(b)}}else {a=b}return a},prepareItems:function(a,e){a=[].concat(a);var b,c,d;for(c=0,d=a.length;c<d;c++){b=a[c];if(!(b instanceof photoViewer.draw.Sprite)){b.surface=this;a[c]=this.createItem(b)}else {b.surface=this}}return a},setText:Ext.emptyFn,createItem:Ext.emptyFn,getId:function(){return this.id||(this.id=Ext.id(null,'ext-surface-'))},destroy:function(){var a=this;delete a.domRef;if(a.background){a.background.destroy()}a.removeAll(!0);Ext.destroy(a.groups.items)}},1,0,0,0,0,[['observable',Ext.util.Observable]],[photoViewer.draw,'Surface'],0);Ext.cmd.derive('photoViewer.draw.layout.Component',Ext.layout.component.Auto,{setHeightInDom:!0,setWidthInDom:!0,type:'draw',measureContentWidth:function(a){var d=a.target,b=a.getPaddingInfo(),c=this.getBBox(a);if(!d.viewBox){if(d.autoSize){return c.width+b.width}else {return c.x+c.width+b.width}}else {if(a.heightModel.shrinkWrap){return b.width}else {return c.width/c.height*(a.getProp('contentHeight')-b.height)+b.width}}},measureContentHeight:function(a){var d=a.target,b=a.getPaddingInfo(),c=this.getBBox(a);if(!a.target.viewBox){if(d.autoSize){return c.height+b.height}else {return c.y+c.height+b.height}}else {if(a.widthModel.shrinkWrap){return b.height}else {return c.height/c.width*(a.getProp('contentWidth')-b.width)+b.height}}},getBBox:function(b){var a=b.surfaceBBox;if(!a){a=b.target.surface.items.getBBox();if(a.width===-Infinity&&a.height===-Infinity){a.width=a.height=a.x=a.y=0}b.surfaceBBox=a}return a},publishInnerWidth:function(a,b){a.setContentWidth(b-a.getFrameInfo().width,!0)},publishInnerHeight:function(a,b){a.setContentHeight(b-a.getFrameInfo().height,!0)},finishedLayout:function(a){var c=a.props,b=a.getPaddingInfo();this.owner.setSurfaceSize(c.contentWidth-b.width,c.contentHeight-b.height);Ext.layout.component.Auto.prototype.finishedLayout.apply(this,arguments)}},0,0,0,0,['layout.draw'],0,[photoViewer.draw.layout,'Component'],0);Ext.cmd.derive('photoViewer.draw.Component',Ext.Component,{enginePriority:['Svg','Vml'],baseCls:'x-surface',componentLayout:'draw',viewBox:!0,shrinkWrap:3,autoSize:!1,suspendSizing:0,onRender:function(){Ext.Component.prototype.onRender.apply(this,arguments);if(this.createSurface()!==!1){this.configureSurfaceSize()}},configureSurfaceSize:function(){var b=this,c=b.viewBox,d=b.autoSize,a;if((c||d)&&!b.suspendSizing){a=b.surface.items.getBBox();if(c){b.surface.setViewBox(a.x,a.y,a.width,a.height)}else {b.autoSizeSurface(a)}}},autoSizeSurface:function(a){a=a||this.surface.items.getBBox();this.setSurfaceSize(a.width,a.height)},setSurfaceSize:function(b,a){this.surface.setSize(b,a);if(this.autoSize){var c=this.surface.items.getBBox();this.surface.setViewBox(c.x,c.y-+Ext.isOpera,b,a)}},createSurface:function(){var a=this,c=Ext.applyIf({renderTo:a.el,height:a.height,width:a.width,items:a.items},a.initialConfig),b;delete c.listeners;if(!c.gradients){c.gradients=a.gradients}a.initSurfaceCfg(c);b=photoViewer.draw.Surface.create(c,a.enginePriority);if(!b){return !1}a.surface=b;b.owner=a;function refire(b){return function(c){a.fireEvent(b,c)}}b.on({scope:a,mouseup:refire('mouseup'),mousedown:refire('mousedown'),mousemove:refire('mousemove'),mouseenter:refire('mouseenter'),mouseleave:refire('mouseleave'),click:refire('click'),dblclick:refire('dblclick')})},initSurfaceCfg:Ext.emptyFn,onDestroy:function(){Ext.destroy(this.surface);Ext.Component.prototype.onDestroy.apply(this,arguments)}},0,0,['component','box'],{'component':!0,'box':!0},0,0,[photoViewer.draw,'Component'],0);Ext.cmd.derive('photoViewer.draw.Draw',Ext.Base,{singleton:!0,pathToStringRE:/,?([achlmqrstvxz]),?/gi,pathCommandRE:/([achlmqstvz])[\s,]*((-?\d*\.?\d*(?:e[-+]?\d+)?\s*,?\s*)+)/ig,pathValuesRE:/(-?\d*\.?\d*(?:e[-+]?\d+)?)\s*,?\s*/ig,stopsRE:/^(\d+%?)$/,radian:Math.PI/180,availableAnimAttrs:{along:'along',blur:null,'clip-rect':'csv',cx:null,cy:null,fill:'color','fill-opacity':null,'font-size':null,height:null,opacity:null,path:'path',r:null,rotation:'csv',rx:null,ry:null,scale:'csv',stroke:'color','stroke-opacity':null,'stroke-width':null,translation:'csv',width:null,x:null,y:null},is:function(b,a){a=String(a).toLowerCase();return a=='object'&&b===Object(b)||a=='undefined'&&typeof b==a||a=='null'&&b===null||a=='array'&&Array.isArray&&Array.isArray(b)||Object.prototype.toString.call(b).toLowerCase().slice(8,-1)==a},ellipsePath:function(b){var a=b.attr;return Ext.String.format('M{0},{1}A{2},{3},0,1,1,{0},{4}A{2},{3},0,1,1,{0},{1}z',a.x,a.y-a.ry,a.rx,a.ry,a.y+a.ry)},rectPath:function(b){var a=b.attr;if(a.radius){return Ext.String.format('M{0},{1}l{2},0a{3},{3},0,0,1,{3},{3}l0,{5}a{3},{3},0,0,1,{4},{3}l{6},0a{3},{3},0,0,1,{4},{4}l0,{7}a{3},{3},0,0,1,{3},{4}z',a.x+a.radius,a.y,a.width-a.radius*2,a.radius,-a.radius,a.height-a.radius*2,a.radius*2-a.width,a.radius*2-a.height)}else {return Ext.String.format('M{0},{1}L{2},{1},{2},{3},{0},{3}z',a.x,a.y,a.width+a.x,a.height+a.y)}},path2string:function(){return this.join(',').replace(photoViewer.draw.Draw.pathToStringRE,'$1')},pathToString:function(a){return a.join(',').replace(photoViewer.draw.Draw.pathToStringRE,'$1')},parsePathString:function(c){if(!c){return null}var d={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},a=[],b=this;if(b.is(c,'array')&&b.is(c[0],'array')){a=b.pathClone(c)}if(!a.length){String(c).replace(b.pathCommandRE,function(i,g,h){var e=[],f=g.toLowerCase();h.replace(b.pathValuesRE,function(b,a){a&&e.push(+a)});if(f=='m'&&e.length>2){a.push([g].concat(Ext.Array.splice(e,0,2)));f='l';g=g=='m'?'l':'L'}while(e.length>=d[f]){a.push([g].concat(Ext.Array.splice(e,0,d[f])));if(!d[f]){break}}})}a.toString=b.path2string;return a},mapPath:function(c,e){if(!e){return c}var h,i,d,f,a,g,b;c=this.path2curve(c);for(d=0,f=c.length;d<f;d++){b=c[d];for(a=1,g=b.length;a<g-1;a+=2){h=e.x(b[a],b[a+1]);i=e.y(b[a],b[a+1]);b[a]=h;b[a+1]=i}}return c},pathClone:function(a){var d=[],c,f,b,e;if(!this.is(a,'array')||!this.is(a&&a[0],'array')){a=this.parsePathString(a)}for(b=0,e=a.length;b<e;b++){d[b]=[];for(c=0,f=a[b].length;c<f;c++){d[b][c]=a[b][c]}}d.toString=this.path2string;return d},pathToAbsolute:function(d){if(!this.is(d,'array')||!this.is(d&&d[0],'array')){d=this.parsePathString(d)}var i=[],f=0,g=0,j=0,k=0,h=0,l=d.length,b,a,c,e;if(l&&d[0][0]=='M'){f=+d[0][1];g=+d[0][2];j=f;k=g;h++;i[0]=['M',f,g]}for(;h<l;h++){b=i[h]=[];a=d[h];if(a[0]!=a[0].toUpperCase()){b[0]=a[0].toUpperCase();switch(b[0]){case 'A':b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=+(a[6]+f);b[7]=+(a[7]+g);break;case 'V':b[1]=+a[1]+g;break;case 'H':b[1]=+a[1]+f;break;case 'M':j=+a[1]+f;k=+a[2]+g;default:c=1;e=a.length;for(;c<e;c++){b[c]=+a[c]+(c%2?f:g)};}}else {c=0;e=a.length;for(;c<e;c++){i[h][c]=a[c]}}switch(b[0]){case 'Z':f=j;g=k;break;case 'H':f=b[1];break;case 'V':g=b[1];break;case 'M':a=i[h];e=a.length;j=a[e-2];k=a[e-1];default:a=i[h];e=a.length;f=a[e-2];g=a[e-1];}}i.toString=this.path2string;return i},pathToRelative:function(e){if(!this.is(e,'array')||!this.is(e&&e[0],'array')){e=this.parsePathString(e)}var d=[],g=0,f=0,k=0,l=0,m=0,c,a,b,h,j,i,n,o,p;if(e[0][0]=='M'){g=e[0][1];f=e[0][2];k=g;l=f;m++;d.push(['M',g,f])}for(b=m,n=e.length;b<n;b++){c=d[b]=[];a=e[b];if(a[0]!=a[0].toLowerCase()){c[0]=a[0].toLowerCase();switch(c[0]){case 'a':c[1]=a[1];c[2]=a[2];c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=+(a[6]-g).toFixed(3);c[7]=+(a[7]-f).toFixed(3);break;case 'v':c[1]=+(a[1]-f).toFixed(3);break;case 'm':k=a[1];l=a[2];default:for(h=1,o=a.length;h<o;h++){c[h]=+(a[h]-(h%2?g:f)).toFixed(3)};}}else {c=d[b]=[];if(a[0]=='m'){k=a[1]+g;l=a[2]+f}for(j=0,p=a.length;j<p;j++){d[b][j]=a[j]}}i=d[b].length;switch(d[b][0]){case 'z':g=k;f=l;break;case 'h':g+=+d[b][i-1];break;case 'v':f+=+d[b][i-1];break;default:g+=+d[b][i-2];f+=+d[b][i-1];}}d.toString=this.path2string;return d},path2curve:function(i){var h=this,b=h.pathToAbsolute(i),g=b.length,c={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},a,d,e,f;for(a=0;a<g;a++){b[a]=h.command2curve(b[a],c);if(b[a].length>7){b[a].shift();f=b[a];while(f.length){Ext.Array.splice(b,a++,0,['C'].concat(Ext.Array.splice(f,0,6)))}Ext.Array.erase(b,a,1);g=b.length;a--}d=b[a];e=d.length;c.x=d[e-2];c.y=d[e-1];c.bx=parseFloat(d[e-4])||c.x;c.by=parseFloat(d[e-3])||c.y}return b},interpolatePaths:function(o,n){var k=this,c=k.pathToAbsolute(o),b=k.pathToAbsolute(n),e={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},d={x:0,y:0,bx:0,by:0,X:0,Y:0,qx:null,qy:null},l=function(a,d){if(a[d].length>7){a[d].shift();var e=a[d];while(e.length){Ext.Array.splice(a,d++,0,['C'].concat(Ext.Array.splice(e,0,6)))}Ext.Array.erase(a,d,1);j=Math.max(c.length,b.length||0)}},m=function(d,f,e,g,a){if(d&&f&&d[a][0]=='M'&&f[a][0]!='M'){Ext.Array.splice(f,a,0,['M',g.x,g.y]);e.bx=0;e.by=0;e.x=d[a][1];e.y=d[a][2];j=Math.max(c.length,b.length||0)}},a,j,g,f,i,h;for(a=0,j=Math.max(c.length,b.length||0);a<j;a++){c[a]=k.command2curve(c[a],e);l(c,a);b[a]=k.command2curve(b[a],d);l(b,a);m(c,b,e,d,a);m(b,c,d,e,a);g=c[a];f=b[a];i=g.length;h=f.length;e.x=g[i-2];e.y=g[i-1];e.bx=parseFloat(g[i-4])||e.x;e.by=parseFloat(g[i-3])||e.y;d.bx=parseFloat(f[h-4])||d.x;d.by=parseFloat(f[h-3])||d.y;d.x=f[h-2];d.y=f[h-1]}return [c,b]},command2curve:function(b,a){var c=this;if(!b){return ['C',a.x,a.y,a.x,a.y,a.x,a.y]}if(b[0]!='T'&&b[0]!='Q'){a.qx=a.qy=null}switch(b[0]){case 'M':a.X=b[1];a.Y=b[2];break;case 'A':b=['C'].concat(c.arc2curve.apply(c,[a.x,a.y].concat(b.slice(1))));break;case 'S':b=['C',a.x+(a.x-(a.bx||a.x)),a.y+(a.y-(a.by||a.y))].concat(b.slice(1));break;case 'T':a.qx=a.x+(a.x-(a.qx||a.x));a.qy=a.y+(a.y-(a.qy||a.y));b=['C'].concat(c.quadratic2curve(a.x,a.y,a.qx,a.qy,b[1],b[2]));break;case 'Q':a.qx=b[1];a.qy=b[2];b=['C'].concat(c.quadratic2curve(a.x,a.y,b[1],b[2],b[3],b[4]));break;case 'L':b=['C'].concat(a.x,a.y,b[1],b[2],b[1],b[2]);break;case 'H':b=['C'].concat(a.x,a.y,b[1],a.y,b[1],a.y);break;case 'V':b=['C'].concat(a.x,a.y,a.x,b[1],a.x,b[1]);break;case 'Z':b=['C'].concat(a.x,a.y,a.X,a.Y,a.X,a.Y);break;}return b},quadratic2curve:function(g,h,c,d,e,f){var a=1/3,b=2/3;return [a*g+b*c,a*h+b*d,a*e+b*c,a*f+b*d,e,f]},rotate:function(d,e,b){var a=Math.cos(b),c=Math.sin(b),f=d*a-e*c,g=d*c+e*a;return {x:f,y:g}},arc2curve:function(m,n,d,c,K,X,v,e,f,o){var s=this,k=Math.PI,Y=s.radian,Q=k*120/180,w=Y*(+K||0),g=[],p=Math,B=p.cos,C=p.sin,N=p.sqrt,R=p.abs,M=p.asin,t,i,j,u,x,y,I,q,r,b,a,z,S,V,T,W,J,D,E,F,l,G,H,A,h,U,L,O,P;if(!o){t=s.rotate(m,n,-w);m=t.x;n=t.y;t=s.rotate(e,f,-w);e=t.x;f=t.y;i=(m-e)/2;j=(n-f)/2;u=i*i/(d*d)+j*j/(c*c);if(u>1){u=N(u);d=u*d;c=u*c}x=d*d;y=c*c;I=(X==v?-1:1)*N(R((x*y-x*j*j-y*i*i)/(x*j*j+y*i*i)));q=I*d*j/c+(m+e)/2;r=I*-c*i/d+(n+f)/2;b=M(((n-r)/c).toFixed(7));a=M(((f-r)/c).toFixed(7));b=m<q?k-b:b;a=e<q?k-a:a;if(b<0){b=k*2+b}if(a<0){a=k*2+a}if(v&&b>a){b=b-k*2}if(!v&&a>b){a=a-k*2}}else {b=o[0];a=o[1];q=o[2];r=o[3]}z=a-b;if(R(z)>Q){L=a;O=e;P=f;a=b+Q*(v&&a>b?1:-1);e=q+d*B(a);f=r+c*C(a);g=s.arc2curve(e,f,d,c,K,0,v,O,P,[a,L,q,r])}z=a-b;S=B(b);V=C(b);T=B(a);W=C(a);J=p.tan(z/4);D=4/3*d*J;E=4/3*c*J;F=[m,n];l=[m+D*V,n-E*S];G=[e+D*W,f-E*T];H=[e,f];l[0]=2*F[0]-l[0];l[1]=2*F[1]-l[1];if(o){return [l,G,H].concat(g)}else {g=[l,G,H].concat(g).join().split(',');A=[];U=g.length;for(h=0;h<U;h++){A[h]=h%2?s.rotate(g[h-1],g[h],w).y:s.rotate(g[h],g[h+1],w).x}return A}},rotateAndTranslatePath:function(b){var h=b.rotation.degrees,k=b.rotation.x,l=b.rotation.y,e=b.translation.x,f=b.translation.y,i,g,a,d,c,j=[];if(!h&&!e&&!f){return this.pathToAbsolute(b.attr.path)}e=e||0;f=f||0;i=this.pathToAbsolute(b.attr.path);for(g=i.length;g--;){a=j[g]=i[g].slice();if(a[0]=='A'){d=this.rotatePoint(a[6],a[7],h,k,l);a[6]=d.x+e;a[7]=d.y+f}else {c=1;while(a[c+1]!=null){d=this.rotatePoint(a[c],a[c+1],h,k,l);a[c]=d.x+e;a[c+1]=d.y+f;c+=2}}}return j},rotatePoint:function(b,c,a,d,e){if(!a){return {x:b,y:c}}d=d||0;e=e||0;b=b-d;c=c-e;a=a*this.radian;var f=Math.cos(a),g=Math.sin(a);return {x:b*f-c*g+d,y:b*g+c*f+e}},pathDimensions:function(b){if(!b||!(b+'')){return {x:0,y:0,width:0,height:0}}b=this.path2curve(b);var f=0,g=0,d=[],e=[],j=0,m=b.length,a,h,i,k,l,c;for(;j<m;j++){a=b[j];if(a[0]=='M'){f=a[1];g=a[2];d.push(f);e.push(g)}else {c=this.curveDim(f,g,a[1],a[2],a[3],a[4],a[5],a[6]);d=d.concat(c.min.x,c.max.x);e=e.concat(c.min.y,c.max.y);f=a[5];g=a[6]}}h=Math.min.apply(0,d);i=Math.min.apply(0,e);k=Math.max.apply(0,d);l=Math.max.apply(0,e);return {x:Math.round(h),y:Math.round(i),path:b,width:Math.round(k-h),height:Math.round(l-i)}},intersectInside:function(b,a,c){return (c[0]-a[0])*(b[1]-a[1])>(c[1]-a[1])*(b[0]-a[0])},intersectIntersection:function(d,c,a,b){var e=[],f=a[0]-b[0],g=a[1]-b[1],h=d[0]-c[0],i=d[1]-c[1],j=a[0]*b[1]-a[1]*b[0],k=d[0]*c[1]-d[1]*c[0],l=1/(f*i-g*h);e[0]=(j*h-k*f)*l;e[1]=(j*i-k*g)*l;return e},intersect:function(m,i){var g=this,j=0,l=i.length,c=i[l-1],b=m,a,e,d,k,f,h;for(;j<l;++j){a=i[j];f=b;b=[];e=f[f.length-1];h=0;k=f.length;for(;h<k;h++){d=f[h];if(g.intersectInside(d,c,a)){if(!g.intersectInside(e,c,a)){b.push(g.intersectIntersection(e,d,c,a))}b.push(d)}else {if(g.intersectInside(e,c,a)){b.push(g.intersectIntersection(e,d,c,a))}}e=d}c=a}return b},bezier:function(d,g,h,e,b){if(b===0){return d}else {if(b===1){return e}}var a=1-b,f=a*a*a,c=b/a;return f*(d+c*(3*g+c*(3*h+e*c)))},bezierDim:function(b,c,f,g){var d=[],a,m,e,o,j,i,n,l,k,h;if(b+3*f==g+3*c){a=b-c;a/=2*(b-c-c+f);if(a<1&&a>0){d.push(a)}}else {m=b-3*c+3*f-g;e=2*(b-c-c+f);o=b-c;j=e*e-4*m*o;i=m+m;if(j===0){a=e/i;if(a<1&&a>0){d.push(a)}}else {if(j>0){n=Math.sqrt(j);a=(n+e)/i;if(a<1&&a>0){d.push(a)}a=(e-n)/i;if(a<1&&a>0){d.push(a)}}}}l=Math.min(b,g);k=Math.max(b,g);for(h=0;h<d.length;h++){l=Math.min(l,this.bezier(b,c,f,g,d[h]));k=Math.max(k,this.bezier(b,c,f,g,d[h]))}return [l,k]},curveDim:function(g,h,c,d,e,f,i,j){var a=this.bezierDim(g,c,e,i),b=this.bezierDim(h,d,f,j);return {min:{x:a[0],y:b[0]},max:{x:a[1],y:b[1]}}},getAnchors:function(t,c,f,a,s,b,n){n=n||4;var k=Math,j=k.PI,r=j/2,o=k.abs,w=k.sin,v=k.cos,u=k.atan,p,q,d,e,l,g,m,h,i;p=(f-t)/n;q=(s-f)/n;if(a>=c&&a>=b||a<=c&&a<=b){d=e=r}else {d=u((f-t)/o(a-c));if(c<a){d=j-d}e=u((s-f)/o(a-b));if(b<a){e=j-e}}i=r-(d+e)%(j*2)/2;if(i>r){i-=j}d+=i;e+=i;l=f-p*w(d);g=a+p*v(d);m=f+q*w(e);h=a+q*v(e);if(a>c&&g<c||a<c&&g>c){l+=o(c-g)*(l-f)/(g-a);g=c}if(a>b&&h<b||a<b&&h>b){m-=o(b-h)*(m-f)/(h-a);h=b}return {x1:l,y1:g,x2:m,y2:h}},smooth:function(s,r){var f=this.path2curve(s),e=[f[0]],m=f[0][1],n=f[0][2],q,d,i=1,t=f.length,h=1,k=m,l=n,a,b,g,j,c,o,p;for(;i<t;i++){a=f[i];b=a.length;g=f[i-1];j=g.length;c=f[i+1];o=c&&c.length;if(a[0]=='M'){k=a[1];l=a[2];q=i+1;while(f[q][0]!='C'){q++}e.push(['M',k,l]);h=e.length;m=k;n=l;continue}if(a[b-2]==k&&a[b-1]==l&&(!c||c[0]=='M')){p=e[h].length;d=this.getAnchors(g[j-2],g[j-1],k,l,e[h][p-2],e[h][p-1],r);e[h][1]=d.x2;e[h][2]=d.y2}else {if(!c||c[0]=='M'){d={x1:a[b-2],y1:a[b-1]}}else {d=this.getAnchors(g[j-2],g[j-1],a[b-2],a[b-1],c[o-2],c[o-1],r)}}e.push(['C',m,n,d.x1,d.y1,a[b-2],a[b-1]]);m=d.x2;n=d.y2}return e},findDotAtSegment:function(g,h,c,d,e,f,i,j,a){var b=1-a;return {x:Math.pow(b,3)*g+Math.pow(b,2)*3*a*c+b*3*a*a*e+Math.pow(a,3)*i,y:Math.pow(b,3)*h+Math.pow(b,2)*3*a*d+b*3*a*a*f+Math.pow(a,3)*j}},snapEnds:function(a,d,l,q){if(Ext.isDate(a)){return this.snapEndsByDate(a,d,l)}var c=(d-a)/l,f=Math.floor(Math.log(c)/Math.LN10)+1,g=Math.pow(10,f),b,e,p=Math.round(c%g*Math.pow(10,2-f)),k=[[0,15],[10,1],[20,4],[25,2],[50,9],[100,15]],h=0,j,m,i,o,n=1000000000,r=k.length;e=Math.floor(a/g)*g;if(a==e&&e>0){e=Math.floor((a-g/10)/g)*g}if(q){for(i=0;i<r;i++){j=k[i][0];m=j-p<0?1000000:(j-p)/k[i][1];if(m<n){o=j;n=m}}c=Math.floor(c*Math.pow(10,-f))*Math.pow(10,f)+o*Math.pow(10,f-2);if(a<0&&d>=0){b=0;while(b>a){b-=c;h++}a=+b.toFixed(10);b=0;while(b<d){b+=c;h++}d=+b.toFixed(10)}else {b=a=e;while(b<d){b+=c;h++}}d=+b.toFixed(10)}else {a=e;h=l}return {from:a,to:d,power:f,step:c,steps:h}},snapEndsByDate:function(e,f,h,g){var c=!1,j=[[Ext.Date.MILLI,[1,2,5,10,20,50,100,200,250,500]],[Ext.Date.SECOND,[1,2,5,10,15,30]],[Ext.Date.MINUTE,[1,2,5,10,15,30]],[Ext.Date.HOUR,[1,2,3,4,6,12]],[Ext.Date.DAY,[1,2,7,14]],[Ext.Date.MONTH,[1,2,3,6]]],l=j.length,k=!1,a,b,i,d;for(d=0;d<l;d++){a=j[d];if(!k){for(b=0;b<a[1].length;b++){if(f<Ext.Date.add(e,a[0],a[1][b]*h)){c=[a[0],a[1][b]];k=!0;break}}}}if(!c){i=this.snapEnds(e.getFullYear(),f.getFullYear()+1,h,g);c=[Date.YEAR,Math.round(i.step)]}return this.snapEndsByDateAndStep(e,f,c,g)},snapEndsByDateAndStep:function(g,p,o,n){var a=[g.getFullYear(),g.getMonth(),g.getDate(),g.getHours(),g.getMinutes(),g.getSeconds(),g.getMilliseconds()],e,d,l,i,h,c,m,j,k=o[0],b=o[1],f=0;if(n){e=g}else {switch(k){case Ext.Date.MILLI:e=new Date(a[0],a[1],a[2],a[3],a[4],a[5],Math.floor(a[6]/b)*b);break;case Ext.Date.SECOND:e=new Date(a[0],a[1],a[2],a[3],a[4],Math.floor(a[5]/b)*b,0);break;case Ext.Date.MINUTE:e=new Date(a[0],a[1],a[2],a[3],Math.floor(a[4]/b)*b,0,0);break;case Ext.Date.HOUR:e=new Date(a[0],a[1],a[2],Math.floor(a[3]/b)*b,0,0,0);break;case Ext.Date.DAY:e=new Date(a[0],a[1],Math.floor((a[2]-1)/b)*b+1,0,0,0,0);break;case Ext.Date.MONTH:e=new Date(a[0],Math.floor(a[1]/b)*b,1,0,0,0,0);f=[];j=!0;break;default:e=new Date(Math.floor(a[0]/b)*b,0,1,0,0,0,0);f=[];j=!0;break;}}m=k===Ext.Date.MONTH&&(b==1/2||b==1/3||b==1/4);d=new Date(e);while(d<p){if(m){l=new Date(d);i=l.getFullYear();h=l.getMonth();c=l.getDate();switch(b){case 1/2:if(c>=15){c=1;if(++h>11){i++}}else {c=15};break;case 1/3:if(c>=20){c=1;if(++h>11){i++}}else {if(c>=10){c=20}else {c=10}};break;case 1/4:if(c>=22){c=1;if(++h>11){i++}}else {if(c>=15){c=22}else {if(c>=8){c=15}else {c=8}}};break;}d.setYear(i);d.setMonth(h);d.setDate(c);f.push(new Date(d))}else {if(j){d=Ext.Date.add(d,k,b);f.push(new Date(d))}else {d=Ext.Date.add(d,k,b);f++}}}if(n){d=p}if(j){return {from:+e,to:+d,steps:f}}else {return {from:+e,to:+d,step:(d-e)/f,steps:f}}},sorter:function(a,b){return a.offset-b.offset},rad:function(a){return a%360*Math.PI/180},normalizeRadians:function(b){var a=2*Math.PI;if(b>=0){return b%a}return (b%a+a)%a},degrees:function(a){return a*180/Math.PI%360},normalizeDegrees:function(a){if(a>=0){return a%360}return (a%360+360)%360},withinBox:function(b,c,a){a=a||{};return b>=a.x&&b<=a.x+a.width&&c>=a.y&&c<=a.y+a.height},parseGradient:function(b){var h=this,f=b.type||'linear',k=b.angle||0,j=h.radian,e=b.stops,d=[],c,a,g,i;if(f=='linear'){a=[0,0,Math.cos(k*j),Math.sin(k*j)];g=1/(Math.max(Math.abs(a[2]),Math.abs(a[3]))||1);a[2]*=g;a[3]*=g;if(a[2]<0){a[0]=-a[2];a[2]=0}if(a[3]<0){a[1]=-a[3];a[3]=0}}for(c in e){if(e.hasOwnProperty(c)&&h.stopsRE.test(c)){i={offset:parseInt(c,10),color:photoViewer.draw.Color.toHex(e[c].color)||'#ffffff',opacity:e[c].opacity||1};d.push(i)}}Ext.Array.sort(d,h.sorter);if(f=='linear'){return {id:b.id,type:f,vector:a,stops:d}}else {return {id:b.id,type:f,centerX:b.centerX,centerY:b.centerY,focalX:b.focalX,focalY:b.focalY,radius:b.radius,vector:a,stops:d}}}},0,0,0,0,0,0,[photoViewer.draw,'Draw'],0);Ext.cmd.derive('photoViewer.draw.Matrix',Ext.Base,{constructor:function(a,b,c,d,e,f){if(a!=null){this.matrix=[[a,c,e],[b,d,f],[0,0,1]]}else {this.matrix=[[1,0,0],[0,1,0],[0,0,1]]}},add:function(h,i,j,k,l,m){var f=this,e=[[],[],[]],g=[[h,j,l],[i,k,m],[0,0,1]],a,b,c,d;for(a=0;a<3;a++){for(b=0;b<3;b++){d=0;for(c=0;c<3;c++){d+=f.matrix[a][c]*g[c][b]}e[a][b]=d}}f.matrix=e},prepend:function(h,i,j,k,l,m){var f=this,e=[[],[],[]],g=[[h,j,l],[i,k,m],[0,0,1]],a,b,c,d;for(a=0;a<3;a++){for(b=0;b<3;b++){d=0;for(c=0;c<3;c++){d+=g[a][c]*f.matrix[c][b]}e[a][b]=d}}f.matrix=e},invert:function(){var a=this.matrix,c=a[0][0],d=a[1][0],e=a[0][1],f=a[1][1],g=a[0][2],h=a[1][2],b=c*f-d*e;return new photoViewer.draw.Matrix(f/b,-d/b,-e/b,c/b,(e*h-f*g)/b,(d*g-c*h)/b)},clone:function(){var a=this.matrix,b=a[0][0],c=a[1][0],d=a[0][1],e=a[1][1],f=a[0][2],g=a[1][2];return new photoViewer.draw.Matrix(b,c,d,e,f,g)},translate:function(a,b){this.prepend(1,0,0,1,a,b)},scale:function(b,a,c,d){var e=this;if(a==null){a=b}e.add(b,0,0,a,c*(1-b),d*(1-a))},rotate:function(c,d,e){c=photoViewer.draw.Draw.rad(c);var f=this,a=+Math.cos(c).toFixed(9),b=+Math.sin(c).toFixed(9);f.add(a,b,-b,a,d-a*d+b*e,-(b*d)+e-a*e)},x:function(b,c){var a=this.matrix;return b*a[0][0]+c*a[0][1]+a[0][2]},y:function(b,c){var a=this.matrix;return b*a[1][0]+c*a[1][1]+a[1][2]},get:function(a,b){return +this.matrix[a][b].toFixed(4)},toString:function(){var a=this;return [a.get(0,0),a.get(0,1),a.get(1,0),a.get(1,1),0,0].join()},toSvg:function(){var a=this;return 'matrix('+[a.get(0,0),a.get(1,0),a.get(0,1),a.get(1,1),a.get(0,2),a.get(1,2)].join()+')'},toFilter:function(b,c){var a=this;b=b||0;c=c||0;return "progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', filterType='bilinear', M11="+a.get(0,0)+', M12='+a.get(0,1)+', M21='+a.get(1,0)+', M22='+a.get(1,1)+', Dx='+(a.get(0,2)+b)+', Dy='+(a.get(1,2)+c)+')'},offset:function(){var a=this.matrix;return [(a[0][2]||0).toFixed(4),(a[1][2]||0).toFixed(4)]},split:function(){function norm(a){return a[0]*a[0]+a[1]*a[1]}function normalize(a){var b=Math.sqrt(norm(a));a[0]/=b;a[1]/=b}var c=this.matrix,b={translateX:c[0][2],translateY:c[1][2]},a;a=[[c[0][0],c[0][1]],[c[1][1],c[1][1]]];b.scaleX=Math.sqrt(norm(a[0]));normalize(a[0]);b.shear=a[0][0]*a[1][0]+a[0][1]*a[1][1];a[1]=[a[1][0]-a[0][0]*b.shear,a[1][1]-a[0][1]*b.shear];b.scaleY=Math.sqrt(norm(a[1]));normalize(a[1]);b.shear/=b.scaleY;b.rotate=Math.asin(-a[0][1]);b.isSimple=!+b.shear.toFixed(9)&&(b.scaleX.toFixed(9)==b.scaleY.toFixed(9)||!b.rotate);return b}},3,0,0,0,0,0,[photoViewer.draw,'Matrix'],0);(function(){var c=2.0943951023931953,g=Math.abs,h=Math.cos,b=Math.cos,f=Math.acos,a=Math.sqrt,d=Math.exp,e=Math.log;Ext.cmd.derive('photoViewer.draw.Solver',Ext.Base,{singleton:!0,cubicRoot:function(a){if(a>0){return d(e(a)/3)}else {if(a<0){return -d(e(-a)/3)}else {return 0}}},linearFunction:function(b,c){var a;if(b===0){a=function(a){return c};a.solve=function(a){return []}}else {a=function(a){return b*a+c};a.solve=function(a){return [(a-c)/b]}}return a},quadraticFunction:function(c,d,f){var e;if(c===0){return this.linearFunction(d,f)}else {e=function(a){return (c*a+d)*a+f};var i=d*d-4*c*f,j=function(a){return i+4*c*a},b=1/c*0.5,h=-b*d;b=g(b);e.solve=function(g){var e=j(g);if(e<0){return []}e=a(e);return [h-e*b,h+e*b]}}return e},cubicFunction:function(g,j,k,l){var i;if(g===0){return this.quadraticFunction(j,k,l)}else {i=function(a){return ((g*a+j)*a+k)*a+l};var d=j/g/3,n=k/g,r=l/g,o=d*d,m=(d*n-r)*0.5-d*o,h=o-n/3,q=h*h*h;if(h===0){i.solve=function(a){return [-d+this.cubicRoot(m*2+a/g)]}}else {if(h>0){var e=a(h),p=e*e*e;e+=e}i.solve=function(v){v/=g;var o=m+v*0.5,r=o*o-q;if(r>0){r=a(r);return [-d+this.cubicRoot(o+r)+this.cubicRoot(o-r)]}else {if(r===0){var u=this.cubicRoot(o),s=-d-u;if(o>=0){return [s,s,-d+2*u]}else {return [-d+2*u,s,s]}}else {var t=f(o/p)/3,i=e*b(t)-d,n=e*b(t+c)-d,h=e*b(t-c)-d;if(i<n){if(n<h){return [i,n,h]}else {if(i<h){return [i,h,n]}else {return [h,i,n]}}}else {if(i<h){return [n,i,h]}else {if(n<h){return [n,h,i]}else {return [h,n,i]}}}}}}}}return i},createBezierSolver:function(a,b,c,d){return this.cubicFunction(3*(b-c)+d-a,3*(a-2*b+c),3*(b-a),a)}},0,0,0,0,0,0,[photoViewer.draw,'Solver'],0)})();Ext.cmd.derive('photoViewer.draw.Path',Ext.Base,{statics:{pathRe:/,?([achlmqrstvxz]),?/gi,pathRe2:/-/gi,pathSplitRe:/\s|,/g},svgString:'',constructor:function(b){var a=this;a.coords=[];a.types=[];a.cursor=null;a.startX=0;a.startY=0;a.solvers={};if(b){a.fromSvgString(b)}},clear:function(){var a=this;a.coords.length=0;a.types.length=0;a.cursor=null;a.startX=0;a.startY=0;a.solvers={};a.dirt()},dirt:function(){this.svgString=''},moveTo:function(b,c){var a=this;if(!a.cursor){a.cursor=[b,c]}a.coords.push(b,c);a.types.push('M');a.startX=b;a.startY=c;a.cursor[0]=b;a.cursor[1]=c;a.dirt()},lineTo:function(b,c){var a=this;if(!a.cursor){a.cursor=[b,c];a.coords.push(b,c);a.types.push('M')}else {a.coords.push(b,c);a.types.push('L')}a.cursor[0]=b;a.cursor[1]=c;a.dirt()},bezierCurveTo:function(b,c,f,g,d,e){var a=this;if(!a.cursor){a.moveTo(b,c)}a.coords.push(b,c,f,g,d,e);a.types.push('C');a.cursor[0]=d;a.cursor[1]=e;a.dirt()},quadraticCurveTo:function(b,c,d,e){var a=this;if(!a.cursor){a.moveTo(b,c)}a.bezierCurveTo((a.cursor[0]*2+b)/3,(a.cursor[1]*2+c)/3,(d*2+b)/3,(e*2+c)/3,d,e)},closePath:function(){var a=this;if(a.cursor){a.types.push('Z');a.dirt()}},arcTo:function(l,m,e,f,d,b,n){var i=this;if(b===undefined){b=d}if(n===undefined){n=0}if(!i.cursor){i.moveTo(l,m);return}if(d===0||b===0){i.lineTo(l,m);return}e-=l;f-=m;var g=i.cursor[0]-l,h=i.cursor[1]-m,q=e*h-f*g,j,k,x,z,y,A,v=Math.sqrt(g*g+h*h),w=Math.sqrt(e*e+f*f),t,c,a;if(q===0){i.lineTo(l,m);return}if(b!==d){j=Math.cos(n);k=Math.sin(n);x=j/d;z=k/b;y=-k/d;A=j/b;var u=x*g+z*h;h=y*g+A*h;g=u;u=x*e+z*f;f=y*e+A*f;e=u}else {g/=d;h/=b;e/=d;f/=b}c=g*w+e*v;a=h*w+f*v;t=1/(Math.sin(Math.asin(Math.abs(q)/(v*w))*0.5)*Math.sqrt(c*c+a*a));c*=t;a*=t;var B=(c*g+a*h)/(g*g+h*h),C=(c*e+a*f)/(e*e+f*f);var r=g*B-c,s=h*B-a,D=e*C-c,E=f*C-a,o=Math.atan2(s,r),p=Math.atan2(E,D);if(q>0){if(p<o){p+=Math.PI*2}}else {if(o<p){o+=Math.PI*2}}if(b!==d){c=j*c*d-k*a*b+l;a=k*a*b+j*a*b+m;i.lineTo(j*d*r-k*b*s+c,k*d*r+j*b*s+a);i.ellipse(c,a,d,b,n,o,p,q<0)}else {c=c*d+l;a=a*b+m;i.lineTo(d*r+c,b*s+a);i.ellipse(c,a,d,b,n,o,p,q<0)}},ellipse:function(j,k,h,i,g,d,e,l){var b=this,a=b.coords,o=a.length,m,c,f;if(e-d>=Math.PI*2){b.ellipse(j,k,h,i,g,d,d+Math.PI,l);b.ellipse(j,k,h,i,g,d+Math.PI,e,l);return}if(!l){if(e<d){e+=Math.PI*2}m=b.approximateArc(a,j,k,h,i,g,d,e)}else {if(d<e){d+=Math.PI*2}m=b.approximateArc(a,j,k,h,i,g,e,d);for(c=o,f=a.length-2;c<f;c+=2,f-=2){var n=a[c];a[c]=a[f];a[f]=n;n=a[c+1];a[c+1]=a[f+1];a[f+1]=n}}if(!b.cursor){b.cursor=[a[a.length-2],a[a.length-1]];b.types.push('M')}else {b.cursor[0]=a[a.length-2];b.cursor[1]=a[a.length-1];b.types.push('L')}for(c=2;c<m;c+=6){b.types.push('C')}b.dirt()},arc:function(e,f,a,c,d,b){this.ellipse(e,f,a,a,0,c,d,b)},rect:function(b,c,e,d){if(e==0||d==0){return}var a=this;a.moveTo(b,c);a.lineTo(b+e,c);a.lineTo(b+e,c+d);a.lineTo(b,c+d);a.closePath()},approximateArc:function(s,f,g,q,r,y,t,a){var m=Math.cos(y),n=Math.sin(y),k=Math.cos(t),l=Math.sin(t),z=m*k*q-n*l*r,B=-m*l*q-n*k*r,A=n*k*q+m*l*r,C=-n*l*q+m*k*r,x=Math.PI/2,u=2,d=z,b=B,e=A,c=C,p=0.547443256150549,o,i,h,j,v,w;a-=t;if(a<0){a+=Math.PI*2}s.push(z+f,A+g);while(a>=x){s.push(d+b*p+f,e+c*p+g,d*p+b+f,e*p+c+g,b+f,c+g);u+=6;a-=x;o=d;d=b;b=-o;o=e;e=c;c=-o}if(a){i=(0.3294738052815987+0.012120855841304373*a)*a;h=Math.cos(a);j=Math.sin(a);v=h+i*j;w=j-i*h;s.push(d+b*i+f,e+c*i+g,d*v+b*w+f,e*v+c*w+g,d*h+b*j+f,e*h+c*j+g);u+=6}return u},arcSvg:function(b,c,i,y,m,v,x){if(b<0){b=-b}if(c<0){c=-c}var n=this,u=n.cursor[0],w=n.cursor[1],q=(u-v)/2,r=(w-x)/2,g=Math.cos(i),h=Math.sin(i),o=q*g+r*h,p=-q*h+r*g,k=o/b,l=p/c,a=k*k+l*l,s=(u+v)*0.5,t=(w+x)*0.5,e=0,f=0;if(a>=1){a=Math.sqrt(a);b*=a;c*=a}else {a=Math.sqrt(1/a-1);if(y===m){a=-a}e=a*b*l;f=-a*c*k;s+=g*e-h*f;t+=h*e+g*f}var j=Math.atan2((p-f)/c,(o-e)/b),d=Math.atan2((-p-f)/c,(-o-e)/b)-j;if(m){if(d<=0){d+=Math.PI*2}}else {if(d>=0){d-=Math.PI*2}}n.ellipse(s,t,b,c,i,j,j+d,1-m)},fromSvgString:function(k){if(!k){return}var e=this,b,g={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0,A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},h='',i,j,c=0,d=0,l=!1,a,f,m;if(Ext.isString(k)){b=k.replace(photoViewer.draw.Path.pathRe,' $1 ').replace(photoViewer.draw.Path.pathRe2,' -').split(photoViewer.draw.Path.pathSplitRe)}else {if(Ext.isArray(k)){b=k.join(',').split(photoViewer.draw.Path.pathSplitRe)}}for(a=0,f=0;a<b.length;a++){if(b[a]!==''){b[f++]=b[a]}}b.length=f;e.clear();for(a=0;a<b.length;){h=l;l=b[a];m=l.toUpperCase()!==l;a++;switch(l){case 'M':e.moveTo(c=+b[a],d=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c=+b[a],d=+b[a+1]);a+=2};break;case 'L':e.lineTo(c=+b[a],d=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c=+b[a],d=+b[a+1]);a+=2};break;case 'A':while(a<f&&!g.hasOwnProperty(b[a])){e.arcSvg(+b[a],+b[a+1],+b[a+2]*Math.PI/180,+b[a+3],+b[a+4],c=+b[a+5],d=+b[a+6]);a+=7};break;case 'C':while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(+b[a],+b[a+1],i=+b[a+2],j=+b[a+3],c=+b[a+4],d=+b[a+5]);a+=6};break;case 'Z':e.closePath();break;case 'm':e.moveTo(c+=+b[a],d+=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c+=+b[a],d+=+b[a+1]);a+=2};break;case 'l':e.lineTo(c+=+b[a],d+=+b[a+1]);a+=2;while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c+=+b[a],d+=+b[a+1]);a+=2};break;case 'a':while(a<f&&!g.hasOwnProperty(b[a])){e.arcSvg(+b[a],+b[a+1],+b[a+2]*Math.PI/180,+b[a+3],+b[a+4],c+=+b[a+5],d+=+b[a+6]);a+=7};break;case 'c':while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(c+ +b[a],d+ +b[a+1],i=c+ +b[a+2],j=d+ +b[a+3],c+=+b[a+4],d+=+b[a+5]);a+=6};break;case 'z':e.closePath();break;case 's':if(!(h==='c'||h==='C'||h==='s'||h==='S')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(c+c-i,d+d-j,i=c+ +b[a],j=d+ +b[a+1],c+=+b[a+2],d+=+b[a+3]);a+=4};break;case 'S':if(!(h==='c'||h==='C'||h==='s'||h==='S')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.bezierCurveTo(c+c-i,d+d-j,i=+b[a],j=+b[a+1],c=+b[a+2],d=+b[a+3]);a+=4};break;case 'q':while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=c+ +b[a],j=d+ +b[a+1],c+=+b[a+2],d+=+b[a+3]);a+=4};break;case 'Q':while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=+b[a],j=+b[a+1],c=+b[a+2],d=+b[a+3]);a+=4};break;case 't':if(!(h==='q'||h==='Q'||h==='t'||h==='T')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=c+c-i,j=d+d-j,c+=+b[a+1],d+=+b[a+2]);a+=2};break;case 'T':if(!(h==='q'||h==='Q'||h==='t'||h==='T')){i=c;j=d};while(a<f&&!g.hasOwnProperty(b[a])){e.quadraticCurveTo(i=c+c-i,j=d+d-j,c=+b[a+1],d=+b[a+2]);a+=2};break;case 'h':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c+=+b[a],d);a++};break;case 'H':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c=+b[a],d);a++};break;case 'v':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c,d+=+b[a]);a++};break;case 'V':while(a<f&&!g.hasOwnProperty(b[a])){e.lineTo(c,d=+b[a]);a++};break;}}},rayTestLine:function(c,a,g,d,e,b){var f;if(a===d){if(b===a){if(Math.min(c,g)<=e&&e<=Math.max(c,g)){return -1}}else {return 0}}if(a<b&&b<d||d<b&&b<a){f=(b-a)*(g-c)/(d-a)+c;if(f===e){return -1}else {if(f<e){return 0}else {return 1}}}else {return 0}},rayTestCubicBezier:function(c,j,d,k,e,l,f,m,b,g,h){if(Math.min(c,d,e,f)<=b&&b<=Math.max(c,d,e,f)){if(Math.min(j,k,l,m)<=g&&g<=Math.max(j,k,l,m)){var i=this,n=i.solvers[h]||(i.solvers[h]=photoViewer.app.view.photoViewer.annotations.imports.Solver.createBezierSolver(c,d,e,f)),a=n.solve(g);return +(b<=a[0]&&0<=a[0]&&a[0]<=1)+ +(b<=a[1]&&0<=a[1]&&a[1]<=1)+ +(b<=a[2]&&0<=a[2]&&a[2]<=1)}}return 0},isPointInPath:function(j,k){var g=this,h,a,f=0,c=0,m=g.types,b=g.coords,n=m.length,i=null,l=null,d=0,e=0;for(h=0,a=0;h<n;h++){switch(m[h]){case 'M':if(i!==null){c=g.rayTestLine(i,l,d,e,j,k);if(c<0){f+=1}else {f+=c}};i=d=b[a];l=e=b[a+1];a+=2;break;case 'L':c=g.rayTestLine(d,e,b[a],b[a+1],j,k);if(c<0){return !0};f+=c;d=b[a];e=b[a+1];a+=2;break;case 'C':c=g.rayTestCubicBezier(d,e,b[a],b[a+1],b[a+2],b[a+3],b[a+4],b[a+5],j,k,h);if(c<0){return !0};f+=c;d=b[a+4];e=b[a+5];a+=6;break;case 'Z':break;}}return f%2===1},clone:function(){var b=this,a=new photoViewer.draw.Path();a.coords=b.coords.slice(0);a.types=b.types.slice(0);a.cursor=b.cursor?b.cursor.slice(0):null;a.startX=b.startX;a.startY=b.startY;a.svgString=b.svgString;return a},transform:function(a){if(a.isIdentity()){return}var i=a.getXX(),k=a.getYX(),f=a.getDX(),j=a.getXY(),l=a.getYY(),g=a.getDY(),c=this.coords,b=0,h=c.length,d,e;for(;b<h;b+=2){d=c[b];e=c[b+1];c[b]=d*i+e*k+f;c[b+1]=d*j+e*l+g}this.dirt()},getDimension:function(a){if(!a){a={}}if(!this.types||!this.types.length){a.x=0;a.y=0;a.width=0;a.height=0;return a}a.left=Infinity;a.top=Infinity;a.right=-Infinity;a.bottom=-Infinity;var f=0,b=0,g=this.types,c=this.coords,h=g.length,d,e;for(;f<h;f++){switch(g[f]){case 'M':case 'L':d=c[b];e=c[b+1];a.left=Math.min(d,a.left);a.top=Math.min(e,a.top);a.right=Math.max(d,a.right);a.bottom=Math.max(e,a.bottom);b+=2;break;case 'C':this.expandDimension(a,d,e,c[b],c[b+1],c[b+2],c[b+3],d=c[b+4],e=c[b+5]);b+=6;break;}}a.x=a.left;a.y=a.top;a.width=a.right-a.left;a.height=a.bottom-a.top;return a},getDimensionWithTransform:function(d,a){if(!this.types||!this.types.length){if(!a){a={}}a.x=0;a.y=0;a.width=0;a.height=0;return a}a.left=Infinity;a.top=Infinity;a.right=-Infinity;a.bottom=-Infinity;var i=d.getXX(),k=d.getYX(),g=d.getDX(),j=d.getXY(),l=d.getYY(),h=d.getDY(),m=0,b=0,n=this.types,c=this.coords,o=n.length,e,f;for(;m<o;m++){switch(n[m]){case 'M':case 'L':e=c[b]*i+c[b+1]*k+g;f=c[b]*j+c[b+1]*l+h;a.left=Math.min(e,a.left);a.top=Math.min(f,a.top);a.right=Math.max(e,a.right);a.bottom=Math.max(f,a.bottom);b+=2;break;case 'C':this.expandDimension(a,e,f,c[b]*i+c[b+1]*k+g,c[b]*j+c[b+1]*l+h,c[b+2]*i+c[b+3]*k+g,c[b+2]*j+c[b+3]*l+h,e=c[b+4]*i+c[b+5]*k+g,f=c[b+4]*j+c[b+5]*l+h);b+=6;break;}}if(!a){a={}}a.x=a.left;a.y=a.top;a.width=a.right-a.left;a.height=a.bottom-a.top;return a},expandDimension:function(a,l,n,h,j,i,k,m,o){var c=this,e=a.left,f=a.right,g=a.top,d=a.bottom,b=c.dim||(c.dim=[]);c.curveDimension(l,h,i,m,b);e=Math.min(e,b[0]);f=Math.max(f,b[1]);c.curveDimension(n,j,k,o,b);g=Math.min(g,b[0]);d=Math.max(d,b[1]);a.left=e;a.right=f;a.top=g;a.bottom=d},curveDimension:function(e,g,j,h,k){var l=3*(-e+3*(g-j)+h),i=6*(e-2*g+j),m=-3*(e-g),a,b,d=Math.min(e,h),c=Math.max(e,h),f;if(l===0){if(i===0){k[0]=d;k[1]=c;return}else {a=-m/i;if(0<a&&a<1){b=this.interpolate(e,g,j,h,a);d=Math.min(d,b);c=Math.max(c,b)}}}else {f=i*i-4*l*m;if(f>=0){f=Math.sqrt(f);a=(f-i)/2/l;if(0<a&&a<1){b=this.interpolate(e,g,j,h,a);d=Math.min(d,b);c=Math.max(c,b)}if(f>0){a-=f/l;if(0<a&&a<1){b=this.interpolate(e,g,j,h,a);d=Math.min(d,b);c=Math.max(c,b)}}}}k[0]=d;k[1]=c},interpolate:function(c,e,f,d,a){if(a===0){return c}if(a===1){return d}var b=(1-a)/a;return a*a*a*(d+b*(3*f+b*(3*e+b*c)))},fromStripes:function(e){var a=this,c=0,g=e.length,d,f,b;a.clear();for(;c<g;c++){b=e[c];a.coords.push.apply(a.coords,b);a.types.push('M');for(d=2,f=b.length;d<f;d+=6){a.types.push('C')}}if(!a.cursor){a.cursor=[]}a.cursor[0]=a.coords[a.coords.length-2];a.cursor[1]=a.coords[a.coords.length-1];a.dirt()},toStripes:function(m){var i=m||[],g,e,f,c,d,j,k,h,a,l=this.types,b=this.coords,n=l.length;for(h=0,a=0;h<n;h++){switch(l[h]){case 'M':g=[j=c=b[a++],k=d=b[a++]];i.push(g);break;case 'L':e=b[a++];f=b[a++];g.push((c+c+e)/3,(d+d+f)/3,(c+e+e)/3,(d+f+f)/3,c=e,d=f);break;case 'C':g.push(b[a++],b[a++],b[a++],b[a++],c=b[a++],d=b[a++]);break;case 'Z':e=j;f=k;g.push((c+c+e)/3,(d+d+f)/3,(c+e+e)/3,(d+f+f)/3,c=e,d=f);break;}}return i},updateSvgString:function(){var c=[],e=this.types,b=this.coords,f=e.length,d=0,a=0;for(;d<f;d++){switch(e[d]){case 'M':case 'm':c.push(e[d]+b[a]+','+b[a+1]);a+=2;break;case 'L':c.push('L'+b[a]+','+b[a+1]);a+=2;break;case 'C':case 'c':c.push(e[d]+b[a]+','+b[a+1]+' '+b[a+2]+','+b[a+3]+' '+b[a+4]+','+b[a+5]);a+=6;break;case 'Z':c.push('Z');break;}}this.svgString=c.join('')},toString:function(){if(!this.svgString){this.updateSvgString()}return this.svgString},relativeMoveTo:function(b,c){var a=this;if(!a.cursor){a.moveTo(b,c);return}a.coords.push(b-a.cursor[0],c-a.cursor[1]);a.types.push('m');a.startX=b;a.startY=c;a.cursor[0]=b;a.cursor[1]=c;a.dirt()},convertAbsToRelPathBezierCurveTo:function(e,f,i,j,g,h){var a=this,d=0;if(!a.cursor){a.moveTo(e,f)}for(var b=0;b<arguments.length;b++){var c=arguments[b]-a.cursor[b%2];a.coords.push(c);d+=c.toString().length}a.types.push('c');a.cursor[0]=g;a.cursor[1]=h;a.dirt();return d},convertRelToAbsPathBezierCurveTo:function(b,d,c,e,f,g){var a=this;a.bezierCurveTo(a.cursor[0]+b,a.cursor[1]+d,a.cursor[0]+c,a.cursor[1]+e,a.cursor[0]+f,a.cursor[1]+g)}},3,0,0,0,0,0,[photoViewer.draw,'Path'],0);Ext.cmd.derive('photoViewer.draw.SpriteDD',photoViewer.dd.DragSource,{constructor:function(b,d){var a=this,c=b.el;a.sprite=b;a.el=c;a.dragData={el:c,sprite:b};photoViewer.dd.DragSource.prototype.constructor.call(this,c,d);a.sprite.setStyle('cursor','move')},showFrame:Ext.emptyFn,createFrame:Ext.emptyFn,getDragEl:function(a){return this.el},getRegion:function(){var h=this,k=h.el,d,f,i,g,j,o,n,l,m,e,a,c,b;a=h.sprite;e=a.getBBox();c=a.drawComponent?a.drawComponent.getScale():1;b=a.el?Number(a.el.dom.getAttribute('stroke-width'))*c:0;try{d=k.getXY()}catch(p){}if(!d){return null}f=d[0]-b;i=f+e.width*c+b*2;g=d[1]-b;j=g+e.height*c+b*2;return new Ext.util.Region(g,i,j,f)},startDrag:function(b,c){var a=this,d=a.sprite.attr;a.prev=a.sprite.surface.transformToViewBox(b,c)},onDrag:function(g){var a=g.getXY(),b=this,c=b.sprite,d=c.attr,e,f;a=b.sprite.surface.transformToViewBox(a[0],a[1]);e=a[0]-b.prev[0];f=a[1]-b.prev[1];c.setAttributes({translate:{x:d.translation.x+e,y:d.translation.y+f}},!0);b.prev=a},setDragElPos:function(){return !1}},1,0,0,0,0,0,[photoViewer.draw,'SpriteDD'],0);Ext.cmd.derive('photoViewer.draw.Sprite',Ext.Base,{dirty:!1,dirtyHidden:!1,dirtyTransform:!1,dirtyPath:!0,dirtyFont:!0,zIndexDirty:!0,isSprite:!0,zIndex:0,fontProperties:['font','font-size','font-weight','font-style','font-family','text-anchor','text'],pathProperties:['x','y','d','path','height','width','radius','r','rx','ry','cx','cy'],constructor:function(a){var b=this;a=Ext.merge({},a||{});b.id=Ext.id(null,'ext-sprite-');b.transformations=[];Ext.copyTo(this,a,'surface,group,type,draggable');b.bbox={};b.attr={zIndex:0,translation:{x:null,y:null},rotation:{degrees:null,x:null,y:null},scaling:{x:null,y:null,cx:null,cy:null}};delete a.surface;delete a.group;delete a.type;delete a.draggable;b.setAttributes(a);b.mixins.observable.constructor.apply(this,arguments)},initDraggable:function(){var a=this;if(!a.el){a.surface.createSpriteElement(a)}a.dd=new photoViewer.draw.SpriteDD(a,Ext.isBoolean(a.draggable)?a.draggable:null);a.on('beforedestroy',a.dd.destroy,a.dd)},setAttributes:function(a,s){var b=this,o=b.fontProperties,q=o.length,p=b.pathProperties,r=p.length,n=!!b.surface,m=n&&b.surface.customAttributes||{},e=b.attr,l=!1,d,i,h,k,f,j,c,g;a=Ext.apply({},a);for(d in m){if(a.hasOwnProperty(d)&&typeof m[d]=='function'){Ext.apply(a,m[d].apply(b,[].concat(a[d])))}}if(!!a.hidden!==!!e.hidden){b.dirtyHidden=!0}for(i=0;i<r;i++){d=p[i];if(d in a&&a[d]!==e[d]){b.dirtyPath=!0;l=!0;break}}if('zIndex' in a){b.zIndexDirty=!0}if('text' in a){b.dirtyFont=!0;l=!0;a.text=b.transformText(a.text)}for(i=0;i<q;i++){d=o[i];if(d in a&&a[d]!==e[d]){b.dirtyFont=!0;l=!0;break}}h=a.translation||a.translate;delete a.translate;delete a.translation;k=e.translation;if(h){if('x' in h&&h.x!==k.x||'y' in h&&h.y!==k.y){b.dirtyTransform=!0;k.x=h.x;k.y=h.y}}f=a.rotation||a.rotate;j=e.rotation;delete a.rotate;delete a.rotation;if(f){if('x' in f&&f.x!==j.x||'y' in f&&f.y!==j.y||'degrees' in f&&f.degrees!==j.degrees){b.dirtyTransform=!0;j.x=f.x;j.y=f.y;j.degrees=f.degrees}}c=a.scaling||a.scale;g=e.scaling;delete a.scale;delete a.scaling;if(c){if('x' in c&&c.x!==g.x||'y' in c&&c.y!==g.y||'cx' in c&&c.cx!==g.cx||'cy' in c&&c.cy!==g.cy){b.dirtyTransform=!0;g.x=c.x;g.y=c.y;g.cx=c.cx;g.cy=c.cy}}if(!b.dirtyTransform&&l){if(e.scaling.x===null||e.scaling.y===null||e.rotation.y===null||e.rotation.y===null){b.dirtyTransform=!0}}Ext.apply(e,a);b.dirty=!0;if(s===!0&&n){b.redraw()}return this},transformText:Ext.identityFn,getBBox:function(){return this.surface.getBBox(this)},setText:function(a){this.attr.text=a;this.surface.applyAttrs(this);return this},hide:function(a){this.setAttributes({hidden:!0},a);return this},show:function(a){this.setAttributes({hidden:!1},a);return this},remove:function(){if(this.surface){this.surface.remove(this);return !0}return !1},onRemove:function(){this.surface.onRemove(this)},destroy:function(){var a=this;if(a.fireEvent('beforedestroy',a)!==!1){a.remove();a.surface.onDestroy(a);a.clearListeners();a.fireEvent('destroy')}},redraw:function(){var b=this,d=!b.el||b.dirty,c=b.surface,a;c.renderItem(b);if(d){a=c.owner;if(!b.isBackground&&a&&(a.viewBox||a.autoSize)){a.configureSurfaceSize()}}return this},setStyle:function(){this.el.setStyle.apply(this.el,arguments);return this},addCls:function(a){this.surface.addCls(this,a);return this},removeCls:function(a){this.surface.removeCls(this,a);return this}},1,0,0,0,0,[['observable',Ext.util.Observable],['animate',Ext.util.Animate]],[photoViewer.draw,'Sprite'],0);Ext.cmd.derive('photoViewer.draw.engine.ImageExporter',Ext.Base,{singleton:!0,defaultUrl:'http://svg.sencha.io',supportedTypes:['image/png','image/jpeg'],widthParam:'width',heightParam:'height',typeParam:'type',svgParam:'svg',formCls:'x-hide-display',generate:function(d,a){a=a||{};var b=this,e=a.type,c;if(Ext.Array.indexOf(b.supportedTypes,e)===-1){return !1}c=Ext.getBody().createChild({tag:'form',method:'POST',action:a.url||b.defaultUrl,cls:b.formCls,children:[{tag:'input',type:'hidden',name:a.widthParam||b.widthParam,value:a.width||d.width},{tag:'input',type:'hidden',name:a.heightParam||b.heightParam,value:a.height||d.height},{tag:'input',type:'hidden',name:a.typeParam||b.typeParam,value:e},{tag:'input',type:'hidden',name:a.svgParam||b.svgParam}]});c.last(null,!0).value=photoViewer.draw.engine.SvgExporter.generate(d);c.dom.submit();c.remove();return !0}},0,0,0,0,0,0,[photoViewer.draw.engine,'ImageExporter'],0);Ext.cmd.derive('photoViewer.draw.engine.Svg',photoViewer.draw.Surface,{engine:'Svg',trimRe:/^\s+|\s+$/g,spacesRe:/\s+/,xlink:'http://www.w3.org/1999/xlink',translateAttrs:{radius:'r',radiusX:'rx',radiusY:'ry',path:'d',lineWidth:'stroke-width',fillOpacity:'fill-opacity',strokeOpacity:'stroke-opacity',strokeLinejoin:'stroke-linejoin'},parsers:{},fontRe:/^font-?/,minDefaults:{circle:{cx:0,cy:0,r:0,fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},ellipse:{cx:0,cy:0,rx:0,ry:0,fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},rect:{x:0,y:0,width:0,height:0,rx:0,ry:0,fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},text:{x:0,y:0,'text-anchor':'start','font-family':null,'font-size':null,'font-weight':null,'font-style':null,fill:'#000',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},path:{d:'M0,0',fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},image:{x:0,y:0,width:0,height:0,preserveAspectRatio:'none',opacity:null}},createSvgElement:function(d,a){var c=this.domRef.createElementNS('http://www.w3.org/2000/svg',d),b;if(a){for(b in a){c.setAttribute(b,String(a[b]))}}return c},createSpriteElement:function(a){var b=this.createSvgElement(a.type);b.id=a.id;if(b.style){b.style.webkitTapHighlightColor='rgba(0,0,0,0)'}a.el=Ext.get(b);this.applyZIndex(a);a.matrix=new photoViewer.draw.Matrix();a.bbox={plain:0,transform:0};this.applyAttrs(a);this.applyTransformations(a);a.fireEvent('render',a);return b},getBBoxText:function(e){var a={},b,f,g,d,h,c;if(e&&e.el){c=e.el.dom;try{a=c.getBBox();return a}catch(i){}a={x:a.x,y:Infinity,width:0,height:0};h=c.getNumberOfChars();for(d=0;d<h;d++){b=c.getExtentOfChar(d);a.y=Math.min(b.y,a.y);f=b.y+b.height-a.y;a.height=Math.max(a.height,f);g=b.x+b.width-a.x;a.width=Math.max(a.width,g)}return a}},hide:function(){Ext.get(this.el).hide()},show:function(){Ext.get(this.el).show()},hidePrim:function(a){this.addCls(a,'x-hide-visibility')},showPrim:function(a){this.removeCls(a,'x-hide-visibility')},getDefs:function(){return this._defs||(this._defs=this.createSvgElement('defs'))},transform:function(d,h){var i=this,b=new photoViewer.draw.Matrix(),f=d.transformations,g=f.length,e=0,a,c;for(;e<g;e++){a=f[e];c=a.type;if(c=='translate'){b.translate(a.x,a.y)}else {if(c=='rotate'){b.rotate(a.degrees,a.x,a.y)}else {if(c=='scale'){b.scale(a.x,a.y,a.centerX,a.centerY)}}}}d.matrix=b;if(!h){d.el.set({transform:b.toSvg()})}},setSize:function(b,a){var c=this,d=c.el;b=+b||c.width;a=+a||c.height;c.width=b;c.height=a;d.setSize(b,a);d.set({width:b,height:a});photoViewer.draw.Surface.prototype.setSize.call(this,b,a)},getRegion:function(){var b=this.el.getXY(),a=this.bgRect.getXY(),c=Math.max,d=c(b[0],a[0]),e=c(b[1],a[1]);return {left:d,top:e,right:d+this.width,bottom:e+this.height}},onRemove:function(a){if(a.el){a.el.destroy();delete a.el}photoViewer.draw.Surface.prototype.onRemove.apply(this,arguments)},setViewBox:function(c,d,b,a){if(isFinite(c)&&isFinite(d)&&isFinite(b)&&isFinite(a)){photoViewer.draw.Surface.prototype.setViewBox.apply(this,arguments);this.el.dom.setAttribute('viewBox',[c,d,b,a].join(' '))}},render:function(g){var a=this,e,b,f,d,c;if(!a.el){e={xmlns:'http://www.w3.org/2000/svg',version:1.1,width:a.width||0,height:a.height||0};if(a.forceLtr){e.direction='ltr'}b=a.createSvgElement('svg',e);f=a.getDefs();d=a.createSvgElement('rect',{width:'100%',height:'100%',fill:'#000',stroke:'none',opacity:0});if(Ext.isSafari3){c=a.createSvgElement('rect',{x:-10,y:-10,width:'110%',height:'110%',fill:'none',stroke:'#000'})}b.appendChild(f);if(Ext.isSafari3){b.appendChild(c)}b.appendChild(d);g.appendChild(b);a.el=Ext.get(b);a.bgRect=Ext.get(d);if(Ext.isSafari3){a.webkitRect=Ext.get(c);a.webkitRect.hide()}a.el.on({scope:a,mouseup:a.onMouseUp,mousedown:a.onMouseDown,mouseover:a.onMouseOver,mouseout:a.onMouseOut,mousemove:a.onMouseMove,mouseenter:a.onMouseEnter,mouseleave:a.onMouseLeave,click:a.onClick,dblclick:a.onDblClick})}a.renderAll()},onMouseEnter:function(a){if(this.el.parent().getRegion().contains(a.getPoint())){this.fireEvent('mouseenter',a)}},onMouseLeave:function(a){if(!this.el.parent().getRegion().contains(a.getPoint())){this.fireEvent('mouseleave',a)}},processEvent:function(d,c){var a=c.getTarget(),e=this.surface,b;this.fireEvent(d,c);if(a.nodeName=='tspan'&&a.parentNode){a=a.parentNode}b=this.items.get(a.id);if(b){b.fireEvent(d,b,c)}},tuneText:function(a,e){var l=a.el.dom,b=[],d,k,g,c,h,j,f,i;if(e.hasOwnProperty('text')){g=a.tspans&&Ext.Array.map(a.tspans,function(b){return b.textContent}).join('');if(!a.tspans||e.text!=g){b=this.setText(a,e.text);a.tspans=b}else {b=a.tspans||[]}}if(b.length){d=this.getBBoxText(a).height;i=a.el.dom.getAttribute('x');for(c=0,h=b.length;c<h;c++){f=Ext.isFF3_0||Ext.isFF3_5?2:4;b[c].setAttribute('x',i);b[c].setAttribute('dy',c?d*1.2:d/f)}a.dirty=!0}},setText:function(i,h){var j=this,c=i.el.dom,f=[],k,b,e,a,g,d;while(c.firstChild){c.removeChild(c.firstChild)}d=String(h).split('\n');for(a=0,g=d.length;a<g;a++){e=d[a];if(e){b=j.createSvgElement('tspan');b.appendChild(document.createTextNode(Ext.htmlDecode(e)));c.appendChild(b);f[a]=b}}return f},renderAll:function(){this.items.each(this.renderItem,this)},renderItem:function(a){if(!this.el){return}if(!a.el){this.createSpriteElement(a)}if(a.zIndexDirty){this.applyZIndex(a)}if(a.dirty){this.applyAttrs(a);if(a.dirtyTransform){this.applyTransformations(a)}}},redraw:function(a){a.dirty=a.zIndexDirty=!0;this.renderItem(a)},applyAttrs:function(a){var c=this,f=a.el,g=a.group,n=a.attr,m=c.parsers,l=c.gradientsMap||{},p=Ext.isSafari&&!Ext.isStrict,q=c.fontRe,j,h,o,b,r,d,k,s,t,i,e;if(g){j=[].concat(g);o=j.length;for(h=0;h<o;h++){g=j[h];c.getGroup(g).add(a)}delete a.group}b=c.scrubAttrs(a)||{};a.bbox.plain=0;a.bbox.transform=0;if(a.type=='circle'||a.type=='ellipse'){b.cx=b.cx||b.x;b.cy=b.cy||b.y}else {if(a.type=='rect'){b.rx=b.ry=b.r}else {if(a.type=='path'&&b.d){b.d=photoViewer.draw.Draw.pathToString(photoViewer.draw.Draw.pathToAbsolute(b.d))}}}a.dirtyPath=!1;if(b['clip-rect']){c.setClip(a,b);delete b['clip-rect']}if(a.type=='text'&&b.font&&a.dirtyFont){f.set({style:'font: '+b.font})}if(a.type=='image'){f.dom.setAttributeNS(c.xlink,'href',b.src)}Ext.applyIf(b,c.minDefaults[a.type]);if(a.dirtyHidden){n.hidden?c.hidePrim(a):c.showPrim(a);a.dirtyHidden=!1}for(d in b){e=b[d];if(b.hasOwnProperty(d)&&e!=null){if(p&&'color|stroke|fill'.indexOf(d)>-1&&e in l){e=l[e]}if(d=='hidden'&&a.type=='text'){continue}if(d in m){f.dom.setAttribute(d,m[d](e,a,c))}else {f.dom.setAttribute(d,e);if(q.test(d)){i=i||{};i[d]=e;f.setStyle(d,e)}}}}if(a.type=='text'){c.tuneText(a,b)}a.dirtyFont=!1;k=n.style;if(k){f.setStyle(k)}a.dirty=!1;if(Ext.isSafari3){c.webkitRect.show();Ext.defer(function(){c.webkitRect.hide()},1)}},setClip:function(c,f){var e=this,d=f['clip-rect'],b,a;if(d){if(c.clip){c.clip.parentNode.parentNode.removeChild(c.clip.parentNode)}b=e.createSvgElement('clipPath');a=e.createSvgElement('rect');b.id=Ext.id(null,'ext-clip-');a.setAttribute('x',d.x);a.setAttribute('y',d.y);a.setAttribute('width',d.width);a.setAttribute('height',d.height);b.appendChild(a);e.getDefs().appendChild(b);c.el.dom.setAttribute('clip-path','url(#'+b.id+')');c.clip=a}},applyZIndex:function(c){var d=this,e=d.items,a=e.indexOf(c),f=c.el,b;if(d.el.dom.childNodes[a+2]!==f.dom){if(a>0){do{b=e.getAt(--a).el}while(!b&&a>0)}f.insertAfter(b||d.bgRect)}c.zIndexDirty=!1},createItem:function(b){var a=new photoViewer.draw.Sprite(b);a.surface=this;return a},addGradient:function(a){a=photoViewer.draw.Draw.parseGradient(a);var c=this,j=a.stops.length,e=a.vector,i=Ext.isSafari&&!Ext.isStrict,b,f,d,g,h;h=c.gradientsMap||{};if(!i){if(a.type=='linear'){b=c.createSvgElement('linearGradient');b.setAttribute('x1',e[0]);b.setAttribute('y1',e[1]);b.setAttribute('x2',e[2]);b.setAttribute('y2',e[3])}else {b=c.createSvgElement('radialGradient');b.setAttribute('cx',a.centerX);b.setAttribute('cy',a.centerY);b.setAttribute('r',a.radius);if(Ext.isNumber(a.focalX)&&Ext.isNumber(a.focalY)){b.setAttribute('fx',a.focalX);b.setAttribute('fy',a.focalY)}}b.id=a.id;c.getDefs().appendChild(b);for(g=0;g<j;g++){f=a.stops[g];d=c.createSvgElement('stop');d.setAttribute('offset',f.offset+'%');d.setAttribute('stop-color',f.color);d.setAttribute('stop-opacity',f.opacity);b.appendChild(d)}}else {h['url(#'+a.id+')']=a.stops[0].color}c.gradientsMap=h},hasCls:function(b,a){return a&&(' '+(b.el.dom.getAttribute('class')||'')+' ').indexOf(' '+a+' ')!=-1},addCls:function(g,a){var e=g.el,b,h,c,d=[],f=e.getAttribute('class')||'';if(!Ext.isArray(a)){if(typeof a=='string'&&!this.hasCls(g,a)){e.set({'class':f+' '+a})}}else {for(b=0,h=a.length;b<h;b++){c=a[b];if(typeof c=='string'&&(' '+f+' ').indexOf(' '+c+' ')==-1){d.push(c)}}if(d.length){e.set({'class':' '+d.join(' ')})}}},removeCls:function(j,a){var f=this,i=j.el,g=i.getAttribute('class')||'',d,e,h,b,c;if(!Ext.isArray(a)){a=[a]}if(g){c=g.replace(f.trimRe,' ').split(f.spacesRe);for(d=0,h=a.length;d<h;d++){b=a[d];if(typeof b=='string'){b=b.replace(f.trimRe,'');e=Ext.Array.indexOf(c,b);if(e!=-1){Ext.Array.erase(c,e,1)}}}i.set({'class':c.join(' ')})}},destroy:function(){var a=this;photoViewer.draw.Surface.prototype.destroy.call(this);if(a.el){a.el.destroy()}if(a._defs){Ext.get(a._defs).destroy()}if(a.bgRect){Ext.get(a.bgRect).destroy()}if(a.webkitRect){Ext.get(a.webkitRect).destroy()}delete a.el}},0,0,0,0,0,0,[photoViewer.draw.engine,'Svg'],0);Ext.cmd.derive('photoViewer.draw.engine.SvgExporter',Ext.Base,function(){var k=/,/g,i=/(-?\d*\.?\d*){1}(em|ex|px|in|cm|mm|pt|pc|%)\s('*.*'*)/,g=/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/g,f=/rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,([\d\.]+)\)/g,a,m,e,d,l=function(b){a=b;m=a.length;e=a.width;d=a.height},c={path:function(f){var a=f.attr,c=a.path,d='',g,e,h;if(Ext.isArray(c[0])){h=c.length;for(e=0;e<h;e++){d+=c[e].join(' ')}}else {if(Ext.isArray(c)){d=c.join(' ')}else {d=c.replace(k,' ')}}g=b({d:d,fill:a.fill||'none',stroke:a.stroke,'fill-opacity':a.opacity,'stroke-width':a['stroke-width'],'stroke-opacity':a['stroke-opacity'],'z-index':a.zIndex,transform:f.matrix.toSvg()});return '<path '+g+'/>'},text:function(e){var a=e.attr,d=i.exec(a.font),g=d&&d[1]||'12',j=d&&d[3]||'Arial',k=a.text,h=Ext.isFF3_0||Ext.isFF3_5?2:4,c='',f;e.getBBox();c+='<tspan x="'+(a.x||'')+'" dy="';c+=g/h+'">';c+=Ext.htmlEncode(k)+'</tspan>';f=b({x:a.x,y:a.y,'font-size':g,'font-family':j,'font-weight':a['font-weight'],'text-anchor':a['text-anchor'],fill:a.fill||'#000','fill-opacity':a.opacity,transform:e.matrix.toSvg()});return '<text '+f+'>'+c+'</text>'},rect:function(c){var a=c.attr,d=b({x:a.x,y:a.y,rx:a.rx,ry:a.ry,width:a.width,height:a.height,fill:a.fill||'none','fill-opacity':a.opacity,stroke:a.stroke,'stroke-opacity':a['stroke-opacity'],'stroke-width':a['stroke-width'],transform:c.matrix&&c.matrix.toSvg()});return '<rect '+d+'/>'},circle:function(c){var a=c.attr,d=b({cx:a.x,cy:a.y,r:a.radius,fill:a.translation.fill||a.fill||'none','fill-opacity':a.opacity,stroke:a.stroke,'stroke-opacity':a['stroke-opacity'],'stroke-width':a['stroke-width'],transform:c.matrix.toSvg()});return '<circle '+d+' />'},image:function(c){var a=c.attr,d=b({x:a.x-(a.width/2>>0),y:a.y-(a.height/2>>0),width:a.width,height:a.height,'xlink:href':a.src,transform:c.matrix.toSvg()});return '<image '+d+' />'}},j=function(){var a='<?xml version="1.0" standalone="yes"?>';a+='<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';return a},h=function(){var k='<svg width="'+e+'px" height="'+d+'px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">',j='',p,n,i,x,q,r,t,o,s,z,l,A,u,B,b,C,y,m,v,w;i=a.items.items;n=i.length;q=function(k){var i=k.childNodes,j=i.length,g=0,h,c,a='',b,f,e,d;for(;g<j;g++){b=i[g];f=b.attributes;e=b.tagName;a+='<'+e;for(c=0,h=f.length;c<h;c++){d=f.item(c);a+=' '+d.name+'="'+d.value+'"'}a+='>';if(b.childNodes.length>0){a+=q(b)}a+='</'+e+'>'}return a};if(a.getDefs){j=q(a.getDefs())}else {o=a.gradientsColl;if(o){s=o.keys;z=o.items;l=0;A=s.length}for(;l<A;l++){u=s[l];B=z[l];x=a.gradientsColl.getByKey(u);j+='<linearGradient id="'+u+'" x1="0" y1="0" x2="1" y2="1">';var h=x.colors.replace(g,'rgb($1|$2|$3)');h=h.replace(f,'rgba($1|$2|$3|$4)');r=h.split(',');for(b=0,y=r.length;b<y;b++){t=r[b].split(' ');h=photoViewer.draw.Color.fromString(t[1].replace(/\|/g,','));j+='<stop offset="'+t[0]+'" stop-color="'+h.toString()+'" stop-opacity="1"></stop>'}j+='</linearGradient>'}}k+='<defs>'+j+'</defs>';k+=c.rect({attr:{width:'100%',height:'100%',fill:'#fff',stroke:'none',opacity:'0'}});m=new Array(n);for(b=0;b<n;b++){m[b]=b}m.sort(function(a,b){v=i[a].attr.zIndex||0;w=i[b].attr.zIndex||0;if(v==w){return a-b}return v-w});for(b=0;b<n;b++){p=i[m[b]];if(!p.attr.hidden){k+=c[p.type](p)}}k+='</svg>';return k},b=function(b){var c='',a;for(a in b){if(b.hasOwnProperty(a)&&b[a]!=null){c+=a+'="'+b[a]+'" '}}return c};return {singleton:!0,generate:function(b,a){a=a||{};l(b);return j()+h()}}},0,0,0,0,0,0,[photoViewer.draw.engine,'SvgExporter'],0);Ext.cmd.derive('photoViewer.draw.engine.Vml',photoViewer.draw.Surface,{engine:'Vml',map:{M:'m',L:'l',C:'c',Z:'x',m:'t',l:'r',c:'v',z:'x'},bitesRe:/([clmz]),?([^clmz]*)/gi,valRe:/-?[^,\s\-]+/g,fillUrlRe:/^url\(\s*['"]?([^\)]+?)['"]?\s*\)$/i,pathlike:/^(path|rect)$/,NonVmlPathRe:/[ahqstv]/ig,partialPathRe:/[clmz]/g,fontFamilyRe:/^['"]+|['"]+$/g,baseVmlCls:'x-vml-base',vmlGroupCls:'x-vml-group',spriteCls:'x-vml-sprite',measureSpanCls:'x-vml-measure-span',zoom:21600,coordsize:1000,coordorigin:'0 0',zIndexShift:0,orderSpritesByZIndex:!1,path2vml:function(f){var a=this,m=a.NonVmlPathRe,k=a.map,p=a.valRe,o=a.zoom,n=a.bitesRe,j=Ext.Function.bind(photoViewer.draw.Draw.pathToAbsolute,photoViewer.draw.Draw),b,g,i,e,c,l,d,h;if(String(f).match(m)){j=Ext.Function.bind(photoViewer.draw.Draw.path2curve,photoViewer.draw.Draw)}else {if(!String(f).match(a.partialPathRe)){b=String(f).replace(n,function(g,b,e){var a=[],d=b.toLowerCase()=='m',c=k[b];e.replace(p,function(h){if(d&&a.length===2){c+=a+k[b=='m'?'l':'L'];a=[]}a.push(Math.round(h*o))});return c+a});return b}}g=j(f);b=[];for(c=0,l=g.length;c<l;c++){i=g[c];e=g[c][0].toLowerCase();if(e=='z'){e='x'}for(d=1,h=i.length;d<h;d++){e+=Math.round(i[d]*a.zoom)+(d!=h-1?',':'')}b.push(e)}return b.join(' ')},translateAttrs:{radius:'r',radiusX:'rx',radiusY:'ry',lineWidth:'stroke-width',fillOpacity:'fill-opacity',strokeOpacity:'stroke-opacity',strokeLinejoin:'stroke-linejoin'},minDefaults:{circle:{fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},ellipse:{cx:0,cy:0,rx:0,ry:0,fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},rect:{x:0,y:0,width:0,height:0,rx:0,ry:0,fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},text:{x:0,y:0,'text-anchor':'start',font:'10px "Arial"',fill:'#000',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},path:{d:'M0,0',fill:'none',stroke:null,'stroke-width':null,opacity:null,'fill-opacity':null,'stroke-opacity':null},image:{x:0,y:0,width:0,height:0,preserveAspectRatio:'none',opacity:null}},onMouseEnter:function(a){this.fireEvent('mouseenter',a)},onMouseLeave:function(a){this.fireEvent('mouseleave',a)},processEvent:function(c,b){var d=b.getTarget(),a;this.fireEvent(c,b);a=this.items.get(d.id);if(a){a.fireEvent(c,a,b)}},createSpriteElement:function(a){var c=this,j=a.attr,g=a.type,h=c.zoom,i=a.vml||(a.vml={}),b=g==='image'?c.createNode('image'):c.createNode('shape'),f,d,e;b.coordsize=h+' '+h;b.coordorigin=j.coordorigin||'0 0';Ext.get(b).addCls(c.spriteCls);if(g=='text'){i.path=f=c.createNode('path');f.textpathok=!0;i.textpath=e=c.createNode('textpath');e.on=!0;b.appendChild(e);b.appendChild(f)}b.id=a.id;a.el=Ext.get(b);a.el.setStyle('zIndex',-c.zIndexShift);c.el.appendChild(b);if(g!=='image'){d=c.createNode('skew');d.on=!0;b.appendChild(d);a.skew=d}a.matrix=new photoViewer.draw.Matrix();a.bbox={plain:null,transform:null};this.applyAttrs(a);this.applyTransformations(a);a.fireEvent('render',a);return a.el},getBBoxText:function(b){var a=b.vml;return {x:a.X+(a.bbx||0)-a.W/2,y:a.Y-a.H/2,width:a.W,height:a.H}},applyAttrs:function(b){var c=this,e=b.group,o=b.attr,k=b.el,d=k.dom,i,h,g,n,a,f,j,l,m;if(e){h=[].concat(e);n=h.length;for(g=0;g<n;g++){e=h[g];c.getGroup(e).add(b)}delete b.group}a=c.scrubAttrs(b)||{};if(b.zIndexDirty){c.setZIndex(b)}Ext.applyIf(a,c.minDefaults[b.type]);if(b.type=='image'){Ext.apply(b.attr,{x:a.x,y:a.y,width:a.width,height:a.height});k.setStyle({width:a.width+'px',height:a.height+'px'});d.src=a.src}if(d.href){d.href=a.href}if(d.title){d.title=a.title}if(d.target){d.target=a.target}if(d.cursor){d.cursor=a.cursor}if(b.dirtyHidden){a.hidden?c.hidePrim(b):c.showPrim(b);b.dirtyHidden=!1}if(b.dirtyPath){if(b.type=='circle'||b.type=='ellipse'){f=a.x;j=a.y;l=a.rx||a.r||0;m=a.ry||a.r||0;d.path=Ext.String.format('ar{0},{1},{2},{3},{4},{1},{4},{1}',Math.round((f-l)*c.zoom),Math.round((j-m)*c.zoom),Math.round((f+l)*c.zoom),Math.round((j+m)*c.zoom),Math.round(f*c.zoom));b.dirtyPath=!1}else {b.attr.path=a.path=c.setPaths(b,a)||a.path;d.path=c.path2vml(a.path);b.dirtyPath=!1}}if('clip-rect' in a){c.setClip(b,a)}if(b.type=='text'){c.setTextAttributes(b,a)}if(a.opacity||a['stroke-opacity']||a.fill){c.setFill(b,a)}if(a.stroke||a['stroke-opacity']||a.fill){c.setStroke(b,a)}i=o.style;if(i){k.setStyle(i)}b.dirty=!1},setZIndex:function(e){var h=this,c=e.attr.zIndex,b=h.zIndexShift,f,g,d,a;if(c<b){f=h.items.items;g=f.length;for(a=0;a<g;a++){if((c=f[a].attr.zIndex)&&c<b){b=c}}h.zIndexShift=b;for(a=0;a<g;a++){d=f[a];if(d.el){d.el.setStyle('zIndex',d.attr.zIndex-b)}d.zIndexDirty=!1}}else {if(e.el){e.el.setStyle('zIndex',c-b);e.zIndexDirty=!1}}},setPaths:function(a,c){var b=a.attr;a.bbox.plain=null;a.bbox.transform=null;if(a.type=='circle'){b.rx=b.ry=c.r;return photoViewer.draw.Draw.ellipsePath(a)}else {if(a.type=='ellipse'){b.rx=c.rx;b.ry=c.ry;return photoViewer.draw.Draw.ellipsePath(a)}else {if(a.type=='rect'){b.rx=b.ry=c.r;return photoViewer.draw.Draw.rectPath(a)}else {if(a.type=='path'&&b.path){return photoViewer.draw.Draw.pathToAbsolute(b.path)}}}}return !1},setFill:function(j,b){var h=this,g=j.el.dom,a=g.fill,i=!1,d,c,f,e;if(!a){a=g.fill=h.createNode('fill');i=!0}if(Ext.isArray(b.fill)){b.fill=b.fill[0]}if(b.fill=='none'){a.on=!1}else {if(typeof b.opacity=='number'){a.opacity=b.opacity}if(typeof b['fill-opacity']=='number'){a.opacity=b['fill-opacity']}a.on=!0;if(typeof b.fill=='string'){c=b.fill.match(h.fillUrlRe);if(c){c=c[1];if(c.charAt(0)=='#'){d=h.gradientsColl.getByKey(c.substring(1))}if(d){f=b.rotation;e=-(d.angle+270+(f?f.degrees:0))%360;if(e===0){e=180}a.angle=e;a.type='gradient';a.method='sigma';if(a.colors){a.colors.value=d.colors}else {a.colors=d.colors}}else {a.src=c;a.type='tile'}}else {a.color=photoViewer.draw.Color.toHex(b.fill);a.src='';a.type='solid'}}}if(i){g.appendChild(a)}},setStroke:function(e,a){var g=this,h=e.el.dom,b=e.strokeEl,f=!1,c,d;if(!b){b=e.strokeEl=g.createNode('stroke');f=!0}if(Ext.isArray(a.stroke)){a.stroke=a.stroke[0]}if(!a.stroke||a.stroke=='none'||a.stroke==0||a['stroke-width']==0){b.on=!1}else {b.on=!0;if(a.stroke&&!a.stroke.match(g.fillUrlRe)){b.color=photoViewer.draw.Color.toHex(a.stroke)}b.dashstyle=a['stroke-dasharray']?'dash':'solid';b.joinstyle=a['stroke-linejoin'];b.endcap=a['stroke-linecap']||'round';b.miterlimit=a['stroke-miterlimit']||8;c=parseFloat(a['stroke-width']||1)*0.75;d=a['stroke-opacity']||1;if(Ext.isNumber(c)&&c<1){b.weight=1;b.opacity=d*c}else {b.weight=c;b.opacity=d}}if(f){h.appendChild(b)}},setClip:function(d,e){var c=this,b=d.clipEl,a=String(e['clip-rect']).split(c.separatorRe);if(!b){b=d.clipEl=c.el.insertFirst(Ext.getDoc().dom.createElement('div'));b.addCls('x-vml-sprite')}if(a.length==4){a[2]=+a[2]+ +a[0];a[3]=+a[3]+ +a[1];b.setStyle('clip',Ext.String.format('rect({1}px {2}px {3}px {0}px)',a[0],a[1],a[2],a[3]));b.setSize(c.el.width,c.el.height)}else {b.setStyle('clip','')}},setTextAttributes:function(e,b){var c=this,a=e.vml,d=a.textpath.style,g=c.span.style,i=c.zoom,j={fontSize:'font-size',fontWeight:'font-weight',fontStyle:'font-style'},f,h;if(e.dirtyFont){if(b.font){d.font=g.font=b.font}if(b['font-family']){d.fontFamily='"'+b['font-family'].split(',')[0].replace(c.fontFamilyRe,'')+'"';g.fontFamily=b['font-family']}for(f in j){h=b[j[f]];if(h){d[f]=g[f]=h}}c.setText(e,b.text);if(a.textpath.string){c.span.innerHTML=String(a.textpath.string).replace(/</g,'&#60;').replace(/&/g,'&#38;').replace(/\n/g,'<br/>')}a.W=c.span.offsetWidth;a.H=c.span.offsetHeight+2;if(b['text-anchor']=='middle'){d['v-text-align']='center'}else {if(b['text-anchor']=='end'){d['v-text-align']='right';a.bbx=-Math.round(a.W/2)}else {d['v-text-align']='left';a.bbx=Math.round(a.W/2)}}}a.X=b.x;a.Y=b.y;a.path.v=Ext.String.format('m{0},{1}l{2},{1}',Math.round(a.X*i),Math.round(a.Y*i),Math.round(a.X*i)+1);e.bbox.plain=null;e.bbox.transform=null;e.dirtyFont=!1},setText:function(a,b){a.vml.textpath.string=Ext.htmlDecode(b)},hide:function(){this.el.hide()},show:function(){this.el.show()},hidePrim:function(a){a.el.addCls('x-hide-visibility')},showPrim:function(a){a.el.removeCls('x-hide-visibility')},setSize:function(c,b){var a=this;c=c||a.width;b=b||a.height;a.width=c;a.height=b;if(a.el){if(c!=undefined){a.el.setWidth(c)}if(b!=undefined){a.el.setHeight(b)}}photoViewer.draw.Surface.prototype.setSize.apply(this,arguments)},applyViewBox:function(){var a=this,e=a.viewBox,g=a.width,f=a.height,c,d,b;photoViewer.draw.Surface.prototype.applyViewBox.call(this);if(e&&(g||f)){c=a.items.items;d=c.length;for(b=0;b<d;b++){a.applyTransformations(c[b])}}},onAdd:function(a){photoViewer.draw.Surface.prototype.onAdd.apply(this,arguments);if(this.el){this.renderItem(a)}},onRemove:function(a){if(a.el){a.el.destroy();delete a.el}photoViewer.draw.Surface.prototype.onRemove.apply(this,arguments)},render:function(d){var a=this,b=Ext.getDoc().dom,c;if(!a.createNode){try{if(!b.namespaces.rvml){b.namespaces.add('rvml','urn:schemas-microsoft-com:vml')}a.createNode=function(a){return b.createElement('<rvml:'+a+' class="rvml">')}}catch(e){a.createNode=function(a){return b.createElement('<'+a+' xmlns="urn:schemas-microsoft.com:vml" class="rvml">')}}}if(!a.el){c=b.createElement('div');a.el=Ext.get(c);a.el.addCls(a.baseVmlCls);a.span=b.createElement('span');Ext.get(a.span).addCls(a.measureSpanCls);c.appendChild(a.span);a.el.setSize(a.width||0,a.height||0);d.appendChild(c);a.el.on({scope:a,mouseup:a.onMouseUp,mousedown:a.onMouseDown,mouseover:a.onMouseOver,mouseout:a.onMouseOut,mousemove:a.onMouseMove,mouseenter:a.onMouseEnter,mouseleave:a.onMouseLeave,click:a.onClick,dblclick:a.onDblClick})}a.renderAll()},renderAll:function(){this.items.each(this.renderItem,this)},redraw:function(a){a.dirty=!0;this.renderItem(a)},renderItem:function(a){if(!this.el){return}if(!a.el){this.createSpriteElement(a)}if(a.dirty){this.applyAttrs(a);if(a.dirtyTransform){this.applyTransformations(a)}}},rotationCompensation:function(d,b,c){var a=new photoViewer.draw.Matrix();a.rotate(-d,0.5,0.5);return {x:a.x(b,c),y:a.y(b,c)}},transform:function(f,q){var l=this,a=l.getBBox(f,!0),b=new photoViewer.draw.Matrix(),k=f.transformations,m=k.length,j=0,n=0,o=1,p=1,s=f.el,r=s.dom,i=r.style,g=f.skew,e=l.viewBoxShift,c,h,d;for(;j<m;j++){c=k[j];h=c.type;if(h=='translate'){b.translate(c.x,c.y)}else {if(h=='rotate'){b.rotate(c.degrees,c.x,c.y);n+=c.degrees}else {if(h=='scale'){b.scale(c.x,c.y,c.centerX,c.centerY);o*=c.x;p*=c.y}}}}f.matrix=b.clone();if(q){return}if(e){b.prepend(e.scale,0,0,e.scale,e.dx*e.scale,e.dy*e.scale)}if(f.type!='image'&&g){g.origin='0,0';g.matrix=b.toString();d=b.offset();if(d[0]>32767){d[0]=32767}else {if(d[0]<-32768){d[0]=-32768}}if(d[1]>32767){d[1]=32767}else {if(d[1]<-32768){d[1]=-32768}}g.offset=d}else {i.filter=b.toFilter();i.left=Math.min(b.x(a.x,a.y),b.x(a.x+a.width,a.y),b.x(a.x,a.y+a.height),b.x(a.x+a.width,a.y+a.height))+'px';i.top=Math.min(b.y(a.x,a.y),b.y(a.x+a.width,a.y),b.y(a.x,a.y+a.height),b.y(a.x+a.width,a.y+a.height))+'px'}},createItem:function(a){return Ext.create('photoViewer.draw.Sprite',a)},getRegion:function(){return this.el.getRegion()},addCls:function(a,b){if(a&&a.el){a.el.addCls(b)}},removeCls:function(a,b){if(a&&a.el){a.el.removeCls(b)}},addGradient:function(c){var j=this.gradientsColl||(this.gradientsColl=Ext.create('Ext.util.MixedCollection')),e=[],b=Ext.create('Ext.util.MixedCollection'),d,f,g,i,h,a;b.addAll(c.stops);b.sortByKey('ASC',function(a,b){a=parseInt(a,10);b=parseInt(b,10);return a>b?1:a<b?-1:0});d=b.keys;f=b.items;g=d.length;for(a=0;a<g;a++){i=d[a];h=f[a];e.push(i+'% '+h.color)}j.add(c.id,{colors:e.join(','),angle:c.angle})},destroy:function(){var a=this;photoViewer.draw.Surface.prototype.destroy.apply(this,arguments);if(a.el){a.el.destroy()}delete a.el}},0,0,0,0,0,0,[photoViewer.draw.engine,'Vml'],0);Ext.cmd.derive('photoViewer.view.addphotostoalbum.AddPhotosToAlbumController',Ext.app.ViewController,{onExistingAlbumClick:function(){var a=this.getView().getSelectedAlbumUIDs();if(a.length){this.lookupReference('addPhotosToAlbumNextAction').enable()}else {this.lookupReference('addPhotosToAlbumNextAction').disable()}this.getViewModel().set('selectedAlbumUIDs',a)},onAddPhotosToAlbumNextActionClick:function(){var a=this.getViewModel();if(a.get('albumChoice.createNewAlbum')){this.getToolbarActionsController().makeAlbum()}else {this.savePhotosToAlbums()}},savePhotosToAlbums:function(d){var c=this.getViewModel(),a=this.getView(),b=c.get('selectedAlbumUIDs');if(!d){this.getToolbarActionsController().savePhotosToAlbums(b,a,this.savePhotosToAlbums.bind(this));return}Ext.getBody().mask();a.setLoading(!0);Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoList.savePhotosToAlbums',params:{ProjectUID:c.get('ProjectUID'),albumUIDs:b.join(','),photos:d.join(',')},successCallback:function(b){this.afterAddPhotosToAlbum(b);Ext.Msg.alert(mvstr['PA_Photos added'],mvstr['PA_The photos were succe']);Ext.getBody().unmask();a.destroy()},afterFailMessageCallback:function(b){this.afterAddPhotosToAlbum(b);Ext.getBody().unmask();a.setLoading(!1)},scope:this})},afterAddPhotosToAlbum:function(b){if(!b){return}var d=this.getToolbarActionsController().interfaceControl;if(!d.afterAddPhotosToAlbum){return}for(var c=0;c<b.length;c++){var a=b[c],e=a.data.count?a.data.count:0;d.afterAddPhotosToAlbum(a.AlbumUID,e)}},getToolbarActionsController:function(){return app.getController('photoActions.controller.ToolbarActions')}},0,0,0,0,['controller.photovieweralbumadd'],0,[photoViewer.view.addphotostoalbum,'AddPhotosToAlbumController'],0);Ext.cmd.derive('photoViewer.view.addphotostoalbum.AddPhotosToAlbumModel',Ext.app.ViewModel,{data:{albumChoice:{createNewAlbum:!1},lastAlbumUIDChange:null},formulas:{actionDesc:function(a){return a('albumChoice.createNewAlbum')?mvstr['PUL_Name New Album']:mvstr['PUL_Choose Existing Album']},selectedAlbumUIDs:{get:function(d){if(!d('preferencesReady')){return null}var f=d('lastAlbumUIDChange'),a=mdsPreferences.ProjectPreferences.getAlbumUIDArray(),b=[],e=this.getView().store;for(var c=0;c<a.length;c++){if(e.getById(a[c])){b.push(a[c])}}if(b.length!=a.length){mdsPreferences.ProjectPreferences.setAlbumUIDArray(b)}return b},set:function(a){mdsPreferences.ProjectPreferences.setAlbumUIDArray(a);this.set('lastAlbumUIDChange',(new Date()).getTime())}},nextButtonEnabled:function(a){var b=a('albumChoice.createNewAlbum'),c=a('selectedAlbumUIDs');return !!(b||c.length)}}},0,0,0,0,['viewmodel.photovieweralbumadd'],0,[photoViewer.view.addphotostoalbum,'AddPhotosToAlbumModel'],0);Ext.cmd.derive('photoViewer.view.addphotostoalbum.AddPhotosToAlbum',Ext.window.Window,{config:{store:null,loadMaskCls:'light-load-indicator'},ui:'orange',width:490,height:390,padding:'23 27 23 27',bind:{selectedAlbumUIDs:'{selectedAlbumUIDs}'},viewModel:{type:'photovieweralbumadd'},controller:'photovieweralbumadd',localized:{title:'PUL_Add Photos To Album'},layout:{type:'vbox',align:'stretch'},modal:!0,modalMaskCls:'dark-mask',alwaysOnTop:2,constructor:function(a){var b=[],c=!a.store.getCount();a.store.each(function(c){b.push({xtype:'checkboxfield',ui:'plain-16',boxLabel:c.get('AlbumName'),listeners:{change:'onExistingAlbumClick'}})});a.items=[{xtype:'component',cls:'instructions',localized:{html:'PUL_Choose from the field'},margin:'0 0 23 0'},{xtype:'radiogroup',layout:'hbox',bind:{value:'{albumChoice}'},defaults:{name:'createNewAlbum',ui:'plain-radio-16',width:'50%'},items:[{localized:{boxLabel:'PUL_Add to Existing Album'},inputValue:!1,disabled:c},{localized:{boxLabel:'PUL_Create New Album'},inputValue:!0}]},{xtype:'component',bind:{html:'{actionDesc}'},margin:'18 0 7 0'},{xtype:'checkboxgroup',width:'100%',height:126,columns:2,cls:'album-list',scrollable:!0,reference:'existingAlbums',itemId:'existingAlbums',items:b,bind:{hidden:'{albumChoice.createNewAlbum}'}},{xtype:'detailformtextfield',width:436,bind:{hidden:'{!albumChoice.createNewAlbum}'},id:'newAlbumName',itemId:'albumName',localized:{emptyText:'PUL_Enter new album name',fieldLabel:'PUL_Album Name'},allowBlank:!1,maxLength:255,enforceMaxLength:!0},{xtype:'component',flex:1},{xtype:'container',layout:{type:'hbox',pack:'middle'},items:[{xtype:'button',scale:'medium',margin:'0 12 0 12',ui:'grey',localized:{text:'G_Cancel'},listeners:{click:function(){this.up('window').destroy()}}},{xtype:'button',reference:'addPhotosToAlbumNextAction',ui:'green',scale:'medium',margin:'0 12 0 12',localized:{text:'G_Save'},bind:{disabled:'{!nextButtonEnabled}'},listeners:{click:'onAddPhotosToAlbumNextActionClick'}}]}];Ext.window.Window.prototype.constructor.apply(this,arguments);this.getViewModel().set('albumChoice.createNewAlbum',c)},getSelectedAlbumUIDs:function(){var d=this.lookupReference('existingAlbums'),e=this.getStore().getRange(),b=d.query('checkboxfield'),c=[];for(var a=0;a<b.length;a++){if(b[a].getValue()){c.push(e[a].get('AlbumUID'))}}return c},setSelectedAlbumUIDs:function(c){var d=this.lookupReference('existingAlbums'),e=this.getStore().getRange(),b=d.query('checkboxfield');for(var a=0;a<b.length;a++){b[a].setValue(Ext.Array.contains(c,e[a].get('AlbumUID')))}}},1,['photovieweralbumadd'],['component','box','container','panel','window','photovieweralbumadd'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'photovieweralbumadd':!0},['widget.photovieweralbumadd'],0,[photoViewer.view.addphotostoalbum,'AddPhotosToAlbum'],0);Ext.cmd.derive('photoViewer.view.annotations.sprites.Line',photoViewer.draw.Sprite,{constructor:function(a){this.initConfig(a);photoViewer.draw.Sprite.prototype.constructor.apply(this,arguments)},initConfig:function(a){this.x0=a.x0-0;this.y0=a.y0-0;this.x1=a.x1-0;this.y1=a.y1-0;a.type='path',a.path=this.makePath();this.callParent(arguments)},makePath:function(){path=['M',this.x0,this.y0,'L',this.x1,this.y1,'Z'];return path.join(' ')},setAttributes:function(a,c){var b=!1;if(a.x0!==undefined){this.x0=a.x0;delete a.x0;b=!0}if(a.y0!==undefined){this.y0=a.y0;delete a.y0;b=!0}if(a.x1!==undefined){this.x1=a.x1;delete a.x1;b=!0}if(a.y1!==undefined){this.y1=a.y1;delete a.y1;b=!0}if(b){a.path=this.makePath()}photoViewer.draw.Sprite.prototype.setAttributes.apply(this,arguments)}},1,0,0,0,0,0,[photoViewer.view.annotations.sprites,'Line'],0);Ext.cmd.derive('photoViewer.view.annotations.sprites.Arrow',photoViewer.view.annotations.sprites.Line,{initConfig:function(a){this.strokeWidth=a['stroke-width'];photoViewer.view.annotations.sprites.Line.prototype.initConfig.apply(this,arguments)},makePath:function(){var j=this.strokeWidth===undefined?this.attr['stroke-width']:this.strokeWidth;var d=Math.getLineAngle([this.x0,this.y0],[this.x1,this.y1]);var b=Math.sqrt(Math.pow(this.y0-this.y1,2)+Math.pow(this.x0-this.x1,2));var a=j*(this.fill?5:10);var h=a/2;var i=Math.max(0,b-a);var e=Math.getRotatedPoint([this.x0,this.y0],[this.x0+b-a-i,this.y0],d);var c=Math.getRotatedPoint([this.x0,this.y0],[this.x0+b-a,this.y0],d);var f=Math.getRotatedPoint([this.x0,this.y0],[this.x0+b-a,this.y0-h/2],d);var g=Math.getRotatedPoint([this.x0,this.y0],[this.x0+b-a,this.y0+h/2],d);var k=['M',e[0],e[1],'L',c[0],c[1],'L',f[0],f[1],'L',this.x1,this.y1,'L',g[0],g[1],'L',c[0],c[1],'Z'];return k.join(' ')},setAttributes:function(a,b){if(a['stroke-width']!=undefined){this.strokeWidth=a['stroke-width'];if(a.x0===undefined){a.x0=this.x0}if(a.y0===undefined){a.y0=this.y0}if(a.x1===undefined){a.x1=this.x1}if(a.y1===undefined){a.y1=this.y1}}photoViewer.view.annotations.sprites.Line.prototype.setAttributes.apply(this,arguments)}},0,0,0,0,0,0,[photoViewer.view.annotations.sprites,'Arrow'],0);Ext.cmd.derive('photoViewer.view.annotations.sprites.pointHandle',photoViewer.draw.Sprite,{bboxExcluded:!0,draggable:!0,config:{type:'ellipse',fill:'white',stroke:'black',radiusX:4,radiusY:4},constructor:function(a){this.initConfig(a);photoViewer.draw.Sprite.prototype.constructor.apply(this,arguments);this.addListener('mouseover',function(){this.setStyle('cursor','pointer')},this,{single:!0})},initConfig:function(a){var b=a.drawComponent.getScale();a.type='ellipse';a.fill='white';a.stroke='black';a.radiusX=Math.max(4/b,4);a.radiusY=Math.max(4/b,4);this.callParent(arguments)}},1,0,0,0,0,0,[photoViewer.view.annotations.sprites,'pointHandle'],0);Ext.cmd.derive('photoViewer.view.annotations.sprites.resizeHandle',photoViewer.draw.Sprite,{draggable:!0,bboxExcluded:!0,invertX:!1,invertY:!1,constructor:function(a){this.initConfig(a);photoViewer.draw.Sprite.prototype.constructor.apply(this,arguments);this.addListener('mouseover',function(){var b=['n-resize','ne-resize','e-resize','se-resize','s-resize','sw-resize','w-resize','nw-resize'];this.setStyle('cursor',b[this.position])},this,{single:!0})},initConfig:function(a){var c=this.getPositionXY(a.position,a.boundingBox,a.drawComponent),d=a.drawComponent.getScale(),b=this.getHandleWidth(d);a.x=c[0];a.y=c[1];a.width=b;a.height=b;delete a.boundingBox;a.type='rect';a.stroke='black';a.fill='white';a['stroke-width']=1;this.callParent(arguments)},getPositionXY:function(d,g,h){if(!h){h=this.drawComponent}var b=g.x,c=g.y,f=g.width,e=g.height,a=this.getHandleWidth(h.getScale());if(d===0){return [b+f/2-a/2,c-a/2]}else {if(d==1){return [b+f-a/2,c-a/2]}else {if(d==2){return [b+f-a/2,c+e/2-a/2]}else {if(d==3){return [b+f-a/2,c+e-a/2]}else {if(d==4){return [b+f/2-a/2,c+e-a/2]}else {if(d==5){return [b-a/2,c+e-a/2]}else {if(d==6){return [b-a/2,c+e/2-a/2]}else {return [b-a/2,c-a/2]}}}}}}}},refreshPosition:function(d){var b=this.getPositionXY(this.position,d),c=this.drawComponent.getScale(),a=this.getHandleWidth(c);this.setAttributes({width:a,height:a,x:b[0],y:b[1]},!0);this.show(!0)},getPosition:function(b){var c=b.getByKey('resizeHandle'+(this.position+4)%8);var d=b.getByKey('resizeHandle'+(this.position+2)%8);var e=b.getByKey('resizeHandle'+(this.position+6)%8);xPositions=[this.getBBox().x,c.getBBox().x,d.getBBox().x,e.getBBox().x];yPositions=[this.getBBox().y,c.getBBox().y,d.getBBox().y,e.getBBox().y];if(this.position===0||this.position===4){if(yPositions[0]===yPositions[1]){return this.position}if(yPositions[0]<yPositions[1]){return 0}return 4}if(this.position===6||this.position===2){if(xPositions[0]===xPositions[1]){return this.position}if(xPositions[0]<xPositions[1]){return 6}return 2}for(var a=1;a<4;a++){if(xPositions[a]==xPositions[0]&&yPositions[a]==yPositions[0]){return this.position}}var i=Ext.Array.min(xPositions),g=Ext.Array.max(xPositions),h=Ext.Array.min(yPositions),f=Ext.Array.max(yPositions);if(xPositions[0]==g&&yPositions[0]==h){return 1}if(xPositions[0]==g&&yPositions[0]==f){return 3}if(xPositions[0]==i&&yPositions[0]==f){return 5}if(xPositions[0]==i&&yPositions[0]==h){return 7}},getHandleWidth:function(a){return Math.max(7/a,4)}},1,0,0,0,0,0,[photoViewer.view.annotations.sprites,'resizeHandle'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Base',photoViewer.draw.CompositeSprite,{statics:{HANDLE_POS:{RHS:[1,2,3],LHS:[5,6,7],TOP:[0,1,7],BOTTOM:[3,4,5]}},shapeAttributes:[],dataAttributes:[],nBaseSprites:1,isSelected:!1,constructor:function(a){if(!a&&this.myConfig){a=this.myConfig}this.drawComponent=a.drawComponent;if(typeof a=='undefined'||a.isNew){a=this.getDefaultConfig()}this.surface=this.drawComponent.surface;photoViewer.draw.CompositeSprite.prototype.constructor.apply(this,arguments);if(typeof a.model!=='undefined'){var c=a.model;this.record=c;a={};for(var b=0;b<this.shapeAttributes.length;b++){a[this.shapeAttributes[b]]=c.get('Attr'+b)}this.readOnly=c.get('ReadOnly')||this.drawComponent.getReadOnly()}this.initConfig(a)},initConfig:function(a){if(!a){return}this.callParent(arguments)},add:function(c,a){var b=this;photoViewer.draw.CompositeSprite.prototype.add.apply(this,arguments);b.surface.add(a);a.show(!0);if(c.indexOf('base')!=-1){if(!this.readOnly){a.addListener('click',this.onClick,this)}}if(this.readOnly){return}if(a.dd&&c.indexOf('resizeHandle')!=-1){Ext.override(a.dd,{onDrag:function(d){b.resizeShapeOnDragHandle(a.dd,a,d)},onMouseUp:function(d){b.onDragHandleMouseUp(a.dd,a,d)}})}else {if(a.dd&&c.indexOf('pointHandle')!=-1){Ext.override(a.dd,{onDrag:function(d){b.changePointOnDragHandle(a.dd,a,d)}})}else {if(a.dd!==undefined){Ext.override(a.dd,{onDrag:function(d){b.spriteGroupMove(a.dd,a,d)}})}}}a.drawComponent=this.drawComponent},removeByKey:function(b){var a=this.getByKey(b);if(!a){return}this.removeAtKey(b);this.surface.remove(a,!0)},onRemove:function(){},select:function(){var a=this.getViewModel(),b=a.get('drawMode')==photoViewer.Values.DRAW_OFF;if(this.isSelected||a.get('toolSettings.mode')!='select'){return}this.drawComponent.getController().deselectAll(this);this.isSelected=!0;if(!b&&!this.readOnly){this.refreshSelectionSprites();this.drawComponent.getController().onShapeSelect(this)}},onClick:function(){if(!this.drawComponent.up('photoviewer').lookupController().beforeDrawableSelectionChange(this.record)){return}var b=this.getViewModel(),c=b.get('drawMode')==photoViewer.Values.DRAW_OFF;if(this.isSelected||b.get('toolSettings.mode')!='select'){return}var a=this.drawComponent.getController().getSelectedShape();if(!c&&!this.readOnly){if(a&&!this.disableShapeSync){this.drawComponent.fireEvent('shapesync',this,a)}}this.getViewModel().set('selectedDrawing',this.record)},deselect:function(){var a=this.isSelected;this.isSelected=!1;this.removeSelectionSprites();if(a){this.drawComponent.getController().onShapeDeselect(this)}return a},refreshSelectionSprites:function(){var d=this.getByKey('resizeHandle0');var c=this.getBBox();if(!d){for(var a=0;a<8;a++){var e=Ext.create('photoViewer.view.annotations.sprites.resizeHandle',{boundingBox:c,position:a,drawComponent:this.drawComponent});this.add('resizeHandle'+a,e)}}else {for(var b=0;b<8;b++){this.getByKey('resizeHandle'+b).refreshPosition(c)}}},removeSelectionSprites:function(){for(var a=0;a<8;a++){var b=this.getByKey('resizeHandle'+a);if(b){b.hide(!0)}}},spriteGroupMove:function(f,c,j){this.drawComponent.getController().deselectAll(this);var e=j.getXY(),a=[0,0],k=this.drawComponent,g=k.getScale();var d=f.prev;if(d){a[0]=e[0]-d[0],a[1]=e[1]-d[1];d[0]=e[0];d[1]=e[1]}else {var b=f.getOffset();if(c.prevOffset){a[0]=b[0]-c.prevOffset[0],a[1]=b[1]-c.prevOffset[1];c.prevOffset=b}else {a=b;c.prevOffset=b}}a[0]=a[0]/g;a[1]=a[1]/g;var h=a[0]<0?!0:!1;var i=a[1]<0?!0:!1;this.adjustdxDYToStayInBounds(a,h,i);if(a[0]===0&&a[1]===0){return}this.translate(a[0],a[1]);this.refreshSelectionSprites();this.drawComponent.pendingDataChangeShape=this},translate:function(d,e){for(var c=0;c<this.nBaseSprites;c++){var b=this.getAt(c);var a={};a.x=b.attr.x+d;a.y=b.attr.y+e;b.setAttributes(a,!0)}},resizeShapeOnDragHandle:function(e,f,g){var a=g.getXY(),c=this.drawComponent.getScale(),b=this.drawComponent.getRegion(),d=[(a[0]-b.left)/c,(a[1]-b.top)/c];e.prev=a;this.resizeShape(d,f.getPosition(this))},getChangeWidth:function(a){return Ext.Array.contains([1,2,3,5,6,7],a)?!0:!1},getChangeHeight:function(a){return Ext.Array.contains([0,1,3,4,5,7],a)?!0:!1},getShiftPositionLeft:function(a){return Ext.Array.contains([0,4,5,6,7],a)?!0:!1},getShiftPositionUp:function(a){return Ext.Array.contains([0,1,2,6,7],a)?!0:!1},getCanResizeFlip:function(){return !0},resizeShape:function(e,a){var b=photoViewer.view.annotations.shapes.Base.HANDLE_POS,h=this.getRealLeft(),i=this.getRealTop(),d=this.getRealWidth(),c=this.getRealHeight(),f=this.getCanResizeFlip(),j=this.getType(),g='resize-shape-'+a;if(this.resizeCls!=g){if(this.resizeCls){this.drawComponent.up().el.removeCls(this.resizeCls)}this.drawComponent.up().el.addCls(g);this.resizeCls=g}if(j=='text'||j=='textbox'){e[0]=Math.max(0,Math.min(e[0],this.drawComponent.getNaturalWidth()));e[1]=Math.max(0,Math.min(e[1],this.drawComponent.getNaturalHeight()))}if(this.flipX){a={0:0,1:7,2:6,3:5,4:4,5:3,6:2,7:1}[a]}if(this.flipY){a={0:4,1:3,2:2,3:1,4:0,5:7,6:6,7:5}[a]}if(!this.anchorX&&(Ext.Array.contains(b.RHS,a)||Ext.Array.contains(b.LHS,a))){if(Ext.Array.contains(b.RHS,a)){this.anchorX=this.getRealLeft()}else {this.anchorX=this.getRealRight()}}if(!this.anchorY&&(Ext.Array.contains(b.TOP,a)||Ext.Array.contains(b.BOTTOM,a))){if(Ext.Array.contains(b.TOP,a)){this.anchorY=this.getRealBottom()}else {this.anchorY=this.getRealTop()}}if(Ext.Array.contains(b.RHS,a)){d=e[0]-this.anchorX;h=this.anchorX;if(!f){d=Math.max(d,this.getMinWidth())}}else {if(Ext.Array.contains(b.LHS,a)){d=this.anchorX-e[0];if(!f){d=Math.max(d,this.getMinWidth())}h=this.anchorX-d}}if(Ext.Array.contains(b.BOTTOM,a)){c=e[1]-this.anchorY;i=this.anchorY;if(!f){c=Math.max(c,this.getMinHeight())}}else {if(Ext.Array.contains(b.TOP,a)){c=this.anchorY-e[1];if(!f){c=Math.max(c,this.getMinHeight())}i=this.anchorY-c}}if(d<0||c<0){if(d<0){this.flipX=!this.flipX}if(c<0){this.flipY=!this.flipY}return}this.resize(h,i,d,c,this.getShiftPositionLeft(a),this.getShiftPositionUp(a));this.refreshSelectionSprites();this.drawComponent.pendingDataChangeShape=this},onDragHandleMouseUp:function(){delete this.flipX;delete this.flipY;delete this.anchorX;delete this.anchorY;this.refreshSelectionSprites();if(this.readOnly&&this.getType()=='text'){this.afterMove()}if(this.resizeCls){this.drawComponent.up().el.removeCls(this.resizeCls);delete this.resizeCls}},getWidth:function(){return this.getBaseShape().getBBox().width},getHeight:function(){return this.getBaseShape().getBBox().height},getRealWidth:function(){if(Ext.Array.contains(this.shapeAttributes,'width')){return this.getAttribute('width')}if(Ext.Array.contains(this.shapeAttributes,'radiusX')){return this.getAttribute('radiusX')*2}if(this.nBaseSprites==1&&typeof this.getAt(0).attr.width!='undefined'){return this.getAt(0).attr.width}return this.getBaseShape().getBBox().width},getRealHeight:function(){if(Ext.Array.contains(this.shapeAttributes,'height')){return this.getAttribute('height')}if(Ext.Array.contains(this.shapeAttributes,'radiusY')){return this.getAttribute('radiusY')*2}if(this.nBaseSprites==1&&typeof this.getAt(0).attr.height!='undefined'){return this.getAt(0).attr.height}return this.getBaseShape().getBBox().height},getRealLeft:function(){if(Ext.Array.contains(this.shapeAttributes,'x')){return this.getAttribute('x')}if(Ext.Array.contains(this.shapeAttributes,'x0')&&Ext.Array.contains(this.shapeAttributes,'x1')){return Math.min(this.getAttribute('x0'),this.getAttribute('x1'))}if(this.nBaseSprites==1&&typeof this.getAt(0).attr.x!='undefined'){return this.getAt(0).attr.x}return this.getBaseShape().getBBox().x},getRealRight:function(){if(Ext.Array.contains(this.shapeAttributes,'x0')&&Ext.Array.contains(this.shapeAttributes,'x1')){return Math.max(this.getAttribute('x0'),this.getAttribute('x1'))}return this.getRealLeft()+this.getRealWidth()},getRealTop:function(){if(Ext.Array.contains(this.shapeAttributes,'y')){return this.getAttribute('y')}if(Ext.Array.contains(this.shapeAttributes,'y0')&&Ext.Array.contains(this.shapeAttributes,'y1')){return Math.min(this.getAttribute('y0'),this.getAttribute('y1'))}if(this.nBaseSprites==1&&typeof this.getAt(0).attr.y!='undefined'){return this.getAt(0).attr.y}return this.getBaseShape().getBBox().y},getRealBottom:function(){if(Ext.Array.contains(this.shapeAttributes,'y0')&&Ext.Array.contains(this.shapeAttributes,'y1')){return Math.max(this.getAttribute('y0'),this.getAttribute('y1'))}return this.getRealTop()+this.getRealHeight()},isTooSmall:function(){return this.getWidth()<=10||this.getHeight()<=10?!0:!1},setColour:function(b){for(var a=0;a<this.nBaseSprites;a++){var c=this.getAt(a);c.setAttributes({stroke:b},!0)}this.drawComponent.lookupViewModel().set('toolSettings.strokeColour',b);this.fireEvent('datachanged')},getType:function(){return this.getAt(0).type},getAttribute:function(a){var d=this.getAt(0);var b=d.attr;if(!b){b=d}var c=b[a];if(a=='width'||a=='height'||a=='x'||a=='y'||a=='radiusX'||a=='radiusY'){c=Math.round(c)}else {if(a=='style'){for(var e in this.drawComponent.self.styleSettings){if(b['stroke-dasharray']==this.drawComponent.self.styleSettings[e]){return e}}}}return c},adjustdxDYToStayInBounds:function(a,f,g){var e=this.getRealTop(),c=this.getRealRight(),b=this.getRealBottom(),d=this.getRealLeft();var h=this.getViewModel().get('naturalWidth'),i=this.getViewModel().get('naturalHeight');var l=f?d+a[0]:d,m=g?e+a[1]:e,k=!f?c+a[0]:c,j=!g?b+a[1]:b;if(l<0){a[0]=0-d;a[0]=Math.ceil(a[0])}else {if(k>h){a[0]=h-c;a[0]=Math.floor(a[0])}}if(m<0){a[1]=0-e;a[1]=Math.ceil(a[1])}else {if(j>i){a[1]=i-b;a[1]=Math.floor(a[1])}}},resize:function(d,e,c,b){for(var a=0;a<this.nBaseSprites;a++){this.getAt(a).setAttributes({x:d,y:e,width:c,height:b},!0)}},handleKeyPress:function(a,b){var d=a.getKey();if(d==Ext.EventObject.DELETE){a.preventDefault();if(this.readOnly){return}var c=this.drawComponent.lookupViewModel().get('drawablesStore');this.drawComponent.up('photoviewer').lookupController().removeDrawable(c.getAt(b))}},setStrokeWidth:function(b){var a=this.getBaseShape();if(a){a.setAttributes({'stroke-width':b},!0)}this.drawComponent.lookupViewModel().set('toolSettings.strokeWidth',b);this.fireEvent('datachanged')},setStrokeStyle:function(b){var a=this.getBaseShape();if(a){a.setAttributes({'stroke-dasharray':this.drawComponent.self.styleSettings[b]},!0)}this.drawComponent.lookupViewModel().set('toolSettings.strokeStyle',b);this.fireEvent('datachanged')},getBaseShape:function(){return this.getAt(0)},getDrawComponent:function(){return this.drawComponent},onCreate:Ext.emptyFn,getViewModel:function(){return this.getDrawComponent().lookupViewModel()},getMinWidth:function(){return 0},getMinHeight:function(){return 0},onZoomChange:Ext.emptyFn,onTitleChange:Ext.emptyFn,onIsMetricChange:Ext.emptyFn,getAttrFieldName:function(a){return 'Attr'+this.shapeAttributes.indexOf(a)},getRecordValueByAttrName:function(a){return this.record.get(this.getAttrFieldName(a))}},1,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Base'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Line',photoViewer.view.annotations.shapes.Base,{shapeAttributes:['x0','y0','x1','y1','stroke','stroke-width','style'],x1Index:10,initLineConfig:function(a){var b={x0:a.x0-0,y0:a.y0-0,x1:a.x1-0,y1:a.y1-0,draggable:!this.readOnly,stroke:a.stroke,'stroke-width':a['stroke-width'],'stroke-dasharray':this.drawComponent.self.styleSettings[a['style']]};return b},initConfig:function(a){if(!a){return}var b=this.initLineConfig(a);var c=Ext.create('photoViewer.view.annotations.sprites.Line',b);this.add('base0',c);this.show(!0)},refreshSelectionSprites:function(d){var a=this.getByKey('pointHandle'+0),b=this.getByKey('pointHandle'+1),f=this.getAttribute('x0'),h=this.getAttribute('y0'),g=this.getAttribute('x1'),i=this.getAttribute('y1'),j=this.drawComponent.getScale(),e=this.getBaseShape().draggable;if(!a){a=Ext.create('photoViewer.view.annotations.sprites.pointHandle',{x:f,y:h,pointNumber:0,drawComponent:this.drawComponent,draggable:e});b=Ext.create('photoViewer.view.annotations.sprites.pointHandle',{x:g,y:i,pointNumber:1,drawComponent:this.drawComponent,draggable:e});this.add('pointHandle0',a);this.add('pointHandle1',b)}else {var c=Math.max(4/j,3);if(d!==0){a.setAttributes({x:f,y:h,radiusX:c,radiusY:c},!0);a.show(!0)}if(d!==1){b.setAttributes({x:g,y:i,radiusX:c,radiusY:c},!0);b.show(!0)}}},removeSelectionSprites:function(){for(var a=0;a<2;a++){var b=this.getByKey('pointHandle'+a);if(b){b.hide(!0)}}},getType:function(){return 'line'},getAttribute:function(a){var c=this.getAt(0),b=c.attr;if(a=='stroke'){return b.stroke}if(a=='stroke-width'){return b['stroke-width']}if(a=='style'){for(var d in this.drawComponent.self.styleSettings){if(b['stroke-dasharray']==this.drawComponent.self.styleSettings[d]){return d}}}return Math.round(c[a])},changePointOnDragHandle:function(d,a,c){var b=this.drawComponent.getController().getRelativeDescaledXYFromMouseEvent(c);this.movePointHandle(a.pointNumber,b[0],b[1]);this.refreshSelectionSprites(Math.abs(a.pointNumber-1))},movePointHandle:function(i,a,b){var c=this.getViewModel().get('naturalWidth');var d=this.getViewModel().get('naturalHeight');if(a<0){a=0}else {if(a>c){a=c}}if(b<0){b=0}else {if(b>d){b=d}}var e=this.getAttribute('x0');var g=this.getAttribute('y0');var f=this.getAttribute('x1');var h=this.getAttribute('y1');if(i===0){e=a;g=b}else {f=a;h=b}this.getAt(0).setAttributes({x0:e,y0:g,x1:f,y1:h},!0);this.fireEvent('datachanged')},isTooSmall:function(){var a=this.getAt(0),b=Math.getLineLength([a.x0,a.y0],[a.x1,a.y1]);return b>5?!1:!0},setColour:function(a){this.getAt(0).setAttributes({stroke:a},!0);this.fireEvent('datachanged')},translate:function(b,c){var a=this.getAt(0);a.setAttributes({x0:a.x0+b,y0:a.y0+c,x1:a.x1+b,y1:a.y1+c},!0)},getDefaultConfig:function(){var a=this.drawComponent.descaledXY,b=this.getViewModel();return {x0:a[0],x1:a[0],y0:a[1],y1:a[1],stroke:b.get('toolSettings.strokeColour'),'stroke-width':b.get('toolSettings.strokeWidth'),style:b.get('toolSettings.strokeStyle')}}},0,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Line'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Arrow',photoViewer.view.annotations.shapes.Line,{initConfig:function(a){if(!a){return}var b=this.initLineConfig(a);var c=Ext.create('photoViewer.view.annotations.sprites.Arrow',b);this.add('base0',c);this.show(!0)},getType:function(){return 'arrow'}},0,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Arrow'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Ellipse',photoViewer.view.annotations.shapes.Base,{shapeAttributes:['x','y','radiusX','radiusY','stroke','stroke-width','style'],initConfig:function(a){if(!a){return}photoViewer.view.annotations.shapes.Base.prototype.initConfig.apply(this,arguments);a.type='ellipse';a.draggable=!this.readOnly;a.fill='none';a['stroke-dasharray']=this.drawComponent.self.styleSettings[a['style']];var b=Ext.create('photoViewer.draw.Sprite',a);this.add('base0',b);this.show(!0)},resize:function(f,g,c,b){var d=this.getAt(0),e=d.getBBox();var a={x:f+c/2,y:g+b/2};if(e.width!=c){a.radiusX=c/2}if(e.height!=b){a.radiusY=b/2}d.setAttributes(a,!0)},getRealLeft:function(){return this.getAt(0).getBBox().x},getRealRight:function(){return this.getAt(0).getBBox().x+this.getBBox().width},getRealTop:function(){return this.getAt(0).getBBox().y},getRealBottom:function(){return this.getAt(0).getBBox().y+this.getAt(0).getBBox().height},getDefaultConfig:function(){var b=this.drawComponent.descaledXY,a=this.getViewModel();return {x:b[0],y:b[1],radiusX:1,radiusY:1,stroke:a.get('toolSettings.strokeColour'),'stroke-width':a.get('toolSettings.strokeWidth'),style:a.get('toolSettings.strokeStyle')}}},0,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Ellipse'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Measure',photoViewer.view.annotations.shapes.Line,{disableShapeSync:!0,nBaseSprites:1,dataAttributes:['length','oScale','iX','iY','stemPosition'],stemLength:15,arrowWidth:1,constructor:function(a){this.shapeAttributes=['x0','y0','x1','y1','stroke','stroke-width','style','length','iX','iY','oScale','stemPosition'];photoViewer.view.annotations.shapes.Line.prototype.constructor.apply(this,arguments)},getType:function(){return 'measure'},getDefaultConfig:function(){var a=this.drawComponent.descaledXY;return {x0:a[0],x1:a[0],y0:a[1],y1:a[1],stroke:'#FF6600','stroke-width':4,style:'normal'}},initConfig:function(d){if(!d){return}var g=this.initLineConfig(d),a=Ext.create('photoViewer.view.annotations.sprites.Line',g),c=!this.readOnly;this.add('base0',a);this.show(!0);a.addCls('measure');var b={shape:this,draggable:c,renderTo:this.drawComponent.el,contrainTo:this.drawComponent.el,constrain:!0,hidden:!0};this.stemPosition=this.record?this.getRecordValueByAttrName('stemPosition'):'';var f=this.record?this.getRecordValueByAttrName('iX'):undefined;if(f===''||f===undefined){b.alignTarget=a.el;b.defaultAlign='tc-bc?'}this.measurementLabel=Ext.create('photoViewer.view.annotations.sprites.Info',b);if(c){var e=this.measurementLabel.getDragEl();e.addListener('drag',this.onLabelDrag,this);e.addListener('dragend',this.onLabelDragEnd,this)}this.refreshMeasurementLabel(!0)},initLineConfig:function(a){var b=this.getScaleFromUnalteredPhoto(),c=!!(!this.record||!this.record.store||this.record.store.getProxy().type=='memory'),d={x0:(a.x0-0)*b,y0:(a.y0-0)*b,x1:(a.x1-0)*b,y1:(a.y1-0)*b,draggable:c,stroke:a.stroke,'stroke-width':a['stroke-width'],'stroke-dasharray':this.drawComponent.self.styleSettings[a['style']]};return d},getScaleFromUnalteredPhoto:function(){var a=this.drawComponent.lookupViewModel().get('drawMode')===photoViewer.Values.DRAW_MEASURING;return a?1:this.getRecordValueByAttrName('oScale')},onZoomChange:function(){this.refreshMeasurementLabel()},destroy:function(){this.measurementLabel.destroy();photoViewer.view.annotations.shapes.Line.prototype.destroy.apply(this,arguments)},refreshMeasurementLabel:function(f,e){if(this.measurementLabel&&(f||this.measurementLabel.isVisible())&&this.record&&this.record.get('Length')){this.measurementLabel.setData(this.record.getData());if(this.measurementLabel.alignTarget){this.measurementLabel.showBy(this.getBaseShape().el)}else {this.measurementLabel.el.dom.style.visibility='hidden';if(!this.measurementLabel.isVisible()){this.measurementLabel.show()}var d=this.drawComponent.getScale(),a=this.getScaleFromUnalteredPhoto(),c=this.drawComponent.getBox(),g=this.getRecordValueByAttrName('iX')*d*a+c.left,h=this.getRecordValueByAttrName('iY')*d*a+c.top,i=g-this.measurementLabel.el.getWidth()/2,j=h-this.measurementLabel.el.getHeight()/2,k=this.getScaledArrowWidth();if(!e){this.measurementLabel.setXY([i,j])}var b=this.getLabelDimensions();if(this.stem&&this.arrow&&b.stem){this.stem.setAttributes(this.getUpdatedStemConfig(),!0);this.arrow.setAttributes(this.getUpdatedArrowConfig(),!0)}else {if(!this.stem&&b.stem){this.addArrow()}}this.measurementLabel.el.dom.style.visibility=''}}},getUpdatedStemConfig:function(){var a=this.getLabelDimensions();return {x0:a.stem.x,y0:a.stem.y,x1:a.stem.x1,y1:a.stem.y1,'stroke-width':this.getScaledArrowWidth()*2}},getFullStemConfig:function(){var a=this.getUpdatedStemConfig();a.draggable=!this.readOnly;a.stroke='red';return a},getUpdatedArrowConfig:function(){var a=this.getLabelDimensions();return {x0:a.stem.x1,y0:a.stem.y1,'stroke-width':this.getScaledArrowWidth()*2}},getFullArrowConfig:function(){var a=this.getUpdatedArrowConfig(),b=this.getScaleFromUnalteredPhoto(),c=Math.round(b*this.record.get('Attr'+this.shapeAttributes.indexOf('x0'))),e=Math.round(b*this.record.get('Attr'+this.shapeAttributes.indexOf('y0'))),d=Math.round(b*this.record.get('Attr'+this.shapeAttributes.indexOf('x1'))),f=Math.round(b*this.record.get('Attr'+this.shapeAttributes.indexOf('y1')));a.draggable=!this.readOnly;a.x1=(c+d)/2;a.y1=(e+f)/2;a.stroke='red';a.fill='red';return a},hide:function(){photoViewer.view.annotations.shapes.Line.prototype.hide.apply(this,arguments);this.measurementLabel.hide()},show:function(){photoViewer.view.annotations.shapes.Line.prototype.show.apply(this,arguments);this.refreshMeasurementLabel(!0)},changePointOnDragHandle:function(){photoViewer.view.annotations.shapes.Line.prototype.changePointOnDragHandle.apply(this,arguments);this.onLineMove()},translate:function(){photoViewer.view.annotations.shapes.Line.prototype.translate.apply(this,arguments);this.onLineMove()},onLineMove:function(){if(this.record){this.record.setAttr('length',undefined);this.measurementLabel.hide()}},select:function(){photoViewer.view.annotations.shapes.Line.prototype.select.apply(this,arguments);this.measurementLabel.toFront()},onTitleChange:function(){this.refreshMeasurementLabel(!0)},onIsMetricChange:function(){this.refreshMeasurementLabel(!0)},onLabelDrag:function(){if(this.measurementLabel.alignTarget){this.measurementLabel.alignTarget=null;this.measurementLabel.defaultAlign=null}var a=this.getLabelDimensions(!0);if(this.arrow){if(!a.stem){this.arrow.destroy();this.stem.destroy();this.arrow=null;this.stem=null;this.stemPosition='';this.fireEvent('datachanged')}else {this.fixArrowIntersection()}}this.refreshMeasurementLabel(!0,!0)},onLabelDragEnd:function(){var a=this.getLabelDimensions(),b=this.drawComponent.lookupViewModel();this.record.setAttrs({'iX':a.midX,'iY':a.midY,'stemPosition':this.stemPosition,'oScale':(b.get('activePhoto.OriginalsWidth')/b.get('unalteredWidth')).toFixed(3)})},getLabelDimensions:function(j){var h=this.drawComponent.getScale(),i=this.drawComponent.el.getBox(),a={x:(this.measurementLabel.el.getX()-i.left)/h,y:(this.measurementLabel.el.getY()-i.top)/h,width:this.measurementLabel.el.getWidth()/h,height:this.measurementLabel.el.getHeight()/h},g=this.getScaledStemLength();a.right=a.x+a.width;a.bottom=a.y+a.height;a.midX=Math.round(a.x+a.width/2);a.midY=Math.round(a.y+a.height/2);a.mid0={x:a.midX,y:a.y,x1:a.midX,y1:a.y-g};a.mid1={x:a.right,y:a.midY,x1:a.right+g,y1:a.midY};a.mid2={x:a.midX,y:a.bottom,x1:a.midX,y1:a.bottom+g};a.mid3={x:a.x,y:a.midY,x1:a.x-g,y1:a.midY};var c=Math.round(this.record.get('Attr'+this.shapeAttributes.indexOf('x0'))),e=Math.round(this.record.get('Attr'+this.shapeAttributes.indexOf('y0'))),d=Math.round(this.record.get('Attr'+this.shapeAttributes.indexOf('x1'))),f=Math.round(this.record.get('Attr'+this.shapeAttributes.indexOf('y1')));if(j||this.stemPosition===undefined){var b='';if(a.y>Math.max(e,f)){b=0}else {if(a.bottom<Math.min(e,f)){b=2}else {if(a.x>Math.max(c,d)){b=1}else {if(a.right<Math.min(c,d)){b=3}}}}if(this.stemPosition===undefined||this.stemPosition===''&&b!==''||this.stemPosition!==''&&b===''){this.stemPosition=b}}if(Math.segmentsIntersect([a.mid0.x,a.mid0.y],[a.mid0.x1,a.mid0.y1],[c,e],[d,f])||Math.segmentsIntersect([a.mid1.x,a.mid0.y],[a.mid1.x1,a.mid1.y1],[c,e],[d,f])||Math.segmentsIntersect([a.mid2.x,a.mid0.y],[a.mid2.x1,a.mid2.y1],[c,e],[d,f])||Math.segmentsIntersect([a.mid3.x,a.mid0.y],[a.mid3.x1,a.mid3.y1],[c,e],[d,f])){this.stemPosition=''}if(this.stemPosition!==''){a.stem=a['mid'+this.stemPosition]}return a},addArrow:function(){this.stem=Ext.create('photoViewer.view.annotations.sprites.Line',this.getFullStemConfig());this.arrow=Ext.create('photoViewer.view.annotations.sprites.Arrow',this.getFullArrowConfig());this.add('arrow',this.arrow);this.add('stem',this.stem)},fixArrowIntersection:function(m){var f=this.arrow,l=this.stem,g=this.getLabelDimensions();var b=g.width,e=g.height,a=g.x,c=g.y,d=f.attr['stroke-width'];var k=this.arrowIntersectsSide(0),i=this.arrowIntersectsSide(1),h=this.arrowIntersectsSide(2),j=this.arrowIntersectsSide(3);if(j&&k){if(f.x1<=a){this.moveStemToSide(3,a,c,b,e,d,!0)}else {this.moveStemToSide(0,a,c,b,e,d,!0)}}else {if(i&&k){if(f.x1>=a+b){this.moveStemToSide(1,a,c,b,e,d,!0)}else {this.moveStemToSide(0,a,c,b,e,d,!0)}}else {if(j&&h){if(f.x1<=a){this.moveStemToSide(3,a,c,b,e,d,!0)}else {this.moveStemToSide(2,a,c,b,e,d,!0)}}else {if(i&&h){if(f.x1>=a+b){this.moveStemToSide(1,a,c,b,e,d,!0)}else {this.moveStemToSide(2,a,c,b,e,d,!0)}}else {if(k&&h){if(f.y1<=c){this.moveStemToSide(0,a,c,b,e,d,!0)}else {this.moveStemToSide(2,a,c,b,e,d,!0)}}else {if(i&&j){if(f.x1<=a){this.moveStemToSide(3,a,c,b,e,d,!0)}else {this.moveStemToSide(1,a,c,b,e,d,!0)}}}}}}}f.setAttributes({x0:l.x1,y0:l.y1,x1:f.x1,y1:f.y1},!0)},arrowIntersectsSide:function(f){var c=this.arrow,d=this.getLabelDimensions(),i=d.width,e=d.height,a=d.x,b=d.y,j=c.attr['stroke-width'];var g=[a,b],h=[a+i,b];if(f===1){g=[a+i,b+e]}if(f===2){g=[a,b+e];h=[a+i,b+e]}if(f===3){h=[a,b+e]}return Math.segmentsIntersect(g,h,[c.x0,c.y0],[c.x1,c.y1])},moveStemToSide:function(c,h,i,g,f,d,e){this.stemPosition=c;var a=this.getStemSideCoordinates(c,h,i,g,f,d);var b={x0:a.x0,y0:a.y0};if(e){b.x1=a.x1;b.y1=a.y1}this.stem.setAttributes(b,!0)},getScaledStemLength:function(){return this.stemLength/this.drawComponent.getScale()},getScaledArrowWidth:function(){return this.arrowWidth/this.drawComponent.getScale()},getStemSideCoordinates:function(f,a,b,h,g,i){var c=a+h/2-i/2;var d=b+g/2+i/2;var e=this.getScaledStemLength();if(f===0){return {x0:c,y0:b,x1:c,y1:b-e}}if(f===1){return {x0:a+h,y0:d,x1:a+h+e,y1:d}}if(f===2){return {x0:c,y0:b+g,x1:c,y1:b+g+e}}if(f===3){return {x0:a,y0:d,x1:a-e,y1:d}}},getAttribute:function(a){if(Ext.Array.contains(['x0','y0','x1','y1'],a)){return photoViewer.view.annotations.shapes.Line.prototype.getAttribute.apply(this,arguments)/this.getScaleFromUnalteredPhoto()}return photoViewer.view.annotations.shapes.Line.prototype.getAttribute.apply(this,arguments)},isTooSmall:function(){return !1}},1,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Measure'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Pen',photoViewer.view.annotations.shapes.Base,{shapeAttributes:['translationX','translationY','unscaledWidth','unscaledHeight','stroke','coordsString','stroke-width','style','scalingX','scalingY'],self:{pointAttrIndices:[0],typeLengths:{a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0,A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},MAX_ANGLE:Math.PI*0.7,MAX_ERROR:2,MAX_N_ITERATION:4,BOX_SIZE:50,INCREASE_K:0.2,LINE_D:40,N:50,MAX_COORDS_LENGTH:1024},initPenConfig:function(a){for(var b=0;b<this.shapeAttributes.length;b++){var m=this.shapeAttributes[b];if(typeof a[m]==='undefined'){throw "Property '"+m+"' required"}}this.coordsString=a.coordsString;this.scalingX=a.scalingX;this.scalingY=a.scalingY;this.translationX=a.translationX;this.translationY=a.translationY;var p='';if(a.isUndrawn){var g=this.getDrawComponent(),d=g.el,o=d.getWidth(),l=d.getHeight(),e=d.getX(),f=d.getY(),n=e+o,k=f+l,c=this.drawComponent.up('photoviewer').lookupController().lookupReference('photoContainer'),i=c.el.getWidth(),h=c.el.getHeight();this.drawingFieldWidth=o;this.drawingFieldHeight=l;this.xOffset=e;this.yOffset=f;if(e<c.el.getLeft()){this.drawingFieldWidth+=e}if(f<c.el.getTop()){this.drawingFieldHeight+=f}if(n>i){this.drawingFieldWidth-=n-i}if(k>h){this.drawingFieldHeight-=k-h}var q=[];var r=0,j=Math.floor(this.self.N*r);for(var b=0,t=this.self.N;b<t;b++){q.push((b+1+j)/(this.self.N+2*j))}this.ti=q;this.seg=new MVMath.CurveSegment();this.iterations=0;this.rasterBorder={minx:0,miny:0,maxx:0,maxy:0};this.breakFlag=!1;this.curve={curveSeg:[new MVMath.CurveSegment()]};this.vectorDistMap=null;this.initCurveSegment(g.pageXY[0]-this.xOffset,g.pageXY[1]-this.yOffset,this.curve.curveSeg[0]);this.clearVectorDistMap(this.drawingFieldWidth,this.drawingFieldHeight);this.scale=g.getScale();this.done=!1;this.pathObj=Ext.create('photoViewer.draw.Path')}else {this.unscaledWidth=a.unscaledWidth;this.unscaledHeight=a.unscaledHeight;this.setupAbsCoords(a.coordsString);p=this.getTransformedPath()}var s={type:'path',path:p,draggable:!this.readOnly,stroke:a.stroke,'stroke-width':a['stroke-width'],'stroke-dasharray':this.drawComponent.self.styleSettings[a['style']]};return s},getTransformedPath:function(){var d=this.minX+this.unscaledWidth/2,e=this.minY+this.unscaledHeight/2,f=d+-d*this.scalingX+this.translationX,g=e+-e*this.scalingY+this.translationY,c='M '+f+','+g,b=Ext.Array.clone(this.absCoords);for(var a=0;a<b.length;a+=2){b[a]=b[a]*this.scalingX+f;b[a+1]=b[a+1]*this.scalingY+g}for(var a=0;a<b.length;a+=6){c+='C'+ +b[a]+' '+ +b[a+1]+' '+ +b[a+2]+' '+b[a+3]+' '+b[a+4]+' '+b[a+5]}return c},setupAbsCoords:function(h){var c=[0,0],b=h.split(','),d=Number(b[0]),e=Number(b[1]),f=d,g=e;for(var a=0;a<b.length;a+=6){var i=[c[0]+Number(b[a+4]),c[1]+Number(b[a+5])];b[a]=c[0]+Number(b[a]);b[a+1]=c[1]+Number(b[a+1]);b[a+2]=c[0]+Number(b[a+2]);b[a+3]=c[1]+Number(b[a+3]);b[a+4]=c[0]+Number(b[a+4]);b[a+5]=c[1]+Number(b[a+5]);c=i}this.absCoords=Ext.Array.clone(b);for(var a=0;a<b.length;a++){if(a%2===0&&b[a]<d){d=b[a]}if(a%2===1&&b[a]<e){e=b[a]}if(a%2===0&&b[a]>f){f=b[a]}if(a%2===1&&b[a]>g){g=b[a]}}this.minX=d;this.minY=e},transformPoint:function(a,c,b){return a+-a*c+b},initConfig:function(a){if(!a){return}var c=this.initPenConfig(a);var b=Ext.create('photoViewer.draw.Sprite',c);this.add('base0',b);this.show(!0)},getType:function(){return 'pen'},getAttribute:function(a){var c=this.getAt(0),b='';if(a=='coordsString'){b=this.getCoordsString()}else {if(this[a]!==undefined){b=this[a]}else {b=c.attr[a]}}if(a=='unscaledWidth'||a=='unscaledHeight'||a=='x'||a=='y'||a=='translationX'||a=='translationY'){b=Math.round(b)}else {if(a=='style'){for(var d in this.drawComponent.self.styleSettings){if(c.attr['stroke-dasharray']==this.drawComponent.self.styleSettings[d]){return d}}}}return b},getCoordsString:function(){var a=this.pathObj?this.pathObj.coords:null;return this.coordsString?this.coordsString:Ext.Array.slice(a,2,a.length-(a.length-2)%6).join(',')},changePointOnDragHandle:function(d,a,c){var b=this.drawComponent.getController().getRelativeDescaledXYFromMouseEvent(c);this.movePointHandle(a.pointNumber,b[0],b[1]);this.refreshSelectionSprites(Math.abs(a.pointNumber-1))},movePointHandle:function(i,a,b){var c=this.getViewModel().get('naturalWidth');var d=this.getViewModel().get('naturalHeight');if(a<0){a=0}else {if(a>c){a=c}}if(b<0){b=0}else {if(b>d){b=d}}var e=this.getAttribute('x0');var g=this.getAttribute('y0');var f=this.getAttribute('x1');var h=this.getAttribute('y1');if(i===0){e=a;g=b}else {f=a;h=b}this.getAt(0).setAttributes({x0:e,y0:g,x1:f,y1:h},!0);this.fireEvent('datachanged')},isTooSmall:function(){return this.getWidth()>5?!1:!0},setColour:function(a){this.getAt(0).setAttributes({stroke:a},!0);this.fireEvent('datachanged')},getDefaultConfig:function(){var a=this.getViewModel();return {translationX:0,translationY:0,unscaledWidth:0,unscaledHeight:0,stroke:a.get('toolSettings.strokeColour'),coordsString:'','stroke-width':a.get('toolSettings.strokeWidth'),style:a.get('toolSettings.strokeStyle'),scalingX:1,scalingY:1,isUndrawn:!0}},translate:function(a,b){this.translationX+=a;this.translationY+=b;this.getBaseShape().setAttributes({path:this.getTransformedPath()},!0)},resize:function(e,f,d,c,g,h){var a=this.getBaseShape();this.scalingX=d/this.unscaledWidth;this.scalingY=c/this.unscaledHeight;a.setAttributes({path:this.getTransformedPath()},!1);var b=a.getBBox();this.translationX+=e-b.x;this.translationY+=f-b.y;a.setAttributes({path:this.getTransformedPath()},!0)},drawPath:function(i,j,h){if(this.done){return}var k=this.getDrawComponent(),d=h.browserEvent.pageX-this.xOffset,e=h.browserEvent.pageY-this.yOffset,f=this.curve,b=f.curveSeg[f.curveSeg.length-1],g=new MVMath.Point(b.C3),c,a;c=this.updateCurveSegment(d,e,b);if(c!=='SUCCESS'){a=new MVMath.CurveSegment();this.initCurveSegment(g.x,g.y,a,d,e);this.clearRaster(this.rasterBorder,this.vectorDistMap);if(c==='FAILURE'){a.constrainted=!0;a.tan=new MVMath.Point(b.C3.x-b.C2.x,b.C3.y-b.C2.y);a.tan.normalize();a.C2.x=a.C0.x-a.tan.x;a.C2.y=a.C0.y-a.tan.y}else {if(c!=='CORNER'){a.constrained=!1}}this.updateCurveSegment(d,e,a);this.curve.curveSeg.push(a)}},updateCurveSegment:function(l,m,a){var n=this.vectorDistMap,c=this.ti,i=new MVMath.Point(a.C3),h=0,p=0,d,k,o=new MVMath.Point(),j=new MVMath.Point(),f,g=0,e=new MVMath.Point((a.C3.x-a.C0.x)/3,(a.C3.y-a.C0.y)/3);if(this.testCorner(l,m,a)){return 'CORNER'}this.saveControlVertices(a);a.C3=new MVMath.Point(l,m);a.C2=new MVMath.Point(a.C2.x+(l-i.x),a.C2.y+(m-i.y));if(e.getLength()<this.self.LINE_D){a.C2.x=a.C3.x-e.x;a.C2.y=a.C3.y-e.y;if(a.constrainted===!0){g=a.tan.getScalarMult(e);e=new MVMath.Point(g*a.tan.x,g*a.tan.y)}a.C1.x=a.C0.x+(e.x?e.x:0);a.C1.y=a.C0.y+(e.y?e.y:0)}this.renderLineCell(i.x,i.y,l,m,this.self.BOX_SIZE,n);this.renderPointCell(i.x,i.y,this.self.BOX_SIZE,n);do{d=new MVMath.Point();k=new MVMath.Point();h=0;for(var b=0,q=this.self.N;b<q;b+=1){o=this.calc(a,c[b]);j=this.interpVectorDist(n,o.x,o.y);f=j.getLength();if(f>h){h=f}h+=f;d.x+=6*c[b]*(1-c[b])*(1-c[b])*f*j.x/this.self.N;d.y+=6*c[b]*(1-c[b])*(1-c[b])*f*j.y/this.self.N;k.x+=6*c[b]*c[b]*(1-c[b])*f*j.x/this.self.N;k.y+=6*c[b]*c[b]*(1-c[b])*f*j.y/this.self.N}h/=this.self.N;if(a.constrainted===!0){g=a.tan.getScalarMult(d);d=new MVMath.Point(g*a.tan.x,g*a.tan.y)}a.C1.x=a.C1.x-this.self.INCREASE_K*(d.x?d.x:0);a.C1.y=a.C1.y-this.self.INCREASE_K*(d.y?d.y:0);a.C2.x=a.C2.x-this.self.INCREASE_K*k.x;a.C2.y=a.C2.y-this.self.INCREASE_K*k.y;p++}while(p<this.self.MAX_N_ITERATION);if(h<this.self.MAX_ERROR){this.drawCurve(a);this.breakFlag=!1;return 'SUCCESS'}else {this.resetControlVertices(a);return 'FAILURE'}},testCorner:function(c,d,a){var b=this.getVectorAngle(new MVMath.Point(a.C2.x-a.C3.x,a.C2.y-a.C3.y),new MVMath.Point(c-a.C3.x,d-a.C3.y));if(b<this.self.MAX_ANGLE){return !0}else {return !1}},getVectorAngle:function(a,b){var c=a.getScalarMult(b),d=a.getLength(),e=b.getLength();return Math.acos(c/(d*e))},adjustdxDYToStayInBounds:Ext.emptyFn,getCanResizeFlip:function(){return !1},saveControlVertices:function(a){if(typeof a.save==='undefined'){a.save={}}a.save.C1=a.C1;a.save.C2=a.C2;a.save.C3=a.C3},initCurveSegment:function(b,c,a,d,e){a.C0=MVMath.Point(b,c);a.C1=MVMath.Point(b,c);a.C2=MVMath.Point(b,c);a.C3=MVMath.Point(b,c)},clearVectorDistMap:function(b,a){this.vectorDistMap=[];this.rasterBorder.minx=Math.floor(b);this.rasterBorder.maxx=0;this.rasterBorder.miny=Math.floor(a);this.rasterBorder.maxy=0},renderLineCell:function(b,c,e,f,i,l){var h=[],d=new MVMath.Point(f-c,-(e-b)),a=new MVMath.Point(),g,k=new MVMath.Point(),j=new MVMath.Point();d.normalize();a=new MVMath.Point(d.x*i,d.y*i);h.push(new MVMath.Edge(new MVMath.Point(e+a.x,f+a.y),new MVMath.Point(b+a.x,c+a.y)));h.push(new MVMath.Edge(new MVMath.Point(b+a.x,c+a.y),new MVMath.Point(b-a.x,c-a.y)));h.push(new MVMath.Edge(new MVMath.Point(b-a.x,c-a.y),new MVMath.Point(e-a.x,f-a.y)));h.push(new MVMath.Edge(new MVMath.Point(e-a.x,f-a.y),new MVMath.Point(e+a.x,f+a.y)));g=this.rasterize(h);if(g.length>0){j=this.getDistanceDeffVectorLine(g,e,f,b,c,d);k=this.getDistanceVectorLine(d,g[0],b,c);this.processPoints(g,j,k,l,d,b,c)}},renderPointCell:function(b,c,a,f){var e=[],d,h=new MVMath.Point(),g=new MVMath.Point(),f=this.vectorDistMap;e.push(new MVMath.Edge(new MVMath.Point(b-a,c+a),new MVMath.Point(b+a,c+a)));e.push(new MVMath.Edge(new MVMath.Point(b+a,c+a),new MVMath.Point(b+a,c-a)));e.push(new MVMath.Edge(new MVMath.Point(b+a,c-a),new MVMath.Point(b-a,c-a)));e.push(new MVMath.Edge(new MVMath.Point(b-a,c-a),new MVMath.Point(b-a,c+a)));d=this.rasterize(e);if(d.length>0){g=this.getDistanceDeffVectorPoint(d,b,c);h=this.getDistanceVectorPoint(b,c,d[0]);this.processPoints(d,g,h,f,null,b,c)}},rasterize:function(g){var o=[],r=this.drawingFieldWidth,l=this.drawingFieldHeight,h=this.rasterBorder,k=0,d=l,p,e,s,i=[],n,b,c=[],j=!1,f=0,m=0;for(var a=0;a<g.length;a++){b=g[a];if(b.p1.y>b.p2.y){p=b.p2;b.p2=b.p1;b.p1=p}if(b.p1.y<d){d=b.p1.y}if(b.p2.y>k){k=b.p2.y}b.startY=l-Math.floor(l-b.p1.y);b.k=(b.p2.x-b.p1.x)/(b.p2.y-b.p1.y);b.startX=b.p1.x+(b.startY-b.p1.y)*b.k;b.stopY=Math.floor(b.p2.y)}for(a=g.length-1;a>=0;a-=1){if(g[a].p1.y===g[a].p2.y){g.splice(a,1)}}k=Math.floor(k);d=l-Math.floor(l-d);i=new Array(Math.max(k-d+1,0));for(var a=0;a<g.length;a++){n=g[a].startY-d;if(typeof i[n]==='undefined'){i[n]=[]}i[n].push(g[a])}var q=function(a,b){if(a.startX-b.startX!==0){return a.startX-b.startX}else {return a.p2.x-b.p2.x}};for(a=d,max_i=k;a<=max_i;a+=1){for(e=c.length-1;e>=0;e-=1){c[e].startX+=c[e].k}if(typeof i[a-d]!=='undefined'&&i[a-d].length>0){c=c.concat(i[a-d]);c.sort(q)}for(e=c.length-1;e>=0;e-=1){if(c[e].stopY===a){c.splice(e,1)}}if(c.length>1){f=Math.round(c[0].startX);j=!0;m=1;do{if(j){o.push({x:f,y:a});if(f>h.maxx){h.maxx=f}if(f<h.minx){h.minx=f}if(a>h.maxy){h.maxy=a}if(a<h.miny){h.miny=a}}f++;if(j&&f>Math.round(c[m].startX)||!j&&f>=Math.round(c[m].startX)){m++;j=!j}}while(m<c.length)}}return o},getPathObj:function(){return this.pathObj},getDistanceDeffVectorPoint:function(a,c,d){var b,f,e;if(a.length>1){b=this.getDistanceVectorPoint(c,d,a[0]);f=this.getDistanceVectorPoint(c,d,new MVMath.Point(a[0].x,a[0].y+1));e=this.getDistanceVectorPoint(c,d,new MVMath.Point(a[0].x+1,a[0].y));return {fx:new MVMath.Point(e.x-b.x,f.x-b.x),fy:new MVMath.Point(e.y-b.y,f.y-b.y)}}else {return {fx:new MVMath.Point(),fy:new MVMath.Point()}}},getDistanceVectorPoint:function(a,c,d){var b,f,e;if(a.length>1){b=this.getDistanceVectorPoint(c,d,a[0]);f=this.getDistanceVectorPoint(c,d,new MVMath.Point(a[0].x,a[0].y+1));e=this.getDistanceVectorPoint(c,d,new MVMath.Point(a[0].x+1,a[0].y));return {fx:new MVMath.Point(e.x-b.x,f.x-b.x),fy:new MVMath.Point(e.y-b.y,f.y-b.y)}}else {return {fx:new MVMath.Point(),fy:new MVMath.Point()}}},processPoints:function(a,d,g,c,l,h,i){var b,f,e=new MVMath.Point(),j,k;for(b=0,f=a.length-1;b<f;b+=1){e=new MVMath.Point(g.x+(a[b+1].x-a[0].x)*d.fx.x+(a[b+1].y-a[0].y)*d.fx.y,g.y+(a[b+1].x-a[0].x)*d.fy.x+(a[b+1].y-a[0].y)*d.fy.y);if(!c[a[b+1].y]){c[a[b+1].y]=[]}if(!c[a[b+1].y][a[b+1].x]){c[a[b+1].y][a[b+1].x]=e}else {if(c[a[b+1].y][a[b+1].x].getLength()>e.getLength()){c[a[b+1].y][a[b+1].x]=e}}}},getDistanceVectorPoint:function(b,c,a){var d=new MVMath.Point(a.x-b,a.y-c);return d},calc:function(b,a){var c,d;c=(b.C0.x?b.C0.x:0)*(1-a)*(1-a)*(1-a)+3*(b.C1.x?b.C1.x:0)*a*(1-a)*(1-a)+3*(b.C2.x?b.C2.x:0)*a*a*(1-a)+(b.C3.x?b.C3.x:0)*a*a*a;d=(b.C0.y?b.C0.y:b.C0.y)*(1-a)*(1-a)*(1-a)+3*(b.C1.y?b.C1.y:0)*a*(1-a)*(1-a)+3*b.C2.y*a*a*(1-a)+b.C3.y*a*a*a;return new MVMath.Point(c,d)},interpVectorDist:function(a,e,f){var d=Math.floor(e),b=Math.floor(f),g=d+1,c=b+1,h=a[b]&&a[b][d]?a[b][d]:{x:0,y:0},j=a[b]&&a[b][g]?a[b][g]:{x:0,y:0},i=a[c]&&a[c][d]?a[c][d]:{x:0,y:0},k=a[c]&&a[c][g]?a[c][g]:{x:0,y:0};return new MVMath.Point(h.x*(g-e)*(c-f)+j.x*(e-d)*(c-f)+i.x*(g-e)*(f-b)+k.x*(e-d)*(f-b),h.y*(g-e)*(c-f)+j.y*(e-d)*(c-f)+i.y*(g-e)*(f-b)+k.y*(e-d)*(f-b))},resetControlVertices:function(a){if(typeof a.save!=='undefined'){a.C1=a.save.C1;a.C2=a.save.C2;a.C3=a.save.C3}},clearRaster:function(a,b){this.vectorDistMap=[];a.minx=this.drawingFieldWidth;a.maxx=0;a.miny=this.drawingFieldHeight;a.maxy=0},redraw:function(){this.setAttributes({path:this.getPathObj().toString()},!0)},drawCurve:function(b,l,k){var a=this.getPathObj(),c=Math.round(b.C0.x/this.scale),d=Math.round(b.C0.y/this.scale),e=Math.round(b.C1.x/this.scale),f=Math.round(b.C1.y/this.scale),g=Math.round(b.C2.x/this.scale),h=Math.round(b.C2.y/this.scale),i=Math.round(b.C3.x/this.scale),j=Math.round(b.C3.y/this.scale);if(l!==!0){this.doClear()}if(!a.cursor||a.cursor[0]!=c||a.cursor[1]!=d){a.relativeMoveTo(c,d)}this.coordsLength+=a.convertAbsToRelPathBezierCurveTo(e,f,g,h,i,j)+6;if(this.coordsLength>=this.self.MAX_COORDS_LENGTH){this.done=!0;a.types.pop();Ext.Array.erase(a.coords,a.coords.length-this.self.typeLengths.c,this.self.typeLengths.c);return}if(!k){this.redraw()}},getDistanceDeffVectorLine:function(a,i,j,c,d,g){var b,f,e,h;if(a.length>1){b=this.getDistanceVectorLine(g,a[0],c,d);f=this.getDistanceVectorLine(g,new MVMath.Point(a[0].x,a[0].y+1),c,d);e=this.getDistanceVectorLine(g,new MVMath.Point(a[0].x+1,a[0].y),c,d);return {fx:new MVMath.Point(e.x-b.x,f.x-b.x),fy:new MVMath.Point(e.y-b.y,f.y-b.y)}}else {return {fx:new MVMath.Point(),fy:new MVMath.Point()}}},getDistanceVectorLine:function(b,d,e,f){var a,c;a=b.getScalarMult(new MVMath.Point(d.x-e,d.y-f));c=new MVMath.Point(b.x*a,b.y*a);return c},doClear:function(){var b=this.curve.curveSeg,c=this.getPathObj();c.clear();this.coordsLength=-1;for(var a=0;a<b.length;a++){this.drawCurve(b[a],!0,!0)}this.redraw()},getWidth:function(){return !this.getBaseShape().attr.path?0:photoViewer.view.annotations.shapes.Base.prototype.getWidth.apply(this,arguments)},getHeight:function(){return !this.getBaseShape().attr.path?0:photoViewer.view.annotations.shapes.Base.prototype.getHeight.apply(this,arguments)},onCreate:function(){this.doClear();delete this.breakFlag;delete this.coordsLength;delete this.currentSeg;delete this.curve;delete this.done;delete this.drawingFieldHeight;delete this.drawingFieldWidth;delete this.iterations;delete this.rasterBorder;delete this.scale;delete this.seg;delete this.ti;delete this.vectorDistMap;delete this.xOffset;delete this.yOffset;var a=this.pathObj,c=a.coords[0],d=a.coords[1];this.translationX=c;this.translationY=d;this.setupAbsCoords(this.getCoordsString());var b=this.getBaseShape().getBBox();this.unscaledWidth=b.width;this.unscaledHeight=b.height;this.fireEvent('datachanged')}},0,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Pen'],0);(function(){if(typeof MVMath=='undefined'){Ext.namespace('MVMath')}MVMath.crossProduct2D=function(a,b){return a[0]*b[1]-a[1]*b[0]};MVMath.roundToNDecimalPlaces=function(b,a){return Number(b.toFixed(a))};MVMath.Point=function(a,b){if(!(this instanceof MVMath.Point)){return new MVMath.Point(a,b)}switch(!0){case a instanceof MVMath.Point&&typeof b==='undefined':this.x=a.x;this.y=a.y;break;case typeof a==='number'&&typeof b==='number':this.x=a;this.y=b;break;default:this.x=0;this.y=0;}};MVMath.Point.prototype.getLength=function getLength(){return Math.sqrt(this.x*this.x+this.y*this.y)};MVMath.Point.prototype.getScalarMult=function getScalarMult(a){return this.x*a.x+this.y*a.y};MVMath.Point.prototype.normalize=function normalize(){var a=this.getLength();this.x/=a;this.y/=a};MVMath.Point.prototype.getRotatedPoint=function(a,b){b=b*-1;return new MVMath.Point(Math.cos(b)*(this.x-a.x)-Math.sin(b)*(this.y-a.y)+a.x,a.y+Math.sin(b)*(this.x-a.x)+Math.cos(b)*(this.y-a.y))};MVMath.Edge=function(a,b,c,d){if(!(this instanceof MVMath.Edge)){return new MVMath.Edge(a,b,c,d)}if(arguments.length===2){this.p1=a;this.p2=b}if(arguments.length===4){this.p1=new MVMath.Point(a,b);this.p2=new MVMath.Point(c,d)}};MVMath.Edge.prototype.getLength=function(){return Math.sqrt(Math.pow(this.p1.y-this.p2.y,2)+Math.pow(this.p1.x-this.p2.x,2))};MVMath.Edge.prototype.intersects=function(a){var c=[this.p2.x-this.p1.x,this.p2.y-this.p1.y],d=[a.p2.x-a.p1.x,a.p2.y-a.p1.y];var b=MVMath.crossProduct2D(c,d);if(b===0){if(MVMath.crossProduct2D([a.p1.x-this.p1.x,a.p1.y-[1]],c)===0){return !0}return !1}var e=MVMath.crossProduct2D([a.p1.x-this.p1.x,a.p1.y-this.p1.y],d)/b;var f=MVMath.crossProduct2D([a.p1.x-this.p1.x,a.p1.y-this.p1.y],c)/b;if(0<=e&&e<=1&&0<=f&&f<=1){return !0}return !1};MVMath.Edge.prototype.getAngle=function(){var b=(new MVMath.Edge(this.p1.x,this.p1.y,this.p2.x,this.p2.y)).getLength(),a=b?Math.asin(Math.abs(this.p1.y-this.p2.y)/b):0;if(this.p2.x<=this.p1.x&&this.p2.y<=this.p1.y){a=a-Math.PI;a=a*-1}else {if(this.p2.x<=this.p1.x&&this.p2.y>=this.p1.y){a=a-Math.PI}else {if(this.p2.x>=this.p1.x&&this.p2.y>=this.p1.y){a=a*-1}}}return a};MVMath.CurveSegment=function(a,b){if(typeof a==='undefined'||typeof b==='undefined'){this.C0=new MVMath.Point();this.C1=new MVMath.Point();this.C2=new MVMath.Point();this.C3=new MVMath.Point()}else {this.C0=new MVMath.Point(a,b);this.C1=new MVMath.Point(a,b);this.C2=new MVMath.Point(a,b);this.C3=new MVMath.Point(a,b)}}})();Ext.cmd.derive('photoViewer.view.annotations.shapes.Rectangle',photoViewer.view.annotations.shapes.Base,{shapeAttributes:['x','y','width','height','stroke','stroke-width','style'],initConfig:function(a){if(!a){return}photoViewer.view.annotations.shapes.Base.prototype.initConfig.apply(this,arguments);a.type='rect';a.draggable=!this.readOnly;a.fill='none';a['stroke-dasharray']=this.drawComponent.self.styleSettings[a['style']];var b=Ext.create('photoViewer.draw.Sprite',a);this.add('base0',b);this.show(!0)},getDefaultConfig:function(){var b=this.drawComponent.descaledXY,a=this.getViewModel();return {x:b[0],y:b[1],width:1,height:1,stroke:a.get('toolSettings.strokeColour'),'stroke-width':a.get('toolSettings.strokeWidth'),style:a.get('toolSettings.strokeStyle')}},getType:function(){return 'rectangle'}},0,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Rectangle'],0);Ext.cmd.derive('photoViewer.view.annotations.sprites.TextBox',Ext.form.field.TextArea,{fieldCls:'x-form-field annotationsTextBox',style:'position: absolute',setXY:function(a,e){if(!e&&this.unscaledXY&&this.unscaledXY[0]==a[0]&&this.unscaledXY[1]==a[1]){return}var d=this.shape.drawComponent,b=d.el.getBox(),c=d.getScale();this.unscaledXY=[a[0],a[1]];this.setPagePosition(Math.round(a[0]*c+b.left),Math.round(a[1]*c+b.top))},setWidth:function(a,b){if(!b&&this.unscaledWidth&&this.unscaledWidth==a||!a){return}this.unscaledWidth=a;Ext.form.field.TextArea.prototype.setWidth.call(this,Math.max(a*this.shape.drawComponent.getScale(),1))},setHeight:function(a,b){if(!b&&this.unscaledHeight&&this.unscaledHeight==a||!a){return}this.unscaledHeight=a;var a=Math.max(a*this.shape.drawComponent.getScale(),1);Ext.form.field.TextArea.prototype.setHeight.call(this,a);if(this.el.dom){this.getTextArea().style.height=Math.ceil(a)+'px'}},setBorderWeight:function(a){this.borderWeight=a;this.refresh()},getBorderWeight:function(){return this.borderWeight},setBorderStyle:function(a){this.borderStyle=a=='normal'?'solid':a;this.refresh()},getBorderStyle:function(){return this.borderStyle=='solid'?'normal':this.borderStyle},setBorderColour:function(a){this.borderColour=a;this.refresh()},getBorderColour:function(){return this.borderColour},setFontSize:function(a){this.fontSize=a;this.refresh()},getFontSize:function(){return this.fontSize},refresh:function(){if(!this.el){return}var b=this.shape.drawComponent.getScale();this.setWidth(this.unscaledWidth,!0);this.setHeight(this.unscaledHeight,!0);if(this.unscaledXY){this.setXY(this.unscaledXY,!0)}var a=this.getTextArea();a.style.border=this.borderWeight*b+'px '+this.borderStyle+' '+this.borderColour;a.style.color=this.borderColour;a.style.fontSize=''+(Number(this.fontSize)*b).toFixed(2)+'pt'},getUnscaledRelativeBox:function(){if(!this.unscaledXY){return {0:this.shape.config.x,1:this.shape.config.y,x:this.shape.config.x,y:this.shape.config.y,width:this.shape.config.width,height:this.shape.config.height,right:this.shape.config.x+this.shape.config.width,bottom:this.shape.config.y+this.shape.config.height}}return {0:this.unscaledXY[0],1:this.unscaledXY[1],x:this.unscaledXY[0],y:this.unscaledXY[1],width:this.unscaledWidth,height:this.unscaledHeight,right:this.unscaledXY[0]+this.unscaledWidth,bottom:this.unscaledXY[1]+this.unscaledHeight}},getRelativeBox:function(){var a=this.el.getBox(),c=this.shape.drawComponent,b=c.el.getBox();a[0]-=b.left;a[1]-=b.top;a.x-=b.left;a.y-=b.top;a.left=a.x;a.top=a.y;a.right-=b.left;a.bottom-=b.top;return a},getTextArea:function(){return this.el.dom.getElementsByTagName('textarea')[0]},listeners:{afterrender:function(a){var a=this;a.el.unselectable();var b=a.getTextArea();b.style.overflow='hidden';this.refresh();b.style.cursor='move';this.el.dom.style.zIndex=this.shape.drawComponent.el.dom.style.zIndex-0+1;this.el.addListener('mousemove',function(b){this.shape.drawComponent.fireEvent('mousemove',b)},this);this.el.addListener('mouseup',function(b){this.shape.drawComponent.fireEvent('mouseup',b)},this);this.el.dom.style.zIndex=this.shape.drawComponent.el.dom.style.zIndex},blur:function(b){var a=b.getTextArea();a.style.cursor='move';this.shape.editingText=!1;a.scrollTop=0;this.dd.disabled=!1},el:{click:function(){var a=Ext.getCmp(this.getId());if(a.shape.readOnly||a.shape.editingText){return}if(!a.shape.isSelected){a.shape.onClick()}else {a.dd.disabled=!0;var b=a.getTextArea();b.style.cursor='text';b.focus();a.shape.editingText=!0}},scope:'this'}}},0,['annotationstextbox'],['component','box','field','textfield','textareafield','textarea','annotationstextbox'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'textareafield':!0,'textarea':!0,'annotationstextbox':!0},['widget.annotationstextbox'],0,[photoViewer.view.annotations.sprites,'TextBox'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Text',photoViewer.view.annotations.shapes.Base,{shapeAttributes:['x','y','width','height','stroke','text','aX0','aY0','aX1','aY1','stroke-width','style','font-size'],nBaseSprites:2,defaultStemLength:80,defaultWidth:460,defaultHeight:90,hasArrow:!0,initConfig:function(a){if(!a){return}var f=this;if(!a['font-size']){a['font-size']=Math.round(24+(a['stroke-width']-4)*1.5)}photoViewer.view.annotations.shapes.Base.prototype.initConfig.apply(this,arguments);if(this.hasArrow){var g=Ext.create('photoViewer.view.annotations.sprites.Arrow',{draggable:!this.readOnly,x0:a.aX0,y0:a.aY0,x1:a.aX1,y1:a.aY1,'stroke-width':a['stroke-width'],'stroke':a.stroke,'stroke-dasharray':this.drawComponent.self.styleSettings[a['style']]});this.add('base0',g);var b=a.aX0,c=a.aY0;if(a.aY0<=a.y){this.stemPosition=0;c=a.y}else {if(a.aX0>=a.x+a.width){this.stemPosition=1;b=a.x+a.width}else {if(a.aY0>=a.y+a.height){this.stemPosition=2;c=a.y+a.height}else {this.stemPosition=3;b=a.x}}}var i=Ext.create('photoViewer.view.annotations.sprites.Line',{draggable:!this.readOnly,x0:b,y0:c,x1:a.aX0,y1:a.aY0,'stroke-width':a['stroke-width'],'stroke':a.stroke,'stroke-dasharray':this.drawComponent.self.styleSettings[a['style']]});this.add('base1',i)}var h=a.style=='normal'?'solid':a.style,d=!this.readOnly;this.textBox=this.drawComponent.up('photoviewer').lookupController().lookupReference('photoContainer').add({xtype:'annotationstextbox',value:a.text,borderStyle:h,borderWeight:a['stroke-width'],borderColour:a.stroke,shape:this,draggable:d,disabled:this.readOnly,left:a.x,top:a.y});var e=function(){this.textBox.setWidth(a.width);this.textBox.setHeight(a.height);this.textBox.setXY([a.x,a.y]);this.textBox.setFontSize(a['font-size']);this.currText=a.text;if(this.hasArrow){this.fixArrowIntersection(!0)}var b=this;if(d){this.textBox.initDraggable();Ext.override(this.textBox.dd,{onDrag:function(c){b.isSelected=!0;b.spriteGroupMove(b.textBox.dd,b.textBox,c)},onMouseDown:function(c,b){if(f.editingText){return}return this.callParent(arguments)},onMouseUp:function(c){b.textBox.prevOffset=undefined;if(f.editingText){return}return this.callParent(arguments)},onMouseMove:function(d,c){if(b.editingText){return}this.callParent(arguments)}});this.textBox.dd.addListener('mouseup',function(c,d){if(this.lastXY[0]==this.startXY[0]&&this.lastXY[1]==this.startXY[1]){b.textBox.fireEvent('click',b.textBox)}else {b.afterMove()}})}this.drawComponent.addListener('move',b.textBox.refresh,b.textBox)};if(this.textBox.el){e.call(this)}else {this.textBox.addListener('afterrender',e,this,{single:!0})}this.show(!0)},getAttribute:function(a){if(a=='text'){return this.textBox.value}else {if(a=='stroke'){return this.textBox.getBorderColour()}else {if(a=='stroke-width'){return this.textBox.getBorderWeight()}else {if(a=='x'||a=='y'||a=='width'||a=='height'){var b=this.textBox.getUnscaledRelativeBox();return Math.round(b[a])}else {if(a=='style'){return this.textBox.getBorderStyle()}else {if(a=='aX0'){return this.hasArrow?Math.round(this.getByKey('base0').x0):0}else {if(a=='aY0'){return this.hasArrow?Math.round(this.getByKey('base0').y0):0}else {if(a=='aX1'){return this.hasArrow?Math.round(this.getByKey('base0').x1):0}else {if(a=='aY1'){return this.hasArrow?Math.round(this.getByKey('base0').y1):0}else {if(a=='font-size'){return this.textBox.getFontSize()}}}}}}}}}}return undefined},resize:function(c,d,b,a){this.textBox.setXY([c,d]);this.textBox.setHeight(a);this.textBox.setWidth(b);if(this.hasArrow){this.fixStemCoords()}},deselect:function(){if(!this.isSelected){return !1}this.textBox.blur();if(this.textBox.value!=this.currText){this.fireEvent('datachanged');this.currText=this.textBox.value}return photoViewer.view.annotations.shapes.Base.prototype.deselect.apply(this,arguments)},getType:function(){return 'text'},isTooSmall:function(){return !1},getDefaultConfig:function(){var b=this.drawComponent.descaledXY,a=this.getViewModel(),e=b[0]-this.defaultWidth/2,f=b[1]-this.defaultHeight/2,c=a.get('toolSettings.strokeWidth'),d=this.getStemSideCoordinates(3,e,f,this.defaultWidth,this.defaultHeight,c);return {x:e,y:f,width:this.defaultWidth,height:this.defaultHeight,stroke:a.get('toolSettings.strokeColour'),text:'','aX1':b[0],'aY1':b[1],'aX0':d.x1,'aY0':d.y1,'stroke-width':c,'style':a.get('toolSettings.strokeStyle'),'font-size':a.get('toolSettings.fontSize')}},translate:function(c,d){var e=this.getViewModel().get('naturalWidth'),f=this.getViewModel().get('naturalHeight'),a=this.textBox.getUnscaledRelativeBox(),g=this.hasArrow?this.getByKey('base0'):null,b=this.hasArrow?this.getByKey('base1'):null;if(a.x+c<0||a.x+c+a.width>e||a.y+d<0||a.y+d+a.height>f){return}this.textBox.setXY([a.x+c,a.y+d]);if(this.hasArrow){b.setAttributes({x0:Math.min(e,Math.max(0,b.x0+c)),y0:Math.min(f,Math.max(0,b.y0+d)),x1:Math.min(e,Math.max(0,b.x1+c)),y1:Math.min(f,Math.max(0,b.y1+d))},!0);g.setAttributes({x0:b.x1,y0:b.y1},!0);this.fixArrowIntersection()}},fixStemCoords:function(){var c=this.textBox.getUnscaledRelativeBox(),a=this.getByKey('base1'),g=this.getByKey('base0'),h=c.x-c.x,i=c.y-c.y,e=this.getViewModel().get('naturalWidth'),f=this.getViewModel().get('naturalHeight'),b={};if((this.stemPosition==0||this.stemPosition==2)&&(a.x0<c.x||a.x0>c.x+c.width)||(this.stemPosition==1||this.stemPosition==3)&&(a.y0<c.y||a.y0>c.y+c.height)){b=this.getStemSideCoordinates(this.stemPosition,c.x,c.y,c.width,c.height,a.attr['stroke-width'])}else {var d=Math.getLineLength([a.x0,a.y0],[a.x1,a.y1]);if(this.stemPosition===0){b.y0=c.y;if(Math.getLineLength([a.x0,b.y0],[a.x1,a.y1])<d&&b.y0-a.y1<this.defaultStemLength){b.y1=Math.max(0,b.y0-this.defaultStemLength)}}else {if(this.stemPosition===1){b.x0=c.right;if(Math.getLineLength([b.x0,a.y0],[a.x1,a.y1])<d&&a.x1-b.x0<this.defaultStemLength){b.x1=Math.min(e,b.x0+this.defaultStemLength)}}else {if(this.stemPosition===2){b.y0=c.bottom;if(Math.getLineLength([a.x0,b.y0],[a.x1,a.y1])<d&&a.y1-b.y0<this.defaultStemLength){b.y1=Math.min(f,b.y0+this.defaultStemLength)}}else {if(this.stemPosition===3){b.x0=c.x;if(Math.getLineLength([b.x0,a.y0],[a.x1,a.y1])<d&&b.x0-a.x1<this.defaultStemLength){b.x1=Math.max(0,b.x0-this.defaultStemLength)}}}}}}a.setAttributes(b,!0);this.fixArrowIntersection();this.refreshSelectionSprites()},getStemSideCoordinates:function(e,a,b,g,f,h){var c=a+g/2-h/2;var d=b+f/2+h/2;if(e===0){return {x0:c,y0:b,x1:c,y1:b-this.defaultStemLength}}if(e===1){return {x0:a+g,y0:d,x1:a+g+this.defaultStemLength,y1:d}}if(e===2){return {x0:c,y0:b+f,x1:c,y1:b+f+this.defaultStemLength}}if(e===3){return {x0:a,y0:d,x1:a-this.defaultStemLength,y1:d}}},moveStemToSide:function(c,h,i,g,f,d,e){this.stemPosition=c;var a=this.getStemSideCoordinates(c,h,i,g,f,d);var b={x0:a.x0,y0:a.y0};if(e){b.x1=a.x1;b.y1=a.y1}this.getByKey('base1').setAttributes(b,!0)},arrowIntersectsSide:function(f){var c=this.getByKey('base0'),d=this.textBox.getUnscaledRelativeBox(),i=d.width,e=d.height,a=d.x,b=d.y,j=c.attr['stroke-width'];var g=[a,b],h=[a+i,b];if(f===1){g=[a+i,b+e]}if(f===2){g=[a,b+e];h=[a+i,b+e]}if(f===3){h=[a,b+e]}return Math.segmentsIntersect(g,h,[c.x0,c.y0],[c.x1,c.y1])},fixArrowIntersection:function(m){var f=this.getByKey('base0'),l=this.getByKey('base1'),g=this.textBox.getUnscaledRelativeBox();var b=g.width,e=g.height,a=g.x,c=g.y,d=f.attr['stroke-width'];var k=this.arrowIntersectsSide(0),i=this.arrowIntersectsSide(1),h=this.arrowIntersectsSide(2),j=this.arrowIntersectsSide(3);if(j&&k){if(f.x1<=a){this.moveStemToSide(3,a,c,b,e,d,!0)}else {this.moveStemToSide(0,a,c,b,e,d,!0)}}else {if(i&&k){if(f.x1>=a+b){this.moveStemToSide(1,a,c,b,e,d,!0)}else {this.moveStemToSide(0,a,c,b,e,d,!0)}}else {if(j&&h){if(f.x1<=a){this.moveStemToSide(3,a,c,b,e,d,!0)}else {this.moveStemToSide(2,a,c,b,e,d,!0)}}else {if(i&&h){if(f.x1>=a+b){this.moveStemToSide(1,a,c,b,e,d,!0)}else {this.moveStemToSide(2,a,c,b,e,d,!0)}}else {if(k&&h){if(f.y1<=c){this.moveStemToSide(0,a,c,b,e,d,!0)}else {this.moveStemToSide(2,a,c,b,e,d,!0)}}else {if(i&&j){if(f.x1<=a){this.moveStemToSide(3,a,c,b,e,d,!0)}else {this.moveStemToSide(1,a,c,b,e,d,!0)}}}}}}}f.setAttributes({x0:l.x1,y0:l.y1,x1:f.x1,y1:f.y1},!0);if(!m){this.fireEvent('datachanged')}},afterMove:function(){if(!this.hasArrow){return}var f=this.getByKey('base1'),b=this.getByKey('base0'),a=this.textBox.getUnscaledRelativeBox();if(b.x1>=a.x&&b.x1<=a.x+a.width&&b.y1>=a.y&&b.y1<=a.y+a.height){var d=b.x1-a.x,c=a.x+a.width-b.x1;var e=d+this.defaultStemLength;if(Math.min(c,d)==c&&a.x-(c+this.defaultStemLength)>0){e=0-c-this.defaultStemLength}this.translate(e,0);this.refreshSelectionSprites();this.fireEvent('datachanged')}},refreshSelectionSprites:function(f){var h=this.getByKey('resizeHandle0');var g=this.textBox.getUnscaledRelativeBox();var a=this.getByKey('base0');if(!h){for(var d=0;d<8;d++){var i=Ext.create('photoViewer.view.annotations.sprites.resizeHandle',{boundingBox:g,position:d,drawComponent:this.drawComponent});this.add('resizeHandle'+d,i)}if(this.hasArrow){var c=Ext.create('photoViewer.view.annotations.sprites.pointHandle',{x:a.x0,y:a.y0,pointNumber:0,drawComponent:this.drawComponent});this.add('pointHandle0',c);var b=Ext.create('photoViewer.view.annotations.sprites.pointHandle',{x:a.x1,y:a.y1,pointNumber:1,drawComponent:this.drawComponent});this.add('pointHandle1',b);var j=this;Ext.override(b.dd,{onMouseUp:function(){j.afterMove()}})}}else {for(var e=0;e<8;e++){this.getByKey('resizeHandle'+e).refreshPosition(g)}if(this.hasArrow){var c=this.getByKey('pointHandle0'),b=this.getByKey('pointHandle1');if(f!==0){c.setAttributes({x:a.x0,y:a.y0},!0);c.show(!0)}if(f!==1){b.setAttributes({x:a.x1,y:a.y1},!0);b.show(!0)}}}},removeSelectionSprites:function(){for(var a=0;a<8;a++){var b=this.getByKey('resizeHandle'+a);if(b){b.hide(!0)}else {return}}if(this.hasArrow){for(var a=0;a<2;a++){this.getByKey('pointHandle'+a).hide(!0)}}},changePointOnDragHandle:function(d,b,c){var a=this.drawComponent.getController().getRelativeDescaledXYFromMouseEvent(c);this.movePointHandle(b.pointNumber,a[0],a[1]);this.refreshSelectionSprites()},movePointHandle:function(g,b,c){var h=this.getViewModel().get('naturalWidth');var i=this.getViewModel().get('naturalHeight');if(b<0){b=0}else {if(b>h){b=h}}if(c<0){c=0}else {if(c>i){c=i}}var d=this.getByKey('base0');var e=d.x0,f=d.y0,j=d.x1,k=d.y1;if(g===0){var a=this.textBox.getUnscaledRelativeBox();if(this.stemPosition==0&&c>a.y){c=a.y}if(this.stemPosition==1&&b<a.x+a.width){b=a.x+a.width}if(this.stemPosition==2&&c<a.y+a.height){c=a.y+a.height}if(this.stemPosition==3&&b>a.x){b=a.x}if(this.stemPosition===0||this.stemPosition==2){f=c}else {e=b}}else {j=b;k=c}d.setAttributes({x0:e,y0:f,x1:j,y1:k},!0);if(g===0){this.getByKey('base1').setAttributes({x1:e,y1:f},!0)}this.fixArrowIntersection()},setScale:function(a){this.textBox.refresh();this.callParent(arguments)},destroy:function(){this.drawComponent.removeListener('move',this.textBox.refresh,this.textBox);this.textBox.destroy();photoViewer.view.annotations.shapes.Base.prototype.destroy.apply(this,arguments)},setStrokeWidth:function(a){if(this.hasArrow){this.getByKey('base1').setAttributes({'stroke-width':a},!0)}this.textBox.setBorderWeight(a);photoViewer.view.annotations.shapes.Base.prototype.setStrokeWidth.apply(this,arguments)},setStrokeStyle:function(a){if(this.hasArrow){this.getByKey('base1').setAttributes({'stroke-dasharray':this.drawComponent.self.styleSettings[a]},!0)}this.textBox.setBorderStyle(a);photoViewer.view.annotations.shapes.Base.prototype.setStrokeStyle.apply(this,arguments)},setColour:function(a){this.textBox.setBorderColour(a);photoViewer.view.annotations.shapes.Base.prototype.setColour.apply(this,arguments)},setFontSize:function(a){var b=this.getAttribute('font-size');this.textBox.setFontSize(a);if(a!=b){this.drawComponent.lookupViewModel().set('toolSettings.fontSize',a);this.fireEvent('datachanged')}},getCanResizeFlip:function(){return !1},getMinWidth:function(){return Math.max((48+this.getAttribute('stroke-width')*2)/this.drawComponent.getScale(),100)},getMinHeight:function(){return Math.max((48+this.getAttribute('stroke-width')*2)/this.drawComponent.getScale(),100)},onZoomChange:function(){if(this.textBox){this.textBox.refresh()}},hide:function(){photoViewer.view.annotations.shapes.Base.prototype.hide.apply(this,arguments);this.textBox.hide()},show:function(){photoViewer.view.annotations.shapes.Base.prototype.show.apply(this,arguments);this.textBox.show();this.textBox.refresh()}},0,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Text'],0);Ext.cmd.derive('photoViewer.view.annotations.shapes.Textbox',photoViewer.view.annotations.shapes.Text,{nBaseSprites:0,hasArrow:!1,defaultWidth:100,defaultHeight:75,minWidth:100,minHeight:75,getType:function(){return 'textbox'}},0,0,0,0,0,0,[photoViewer.view.annotations.shapes,'Textbox'],0);Ext.cmd.derive('photoViewer.view.annotations.sprites.Info',Ext.Component,{cls:'photoviewer-measurement-info',floating:!0,shadow:!1,tpl:new Ext.Template('<div class="name">{TitleDisplayName}:</div><div class="measurement">{MeasurementString}</div>')},0,['annotationsinfo'],['component','box','annotationsinfo'],{'component':!0,'box':!0,'annotationsinfo':!0},['widget.annotationsinfo'],0,[photoViewer.view.annotations.sprites,'Info'],0);Ext.cmd.derive('photoViewer.view.annotations.sprites.selectionBox',photoViewer.draw.Sprite,{constructor:function(a){this.initConfig(a);photoViewer.draw.Sprite.prototype.constructor.apply(this,arguments)},bboxExcluded:!0,initConfig:function(a){a.x=a.boundingBox.x;a.y=a.boundingBox.y;a.width=a.boundingBox.width;a.height=a.boundingBox.height;delete a.boundingBox;a.type='rect';a.stroke='white';if(typeof a['stroke-width']==='undefined'){a['stroke-width']=1}a.draggable=!0;this.callParent(arguments)},resize:function(d,e,f,g){var a=this.attr?this.attr:this;var b=a.x;var c=a.y;if(f){b-=d}if(g){c-=e}var i=a.width+d;var h=a.height+e;this.setAttributes({width:i,height:h,x:b,y:c},!0)}},1,0,0,0,0,0,[photoViewer.view.annotations.sprites,'selectionBox'],0);Ext.cmd.derive('photoViewer.view.annotations.tools.PhotoViewerToolButton',Ext.button.Button,{enableToggle:!0,defaultListenerScope:'this',width:61,height:61,scale:'large',padding:14,ui:'annotationtool',config:{iconAlign:'top'},listeners:{click:'onButtonClick'},onButtonClick:function(){this.up('photoviewerannotationstoolwindow').doButtonToggle(this);this.changeMode(this)},changeMode:function(a){if(a.controlMode){this.lookupViewModel().set('toolSettings.mode',a.controlMode)}}},0,['photoviewertoolbutton'],['component','box','button','photoviewertoolbutton'],{'component':!0,'box':!0,'button':!0,'photoviewertoolbutton':!0},['widget.photoviewertoolbutton'],0,[photoViewer.view.annotations.tools,'PhotoViewerToolButton'],0);Ext.cmd.derive('photoViewer.view.annotations.tools.PhotoViewerToolMenuButton',photoViewer.view.annotations.tools.PhotoViewerToolButton,{config:{menuOptions:[],activeButton:null,menuCls:'',iconAlign:'right',menuAlign:'br-tr?'},initComponent:function(){var a=this.getMenuOptions(),c=[];for(var b=0;b<a.length;b++){a[b].listeners={click:{fn:this.onMenuButtonClick,scope:this}};if(a[b].icon){c.push(a[b].icon)}}this.setMvPreloadImages(c);this.setIcon(a[0].icon);this.setMenu({ui:'annotationtool',cls:this.getMenuCls(),showSeparator:!1,items:a,shadow:!1});photoViewer.view.annotations.tools.PhotoViewerToolButton.prototype.initComponent.apply(this,arguments);this.setActiveButton(this.getMenu().items.items[0])},onButtonClick:function(){this.up('photoviewerannotationstoolwindow').doButtonToggle(this);this.changeMode(this.getActiveButton())},onMenuButtonClick:function(a){this.changeMode(a);this.setIcon(a.icon);this.setActiveButton(a)}},0,['photoviewertoolmenubutton'],['component','box','button','photoviewertoolbutton','photoviewertoolmenubutton'],{'component':!0,'box':!0,'button':!0,'photoviewertoolbutton':!0,'photoviewertoolmenubutton':!0},['widget.photoviewertoolmenubutton'],0,[photoViewer.view.annotations.tools,'PhotoViewerToolMenuButton'],0);Ext.cmd.derive('photoViewer.view.annotations.tools.PhotoViewerStrokeStyle',photoViewer.view.annotations.tools.PhotoViewerToolMenuButton,{config:{menuOptions:[{icon:'mds/image/component/annotations/style_solid.png',value:'normal'},{icon:'mds/image/component/annotations/style_dashed.png',value:'dashed'},{icon:'mds/image/component/annotations/style_dotted.png',value:'dotted'}],activeButton:null,scale:'small',menuCls:'small',localized:{text:'PAT_Style'},labelAlign:'left',width:60,height:14,enableToggle:!1,padding:0,menuAlign:'tr-br?'},onMenuButtonClick:function(a){this.fireEvent('change',this,a.value);this.setIcon(a.icon);this.setActiveButton(a)},onButtonClick:Ext.emptyFn,setValue:function(e){var b=this.getMenuOptions(),a;for(a=0;a<b.length;a++){if(b[a].value==e){this.fireEvent('change',this,b[a].value);this.setIcon(b[a].icon);var d=this.getMenu(),c=d?d.items.items:null;if(c){this.setActiveButton(c[a])}}}}},0,['photoviewerstrokestyle'],['component','box','button','photoviewertoolbutton','photoviewertoolmenubutton','photoviewerstrokestyle'],{'component':!0,'box':!0,'button':!0,'photoviewertoolbutton':!0,'photoviewertoolmenubutton':!0,'photoviewerstrokestyle':!0},['widget.photoviewerstrokestyle'],0,[photoViewer.view.annotations.tools,'PhotoViewerStrokeStyle'],0);Ext.cmd.derive('photoViewer.view.annotations.tools.ToolWindow',Ext.panel.Panel,{reference:'annotationsTW',closeAction:'hide',draggable:!0,resizable:!1,defaultType:'button',controller:'toolwindow',hidden:!0,floating:!0,shadow:!1,defaultAlign:'bc-bc?',layout:{type:'hbox',align:'center'},items:[{reference:'annotationsSelectButton',xtype:'photoviewertoolbutton',icon:'mds/image/icon/annotations/select.png',localized:{tooltip:'PAT_Selection Tool'},controlMode:'select'},{xtype:'photoviewertoolbutton',icon:'mds/image/icon/annotations/pen.png',controlMode:'pen',localized:{tooltip:'PAT_Pen Tool'}},{xtype:'photoviewertoolmenubutton',menuOptions:[{icon:'mds/image/icon/annotations/line.png',controlMode:'line',localized:{tooltip:'PAT_Line Tool'}},{icon:'mds/image/icon/annotations/arrow.png',controlMode:'arrow',localized:{tooltip:'PAT_Arrow Tool'}}]},{xtype:'photoviewertoolmenubutton',menuOptions:[{icon:'mds/image/icon/annotations/square.png',controlMode:'rectangle',localized:{tooltip:'PAT_Rectangle Tool'}},{icon:'mds/image/icon/annotations/circle.png',controlMode:'ellipse',localized:{tooltip:'PAT_Ellipse Tool'}}]},{xtype:'photoviewertoolmenubutton',cls:'text-tool',margin:'0 15 0 0',menuOptions:[{icon:'mds/image/icon/annotations/textbox.png',controlMode:'textbox',localized:{tooltip:'PAT_Text Box Tool'}},{icon:'mds/image/icon/annotations/callout.png',controlMode:'text',localized:{tooltip:'PAT_Callout Tool'}}]},{xtype:'rangeCombo',ui:'annotationtool',reference:'fontSizePicker',localized:{fieldLabel:'PAT_Font Size'},labelSeparator:'',labelWidth:45,margin:'0 14 0 0',min:12,max:100,pickerAlign:'tl-bl?',pickerOffset:[0,1],listConfig:{cls:'annotationtool-list',height:100,shadow:!1},bind:{value:'{toolSettings.fontSize}'},listeners:{change:'onFontSizeChange'}},{xtype:'simplecolorwidget',popupUi:'dark',popupShadow:!1,reference:'strokeColourSample',bind:{value:'{annotationsStrokeColourNoHash}'},width:33,height:33},{xtype:'container',layout:'vbox',margin:'0 25 0 18',items:[{xtype:'rangeCombo',reference:'strokeWidthPicker',localized:{fieldLabel:'PAT_Width'},labelSeparator:'',labelWidth:29,ui:'annotationtool',min:1,max:50,pickerAlign:'tl-bl?',pickerOffset:[0,1],listConfig:{cls:'annotationtool-list',height:100,shadow:!1},listeners:{change:'onStrokeWidthChange'}},{xtype:'photoviewerstrokestyle',reference:'strokeStylePicker',listeners:{change:'onStrokeStyleChange'}}]}],listeners:{beforeshow:'onBeforeShow',hide:'onHide'},constructor:function(){Ext.panel.Panel.prototype.constructor.apply(this,arguments)},doButtonToggle:function(b){if(!b.pressed){b.toggle()}for(var c=0;c<this.items.length;c++){var a=this.items.getAt(c);if(a!=b&&a.pressed){a.toggle()}}}},1,['photoviewerannotationstoolwindow'],['component','box','container','panel','photoviewerannotationstoolwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewerannotationstoolwindow':!0},['widget.photoviewerannotationstoolwindow'],0,[photoViewer.view.annotations.tools,'ToolWindow'],0);Ext.cmd.derive('photoViewer.view.annotations.tools.ToolWindowController',Ext.app.ViewController,{MemberUIDArray:[],statics:{defaultStrokeColour:'#FF6600',defaultStrokeWidth:4,defaultStrokeStyle:'normal',defaultFontSize:24},onStrokeColourClick:function(){this.lookupReference('strokeColourPickerWindow').showBy(this.lookupReference('strokeColourSample'),'tl-tr',[5,0])},onBeforeShow:function(){this.setDefaults();Ext.getDoc().addListener('click',this.checkClick,this)},onHide:function(){Ext.getDoc().removeListener('click',this.checkClick,this)},onStrokeStyleChange:function(b,a){if(!a){return}this.getViewModel().set('toolSettings.strokeStyle',a);if(b.isVisible()){this.getPhotoController().setSelectedShapeStrokeStyle(a)}},onStrokeWidthChange:function(b,a){this.getViewModel().set('toolSettings.strokeWidth',a);if(b.isVisible()){this.getPhotoController().setSelectedShapeStrokeWidth(a)}},onFontSizeChange:function(b,a){this.getViewModel().set('toolSettings.fontSize',a);if(b.isVisible()){this.getPhotoController().setSelectedShapeFontSize(a)}},onShareTypeChange:function(a){this.getPhotoController().setRecordSelectedShapeShareType(a.selectedShareType,a.selectedMemberList?a.selectedMemberList.split(','):[])},getControlMode:function(){return this.getViewModel().get('toolSettings.mode')},getFontSize:function(){return this.getViewModel().get('toolSettings.fontSize')},checkClick:function(b){var c=this.lookupReference('strokeColourPickerWindow'),a=b.getTarget();if(!a){return}},setDefaults:function(){var a=this.getViewModel(),b=this.lookupReference('annotationsSelectButton');a.set('toolSettings.strokeColour',this.self.defaultStrokeColour);a.set('toolSettings.strokeWidth',this.self.defaultStrokeWidth);a.set('toolSettings.fontSize',this.self.defaultFontSize);this.lookupReference('strokeWidthPicker').setValue(this.self.defaultStrokeWidth);this.lookupReference('strokeStylePicker').setValue(this.self.defaultStrokeStyle);b.toggle();this.getViewModel().set('toolSettings.mode',b.controlMode)},resetSelectedButton:function(){var c=this.getControlMode(),b=this.items.items;if(c){for(var a=0;a<b.length;a++){if(b[a].controlMode==c){b[a].fireEvent('click',b[a]);break}}}},onFontSizePickerShow:function(){this.lookupReference('fontSizePicker').setValue(this.getViewModel().get('toolSettings.fontSize'))},onStrokeStylePickerShow:function(){this.lookupReference('strokeStylePicker').setValue(this.getViewModel().get('toolSettings.strokeStyle'))},onStrokeWidthPickerShow:function(){this.lookupReference('strokeWidthPicker').setValue(this.getViewModel().get('toolSettings.strokeWidth'))},getPhotoController:function(){return this.getView().up('photoviewer').lookupController().lookupReference('photoContainer').lookupReference('photo').lookupController()}},0,0,0,0,['controller.toolwindow'],0,[photoViewer.view.annotations.tools,'ToolWindowController'],0);Ext.cmd.derive('photoViewer.view.annotations.widget.rangeCombo',Ext.form.field.ComboBox,{constructor:function(a){a.store=Ext.create('Ext.data.Store',{fields:['value','display'],idProperty:'value',data:[]});var d=this;for(var b=a.min;b<=a.max;b++){var c=b;if(a.unit){c+=a.unit}a.store.add({value:b,display:c})}Ext.form.field.ComboBox.prototype.constructor.apply(this,arguments)},queryMode:'local',valueField:'value',displayField:'display',editable:!1,autoSelect:!0},1,['rangeCombo'],['component','box','field','textfield','pickerfield','combobox','combo','rangeCombo'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'rangeCombo':!0},['widget.rangeCombo'],0,[photoViewer.view.annotations.widget,'rangeCombo'],0);Ext.cmd.derive('photoViewer.view.exif.Exif',Ext.grid.Panel,{localized:{title:'EXIF_Exif Data'},width:375,height:300,closable:!0,closeAction:'hide',hidden:!0,floating:!0,resizable:!0,draggable:!0,controller:'exif',viewModel:{stores:{exifData:{type:'exifdata',listeners:{load:'exifDataStoreLoaded'}}}},bind:{store:'{exifData}'},dockedItems:[{xtype:'toolbar',dock:'bottom',items:[{xtype:'checkbox',reference:'exifShowTagsCheckbox',localized:{boxLabel:'EXIF_Show All Tags'},listeners:{change:'toggleExifShowAllTags'}}],padding:'0 0 5 5'}],columns:[{localized:{text:'EXIF_Tag Name'},dataIndex:'name',width:150},{localized:{text:'EXIF_Tag Value'},dataIndex:'description',width:200}]},0,['photoviewerexif'],['component','box','container','panel','tablepanel','gridpanel','grid','photoviewerexif'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tablepanel':!0,'gridpanel':!0,'grid':!0,'photoviewerexif':!0},['widget.photoviewerexif'],0,[photoViewer.view.exif,'Exif'],0);Ext.cmd.derive('photoViewer.view.exif.ExifController',Ext.app.ViewController,{exifDataStoreLoaded:function(){this.getStore('exifData').filterTags();this.lookupReference('exifShowTagsCheckbox').setValue(!1)},toggleExifShowAllTags:function(c,b){var a=this.getStore('exifData');if(b){a.unFilterTags()}else {a.filterTags()}},showExifInfo:function(){this.getView().show();var a=this.getStore('exifData'),b=this.getView().lookupViewModel();a.getProxy().setExtraParam('id',this.getView().lookupViewModel().get('activePhoto.id'));a.getProxy().setExtraParam('projectUID',b.get('ProjectUID'));a.getProxy().setExtraParam('webcamUID',b.get('activePhoto.WebcamUID'));Ext.getBody().mask('Loading ...');a.addListener('load',function(){Ext.getBody().unmask()},this,{single:!0});a.load()}},0,0,0,0,['controller.exif'],0,[photoViewer.view.exif,'ExifController'],0);Ext.cmd.derive('photoViewer.view.webcam.WebcamCustomSlideshow',Ext.window.Window,{modal:!0,modalMaskCls:'dark-mask',ui:'orange',closeAction:'hide',height:500,width:500,alwaysOnTop:2,layout:{type:'vbox',align:'stretchmax'},localized:{title:'WVA_Custom Slideshow Recu'},items:[{xtype:'container',layout:{type:'vbox',pack:'center',align:'stretchmax'},height:'100%',padding:15,items:[{xtype:'container',layout:{type:'hbox'},margin:5,items:[{xtype:'container',layout:{type:'vbox'},defaults:{xtype:'datefield',ui:'detail-form',labelWidth:70,cls:'with-icon',labelSeparator:'',localized:{format:'DATE_Medium'},width:200},items:[{reference:'csStartDate',localized:{fieldLabel:'WVA_Start Date'}},{reference:'csEndDate',localized:{fieldLabel:'WVA_End Date'}}]},{xtype:'container',layout:{type:'vbox'},items:[{xtype:'container',layout:{type:'hbox'},items:[{xtype:'radio',ui:'plain-radio-16',name:'csSelectionType',reference:'csSelectionType',cls:'csSelectionType',localized:{boxLabel:'WVA_Time'},checked:!0,margin:'0 5 0 25',inputValue:'time',bind:{value:'{hasTargetTime}'}},{xtype:'detailformcombo',reference:'csHour',bind:{disabled:'{!hasTargetTime}'},width:86,store:Ext.create('Ext.data.Store',{fields:['text','value'],proxy:'memory',data:[{text:'12 AM',value:0},{text:'1 AM',value:1},{text:'2 AM',value:2},{text:'3 AM',value:3},{text:'4 AM',value:4},{text:'5 AM',value:5},{text:'6 AM',value:6},{text:'7 AM',value:7},{text:'8 AM',value:8},{text:'9 AM',value:9},{text:'10 AM',value:10},{text:'11 AM',value:11},{text:'12 PM',value:12},{text:'1 PM',value:13},{text:'2 PM',value:14},{text:'3 PM',value:15},{text:'4 PM',value:16},{text:'5 PM',value:17},{text:'6 PM',value:18},{text:'7 PM',value:19},{text:'8 PM',value:20},{text:'9 PM',value:21},{text:'10 PM',value:22},{text:'11 PM',value:23}]}),valueField:'value',editable:!1,listeners:{afterrender:function(a){a.setValue(12)}}},{xtype:'detailformcombo',reference:'csMinute',bind:{disabled:'{!hasTargetTime}'},width:68,store:Ext.create('Ext.data.Store',{fields:['text','value'],proxy:'memory',data:[{text:':00',value:0},{text:':15',value:15},{text:':30',value:30},{text:':45',value:45}]}),valueField:'value',editable:!1,listeners:{afterrender:function(a){a.setValue(0)}}}]},{xtype:'radio',ui:'plain-radio-16',name:'csSelectionType',cls:'csSelectionType',localized:{boxLabel:'WVA_All Photos'},inputValue:'allPhotos',margin:'10 5 0 25'},{xtype:'radio',ui:'plain-radio-16',name:'csSelectionType',cls:'csSelectionType',localized:{boxLabel:'WVA_Commented'},inputValue:'commented',margin:'10 5 0 25'}]}]},{xtype:'component',flex:1,html:'<hr>',margin:'0 0 5 0'},{xtype:'container',layout:{type:'hbox'},items:[{xtype:'radiogroup',reference:'csSelectionRadioGroup',layout:{type:'vbox'},defaults:{name:'csRecurrenceType',ui:'plain-radio-16',margin:'0 0 5 5'},bind:{disabled:'{!hasTargetTime}'},items:[{localized:{boxLabel:'WVA_Daily'},inputValue:'daily',checked:!0},{localized:{boxLabel:'WVA_Weekly'},inputValue:'weekly'},{localized:{boxLabel:'WVA_Monthly'},inputValue:'monthly'}],listeners:{change:function(a,c,e){var b=a.up('webcamcustomslideshow'),d=b.down('[reference=csRecurrenceTypeCards]');d.getLayout().setActiveItem(c.csRecurrenceType+'Card')}}},{xtype:'component',flex:1},{xtype:'panel',cls:'cs-panel',reference:'csRecurrenceTypeCards',layout:{type:'card'},width:300,height:230,defaults:{padding:5},bind:{disabled:'{!hasTargetTime}'},items:[{itemId:'dailyCard',xtype:'container',layout:{type:'vbox'},items:[{xtype:'container',layout:{type:'hbox',align:'middle'},items:[{xtype:'numberfield',ui:'detail-form',reference:'csRecurrenceX',localized:{fieldLabel:'WVA_Recur every'},labelWidth:75,labelSeparator:'',width:145,value:1,minValue:1},{xtype:'label',ui:'detail-form',localized:{text:'WVA_day(s)'},margin:'0 0 0 5'}]},{flex:1,border:0}]},{itemId:'weeklyCard',xtype:'container',layout:{type:'vbox'},items:[{xtype:'container',layout:{type:'hbox',align:'middle'},items:[{xtype:'numberfield',ui:'detail-form',reference:'csRecurrenceX',localized:{fieldLabel:'WVA_Recur every'},labelWidth:75,labelSeparator:'',width:145,value:1,minValue:1},{xtype:'label',ui:'detail-form',localized:{text:'WVA_week(s) on'},margin:'0 0 0 5'}]},{xtype:'checkboxgroup',reference:'csWeekdays',flex:1,layout:{type:'vbox'},margin:'5 0 0 0',defaults:{ui:'plain-16',name:'csWeekdays'},allowBlank:!1,items:[{boxLabel:Ext.Date.dayNames[0],inputValue:1},{boxLabel:Ext.Date.dayNames[1],inputValue:2},{boxLabel:Ext.Date.dayNames[2],inputValue:3},{boxLabel:Ext.Date.dayNames[3],inputValue:4},{boxLabel:Ext.Date.dayNames[4],inputValue:5},{boxLabel:Ext.Date.dayNames[5],inputValue:6},{boxLabel:Ext.Date.dayNames[6],inputValue:7}]}]},{itemId:'monthlyCard',xtype:'container',layout:{type:'vbox'},items:[{xtype:'container',layout:{type:'hbox',align:'middle'},items:[{xtype:'numberfield',ui:'detail-form',reference:'csDayOfMonth',fieldLabel:'Day',labelWidth:23,labelSeparator:'',width:83,value:15,minValue:1,maxValue:31},{xtype:'label',ui:'detail-form',text:'of every',margin:'0 5 0 5'},{xtype:'numberfield',ui:'detail-form',reference:'csRecurrenceX',labelSeparator:'',width:60,value:1,minValue:1},{xtype:'label',ui:'detail-form',text:'month(s)',margin:'0 0 0 5'}]},{flex:1,border:0}]}]}]},{xtype:'container',layout:{type:'hbox'},items:[{flex:1,border:0},{ui:'orange',xtype:'button',localized:{text:'WVA_Generate'},margin:'15 2 0 0',handler:function(){var a=this.up('window'),c=a.getViewModel().getParent(),f=c.get('activeWebcam'),e=c.get('selectedWebcamPosition'),d=e.get('ArchivePositionID')||0;var b={start:Ext.Date.format(a.down('[reference=csStartDate]').getValue(),'Y-m-d'),end:Ext.Date.format(a.down('[reference=csEndDate]').getValue(),'Y-m-d'),stype:a.down('[reference=csSelectionType]').getGroupValue()};if(b.stype=='time'){b.rtype=a.down('[reference=csSelectionRadioGroup]').getValue().csRecurrenceType;if(b.rtype=='weekly'){b.wd=a.down('[reference=csWeekdays]').getValue().csWeekdays;if(b.wd===undefined){Ext.Msg.alert('Validation Error','At least one day of the week most be chosen.');return}}var g=a.down('[reference=csRecurrenceTypeCards]').getLayout().getActiveItem();b.h=a.down('[reference=csHour]').getValue();b.m=a.down('[reference=csMinute]').getValue();b.x=g.down('[reference=csRecurrenceX]').getValue();if(b.rtype=='monthly'){b.d=a.down('[reference=csDayOfMonth]').getValue()}}c.set('photoGroup',Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':f.getId(),'Type':'C','ArchivePositionID':d,'SlideshowDetails':b,'ParentPhoto':c.get('activeOrParentPhoto')}));c.set('activePhoto',null);a.hide()}}]}]}],listeners:{afterrender:function(d){var e=this.getViewModel(),c=e.get('activeWebcam'),a=e.get('selectedWebcamPosition'),f=d.down('[reference=csStartDate]'),g=d.down('[reference=csEndDate]');if(!c){return}var b=new Date(c.get('MostRecentPhotoDate'));if(a&&a.get('MostRecentPhotoDate')){b=new Date(a.get('MostRecentPhotoDate'))}f.setValue(Ext.Date.add(b,Ext.Date.MONTH,-1));g.setValue(b)}}},0,['webcamcustomslideshow'],['component','box','container','panel','window','webcamcustomslideshow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'webcamcustomslideshow':!0},['widget.webcamcustomslideshow'],0,[photoViewer.view.webcam,'WebcamCustomSlideshow'],0);Ext.cmd.derive('photoViewer.view.mainpanel.PhotoViewerBottomPanel',Ext.Container,{mvPreloadImages:['mds/image/component/expand-up.svg','mds/image/icon/slideshow-on.png'],width:'100%',height:131,padding:'0 10 0 20',margin:'14 0 0 0',layout:'vbox',viewModel:{formulas:{shootLockVisible:function(a){return !a('photoThumbsCollapsed')&&a('shootLockAvailable')},webcamThumbsHeaderVisible:function(a){return !a('photoThumbsCollapsed')&&a('activeWebcam')},slideshowButtonVisible:function(a){return !a('photoThumbsCollapsed')&&a('activePhoto')},webcamDatePickerVisible:function(a){return !1},gridViewVisible:function(a){return !a('photoThumbsCollapsed')&&a('activeStream')&&a('webcams.totalCount')>1}}},items:[{xtype:'container',layout:'hbox',width:'100%',height:31,padding:'6 0 0 0',items:[{xtype:'container',width:200,items:[{xtype:'shootlocktoggle',cls:'transparent',hidden:!0,bind:{lockMode:'{lockMode}',hidden:'{!shootLockVisible}'}},{xtype:'webcamthumbsheader',hidden:!0,bind:{hidden:'{!webcamThumbsHeaderVisible}'}}]},{xtype:'component',flex:1},{xtype:'container',itemId:'bottomBarExpandTab',layout:{type:'hbox',pack:'center'},width:100,items:[{xtype:'expandtab',scale:'medium',iconAlign:'center',width:11,height:6,margin:'2 0 0 0',listeners:{'click':{fn:function(){var a=this.up('photoviewer').getViewModel();a.set('photoThumbsCollapsed',!a.get('photoThumbsCollapsed'))}}}}]},{xtype:'component',flex:1},{xtype:'container',width:200,layout:{type:'hbox',pack:'end'},items:[{xtype:'container',layout:{type:'hbox',align:'middle',pack:'end'},dock:'right',width:133,items:[{xtype:'button',itemId:'slideshowButton',cls:'slideshow-button',width:22,height:14,ui:'plain',enableToggle:!0,hidden:!0,listeners:{toggle:'onSlideshowToggle'},tooltip:{localized:{text:'PV_Toggle Slideshow'},anchor:'top'},bind:{hidden:'{!slideshowButtonVisible}'}},{xtype:'button',cls:'customize-ss-button',margin:'0 0 0 10',ui:'plain',width:22,hidden:!0,bind:{hidden:'{!webcamDatePickerVisible}'},tooltip:{localized:{text:'WVA_Customize'},anchor:'top'},handler:'onCustomWebcamArchiveClick'},{xtype:'button',itemId:'gridViewButton',cls:'gridview-button',width:22,ui:'plain',hidden:!0,bind:{hidden:'{!gridViewVisible}'},tooltip:{localized:{text:'WV_Grid View'},anchor:'top'},handler:'onGridViewButtonClick'}]}]}]},{reference:'thumbsContainer',xtype:'photoviewerthumbs',padding:'0 10 0 0',hidden:!0,bind:{hidden:'{!activePhoto}'}},{xtype:'webcamviewerthumbs',padding:'0 10 0 0',hidden:!0,bind:{hidden:'{!activeStream}'}}]},0,['photoviewerbottompanel'],['component','box','container','photoviewerbottompanel'],{'component':!0,'box':!0,'container':!0,'photoviewerbottompanel':!0},['widget.photoviewerbottompanel'],0,[photoViewer.view.mainpanel,'PhotoViewerBottomPanel'],0);Ext.cmd.derive('photoViewer.view.mainpanel.PhotoViewerFloorplanCloseView',floorplanViewer.view.floorplanViewer.FloorplanViewer,{reference:'largeFloorplanViewer',showMiniMap:!1,showHotspotComments:!0,showSelectionLayer:!1,showZoomControls:!1,showHovers:!1,showPhotoThumbs:!1,showTitle:!1,showLegend:!1,showMapTools:!1,openPins:!1,width:'100%',height:'100%',cls:'mv-light-load-mask',animateOptions:{pan:{animate:!0,duration:0.5,easeLinearity:0.1},zoom:{animate:!0}}},0,['photoviewerfloorplanclose'],['component','box','container','clientFloorplanViewerDisp','photoviewerfloorplanclose'],{'component':!0,'box':!0,'container':!0,'clientFloorplanViewerDisp':!0,'photoviewerfloorplanclose':!0},['widget.photoviewerfloorplanclose'],0,[photoViewer.view.mainpanel,'PhotoViewerFloorplanCloseView'],0);Ext.cmd.derive('photoViewer.view.mainpanel.PhotoViewerMainPanel',Ext.Container,{flex:1,layout:{type:'vbox'},items:[{xtype:'container',layout:'hbox',width:'100%',flex:1,items:[{xtype:'photocontainer',reference:'photoContainer',flex:1,height:'100%',listeners:{resize:'onPhotoContainerResize'}},{xtype:'panel',layout:'fit',height:'100%',width:'50%',hidden:!0,cls:'close-floorplan-wrapper',bind:{hidden:'{!largeFloorplanVisible}',style:{visibility:'{largeFloorplanVisible}'}},resizable:{handles:'w',pinned:!0,dynamic:!0},items:[{xtype:'photoviewerfloorplanclose'}]}]},{xtype:'photoviewerbottompanel',reference:'photoViewerThumbs'}]},0,['photoviewermainpanel'],['component','box','container','photoviewermainpanel'],{'component':!0,'box':!0,'container':!0,'photoviewermainpanel':!0},['widget.photoviewermainpanel'],0,[photoViewer.view.mainpanel,'PhotoViewerMainPanel'],0);Ext.cmd.derive('photoViewer.view.mainpanel.PhotoViewerThumbs',Ext.Container,{width:'100%',statics:{leftOffset:42},height:Ext.isChrome?91:92,layout:{type:'hbox',align:'middle'},initComponent:function(){this.items=[{xtype:'container',width:7,margin:'0 15 0 0',items:[{xtype:'button',cls:'prev-thumb-button',width:7,height:21,ui:'plain',iconAlign:'left',listeners:{click:function(){this.up('photoviewerthumbs').scroll(-1)}},bind:{hidden:'{!prevActive}'}}]},{xtype:'container',itemId:'thumbWrapper',cls:'thumb-wrapper',flex:1,items:[{xtype:'dataview',bind:'{photoStore}',itemSelector:'.photo',height:Ext.isChrome?91:92,flex:1,cls:'thumb-container',loadMask:null,selectionModel:!1,selectedCls:'',tpl:new Ext.XTemplate('<tpl for="."><tpl if="LoadedImage"><div class="photo {SelectedCls} {FavouriteCls} {[this.commentCls(values)]} {[this.activeCls(values)]}"','style="background-image: url(\'{LoadedImage}\')">','<div class="photo-list-control-button select"></div>','<tpl if="CommentCount"><div class="has-comments photo-info tip">{CommentCount}</div></tpl>','<tpl if="HasAnnotations"><div class="has-annotations photo-info tip"></div></tpl>','<tpl if="IsInteriorPano">','<div class="has-pano interior-pano photo-info tip"></div>','</tpl>','<tpl if="IsPano">','<div class="has-pano aerial-pano photo-info tip"></div>','</tpl>','</div><tpl elseif="LoadedImage===0"><div class="photo error"><div class="message">mvstr[PT_Failed to load image]</div></div>','<tpl else><div class="photo"></div></tpl></tpl>',{commentCls:function(a){return a.CommentCount?'':'no-comments'},activeCls:function(a){return a.Active?'is-active':''}}),listeners:{itemclick:'onThumbClick',resize:{fn:'onThumbsResize',buffer:100}}}],listeners:{afterrender:function(b){var a=this.up('photoviewerthumbs');a.tip1=Ext.create('Ext.tip.ToolTip',Ext.mergeIf({target:this.getId(),delegate:'.tip',listeners:{beforeshow:{fn:a.onTooltipBeforeShow,scope:a}}},photoViewer.view.photoviewer.PhotoViewer.defaultTooltipConfig));a.tip2=Ext.create('Ext.tip.ToolTip',Ext.mergeIf({target:this.getId(),delegate:'.photo',listeners:{beforeshow:{fn:a.onTooltipBeforeShow,scope:a}}},photoViewer.view.photoviewer.PhotoViewer.defaultTooltipConfig))}}},{xtype:'container',width:7,margin:'0 0 0 15',items:[{xtype:'button',cls:'next-thumb-button',width:7,height:21,ui:'plain',iconAlign:'right',listeners:{click:function(){this.up('photoviewerthumbs').scroll(1)}},bind:{hidden:'{!nextActive}'}}]}];Ext.container.Container.prototype.initComponent.apply(this,arguments)},getScrollButtonAmount:function(){return this.getWidth()-137},scrollTo:function(b,g){if(this.deferredScrollTo){this.deferredScrollTo.destroy()}var a=this.down('dataview'),d=this.el.select('.photo').elements,f=Ext.fly(d[d.length-1]),h=f.getOffsetsTo(a)[0],c=h+f.getWidth(),l=(c-a.el.getWidth())*-1;if(a.el.getWidth()===c&&a.el.getWidth()>a.up('photoviewerthumbs').getWidth()){this.deferredScrollTo=a.addListener('resize',this.scrollTo,this,{args:[b,g],destroyable:!0});return}b=Math.max(l,b);if(d.length<this.getNThumbsPerPage()){b=this.self.leftOffset}this.pendingX=b;if(g){var k=Math.abs(b-a.el.getX());a.el.setX(b,{duration:750*(k/this.getScrollButtonAmount()),stopAnimation:!0,scope:this})}else {a.el.setX(b)}var i=Math.abs(b-this.self.leftOffset),j=i+a.el.getWidth(),e=this.lookupViewModel();e.set('nextActive',c>j);e.set('prevActive',b<this.self.leftOffset);e.set('firstScrollDone',!0)},getPageNumber:function(a){a=a===undefined?this.down('dataview').el.getX():a;return Math.ceil((a-this.self.leftOffset)*-1/this.getScrollButtonAmount())},scroll:function(c){var d=this.down('dataview'),a=this.pendingX;if(a===undefined){a=d.getX()}var b=Math.min(this.self.leftOffset,a+this.getScrollButtonAmount()*(c*-1));this.scrollTo(b,!0);this.lookupViewModel().set('thumbPage',this.getPageNumber(b))},gotoThumb:function(e){if(this.deferredGotoThumb){this.deferredGotoThumb.destroy()}var k=this.lookupViewModel(),i=this.el.select('.photo').elements,c=Ext.fly(i[e]),b=this.down('dataview');if(!c){this.deferredGotoThumb=b.addListener('refresh',this.gotoThumb,this,{args:[e],destroyable:!0});return}var a=c.getOffsetsTo(b)[0],f=a+c.getWidth(),g=b.getX(),d=Math.abs(g-this.self.leftOffset),h=d+this.down('dataview').el.getWidth(),j=(a-this.self.leftOffset-7)*-1;if(a<d||f>h||!k.get('firstScrollDone')){this.scrollTo(j)}},thumbVisible:function(e){var i=this.el.select('.photo').elements,a=Ext.fly(i[e]);if(!a){return !1}var d=this.down('dataview'),c=a.getOffsetsTo(d)[0],f=c+a.getWidth(),g=d.getX(),b=Math.abs(g-this.self.leftOffset),h=b+this.down('dataview').el.getWidth();return f>=b&&c<=h},onTooltipBeforeShow:function(e){var a=Ext.fly(e.triggerElement),c,b='',f=this.down('dataview'),g=f.el.select('.photo').elements,d=null;if(a.hasCls('photo')){c=a}else {c=a.up('.photo')}if(c&&c.dom){d=f.getStore().getAt(g.indexOf(c.dom))}if(!d){return !1}if(a.hasCls('aerial-pano')){b=mvstr['PT_AerialPano']}else {if(a.hasCls('interior-pano')){b=mvstr['PT_InteriorPano']}else {if(a.hasCls('has-annotations')){b=mvstr['PT_Photo is annotated']}else {if(a.hasCls('has-comments')){b=mvstr['PT_{x} comment(s)'].replace('{x}',d.get('CommentCount'))}else {if(a.hasCls('favourite-btn')){b=d.get('IsFavourite')?mvstr['PT_Remove this photo fro']:mvstr['PT_Add this photo to my ']}else {if(a.hasCls('photo')){b=d.get('title')}}}}}}if(e==this.tip1){this.tip2.hide()}e.update(b)},getNThumbsPerPage:function(){var d=this.down('dataview').el.getWidth(),c=123,b=137,a=4;return Math.floor((d-(b+a))/(c+a))+1}},0,['photoviewerthumbs'],['component','box','container','photoviewerthumbs'],{'component':!0,'box':!0,'container':!0,'photoviewerthumbs':!0},['widget.photoviewerthumbs'],0,[photoViewer.view.mainpanel,'PhotoViewerThumbs'],0);Ext.cmd.derive('photoViewer.view.mainpanel.WebcamThumbsHeader',Ext.container.Container,{layout:{type:'hbox'},hidden:!0,defaults:{margin:'0 5 0 0'},items:[{xtype:'label',localized:{html:'WV_More Webcams'},cls:'bottom-panel-label',hidden:!0,bind:{hidden:'{!activeStream}'}},{xtype:'button',cls:'datetime-selector',text:'',arrowCls:'calendar',hidden:!0,bind:{hidden:'{!activePhoto}',text:'{activePhoto.PhotoDate:date("DATE_Medium2")}'},menu:{shadow:!1,cls:'webcam-calendar-menu',items:[{xtype:'datepicker',reference:'webcamPhotoDatePicker',ui:'mds-dark',width:200,showToday:!1,bind:{value:'{activePhoto.PhotoDate}'},listeners:{select:function(c,d){var b=c.up('photoviewer').getViewModel(),a=b.get('photoGroup').getData();a.StartDate=d;a.Type='W';b.set('photoGroup',Ext.create('floorplanViewer.model.PhotoGroup',a))}}}]}},{xtype:'combo',reference:'webcamPhotoTimeCombo',ui:'webcam-time',queryMode:'local',editable:!1,valueField:'PhotoDate',shadow:!1,listConfig:{cls:'webcam-time-boundlist',shadow:!1},hidden:!0,bind:{hidden:'{!activePhoto}',value:'{activePhoto}',store:'{photoStore}'},valuePublishEvent:'',tpl:Ext.create('Ext.XTemplate','<tpl for=".">','<div class="x-boundlist-item">{PhotoDate:date("g:i A")}</div>','</tpl>'),displayTpl:Ext.create('Ext.XTemplate','<tpl for=".">','{PhotoDate:date("g:i A")}','</tpl>'),listeners:{select:function(b,a){b.up('photoviewer').getViewModel().set('activePhoto',a)}}}]},0,['webcamthumbsheader'],['component','box','container','webcamthumbsheader'],{'component':!0,'box':!0,'container':!0,'webcamthumbsheader':!0},['widget.webcamthumbsheader'],0,[photoViewer.view.mainpanel,'WebcamThumbsHeader'],0);Ext.cmd.derive('photoViewer.view.mainpanel.WebcamViewerThumbs',Ext.Container,{width:'100%',statics:{leftOffset:42},height:Ext.isChrome?91:92,layout:{type:'hbox',align:'middle'},initComponent:function(){this.items=[{xtype:'container',width:7,margin:'0 15 0 0',items:[{xtype:'button',cls:'prev-thumb-button',width:7,height:21,ui:'plain',iconAlign:'left',listeners:{click:function(){this.up('webcamviewerthumbs').scroll(-1)}},bind:{hidden:'{!prevActive}'}}]},{xtype:'container',itemId:'thumbWrapper',cls:'thumb-wrapper',flex:1,items:[{xtype:'dataview',bind:'{webcams}',itemSelector:'.webcam',height:Ext.isChrome?91:92,flex:1,cls:'thumb-container',loadMask:null,selectionModel:!1,selectedCls:'',tpl:new Ext.XTemplate('<tpl for="."><tpl if="ImageURL"><div class="webcam {[this.activeCls(values)]}"','style="background-image: url(\'{ImageURL}\')">','</div><tpl elseif="ImageURL===0"><div class="webcam error"><div class="message">mvstr[PT_Failed to load image]</div></div>','<tpl else><div class="webcam"></div></tpl></tpl>',{activeCls:function(a){return a.Active?'is-active':''}}),listeners:{itemclick:'onWebcamThumbClick',resize:{fn:'onThumbsResize',buffer:100}}}]},{xtype:'container',width:7,margin:'0 0 0 15',items:[{xtype:'button',cls:'next-thumb-button',width:7,height:21,ui:'plain',iconAlign:'right',listeners:{click:function(){this.up('webcamviewerthumbs').scroll(1)}},bind:{hidden:'{!nextActive}'}}]}];Ext.container.Container.prototype.initComponent.apply(this,arguments)},getScrollButtonAmount:function(){return this.getWidth()-137},scrollTo:function(a,j){var b=this.down('dataview'),c=this.el.select('.webcam').elements,f=Ext.fly(c[c.length-1]),g=f.getOffsetsTo(b)[0],e=g+f.getWidth(),l=(e-b.el.getWidth())*-1;a=Math.max(l,a);if(c.length<this.getNThumbsPerPage()){a=this.self.leftOffset}this.pendingX=a;if(j){var k=Math.abs(a-b.el.getX());b.el.setX(a,{duration:750*(k/this.getScrollButtonAmount()),stopAnimation:!0,scope:this})}else {b.el.setX(a)}var h=Math.abs(a-this.self.leftOffset),i=h+b.el.getWidth(),d=this.lookupViewModel();d.set('nextActive',e>i);d.set('prevActive',a<this.self.leftOffset);d.set('firstScrollDone',!0)},getPageNumber:function(a){a=a===undefined?this.down('dataview').el.getX():a;return Math.ceil((a-this.self.leftOffset)*-1/this.getScrollButtonAmount())},scroll:function(c){var d=this.down('dataview'),a=this.pendingX;if(a===undefined){a=d.getX()}var b=Math.min(this.self.leftOffset,a+this.getScrollButtonAmount()*(c*-1));this.scrollTo(b,!0);this.lookupViewModel().set('thumbPage',this.getPageNumber(b))},gotoThumb:function(e){if(this.deferredGotoThumb){this.deferredGotoThumb.destroy()}var k=this.lookupViewModel(),i=this.el.select('.webcam').elements,c=Ext.fly(i[e]),b=this.down('dataview');if(!c){this.deferredGotoThumb=b.addListener('refresh',this.gotoThumb,this,{args:[e],destroyable:!0});return}var a=c.getOffsetsTo(b)[0],f=a+c.getWidth(),g=b.getX(),d=Math.abs(g-this.self.leftOffset),h=d+this.down('dataview').el.getWidth(),j=(a-this.self.leftOffset-7)*-1;if(a<d||f>h||!k.get('firstScrollDone')){this.scrollTo(j)}},thumbVisible:function(e){var i=this.el.select('.webcam').elements,a=Ext.fly(i[e]);if(!a){return !1}var d=this.down('dataview'),c=a.getOffsetsTo(d)[0],f=c+a.getWidth(),g=d.getX(),b=Math.abs(g-this.self.leftOffset),h=b+this.down('dataview').el.getWidth();return f>=b&&c<=h},getNThumbsPerPage:function(){var d=this.down('dataview').el.getWidth(),c=123,b=137,a=4;return Math.floor((d-(b+a))/(c+a))+1}},0,['webcamviewerthumbs'],['component','box','container','webcamviewerthumbs'],{'component':!0,'box':!0,'container':!0,'webcamviewerthumbs':!0},['widget.webcamviewerthumbs'],0,[photoViewer.view.mainpanel,'WebcamViewerThumbs'],0);Ext.cmd.derive('photoViewer.view.measurements.PhotoViewerMeasurementTools',Ext.Container,{reference:'measureTW',hidden:!0,floating:!0,shadow:!1,draggable:!0,layout:{type:'vbox',align:'middle',pack:'center'},width:262,height:79,padding:15,defaultAlign:'bc-bc?',alignOffset:[0,-20],viewModel:{formulas:{text:function(a){switch(a('measureStep')){case photoViewer.Values.MSR_ZERO_POINTS:return mvstr['PM_Click on the photo to'];case photoViewer.Values.MSR_ONE_POINTS:return mvstr['PM_Click on the photo to'];case photoViewer.Values.MSR_TWO_POINTS:return mvstr['PM_Click Calculate to ge'];case photoViewer.Values.MSR_CALCULATING:return mvstr['PM_Calculating...'];case photoViewer.Values.MSR_DONE:return mvstr['PM_Measurement']+': '+a('measurementString');}return ''},actionText:function(a){switch(a('measureStep')){case photoViewer.Values.MSR_TWO_POINTS:case photoViewer.Values.MSR_CALCULATING:return mvstr['PM_Calculate'];case photoViewer.Values.MSR_DONE:return mvstr['PM_Save'];}return ''},canClear:function(a){return a('measureStep')>photoViewer.Values.MSR_ONE_POINTS},buttonsVisible:function(a){return !!(a('actionText')||a('canClear'))}}},bind:{disabled:'{gettingCmiLength}'},items:[{xtype:'component',cls:'instructions',bind:{html:'{text}'}},{xtype:'container',layout:{type:'hbox',pack:'middle'},hidden:!0,bind:{hidden:'{!buttonsVisible}'},defaults:{xtype:'button',width:70,height:25,scale:'small'},padding:'13 0 0 0',items:[{localized:{text:'PM_Clear'},ui:'grey',bind:{hidden:'{!canClear}'},margin:'0 10 0 0',listeners:{click:'clearActiveMeasurement'}},{ui:'orange',bind:{text:'{actionText}',hidden:'{!actionText}'},listeners:{click:'doMeasurementAction'}}]}]},0,['photoviewermeasurementtools'],['component','box','container','photoviewermeasurementtools'],{'component':!0,'box':!0,'container':!0,'photoviewermeasurementtools':!0},['widget.photoviewermeasurementtools'],0,[photoViewer.view.measurements,'PhotoViewerMeasurementTools'],0);Ext.cmd.derive('photoViewer.view.pannellum.PannellumController',Ext.app.ViewController,{config:{viewerReady:!1,listeningForMovement:!1,lastPhoto:{hotspotID:0,yaw:0}},init:function(){var a=this.getViewModel();this.getView().up('photocontainer').on('resize',this.onPannellumResize,this);a.bind({floorplanModeOn:'{floorplanModeOn}'},function(a){this.removeMarkerLayer(!0);this.checkFloorplanReady()},this)},clear:function(){if(this.viewer){this.createMarkerLayer();this.setViewerReady(!1);this.viewer.destroy()}},getViewModel:function(){return this.getView().lookupViewModel()},setupViewer:function(){if(this.viewer){this.clear()}if(this.pannellumScriptLoaded){return this.setupViewer2()}Ext.Loader.loadScript({url:'mds/lib/pannellum/pannellum.js',onLoad:function(){this.pannellumScriptLoaded=!0;this.setupViewer()},scope:this})},setupViewer2:function(){var a=this;var e=this.getView();var d=this.getViewModel();var b=d.get('activePhoto');var c=0;if(!!a.getLastPhoto().hotspotID&&!!b.get('HotspotID')&&b.get('HotspotID')==a.getLastPhoto().hotspotID){c=a.getLastPhoto().yaw}mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=pannellumViewer.getBase64Image&Identifier='+b.get('Identifier')+'&FloorplanUID='+b.get('FloorplanUID'),successCallback:function(j){var i=b.get('ImageURL');if(typeof j.base64Str!=='undefined'){var f=window.atob(j.base64Str);var h=f.length;var g=new Uint8Array(h);for(var d=0;d<h;d++){var k=f.charCodeAt(d);g[d]=k}var l=new Blob([g],{type:'application/octet-stream'});i=window.URL.createObjectURL(l)}a.viewer=pannellum.viewer(e.getId(),{type:'equirectangular',panorama:i,preview:b.get('ImageURL'),autoLoad:!0,showControls:!1,compass:!1,hfov:180,yaw:c}).on('load',function(){a.getLastPhoto().hotspotID=b.get('HotspotID')||0;a.checkFloorplanReady()}).on('mousedown',function(){a.setListeningForMovement(!0);a.startMovingMarkerFOV()}).on('mouseup',function(){a.setListeningForMovement(!1)})},failure:function(){Ext.Msg.alert('Error','Error loading base64Image data.')},scope:a})},startMovingMarkerFOV:function(){if(this.getListeningForMovement()){this.updateMarkerFOV();setTimeout(this.startMovingMarkerFOV.bind(this),100)}},getViewerAngle:function(){var a=this.getHotspot();if(a&&a.properties.hotspotType=='360pano'){if(this.viewer!==undefined){var c=this.viewer.getYaw();var b=Ext.Number.from(a.properties.media.split('_')[1]);if(Ext.isNumber(b)){this.getLastPhoto().yaw=c;return b+c}}}},takeScreenShot:function(){var a=this.viewer;if(this.viewer!==undefined){return new Ext.Promise(function(c,d){var e=a.getPitch()*Math.PI/180;var g=a.getYaw()*Math.PI/180;var f=a.getHfov()*Math.PI/180;var b=a.getRenderer().render(e,g,f,{returnImage:!0});if(b){c(b)}else {d()}})}return null},onPannellumResize:function(){var a=this.viewer;if(a){try{this.viewer.resize()}catch(b){console.log("Couldn't resize pannellum viewer: ",b.message)}}}},0,0,0,0,['controller.pannellum'],[[photoViewer.controller.PanoramaMarkerController.prototype.mixinId||photoViewer.controller.PanoramaMarkerController.$className,photoViewer.controller.PanoramaMarkerController]],[photoViewer.view.pannellum,'PannellumController'],0);Ext.cmd.derive('photoViewer.view.pannellum.Pannellum',Ext.Component,{controller:'pannellum',reference:'pannellum'},0,['pannellum'],['component','box','pannellum'],{'component':!0,'box':!0,'pannellum':!0},['widget.pannellum'],0,[photoViewer.view.pannellum,'Pannellum'],0);Ext.cmd.derive('photoViewer.view.photo.PhotoController',Ext.app.ViewController,{init:function(){app.addListener('photoviewerbeforeloadphoto',this.onBeforeLoadPhoto,this);this.addListener('triggerdisplayannotations',this._displayAnnotations,this,{buffer:100});Ext.getBody().addListener('keydown',this.onKeyPress,this);var a=this.getViewModel();a.bind('{toolSettings.strokeColour}',this.setSelectedShapeStrokeColour,this);a.bind({drawMode:'{drawMode}'},function(a){this.onDrawModeChange(a.drawMode!=photoViewer.Values.DRAW_OFF)},this);a.bind({drawMode:'{annotating}'},this.onAnnotatingChange,this,{delay:1});a.bind({annoStoreLoaded:'{annoProps.storeLoaded}',naturalWidth:'{naturalWidth}',naturalHeight:'{naturalHeight}'},function(a){if(a.naturalWidth&&a.naturalHeight&&a.annoStoreLoaded&&this.getViewModel().get('drawMode')==photoViewer.Values.DRAW_OFF){this.displayAnnotations()}},this);a.bind({naturalWidth:'{naturalWidth}',naturalHeight:'{naturalHeight}'},this.onPhotoSizeChange,this);a.bind('{annoProps.toggledOn}',function(a){this.updateAnnotationsVisibility(!a)},this);a.bind('{selectedDrawing}',this.onSelectedDrawingChange,this)},onBoxReady:function(){var a=this.getView(),b=function(b){if(a.shapeInCreation){return}this.callParent(arguments)};Ext.override(a.dd,{onMouseMove:b})},onBeforeLoadPhoto:function(){this.getViewModel().set('annoProps.storeLoaded',!this.getViewModel().get('activePhoto.HasDrawables'))},removeAllDrawables:function(){var a=this.getViewModel().get('drawablesStore');if(a){a.each(function(a){if(a.shape){a.shape.destroy()}})}},displayAnnotations:function(){this.fireEvent('triggerdisplayannotations')},_displayAnnotations:function(){var a=this.getViewModel(),b=a.get('drawablesStore'),e=a.get('drawMode');if(!b||b.isLoading()){if(this.displayAnnotationsTimeout){clearTimeout(this.displayAnnotationsTimeout)}this.displayAnnotationsTimeout=setTimeout(Ext.bind(this.displayAnnotations,this),100);return}var c=!a.get('annotating'),d=!a.get('measuring');this.removeAllDrawables();if(a.get('annoProps.toggledOn')||e!=photoViewer.Values.DRAW_OFF){b.each(function(a){if(c&&a.get('Type')=='measure'||d&&a.get('Type')!='measure'){a.createShape(this.getView())}},this)}a.set('drawingReady',!0)},onPhotoSizeChange:function(a){this.removeAllDrawables();this.getView().surface.el.dom.setAttribute('viewBox','0,0,'+a.naturalWidth+','+a.naturalHeight)},updateAnnotationsVisibility:function(a){if(!this._init_updateAnnotationsVisibility){this._init_updateAnnotationsVisibility=!0;return}if(a){this.removeAllDrawables()}else {this.displayAnnotations()}},updateAnnotationVisibility:function(a,b){if(!a.shape){return}if(b===undefined){b=!a.get('Visible')}if(!a.get('Visible')){b=!0}if(b){a.shape.hide(!0)}else {a.shape.show(!0)}},getStore:function(){return this.getViewModel().get('annotationStore')},onDrawModeChange:function(a){this.getViewModel().set('readOnly',!a)},onAnnotatingChange:function(){if(!this._init_onAnnotatingChange){this._init_onAnnotatingChange=!0;return}this.displayAnnotations()},onMouseDown:function(c){var a=this.getView(),b=this.getViewModel().get('toolSettings.mode'),e=this.getViewModel().get('readOnly');if(e||b=='select'){a.addCls('dragging')}if(e){return}if(this.deselectAll()){return !1}c.preventDefault();var d=this.getRelativeDescaledXYFromMouseEvent(c);a.descaledXY=d;a.pageXY=[c.browserEvent.pageX,c.browserEvent.pageY];if(b=='select'){a.isDragging=!0;return !1}else {var f=b.substring(0,1).toUpperCase()+b.substring(1);a.shapeInCreation=Ext.create('photoViewer.view.annotations.shapes.'+f,{drawComponent:this.getView(),isNew:!0});a.shapeInCreationClickXY=d;a.shapeInCreationPrevXY=d}return !1},onMouseMove:function(e){var j=this.getViewModel(),a=this.getView();if(j.get('measuring')){var f=j.get('measureStep');if(f==photoViewer.Values.MSR_ZERO_POINTS){return !1}if(f==photoViewer.Values.MSR_ONE_POINTS&&a.shapeInCreation){var g=a.shapeInCreation.get('pointHandle1');a.shapeInCreation.changePointOnDragHandle(g.dd,g,e);return !1}}a.pageXY=[e.browserEvent.pageX,e.browserEvent.pageY];if(a.isDragging){return !1}if(a.shapeInCreation){var d=this.getRelativeDescaledXYFromMouseEvent(e),h=d[0]-a.shapeInCreationPrevXY[0],i=d[1]-a.shapeInCreationPrevXY[1];a.shapeInCreationPrevXY=d;var c=this.getViewModel().get('toolSettings.mode');if(c=='ellipse'||c=='rectangle'||c=='textbox'){var k=d[0]-a.shapeInCreationClickXY[0],l=d[1]-a.shapeInCreationClickXY[1],b=a.shapeInCreationHandlePosition;if(!a.shapeInCreationHandleDX){a.shapeInCreationHandleDX=k}if(!a.shapeInCreationHandleDY){a.shapeInCreationHandleDY=l}if(b===undefined){if(a.shapeInCreationHandleDX<0){if(a.shapeInCreationHandleDY<0){b=7}else {if(a.shapeInCreationHandleDY>0){b=5}else {b=6}}}else {if(a.shapeInCreationHandleDX>0){if(a.shapeInCreationHandleDY<0){b=1}else {if(a.shapeInCreationHandleDY>0){b=3}else {b=2}}}else {if(a.shapeInCreationHandleDY<0){b=0}else {b=4}}}if(a.shapeInCreationHandleDX&&a.shapeInCreationHandleDY){a.shapeInCreationHandlePosition=b}}a.shapeInCreation.resizeShape(d,b)}else {if(c=='line'||c=='arrow'||c=='measure'){a.shapeInCreation.movePointHandle(1,d[0],d[1])}else {if(c=='text'){a.shapeInCreation.translate(h,i)}else {if(c=='pen'){a.shapeInCreation.drawPath(h,i,e)}}}}}return !1},onMouseUp:function(e){var b=this.getViewModel(),a=this.getView();a.removeCls('dragging');if(b.get('measuring')&&b.get('measureStep')==photoViewer.Values.MSR_ZERO_POINTS){b.set('measureStep',photoViewer.Values.MSR_ONE_POINTS);a.shapeInCreation.refreshSelectionSprites();return !1}if(b.get('readOnly')){return}if(a.pendingDataChangeShape){a.pendingDataChangeShape.fireEvent('datachanged');a.pendingDataChangeShape=null}if(a.isDragging){a.isDragging=!1;return !1}if(a.shapeInCreation){if(a.shapeInCreation.isTooSmall()){a.shapeInCreation.destroy()}else {var d=this.getView().up('photoviewer').lookupReference('annotationsTW').getController().lookupReference('annotationsSelectButton');d.fireEvent('click',d);var c=Ext.create('photoViewer.model.Annotation',{ShareTypeID:b.get('defaultShareTypeID'),MemberUIDArray:[],MemberFirstName:b.get('account.MemberFirstName'),MemberLastName:b.get('account.MemberLastName'),IsMetric:b.get('usingMetric')});c.setShape(a.shapeInCreation);a.shapeInCreation.onCreate();this.getViewModel().get('writeDrawablesStore').add(c);b.set('selectedDrawing',c);if(c.get('Type')=='measure'){this.onAddMeasurement(c)}if(typeof a.shapeInCreation.afterMove=='function'){a.shapeInCreation.afterMove()}a.shapeInCreation.onDragHandleMouseUp()}a.shapeInCreation=null;a.shapeInCreationHandlePosition=undefined;a.shapeInCreationHandleDX=undefined;a.shapeInCreationHandleDY=undefined}return !1},onKeyPress:function(f){var e=this.getViewModel();if(!e.get('drawing')||f.getTarget().tagName=='TEXTAREA'){return}var a,d=e.get('drawablesStore'),g=d.count(),c,b=null;for(a=0;a<g;a++){c=d.getAt(a);if(c.shape.isSelected){b=c.shape;break}}if(b===null){return}b.handleKeyPress(f,a)},onModeChange:function(a){if(a!='select'){this.deselectAll()}},setSelectedShapeStrokeColour:function(b){var a=this.getSelectedShape();if(a){a.setColour(b)}},setSelectedShapeStrokeWidth:function(b){var a=this.getSelectedShape();if(a&&b!=a.getAttribute('stroke-width')){a.setStrokeWidth(b)}},setSelectedShapeStrokeStyle:function(b){var a=this.getSelectedShape();if(a&&b!=a.getAttribute('style')){a.setStrokeStyle(b)}},setRecordSelectedShapeShareType:function(c,b){var a=this.getSelectedModel();if(a){if(a.get('ShareTypeID')!=c){a.set('ShareTypeID',c)}if(a.get('MemberUIDArray').join(',')!=b.join(',')){a.set('MemberUIDArray',b.slice())}}},setSelectedShapeFontSize:function(b){var a=this.getSelectedShape();if(a&&Ext.Array.contains(a.shapeAttributes,'font-size')&&b!=a.getAttribute('font-size')){a.setFontSize(b)}},onShapeSelect:function(a){if(a.getType()=='measure'){return}var b=this.getViewModel();b.set('toolSettings.strokeWidth',a.getAttribute('stroke-width'));b.set('toolSettings.strokeColour',a.getAttribute('stroke'));b.set('toolSettings.strokeStyle',a.getAttribute('style'));if(Ext.Array.contains(a.shapeAttributes,'font-size')){b.set('toolSettings.fontSize',a.getAttribute('font-size'))}b.set('toolSettings.selectedShapes',[a])},onShapeDeselect:function(a){this.getViewModel().set('toolSettings.selectedShapes',[])},deselectAll:function(a){if(!this.getView().up('photoviewer').lookupController().beforeDrawableSelectionChange()){return !1}if(!a||a.record!=this.getViewModel().get('selectedDrawing')){this.getViewModel().set('selectedDrawing',null)}var d=this.getViewModel().get('drawablesStore'),f=d.count(),b=!1;for(var c=0;c<f;c++){var e=d.getAt(c);if(!a||e.shape!=a){b=e.shape.deselect()||b}}return b},getRelativeDescaledXYFromMouseEvent:function(d){var b=this.getView().el.getBox();var a=[],c=this.getViewModel().get('scale');a[0]=(d.browserEvent.clientX-b.left)/c;a[1]=(d.browserEvent.clientY-b.top)/c;return a},getSelectedShape:function(){var a=this.getViewModel().get('drawablesStore');if(!a){return null}var d=a.count();for(var b=0;b<d;b++){var c=a.getAt(b);if(c.shape.isSelected){return c.shape}}return null},getSelectedModel:function(){var b=this.getViewModel().get('drawablesStore'),d=b.count();for(var a=0;a<d;a++){var c=b.getAt(a);if(c.shape.isSelected){return c}}return null},getRelativeRealXYFromMouseEvent:function(c){var b=this.getView().el.getBox(),a=[];a[0]=c.browserEvent.clientX-b.left;a[1]=c.browserEvent.clientY-b.top;return a},onResetPhotoPosition:function(c){var a=this.getViewModel().get('activeDrawablesStore');if(a&&a.getCount()){if(this.getView().surface.items.length){a.each(function(a){if(a.shape){a.shape.onZoomChange(c)}})}else {if(a.isLoaded()){this.displayAnnotations()}}}var b=this.getView().surface.el.dom;b.setAttribute('width','100%');b.setAttribute('height','100%')},onDoubleClick:function(h){var d=this.getViewModel();if(!d.get('photoState.fullImageLoaded')||d.get('drawing')){return}var g=this.getView(),a=g.el.getBox(),b=h.getPoint(),c=!(b.y<a.top||b.x>a.right||b.y>a.bottom||b.x<a.left),e=c?b.x-a.x:undefined,f=c?b.y-a.y:undefined;this.getView().up('photoviewer').lookupController().lookupReference('photoContainer').getController().zoom(1,e,f)},getAnnotationShareButton:function(){return Ext.ComponentQuery.query('photoviewerannotationstoolwindow shareWithButton')[0]},onAddMeasurement:function(a){this.getViewModel().set('measureStep',photoViewer.Values.MSR_TWO_POINTS);this.getViewModel().set('toolSettings.mode','select');this.getViewModel().set('activeMeasurement',a)},onSelectedDrawingChange:function(a){if(a&&a.shape){a.shape.select()}},onPhotoDragStart:function(){app.fireEvent('slideshowinterrupt')},onPhotoDragEnd:function(){}},0,0,0,0,['controller.photo'],0,[photoViewer.view.photo,'PhotoController'],0);Ext.cmd.derive('photoViewer.view.photo.Photo',photoViewer.draw.Component,{controller:'photo',reference:'photo',draggable:{listeners:{dragstart:function(){Ext.getCmp(this.dragTarget.getId()).lookupController().onPhotoDragStart()},dragend:function(){Ext.getCmp(this.dragTarget.getId()).lookupController().onPhotoDragEnd()}}},shadow:!1,zIndex:0,viewBox:!1,pageXY:null,descaledXY:null,shapeInCreation:null,shapeInCreationClickXY:null,shapeInCreationPrevXY:null,statics:{styleSettings:{normal:'',dotted:'5,5',dashed:'10,10'}},setZIndex:function(){return},getScale:function(){return this.lookupViewModel().get('scale')},getReadOnly:function(){return this.lookupViewModel().get('readOnly')},getNaturalWidth:function(){return this.lookupViewModel().get('naturalWidth')},getNaturalHeight:function(){return this.lookupViewModel().get('naturalHeight')},listeners:{boxready:'onBoxReady',mousedown:'onMouseDown',mousemove:'onMouseMove',mouseup:'onMouseUp',el:{doubletap:'onDoubleClick',scope:'self.controller'}}},0,['viewerphoto'],['component','box','viewerphoto'],{'component':!0,'box':!0,'viewerphoto':!0},['widget.viewerphoto'],0,[photoViewer.view.photo,'Photo'],0);Ext.cmd.derive('photoViewer.view.photocontainer.PhotoContainerController',Ext.app.ViewController,{statics:{zoomMin:0,zoomMax:20,zoomFactor:1.25},zoomCount:0,defaultWidth:0,defaultHeight:0,init:function(){var a=this.getViewModel();a.bind({mediumWidth:'{activePhoto.MediumWidth}'},function(){this.resetPhotoDisplay()},this);a.bind({fullImageLoaded:'{photoState.fullImageLoaded}',activePhoto:'{activePhoto}',naturalWidth:'{activePhoto.OriginalsWidth}',naturalHeight:'{activePhoto.OriginalsHeight}'},function(a){if(a.fullImageLoaded&&a.activePhoto&&a.naturalWidth&&a.naturalHeight){this.resetPhotoDisplay(!a.activePhoto.pvInitialized);a.activePhoto.pvInitialized=!0}},this);app.addListener('photoviewerbeforeloadphoto',this.onBeforeLoadPhoto,this);this.sw360=app.getController('photoViewer.controller.SiteWalk360Controller');this.sw360.viewModel=this.getView().up('photoviewer').getViewModel();this.sw360.on('showcaseconnected',this.showcaseConnected,this)},getMainViewModel:function(){return this.getView().up('photoviewer').getViewModel()},showcaseConnected:function(a){this.getMainViewModel().set('interiorPanoShowcaseConnected',a)},onBeforeLoadPhoto:function(b){var a=this.getViewModel();a.set('photoData.id',b.get('id'));a.set('photoData.photoId',b.getId());a.set('photoData.nComments',b.get('CommentCount'));a.set('annoProps.hasAnnotations',!!b.get('HasAnnotations'));var d=!!b.get('IsPano');var e=!!b.get('IsInteriorPano');var c=b.get('Is360Pano');a.set('photoState.isPano',d);a.set('photoState.isInteriorPano',e);a.set('photoState.is360Pano',c);if(d){var g=b.get('ImageURLThumb');var f=g.split('/');var h=f.slice(0,6).join('/')+'/pano/processed/index.html';a.set('photoData.panoHome',h)}if(c){this.lookupReference('pannellum').lookupController().setupViewer()}else {this.lookupReference('pannellum').lookupController().clear()}this.getMainViewModel().set('photoState.fullImageLoaded',!1)},onBoxReady:function(b){b.body.unselectable();var a=this.lookupReference('photo'),c=this.lookupReference('webcamLiveStream');a.setWidth(b.getWidth());a.setHeight(b.getHeight());if(mdsUtil.Browser.isMouseEventSupported('wheel')){a.el.addListener('wheel',this.onMouseWheel,this);c.el.addListener('wheel',this.onLivestreamMouseWheel,this)}else {a.el.addListener('mousewheel',this.onMouseWheel,this);c.el.addListener('mousewheel',this.onLivestreamMouseWheel,this)}a.show()},onMouseWheel:function(c,i){if(!this.getViewModel().get('photoState.fullImageLoaded')){return}app.fireEvent('mouseWheelZoom',this.getView(),c,i);var h=this.lookupReference('photo'),a=h.el.getBox(),b=c.getPoint(),d=!(b.y<a.top||b.x>a.right||b.y>a.bottom||b.x<a.left),e=d?b.x-a.x:undefined,f=d?b.y-a.y:undefined,g=c.getWheelDelta()>=0?1:-1;this.zoom(g,e,f)},onLivestreamMouseWheel:function(k,l){var h=this.getMainViewModel().get('activeStream'),e=this.lookupReference('webcamLiveStream'),a=e.el.getBox(),b=k.getPoint(),j=!(b.y<a.top||b.x>a.right||b.y>a.bottom||b.x<a.left),c=j?b.x-a.x:undefined,d=j?b.y-a.y:undefined,i=k.getWheelDelta()>=0?1:-1;if(h&&!h.WebcamPTZEnabled){e.zoom(i,c,d);var f=0,g=0;if(i>0){f=c*this.self.zoomFactor;g=d*this.self.zoomFactor}else {if(e.localScale<=100){return}f=c/this.self.zoomFactor;g=d/this.self.zoomFactor}e.setXY([a.x-(f-c),a.y-(g-d)])}},onContextMenu:function(a){a.preventDefault();if(!this.getViewModel().get('drawing')&&this.getViewModel().get('activePhoto')){this.getView().up('photoviewer').getController().showContextMenu(a)}return !1},zoom:function(h,a,b){if(!this.getViewModel().get('photoState.fullImageLoaded')){return}app.fireEvent('slideshowinterrupt');var c=this.lookupReference('photo'),d=c.el.getBox(),e=0,f=0;if(a===undefined){a=d.width/2}if(b===undefined){b=d.height/2}if(h>0){if(this.zoomCount==this.self.zoomMax){return}e=a*this.self.zoomFactor;f=b*this.self.zoomFactor}else {if(this.zoomCount==this.self.zoomMin){this.resetPhotoDisplay(!1,!0);return}e=a/this.self.zoomFactor;f=b/this.self.zoomFactor}this.zoomCount+=h;var g=this.zoomCount>=0?Math.pow(this.self.zoomFactor,this.zoomCount):Math.pow(1/this.self.zoomFactor,this.zoomCount),i=this.defaultWidth*g,k=this.defaultHeight*g;var j=i/this.getViewModel().get('naturalWidth');this.getViewModel().set('scale',j);c.setWidth(i);c.setHeight(k);c.setXY([d.x-(e-a),d.y-(f-b)]);c.getController().onResetPhotoPosition(j)},zoomIn:function(){if(this.getMainViewModel().get('activeStream')){this.lookupReference('webcamLiveStream').zoom(1)}else {this.zoom(1)}},zoomOut:function(){if(this.getMainViewModel().get('activeStream')){this.lookupReference('webcamLiveStream').zoom(-1)}else {this.zoom(-1)}},getDefaultPhotoDimenstions:function(){var c=this.getMainViewModel().get('activePhoto.MediumWidth'),e=this.getMainViewModel().get('activePhoto.MediumHeight'),g=this.getView(),d=g.body.getWidth(),f=g.body.getHeight(),b=d,a=f;if(c&&a){a=f;b=Math.round(c*(a/e));if(b>d){b=d;a=Math.round(e*(b/c))}}return {width:b,height:a}},resetPhotoDisplay:function(k,j){var d=this.lookupReference('photo'),h=this.getMainViewModel().get('naturalWidth'),e=this.getView(),g=e.body.getWidth(),f=e.body.getHeight(),b=e.body.getXY(),a=this.getDefaultPhotoDimenstions(),i=h?a.width/h:1;if(this.getMainViewModel().get('activeStream')){var c=this.lookupReference('webcamLiveStream');c.localZoom(100);c.setXY([Math.round((g-c.getWidth())/2+b[0]),Math.round((f-c.getHeight())/2+b[1])]);return}d.setWidth(a.width);d.setHeight(a.height);this.getMainViewModel().set('scale',i);if(!j){d.setXY([Math.round((g-a.width)/2+b[0]),Math.round((f-a.height)/2+b[1])])}if(!k){d.getController().onResetPhotoPosition(i)}this.zoomCount=0;this.defaultWidth=a.width;this.defaultHeight=a.height},centerPhoto:function(){if(this.zoomCount==0){this.resetPhotoDisplay()}else {var a=this.lookupReference('photo'),g=a.el.getWidth(),f=a.el.getHeight(),b=this.getView(),e=b.body.getWidth(),d=b.body.getHeight(),c=b.body.getXY();a.setXY([g>e?a.el.getX():Math.round((e-g)/2+c[0]),f>d?a.el.getY():Math.round((d-f)/2+c[1])])}},switchImageSize:function(a,c){var k=this.getViewModel(),g=this.lookupReference('photo'),f=this.getView(),e=f.body.getWidth(),d=f.body.getHeight(),b=a?Math.min(e/a,d/c):1,j=a?a*b:e,i=c?c*b:d,h=g.el.getWidth()/a;k.set('scale',h);Ext.defer(function(){g.lookupController().onResetPhotoPosition()},1);this.defaultWidth=j;this.defaultHeight=i;this.zoomCount=Math.round(Math.log(h/b)/Math.log(this.self.zoomFactor))},onShapeSelect:function(a){},syncShapes:function(a,b){a.setColour(b.getAttribute('stroke'));a.setStrokeWidth(b.getAttribute('stroke-width'));a.setStrokeStyle(b.getAttribute('style'));if(Ext.Array.contains(b.shapeAttributes,'font-size')&&Ext.Array.contains(a.shapeAttributes,'font-size')){a.setFontSize(b.getAttribute('font-size'))}},siteWalkTakeScreenShot:function(a){return this.sw360.takeScreenShot(a)},pannellumTakeScreenshot:function(){return this.lookupReference('pannellum').lookupController().takeScreenShot()},siteWalkGetPose:function(){return this.sw360.getPose()},getPannellumViewerAngle:function(){return this.lookupReference('pannellum').lookupController().getViewerAngle()},nextPhoto:function(){this.getView().up('photoviewer').getController().nextPhoto()},prevPhoto:function(){this.getView().up('photoviewer').getController().prevPhoto()},onResize:function(){var a=this.getViewModel();if(a.get('photoState.fullImageLoaded')&&a.get('activePhoto')&&a.get('naturalWidth')&&a.get('naturalHeight')){this.centerPhoto()}if(a.get('activeStream')){this.lookupReference('webcamLiveStream').resize();var b=this.lookupReference('streampositioncontrols');if(b){b.controller.handleResize()}}},onFullscreenClick:function(){var c=this.getViewModel().get('fullscreen');if(this.getViewModel().get('activeStream')){if(c){document.exitFullscreen()}else {var a=this.getView().body.dom;var b=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullScreen;if(b){b.call(a)}}}},pvWebcamPositionSelected:function(b,a){this.getView().up('photoviewer').getController().onSelectedWebcamPositionChange(a)},webcamLiveStreamDragStart:function(){var a=this.getMainViewModel();return a.get('activeStream')&&!a.get('activeStream').WebcamPTZEnabled},onUAVPanoLoadOrError:function(){if(this.getViewModel().get('photoState.isPano')){analytics.Ctrl.log('Viewed Photo',{},['Photo ID','Photo Type','Photo ID with Prefix'])}}},0,0,0,0,['controller.photocontainer'],0,[photoViewer.view.photocontainer,'PhotoContainerController'],0);Ext.cmd.derive('photoViewer.view.positioncontrols.WebcamPositionSelector',Ext.form.field.ComboBox,{height:29,width:120,alwaysOnTop:2,style:{zIndex:2},displayField:'Name',editable:!1,cls:'camera-presets',listConfig:{cls:'photo-viewer-camera-presets',shadow:!1},bind:{store:'{webcamPositions}',value:'{_selectedArchivePosition}'},listeners:{select:'pvWebcamPositionSelected'}},0,['webcampositionselector'],['component','box','field','textfield','pickerfield','combobox','combo','webcampositionselector'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'webcampositionselector':!0},['widget.webcampositionselector'],0,[photoViewer.view.positioncontrols,'WebcamPositionSelector'],0);Ext.cmd.derive('photoViewer.view.photocontainer.PhotoContainer',Ext.panel.Panel,{config:{loadMaskCls:'dark-load-indicator'},controller:'photocontainer',layout:'absolute',bind:{disabled:'{viewerDisabled}'},items:[{xtype:'viewerphoto',reference:'photo',bind:{hidden:'{isPhotoHidden}'},listeners:{shapesync:'syncShapes',shapeSelect:'onShapeSelect'}},{xtype:'uxiframe',id:'panophoto',bind:{visible:'{photoState.isPano}',src:'{photoData.panoHome}'},renderTpl:['<iframe src="{src}" id="{id}-iframeEl" data-ref="iframeEl" name="{frameName}" width="100%" height="100%" frameborder="0" allowFullScreen="true"></iframe>'],width:'100%',height:'100%',setSrc:function(a){this.load(a)},listeners:{error:'onUAVPanoLoadOrError',load:'onUAVPanoLoadOrError'}},{id:'interiorPanoFrame',xtype:'uxiframe',loadMask:null,bind:{visible:'{interiorPanoFrameVisible}',src:'{interiorPanoUrl}'},renderTpl:['<iframe src="{src}" id="{id}-iframeEl" data-ref="iframeEl" name="{frameName}" width="100%" height="100%" frameborder="0" allowFullScreen="true" allow="vr"></iframe>'],width:'100%',height:'100%',setSrc:function(a){this.load(a)}},{xtype:'component',id:'truViewComponent',bind:{visible:'{truViewComponentVisible}'},width:'100%',height:'100%'},{xtype:'pannellum',loadMask:null,bind:{visible:'{photoState.is360Pano}'},width:'100%',height:'100%'},{xtype:'container',layout:{type:'hbox',align:'center',pack:'center'},bind:{visible:'{activeStream}'},items:[{xtype:'webcamlivestream',layout:{type:'vbox',pack:'center'},reference:'webcamLiveStream',draggable:{listeners:{mousedown:function(a){return a.comp.lookupController().webcamLiveStreamDragStart()}}},showFullscreenButton:!1}]},{xtype:'component',cls:'photo-viewer-video',reference:'webcamTimelapse',height:'100%',bind:{hidden:'{!activeTimelapse}'}},{xtype:'container',cls:'nextprev-button-container',height:'100%',width:49,items:[{xtype:'button',cls:'prev-photo-button',ui:'plain',iconAlign:'right',width:49,height:64,padding:20,margin:'-32 0 0 0',style:{position:'absolute',top:'50%',zIndex:2},listeners:{click:function(a){a.up('photoviewer').lookupController().logNextPrevEvent('prev','click');a.up('photoviewer').lookupController().prevPhoto()}},bind:{hidden:'{!nextPrevButtonsVisible}'}}]},{xtype:'container',cls:'nextprev-button-container',width:49,height:'100%',style:{top:0,right:0},items:[{xtype:'button',cls:'next-photo-button',ui:'plain',iconAlign:'left',width:49,height:64,padding:20,margin:'-32 0 0 0',style:{position:'absolute',top:'50%',zIndex:2},listeners:{click:function(a){a.up('photoviewer').lookupController().logNextPrevEvent('next','click');a.up('photoviewer').lookupController().nextPhoto()}},bind:{hidden:'{!nextPrevButtonsVisible}'}}]},{xtype:'streampositioncontrols',reference:'streampositioncontrols',hidden:!0,bind:{hidden:'{ptzControlsHidden}'}},{xtype:'container',x:17,y:20,layout:{type:'vbox',align:'center'},width:120,bind:{width:'{positionControlsWidth}'},viewModel:{formulas:{positionControlsWidth:function(a){return a('showWebcamPositionSelector')?120:36}}},defaults:{hidden:!0},items:[{xtype:'photopositioncontrols',bind:{hidden:'{!showPhotoPositionControls}'}},{xtype:'webcampositionselector',bind:{hidden:'{!showWebcamPositionSelector}'}}]},{xtype:'photoviewerfullscreentoggle',bind:{pressed:'{fullscreen}',hidden:'{!overlayVisible}'},listeners:{click:'onFullscreenClick'}}],listeners:{boxready:'onBoxReady',el:{contextmenu:'onContextMenu',scope:'self.controller'},resize:'onResize'},getStaticHSpace:function(){return 0},getStaticVSpace:function(){return 0},onEnable:function(){Ext.panel.Panel.prototype.onEnable.apply(this,arguments);this.unmask()}},0,['photocontainer'],['component','box','container','panel','photocontainer'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photocontainer':!0},['widget.photocontainer'],0,[photoViewer.view.photocontainer,'PhotoContainer'],0);Ext.cmd.derive('photoViewer.view.photocontainer.PhotoViewerFullscreenToggle',Ext.button.Button,{cls:'full-image-button',width:28,height:20,config:{enableToggle:!0},ui:'plain',icon:'mds/image/icon/fullscreen-enter.png',mvPreloadImages:['mds/image/icon/fullscreen-enter.png'],style:{bottom:'6px',right:'6px'},tooltip:{localized:{text:'PV_Toggle Fullscreen'},anchor:'top'}},0,['photoviewerfullscreentoggle'],['component','box','button','photoviewerfullscreentoggle'],{'component':!0,'box':!0,'button':!0,'photoviewerfullscreentoggle':!0},['widget.photoviewerfullscreentoggle'],0,[photoViewer.view.photocontainer,'PhotoViewerFullscreenToggle'],0);Ext.cmd.derive('photoViewer.view.photomenu.ContextMenu',Ext.menu.Menu,{ui:'dark2',cls:'photo-actions-menu',floating:!0,showSeparator:!1,shadow:!1,defaultMinWidth:103,width:102,defaults:{height:21},items:[{localized:{text:'PV_Save Photo'},listeners:{click:'downloadCurrentImage'}},{localized:{text:'PV_Show Exif Info'},listeners:{click:'showExifInfo'}}],listeners:{mouseleave:function(){this.hide()}}},0,['photoviewercontextmenu'],['component','box','container','panel','menu','photoviewercontextmenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'photoviewercontextmenu':!0},['widget.photoviewercontextmenu'],0,[photoViewer.view.photomenu,'ContextMenu'],0);Ext.cmd.derive('photoViewer.view.photoviewer.PhotoViewerController',Ext.app.ViewController,{config:{storeSession:null},slideInterval:4000,canSnapshot:!0,flowplayer:null,activeTypes:['activePhoto','activeStream','activeTimelapse'],init:function(){Ext.on('resize',this.onViewerResize,this);var d=window.app.getController('photoActions.controller.ToolbarActions');this.oldInterfaceControl=d.interfaceControl;d.interfaceControl=this;this.oldToolbarActionsMainView=d.mainView;d.mainView=this.getView();this.oldExtMsg=Ext.Msg;Ext.Msg=Ext.MessageBox=MDS.Msg;var a=this.getViewModel();a.bind('{annotating}',this.onAnnotatingToggle,this);a.bind({activePhoto:'{activePhoto}',photoStore:'{photoStore}',photoStoreLoaded:'{photoStoreLoaded}'},this.onActivePhotoChange,this);a.bind({FloorplanUID:'{FloorplanUID}'},function(a){if(a.FloorplanUID){if(a.floorplanModeOn){this.loadFloorplan(this.lookupReference('largeFloorplanViewer').down('fvFloorplanViewer'),a.FloorplanUID)}else {this.loadFloorplan(this.lookupReference('smallFloorplanView').down('fvFloorplanViewer'),a.FloorplanUID)}}},this);a.bind({floorplanModeOn:'{floorplanModeOn}'},function(b){if(!this.floorplanModeOnInitialized){this.floorplanModeOnInitialized=!0;return}if(this.getViewModel().get('FloorplanUID')){var a=app.getController('photoViewer.controller.SiteWalk360Controller');if(b.floorplanModeOn){this.loadFloorplan(this.lookupReference('largeFloorplanViewer').down('fvFloorplanViewer'),this.getViewModel().get('FloorplanUID'))}else {this.loadFloorplan(this.lookupReference('smallFloorplanView').down('fvFloorplanViewer'),this.getViewModel().get('FloorplanUID'))}if(this.getViewModel().get('activePhoto.IsInteriorPano')){a.displayPanoMarkersOnFloorplan()}else {app.getController('photoViewer.controller.SiteWalk360Controller').removePanoLayer()}}},this);a.bind({largeFloorplanReady:'{largeFloorplanReady}',activePhoto:'{activePhoto}',floorplanModeOn:'{floorplanModeOn}'},function(a){if(a.largeFloorplanReady&&a.activePhoto&&a.floorplanModeOn&&!this.getViewModel().get('activePhoto.IsInteriorPano')){this.lookupReference('largeFloorplanViewer').down('fvFloorplanViewer').highlight2(a.activePhoto.get('HotspotID'),a.activePhoto.get('PushpinUID'),!0)}},this);a.bind({smallFloorplanReady:'{smallFloorplanReady}',activePhoto:'{activePhoto}',floorplanModeOn:'{floorplanModeOn}'},function(a){if(a.smallFloorplanReady&&a.activePhoto&&!a.floorplanModeOn&&!this.getViewModel().get('activePhoto.IsInteriorPano')){this.lookupReference('smallFloorplanView').down('fvFloorplanViewer').highlight2(a.activePhoto.get('HotspotID'),a.activePhoto.get('PushpinUID'),!0)}},this);a.bind({isInteriorPano:'{activePhoto.IsInteriorPano}',smallFloorplanReady:'{smallFloorplanReady}'},function(a){if(a.smallFloorplanReady){this.lookupReference('smallFloorplanView').down('fvFloorplanViewer').setPanoHotspotLayerVisible(!0)}},this);a.bind({isInteriorPano:'{activePhoto.IsInteriorPano}',largeFloorplanReady:'{largeFloorplanReady}'},function(a){if(a.largeFloorplanReady){this.lookupReference('largeFloorplanViewer').down('fvFloorplanViewer').setPanoHotspotLayerVisible(!0)}},this);var e=a.bind({albumStoreLoaded:'{albumStoreLoaded}',photoGroup:'{photoGroup}',albumStore:'{albumStore}'},function(a){if(!a.albumStore||!a.albumStoreLoaded||!a.photoGroup){return}e.destroy();this.onAlbumStoreLoaded(a.albumStore,a.photoGroup)},this);a.bind({PushpinUID:'{PushpinUID}'},this.onPushpinChange,this);a.bind({photoGroup:'{photoGroup}'},this.onPhotoGroupChange,this);a.bind({floorplan:'{lockMode}'},this.onLockModeChange,this);a.bind({lockMode:'{lockMode}'},this.onLockModeChange,this);a.bind('{measuring}',this.onMeasuringToggle,this);a.bind({measureStep:'{measureStep}',measuring:'{measuring}'},this.onMeasuringStepChange,this);a.bind({cachedCmiPhotoID:'{cachedCmiPhotoID}',unalteredImagePhotoID:'{unalteredImagePhotoID}',activePhotoID:'{activePhoto.Identifier}'},function(a){if(a.cachedCmiPhotoID&&a.cachedCmiPhotoID==a.activePhotoID&&a.unalteredImagePhotoID&&a.unalteredImagePhotoID==a.activePhotoID){this.onMeasuringReady()}},this);a.bind('{gettingCmiLength}',this.onGettingCmiLengthChange,this);a.bind('{sidePanelCollapsed}',this.onSidePanelCollapseChange,this);a.bind('{photoThumbsCollapsed}',this.onPhotoThumbsCollapseChange,this);a.bind('{activeMeasurement.Length}',this.onActiveMeasurementLengthChange,this);a.bind('{usingMetric}',this.usingMetricChange,this);a.bind('{thumbPage}',this.onThumbPageChange,this);a.bind('{viewMode}',this.onViewModeChange,this);a.bind('{viewModeButtonValue}',this.onViewModeToggle,this);a.bind('{FloorplanUID}',function(a){analytics.Ctrl.setOptionalDefaultEventProperties({'Floorplan UID':a})},this);a.bind('{permissionsLoaded}',this.onPermissionsLoaded,this);a.bind({webcamPlaybackReady:'{webcamPlaybackReady}',activeStream:'{activeStream}'},Ext.bind(function(a){this.getLivestreamWeather();if(a.activeStream){if(a.webcamPlaybackReady){this.initStream(a.activeStream)}else {this.initWebcamPlayback(a.activeStream)}}},this));a.bind({flowplayerLoaded:'{flowplayerLoaded}',activeTimelapse:'{activeTimelapse}'},Ext.bind(function(a){if(a.activeTimelapse){if(a.flowplayerLoaded){this.initTimelapsePlayback(a.activeTimelapse)}else {this.loadFlowplayer()}}},this));a.bind('{activeWebcam}',function(a){if(a){this.loadWebcamArchivePositions(a)}},this);a.bind('{selectedWebcamPosition}',this.loadWebcamPhotoDates,this);var b=this.getView();if(b.activePhoto){a.set('activePhoto',b.activePhoto)}if(b.photoGroup){a.set('photoGroup',b.photoGroup)}if(b.standalone!==undefined){a.set('standalone',b.standalone)}if(b.standalone!==undefined){a.set('standalone',b.standalone)}if(b.ListTypeID!==undefined){a.set('ListTypeID',b.ListTypeID)}var c=b.webcams;if(!c){c=Ext.create('photoViewer.store.Webcams',{proxy:{extraParams:{ProjectUID:a.get('ProjectUID')}},listeners:{load:function(){a.set('_webcamsLoaded',!0)}}})}else {a.set('_webcamsLoaded',!0)}a.set('webcams',c);if(!c.isLoaded()&&!c.isLoading()){if(b.WebcamUID){c.load()}else {a.bind('{photoStoreLoaded}',function(b){if(b&&!a.get('webcams').isLoaded()&&!a.get('webcams').isLoading()){var d=a.get('photoStore');if(d.query('Type','W').length>0){c.load()}}},this)}}if(!b.photoGroup&&b.WebcamUID){Ext.defer(function(){this.launchWebcamView(b.WebcamUID)},1,this)}this.setStoreSession(b.storeSession||Ext.create('Ext.data.Session'));this.pendingPhotoID=b.photoId;this.keyNavArrows=new Ext.util.KeyNav({target:Ext.getBody(),left:function(a){this.thumbsArrowKeys(a);return !0},right:function(a){this.thumbsArrowKeys(a);return !0},scope:this});this.lookupReference('measureTW').alignTarget=this.lookupReference('photoContainer');this.lookupReference('annotationsTW').alignTarget=this.lookupReference('photoContainer');this.control({'fvFloorplanViewer':{'hotspot_click':function(d,e){var a=this.getViewModel(),b=a.get('photoStore');this.mapHotspotID=d.id;a.set('PushpinUID',null);if(!this.mapHotspotID||!b.isLoaded()){return}var c=b.findRecord('HotspotID',this.mapHotspotID);if(!c){this.loadPhotosFromHotspot(this.mapHotspotID)}else {a.set('activePhoto',c)}},'pushpin_click':function(c,a){var b=this.getViewModel();this.mapHotspotID=a.id;b.set('PushpinUID',a.id)},'map_ready':function(a){if(a.up('clientFloorplanViewerDisp').xtype=='photoviewerfloorplanclose'){var b=this.lookupReference('minimapFloorplanView');if(b._mainMap!=a.map){b.reinit();b._mainMap=a.map;a.addSeparateMiniMap(b.map)}this.getViewModel().set('largeFloorplanReady',!0)}else {this.getViewModel().set('pvFloorplan',a.lookupViewModel().get('floorplan'));this.getViewModel().set('smallFloorplanReady',!0)}}},'comments':{commentcountchange:function(c){var a=this.getViewModel().get('photoStore'),b=a.getAt(a.find('id',c.Identifier));if(b){b.set('CommentCount',c.nComments)}}}});Ext.tip.QuickTipManager.destroy();Ext.tip.QuickTipManager.init(!0,{className:'photoViewer.view.photoviewer.PhotoViewerToolTip'})},closePhotoViewer:function(){if(this.getViewModel().get('standalone')){var a={};var c=['aClientPhotoViewer.view'];var b=document.referrer.split('index.cfm');if(b.length>1){a=Ext.Object.fromQueryString(b[1])}var d=Ext.Object.fromQueryString(document.location.search).backOK=='1';if(this.getViewModel().get('activeWebcam')&&a.fuseaction=='aClientWebcam.grid'){window.location.href=mdslink.clientWebcamOverview+'ProjectUID='+this.getViewModel().get('ProjectUID');return}if(document.referrer&&!Ext.Array.contains(c,a.fuseaction)||d){if(window.history.length>1){window.history.back()}else {window.location.href=document.referrer}}else {window.location.href=archiverConfig.GATEWAY+'?ProjectUID='+this.getViewModel().get('ProjectUID')}}else {this.onDestroy();this.getView().destroy();if(window.app){window.app.fireEvent('photoviewerdestroy')}}},getPhotoComponent:function(){return this.lookupReference('photoContainer').lookupController().lookupReference('photo')},loadSelectedImage:function(){var b=this.getViewModel(),c=b.get('activePhoto'),f='',e='',d=new Image(),a=new Image();b.set('photoState.fullImageLoaded',!1);b.set('src','mds/image/transparent.png');app.fireEvent('photoviewerbeforeloadphoto',c);if(!c.get('isPano')){var g=this.lookupReference('photoContainer').getController();f=c.get('ImageURLMedium');e=c.get('ImageURL');d.onload=function(){if(typeof b.isDestroyed!=='undefined'&&b.isDestroyed){return}b.set('src',d.src);a.src=e;c.set({'MediumWidth':d.naturalWidth,'MediumHeight':d.naturalHeight});var f=g.getDefaultPhotoDimenstions();a.style.width=f.width+'px';a.style.height=f.height+'px';a.style.width=f.width+'px';a.style.height=f.height+'px';a.style.position='fixed';a.style.left='-99999px';a.style.top='-99999px';document.body.appendChild(a);a.onload=function(){if(typeof b.isDestroyed!=='undefined'&&b.isDestroyed){return}b.set('src',e);c.set('OriginalsWidth',a.naturalWidth);c.set('OriginalsHeight',a.naturalHeight);b.set('photoState.fullImageLoaded',!0);a.parentNode.removeChild(a);if(!b.get('hasSpecialViewer')){analytics.Ctrl.log('Viewed Photo',{},['Photo ID','Photo Type','Photo ID with Prefix'])}};a.src=e};d.src=f}},onAnnotationsStoreLoad:function(a){if(a.getProxy().getExtraParams().photo==this.getViewModel().get('activePhoto.id')){this.getViewModel().set('annoProps.storeLoaded',!0)}},onAnnotatingToggle:function(a){this.toggleToolWindow(a,this.lookupReference('annotationsTW'))},onMeasuringToggle:function(d){this.clearActiveMeasurement();var a=this.getViewModel(),b=new Image(),g=a.get('activePhoto.Identifier'),c=this.lookupReference('photoContainer');if(d){analytics.Ctrl.log('Toggled on Measurement Tools',{},['Photo ID','Photo Type','Photo ID with Prefix']);var e=Ext.bind(function(){Ext.Msg.alert(mvstr['G_Failure'],mvstr['PVM_Could not initialize ']);a.set('measuring',!1);b.onerror=null;b.src=''},this);c.setLoading(!0);this.cacheCmi({success:function(b){a.set('cachedCmiPhotoID',b.photoID)},failure:e,scope:this,photoID:a.get('activePhoto.Identifier'),cmiName:a.get('activePhoto.CmiName')});c.getController().lookupReference('photo').getController().removeAllDrawables();b.onload=function(){a.set('unalteredWidth',b.width);a.set('unalteredHeight',b.height);a.set('unalteredImagePhotoID',g);Ext.defer(function(){c.lookupController().switchImageSize(b.width,b.height)},1)};b.onerror=e;b.src=a.get('activePhoto.ImageURLUnaltered');a.set('measureStep',photoViewer.Values.MSR_ZERO_POINTS)}else {var f=!!a.get('unalteredImagePhotoID');a.set('cachedCmiPhotoID',0);a.set('unalteredImagePhotoID',0);a.set('unalteredWidth',0);a.set('unalteredHeight',0);if(f){Ext.defer(function(){c.lookupController().switchImageSize(a.get('activePhoto.OriginalsWidth'),a.get('activePhoto.OriginalsHeight'))},1)}this.toggleToolWindow(d,this.lookupReference('measureTW'));c.setLoading(!1)}},cacheCmi:function(a){var f=this.getViewModel(),c=a.tries||0,e=a.success||Ext.emptyFn,d=a.failure||Ext.emptyFn,b=a.scope||this;if(f.get('activePhoto.Identifier')!=a.photoID){return}if(c>=50){d.call(b);return}Ext.Ajax.request({url:'/index.cfm?fuseaction=aArgos.isCmiCached',params:{photoID:a.photoID,cmiName:a.cmiName},successCallback:function(d){if(d.cached){e.call(b,a)}else {a.tries=c+1;Ext.defer(this.cacheCmi,500,this,[a])}},noAlert:!0,afterFailMessageCallback:a.failure,scope:this})},onMeasuringReady:function(){var a=this.getViewModel();this.lookupReference('photoContainer').setLoading(!1);this.toggleToolWindow(!0,this.lookupReference('measureTW'));a.set('src',a.get('activePhoto.ImageURLUnaltered'))},onMeasuringStepChange:function(a){if(!a.measuring){return}if(a.measureStep<=photoViewer.Values.MSR_ZERO_POINTS){this.clearActiveMeasurement()}this.getViewModel().set('toolSettings.mode',a.measureStep==photoViewer.Values.MSR_ZERO_POINTS?'measure':'select')},clearActiveMeasurement:function(){var a=this.getViewModel(),b=a.get('activeMeasurement');a.set('measurementString','');if(a.get('measureStep')>photoViewer.Values.MSR_ZERO_POINTS){a.set('measureStep',photoViewer.Values.MSR_ZERO_POINTS)}if(b){a.get('measurementsStore').remove(b);b.destroy()}a.set('activeMeasurement',null)},doMeasurementAction:function(){var a=this.getViewModel(),b=a.get('activeMeasurement');if(a.get('measureStep')==photoViewer.Values.MSR_TWO_POINTS){a.set('measureStep',photoViewer.Values.MSR_CALCULATING);Ext.Ajax.request({url:'/index.cfm?fuseaction=aArgos.getCmiLength',jsonData:{lines:[{start:{x:b.getRecordValueByAttrName('x0'),y:b.getRecordValueByAttrName('y0')},end:{x:b.getRecordValueByAttrName('x1'),y:b.getRecordValueByAttrName('y1')}}],numberOfLines:1,id:'0',cmiName:a.get('activePhoto.CmiName'),photoID:a.get('activePhoto.Identifier')},successCallback:function(c){var d=a.get('activeMeasurement');if(d!=b){return}a.set('measureStep',photoViewer.Values.MSR_TWO_POINTS);if(c.length==='0'||c.message=='No Measurement'){Ext.Msg.alert(mvstr['PVM_Calculation Failed'],mvstr['PVM_Could not use these t']);return}if(!c.length){Ext.Msg.alert(mvstr['PVM_Calculation Failed'],mvstr["PVM_Please try to 'Calcul"]);return}b.setAttrs({'length':Number(c.length),'oScale':(a.get('activePhoto.OriginalsWidth')/a.get('unalteredWidth')).toFixed(3)});a.set('measureStep',photoViewer.Values.MSR_DONE);a.set('measurementString',b.get('MeasurementString'));b.shape.refreshMeasurementLabel(!0)},scope:this,noAlert:!0,afterFailMessageCallback:function(b,c){a.set('measureStep',photoViewer.Values.MSR_TWO_POINTS);if(b&&b.message=='Buzy'){Ext.Msg.alert(mvstr['G_Error'],mvstr['PVM_Unable to measure at '])}else {if(b&&b.message=='CMI Not Found'){a.set('measureStep',photoViewer.Values.MSR_TWO_POINTS);this.cacheCmi({success:this.doMeasurementAction,failure:function(){Ext.Msg.alert(mvstr['G_Error'],mvstr['PVM_Could not reinitializ'])},scope:this,photoID:a.get('activePhoto.Identifier'),cmiName:a.get('activePhoto.CmiName')})}else {Ext.Msg.alert(mvstr.G_Error,mvstr.G_UnexpectedError)}}}})}else {a.get('drawablesStore').add(b);a.set('activeMeasurement',null);a.set('measureStep',photoViewer.Values.MSR_ZERO_POINTS);b.redraw()}},onGettingCmiLengthChange:function(a){if(a){this.lookupReference('photoContainer').setLoading(!0)}else {this.lookupReference('photoContainer').setLoading(!1)}},onActiveMeasurementLengthChange:function(b){var c=this.getViewModel(),a=this.getViewModel().get('measureStep');if(!b&&a>photoViewer.Values.MSR_TWO_POINTS){c.set('measureStep',photoViewer.Values.MSR_TWO_POINTS)}},toggleToolWindow:function(b,a){if(b){a.showBy(a.alignTarget)}else {a.hide()}},onThumbClick:function(l,a,k,j,i){var b=this.getViewModel(),f=Ext.fly(i.getTarget()),g=f.hasCls('select'),e=b.get('ProjectUID'),c=b.get('favouritesAlbumUID');if(g){var h=!a.get('Selected');a.set('Selected',h);b.set('lastSelectionChange',(new Date()).getTime())}else {if(f.hasCls('favourite-btn')){var d=!a.get('IsFavourite');a.set('IsFavourite',d);if(d){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoList.updateAlbum',params:{ProjectUID:e,AlbumUID:c,photos:a.get('id')},afterFailMessageCallback:function(){a.set('IsFavourite',!a.get('IsFavourite'))},scope:this})}else {Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoList.removeMultipleFromAlbum',params:{ProjectUID:e,data:Ext.encode([{AlbumUID:c,mixedPhotoArray:[a.get('id')]}])},afterFailMessageCallback:function(){a.set('IsFavourite',!a.get('IsFavourite'))},scope:this})}}else {b.set('activePhoto',a)}}},onWebcamThumbClick:function(b,a){this.launchWebcamView(a.get('WebcamUID'))},getPhotoEventProperties:function(d){var a=d.getPhotoEventProperties(),b=this.getActivePhoto();if(b&&b.getId()==d.getId()){var c=this.getViewModel().get('viewMode');if(c==photoViewer.Values.VIEW_TRUVIEW){a['Photo Type']='TruView'}else {if(c==photoViewer.Values.VIEW_SITEWALK360){a['Photo Type']='SW360'}}}return a},onActivePhotoChange:function(a){if(!a.photoStore||!a.activePhoto||!a.photoStoreLoaded){return}this.loadSelectedImage(a.activePhoto);var b=this.getViewModel();b.set('commentViewData',{CommentType:'photo',CommentCount:b.get('photoData.nComments'),Identifier:b.get('photoData.id'),BufferLoad:!0});if(b.get('FloorplanUID')!=a.activePhoto.get('FloorplanUID')){b.set('smallFloorplanReady',!1);b.set('largeFloorplanReady',!1);b.set('FloorplanUID',a.activePhoto.get('FloorplanUID'))}b.set('annotating',!1);if(a.photoStore.isLoaded()){var c=a.photoStore.indexOf(a.activePhoto);this.lookupReference('thumbsContainer').gotoThumb(c);this.loadThumbs(c)}},loadThumbs:function(c){var b=this.getViewModel().get('photoStore'),g=this.lookupReference('thumbsContainer'),h=b.getCount()-1,d=[];c=Math.max(0,Math.min(h,c));this.loadThumb(b.getAt(c));var i=this.getViewModel().get('bufferSize');for(var a=0;a<i;a++){var e=c+a,f=c-a;if(e<=h){if(g.thumbVisible(e)){this.loadThumb(b.getAt(e))}else {d.push(e)}}if(f>=0){if(g.thumbVisible(f)){this.loadThumb(b.getAt(f))}else {d.push(f)}}}for(var a=0;a<d.length;a++){this.loadThumb(b.getAt(d[a]))}},loadThumb:function(a){if(!a||a.get('LoadedImage')||a.loadingMediumImage){return}a.loadingMediumImage=!0;var b=new Image();b.onload=function(){a.set('LoadedImage',this.src);a.set({'MediumWidth':b.naturalWidth,'MediumHeight':b.naturalHeight})};b.onerror=function(){b.onerror=function(){a.set('LoadedImage',0)};b.src=a.get('ImageURLThumb')};b.src=a.get('ImageURLMedium')},onThumbPageChange:function(a){this.loadThumbs(a*this.getViewModel().get('nThumbsPerPage'))},onAlbumStoreLoaded:function(d,a){if(a.get('Type')=='A'){var c=d.getById(a.get('Identifier'));if(!c){a.set('IsMine',!1)}else {a.set('IsMine',c.get('IsUserAlbum'))}}var b=d.queryBy(function(b){return b.get('IsFavouritesAlbum')}).getAt(0);if(b){this.getViewModel().set('favouritesAlbumUID',b.get('AlbumUID'))}},nextPhoto:function(c){var d=this.getViewModel(),c=c||1;if(d.get('activeStream')){return this.nextStream(c)}var g=d.get('activePhoto'),b=d.get('photoStore'),e=b.indexOf(g),a=e+c;if(a>=b.getCount()){a=0}if(a<=-1){a=b.getCount()-1}var f=b.getAt(a);if(a!=e){d.set('activePhoto',f)}return f},prevPhoto:function(){this.nextPhoto(-1)},nextStream:function(g){var e=this.getViewModel(),f=e.get('activeWebcam'),b=e.get('webcams'),c=b.indexOf(f),a=c+g;if(a>=b.getCount()){a=0}if(a<=-1){a=b.getCount()-1}var d=b.getAt(a);if(a!=c){this.launchWebcamView(d.get('WebcamUID'))}return d},loadFloorplan:function(b,c){this.floorplanLoadPhoto=this.getViewModel().get('activePhoto');var d=this.floorplanLoadPhoto.get('IsInteriorPano');b.setHighlightInteriorPanoHotspots(d);b.setZoomOutInteriorPanoHotspots(!0);b.setShowInteriorPanoHotspots(!0);var a=b.lookupViewModel();if(!a.get('_recordfloorplan')||a.get('_recordfloorplan.FloorplanUID')!=c){b.mask('');a.set('_recordfloorplan',null);a.set('FloorplanUID',null);a.set('ListTypeID',this.getViewModel().get('ListTypeID'));a.notify();a.set('FloorplanUID',c);a.set('ProjectUID',this.getViewModel().get('ProjectUID'))}},gotoFloorplan:function(){var a=this.getViewModel();var b={ProjectUID:a.get('ProjectUID'),FloorplanUID:a.get('FloorplanUID')},e=a.get('activePhoto.HotspotID'),d=a.get('PushpinUID'),c=a.get('ListTypeID');if(e){b.hotspotID=e}if(d){b.pushpinUID=d}if(c){b.ListTypeID=c}document.location=a.get('floorplanViewerLink')+Ext.Object.toQueryString(b)},onPushpinChange:function(a){if(!a.PushpinUID){return}var b=this.getViewModel();b.set('photoGroup',Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':a.PushpinUID,'Type':'N'}))},onPhotoGroupChange:function(c){if(!c.photoGroup){return}var b=this.getViewModel(),a=c.photoGroup.getPhotoStore(this.getViewModel().get('ProjectUID'),this.getStoreSession(),null,{load:{fn:function(a){},scope:this}});if(c.photoGroup.get('Type')=='A'){a.sort('PhotoDate','DESC')}else {if(c.photoGroup.get('Type')=='H'){a.sort('PhotoDate','ASC');a.proxy.extraParams.LookupDate='';if(!b.get('lockMode')){b.set('lockMode','lockToHotspot')}}}b.set('photoStore',a);if(a.isLoaded()){this.onPhotoStoreLoad(a)}else {b.set('nPhotos',0);b.set('photoStoreLoaded',0);b.set('firstScrollDone',!1);b.set('nextActive',!1);b.set('prevActive',!1);a.addListener('load',this.onPhotoStoreLoad,this,{single:!0});a.load()}},onPhotoStoreLoad:function(a){if(!a.isLoaded()){Ext.Msg.alert(mvstr['G_Error'],mvstr['PV_Photos do not exist o']);this.getView().destroy();return}var c=this.getViewModel(),f=a.getCount();c.set('nPhotos',a.getCount());c.set('photoStoreLoaded',!0);this.lookupReference('photoContainer').setLoading(!1);if(f){var e=a.getRange();for(var d=0;d<e.length;d++){if(!e[d].get('PhotoNumber')){e[d].set('PhotoNumber',d+1)}}var b=0;if(this.pendingPhotoID){b=a.find('id',this.pendingPhotoID)}else {if(a.record.get('Type')=='W'){b=f-1}else {b=a.find('HotspotID',this.mapHotspotID)}}this.pendingPhotoID=0;if(b==-1){b=0}c.set('activePhoto',a.getAt(b))}else {var g=c.get('photoGroup').get('Type');if(g=='N'){MDS.Msg.alert('',mvstr['PV_There are no photos p'])}if(g=='C'){MDS.Msg.alert('',mvstr['PV_Custom Slideshow Error'])}c.set('src','')}},loadPhotosFromHotspot:function(a){var c=this.getViewModel(),d=c.get('activePhoto'),f=c.get('lockMode'),h=c.get('pvFloorplan'),e=this.lookupReference('photoContainer'),g=c.get('ProjectUID'),b=this;a=a||d.get('HotspotID');if(d.get('HotspotID')!=a){d=b.floorplanLoadPhoto}e.setLoading(!0);mdsAjax.doAjaxRequest({url:'/index.cfm?fuseaction=aClientPhotoViewer.getHotspotClickData&HotspotID='+a+'&ProjectUID='+g,scope:b,successCallback:function(c){b.pendingPhotoID='P'+c[0].PhotoID;b.getViewModel().set('photoGroup',Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':f=='lockToHotspot'?a:c[0].ProjectShootTypeUID,'Type':f=='lockToHotspot'?'H':'D','StartDate':customData.fields.tzadate.convertFn(c[0].ShootDate),'Locations':[h.get('floorplanTitle')]}))},afterFailMessageCallback:function(){e.setLoading(!1)}})},onLockModeChange:function(a){var b=this.getViewModel();if(!b.get('pvFloorplan')){b.bind('{pvFloorplan}',function(){this.onLockModeChange(a)},this,{single:!0});return}if(a.lockMode){this.loadPhotosFromHotspot()}},onThumbsResize:function(f,c){if(!c){return}var e=123,d=137,b=4,a=Math.floor((c-(d+b))/(e+b))+1;this.getViewModel().set('nThumbsPerPage',a);this.getViewModel().set('bufferSize',a*2)},onAnnotationsDataChanged:function(d){var c=d.getProxy().getExtraParams().photo,b=this.getViewModel().get('photoStore'),a=b.getAt(b.find('id',c));if(a){a.set('HasAnnotations',d.getCount()>0)}if(c==this.getViewModel().get('activePhoto.id')){this.getViewModel().set('drawablesDataChange',(new Date()).getTime())}},getFloorplan:function(){if(this.getViewModel().get('floorplanModeOn')){return this.lookupReference('largeFloorplanViewer').down('fvFloorplanViewer')}else {return this.lookupReference('smallFloorplanView').down('fvFloorplanViewer')}},onDestroy:function(){Ext.un('resize',this.onViewerResize,this);this.disableSlideshow();window.app.getController('photoViewer.controller.SiteWalk360Controller').clearAll();var a=window.app.getController('photoActions.controller.ToolbarActions');a.interfaceControl=this.oldInterfaceControl;a.mainView=this.oldToolbarActionsMainView;Ext.Msg=Ext.MessageBox=this.oldExtMsg;this.keyNavArrows.destroy(!1);Ext.tip.QuickTipManager.destroy();Ext.tip.QuickTipManager.init()},getSelectedPhotoIDs:function(c){var d=this.getSelectedPhotos(),a=[];for(var b=0;b<d.length;b++){a.push(d[b].get('id'))}if(c){c(a)}return a},getSelectedPhotos:function(){return this.getViewModel().get('selectedPhotos').getRange()},onBatchAddComments:function(b){var d=this.getViewModel(),c=d.get('activePhoto').get('id');for(var a=0;a<b.length;a++){if(c==b[a].get('id')){this.lookupReference('comments').lookupController().loadComments();return}}},onPhotosDeleted:function(c){var d=[],a=this.getViewModel().get('photoStore'),e=this.getViewModel();for(var b=0;b<c.UDEFPhotoUIDs.length;b++){d.push(a.getById(c.UDEFPhotoUIDs[b]))}a.remove(d);e.set('lastSelectionChange',(new Date()).getTime());e.set('nPhotos',a.getCount())},getOpenAlbum:function(){return this.albumStore.getById(this.getViewModel().get('photoGroup').get('Identifier'))},toggleAnnotationsVisible:function(){var a=this.getViewModel();a.set('annoProps.toggledOn',!a.get('annoProps.toggledOn'))},onSlideshowToggle:function(){var d=this.getViewModel(),b=!d.get('slideshowOn');d.set('slideshowOn',b);if(b){Ext.asap(function(){if(this.slideshowClickListener){this.slideshowClickListener.destroy()}this.slideshowClickListener=this.getView().el.addListener('click',this.disableSlideshow,this,{destroyable:!0})},this);var e=5*60*1000,a,c=Ext.bind(function(){clearInterval(this.intervalTimeout);var b=(new Date()).getTime();if(!a||b-a>=e){a=b}var f=this.nextPhoto(),d=this.slideInterval;if(f&&f.get('isInteriorPano')){d*=2}this.intervalTimeout=window.setTimeout(c,d)},this);this.intervalTimeout=window.setTimeout(c,this.slideInterval)}else {this.disableSlideshow()}},disableSlideshow:function(){if(this.slideshowClickListener){this.slideshowClickListener.destroy()}this.getViewModel().set('slideshowOn',!1);if(!this.intervalTimeout){return}clearInterval(this.intervalTimeout);delete this['intervalTimeout']},keepAlive:function(){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoViewer.keepAlive'})},showContextMenu:function(b){var a=this.lookupReference('photoContainer').getEl();this.lookupReference('contextMenu').showAt([b.getX()-a.getX(),b.getY()-a.getY()])},savePhoto:function(){window.app.getController('photoActions.controller.ToolbarActions').saveSinglePhoto(this.getViewModel().get('activePhoto.id'))},showExifInfo:function(){this.lookupReference('exifDisplay').lookupController().showExifInfo()},saveInteriorPanoSnapshotToComputer:function(a,b){this.saveSnapshotToComputer('InteriorPano',a,b)},save360PanoSnapshotToComputer:function(a){this.saveSnapshotToComputer('360Pano',a)},saveWebcamStreamSnapshot:function(e,f){var c=this.getViewModel(),d=c.get('activeWebcam'),a=c.get('selectedWebcamPosition'),b=this.lookupReference('photoContainer');if(a){a=Ext.Array.findBy(d.get('ArchivePositions'),function(b){return b.ArchivePositionID===a.get('ArchivePositionID')})}b.setLoading(!0);Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.doSnapshot',timeout:60000,params:{WebcamUID:d.get('WebcamUID'),ProjectUID:c.get('ProjectUID'),ArchivePositionID:a?a.ArchivePositionID:0},successCallback:function(a){b.setLoading(!1);if(f){var c=Ext.create('mdsData.model.Photo',{Identifier:a.WebcamPhotoUID,WebcamPhotoUID:a.WebcamPhotoUID,Type:'W',ImageURL:a.ImageURLs.webcam_original,ImageURLThumb:a.ImageURLs.webcam_thumb,ImageURLMedium:a.ImageURLs.webcam_medium});e(c)}else {e(['W'+a.WebcamPhotoUID])}},afterFailMessageCallback:function(){b.setLoading(!1)},noResponseCallback:function(){b.setLoading(!1);Ext.Msg.alert(mvstr.G_Error,mvstr.G_UnexpectedError)}})},takeInteriorPanoSnapshot:function(c){var e=window.hasOwnProperty('iwResolutionOptions')?window.iwResolutionOptions:{width:4000,height:2667};var a=this.lookupReference('photoContainer').lookupController();var b=a.siteWalkTakeScreenShot(e);if(c){var d=a.siteWalkGetPose();return Promise.all([b,d])}return b},take360PanoSnapshot:function(){var a=this.lookupReference('photoContainer').lookupController();return a.pannellumTakeScreenshot()},saveSnapshotToComputer:function(a,c,d){var b=this;this['take'+a+'Snapshot']().then(function(e){var h=e?e.length:-1;if(h>0){var f=!1;if(Ext.isChrome||Ext.isGecko||Ext.isWebKit){try{b.downloadBase64Blob(e);f=!0}catch(i){console.log('Failed to save image blob',i)}}if(!f){var g=g||b.getSelectedPhotoIDs();c(g,e)}}else {Ext.Msg.alert(mvstr['G_Error'],mvstr['PA_Unable to take snapsh'])}},function(b){if(b){console.error(b)}Ext.Msg.alert(mvstr['G_Error'],a=='InteriorPano'?mvstr['PA_UnableSnapshotLong']:mvstr['PA_Unable to take snapsh'])})},onViewerResize:function(b,a){this.lookupReference('mainContainer').setSize(a-this.lookupReference('topToolbar').el.getHeight(),this.getView().getWidth())},onPhotoContainerResize:function(){var a=this.lookupReference('measureTW');if(a.isVisible()){a.showBy(a.alignTarget)}},openNewAlbumInViewer:function(a){this.getViewModel().set('photoGroup',Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':a,'Type':'A'}))},isInteriorPano:function(){return this.getViewModel().get('photoState.isInteriorPano')},is360Pano:function(){return this.getViewModel().get('photoState.is360Pano')},saveInteriorPanoSnapshotToUDEF:function(d,b){var c=this.getViewModel().get('viewMode')!=photoViewer.Values.VIEW_TRUVIEW;var a={mpPhotoID:this.getViewModel().get('photoData.photoId'),AlbumUID:d||''};this.takeInteriorPanoSnapshot(c).then(function(e){if(c){if(e.length==2){var f=e[0];if(f&&f.length){var g=e[1];a.base64Photo=f;a.PanoUUID=g?g.sweep:'';this.saveBase64ToUDEFPhoto(a,b)}else {b(!1,'Unable to take snapshot')}}else {console.error('No data returned for snapshot');b(!1,'Unable to take snapshot')}}else {a.base64Photo=e;a.PanoUUID=app.getController('photoViewer.controller.SiteWalk360Controller').getActivePano().uuid||'';this.saveBase64ToUDEFPhoto(a,b)}}.bind(this),function(a){console.log('Failed to take snapshot',a);b(!1,'Failed to take snapshot')})},getPannellumViewerAngle:function(){var a=this.lookupReference('photoContainer').lookupController();var b=a.getPannellumViewerAngle();return b},save360PanoSnapshotToUDEF:function(a,b){this.take360PanoSnapshot().then(function(d){var c={base64Photo:d,AlbumUID:a||''};this.saveBase64ToUDEFPhoto(c,b)}.bind(this))},saveBase64ToUDEFPhoto:function(c,b){c.ProjectUID=this.getViewModel().get('ProjectUID');var a=function(){console.error('Failed to save base 64 photo',arguments);b(!1,'Failed to save snapshot')};Ext.Ajax.request({url:mdslink.server+'/index.cfm?fuseaction=aClientPhotoList.saveBase64UDEFPhoto',method:'POST',jsonData:c,successCallback:function(a){b(!0,a)},afterFailMessageCallback:a,noResponseCallback:a})},takeInteriorPanoSnapshotForPunchlist:function(a){var b=this.getViewModel().get('viewMode')!=photoViewer.Values.VIEW_TRUVIEW;this.takeInteriorPanoSnapshot(b).then(function(d){if(b){if(d.length==2){var c=d[0];if(c&&c.length){var e=d[1];a(!0,c,e?e.sweep:'')}else {a(!1,'Unable to take snapshot')}}else {console.error('No data returned for snapshot');a(!1,'Unable to take snapshot')}}else {var c=d;a(!0,c,'')}}.bind(this),function(b){console.log('Failed to take snapshot',b);a(!1,'Failed to take snapshot')})},take360PanoSnapshotForPunchlist:function(a){this.take360PanoSnapshot().then(function(c){var b=c;a(!0,b,'')},function(){console.error('No data returned for snapshot');console.log('Failed to take snapshot',error);a(!1,'Failed to take snapshot')})},print:function(k,b,f){var e='{}',a=this.getViewModel(),i=a.get('PushpinUID'),d=a.get('ProjectUID');if(a.get('photoGroup').get('Type')==='N'){i=a.get('photoGroup').get('Identifier')}if(b.length==1){if(b[0]==a.get('activePhoto').get('id')){e=JSON.stringify(this.getPrintZoomInformation())}}if(k=='4view'){var c={photos:b,zoomInfo:e,PushpinUID:i};var h=a.get('drawablesStore').query('Visible',!1),g=[];h.each(function(a){g.push(a.getId())});if(h.length){c.hiddenAnnotations=g.join(',')}if(a.get('activePhoto.Is360Pano')){var j=this.getPannellumViewerAngle();c.Photo360ID=a.get('activePhoto.Identifier')||0;if(Ext.isNumber(j)){c.FOVAngle=j}}if(b.length<=f){Ext.Ajax.postFormData(mdslink.server+'/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+d,c,{target:'_blank'})}else {photoActions.controller.ToolbarActions.doEmailPDF(mdslink.server+'/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+d,c)}}else {if(b.length<=f){Ext.Ajax.postFormData(mdslink.server+'/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+d+'&forcePhotoOnly=true',{photos:b,zoomInfo:e},{target:'_blank'})}else {photoActions.controller.ToolbarActions.doEmailPDF(mdslink.server+'/index.cfm?fuseaction=aClientPhotoList.4ViewPDF&ProjectUID='+d+'&forcePhotoOnly=true',{photos:b,zoomInfo:e})}}},getPrintZoomInformation:function(){var j=this.lookupReference('photoContainer'),h=j.getWidth(),g=j.getHeight(),p=this.getViewModel(),o=p.get('activePhoto.OriginalsHeight'),i=this.lookupReference('photoContainer').getController().lookupReference('photo'),f=i.getWidth(),d=i.getHeight(),a={};if(f<=h&&d<=g){return {}}a.realWidth=f;a.realWidth=d;a.viewWidth=h;a.viewHeight=g;var c=j.getPosition(),b=i.getPosition(),l=b[0]+f,n=c[0]+h,k=b[1]+d,m=c[1]+g,e=o/d;if(b[0]>c[0]){a.viewWidth-=b[0]-c[0]}if(l<n){a.viewWidth-=n-l}if(b[1]>c[1]){a.viewHeight-=b[1]-c[1]}if(m>k){a.viewHeight-=m-k}a.realWidth=a.viewWidth*e;a.realHeight=a.viewHeight*e;a.x=Math.round(Math.max(0,(b[0]-c[0])*-1*e));a.y=Math.round(Math.max(0,(b[1]-c[1])*-1*e));a.viewWidth=Math.round(a.viewWidth);a.viewHeight=Math.round(a.viewHeight);a.realWidth=Math.round(a.realWidth);a.realHeight=Math.round(a.realHeight);return a},thumbsArrowKeys:function(a){var c=Ext.get(a.getTarget()),b=a.getKey();if(a.isNavKeyPress()&&!c.hasCls('x-form-text')){if(b==37){this.prevPhoto()}else {if(b==39){this.nextPhoto()}}}return !0},logNextPrevEvent:function(a,b){analytics.Ctrl.log('Clicked Next/Prev',{'Direction':a,'Source':b},['Photo ID','Photo Type','Photo ID with Prefix'])},onSidePanelCollapseChange:function(b){var a=this.lookupReference('photoViewerSidePanel');if(b){a.animate({to:{width:11},duration:250,dynamic:!0})}else {a.animate({to:{width:371},duration:250,dynamic:!0})}},onPhotoThumbsCollapseChange:function(b){var a=this.lookupReference('photoViewerThumbs');if(b){a.animate({to:{height:13},duration:100,dynamic:!0,callback:function(){Ext.asap(function(){a.setWidth('100%')})}})}else {a.animate({to:{height:145},duration:100,dynamic:!0,callback:function(){Ext.asap(function(){a.setWidth('100%')})}})}},usingMetricChange:function(b){var a=this.getViewModel().get('drawablesStore'),c=this.getViewModel().get('activeMeasurement');if(a){a.usingMetric=b;a.each(function(a){a.set('IsMetric',b)},this)}if(c){c.set('IsMetric',b)}},removeDrawable:function(a){var c=this.getViewModel(),b=c.get('drawablesStore');if(b.isSyncing){b.addListener('datachanged',this.removeDrawable,this,{args:[a],single:!0});return}if(a){if(c.get('activeMeasurement')==a){this.clearActiveMeasurement();return}b.remove(a);a.destroy()}},beforeDrawableSelectionChange:function(c){var b=this.getViewModel(),a=b.get('activeMeasurement');if(!b.get('account.canWrite')){return !1}return !(a&&a!=c)},gotoWebcamStream:function(a){var b=this.getViewModel(),a=a&&a.isModel?a:b.get('activeWebcam'),c=this.lookupReference('photoContainer');b.set('activeWebcam',a);b.set('fullscreen',!1);c.setLoading(!0);a.getFullWebcamData(b.get('ProjectUID')).then(Ext.bind(function(b){this.switchToObjectType('activeStream',b);c.setLoading(!1)},this))},gotoWebcamArchive:function(b){var c=this.getViewModel(),b=b&&b.isModel?b:c.get('activeWebcam'),a=c.get('selectedWebcamPosition'),d=c.get('webcamPositions');if(!b||!b.get('ArchivePositions')){Ext.defer(function(){this.gotoWebcamArchive()},1000,this)}if(d&&(!a||!a.get('ArchivePositionID'))){var e=d.findBy(function(a){return !!a.get('ArchivePositionID')});if(e>-1){a=d.getAt(e);c.set('selectedWebcamPosition',a)}else {a=null}}if(a){c.set('_selectedArchivePosition',a)}this.switchToObjectType('activePhoto',null);this.getViewModel().set('photoGroup',Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':b.getId(),'Type':'W','StartDate':a?a.get('MostRecentPhotoDate'):b.get('MostRecentPhotoDate'),'ArchivePositionID':a?a.get('ArchivePositionID'):0}))},gotoWebcamTimelapseOLD:function(b){var c=this.getViewModel(),b=b&&b.isModel?b:c.get('activeWebcam'),a=c.get('selectedWebcamPosition');if(!a||!a.get('TimelapseURL')){var d=c.get('webcamPositions'),e=d.findBy(function(a){return !!a.get('TimelapseURL')});if(e>-1){a=d.getAt(e);c.set('selectedWebcamPosition',a)}else {Ext.Msg.alert(mvstr.G_Error,mvstr.G_UnexpectedError);return}}this.switchToObjectType('activeTimelapse',Ext.create('photoViewer.model.Timelapse',{'WebcamUID':b.get('WebcamUID'),'ArchivePositionID':a.get('ArchivePositionID'),'TimelapseURL':a.get('TimelapseURL')}))},gotoWebcamTimelapse:function(c){var d=this.getViewModel(),c=c&&c.isModel?c:d.get('activeWebcam'),a=d.get('selectedWebcamPosition');var b={'WebcamUID':c.get('WebcamUID')};if(!a||!a.get('TimelapseURL')){var f=d.get('webcamPositions'),g=f.findBy(function(a){return !!a.get('TimelapseURL')});if(g>-1){a=f.getAt(g);b.ArchivePositionID=a.get('ArchivePositionID');b.TimelapseURL=a.get('TimelapseURL');d.set('selectedWebcamPosition',a)}else {var e=c.get('ArchivePositions');if(e&&e.length){var h=this.getView().ArchivePositionID||1;a=Ext.Array.findBy(e,function(a){return a.ArchivePositionID===h});if(!a){a=e[0]}b.ArchivePositionID=a.ArchivePositionID;b.TimelapseURL=a.TimelapseURL;d.set('_selectedArchivePosition',Ext.data.Record.create(a))}}}else {b.ArchivePositionID=a.get('ArchivePositionID');b.TimelapseURL=a.get('TimelapseURL');d.set('_selectedArchivePosition',a)}this.switchToObjectType('activeTimelapse',Ext.create('photoViewer.model.Timelapse',b))},switchToObjectType:function(d,e){var a=this.getViewModel(),c=a.get('activePhoto');if(c){a.set('photoBeforeObjectTypeSwitch',c)}a.set(d,e);for(var b=0;b<this.activeTypes.length;b++){if(d!=this.activeTypes[b]){a.set(this.activeTypes[b],null)}}},onViewModeChange:function(a){this.getViewModel().set('viewModeButtonValue',a);app.getController('photoViewer.controller.SiteWalk360Controller').switchViewer(a==photoViewer.Values.VIEW_TRUVIEW)},onViewModeToggle:function(a){if(a===''){return}if(!this.viewModeToggleInitialized){this.viewModeToggleInitialized=!0;return}this.getViewModel().set('photoState.isTruView',a==photoViewer.Values.VIEW_TRUVIEW)},onPermissionsLoaded:function(){var c=this.getView(),b=this.getViewModel(),a=c.albumStore;if(!a){a=Ext.create('photoActions.store.Albums');if(b.get('account.canWrite')){a.getProxy().setExtraParams({ProjectUID:b.get('ProjectUID')});a.load()}}this.albumStore=a;a.addListener('load',function(a){this.getViewModel().set('albumStore',a);this.getViewModel().set('albumStoreLoaded',!0)},this);if(a.isLoaded()){this.getViewModel().set('albumStore',a);this.getViewModel().set('albumStoreLoaded',!0)}},getActivePhoto:function(){return this.getViewModel().get('activePhoto')},showWelcome:function(){var b=this.getViewModel().get('greetings');if(!b.isLoaded()){b.addListener('loaded',this.showWelcome,this,{single:!0});return}var a=b.getAt(b.findExact('Name','photoViewer2019'));if(a&&!a.get('seen')){var h=Ext.getBody().getHeight(),f=490,e=418,d=(h-e)/2-200,c=Ext.create('photoViewer.view.photoviewer.PhotoViewerWelcome',{x:(Ext.getBody().getWidth()-f)/2,y:d,width:f,height:e,style:{opacity:0}});Ext.create('Ext.fx.Anim',{target:c,duration:1200,from:{opacity:0},to:{opacity:1}});Ext.create('Ext.fx.Anim',{target:c,duration:750,easing:'bounceOut',from:{y:d},to:{y:d+100}});this.getView().add(c).show();var g=a.get('GreetingID');if(g){Ext.Ajax.request({url:'/index.cfm',params:{fuseaction:'aClientNavigation.updateGreeting',GreetingID:g},method:'GET'});a.set('seen',!0);if(window.localStorage.getItem('Multivista_ClientSession')){window.localStorage.removeItem('Multivista_ClientSession')}}}},showTour:function(){var a=this.lookupReference('photoViewerWelcome');if(a){a.destroy()}if(this.getViewModel().get('activeTimelapse')){return}else {if(this.getViewModel().get('activeStream')){Ext.create('clientHelp.view.helpsequences.WebcamViewerHelpSequence',{parentView:this.getView()})}else {Ext.create('clientHelp.view.helpsequences.PhotoViewerHelpSequence',{parentView:this.getView()})}}},onPhotoViewerBoxReady:function(){this.showWelcome()},switchPhotoViewer:function(){var c=this.getViewModel(),e=c.get('photoGroup'),b=e.get('Type'),i=c.get('activePhoto'),h=i.get('Type'),f=i.getId(),d=e.get('Identifier'),a={ProjectUID:c.get('ProjectUID'),switchToOld:1};if(b=='A'){a.AlbumUID=d}else {if(b=='D'||b=='L'){b='S';a.ShootUID=e.get('ShootUID')||c.get('activePhoto').get('ShootUID')}else {if(b=='U'){a.MemberUID=d;a.PhotoGroupDate=Ext.Date.format(e.get('StartDate'),'Y-m-d')}else {if(b=='Q'){a.PunchItemID=d;a.ListTypeID=c.get('ListTypeID')}else {if(b=='M'){a.SNID1=d.split('-')[0];a.SNID2=d.split('-')[1]}else {if(b=='N'){b='P';a.PushpinUID=d;var g=c.get('ListTypeID');if(g){a.ListTypeID=g}}else {if(b=='I'){b='X'}}}}}}}a.PhotoGroupType=b;if(h=='W'){a.SelectedWebcamPhotoUID=f}else {if(h=='U'){a.SelectedUDEFPhotoUID=f}else {a.SelectedPhotoID=f}}if(window.localStorage.getItem('Multivista_ClientSession')){window.localStorage.removeItem('Multivista_ClientSession')}Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientPhotoViewer.setFeatureEnabled',params:{featureEnabled:0},callback:function(){var e=mdslink.clientPhotoViewer+Ext.Object.toQueryString(a);if(this.getViewModel().get('standalone')){window.location.replace(e)}else {if(b=='X'){var f=c.get('photoStore'),d=[];f.each(function(a){d.push(a.get('Identifier'))});Ext.Ajax.postFormData(mdslink.clientPhotoViewer+Ext.Object.toQueryString(a),{PhotoIDs:d.join(','),UDEFPhotoUIDs:'',WebcamPhotoUIDs:''})}else {document.location=e}}},scope:this})},downloadCurrentImage:function(){var a=this.getViewModel();Ext.Ajax.postFormData('/index.cfm?fuseaction=aClientPhotoViewer.downloadCurrentImage',{id:a.get('activePhoto.id'),projectUID:a.get('ProjectUID'),webcamUID:a.get('activePhoto.WebcamUID')})},initWebcamPlayback:function(a){if(a.ForceFlashStream){this.loadFlowplayer()}else {Ext.Loader.loadScript({url:'mds/lib/nanocosmos/js/nanoplayer/nanoplayer.3.17.1.min.js',onLoad:function(){this.getViewModel().set('h5LivePlayerLoaded',!0)},scope:this})}},loadFlowplayer:function(a){if(!this.getViewModel().get('flowplayerLoaded')){Ext.Loader.loadScript({url:'mds/lib/flowplayer-6.0.5/skin/functional.css',scope:this});Ext.Loader.loadScript({url:'mds/lib/flowplayer-6.0.5/flowplayer.min.js',onLoad:function(){this.getViewModel().set('flowplayerLoaded',!0)},scope:this})}},initStream:function(c){var a=this.getViewModel(),b=this.lookupReference('photoContainer').lookupController().lookupReference('webcamLiveStream');b.load(c,{ProjectUID:a.get('ProjectUID'),WebcamUID:a.get('activeWebcam').getId()},this.getView().lookupReference('photoContainer'))},launchWebcamView:function(c){var a=this.getViewModel(),d=a.get('_webcamsLoaded');if(!d){a.bind('{_webcamsLoaded}',function(){this.launchWebcamView(c)},this,{single:!0});return}a.set('_selectedPTZPosition',null);a.set('_selectedArchivePosition',null);var b=a.get('webcams').getById(c);if(b.get('WebcamIsStreaming')){this.gotoWebcamStream(b)}else {if(b.get('MostRecentPhotoDate')){this.gotoWebcamArchive(b)}}},initTimelapsePlayback:function(d){var c=this.lookupReference('photoContainer').lookupController().lookupReference('webcamTimelapse');var b='$131119724416338';if(location.href.indexOf('localhost')!=-1){b='$863732616083910'}var a={preload:!0,scaling:'orig',sources:[{type:'video/mp4',src:d.get('TimelapseURL')}]};if(this.flowplayer){this.flowplayer.load(a,function(b,a){a.pause()});return}this.flowplayer=flowplayer('#'+c.id,{key:b,autoplay:!1,clip:a,embed:!1,adaptiveRatio:!0,controls:!1}).on('error',function(c,b,a){console.log('Error loading video');console.log(a)})},loadWebcamArchivePositions:function(a){var b=this.getViewModel();a=a||b.get('activeWebcam');if(!a||a.get('ArchivePositions')){return}var c=b.get('ProjectUID');var d=a.get('WebcamUID');mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientPhotoViewer.getArchivePositions&ProjectUID='+c+'&WebcamUID='+d,successCallback:function(b){a.set('ArchivePositions',b);if(b.length>0){if(b[0].TimelapseURL==''){a.set('TimelapseIsAvailable',0)}}}})},loadWebcamPhotoDates:function(){var d=this.getViewModel(),c=d.get('activeWebcam'),a=d.get('selectedWebcamPosition'),b=this.lookupReference('webcamPhotoDatePicker');if(!c||!c.get('ArchivePositions')||!c.get('MostRecentPhotoDate')){return}if(a){a=Ext.Array.findBy(c.get('ArchivePositions'),function(b){return b.ArchivePositionID===a.get('ArchivePositionID')})}else {a=c.get('ArchivePositions')[0]}if(a&&a.FirstPhotoDate){if(a.NoPhotoDates.length){b.setDisabledDates(a.NoPhotoDates)}b.setMinDate(new Date(a.FirstPhotoDate));b.setMaxDate(new Date(a.MostRecentPhotoDate));return}var e=d.get('ProjectUID');var f=c.get('WebcamUID');b.setLoading();mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientPhotoViewer.getWebcamPhotoDates&ProjectUID='+e+'&WebcamUID='+f,successCallback:function(c){if(Ext.Object.isEmpty(c)){return}if(a){Ext.Object.merge(a,c)}if(c.NoPhotoDates.length){b.setDisabledDates(c.NoPhotoDates)}b.setMinDate(new Date(c.FirstPhotoDate));b.setMaxDate(new Date(c.MostRecentPhotoDate));b.setLoading(!1)}})},onCustomWebcamArchiveClick:function(){if(!this.webcamCSWindow){this.webcamCSWindow=Ext.create('photoViewer.view.webcam.WebcamCustomSlideshow',{viewModel:{parent:this.getViewModel()}})}this.webcamCSWindow.show()},onGridViewButtonClick:function(){var b=this.getViewModel(),a={ProjectUID:b.get('ProjectUID')};window.location.href=mdslink.clientWebcamGridView+Ext.Object.toQueryString(a)},onSelectedWebcamPositionChange:function(b){var a=this.getViewModel();var c=a.bind('{selectedWebcamPosition}',function(d){c.destroy();if(a.get('activeTimelapse')){this.gotoWebcamTimelapse()}else {if(a.get('activePhoto')){this.gotoWebcamArchive()}}},this);a.set('selectedWebcamPosition',b)},getLivestreamWeather:function(){var a=this.getViewModel().get('activeStream');clearTimeout(this.weatherUpdateInterval);if(!a){this.getViewModel().set('streamWeather',null);return}Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.getWebcamWeather',params:{ProjectUID:a.ProjectUID,WebcamUID:a.WebcamUID},scope:this,successCallback:function(a){this.getViewModel().set('streamWeather',a);this.weatherUpdateInterval=setTimeout(this.getLivestreamWeather.bind(this),3*60*1000)}})},logDrawablesEvent:function(a,c){var b=this.getViewModel().get('photoStore').getById(a.substr(1))}},0,0,0,0,['controller.photoviewer'],0,[photoViewer.view.photoviewer,'PhotoViewerController'],0);Ext.cmd.derive('photoViewer.view.photoviewer.PhotoViewerModel',Ext.app.ViewModel,{data:{nThumbsPerPage:0,photoData:{id:0,photoId:0,nComments:0,panoHome:''},annoProps:{drawn:!1,storeLoaded:!1,toggledOn:!0,annotating:!1,saving:!1,hasAnnotations:!1,checkedForSave:!1},photoActions:{nThumbsSelected:0},photoState:{fullImageLoaded:!1,hasHotspot:!1,isPano:!1,isInteriorPano:!1,isTruView:!1,is360Pano:!1},topNavBarHeight:29,imgToolbarHeight:33,imgToolbarDisabled:!0,dateLocationToggleActiveItem:0,PushpinUID:null,ListTypeID:null,pinDescription:'Photo',thumbnailsLoading:!1,interiorPanoUrl:'',interiorPanoShowcaseConnected:!1,hasMatterportAndTruView:!1,selectedAnnotation:null,toolSettings:{mode:'select',strokeColour:undefined,strokeWidth:undefined,strokeStyle:'normal',fontSize:undefined,strokeStylePickerVisible:!1,selectedShapes:[]},src:'mds/image/transparent.png',unalteredWidth:0,unalteredHeight:0,scale:1,readOnly:!0,nPhotos:0,favouritesAlbumUID:null,_selectedPhotosStore:Ext.create('Ext.data.Store',{model:'mdsData.model.Photo',proxy:'memory'}),photoStore:Ext.create('Ext.data.Store'),lastSelectionChange:0,_selectedPhoto:null,commentViewData:null,FloorplanUID:null,layoutMode:'default',largeFloorplanReady:!1,smallFloorplanReady:!1,_photoGroup:null,lastPhotoGroup:null,standalone:!1,selectedPhotoCount:1,onlyOwnedPhotosSelected:!1,oneOwnedPhotoSelected:!1,photoStoreLoaded:!1,albumStore:null,slideshowOn:!1,measureStep:photoViewer.Values.MSR_ZERO_POINTS,cachedCmiPhotoID:0,unalteredImagePhotoID:0,_measurementsStore:Ext.create('Ext.data.Store',{proxy:'memory',model:'photoViewer.model.Annotation',filters:[{filterFn:function(a){return a.get('Type')=='measure'}}]}),_annotationStore:Ext.create('Ext.data.Store',{proxy:'memory',model:'photoViewer.model.Annotation',filters:[{filterFn:function(a){return a.get('Type')!='measure'}}]}),drawMode:photoViewer.Values.DRAW_OFF,drawingReady:!1,drawablesDataChange:0,activeMeasurement:null,measurementString:'',sidePanelCollapsed:!1,photoThumbsCollapsed:!1,selectedDrawing:null,_usingMetric:null,nextActive:!1,prevActive:!1,firstScrollDone:!1,bufferSize:30,lockMode:'',forceHideInteriorPano:!1,viewModeButtonValue:'',photoBeforeObjectTypeSwitch:null,activeStream:null,activeTimelapse:null,flowplayerLoaded:!1,h5LivePlayerLoaded:!1,pvFloorplan:null,_webcamsLoaded:!1,webcams:null,PTZPresets:Ext.create('Ext.data.Store',{proxy:'memory'}),PTZPosition:null,_selectedPTZPreset:null,_selectedArchivePosition:null,webcamStreamSnapshot:null},formulas:{viewButtonEnabled:function(a){if(a('photoState.isInteriorPano')){return !1}return !!(a('photoActions.nThumbsSelected')&&!a('annotating'))},saveButtonDisabled:function(a){if(a('photoState.isInteriorPano')){return !a('interiorPanoShowcaseConnected')}return a('annotating')},dateLocationToggleDisabled:function(a){var e=a('annotating'),b=a('activePhoto'),d=b?!!b.get('FloorplanUID'):!1,f=a('photoState.hasHotspot'),c=a('imgToolbarDisabled');return e||!d||!f||c},annotationBtnText:function(a){return a('annotating')?'Annotation Mode is ON':'Annotation Mode is OFF'},defaultShareTypeID:function(a){return a('account.canShare')?1:2},permsCls:function(b){var a='';if(b('account.canRead')){a+='perms-canread'}else {a+='perms-noread'}a+=' ';if(b('account.canWrite')){a+='perms-canwrite'}else {a+='perms-nowrite'}return a},printAndEmailDisabled:function(a){if(a('photoState.isInteriorPano')){return !a('interiorPanoShowcaseConnected')}if(a('photoState.isPano')){return !0}return !a('photoState.fullImageLoaded')||a('annotating')},floorplanViewerLink:function(a){return a('ListTypeID')?mdslink.clientFloorplanViewer_punchlistPlan:mdslink.clientFloorplanViewer},isPhotoHidden:function(a){return !!(!a('activePhoto')||a('photoState.isPano'))},isOverlayHidden:function(a){return a('annotating')||a('thumbnailsLoading')},commentsHidden:function(a){return !1},helpHidden:function(a){return a('photoState.isInteriorPano')},integrationsDisabled:function(a){return a('annotating')||a('photoState.isTruView')||a('photoState.isPano')},canToggleAnnotations:function(a){return !!(a('annoProps.hasAnnotations')&&a('account.canRead')&&!a('annotating')&&!Ext.isIE8)},triggerOnShapeSelect:function(b){var a=b('toolSettings.selectedShapes');if(a.length){this.getView().lookupController().lookupReference('photoContainer').getController().onShapeSelect(a)}},backgroundStyle:{bind:{backroundCSS:'url({src})'},get:function(b){var a=this.getView().getController().getPhotoComponent();if(a&&a.el&&a.el.dom){a.el.dom.style.backgroundImage=b.backroundCSS}return b.backroundCSS}},naturalWidth:function(a){return (a('drawMode')==photoViewer.Values.DRAW_MEASURING?a('unalteredWidth'):a('activePhoto.OriginalsWidth'))||0},naturalHeight:function(a){return (a('drawMode')==photoViewer.Values.DRAW_MEASURING?a('unalteredHeight'):a('activePhoto.OriginalsHeight'))||0},onModeChange:function(d){var b=d('toolSettings.mode'),c=d('drawing'),a=this.getView().getController().getPhotoComponent();if(c&&b=='select'){a.el.addCls('mode-select')}else {a.el.removeCls('mode-select')}if(c&&b=='pen'){a.el.addCls('mode-pen')}else {a.el.removeCls('mode-pen')}if(c&&(b!='select'&&b!='pen')){a.el.addCls('mode-draw')}else {a.el.removeCls('mode-draw')}this.getView().getController().getPhotoComponent().lookupController().onModeChange(b)},defaultShareTypeID:function(a){return a('account.canShare')?1:2},annotationsStrokeColourNoHash:{get:function(b){var a=b('toolSettings.strokeColour');if(!a){return a}return a.charAt(0)=='#'?a.substr(1):a},set:function(a){if(!a||a.charAt(0)=='#'){this.set('toolSettings.strokeColour',a)}else {this.set('toolSettings.strokeColour','#'+a)}}},activePhoto:{get:function(a){return a('_selectedPhoto')},set:function(b){var a=this.get('photoStore');if(a){a.each(function(a){a.set('Active',a==b)})}this.set('_selectedPhoto',b)}},floorplanModeOn:function(a){return a('layoutMode')=='floorplan'},floorplanWidgetCard:function(a){return this.getView().lookupController().lookupReference('floorplanWidget').items.getAt(a('floorplanModeOn')?1:0)},largeFloorplanVisible:function(a){return a('activePhoto.FloorplanUID')?'visible':'hidden'},photoGroup:{get:function(a){return a('_photoGroup')},set:function(a){this.set('lastPhotoGroup',this.get('_photoGroup'));if(a.get('Type')=='B'){a.set('Type','A')}this.set('_photoGroup',a)}},canReadAnnotations:function(a){return a('account.canRead')&&!Ext.isIE8},drawablesStore:function(e){var c=e('activePhoto'),a=this.get('_drawablesStore');if(!c){return null}if(a){a.destroyShapes();a.clearListeners();if(a.isSyncing){a.addListener('datachanged',function(){a.destroy()},this,{buffer:10000})}else {a.destroy()}}var d=this.getView().lookupController(),b=Ext.create('photoViewer.store.Annotations',{proxy:{extraParams:{ProjectUID:this.get('ProjectUID'),photo:c.get('id')}},listeners:{load:{fn:'onAnnotationsStoreLoad',scope:d},datachanged:{fn:'onAnnotationsDataChanged',scope:d},logevent:{fn:'logDrawablesEvent',scope:d}},usingMetric:this.get('usingMetric')});this.set('_drawablesStore',b);if(!c.get('HasDrawables')||!e('canReadAnnotations')){this.set('drawingReady',!0)}else {this.set('drawingReady',!1);console.log('loading '+b.getId());b.load()}return b},writeDrawablesStore:function(a){var b=a('drawMode');if(b==photoViewer.Values.DRAW_MEASURING){return a('measurementsStore')}return a('drawablesStore')},measurementsStore:function(a){var c=a('drawablesStore'),e=a('drawablesDataChange'),b=a('_measurementsStore'),d=a('annoProps.storeLoaded');if(c&&d){b.setData(c.getRange())}else {b.removeAll()}return b},annotationStore:function(a){var c=a('drawablesStore'),e=a('drawablesDataChange'),b=a('_annotationStore'),d=a('annoProps.storeLoaded');if(c&&d){b.setData(c.getRange())}else {b.removeAll()}return b},activeDrawablesStore:function(a){switch(a('drawMode')){case photoViewer.Values.DRAW_ANNOTATING:return a('annotationStore');case photoViewer.Values.DRAW_MEASURING:return a('measurementsStore');}return a('drawablesStore')},selectedPhotos:function(e){var d=e('photoStore'),a=this.get('_selectedPhotosStore'),b=[],h=e('activePhoto'),i=e('lastSelectionChange'),f=d.getCount()?!0:!1,g=!1;if(d&&i){d.each(function(a){if(a.get('Selected')){b.push(a)}})}if(!b.length&&h){b.push(h)}a.removeAll();a.add(b);a.each(function(a){if(a.get('IsOwnedByUser')){g=!0}else {f=!1}});var c=a.getCount();this.set('selectedPhotoCount',c);this.set('oneOwnedPhotoSelected',c?g:!1);this.set('onlyOwnedPhotosSelected',c?f:!1);return a},pageHasSettings:function(b){var a=b('openAlbum');return a&&!a.get('IsSystemAlbum')&&a.get('IsUserAlbum')},followersMenuVisible:function(a){return !1;var b=a('openAlbum');return b&&!b.get('IsSystemAlbum')&&a('project.pushpinAlbumFollowEnabled')&&a('openAlbum.ShareTypeID')!=2},openAlbum:function(b){if(!b('activePhoto')){return null}var c=b('albumStore'),a=b('photoGroup');if(!c||!a||a.get('Type')!='A'){return null}return c.getById(a.get('Identifier'))},shootLockAvailable:function(a){var b=a('activePhoto');if(!b){return !1}return b.get('HotspotID')&&a('pvFloorplan')&&!a('activeWebcam')},floorplanVisible:function(a){return !!(a('activePhoto.FloorplanUID')||a('activePhoto.HotspotID')||a('activePhoto.PushpinUID'))},largeFloorplanVisible:function(a){return a('floorplanVisible')&&a('floorplanModeOn')},hasSpecialViewer:function(a){return !!(a('photoState.isPano')||a('photoState.is360Pano'))},overlayVisible:function(a){return !a('hasSpecialViewer')},annotationsAvailable:function(a){return !a('hasSpecialViewer')},integrationsMenuVisible:function(a){return a('activePhoto')&&a('account.features.integrationsVisible')&&(a('account.procoreEnabled')||a('account.planGridEnabled')||a('account.aconexEnabled')||a('account.bluebeamEnabled'))},writeableListsAndReports:function(a){if(!0){return []}if(!a('_listsAndReportsLoaded')){return []}return a('listsAndReports').getRange()},addCommentActionVisible:function(a){return !1},drawing:function(a){return a('drawMode')!=photoViewer.Values.DRAW_OFF},annotating:{get:function(a){return a('drawMode')==photoViewer.Values.DRAW_ANNOTATING},set:function(a){this.set('drawMode',a?photoViewer.Values.DRAW_ANNOTATING:photoViewer.Values.DRAW_OFF)}},measuring:{get:function(a){return a('drawMode')==photoViewer.Values.DRAW_MEASURING},set:function(a){this.set('drawMode',a?photoViewer.Values.DRAW_MEASURING:photoViewer.Values.DRAW_OFF)}},fullscreen:{get:function(a){return a('sidePanelCollapsed')&&a('photoThumbsCollapsed')},set:function(a){this.set('sidePanelCollapsed',a);this.set('photoThumbsCollapsed',a)}},usingMetric:function(a){return a('account.MeasurePreferenceID')==mdsData.PreferenceValues.MEASURE_PREFERENCE_METRIC},gettingCmiLength:function(a){return a('measureStep')==photoViewer.Values.MSR_CALCULATING},photoIsWebcamPhoto:function(a){return a('activePhoto.Type')=='W'},viewMode:{get:function(a){return a('photoState.isTruView')?photoViewer.Values.VIEW_TRUVIEW:photoViewer.Values.VIEW_SITEWALK360},set:function(a){this.set('photoState.isTruView',a==photoViewer.Values.VIEW_TRUVIEW)}},measureInfoLink:function(a){return a('usingMetric')?'https://info.multivista.com/measurable-3d-image-met':'https://info.multivista.com/measurable-3d-images'},truViewComponentVisible:function(a){return a('photoState.isTruView')&&!a('forceHideInteriorPano')},interiorPanoFrameVisible:function(a){return a('photoState.isInteriorPano')&&!a('photoState.isTruView')&&!a('forceHideInteriorPano')},activeOrParentPhoto:function(b){var a=b('photoGroup');return b('activePhoto')||(a?a.get('ParentPhoto'):null)},activeWebcam:{get:function(a){if(a('_webcamsLoaded')){var e=a('activeOrParentPhoto'),c=a('activeStream'),g=a('activeTimelapse'),f=a('webcams'),d,b;if(e&&e.get('WebcamUID')){b=e.get('WebcamUID')}if(c&&c.WebcamUID){b=c.WebcamUID}if(g){b=g.get('WebcamUID')}d=f.getById(b);if(f){f.each(function(b){b.set('Active',b==d)})}return d}return null},set:function(b){var a=this.get('webcams');if(a){a.each(function(a){a.set('Active',a==b)})}}},canSwitchToStream:function(a){return a('activeWebcam')&&a('activeWebcam.WebcamIsStreaming')},canSwitchToArchive:function(a){return a('activeWebcam')&&a('activeWebcam.MostRecentPhotoDate')},canSwitchToTimelapse:function(a){return a('activeWebcam')&&a('activeWebcam.TimelapseIsAvailable')},activeStreamSelected:function(a){return !!a('activeStream')},activeTimelapseSelected:function(a){return !!a('activeTimelapse')},activeArchiveSelected:function(a){return !!(a('activePhoto')&&a('activeWebcam'))},webcamPlaybackReady:function(a){var b=a('activeStream');if(b){if(b.ForceFlashStream){return a('flowplayerLoaded')}else {return a('h5LivePlayerLoaded')}}return !1},viewerDisabled:function(a){return !a('activePhoto')&&!a('activeStream')&&!a('activeTimelapse')},showStreamZoomControls:function(a){return a('overlayVisible')&&(!a('activeStream.WebcamPTZEnabled')||a('PTZPosition'))},showStreamPanTiltControls:function(a){return a('overlayVisible')&&a('activeStream.WebcamPTZEnabled')&&a('PTZPosition')},_activeWebcamRecord:function(a){if(a('activeWebcam')){return a('activeWebcam')}return Ext.create('photoViewer.model.Webcam',{PTZPresets:null,ArchivePositions:null})},webcamPositions:function(a){var d=a('activeWebcam'),c=a('activeStream'),b=Ext.create('Ext.data.Store',{proxy:'memory'});if(!d){return b}if(c&&a('_activeWebcamRecord.PTZPresets')){return Ext.create('Ext.data.Store',{proxy:'memory',data:a('_activeWebcamRecord.PTZPresets')})}if(a('_activeWebcamRecord.ArchivePositions')){b=Ext.create('Ext.data.Store',{proxy:'memory',data:a('_activeWebcamRecord.ArchivePositions')})}if(a('activeTimelapse')){b.filterBy(function(b){return !!b.get('TimelapseURL')})}return b},selectedWebcamPosition:{get:function(a){var c=a('activeWebcam'),b=a('activeStream');if(!c){return null}if(b){if(a('_selectedPTZPreset')){return a('_selectedPTZPreset')}}else {if(a('_selectedArchivePosition')){return a('_selectedArchivePosition')}else {return a('webcamPositions').getAt(0)}}},set:function(a){if(Ext.isObject(a)){var b=this.get('activeStream');if(b){this.set('_selectedPTZPreset',a);if(a&&a.get('ArchivePositionID')){this.set('_selectedArchivePosition',a)}}else {this.set('_selectedArchivePosition',a)}}}},showWebcamPositionSelector:function(a){var c=a('activeWebcam'),d=a('activePhoto'),b=a('activeTimelapse');if(!c){return !1}return a('webcamPositions').getCount()>1&&(d||b)},nextPrevButtonsVisible:function(a){if(a('activeTimelapse')||a('activeStream')&&(a('fullscreen')||a('webcams').count()==1)){return !1}return !0},showPhotoPositionControls:function(b){var c=b('activePhoto'),a=b('activeStream');if(c){return !0}if(a&&!a.WebcamPTZEnabled){return !0}return !1},photoCanBeSaved:function(a){return !!(a('selectedPhotoCount')||a('activeStream'))},ptzPresetCanBeDeleted:function(a){return a('account.canEditPTZ')&&!a('selectedWebcamPosition.ArchivePositionID')},ptzControlsHidden:function(a){return !(a('account.canUsePTZ')&&a('activeStream')&&a('activeStream.WebcamPTZEnabled'))}}},0,0,0,0,['viewmodel.photoviewer'],0,[photoViewer.view.photoviewer,'PhotoViewerModel'],0);Ext.cmd.derive('photoViewer.view.photoviewer.PhotoViewerToolTip',Ext.tip.QuickTip,{anchorToTarget:!0,cls:'x-tip-dark',anchorSize:[0,12],shadow:!1},0,['photoviewertooltip'],['component','box','container','panel','tip','tooltip','quicktip','photoviewertooltip'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tip':!0,'tooltip':!0,'quicktip':!0,'photoviewertooltip':!0},['widget.photoviewertooltip'],0,[photoViewer.view.photoviewer,'PhotoViewerToolTip'],0);Ext.cmd.derive('photoViewer.view.photoviewer.PhotoViewerWelcome',Ext.window.Window,{modal:!0,ui:'orange',cls:'photo-actions-window',title:'Welcome to our new Photoviewer!',padding:'40 45 30 45',reference:'photoViewerWelcome',items:[{xtype:'component',html:'<h1>Welcome to the NEW Multivista Photoviewer!</h1><p>Multivista\u2019s lighting fast new photoviewer has been redesigned to provide a larger viewing area, split-screen capabilities for easier floor plan navigation, a simplified user interface for more efficient workflows, and the ability to capture in-image measurements on Multivista 3D Images.</p><p>Click "Check it Out" to have a look around!</p><br/><p class=\'note\'>*If you prefer to use the last-generation photoviewer, which will be available only through September 20th, click <a>here.</a></p>'}],modalMaskCls:'modal-transparent',dockedItems:[{xtype:'container',dock:'bottom',width:'100%',padding:'40 0 0 0',layout:{type:'hbox',pack:'middle'},defaults:{xtype:'button',scale:'medium',margin:'0 12 0 12'},items:[{ui:'grey-smallerfont',text:'Review Later',listeners:{click:function(){this.up('photoviewerwelcome').destroy()}}},{ui:'green-smallerfont',text:'Check it Out',listeners:{click:'showTour'}}]}],listeners:{render:function(a){a.el.select('a').elements[0].onclick=Ext.bind(function(){this.lookupController().switchPhotoViewer()},this)}}},0,['photoviewerwelcome'],['component','box','container','panel','window','photoviewerwelcome'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'photoviewerwelcome':!0},['widget.photoviewerwelcome'],0,[photoViewer.view.photoviewer,'PhotoViewerWelcome'],0);Ext.cmd.derive('photoViewer.view.positioncontrols.CreatePresetWindow',Ext.window.Window,{modal:!0,modalMaskCls:'dark-mask',ui:'orange',width:370,height:216,alwaysOnTop:1,localized:{title:'WV_Create Preset'},padding:'25 25 25 25',layout:{type:'vbox',align:'middle'},items:[{xtype:'detailformtextfield',localized:{fieldLabel:'WV_Preset Name'},reference:'newPresetName',width:312,validator:function(a){var d=this.lookupViewModel(),b=d.get('webcamPositions'),c=b.findExact('Name',a)>-1;if(a.length>31){return mvstr['WV_Preset name length mu']}if(a.match(/(["<>~:#&=,])+/g)){return mvstr['WV_Preset name cannot co']+': " , < > ~ : # & ='}if(c){return mvstr['WV_Preset with this name exists']}return !0}}],modalMaskCls:'modal-transparent',dockedItems:[{xtype:'container',dock:'bottom',width:'100%',padding:'10 0 0 0',layout:{type:'hbox',pack:'middle'},defaults:{xtype:'button',scale:'medium',margin:'0 12 0 12',padding:'0 5',height:30},items:[{ui:'grey',localized:{text:'G_Cancel'},listeners:{click:function(a){a.up('window').destroy()}}},{ui:'orange',localized:{text:'G_Done'},listeners:{click:function(a){var b=a.up('window'),d=b.down('textfield'),e=d.getValue(),f=b.getViewModel(),c=f.get('activeStream');if(!d.isValid()){return}if(e){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.savePreset',params:{WebcamUID:c.WebcamUID,ProjectUID:c.ProjectUID,name:e},successCallback:function(b){app.fireEvent('reloadwebcampositions');a.up('window').destroy()}})}else {a.up('window').destroy()}}}}]}]},0,['createpresetwindow'],['component','box','container','panel','window','createpresetwindow'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'createpresetwindow':!0},['widget.createpresetwindow'],0,[photoViewer.view.positioncontrols,'CreatePresetWindow'],0);Ext.cmd.derive('photoViewer.view.positioncontrols.PhotoPositionControls',Ext.Container,{layout:'vbox',width:36,defaults:{width:36,height:36,style:{zIndex:2},hidden:!0,margin:'0 0 6 0'},items:[{xtype:'button',text:'+',cls:'zoom-in-button',bind:{hidden:'{!overlayVisible}'},listeners:{click:'zoomIn'},tooltip:{localized:{text:'ZC_Zoom in'},anchor:'top'}},{xtype:'button',itemId:'photoViewerZoomOutButton',text:'-',cls:'zoom-out-button',bind:{hidden:'{!overlayVisible}'},listeners:{click:'zoomOut'},tooltip:{localized:{text:'ZC_Zoom out'},anchor:'top'}},{xtype:'button',icon:'mds/image/icon/reset.png',cls:'reset-button',bind:{hidden:'{!overlayVisible}'},listeners:{click:function(){this.lookupController().resetPhotoDisplay(!1)}},tooltip:{localized:{text:'PV_Reset Display'},anchor:'top'}}]},0,['photopositioncontrols'],['component','box','container','photopositioncontrols'],{'component':!0,'box':!0,'container':!0,'photopositioncontrols':!0},['widget.photopositioncontrols'],0,[photoViewer.view.positioncontrols,'PhotoPositionControls'],0);Ext.cmd.derive('photoViewer.view.positioncontrols.StreamPositionControls',Ext.Container,{controller:'streampositioncontrols',layout:{type:'vbox',align:'middle'},width:152,defaults:{style:{zIndex:2},hidden:!0},items:[{xtype:'streampositionslider',reference:'zoomSlider',cls:'webcam-control-slider',vertical:!0,padding:2,height:149,listeners:{changecomplete:'zoomValueChanged'},bind:{hidden:'{!showStreamZoomControls}'}},{xtype:'container',width:152,height:140,margin:'6 0 0 0',layout:{type:'vbox',align:'middle'},bind:{hidden:'{!showStreamPanTiltControls}'},reference:'panCircle',items:[{xtype:'draw',activeCounter:1,plugins:['spriteevents'],width:136,height:136,cls:'pan-circle',anchor:'0 0',sprites:[{type:'rect',x:0,y:0,height:136,width:136,fillOpacity:1.0E-5,fillStyle:'#777777'},{type:'circle',cx:68,cy:68,r:60,fillStyle:'#000000',strokeStyle:'#4e4e4e',lineWidth:1,fillOpacity:0.6},{type:'arc',reference:'panTrack',cx:68,cy:68,r:60,strokeStyle:'#a8a8a8',lineWidth:2,rotation:-90},{type:'line',reference:'minPanLine',fromX:68,fromY:2,toX:68,toY:14,lineWidth:2,rotationCenterX:68,rotationCenterY:68},{type:'line',reference:'maxPanLine',fromX:68,fromY:2,toX:68,toY:14,lineWidth:2,rotationCenterX:68,rotationCenterY:68},{type:'arc',reference:'panMarkerOutline',cx:68,cy:9,r:8,rotationCenterX:68,rotationCenterY:68,strokeOpacity:1,strokeStyle:'#F0F0F0',lineWidth:2},{type:'circle',reference:'panMarker',cx:68,cy:9,r:6,rotationCenterX:68,rotationCenterY:68,rotation:0,fillStyle:'#F0F0F0',strokeStyle:'#4e4e4e',lineWidth:2}],listeners:{spritemousedown:'panSpriteMouseDown',spritemousemove:'panSpriteMouseMove',spritemouseout:{buffer:250,fn:'panSpriteMouseOut'},spritemouseup:'panSpriteMouseUp',spriteclick:'panSpriteClick'}},{xtype:'streampositionslider',reference:'tiltSlider',buttonType:'arrow',vertical:!0,height:90,listeners:{changecomplete:'tiltValueChanged'},margin:'-113 0 0 0',style:{position:'absolute',zIndex:3}},{xtype:'container',layout:'hbox',width:'100%',margin:'-8 0 0 0',style:{position:'absolute'},items:[{xtype:'button',cls:'ptz-reset-button',handler:'resetPTZPosition',style:{zIndex:3}},{xtype:'container',flex:1},{xtype:'button',cls:'ptz-add-button',text:'+',handler:'createPTZPresetPressed',bind:{disabled:'{!account.canEditPTZ}'},style:{zIndex:3}}]}]},{xtype:'container',layout:'hbox',width:152,cls:'ptz-container',padding:'2 1',height:32,margin:'0 0 6 0',bind:{hidden:'{!showStreamPanTiltControls}'},defaults:{xtype:'numberfield',cls:'ptz-input-field',labelSeparator:'',labelWidth:7,width:40,margin:'3 0',hideTrigger:!0},items:[{fieldLabel:'P',reference:'panNumberField',listeners:{change:{fn:function(a,b){analytics.Ctrl.setOptionalDefaultEventProperties({'Method':'Slider','Sub Method':'Text Input'});this.lookupController().panValueChanged(a,b)},buffer:1000}}},{xtype:'label',cls:'ptz-input-field degree',width:6,margin:'3 0 3 1',text:''},{fieldLabel:'T',reference:'tiltNumberField',listeners:{change:{fn:function(a,b){analytics.Ctrl.setOptionalDefaultEventProperties({'Method':'Slider','Sub Method':'Text Input'});this.lookupController().tiltValueChanged(a,b)},buffer:1000}}},{xtype:'label',cls:'ptz-input-field percent',width:6,margin:'3 3 3 1',text:'%'},{fieldLabel:'Z',reference:'zoomNumberField',listeners:{change:{fn:function(a,b){analytics.Ctrl.setOptionalDefaultEventProperties({'Method':'Slider','Sub Method':'Text Input'});this.lookupController().zoomValueChanged(a,b)},buffer:1000}}},{xtype:'label',cls:'ptz-input-field percent',width:6,margin:'3 1 3 1',text:'%'}]},{xtype:'container',layout:{type:'hbox',align:'middle',pack:'center'},width:152,height:32,cls:'ptz-container',bind:{hidden:'{!showStreamPanTiltControls}'},items:[{xtype:'combobox',displayField:'Name',flex:1,height:'100%',editable:!1,cls:'ptz-presets',listConfig:{cls:'photo-viewer-ptz-presets',shadow:!1},bind:{store:'{webcamPositions}',value:'{selectedWebcamPosition}'},listeners:{select:'presetSelected'}},{xtype:'button',ui:'more-options',scale:'small',width:20,menuAlign:'r',bind:{disabled:'{!_selectedPTZPreset}'},menu:{cls:'photo-viewer-ptz-menu',minWidth:60,showSeparator:!1,shadow:!1,items:[{localized:{text:'PTZ_Create'},scale:'small',handler:'createPTZPresetPressed',bind:{disabled:'{!account.canEditPTZ}'}},{localized:{text:'PTZ_Delete'},scale:'small',disabled:!0,bind:{disabled:'{!ptzPresetCanBeDeleted}'},handler:'deletePTZPresetPressed'}]}}]}],listeners:{show:'handleResize'}},0,['streampositioncontrols'],['component','box','container','streampositioncontrols'],{'component':!0,'box':!0,'container':!0,'streampositioncontrols':!0},['widget.streampositioncontrols'],0,[photoViewer.view.positioncontrols,'StreamPositionControls'],0);Ext.cmd.derive('photoViewer.view.positioncontrols.StreamPositionControlsController',Ext.app.ViewController,{updatePositionTimeout:null,PTZPositionRequest:null,PTZLimitsRequest:null,PTZPresetRequest:null,PanMovementActive:!1,PanMovementTimestamp:null,PanMovementStartAngle:null,init:function(){var a=this.getViewModel();a.bind({activeStream:'{activeStream}'},this.onStreamChange,this);a.bind('{activeWebcam}',this.onWebcamChange,this);a.bind({PTZPosition:'{PTZPosition}'},function(e){var a=e.PTZPosition,b=this.getView().up('photocontainer').lookupReference('webcamLiveStream');if(!a){b.setPTZMaskVisibility(!1);return}b.setPTZMaskVisibility(!0);if(a.pan){this.setPanMarkerPosition(a.pan);this.lookupReference('panNumberField').setRawValue(Math.round(a.pan))}if(a.tilt){this.lookupReference('tiltSlider').setValue(a.tilt);var c=this.convertTiltValue(a.tilt,!0);this.lookupReference('tiltNumberField').setRawValue(c)}if(a.zoom){this.lookupReference('zoomSlider').setValue(a.zoom);var d=this.convertZoomValue(a.zoom,!0);this.lookupReference('zoomNumberField').setRawValue(d)}},this);app.addListener('reloadwebcampositions',this.getPTZPresets,this);app.addListener('forceupdateptzposition',function(){this.updatePosition(!0)},this);this.getView().up('photocontainer').lookupReference('webcamLiveStream').on('resize',this.handleResize,this)},getWebcam:function(){return this.getViewModel().get('activeWebcam')},onWebcamChange:function(b){if(!b){return}var a=this.getViewModel();a.set('PTZPosition',null);var f=b.get('PTZPresets'),d=a.get('_selectedPTZPreset');if(!(f&&d&&Ext.Array.contains(f,d.data))){a.set('_selectedPTZPreset',null)}var c=b.get('ArchivePositions'),e=a.get('_selectedArchivePosition');if(!(c&&e&&Ext.Array.findBy(c,function(a){return a.ArchivePositionID==e.get('ArchivePositionID')}))){a.set('_selectedArchivePosition',null)}},onStreamChange:function(a){clearTimeout(this.updatePositionTimeout);if(this.PTZPositionRequest){Ext.Ajax.abort(this.PTZPositionRequest)}if(this.PTZLimitsRequest){Ext.Ajax.abort(this.PTZLimitsRequest)}if(this.PTZPresetRequest){Ext.Ajax.abort(this.PTZPresetRequest)}if(!a.activeStream||!a.activeStream.WebcamPTZEnabled){return}if(this.getWebcam().PTZLimits){if(!this.getWebcam().PTZPresets){this.getPTZPresets()}this.updatePosition();this.updatePanSliderLimits()}else {this.getPTZLimits()}},getPTZLimits:function(){var c=this.getViewModel(),b=c.get('activeStream'),a=this;this.PTZLimitsRequest=Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.getPTZSettings',params:{WebcamUID:b.WebcamUID,ProjectUID:b.ProjectUID},successCallback:function(b){if(!b.PTZPosition||Ext.Object.isEmpty(b.PTZPosition)){Ext.Msg.alert('',mvstr['WV_Camera position contr']);return}for(var d in b.PTZPosition){if(b.PTZPosition.hasOwnProperty(d)&&!isNaN(b.PTZPosition[d])){b.PTZPosition[d]=b.PTZPosition[d]-0}}for(var d in b.PTZLimits){if(b.PTZLimits.hasOwnProperty(d)&&!isNaN(b.PTZLimits[d])){b.PTZLimits[d]=b.PTZLimits[d]-0}}c.set('PTZPosition',b.PTZPosition);a.getWebcam().PTZLimits=b.PTZLimits;a.updatePanSliderLimits(b.PTZLimits);setTimeout(Ext.bind(a.updatePosition,a),10*1000);a.getPTZPresets()},noResponseCallback:function(){if(a.PTZLimitsRequest&&a.PTZLimitsRequest.aborted){return}Ext.Msg.alert('',mvstr['WV_Camera position contr'])}})},updatePosition:function(d){if(this.PTZPositionRequest){Ext.Ajax.abort(this.PTZPositionRequest)}if(this.updatePositionTimeout){clearTimeout(this.updatePositionTimeout)}var b=this.getViewModel(),c=b.get('activeStream'),a=this;if(!c||!c.WebcamPTZEnabled){return}this.PTZPositionRequest=Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.getPTZPosition',params:{WebcamUID:c.WebcamUID,ProjectUID:c.ProjectUID},successCallback:function(c){if(Ext.Object.isEmpty(c)){if(b.get('PTZPosition')){Ext.Msg.alert('',mvstr['WV_Camera position contr']);b.set('PTZPosition',null)}return}for(var f in c){if(c.hasOwnProperty(f)&&!isNaN(c[f])){c[f]=c[f]-0}}if(d){var e={};if(c.hasOwnProperty('pan')){e.Pan=c.pan}if(c.hasOwnProperty('tilt')){e.Tilt=c.tilt}if(c.hasOwnProperty('zoom')){e.Zoom=c.zoom}analytics.Ctrl.log('PTZ Control',e,['Webcam UID','Method','Sub Method'])}b.set('PTZPosition',c);a.matchCurrentPositionToPreset();a.updatePositionTimeout=setTimeout(Ext.bind(a.updatePosition,a),30*1000)},noResponseCallback:function(){if(!a.PTZPositionRequest.aborted){b.set('PTZPosition',null)}}})},getPTZPresets:function(){var b=this.getViewModel(),a=b.get('activeStream');this.PTZPresetRequest=Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.getPTZPresets',params:{WebcamUID:a.WebcamUID,ProjectUID:a.ProjectUID,force:!0},scope:this,successCallback:function(a){b.set('activeWebcam.PTZPresets',a);this.matchCurrentPositionToPreset()}})},matchCurrentPositionToPreset:function(){var a=this.getViewModel(),c=a.get('webcamPositions'),b=a.get('PTZPosition');if(!b){return}c.each(function(i){var d=!0;var c=['pan','tilt','zoom'];for(var e in c){var f=b[c[e]]<0?-1:1,g=f*b[c[e]],h=f*i.get(c[e]);d=d&&(h+-1<=g&&g<=h+1);if(d){a.set('selectedWebcamPosition',i);return}}});if(!a.get('selectedWebcamPosition')){var d=c.findRecord('isHome',!0);if(!d){return}a.set('selectedWebcamPosition',d)}},presetSelected:function(c,a){var b=a.get('id');if(!b){return}this.moveToPreset(b);this.getViewModel().set('selectedWebcamPosition',a);analytics.Ctrl.log('Selected Camera Position',{'Webcam View':'Live Stream','Position Name':a.get('Name')},['Webcam UID'])},ptzValueChange:function(e,a){if(!Ext.isNumber(a)){return}var b=this.getViewModel(),c=b.get('activeStream'),d=JSON.parse(JSON.stringify(b.get('PTZPosition')));if(this.PTZPositionRequest){Ext.Ajax.abort(this.PTZPositionRequest)}if(this.updatePositionTimeout){clearTimeout(this.updatePositionTimeout)}d[e]=a;b.set('PTZPosition',d);Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.move&'+e+'='+a,params:{WebcamUID:c.WebcamUID,ProjectUID:c.ProjectUID},successCallback:Ext.callback(this.updatePosition,this,[!0],3000)})},moveToPreset:function(b){var c=this.getViewModel(),a=c.get('activeStream');if(a.WebcamPTZEnabled){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.setPreset',params:{WebcamUID:a.WebcamUID,ProjectUID:a.ProjectUID,id:b},successCallback:Ext.bind(this.updatePosition,this)})}},panSpriteMouseDown:function(b,c){var a=b.sprite;if(a.reference=='panMarker'){this.PanMovementActive=!0;this.PanMovementStartAngle=this.getPanMarkerPosition()}},panSpriteMouseMove:function(e,b){if(this.PanMovementActive){this.PanMovementTimestamp=b.getTime();var d=this.getWebcam().PTZLimits;var a=this.getPanMouseEventAngle(b);if(a>=d.MinPan&&a<=d.MaxPan){this.setPanMarkerPosition(a,!1)}}var c=this.lookupReference('panCircle');if(this.checkSpriteClickOnPanTrack(b)){c.setStyle({'cursor':'pointer'})}else {c.setStyle({'cursor':'default'})}},panSpriteMouseUp:function(b,a){if(this.PanMovementActive){this.PanMovementActive=!1;this.ptzValueChange('pan',this.getPanMarkerPosition())}},panSpriteMouseOut:function(c,b){var a=this.PanMovementActive&&Ext.Date.now()-this.PanMovementTimestamp>250;if(a){this.PanMovementActive=!1;this.PanMovementTimestamp=null;if(this.PanMovementStartAngle){this.setPanMarkerPosition(this.PanMovementStartAngle)}}},panSpriteClick:function(c,b){if(this.checkSpriteClickOnPanTrack(b)){var a=this.getPanMouseEventAngle(b);this.setPanMarkerPosition(a,!0);this.ptzValueChange('pan',a)}},checkSpriteClickOnPanTrack:function(b){var a=this.lookupReference('panCircle'),f=b.pageX-a.getX()-a.getWidth()/2,g=-1*(b.pageY-a.getY()-a.getHeight()/2);sprites=a.down('draw').getSprites(),track=Ext.Array.findBy(sprites,function(a){return a.reference=='panTrack'}),clickDistanceFromCenter=Math.sqrt(Math.pow(f,2)+Math.pow(g,2));var e=track.r-10<clickDistanceFromCenter&&track.r+10>clickDistanceFromCenter;var c=this.getWebcam().PTZLimits;var d=this.getPanMouseEventAngle(b);return d>=c.MinPan&&d<=c.MaxPan&&e},getPanMouseEventAngle:function(c){var a=this.lookupReference('panCircle'),d=c.pageX-a.getX()-a.getWidth()/2,e=-1*(c.pageY-a.getY()-a.getHeight()/2);var b=-1*(Math.atan2(e,d)*(180/Math.PI)-90);if(b>180){b-=360}return b},getPanMarkerPosition:function(){var b=this.lookupReference('panCircle'),a=b.down('draw'),c=a.getSprites(),d=Ext.Array.findBy(c,function(a){return a.reference=='panMarker'});return d.attr.rotationRads*180/Math.PI},setPanMarkerPosition:function(d,g){var f=this.lookupReference('panCircle'),c=f.down('draw'),e=c.getSprites(),h=c.getSurface(),b=Ext.Array.findBy(e,function(a){return a.reference=='panMarker'}),a=Ext.Array.findBy(e,function(a){return a.reference=='panMarkerOutline'});if(g){a.setAnimation({duration:500,easing:'easeInOut'});b.setAnimation({duration:500,easing:'easeInOut'})}else {a.setAnimation({duration:0});b.setAnimation({duration:0})}a.setAttributes({rotation:d});b.setAttributes({rotation:d});h.renderFrame()},updatePanSliderLimits:function(a){var a=a||this.getWebcam().PTZLimits,h={MinValue:a.MinTilt,MaxValue:a.MaxTilt},i={MinValue:a.MinZoom,MaxValue:a.MaxZoom},k={MinValue:a.MinPan,MaxValue:a.MaxPan};this.lookupReference('tiltSlider').setConfig(h);this.lookupReference('tiltNumberField').setConfig({MinValue:0,MaxValue:100});this.lookupReference('zoomSlider').setConfig(i);this.lookupReference('zoomNumberField').setConfig({MinValue:0,MaxValue:100});this.lookupReference('panNumberField').setConfig(k);var j=this.lookupReference('panCircle'),c=j.down('draw'),b=c.getSprites(),l=c.getSurface(),m=Ext.Array.findBy(b,function(b){return b.reference=='panTrack'}),e=Ext.Array.findBy(b,function(b){return b.reference=='minPanLine'}),d=Ext.Array.findBy(b,function(b){return b.reference=='maxPanLine'});var g=a.MinPan*Math.PI/180;var f=a.MaxPan*Math.PI/180;if(a.MaxPan!=180||a.MinPan!=-180){e.setAttributes({rotation:a.MinPan,strokeStyle:'#a8a8a8'});d.setAttributes({rotation:a.MaxPan,strokeStyle:'#a8a8a8'})}else {e.setAttributes({strokeStyle:'none'});d.setAttributes({strokeStyle:'none'})}m.setAttributes({startAngle:g,endAngle:f},!0);l.renderFrame()},panValueChanged:function(a,b){var c=a.minValue&&a.maxValue;if(c&&(b<a.minValue||b>a.maxValue)){return}this.ptzValueChange('pan',b)},tiltValueChanged:function(a,b){var c=a.minValue&&a.maxValue;if(c&&(b<a.minValue||b>a.maxValue)){return}if(a.reference=='tiltNumberField'){b=this.convertTiltValue(b,!1)}this.ptzValueChange('tilt',b)},zoomValueChanged:function(a,b){var c=a.minValue&&a.maxValue;if(c&&(b<a.minValue||b>a.maxValue)){return}if(a.reference=='zoomNumberField'){b=this.convertZoomValue(b,!1)}this.ptzValueChange('zoom',b)},resetPTZPosition:function(){var b=this.getViewModel(),a=b.get('selectedWebcamPosition');if(a&&a.get('id')&&Ext.isNumeric(a.get('id'))){this.moveToPreset(a.get('id'))}},createPTZPresetPressed:function(){var a=this.getViewModel();Ext.create('photoViewer.view.positioncontrols.CreatePresetWindow',{viewModel:{parent:a}}).show()},deletePTZPresetPressed:function(){var c=this,a=this.getViewModel().get('selectedWebcamPosition'),d=this.getViewModel().get('webcamPositions'),b=this.getViewModel().get('activeStream');if(a.get('ArchivePositionID')){return}analytics.Ctrl.log('Clicked Delete Preset Button',{},['Webcam UID']);MDS.Msg.show({xtype:'mmvmsgbox',title:mvstr['PTZ_Delete Preset'],message:mvstr["PTZ_Are you sure you'd li"],buttonText:{action:mvstr['G_Yes'],cancel:mvstr['G_Cancel']},maxWidth:400,fn:function(e){if(e=='action'){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientWebcam.removePreset',params:{WebcamUID:b.WebcamUID,ProjectUID:b.ProjectUID,name:a.get('Name')},successCallback:function(){d.remove(a);c.matchCurrentPositionToPreset()}})}},scope:this,transparentModal:!0})},convertZoomValue:function(b,c){var a=this.getWebcam().PTZLimits;if(c){return Math.round(100*b/(a.MaxZoom-a.MinZoom))}else {return b/100*(a.MaxZoom-a.MinZoom)}},convertTiltValue:function(d,f){var b=this.getWebcam().PTZLimits,a=b.MinTilt,e=b.MaxTilt,c=0-a,g=e+c;if(f){return Math.round(Math.min(Math.max((d+c)/g*100,0),100))}else {return a+(e-a)*d/100}},handleResize:function(){var c=this.getView(),b=c.up('photocontainer'),e=b.lookupReference('webcamLiveStream').down('#wcLiveStreamContainer'),a=b.down('button[cls=prev-photo-button]').getWidth();var f=c.getWidth()+a;var d=(b.getWidth()-e.getWidth())/2;if(d<f){var g=d<a?a-d:15;c.alignTo(e.getId(),'tl?',[g,15])}else {c.alignTo(b.getId(),'tl?',[a,15])}}},0,0,0,0,['controller.streampositioncontrols'],0,[photoViewer.view.positioncontrols,'StreamPositionControlsController'],0);Ext.cmd.derive('photoViewer.view.positioncontrols.StreamPositionSlider',Ext.container.Container,{constructor:function(a){a=a||{};var d=!!a.vertical;var c='plus',b='minus';var e={xtype:'slider',cls:'control-slider',vertical:d,flex:1,listeners:{changecomplete:function(b,d){analytics.Ctrl.setOptionalDefaultEventProperties({'Method':'Slider','Sub Method':'Slider Drag'});var c=b.up('streampositionslider');c.fireEvent('changecomplete',b,d)}}};if(d){a.cls=a.cls+' vertical';a.layout={type:'vbox',align:'middle'};if(a.buttonType=='arrow'){c='up';b='down'}}else {a.layout='hbox';if(a.buttonType=='arrow'){c='right';b='left'}}a.items=[{xtype:'button',text:a.buttonType=='arrow'?'':'+',cls:'control-slider-button '+c,handler:function(b){b.up('streampositionslider').nudgeSlider(1)}},e,{xtype:'button',text:a.buttonType=='arrow'?'':'',cls:'control-slider-button '+b,handler:function(b){b.up('streampositionslider').nudgeSlider(-1)}}];if(!a.vertical){a.items.reverse()}Ext.container.Container.prototype.constructor.call(this,a)},getValue:function(a){return this.down('slider').getValue()},setValue:function(a){this.down('slider').setValue(a)},setMaxValue:function(a){this.down('slider').setMaxValue(a)},setMinValue:function(a){this.down('slider').setMinValue(a)},nudgeSlider:function(d){var a=this.down('slider'),b=a.maxValue,c=a.minValue,e=a.getValue(),g=b-c,f=d*(g/30);newValue=e+f;newValue=Math.min(b,newValue);newValue=Math.max(c,newValue);analytics.Ctrl.setOptionalDefaultEventProperties({'Method':'Slider','Sub Method':'Arrow Click'});a.setValue(newValue);this.fireEvent('changecomplete',a,newValue)}},1,['streampositionslider'],['component','box','container','streampositionslider'],{'component':!0,'box':!0,'container':!0,'streampositionslider':!0},['widget.streampositionslider'],0,[photoViewer.view.positioncontrols,'StreamPositionSlider'],0);Ext.cmd.derive('photoViewer.view.sidepanel.PhotoViewerCommentsPane',Ext.panel.Panel,{height:'100%',layout:'fit',padding:'10 15 10 15',items:[{xtype:'comments',reference:'comments'}]},0,['photoviewercommentspane'],['component','box','container','panel','photoviewercommentspane'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewercommentspane':!0},['widget.photoviewercommentspane'],0,[photoViewer.view.sidepanel,'PhotoViewerCommentsPane'],0);Ext.cmd.derive('photoViewer.view.sidepanel.PhotoViewerFloorplanMinimap',Ext.Component,{reinit:function(){if(this.map){this.map.remove()}this.map=MVLeaflet.map(this.getId(),{zoomControl:!1,boxZoom:!1,touchZoom:!1,keyboard:!1,attributionControl:!1,fadeAnimation:!1})}},0,['photoviewerfloorplanminimap'],['component','box','photoviewerfloorplanminimap'],{'component':!0,'box':!0,'photoviewerfloorplanminimap':!0},['widget.photoviewerfloorplanminimap'],0,[photoViewer.view.sidepanel,'PhotoViewerFloorplanMinimap'],0);Ext.cmd.derive('photoViewer.view.sidepanel.PhotoViewerFloorplanView',Ext.panel.Panel,{ui:'dark',reference:'floorplanWidget',layout:'card',width:360,height:339,margin:'20 0 0 0',bind:{activeItem:'{floorplanWidgetCard}'},tbar:{height:46,items:[{xtype:'label',localized:{text:'PV_Floorplan'},margin:'0 0 0 14'},{xtype:'component',flex:1},{xtype:'button',ui:'more-options',width:24,height:16,margin:'0 10 0 0',cls:'on-orange',menu:{cls:'photo-viewer-floorplan-widget-menu',showSeparator:!1,shadow:!1,width:145,items:[{localized:{text:'PV_Go to Floorplan'},height:20,margin:'0 1 0 1',listeners:{click:'gotoFloorplan'}},{localized:{text:'PV_Enable Splitscreen Mo'},height:20,margin:'0 1 0 1',bind:{disabled:'{floorplanModeOn}'},listeners:{click:function(){this.lookupViewModel().set('layoutMode','floorplan')}}}]},tooltip:{localized:{text:'PV_Menu'},anchor:'top'}}]},items:[{xtype:'clientFloorplanViewerDisp',cls:'mv-light-load-mask',reference:'smallFloorplanView',itemId:'defaultFloorplanView',showMiniMap:!1,showHotspotComments:!1,showSelectionLayer:!1,showZoomControls:!1,showHovers:!1,showPhotoThumbs:!1,showTitle:!1,showLegend:!1,showMapTools:!1,openPins:!1,width:'100%',height:'100%',animateOptions:{pan:{animate:!0,duration:0.5,easeLinearity:0.1},zoom:{animate:!0}},bind:{style:{visibility:'{largeFloorplanVisible}'}}},{xtype:'photoviewerfloorplanminimap',cls:'mv-light-load-mask',reference:'minimapFloorplanView',itemId:'minimapFloorplanView',width:'100%',height:'100%',bind:{style:{visibility:'{largeFloorplanVisible}'}}}]},0,['photoviewerflooplanview'],['component','box','container','panel','photoviewerflooplanview'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewerflooplanview':!0},['widget.photoviewerflooplanview'],0,[photoViewer.view.sidepanel,'PhotoViewerFloorplanView'],0);Ext.cmd.derive('photoViewer.view.sidepanel.PhotoViewerSideControls',Ext.tab.Panel,{layout:'card',width:360,flex:1,ui:'orange2',config:{mvPreloadImages:['mds/image/icon/comments-tab-icon-deselected.svg','mds/image/icon/annotations-tab-icon-deselected.svg','mds/image/icon/measurements-tab-icon-deselected.png','mds/image/icon/comments-tab-icon-selected.svg','mds/image/icon/annotations-tab-icon-selected.svg','mds/image/icon/measurements-tab-icon-selected.png'],measurementsAvailable:!1},items:[{xtype:'photoviewercommentspane',localized:{title:'GC_Comments'},iconCls:'comments-tab',icon:'mds/image/icon/comments-tab-icon-deselected.svg'},{xtype:'photoviewerannotationspane',localized:{title:'PV_Annotate'},iconCls:'annotations-tab',icon:'mds/image/icon/annotations-tab-icon-deselected.svg'},{xtype:'photoviewermeasurementspane',itemId:'measureTab',localized:{title:'PV_Measure'},iconCls:'measurements-tab',icon:'mds/image/icon/measurements-tab-icon-deselected.png'}]},0,['photoviewersidecontrols'],['component','box','container','panel','tabpanel','photoviewersidecontrols'],{'component':!0,'box':!0,'container':!0,'panel':!0,'tabpanel':!0,'photoviewersidecontrols':!0},['widget.photoviewersidecontrols'],0,[photoViewer.view.sidepanel,'PhotoViewerSideControls'],0);Ext.cmd.derive('photoViewer.view.sidepanel.PhotoViewerSidePanel',Ext.Container,{mvPreloadImages:['mds/image/icon/expand-sidebar-arrow.svg'],width:371,height:'100%',layout:{type:'hbox'},margin:'0 0 0 9',items:[{xtype:'expandtab',width:7,height:11,margin:'3 5 0 0',padding:1,listeners:{'click':{fn:function(){this.lookupViewModel().set('sidePanelCollapsed',!this.lookupViewModel().get('sidePanelCollapsed'))}}}},{xtype:'container',itemId:'sidePanelContent',layout:{type:'vbox',pack:'end'},width:360,height:'100%',items:[{xtype:'photoviewersidecontrols',hidden:!0,bind:{hidden:'{!account.canRead}'}},{xtype:'container',layout:'fit',width:360,height:339,items:[{xtype:'photoviewerflooplanview',hidden:!0,bind:{hidden:'{!floorplanVisible}'}}]}]}]},0,['photoviewersidepanel'],['component','box','container','photoviewersidepanel'],{'component':!0,'box':!0,'container':!0,'photoviewersidepanel':!0},['widget.photoviewersidepanel'],0,[photoViewer.view.sidepanel,'PhotoViewerSidePanel'],0);Ext.cmd.derive('photoViewer.view.sidepanel.photoviewerannotationspane.PhotoViewerAnnotationsPane',Ext.panel.Panel,{controller:'photoviewerannotationspane',layout:'fit',config:{mvPreloadImages:['mds/image/component/annotations-toggle-on.png','mds/image/component/annotations-toggle-off.png']},viewModel:{data:{allAnnotationsHidden:!1},formulas:{projectMapEditable:function(a){return a('account.canWrite')},copyAnnotationBtnDisabled:function(a){var b=a('selectedDrawing'),c=a('annotationStore');return !(b&&c&&a('annoProps.storeLoaded')&&c.contains(b)&&a('drawMode')==photoViewer.Values.DRAW_ANNOTATING)},deleteAnnotationBtnDisabled:function(b){var a=b('selectedDrawing'),c=b('annotationStore');return !(a&&c&&b('annoProps.storeLoaded')&&c.contains(a)&&a.get('CanEdit'))}}},dockedItems:[{xtype:'container',layout:{type:'hbox',pack:'middle',align:'center'},dock:'top',height:38,width:'100%',items:[{xtype:'container',layout:{type:'hbox',pack:'middle',align:'center'},dock:'top',height:38,width:'100%',items:[{xtype:'label',cls:'annotations-toggle-label',localized:{text:'PV_Annotations Mode'},margin:'0 12 0 0'},{xtype:'button',ui:'plain',width:45,height:19,cls:'annotation-button',enableToggle:!0,tooltip:{localized:{text:'PV_Enable/Disable Drawin'},anchor:'top'},bind:{pressed:'{annotating}',disabled:'{!drawingReady}'}}],bind:{hidden:'{!annotationsAvailable}'}},{xtype:'container',layout:{type:'hbox',pack:'middle',align:'center'},dock:'top',height:46,width:'100%',items:[{xtype:'component',dock:'top',localized:{html:'PV_Annotating is not ava'}}],bind:{hidden:'{annotationsAvailable}'}}],bind:{hidden:'{!account.canWrite}'}}],constructor:function(a){a=a||[];a.items=[{xtype:'annotationsgrid',localized:{emptyText:'PV_There are no annotati'},padding:0,typeHidden:!0,removeImportExport:!0,showVisibilityHeaderToggle:!0,tooltipConfig:photoViewer.view.photoviewer.PhotoViewer.defaultTooltipConfig,bind:{selection:'{selectedDrawing}',hidden:'{!annotationsAvailable}'}}];Ext.panel.Panel.prototype.constructor.call(this,a)}},1,['photoviewerannotationspane'],['component','box','container','panel','photoviewerannotationspane'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewerannotationspane':!0},['widget.photoviewerannotationspane'],0,[photoViewer.view.sidepanel.photoviewerannotationspane,'PhotoViewerAnnotationsPane'],0);Ext.cmd.derive('photoViewer.view.sidepanel.photoviewerannotationspane.PhotoViewerAnnotationsPaneController',Ext.app.ViewController,{init:function(){var a=this.getViewModel();a.bind('{activePhoto}',this.onActivePhotoChange,this)},annotationColorButtonChange:function(b,a){if(a.shape){a.shape.setColour(b)}},annotationGridBeforeSelectionChanged:function(b,a){return this.getView().up('photoviewer').getController().beforeDrawableSelectionChange(a)},annotationGridCellEdit:function(e,f,b,a,g,c,h,d){return a.get('CanEdit')},annotationVisibilityChanged:function(e){var d=this.getView().up('photoviewer').getController().lookupReference('photoContainer').getController().lookupReference('photo').getController(),b=!0,c=!0,a=Ext.getCmp(this.getView().down('annotationsgrid').el.select('.x-btn.annotation-visible-icon').elements[0].id);d.updateAnnotationVisibility(e);this.getView().down('annotationsgrid').getStore().each(function(a){if(a.get('Visible')){c=!1}else {b=!1}},this);if(b){a.setPressed(!1)}else {if(c){a.setPressed(!0)}}},removeButtonClick:function(){this.getView().up('photoviewer').lookupController().removeDrawable(this.getViewModel().get('selectedDrawing'))},copyButtonClick:function(){var b=this.getViewModel().get('selectedDrawing'),a=b.copy(null);a.set('Title',b.get('Title')+' (copy)');a.createShape(this.getView().up('photoviewer').getController().getPhotoComponent());this.getView().up('photoviewer').getViewModel().get('drawablesStore').add(a);this.getView().up('photoviewer').getViewModel().set('selectedDrawing',a)},onToggleAllVisibilityClick:function(a){this.getView().down('annotationsgrid').getStore().each(function(b){b.set('Visible',!a.pressed);this.annotationVisibilityChanged(b)},this)},onActivePhotoChange:function(){var a=this.getView().down('grid').visibilityToggle;if(a){a.setPressed(!1)}},viewMeasurementsInfo:function(){window.open(this.getViewModel().get('usingMetric')?'https://info.multivista.com/measurable-3d-image-met':'https://info.multivista.com/measurable-3d-images','_blank')},annotationGridSelectionChanged:Ext.emptyFn,annotationShareTypeChanged:Ext.emptyFn,annotationGridEdit:Ext.emptyFn,annotationGridRowClick:Ext.emptyFn,annotationGridBeforeRowClick:Ext.emptyFn},0,0,0,0,['controller.photoviewerannotationspane'],0,[photoViewer.view.sidepanel.photoviewerannotationspane,'PhotoViewerAnnotationsPaneController'],0);Ext.cmd.derive('photoViewer.view.sidepanel.photoviewermeasurementspane.PhotoViewerMeasurementsPane',Ext.panel.Panel,{controller:'photoviewerannotationspane',layout:'fit',config:{mvPreloadImages:['mds/image/component/annotations-toggle-on.png']},viewModel:{formulas:{projectMapEditable:function(a){return a('account.canWrite')},deleteAnnotationBtnDisabled:function(b){var a=b('selectedDrawing'),c=b('measurementsStore');return !(a&&c&&b('annoProps.storeLoaded')&&c.contains(a)&&a.get('CanEdit'))}}},bind:{disabled:'{gettingCmiLength}'},dockedItems:[{xtype:'photoviewernomeasurementspane'}],constructor:function(a){a=a||[];a.items=[{xtype:'annotationsgrid',localized:{emptyText:'PV_There are no measurem',titleHeaderLabel:'PV_Measurements'},padding:0,typeHidden:!0,removeImportExport:!0,removeCopy:!0,tooltipConfig:photoViewer.view.photoviewer.PhotoViewer.defaultTooltipConfig,showVisibilityHeaderToggle:!0,bind:{hidden:'{!activePhoto.CmiName}',store:'{measurementsStore}',selection:'{selectedDrawing}'}}];Ext.panel.Panel.prototype.constructor.call(this,a)}},1,['photoviewermeasurementspane'],['component','box','container','panel','photoviewermeasurementspane'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewermeasurementspane':!0},['widget.photoviewermeasurementspane'],0,[photoViewer.view.sidepanel.photoviewermeasurementspane,'PhotoViewerMeasurementsPane'],0);Ext.cmd.derive('photoViewer.view.sidepanel.photoviewermeasurementspane.PhotoViewerNoMeasurementsPane',Ext.Container,{layout:{type:'hbox',pack:'middle',align:'center'},dock:'top',height:46,margin:'12 0 0 0',width:'100%',config:{measureInfoLink:''},items:[{xtype:'component',cls:'unmeasurable-text',dock:'top',localized:{html:'mvstr[PV_This is not a measura]<br/>mvstr[PV_To learn more about 3]'}}],bind:{hidden:'{activePhoto.CmiName}',measureInfoLink:'{measureInfoLink}'},setMeasureInfoLink:function(a){if(this.el){this.el.select('a').elements[0].href=a}}},0,['photoviewernomeasurementspane'],['component','box','container','photoviewernomeasurementspane'],{'component':!0,'box':!0,'container':!0,'photoviewernomeasurementspane':!0},['widget.photoviewernomeasurementspane'],0,[photoViewer.view.sidepanel.photoviewermeasurementspane,'PhotoViewerNoMeasurementsPane'],0);Ext.cmd.derive('photoViewer.view.topbar.PhotoActionsMenu',Ext.button.Button,{ui:'more-options',reference:'listMenuButton',scale:'medium',menuAlign:'tr-br?',mvPreloadImages:['mds/image/component/submenu.png'],menu:{ui:'dark2',width:155,showSeparator:!1,shadow:!1,cls:'photo-actions-menu',items:[{xtype:'photosavemenuitemdark',bind:{disabled:'{!photoCanBeSaved}',hidden:'{activeTimelapse}'}},{itemId:'saveTimelapseAction',localized:{text:'PUL_Save'},hidden:!0,bind:{hidden:'{!activeTimelapse}'}},{xtype:'integrationmenuitemdark',hidden:!0,bind:{hidden:'{!integrationsMenuVisible}',disabled:'{!selectedPhotoCount}'}},{itemId:'printPhotosAction',localized:{text:'PUL_Print'},hidden:!0,cls:'print-button',bind:{disabled:'{!selectedPhotoCount}',hidden:'{!photoactions_showPrintEmailButtons}'}},{localized:{text:'PUL_Email'},hidden:!0,itemId:'emailPhotosAction',cls:'email-button',bind:{disabled:'{!selectedPhotoCount}',hidden:'{!photoactions_showPrintEmailButtons}'}},{localized:{text:'PUL_Add a Comment'},itemId:'addCommentAction',cls:'add-comment-button',hidden:!0,bind:{disabled:'{!selectedPhotoCount}',hidden:'{!addCommentActionVisible}'}},{localized:{text:'PUL_Edit Date and Sharing'},itemId:'editDateAndSharingAction',cls:'edit-date-and-sharing-button',hidden:!0,bind:{hidden:'{!onlyOwnedPhotosSelected}'}},{localized:{text:'PUL_Delete'},itemId:'deleteAction',hidden:!0,bind:{hidden:'{!oneOwnedPhotoSelected}'}},{localized:{text:'PUL_Settings'},itemId:'photoListSettings',hidden:!0,bind:{hidden:'{!pageHasSettings}'}},{localized:{text:'PUL_Followers'},itemId:'albumFollowersAction',hidden:!0,bind:{hidden:'{!followersMenuVisible}'}}]},viewModel:{formulas:{photoactions_showPrintEmailButtons:function(a){var c=a('activeStream'),b=a('activeTimelapse');return !(c||b)}}},constructor:function(a){a=a||{};a.tooltip={text:mvstr.PUL_Menu,anchor:'top'};Ext.button.Button.prototype.constructor.call(this,a)}},1,['photoactionsmenu'],['component','box','button','photoactionsmenu'],{'component':!0,'box':!0,'button':!0,'photoactionsmenu':!0},['widget.photoactionsmenu'],0,[photoViewer.view.topbar,'PhotoActionsMenu'],0);Ext.cmd.derive('photoViewer.view.topbar.PhotoViewerActionsMenu',photoViewer.view.topbar.PhotoActionsMenu,{constructor:function(){photoViewer.view.topbar.PhotoActionsMenu.prototype.constructor.apply(this,arguments);var a=this.getMenu();a.add([{localized:{text:'PV_Help'},listeners:{click:'showTour'}},{text:'Switch to Old Viewer',hidden:!0,bind:{hidden:'{!account.features.photoviewerHasOptOut}'},listeners:{click:'switchPhotoViewer'}}])}},1,['photovieweractionsmenu'],['component','box','button','photoactionsmenu','photovieweractionsmenu'],{'component':!0,'box':!0,'button':!0,'photoactionsmenu':!0,'photovieweractionsmenu':!0},['widget.photovieweractionsmenu'],0,[photoViewer.view.topbar,'PhotoViewerActionsMenu'],0);Ext.cmd.derive('photoViewer.view.topbar.PhotoViewerLayoutMenu',Ext.button.Button,{ui:'dark',width:43,height:35,padding:7,config:{menuOptions:[{icon:'mds/image/icon/photoviewer-view-default.svg',viewMode:'default',tooltip:{text:'PV_Default Mode',anchor:'top'}},{icon:'mds/image/icon/floorplan-splitscreen-toggle.svg',viewMode:'floorplan',tooltip:{text:'PV_Floorplan Mode',anchor:'top'}}],activeButton:null,viewMode:'default',mvPreloadImages:['mds/image/icon/floorplan-splitscreen-toggle.svg'],menuCls:'photo-viewer-layout-menu'},publishes:'viewMode',bind:{viewMode:'{layoutMode}'},tooltip:{localized:{text:'PV_View Mode'},anchor:'top',anchorSize:[12,5]},initComponent:function(){var b=this.getMenuOptions(),d=this.getViewMode();for(var a=0;a<b.length;a++){b[a].tooltip.text=mvstr[b[a].tooltip.text];b[a].listeners={click:{fn:this.onMenuButtonClick,scope:this}};b[a].hidden=d==b[a].viewMode}this.setIcon(b[0].icon);this.setMenu({items:b,ui:'dark',cls:this.getMenuCls(),width:43,padding:7,minWidth:43,shadow:!1});Ext.button.Button.prototype.initComponent.apply(this,arguments);var c=this.getMenu().items.items;for(var a=0;a<c.length;a++){if(d&&c[a].viewMode==d){this.activeButton=c[a]}}this.getMenu().addListener('show',this.onMenuFirstShow,this,{single:!0,delay:1})},onButtonClick:function(){this.changeMode(this.getActiveButton())},onMenuButtonClick:function(a){this.changeMode(a);this.setIcon(a.icon);this.setActiveButton(a)},changeMode:function(a){this.setViewMode(a.viewMode)},updateActiveButton:function(b,a){b.hide();if(a){a.show()}},updateViewMode:function(c){if(this.isConfiguring){return}var b=this.getMenu().items.items;for(var a=0;a<b.length;a++){if(b[a].viewMode==c){this.onMenuButtonClick(b[a])}}},onMenuFirstShow:function(){var b=this.getMenu().items.items,c=this.getViewMode();for(var a=0;a<b.length;a++){if(b[a].viewMode!=c){b[a].hide();b[a].show()}}}},0,['photoviewerlayoutmenu'],['component','box','button','photoviewerlayoutmenu'],{'component':!0,'box':!0,'button':!0,'photoviewerlayoutmenu':!0},['widget.photoviewerlayoutmenu'],0,[photoViewer.view.topbar,'PhotoViewerLayoutMenu'],0);Ext.cmd.derive('photoViewer.view.topbar.PhotoViewerTitle',Ext.Component,{viewModel:{formulas:{titleData:function(c){var b={imageURL:c('project.ImageURL64'),title1:'',title2:'',title3:'',weatherData:''};var a=c('activePhoto');if(a){b.title1=a.get('Type')=='U'?mvstr['PV_User-Uploaded Photo']:a.get('DescLine2')?a.get('DescLine2'):a.get('DescLine1');b.title2=a.get('DescLine3');b.title3=a.get('PhotoLatitude')!==''&&a.get('PhotoLatitude')!==undefined?'Lat: '+a.get('PhotoLatitude')+' Long: '+a.get('PhotoLongitude')+' Elev: '+a.get('PhotoAltitude')+' ASL':''}if(a&&a.get('Weather')){b.weatherData={Weather:a.get('Weather')||'',WindDirection:a.get('WindDirection')||'',WindMPH:a.get('WindMPH')||'',TemperatureF:a.get('TemperatureF')||'',PhotoDate:a.get('PhotoDate')}}var d=c('activeWebcam');if(d){b.title1=d.get('WebcamLabel');if(c('activeStream')){b.title2=mvstr['WV_Live View']}if(c('activeTimelapse')){b.title2=mvstr['WV_Timelapse']}}return b}}},bind:{data:'{titleData}'},tpl:'<img src="{imageURL}"><div class="photo-viewer-title"><div class="title1">{title1}</div><tpl if="weatherData.Weather!==\'\'"><div class="title2">{weatherData.Weather}</div></tpl><div class="title2">{title2}</div><tpl if="title3!==\'\'"><div class="title3">{title3}</div></tpl></div>',listeners:{afterrender:function(a){a.tip1=Ext.create('Ext.tip.ToolTip',Ext.mergeIf({target:this.getId(),cls:'x-tip-dark multiline',delegate:'.photo-viewer-weather',listeners:{beforeshow:{fn:a.onTooltipBeforeShow,scope:a}}},photoViewer.view.photoviewer.PhotoViewer.defaultTooltipConfig))}},onTooltipBeforeShow:function(b){var c=this.getViewModel(),a=c.get('weatherDisplayData');if(Ext.Object.isEmpty(a)){return !1}b.update(a.desc+(a.desc?'<br>':'')+a.temperature+(a.temperature?'<br>':'')+a.windDirection+(a.windDirection?' '+a.windSpeed:''))}},0,['photoviewertitle'],['component','box','photoviewertitle'],{'component':!0,'box':!0,'photoviewertitle':!0},['widget.photoviewertitle'],0,[photoViewer.view.topbar,'PhotoViewerTitle'],0);Ext.cmd.derive('photoViewer.view.topbar.PhotoViewerTopToolbar',Ext.Container,{padding:'12 20 12 20',margin:'0 0 12 0',height:90,layout:{type:'hbox',align:'center'},items:[{xtype:'photoviewertitle'},{xtype:'component',flex:1},{xtype:'photoviewerlayoutmenu',cls:'photoviewer-view-menu',width:45,height:31,padding:'0 7 0 7',margin:'0 14 0 0',menuOptions:[{icon:'mds/image/icon/sitewalk360.png',viewMode:photoViewer.Values.VIEW_SITEWALK360,tooltip:{text:'PV_Sitewalk 360',anchor:'top'}},{icon:'mds/image/icon/truview.png',viewMode:photoViewer.Values.VIEW_TRUVIEW,tooltip:{text:'PV_TruView',anchor:'top'}}],menuCls:'photo-viewer-layout-menu photoviewer-view-menu',mvPreloadImages:['mds/image/icon/truview.png','mds/image/icon/sitewalk360.png'],hidden:!0,bind:{viewMode:'{viewModeButtonValue}',hidden:'{!hasMatterportAndTruView}'}},{xtype:'button',cls:'photo-viewer-webcam-button',ui:'dark',margin:'0 24 0 0',iconCls:'photo-viewer-livestream-btn',hidden:!0,toggleGroup:'webcam-view-btn',allowDepress:!1,bind:{hidden:'{!canSwitchToStream}',pressed:'{activeStreamSelected}'},listeners:{toggle:function(b,a){if(a){analytics.Ctrl.log('Clicked Webcam Navigation Button',{'Webcam View':'Live Stream'},['Webcam UID']);this.lookupController().gotoWebcamStream()}}},tooltip:{localized:{text:'WV_Live View'},anchor:'top'}},{xtype:'button',cls:'photo-viewer-webcam-button',itemId:'photoViewerWebcamModeToggle',margin:'0 22 0 0',iconCls:'photo-viewer-archive-btn',ui:'dark',hidden:!0,toggleGroup:'webcam-view-btn',allowDepress:!1,bind:{hidden:'{!canSwitchToArchive}',pressed:'{activeArchiveSelected}'},listeners:{click:function(){analytics.Ctrl.log('Clicked Webcam Navigation Button',{'Webcam View':'Archive'},['Webcam UID']);this.lookupController().gotoWebcamArchive()}},tooltip:{localized:{text:'WV_Archives'},anchor:'top'}},{xtype:'button',cls:'photo-viewer-webcam-button',iconCls:'photo-viewer-timelapse-btn',ui:'dark',hidden:!0,toggleGroup:'webcam-view-btn',allowDepress:!1,bind:{hidden:'{!canSwitchToTimelapse}',pressed:'{activeTimelapseSelected}'},listeners:{toggle:function(b,a){if(a){analytics.Ctrl.log('Clicked Webcam Navigation Button',{'Webcam View':'Timelapse'},['Webcam UID']);this.lookupController().gotoWebcamTimelapse()}}},tooltip:{localized:{text:'WV_Timelapse'},anchor:'top'}},{xtype:'photoviewerlayoutmenu',itemId:'photoViewerLayoutModeToggle',hidden:!0,bind:{hidden:'{activeWebcam}'}},{xtype:'photovieweractionsmenu',margin:'0 10 0 30',hidden:!0},{xtype:'container',width:35,items:[{xtype:'button',itemId:'photoViewerCloseButton',cls:'close-button',ui:'plain',text:'X',margin:'0 0 0 20',listeners:{click:{fn:'closePhotoViewer',delay:1}},tooltip:{localized:{text:'G_Close'},anchor:'top'}}]}]},0,['photoviewertoptoolbar'],['component','box','container','photoviewertoptoolbar'],{'component':!0,'box':!0,'container':!0,'photoviewertoptoolbar':!0},['widget.photoviewertoptoolbar'],0,[photoViewer.view.topbar,'PhotoViewerTopToolbar'],0);Ext.cmd.derive('photoViewer.view.photoviewer.PhotoViewer',Ext.panel.Panel,{viewModel:{type:'photoviewer'},controller:'photoviewer',statics:{defaultTooltipConfig:{anchor:'top',anchorToTarget:!0,cls:'x-tip-dark',anchorSize:[0,12],shadow:!1},launchWithProjectWrapper:function(a,b,d,c){if(a.lookupViewModel().get('account.features.photoviewerVisible')&&Ext.versions.ext.major==6&&Ext.versions.ext.minor==2){this.launchWithProjectWrapper2(a,b,d)}else {document.location=c}},launchWithProjectWrapper2:function(c,b,d){var a=c.add({xtype:'projectwrapper'}).show();a.getViewModel().set('ProjectUID',b);Ext.asap(function(){a.initWrapper(function(){var e=a.add(d).show();a.el.addListener('resize',function(g,f,a){e.setSize(f,a)},this);e.addListener('destroy',function(){a.destroy()})})})}},width:'100%',height:'100%',floating:!0,alwaysOnTop:!0,layout:{type:'fit'},config:{loadMaskCls:'dark-load-indicator'},dockedItems:[{dock:'top',xtype:'photoviewertoptoolbar',reference:'topToolbar'}],items:[{xtype:'container',reference:'mainContainer',layout:{type:'hbox',align:'stretch'},items:[{xtype:'photoviewermainpanel'},{xtype:'photoviewersidepanel',reference:'photoViewerSidePanel',bind:{hidden:'{!activePhoto}'}}]},{xtype:'photoviewerannotationstoolwindow'},{xtype:'photoviewermeasurementtools'},{xtype:'photoviewercontextmenu',reference:'contextMenu'},{xtype:'photoviewerexif',reference:'exifDisplay'}],listeners:{boxready:{fn:'onPhotoViewerBoxReady',delay:1000}}},0,['photoviewer'],['component','box','container','panel','photoviewer'],{'component':!0,'box':!0,'container':!0,'panel':!0,'photoviewer':!0},['widget.photoviewer'],0,[photoViewer.view.photoviewer,'PhotoViewer'],0);Ext.cmd.derive('notifications.Template',Ext.Base,{singleton:!0,tpl:new Ext.XTemplate('<div class="time-header notification-section-{SectionName}">','{SectionName}','<tpl if="!this.isMobile() && this.placeMarkAsRead(values, xindex)">','<a class="mark-read">Mark all as read</a>','</tpl>','</div>','<tpl for="Notifications">','<tpl if="SAID1">','<div class="notification-item alert<tpl if="Filter"> filtered</tpl>">','<tpl else>','<div class="notification-item notification<tpl if="!IsRead"> unread</tpl><tpl if="Filter"> filtered</tpl>">','</tpl>','<img src="{ImageURL64}">','<div class="text">','<div class="message">','{Message}','</div>','<div class="line2">','<span class="project">{LongProjectTitle}</span>','<span class="time-description">{TimeDescription}</span>','</div>','</div>','</div>','</tpl>',{hasAlerts:!1,placeMarkAsRead:function(b,a){if(b.SectionName==='Alerts'){this.hasAlerts=!0;return !1}if(!this.hasAlerts&&a==1){return !0}return this.hasAlerts&&a==2},isMobile:function(){return !!window.mvphoto}})},0,0,0,0,0,0,[notifications,'Template'],0);Ext.cmd.derive('notifications.model.Base',Ext.data.Model,{schema:{id:'notifications',namespace:'notifications.model'}},0,0,0,0,0,0,[notifications.model,'Base'],0);Ext.cmd.derive('notifications.model.Notification',notifications.model.Base,{fields:[{name:'Message',type:'string'},{name:'IsRead',type:'boolean'},{name:'LongProjectTitle',type:'string'},{name:'ImageURL64',type:'string'},{name:'SAID1',type:'int'},{name:'SAID2',type:'int'},{name:'SNID1',type:'int'},{name:'SNID2',type:'int'},{name:'URL',calculate:function(a){if(!window.mdslink){return ''}var b=a.SAID1,c=a.SAID2,d=a.SNID1,e=a.SNID2;return b?mdslink.notificationLink+'SAID1='+b+'&SAID2='+c:mdslink.notificationLink+'SNID1='+d+'&SNID2='+e}},{name:'URI',type:'string'},{name:'NotificationDateTime',type:'date',persist:!1},{name:'ReferenceTime',type:'date',convert:function(a){return a||new Date()}},{calculate:function(a){return customData.Util.getTimeDescription(a.ReferenceTime,a.NotificationDateTime)},name:'TimeDescription',type:'string',persist:!1}]},0,0,0,0,0,0,[notifications.model,'Notification'],0);Ext.cmd.derive('notifications.model.NotificationSection',notifications.model.Base,{hasMany:{model:'Notification',name:'getNotifications',associationKey:'Notifications'},fields:[{name:'SectionName',type:'string'}]},0,0,0,0,0,0,[notifications.model,'NotificationSection'],0);Ext.cmd.derive('notifications.view.List',Ext.view.View,{cls:'mv-notifications-list',border:!1,itemSelector:'.x-dataview-item',itemTpl:notifications.Template.tpl,emptyText:'You have no notifications',focusable:!1,listeners:{render:function(){var a=this;this.getEl().addListener('click',function(c,b){if(b.className=='mark-read'){if(a.up('notificationcenter')&&a.up('notificationcenter').getController().markAllNotificationsAsRead){a.up('notificationcenter').getController().markAllNotificationsAsRead()}}})},itemclick:'onNotificationClick'}},0,['notificationList'],['component','box','dataview','notificationList'],{'component':!0,'box':!0,'dataview':!0,'notificationList':!0},['widget.notificationList'],0,[notifications.view,'List'],0);Ext.cmd.derive('notifications.view.NotificationBell.ViewController',Ext.app.ViewController,{init:function(){var a=this},updateNotificationCount:function(a){this.setUnreadCount(a);Ext.Function.defer(this.updateNotificationCount,5*60*1000,this)},setUnreadCount:function(d){var b=this,a=b.getView(),c=b.getViewModel();c.set('loadNotificationsOnView',!0);b.flagNotificationCenter();mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aNotifications.getUnreadCount',successCallback:function(b){a.removeCls('unread');if(b.Count){a.addCls('unread');a.setText(b.Count)}else {a.setText('')}}})},flagNotificationCenter:function(){var a=app.getMainView().down('notificationcenter');if(!a){return}a.getViewModel().set('loadNotificationsOnView',!0);if(!a.up('notificationCenterDisp').hidden){a.getController().loadNotificationsStore()}},notificationBellClicked:function(){var b=this.getViewModel(),a=this.getStore('topNotifications');if(b.get('loadNotificationsOnView')){a.load();b.set('loadNotificationsOnView',!1)}else {var c=new Date();a.each(function(b){b.getNotifications().each(function(d){d.set('ReferenceTime',c);a.fireEvent('refresh',a)})})}},onNotificationClick:function(g,e,i,h,f){var b=Ext.fly(f.getTarget());if(b&&!b.hasCls('.notification-item')){b=b.up('.notification-item')}if(b){var c=b.up('.x-dataview-item').select('.notification-item').indexOf(b),a=e.get('Notifications')[c],d=this.getView().up('clientviewport')||this.getView().up('viewport');if(a&&a.ProjectUID&&Ext.Array.contains([20,21,22,27,28],a.NotificationTypeID)){photoViewer.view.photoviewer.PhotoViewer.launchWithProjectWrapper(d,a.ProjectUID,{xtype:'photoviewer',photoGroup:Ext.create('floorplanViewer.model.PhotoGroup',{'Identifier':a.SNID1+'-'+a.SNID2,'Type':'M'})},a.URL)}else {document.location=a.URL}}}},0,0,0,0,['controller.bell'],0,[notifications.view.NotificationBell,'ViewController'],0);Ext.cmd.derive('notifications.view.NotificationBell.Popup',Ext.menu.Menu,{border:!1,cls:'notifications-popup',showSeparator:!1,shadow:!1,items:[{xtype:'container',layout:{type:'vbox',align:'stretch'},items:[{xtype:'label',text:'Notifications'},{xtype:'notificationList',indent:!1,width:350,bind:{store:'{topNotifications}'}},{xtype:'button',indent:!1,ui:'plain',text:'See More',bind:{href:'{mdslink_clientNotifications}'},hrefTarget:'_self',handler:function(){if(app.getName()==='clientDashboard'){app.getController('clientDashboard.controller.Manager4Dashboard').getNavigationBar4Dashboard().selectNone();app.getMainView().query('notificationCenterDisp')[0].show()}}}]}],listeners:{show:function(a){a.showBy(a.up('button'),'bl',[-220,-30])}}},0,['notificationPopup'],['component','box','container','panel','menu','notificationPopup'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'notificationPopup':!0},['widget.notificationPopup'],0,[notifications.view.NotificationBell,'Popup'],0);Ext.cmd.derive('notifications.view.NotificationBell.ViewModel',Ext.app.ViewModel,{data:{hasNotifications:!1,loadNotificationsOnView:!1},stores:{topNotifications:{storeId:'notifications',model:'notifications.model.NotificationSection',autoLoad:!1,proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'/index.cfm?fuseaction=aNotifications.getTopNotifications'}}}},0,0,0,0,['viewmodel.bell'],0,[notifications.view.NotificationBell,'ViewModel'],0);Ext.cmd.derive('notifications.view.NotificationBell.NotificationBell',Ext.button.Button,{ui:'plain',cls:'notification-bell',width:50,controller:'bell',viewModel:{type:'bell'},hidden:!0,bind:{hidden:'{!hasNotifications}'},listeners:{menushow:'notificationBellClicked'},menu:{xtype:'notificationPopup'}},0,['notificationBell'],['component','box','button','notificationBell'],{'component':!0,'box':!0,'button':!0,'notificationBell':!0},['widget.notificationBell'],0,[notifications.view.NotificationBell,'NotificationBell'],0);Ext.cmd.derive('accountShared.model.Member',Ext.data.Model,{fields:[{name:'MemberID',convert:function(b,a){return b||a.get('MemberUID')}},{name:'MemberUsername',type:'string'},{name:'Password',type:'string'},{name:'MemberRole',type:'string',allowBlank:!1},{name:'TerritoryID',type:'int',allowBlank:!1},{name:'MemberFirstName',type:'string'},{name:'MemberLastName',type:'string'},{name:'MemberName',calculate:function(a){return Ext.String.trim(a.MemberFirstName+' '+a.MemberLastName)}},{name:'MemberEmail',type:'string'},{name:'MemberPhone',type:'string'},{name:'MemberCell',type:'string'},{name:'MemberDashboardPreference',type:'string',defaultValue:'globalfeed'},{name:'MemberProjectPreference',type:'string',defaultValue:'floorplans'},{name:'EmailFrequency',type:'string',defaultValue:'r'},{name:'EmailWeekday',type:'int',defaultValue:1},{name:'EmailTimeOfDay',type:'int'},{name:'MemberTimezone',type:'string'},{name:'MemberOverlayInt',type:'boolean'},{name:'MemberCommentIcon',type:'boolean','default':!0},{name:'EmailAsUsername',type:'boolean',persist:!1},{name:'NotificationCategorySettings',type:'auto'},{name:'MeasurePreferenceID',type:'int',defaultValue:1},{name:'ProjectRoleID'},{name:'MemberCompanyName'},{name:'EmailValidating',persist:!1,'default':!1},{name:'EmailExists',persist:!1,'default':!1},{name:'IsClientUserAdd',persist:!1,'default':!1},{name:'IsAdminUserAdd',persist:!1,'default':!1},{name:'EmailIsOtherRealm',persist:!1,'default':!1},{name:'EmailExistsAsUsername',persist:!1,'default':!1},{name:'UsernameExists',persist:!1,'default':!1},{name:'UsernameValidating',persist:!1,'default':!1}],idProperty:'id',clientIdProperty:'MemberID',proxy:{type:'ajax',writer:{type:'json',writeAllFields:!1},reader:{type:'json',rootProperty:'data'},api:{read:'/index.cfm?fuseaction=aMember.getMemberSettings',create:'/index.cfm?fuseaction=aMember.createMember',update:'/index.cfm?fuseaction=aMember.saveMemberSettings'}},validators:{MemberUsername:{fn:function(d,c){if(c.get('UsernameValidating')){return mvstr['G_Validating']}if(c.get('UsernameExists')){return mvstr['UAF_Username taken']}var a=d?d.trim():'',b=a.match(/[a-zA-Z0-9\u00C0-\u00D6\u00D8-\u00f6\u00f8-\u00ff\-!#$%&'*+\/=?\^_`{|}~@.]/g);if(a.length&&(!b||a.length!=b.length)){return mvstr['G_InvalidCharacters'].replace('{x}',"a-z 0-9 . - _ @ ! $ % & ' * + / = ? ^ ` { } | ~")}if(a.length<3){return mvstr['G_MinimumFieldLength'].replace('{x}',3)}if(a.length>60){return mvstr['G_MaximumFieldLength'].replace('{x}',60)}return !0}},MemberFirstName:{fn:function(b){var a=b?b.trim():'',c=a.match(/.*[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+.*/g);if(a.length<1){return mvstr['G_RequiredField']}if(c){return mvstr['UAF_Name cannot contain e']}if(a.length>60){return mvstr['G_MaximumFieldLength'].replace('{x}',60)}return !0}},MemberLastName:{fn:function(a){var b=a?a.trim():'',c=b.match(/.*[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+.*/g);if(b.length>60){return mvstr['G_MaximumFieldLength'].replace('{x}',60)}if(c){return mvstr['UAF_Name cannot contain e']}return !0}},MemberEmail:{type:'email',matcher:/^(?:[^\.])(?:(?:[\.])?(?:[\w\u00C0-\u00D6\u00D8-\u00f6\u00f8-\u00ff\-!#$%&'*+\/=?\^_`{|}~]))*\1@(\w[\-\w]*\.){1,5}([A-Za-z]){2,20}$/,fn:function(b,a){if(a.get('EmailValidating')){return mvstr['G_Validating']}if(a.get('EmailExists')&&!a.get('IsClientUserAdd')&&(!a.get('IsAdminUserAdd')||!a.get('EmailIsOtherRealm'))){return mvstr['UAF_Account exists with t']}if(a.get('IsClientUserAdd')&&!a.get('EmailExists')&&a.get('EmailExistsAsUsername')){return mvstr['UAF_Email is unavailable']}if(!b){return mvstr['G_RequiredField']}var c=/^(?:[^\.])(?:(?:[\.])?(?:[\w\u00C0-\u00D6\u00D8-\u00f6\u00f8-\u00ff\-!#$%&'*+\/=?\^_`{|}~]))*\1@(\w[\-\w]*\.){1,5}([A-Za-z]){2,20}$/;if(b.match(c)){return !0}return mvstr['UAF_Email not of proper f']}},MemberPhone:{fn:function(c,d){var a=c?c.trim():'',b=a.match(/[0-9 \+\-EeXxTt\.]+/g);if(!a.length){return !0}if(!b||b[0]!=a){return mvstr['UAF_Phone number can only']}if(a.length<9){return mvstr['G_MinimumFieldLength'].replace('{x}',9)}if(a.length>60){return mvstr['G_MaximumFieldLength'].replace('{x}',60)}return !0}},MemberCell:{fn:function(c,d){var a=c?c.trim():'',b=a.match(/[0-9 \+\-EeXxTt\.]+/g);if(!a.length){return !0}if(!b||b[0]!=a){return mvstr['UAF_Phone number can only']}if(a.length<9){return mvstr['G_MinimumFieldLength'].replace('{x}',9)}if(a.length>60){return mvstr['G_MaximumFieldLength'].replace('{x}',60)}return !0}},MemberCompanyName:{fn:function(a){var c=3,b=80;if(a&&a.length<c){return mvstr['G_MinimumFieldLength'].replace('{x}',c)}if(a&&a.length>b){return mvstr['G_MaximumFieldLength'].replace('{x}',b)}return !0}}}},0,0,0,0,0,0,[accountShared.model,'Member'],0);Ext.cmd.derive('accountShared.model.MemberAdmin',accountShared.model.Member,{fields:[{name:'MemberRole',type:'string',defaultValue:'client'},{name:'MemberID',type:'string',defaultValue:0},{name:'TerritoryID',type:'int'},{name:'MemberIsActive',type:'boolean',defaultValue:!0},{name:'MemberGetsNotifications',type:'boolean',defaultValue:!0},{name:'MemberCommentIcon',type:'boolean',defaultValue:!0},{name:'MemberOverlayInt',type:'boolean',defaultValue:!0},{name:'LanguageID',type:'string',defaultValue:'en'},{name:'MemberCompanyName',type:'string'},{name:'ProjectRoleID',type:'int'},{name:'MemberCompanyConfirmed',type:'int',defaultValue:0}],idProperty:'MemberID',clientIdProperty:'MemberID',validators:{MemberRole:{fn:function(a){if(!a){return 'Member Role required'}return !0}},TerritoryID:{fn:function(a){if(!a){return 'Default Territory required'}return !0}}}},0,0,0,0,0,0,[accountShared.model,'MemberAdmin'],0);Ext.cmd.derive('accountShared.model.MemberCompany',Ext.data.Model,{fields:[{name:'MemberCompanyName',type:'string'}],idProperty:'MemberCompanyName'},0,0,0,0,0,0,[accountShared.model,'MemberCompany'],0);Ext.cmd.derive('accountShared.model.ProjectRole',Ext.data.Model,{fields:[{name:'ProjectRoleID',type:'int'},{name:'ProjectRoleLabel',type:'string',convert:function(c,b){var a=mvstr['ProjectRole_'+b.get('ProjectRoleID')];return a||c}}],idProperty:'ProjectRoleID'},0,0,0,0,0,0,[accountShared.model,'ProjectRole'],0);Ext.cmd.derive('accountShared.view.MemberCompany',formShared.view.components.Combo,{reference:'memberCompany',allowBlank:!0,hideTrigger:!0,localized:{fieldLabel:'UAF_Company'},editable:!0,queryMode:'remote',minChars:3,displayField:'MemberCompanyName',valueField:'MemberCompanyName',anyMatch:!0,typeAhead:!0,setValue:function(a){if(!this.lastValue){this.lastValue=a}return formShared.view.components.Combo.prototype.setValue.apply(this,arguments)},getValue:function(){var a=formShared.view.components.Combo.prototype.getValue.apply(this,arguments);return a||''}},0,['membercompany'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','membercompany'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'membercompany':!0},['widget.membercompany'],0,[accountShared.view,'MemberCompany'],0);Ext.cmd.derive('accountShared.view.field.ProjectRole',formShared.view.components.Combo,{localized:{fieldLabel:'UAF_Role'},msgTarget:'side',bind:{store:'{projectRoles}'},displayField:'ProjectRoleLabel',valueField:'ProjectRoleID',viewModel:{stores:{projectRoles:{model:'accountShared.model.ProjectRole',autoLoad:!0,proxy:{url:'/index.cfm?fuseaction=aMember.getProjectRoles'}}}}},0,['projectrole'],['component','box','field','textfield','pickerfield','combobox','combo','detailformcombo','projectrole'],{'component':!0,'box':!0,'field':!0,'textfield':!0,'pickerfield':!0,'combobox':!0,'combo':!0,'detailformcombo':!0,'projectrole':!0},['widget.projectrole'],0,[accountShared.view.field,'ProjectRole'],0);Ext.cmd.derive('clientNavigation.model.FileUpload',Ext.data.Model,{idProperty:'id',fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'type',type:'string'},{name:'status',type:'string'},{name:'time',type:'int'},{name:'target',type:'string',defaultValue:''},{name:'message',type:'string',defaultValue:''},{name:'fileExt',type:'string',defaultValue:''},{name:'thumbUrl',type:'string',defaultValue:''},{name:'retries',type:'int',defaultValue:0},{name:'canRetry',type:'boolean',defaultValue:!0},{name:'statusLabel',calculate:function(c){var d=c.type;var a=c.status;var f=c.message;var e=c.target||'';var b=a;if(a==='error'){b=f||Ext.String.capitalize(d)+' error'}else {if(a==='processing'){if(d){b=Ext.String.capitalize(d)+'ing'+(e?' to '+e:'')+'...'}else {b=f||'Uploading...'}}else {if(a){b=Ext.String.capitalize(a)}}}return Ext.String.htmlEncode(b)}},{name:'removeCss',calculate:function(b){var a=b.status;var d=b.retries;var c=!!b.canRetry;if(a==='error'||a==='failed'){return d>0?c?'remove withRetry':'remove':''}if(a==='completed'||a==='cancelled'){return 'remove'}return ''}},{name:'buttonCss',calculate:function(b){var a=b.status;var d=b.retries;var c=!!b.canRetry;if(a==='error'||a==='failed'){return c?'retry'+(d>0?' withRemove':''):''}if(a==='processing'||a==='queued'){return 'cancel'}if(a==='completed'){return 'removeOnly'}return ''}},{name:'buttonLabel',calculate:function(b){var a=b.status;if(a==='error'||a==='failed'){return 'Retry'}if(a==='processing'||a==='queued'){return 'Cancel'}return ''}},{name:'imageStyle',calculate:function(d){var c=mdslink.server+'/mds/image/transparent.png';var b='';var a=(d.fileExt||'').toLowerCase();if(a){if(a==='jpeg'){a='jpg'}else {if(a==='mpeg'){a='mpg'}else {if(a==='tif'){a='tiff'}else {if(a==='docx'||a==='xlsx'||a==='pptx'){a=a.substr(0,3)}}}}var e=['jpg','jpeg','png','gif','tiff','pdf','zip','avi','mov','mpg','doc','xls','ppt','rvt','ifc'];if(e.indexOf(a)!==-1){c=mdslink.server+'/mds/image/clientFileManager/icons/large/'+a+'.png';b='background-size: 37px 50px'}}if(d.thumbUrl){c=d.thumbUrl;b='background-size: 80px 50px;'}var f="background-image: url('"+c+"');";return f+b}},{name:'imageCss',calculate:function(a){var b=(a.fileExt||'').toLowerCase();if(a.thumbUrl&&b==='pdf'){return 'pdf-overlay'}return ''}},{name:'titleAttr',calculate:function(b){var a=b.statusLabel;if(a.length>30){return 'title="'+a+'"'}return ''}},{name:'statusLabelSimple',calculate:function(a){var b=mvstr['GFU_'+a.status];return b||a.status}}]},0,0,0,0,0,0,[clientNavigation.model,'FileUpload'],0);Ext.cmd.derive('clientNavigation.model.MegamenuChild',Ext.data.Model,{fields:[{name:'text'},{name:'href'}]},0,0,0,0,0,0,[clientNavigation.model,'MegamenuChild'],0);Ext.cmd.derive('clientNavigation.model.MegamenuParent',Ext.data.Model,{hasMany:{model:'clientNavigation.model.MegamenuChild',name:'shoots'},fields:[{name:'text'},{name:'list',convert:function(b,c){for(var a=0;a<b.length;a++){var f=b[a].url;var e=Ext.Object.fromQueryString(c.data.list[a].url).ProjectUID,d=Ext.Object.fromQueryString(c.data.list[a].url).FloorplanUID;b[a].url=mdslink.clientFloorplanViewer+'ProjectUID='+e+'&FloorplanUID='+d}return b}}]},0,0,0,0,0,0,[clientNavigation.model,'MegamenuParent'],0);Ext.cmd.derive('clientNavigation.model.Member',Ext.data.Model,{fields:[{name:'MemberUID',type:'string'},{name:'MemberFirstName',type:'string'},{name:'MemberLastName',type:'string'},{name:'MemberDisplayName',convert:function(b,a){return a.get('MemberFirstName')+' '+a.get('MemberLastName')}},{name:'isChecked',type:'boolean',defaultValue:'false'}],idProperty:'MemberUID'},0,0,0,0,0,0,[clientNavigation.model,'Member'],0);Ext.cmd.derive('clientNavigation.view.AbstractNavigationBar',Ext.toolbar.Toolbar,{height:37,aliasButtons:[],ui:'client-navigation',cls:'client-navigation-bar'},0,0,['component','box','container','toolbar'],{'component':!0,'box':!0,'container':!0,'toolbar':!0},0,0,[clientNavigation.view,'AbstractNavigationBar'],0);Ext.cmd.derive('clientNavigation.view.GlobalMyAccount',Ext.button.Button,{text:'Loading...',bind:{account:'{account}'},ui:'plain',cls:'user-name-link invisible',iconCls:'user-name-arrow',iconAlign:'right',handler:'onUserClick',setAccount:function(a){this.account=a;if(a&&a.MemberUID){this.setText(a.MemberUsername);this.removeCls('invisible')}}},0,['globalmyaccount'],['component','box','button','globalmyaccount'],{'component':!0,'box':!0,'button':!0,'globalmyaccount':!0},['widget.globalmyaccount'],0,[clientNavigation.view,'GlobalMyAccount'],0);Ext.cmd.derive('clientNavigation.view.GlobalMyAccountMenu',Ext.menu.Menu,{ui:'topnavmenu',plain:!0,showSeparator:!1,shadow:!1,renderTo:Ext.getBody(),items:[{localized:{text:'G_My Account'},href:mdslink.clientAccount,handler:function(){analytics.Ctrl.log('Clicked User My Account',{});if(app.getName()==='clientDashboard'){app.getController('clientDashboard.controller.Manager4Dashboard').getNavigationBar4Dashboard().selectNone();app.getMainView().query('clientAccountDisp')[0].show()}}},{localized:{text:'G_Logout'},itemId:'topNavLogout',href:''}],listeners:{click:function(b,a){if(a.getItemId()=='topNavLogout'){analytics.Ctrl.log('Clicked User Log Out',{});if(window.localStorage.getItem('Multivista_ClientSession')){window.localStorage.removeItem('Multivista_ClientSession')}mdsPreferences.GlobalPreferences.removeLang();window.location.replace(mdslink.logout)}}}},0,['globalmyaccountmenu'],['component','box','container','panel','menu','globalmyaccountmenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'globalmyaccountmenu':!0},['widget.globalmyaccountmenu'],0,[clientNavigation.view,'GlobalMyAccountMenu'],0);Ext.cmd.derive('clientNavigation.view.HelpIconButton',Ext.button.Button,{id:'topNavHelpIconButton',width:32,ui:'plain',iconCls:'help-icon-button',handler:'showHelp'},0,['helpiconbutton'],['component','box','button','helpiconbutton'],{'component':!0,'box':!0,'button':!0,'helpiconbutton':!0},['widget.helpiconbutton'],0,[clientNavigation.view,'HelpIconButton'],0);Ext.cmd.derive('clientNavigation.view.HelpMenu',Ext.menu.Menu,{reference:'helpMenu',ui:'topnavmenu',plain:!0,showSeparator:!1,shadow:!1,items:[{localized:{text:'G_Support Center'},href:'http://support.multivista.com',hrefTarget:'_blank',handler:'supportCenterHelpClicked'},{localized:{text:'G_Inline Help'},handler:'openInlineHelp'},{localized:{text:'G_Suggest an Idea'},handler:'openSuggestIdeaWindow',hidden:!0,bind:{hidden:'{!account.features.ideasVisible}'}}]},0,['helpmenu'],['component','box','container','panel','menu','helpmenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'helpmenu':!0},['widget.helpmenu'],0,[clientNavigation.view,'HelpMenu'],0);Ext.cmd.derive('clientNavigation.view.fileUploads.FileUploadsButton',Ext.Button,{reference:'fileUploadsButton',ui:'plain',width:0,margin:'3px 0',iconCls:'file-uploads-icon-btn',hidden:!0,handler:'showFileUploads',updateFileUploads:function(c,b,d){var a=c<=0;var e=this.isHidden();if(a!==e){if(!a){this.setHidden(!1)}Ext.create('Ext.fx.Anim',{target:this,duration:750,dynamic:!0,from:{opacity:a?1:0,width:a?46:0},to:{opacity:a?0:1,width:a?0:46},scope:this,callback:function(){if(a){this.setHidden(!0)}}})}this.setIconCls('file-uploads-icon-btn'+(b>0?' upload-animation':'')+(d>0?' upload-error':''))}},0,['fileuploadsbutton'],['component','box','button','fileuploadsbutton'],{'component':!0,'box':!0,'button':!0,'fileuploadsbutton':!0},['widget.fileuploadsbutton'],0,[clientNavigation.view.fileUploads,'FileUploadsButton'],0);Ext.cmd.derive('clientNavigation.view.NavigationBarMegamenu',Ext.menu.Menu,{plain:!0,resetMax:function(){this.setMaxWidth(window.innerWidth-260);this.setMaxHeight(window.innerHeight-140)},layout:{type:'vbox',align:'stretch',reserveScrollbar:!0,manageOverflow:2},maxWidth:window.innerWidth-260,maxHeight:window.innerHeight-140,selectedItemCls:'',hideCollapseTool:!0,scrollable:'y',preventClick:Ext.emptyFn,menuTemplate:['<tpl for=".">','<div class="dropMenuColumnWrap">','<div class="dropMenuColumn">','<p class="dropMenuColumnTitle">{text}</p>','<ul class="dropMenuColumnList">','<tpl for="list">','<li><a href="{url}">{text}</a></li>','</tpl>','</ul>','</div>','</div>','</tpl>'],viewBind:'{floorplans}',renderTo:Ext.getBody(),initComponent:function(){this.items={xtype:'container',items:[{xtype:'dataview',cls:'floorplanMegamenuWrap',bind:this.viewBind,tpl:this.menuTemplate,itemSelector:'.dropMenuColumn'}]};Ext.menu.Menu.prototype.initComponent.apply(this,arguments)},listeners:{click:function(h,g,f){var b=function(c,d){var a=c.get('list');for(var b=0;b<a.length;++I){if(a[b].text==d){return a[b]}}};var a=b(f.record,e.target.innerText);if(!a){console.error('Analytics - no element available');return}var d='Clicked Main Nav Menu Item';var c={'Subsection':a.text,'Navigation Section':'Floorplans'};analytics.Ctrl.log(d,c)}}},0,['floorplanmegamenu'],['component','box','container','panel','menu','floorplanmegamenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'floorplanmegamenu':!0},['widget.floorplanmegamenu'],0,[clientNavigation.view,'NavigationBarMegamenu'],0);Ext.cmd.derive('clientNavigation.view.NavigationBar',clientNavigation.view.AbstractNavigationBar,{defaults:{xtype:'button',height:37,hrefTarget:'',handler:function(b){var a=function(c){var a=c.itemId;switch(c.itemId){case 'dashboardBtn':a='Dashboard';break;case 'photoListBtn':a='Photos';break;case 'floorplanButton':a='Floorplans';break;case 'megaViewerBtn':a='UAV Mapping';break;case 'client3DImmersiveBtn':a='3D Immersive';break;case 'webcamBtn':a='Web Cams';break;case 'fileRepoBtn':a='File Repo';break;case 'videosBtn':a='Videos';break;case 'peopleBtn':a='People';break;case 'externalLinkBtn':a='External Link';break;}return a}}},items:[{itemId:'dashboardBtn',bind:{text:'{navButtonSettings.dashboard.text}',hidden:'{!navButtonSettings.dashboard.visible}',ui:'{navButtonSettings.dashboard.ui}',cls:'{navButtonSettings.dashboard.cls}'}},{itemId:'photoListBtn',bind:{text:'{navButtonSettings.photos.text}',hidden:'{!navButtonSettings.photos.visible}',ui:'{navButtonSettings.photos.ui}',cls:'{navButtonSettings.photos.cls}'}},{itemId:'floorplanButton',bind:{text:'{navButtonSettings.floorplans.text}',hidden:'{!navButtonSettings.floorplans.visible}',ui:'{navButtonSettings.floorplans.ui}',cls:'{navButtonSettings.floorplans.cls}'},menu:{xtype:'floorplanmegamenu'}},{itemId:'megaViewerBtn',bind:{text:'{navButtonSettings.map.text}',hidden:'{!navButtonSettings.map.visible}',ui:'{navButtonSettings.map.ui}',cls:'{navButtonSettings.map.cls}'}},{itemId:'workingPlansButton',bind:{text:'{navButtonSettings.workingplans.text}',href:'{mdslink_clientFloorplanOverview_workingPlans}ProjectUID={ProjectUID}',hidden:'{!navButtonSettings.workingplans.visible}',ui:'{navButtonSettings.workingplans.ui}',cls:'{navButtonSettings.workingplans.cls}'},menu:{xtype:'floorplanmegamenu',viewBind:'{workingPlans}'}},{xtype:'container',reference:'taskListButtonContainer'},{itemId:'client3DImmersiveBtn',bind:{text:'{navButtonSettings.3dimmersive.text}',hidden:'{!navButtonSettings.3dimmersive.visible}',ui:'{navButtonSettings.3dimmersive.ui}',cls:'{navButtonSettings.3dimmersive.cls}'}},{itemId:'webcamBtn',bind:{text:'{navButtonSettings.webcams.text}',hidden:'{!navButtonSettings.webcams.visible}',ui:'{navButtonSettings.webcams.ui}',cls:'{navButtonSettings.webcams.cls}'}},{itemId:'fileRepoBtn',bind:{text:'{navButtonSettings.files.text}',hidden:'{!navButtonSettings.files.visible}',ui:'{navButtonSettings.files.ui}',cls:'{navButtonSettings.files.cls}'}},{itemId:'videosBtn',bind:{text:'{navButtonSettings.videos.text}',hidden:'{!navButtonSettings.videos.visible}',ui:'{navButtonSettings.videos.ui}',cls:'{navButtonSettings.videos.cls}'}},{itemId:'peopleBtn',bind:{text:'{navButtonSettings.people.text}',hidden:'{!navButtonSettings.people.visible}',ui:'{navButtonSettings.people.ui}',cls:'{navButtonSettings.people.cls}'}},{itemId:'externalLinkBtn',reference:'externalLinkButton',bind:{text:'{navButtonSettings.externallink.text}',hidden:'{!navButtonSettings.externallink.visible}',ui:'{navButtonSettings.externallink.ui}',cls:'{navButtonSettings.externallink.cls}'},hrefTarget:null,href:'#'},{xtype:'component',cls:'client-navigation-endcap',width:3,height:'100%'}],listeners:{resize:function(){this.down('#floorplanButton').menu.resetMax();this.down('#workingPlansButton').menu.resetMax()},afterlayout:{fn:function(){this.lookupViewModel().set('mainNavBarReady',!0)},buffer:500}},constructor:function(){clientNavigation.view.AbstractNavigationBar.prototype.constructor.apply(this,arguments);this.initMenu(this.down('#floorplanButton'));this.initMenu(this.down('#workingPlansButton'));var a=this.lookupViewModel().get('ProjectUID');this.down('#dashboardBtn').setHref(mdslink.clientDashboard);this.down('#photoListBtn').setHref(mdslink.clientPhotoList+'ProjectUID='+a);this.down('#floorplanButton').setHref(mdslink.clientFloorplanOverview+'ProjectUID='+a);this.down('#client3DImmersiveBtn').setHref(mdslink.client3DImmersive+'ProjectUID='+a);this.down('#fileRepoBtn').setHref(mdslink.clientFileManager+'ProjectUID='+a);this.down('#webcamBtn').setHref(mdslink.clientWebcamOverview+'ProjectUID='+a);this.down('#peopleBtn').setHref(mdslink.clientPeopleOverview+'ProjectUID='+a);this.down('#workingPlansButton').setHref(mdslink.clientFloorplanOverview_workingPlans+'ProjectUID='+a);this.down('#videosBtn').setHref(mdslink.clientVideo+'ProjectUID='+a);this.down('#megaViewerBtn').setHref(mdslink.clientMegaViewer+'ProjectUID='+a)},initMenu:function(a){var c=new Ext.util.DelayedTask(function(){if(!a.menu.isVisible()){a.showMenu()}},this),b=new Ext.util.DelayedTask(function(){if(a.menu.isVisible()){a.hideMenu()}},this);a.addListener('mouseover',function(){Ext.defer(b.cancel,400,b);c.delay(400)},this);a.addListener('mouseout',function(){b.delay(250);c.cancel()},this);a.menu.addListener('mouseover',function(){b.cancel()},this);a.menu.addListener('mouseleave',function(){b.delay(250)},this)}},1,['navigationbar'],['component','box','container','toolbar','navigationbar'],{'component':!0,'box':!0,'container':!0,'toolbar':!0,'navigationbar':!0},['widget.navigationbar'],0,[clientNavigation.view,'NavigationBar'],0);Ext.cmd.derive('clientNavigation.view.ProjectAdminJump',Ext.form.Panel,{bodyCls:'body',layout:{type:'hbox',align:'middle'},margin:'0 5',items:[{xtype:'button',localized:{text:'G_View'},handler:function(){var b=this;var a=b.up('form').getForm();if(a.isValid()){b.up('projectadminjump').fireEvent('clickv',a.getValues().ProjectID)}else {alert('You must enter a positive integer.')}}},{xtype:'textfield',name:'ProjectID',enableKeyEvents:!0,allowBlank:!1,minLength:1,maxLength:6,width:50,regex:/^[0-9]+$/,listeners:{keyup:function(d,c,e){var b=d;if(c.getKey()==c.ENTER){var a=b.up('form').getForm();if(a.isValid()){b.up('projectadminjump').fireEvent('clicke',a.getValues().ProjectID)}else {alert('You must enter a positive integer.')}}},paste:{element:'inputEl',fn:function(b,a){setTimeout(function(){a.value=a.value.replace(' ','')},50)}}}},{xtype:'button',localized:{text:'G_Edit'},style:{marginLeft:'1px'},handler:function(){var b=this;var a=b.up('form').getForm();if(a.isValid()){b.up('projectadminjump').fireEvent('clicke',a.getValues().ProjectID)}else {alert('You must enter a positive integer.')}}}]},0,['projectadminjump'],['component','box','container','panel','form','projectadminjump'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'projectadminjump':!0},['widget.projectadminjump'],0,[clientNavigation.view,'ProjectAdminJump'],0);Ext.cmd.derive('clientNavigation.view.ProjectBreadcrumb',Ext.view.View,{cls:'navigation-breadcrumb',tpl:['<tpl for=".">','<span class="project-breadcrumb">','<tpl if="xindex !== 1">','<span class="arrow">&nbsp;&gt;&nbsp;</span>','</tpl>','<tpl if="xindex === xcount">','{homepageIcon32}','{display}','<tpl else>','<a href="{url}">{display}</a>','</tpl>','</span>','</tpl>'],itemSelector:'.project-breadcrumb'},0,['projectbreadcrumb'],['component','box','dataview','projectbreadcrumb'],{'component':!0,'box':!0,'dataview':!0,'projectbreadcrumb':!0},['widget.projectbreadcrumb'],0,[clientNavigation.view,'ProjectBreadcrumb'],0);Ext.cmd.derive('clientNavigation.view.ProjectSelectorMenu',Ext.menu.Menu,{cls:'globalProjectSelectorMenuCls',plain:!0,items:[{xtype:'buttongroup',columns:1,items:[]}],preventClick:Ext.emptyFn},0,['projectselectormenu'],['component','box','container','panel','menu','projectselectormenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'projectselectormenu':!0},['widget.projectselectormenu'],0,[clientNavigation.view,'ProjectSelectorMenu'],0);Ext.cmd.derive('clientNavigation.view.ProjectSelector',Ext.Button,{bind:{store:'{projects}',text:'{projectSelectorText}',icon:'{project.ImageURL32}'},margin:'11 24 11 0',cls:'globalProjectSelectorMainButtonCls',maxWidth:350,scale:'large',menu:{xtype:'projectselectormenu'},setStore:function(a){if(!a){return}if(!a.isLoaded()){a.addListener('load',Ext.bind(this.setStore,this,[a]),this,{single:!0});return}var b=a?a.getRange():null,d=this.down('buttongroup');d.removeAll();if(!b||b.length==0){d.add({text:'No Projects',iconAlign:'left',iconCls:'globalProjectSelectorDefaultIconCls',scale:'large',width:250,cls:'globalProjectSelectorButtonCls',disabled:!0,textAlign:'left'})}else {var k=this.down('button'),j=this.up('#topLevelView').getViewModel().get('ProjectUID');for(var e=0,i=b.length;e<i;e++){var c=b[e],f=c.get('ProjectUID'),g=c.get('projectTitle'),h=c.get('image32URL');d.add({text:g,icon:h,iconAlign:'left',iconCls:'globalProjectSelectorDefaultIconCls',scale:'large',width:250,cls:'globalProjectSelectorButtonCls',href:mdslink.projectGateway+'ProjectUID='+f,hrefTarget:'',textAlign:'left',handler:function(b,c,d){analytics.Ctrl.log('Select A Project (global control)',{'Project UID':b.get('ProjectUID'),'Project Name':b.get('projectTitle')})}.bind(this,c)})}}}},0,['projectselector'],['component','box','button','projectselector'],{'component':!0,'box':!0,'button':!0,'projectselector':!0},['widget.projectselector'],0,[clientNavigation.view,'ProjectSelector'],0);Ext.cmd.derive('clientNavigation.view.ProjectTagSearchJump',Ext.form.Panel,{bodyCls:'body',layout:{type:'hbox',align:'middle'},items:[{xtype:'textfield',name:'SearchString',localized:{emptyText:'MN_Search Keywords'},enableKeyEvents:!0,allowBlank:!1,minLength:1,maxLength:30,width:120,value:Ext.Object.fromQueryString(document.location.search).SearchString,listeners:{keyup:function(d,c,e){var a=d;if(c.getKey()==c.ENTER){var b=a.up('form').getForm();if(b.isValid()){a.enableBubble('clicksearch');a.fireEvent('clicksearch',b.getValues().SearchString)}}}}},{xtype:'button',icon:'mds/image/icon/search.png',handler:function(){var a=this;var b=a.up('form').getForm();if(b.isValid()){a.enableBubble('clicksearch');a.fireEvent('clicksearch',b.getValues().SearchString)}}}]},0,['projectagsearchjump'],['component','box','container','panel','form','projectagsearchjump'],{'component':!0,'box':!0,'container':!0,'panel':!0,'form':!0,'projectagsearchjump':!0},['widget.projectagsearchjump'],0,[clientNavigation.view,'ProjectTagSearchJump'],0);Ext.cmd.derive('clientNavigation.view.fileUploads.FileUploadsView',Ext.view.View,{cls:'file-uploads-view',tpl:new Ext.XTemplate('<tpl for=".">','<div class="file-uploads-item" id="fileUploadItem_{id}">','<div class="file-upload-img {imageCss}" style="{imageStyle}"></div>','<div class="file-upload-name {buttonCss}">{name}</div>','<div class="file-upload-status {buttonCss}" {titleAttr}>{statusLabel}</div>','<span class="file-upload-btn {buttonCss}">{buttonLabel}</span>','<span class="file-upload-btn {removeCss}" title="Remove">X</span>','</div>','</tpl>'),itemSelector:'div.file-uploads-item',emptyText:'',store:'fileUploads',loadMask:!1,listeners:{itemclick:function(c,b,a,e,d){c.handleItemClick(b,d.target,a)},itemremove:function(c,d,b,a){this.removeAllStatusAnimations(a)},refresh:function(a){this.removeAllStatusAnimations(a);if(a.store){a.store.each(function(b){if(b.get('status')==='processing'){this.animateItemStatus(a,b)}},this)}}},handleItemClick:function(d,a,e){var b=a?a.getAttribute('class'):'';if(b.indexOf('file-upload-btn')!==-1&&b.indexOf('disabled')===-1){var c=null;if(b.indexOf('retry')!==-1){c='retryBackgroundProcess'}else {if(b.indexOf('cancel')!==-1){c='cancelBackgroundProcess'}else {if(b.indexOf('remove')!==-1){c='removeBackgroundProcess';this.animateRemoveItem(d,e)}}}if(c){Ext.Ajax.request({url:'/index.cfm?fuseaction=aClientNavigation.'+c+'&id='+d.id,noAlert:!0,successCallback:function(b){app.fireEvent('reloadfileuploads')}});a.setAttribute('class',b+' disabled');if(b.indexOf('withRetry')!==-1&&a.querySelector&&a.classList){a.parentNode.querySelector('.file-upload-btn.retry').classList.add('disabled')}else {if(b.indexOf('withRemove')!==-1&&a.querySelector&&a.classList){a.parentNode.querySelector('.file-upload-btn.remove').classList.add('disabled')}}}}},animateRemoveItem:function(a,b){Ext.create('Ext.fx.Anim',{target:b,duration:750,dynamic:!0,to:{height:0,opacity:0},callback:function(){if(a.store){a.store.remove(a)}}})},removeAllStatusAnimations:function(a){if(a.statusAnimationItems){a.oldStatusAnimationItems={};for(var c=0;c<a.statusAnimationItems.length;c++){var b=a.statusAnimationItems[c];clearInterval(b.intervalId);delete b.node;a.oldStatusAnimationItems[''+b.id]=b}delete a.statusAnimationItems}},animateItemStatus:function(b,d){var e=d.get('statusLabel').replace('...','');var c=b.getNode(d);if(c){c=Ext.dom.Query.selectNode('.file-upload-status',c)}if(c){if(!b.statusAnimationItems){b.statusAnimationItems=[]}var a=null;if(b.oldStatusAnimationItems&&b.oldStatusAnimationItems.hasOwnProperty(''+d.id)){a=b.oldStatusAnimationItems[''+d.id];a.node=c;a.label=e;a.updateDots()}else {a={id:d.id,intervalId:0,count:0,label:e,node:c,updateDots:function(){this.count=(this.count+1)%4;var a='';for(var c=0;c<this.count%4;c++){a+='.'}if(this.node&&this.node.parentNode){this.node.innerHTML=this.label+a}else {clearInterval(this.intervalId);delete this.node}}}}a.intervalId=setInterval(a.updateDots.bind(a),400);b.statusAnimationItems.push(a)}}},0,['fileuploadsview'],['component','box','dataview','fileuploadsview'],{'component':!0,'box':!0,'dataview':!0,'fileuploadsview':!0},['widget.fileuploadsview'],0,[clientNavigation.view.fileUploads,'FileUploadsView'],0);Ext.cmd.derive('clientNavigation.view.fileUploads.FileUploadsMenu',Ext.menu.Menu,{reference:'fileUploadsMenu',ui:'topnavmenu',plain:!0,showSeparator:!1,shadow:!1,width:355,items:[{xtype:'component',html:'Active Uploads<a class="file-clear-uploads-link">Clear</a>',cls:'file-active-uploads-label',listeners:{render:function(){var a=this.getEl().child('a');a.on('click',function(){Ext.Ajax.request({url:mdslink.server+'/index.cfm?fuseaction=aClientNavigation.clearCompletedBackgroundProcesses',successCallback:function(a){b.reload()}})});var c=function(c){var b=c.findExact('status','completed');if(b===-1){a.removeCls('shown')}else {a.addCls('shown')}};var b=Ext.getStore('fileUploads');b.on('load',c);c(b)}}},{xtype:'fileuploadsview',scrollable:'y',maxHeight:285}]},0,['fileuploadsmenu'],['component','box','container','panel','menu','fileuploadsmenu'],{'component':!0,'box':!0,'container':!0,'panel':!0,'menu':!0,'fileuploadsmenu':!0},['widget.fileuploadsmenu'],0,[clientNavigation.view.fileUploads,'FileUploadsMenu'],0);Ext.cmd.derive('clientNavigation.view.SuggestIdeaWindow',Ext.window.Window,{width:428,height:495,title:'Suggest an Idea',plain:!0,layout:'fit',ui:'suggestideawindow',border:!1,bodyBorder:!1,items:[{xtype:'form',fieldDefaults:{width:368,labelAlign:'top',labelSeparator:'',labelPad:7,labelClsExtra:'label-plain'},layout:{type:'vbox',align:'stretch'},bodyPadding:20,border:!1,items:[{xtype:'textfield',fieldLabel:'Idea Title',ui:'detail-form',itemId:'ideaTitle',allowBlank:!1,minLength:2},{xtype:'combobox',fieldLabel:'Category',ui:'detail-form',itemId:'ideaCategory',displayField:'categoryName',valueField:'categoryName',queryMode:'local',forceSelection:!0,emptyText:'Select a category',allowBlank:!1,cls:'suggest-idea-field-pad',store:Ext.create('Ext.data.Store',{idProperty:'categoryName',data:[{categoryName:'Photographic Documentation'},{categoryName:'Webcams'},{categoryName:'Owner Equipment Training Videos'},{categoryName:'UAV \u2013 Drone Services'},{categoryName:'UAV \u2013 Mapping'},{categoryName:'Immersive & 3D'},{categoryName:'Task Manager'},{categoryName:'Field Services & Operations'},{categoryName:'Other'}]})},{xtype:'textarea',fieldLabel:'Idea Details',ui:'detail-form',itemId:'ideaDetails',cls:'suggest-idea-field-pad',flex:1}]}],dockedItems:{xtype:'toolbar',dock:'bottom',ui:'footer',height:68,layout:{type:'hbox',align:'middle',pack:'center'},items:[{text:'Cancel',ui:'grey',scale:'medium',minWidth:70,handler:function(){this.up('window').close()}},{xtype:'tbspacer',width:5},{xtype:'savebutton',text:'Submit Idea',ui:'green',width:110,scale:'medium',listeners:{click:function(b){var a=this.up('window');var f=a.down('form');if(f.isValid()){b.setDisabled(!0);b.setDone(!1);b.setProcessing(!0);var e=a.down('#ideaTitle').getValue().trim();var c=a.down('#ideaCategory').getValue();var d=a.down('#ideaDetails').getValue().trim();a.fireEvent('submitidea',e,c,d,function(c){b.setProcessing(!1);if(c){b.setDone(!0);setTimeout(function(){a.close();Ext.create('clientNavigation.view.SuggestIdeaThanksWindow').show()},250)}else {b.setDisabled(!1)}})}}}}]}},0,0,['component','box','container','panel','window'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0},0,0,[clientNavigation.view,'SuggestIdeaWindow'],0);Ext.cmd.derive('clientNavigation.view.SuggestIdeaThanksWindow',Ext.window.Window,{width:350,height:180,title:'Suggest an Idea',plain:!0,layout:'fit',ui:'suggestideawindow',border:!1,bodyBorder:!1,items:[{xtype:'component',html:'Thanks for submitting your idea!',cls:'suggest-idea-thanks',flex:1}],dockedItems:{xtype:'toolbar',dock:'bottom',ui:'footer',height:58,layout:{type:'hbox',align:'middle',pack:'center'},items:[{xtype:'button',text:'Done',ui:'green',width:'80px',scale:'medium',listeners:{click:function(a){this.up('window').close()}}}]}},0,0,['component','box','container','panel','window'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0},0,0,[clientNavigation.view,'SuggestIdeaThanksWindow'],0);Ext.cmd.derive('clientNavigation.view.companyandrole.CompanyAndRoleModel',Ext.app.ViewModel,{data:{User:null,saving:!1,saveDone:!1},stores:{memberCompanies:{proxy:{api:{read:'/index.cfm?fuseaction=aMember.getMemberMemberCompanyNames'}},autoLoad:!1}}},0,0,0,0,['viewmodel.companyandrole'],0,[clientNavigation.view.companyandrole,'CompanyAndRoleModel'],0);Ext.cmd.derive('clientNavigation.view.companyandrole.CompanyAndRoleController',Ext.app.ViewController,{init:function(){var d=this.getView(),c=d.getProjectRoleID(),b=d.getMemberCompanyName(),a={};if(c){a.ProjectRoleID=c}if(b){a.MemberCompanyName=b}a.MemberUID=this.getViewModel().get('account.MemberUID');a.id=a.MemberUID;this.getViewModel().set('User',Ext.create('accountShared.model.Member',a))},save:function(){this.getView().mask();var a=this.getViewModel();a.set('saving',!0);a.set('Member');a.get('User').set('MemberCompanyConfirmed',1);a.get('User').save({success:function(){a.set('saveDone',!0);Ext.defer(function(){var a=this.getView();if(a){a.destroy()}},1000,this)},scope:this})}},0,0,0,0,['controller.companyandrole'],0,[clientNavigation.view.companyandrole,'CompanyAndRoleController'],0);Ext.cmd.derive('clientNavigation.view.companyandrole.CompanyAndRole',Ext.window.Window,{viewModel:{type:'companyandrole'},controller:'companyandrole',config:{ProjectRoleID:null,MemberCompanyName:null},alwaysOnTop:3,modal:!0,ui:'orange',cls:'unsaved',localized:{title:'PU_Update Your Informati'},layout:'fit',items:[{xtype:'form',ui:'detail-form',layout:{type:'vbox',align:'stretch'},width:488,padding:26,items:[{xtype:'component',cls:'instructions',margin:'0 0 30 0',localized:{html:'PU_We are adding Company'}},{xtype:'membercompany',bind:{value:'{User.MemberCompanyName}',store:'{memberCompanies}'},width:440},{xtype:'projectrole',showRequiredText:!0,margin:'0 0 70 0',width:440,bind:{value:'{User.ProjectRoleID}'}},{xtype:'container',dock:'bottom',layout:{type:'hbox',pack:'center'},items:[{xtype:'button',scale:'medium',ui:'grey',localized:{text:'G_Cancel'},margin:'0 12 0 12',listeners:{click:function(){this.up('window').destroy()}}},{xtype:'savebutton',reference:'saveButton',localized:{text:'G_Save'},bind:{processing:'{saving}',done:'{saveDone}',disabled:'{!User.ProjectRoleID}'},margin:'0 12 0 12',listeners:{click:'save'}}]}]}]},0,['companyandrole'],['component','box','container','panel','window','companyandrole'],{'component':!0,'box':!0,'container':!0,'panel':!0,'window':!0,'companyandrole':!0},['widget.companyandrole'],0,[clientNavigation.view.companyandrole,'CompanyAndRole'],0);Ext.cmd.derive('clientNavigation.view.SharedViewController',Ext.app.ViewController,{init:function(){this.getViewModel().bind('{account.aconexEnabled}',this.aconexChanged,this);this.getViewModel().bind('{account.planGridEnabled}',this.plangridChanged,this);this.getViewModel().bind('{account.procoreEnabled}',this.procoreChanged,this);this.getViewModel().bind('{account.bim360Enabled}',this.bim360Changed,this);this.getViewModel().bind('{account.bluebeamEnabled}',this.bluebeamChanged,this);this.getViewModel().bind({permissionsLoaded:'{projectAccountLoaded}',globalAccountLoaded:'{globalAccountLoaded}'},function(a){if(a.permissionsLoaded&&a.globalAccountLoaded){this.onAccountAndPermissionsReady()}},this);return Ext.app.ViewController.prototype.init.apply(this,arguments)},aconexChanged:function(a){this.accountFeatureChanged('aconexEnabled',a)},plangridChanged:function(a){this.accountFeatureChanged('planGridEnabled',a)},procoreChanged:function(a){this.accountFeatureChanged('procoreEnabled',a)},bim360Changed:function(a){this.accountFeatureChanged('bim360Enabled',a)},bluebeamChanged:function(a){this.accountFeatureChanged('bluebeamEnabled',a)},accountFeatureChanged:function(b,c){console.log('Account feature changed',arguments);if(window.localStorage.getItem('Multivista_ClientSession')){var a=JSON.parse(window.localStorage.getItem('Multivista_ClientSession'));a.account[b]=c;window.localStorage.setItem('Multivista_ClientSession',JSON.stringify(a))}},loadAccount:function(){var b=this;var c=b.getViewModel(),a={};a.IsPublic=0;a.MemberRole='superadmin';a.MemberUsername='Client';a.MemberFirstName='Client';a.MemberLastName='User';a.MemberUID=0;a.MeasurePreferenceID=1;a.canShare=!1;a.procoreEnabled=!1;a.aconexEnabled=!1;a.planGridEnabled=!1;a.bim360Enabled=!1;a.bluebeamEnabled=!1;a.features={'pushpinalbumfollowVisible':!0,'megaviewerfloorplanoverlaysVisible':!0,'photoviewerHasOptOut':0,'plangridVisible':!0,'clientUserAddVisible':!1,'ideasVisible':!0,'webrtcVisible':!0,'commentmentionsVisible':!0,'userDetailsPromptVisible':!0,'bluebeamVisible':!0,'amplitudeVisible':!1,'procoreVisible':!0,'uploadscenterVisible':!0,'badgesVisible':!0,'photos360Visible':!0,'photoviewerVisible':!0,'integrationsVisible':!0,'photolistVisible':!0,'bim360Visible':!0,'aconexVisible':!0};a.newFeatureNotifications=[];a.sessionDataID=0;a.ampProfile={};a.subDomains=[];c.set('account',a);c.set('globalAccountLoaded',!0);return;if(window.localStorage.getItem('Multivista_ClientSession')){var d=JSON.parse(window.localStorage.getItem('Multivista_ClientSession'));var c=b.getViewModel();var a=d.account;var e=d.greeting;c.set('account',a);c.get('greetings').loadData(e);if(b.htmlHelpHelper.greetingId!=0){Ext.Ajax.request({url:'/index.cfm',params:{fuseaction:'aClientNavigation.updateGreeting',GreetingID:b.htmlHelpHelper.greetingId},method:'GET'})}c.set('globalAccountLoaded',!0);b.notifyNewFeatures(a.newFeatureNotifications);if(a.features.uploadscenterVisible){b.initFileUploads()}}else {mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientNavigation.getGlobalMyAccount',successCallback:function(c){var d=b.getViewModel(),f=d.get('account'),a={};Ext.Object.merge(a,f);a.IsPublic=c[0].IsPublic;a.MemberRole=c[0].MemberRole;a.MemberUsername=c[0].MemberUsername;a.MemberFirstName=c[0].MemberFirstName;a.MemberLastName=c[0].MemberLastName;a.MemberUID=c[0].MemberUID;a.MeasurePreferenceID=c[0].MeasurePreferenceID;a.canShare=c[0].canShare;a.procoreEnabled=c[0].procoreEnabled;a.aconexEnabled=c[0].aconexEnabled;a.planGridEnabled=c[0].planGridEnabled;a.bim360Enabled=c[0].bim360Enabled;a.bluebeamEnabled=c[0].bluebeamEnabled;a.features=c[0].features;a.newFeatureNotifications=c[0].newFeatureNotifications;a.sessionDataID=c[0].sessionDataID;a.ampProfile=c[0].ampProfile;a.subDomains=c[0].memberRealms;if(a.subDomains.length>1){a.hasSubdomains=!0}d.set('account',a);var e={account:a,greeting:c[0].Greeting};window.localStorage.setItem('Multivista_ClientSession',JSON.stringify(e));d.get('greetings').loadData(c[0].Greeting);if(b.htmlHelpHelper.greetingId!=0){Ext.Ajax.request({url:'/index.cfm',params:{fuseaction:'aClientNavigation.updateGreeting',GreetingID:b.htmlHelpHelper.greetingId},method:'GET'})}d.set('globalAccountLoaded',!0);b.notifyNewFeatures(a.newFeatureNotifications);if(a.features.uploadscenterVisible){b.initFileUploads()}if(c[0].showUpdateDetailsPrompt){b.promptForCompanyAndRole(c[0].MemberCompanyName,c[0].ProjectRoleID)}},scope:b})}},loadMainProjectData:function(b){var d=this;var a=this.getViewModel(),c=a.get('ProjectUID');mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientPhotoViewer.getProject&ProjectUID='+c,successCallback:function(c){var d={};if(c){if(c[0].projectTitle){a.set('project.ProjectTitle',c[0].projectTitle)}if(c[0].projectAddress){a.set('project.ProjectAddress',c[0].projectAddress)}a.set('project.CompanyUID',c[0].CompanyUID);a.set('project.CompanyName',c[0].projectCompany);if(c[0].projectTitle){d.projectTitle=c[0].projectTitle}if(c[0].territory){d.projectTerritory=c[0].territory}if(c[0].ampProject){d.ampProject=c[0].ampProject}if(c[0].commentMentionsEnabled){a.set('project.commentMentionsEnabled',c[0].commentMentionsEnabled)}if(c[0].pushpinAlbumFollowEnabled){a.set('project.pushpinAlbumFollowEnabled',c[0].pushpinAlbumFollowEnabled)}if(c[0].isPhotos360Enabled){a.set('project.isPhotos360Enabled',c[0].isPhotos360Enabled)}a.set('project.ampProject',d);a.set('project.ImageURL32',c[0].projectImg32?c[0].projectImg32:'mds/image/project_icon32.jpg');a.set('project.ImageURL64',c[0].projectImg?c[0].projectImg:'mds/image/project_icon64.jpg')}if(b){b()}},scope:d})},initHelp:function(){this.htmlHelpHelper=null},onProjectAdminEdit:function(a){window.location.href=mdslink.projectEditJump+'ProjectID='+a},onProjectAdminView:function(a){window.location.href=mdslink.projectView+'ProjectID='+a},onProjectTagSearch:function(a){var b=this.getViewModel().get('ProjectUID');window.location.href=mdslink.clientTagSearch+'ProjectUID='+b+'&SearchString='+a},onProjectsLoad:Ext.emptyFn,onBeforeProjectsLoad:Ext.emptyFn,initFileUploads:function(){},pollFileUploads:function(c){var b=this.lookup('fileUploadsButton');if(!b){console.log('File uploads UI unavailable on this page');return}var a=this.getStore('fileUploads');if(a.pollTimeoutId){clearTimeout(a.pollTimeoutId)}a.pollTimeoutId=Ext.defer(function(){a.load({scope:this,callback:function(a,l,j){var i=30000;var d=0;var f=0;var g=0;if(j&&a.length>0){d=a.length;i=15000;for(var e=0;e<a.length;e++){var k=a[e];var h=k.get('status');if(h==='processing'){f++}else {if(h==='error'){g++}}}}b.updateFileUploads(d,f,g);if(d===0&&this.uploadsMenu&&this.uploadsMenu.isVisible()){this.uploadsMenu.hide()}this.pollFileUploads(i)}})},c,this)},showFileUploads:function(b,a){if(!this.uploadsMenu){this.uploadsMenu=this.getView().add(Ext.create('clientNavigation.view.fileUploads.FileUploadsMenu'))}this.showTopNavMenu(this.uploadsMenu,b,[3,-2]);if(a&&a.ctrlKey){}},showHelp:function(a){if(!this.helpMenu){this.helpMenu=this.getView().add(Ext.create('clientNavigation.view.HelpMenu'))}this.showTopNavMenu(this.helpMenu,a);if(this.newFeaturePopupWindow){this.newFeaturePopupWindow.close()}},showTopNavMenu:function(b,c,a){if(b.skipNextShowEvent){delete b.skipNextShowEvent;return}if(!a){a=[10,-5]}if(location.href.toLowerCase().indexOf('clientdashboard')!=-1){a[1]-=15}b.showBy(c,'tr-br',a);if(c.el){c.el.on('mousedown',function(){var d=this;if(d.isVisible()){d.skipNextShowEvent=!0}},b,{single:!0})}},onUserClick:function(d){if(!this.accountMenu){this.accountMenu=Ext.create('clientNavigation.view.GlobalMyAccountMenu');var a=d.account;if(a&&a.hasSubdomains){var c=a.subDomains;var g=Ext.create('Ext.menu.Separator',{text:'Switch subdomains'});this.accountMenu.add(g);for(var b=0;b<c.length;b++){var e=c[b];var f=Ext.create('Ext.menu.Item',{text:e.RealmName,href:'?fuseaction=aAuthentication.realmRelocate&realmID='+e.RealmID,hrefTarget:'_blank'});this.accountMenu.add(f)}}}this.showTopNavMenu(this.accountMenu,d,[5,-5])},logHelpClick:function(a){var c='Clicked Help Button';var b={'Help':a}},openInlineHelp:function(){this.logHelpClick('Inline Help');this.htmlHelpHelper.handleHtmlHelpHelper()},supportCenterHelpClicked:function(){this.logHelpClick('Support Center')},openSuggestIdeaWindow:function(){if(this.suggestIdeaWindow!=null){return}this.logHelpClick('Suggest Idea');var a=Ext.create('clientNavigation.view.SuggestIdeaWindow');a.show();a.on('submitidea',this.submitIdeaHandler,this);a.on('close',function(){delete this.suggestIdeaWindow},this);this.suggestIdeaWindow=a},notifyNewFeatures:function(newFeatures){if(!newFeatures){return}var vm=this.getViewModel(),projectUID=vm.get('ProjectUID');if(projectUID&&!vm.get('readyToShowNotificationPopup')){vm.bind('{readyToShowNotificationPopup}',function(a){if(a){Ext.defer(function(){this.notifyNewFeatures(newFeatures)},1,this)}},this);return}for(var i=0;i<newFeatures.length;i++){var feature=newFeatures[i],classPath='clientHelp.view.newfeatures.'+feature;var featureClass=eval(classPath);if(!featureClass){continue}if(!featureClass.isVisibleNotification||featureClass.isVisibleNotification(vm.get('account'))){Ext.create(classPath,{parentView:this.getView()});return}}},submitIdeaHandler:function(e,b,d,a){var c=function(){var g=encodeURIComponent('Idea submission - Category '+b);var c='Title = '+e+'\nCategory = '+b+'\nDetails = '+d;c=encodeURIComponent(c);if(c.length>256){c=c.substr(0,252)+'...'}var f='ideas@multivista.com?subject='+g+'&body='+c;Ext.Msg.error('There was an error submitting your idea.<br>Please email <a href="mailto:'+f+'">ideas@multivista.com</a> with your idea.<br>Sorry for the inconvenience.')};mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientNavigation.submitIdea',method:'POST',scope:this,jsonData:{title:e,category:b,details:d},success:function(g){var f=JSON.parse(g.responseText);if(f.success){a(!0)}else {console.log('Error submitting idea',f.message);c();a(!1)}},failure:function(f){console.error('Failed to submit idea',f);c();a(!1)}})},loadPermissions:function(b){var a=this.getViewModel(),c=a.get('ProjectUID');mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aPermission.getUserPermissions&ProjectUID='+c,successCallback:function(c){var f=c.comment.read,e=c.comment['write'],d=c.userCanShare;a.set('account.canShare',d);a.set('account.canRead',f);a.set('account.canWrite',e);a.set('account.canViewArchive',c.userHasArchivePermission);a.set('account.canViewLivestream',c.userHasLivestreamPermission);a.set('account.canViewTimelapse',c.userHasTimelapsePermission);a.set('account.canUsePTZ',c.userHasPTZPermission);a.set('account.canEditPTZ',c.userHasPTZPresetPermission);a.set('account.TaskListItemStatusPermission',c.TaskListItemStatusPermission);a.set('permissionsLoaded',!0);if(b){b(f,e,d)}}})},promptForCompanyAndRole:function(a,b){this.getView().add({xtype:'companyandrole',MemberCompanyName:a,ProjectRoleID:b}).show()},onAccountAndPermissionsReady:function(){if(this.htmlHelpHelper){var a=JSON.parse(window.localStorage.getItem('Multivista_ClientSession'));this.htmlHelpHelper.account=this.getViewModel().get('account');this.htmlHelpHelper.handleGreetings(a.greeting)}}},0,0,0,0,['controller.sharedviewcontroller'],0,[clientNavigation.view,'SharedViewController'],0);Ext.cmd.derive('clientNavigation.view.ProjectViewModel',Ext.app.ViewModel,{data:{ProjectUID:'',project:{ProjectTitle:'',ProjectAddress:'',ImageURL32:'',ImageURL64:'',ampProject:{},commentMentionsEnabled:!1,pushpinAlbumFollowEnabled:!1},permissionsLoaded:!1,private_ShareTypeID:null,private_ShareMemberUIDList:null},formulas:{preferencesReady:function(c){var b=c('ProjectUID'),a=c('account.MemberUID');if(!b||!a){return !1}mdsPreferences.ProjectPreferences.setIdentification(b,a);mdsPreferences.MemberPreferences.setIdentification(a);return !0},selectedShareTypeID:{get:function(b){var a=b('private_ShareTypeID');if(a!==null){return a}if(!b('preferencesReady')){return null}a=mdsPreferences.ProjectPreferences.getShareTypeID();return a?a:b('account.canShare')?1:2},set:function(a){this.set('private_ShareTypeID',a);mdsPreferences.ProjectPreferences.setShareTypeID(a)}},selectedShareMemberUIDList:{get:function(c){var a=c('private_ShareMemberUIDList'),g=c('people'),f=c('_peopleLoaded');if(a===null){if(!c('preferencesReady')){return null}a=mdsPreferences.ProjectPreferences.getShareMembersList()}if(f){var b=a?a.split(','):[],e=[];for(var d=0;d<b.length;d++){if(g.getById(b[d])){e.push(b[d])}}a=e.join(',');if(b.length!=e.length){this.set('private_ShareMemberUIDList',a);mdsPreferences.ProjectPreferences.setShareMembersList(a)}}return a?a:''},set:function(a){this.set('private_ShareMemberUIDList',a);mdsPreferences.ProjectPreferences.setShareMembersList(a)}}},stores:{listsAndReports:{type:'listreports',proxy:{extraParams:{ProjectUID:'{ProjectUID}'}},autoLoad:!1,mvAutoLoadVars:!1},people:{model:'clientNavigation.model.Member',proxy:{type:'jsonp',url:'index.cfm?fuseaction=aClientPeopleOverview.getPeopleBasic'},autoLoad:!1,mvAutoLoadVars:!1}}},0,0,0,0,['viewmodel.projectviewmodel'],0,[clientNavigation.view,'ProjectViewModel'],0);Ext.cmd.derive('clientNavigation.view.ProjectWrapper',Ext.Container,{controller:'sharedviewcontroller',viewModel:{type:'projectviewmodel'},floating:!0,shadow:!1,width:'100%',height:'100%',initWrapper:function(a){var b=this.getViewModel().bind({permissionsLoaded:'{permissionsLoaded}',projectTitle:'{project.ProjectTitle}'},function(c){if(c.permissionsLoaded&&c.projectTitle){if(a){a()}b.destroy()}});this.getController().loadPermissions();this.getController().loadMainProjectData()}},0,['projectwrapper'],['component','box','container','projectwrapper'],{'component':!0,'box':!0,'container':!0,'projectwrapper':!0},['widget.projectwrapper'],0,[clientNavigation.view,'ProjectWrapper'],0);Ext.cmd.derive('clientNavigation.view.Navigation',Ext.container.Container,{layout:{type:'vbox',align:'stretch'},height:97,scrollable:!1,items:[{xtype:'container',layout:{type:'hbox',align:'middle'},width:'100%',items:[{xtype:'button',cls:'global-home',hrefTarget:'',width:230,height:60,ui:'plain',bind:{href:'{mdslink_home}'},listeners:{click:function(){analytics.Ctrl.log('Clicked MV Logo',{})}}},{xtype:'projectbreadcrumb',bind:'{breadcrumbs}'},{xtype:'component',bind:{html:'{logoHtml}'},margin:'0 20 0 0'},{xtype:'component',flex:1}]},{xtype:'navigationbar'}]},0,['clientnavigation'],['component','box','container','clientnavigation'],{'component':!0,'box':!0,'container':!0,'clientnavigation':!0},['widget.clientnavigation'],0,[clientNavigation.view,'Navigation'],0);Ext.cmd.derive('clientNavigation.view.SharedViewModel',clientNavigation.view.ProjectViewModel,{data:{globalAccountLoaded:!1,mainNavBarReady:!0,navSettings:{companyLogoURL:''},navButtonSettings:{dashboard:{visible:!1,ui:'client-navigation'},photos:{visible:!1},floorplans:{visible:!1},files:{visible:!1},webcams:{visible:!1},videos:{visible:!1},people:{visible:!1},externallink:{text:'',visible:!1},'3dimmersive':{text:'3D Immersive',visible:!1},projectedit:{visible:!1},workingplans:{visible:!1},'map':{visible:!1}}},formulas:{isStaff:function(b){var a=b('account.MemberRole');return !!(a&&a!='client')},projectSelectorText:function(b){var a=b('project.ProjectTitle');return a?a:mvstr['G_Select A Project']},globalPreferencesReady:function(b){var a=b('account.MemberUID');if(!a){return !1}mdsPreferences.MemberPreferences.setIdentification(a);return !0},readyToShowNotificationPopup:function(a){return a('projectAccountLoaded')&&a('mainNavBarReady')}},stores:{projects:{extend:'Ext.data.Store',model:'sharedLookup.model.ProjectSelector',storeId:'projects',proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'index.cfm?fuseaction=aClientNavigation.ProjectNavigation'},sorters:[{property:'projectTitle',direction:'ASC'}],autoLoad:!1,listeners:{load:'onProjectsLoad',beforeload:'onBeforeProjectsLoad'}},greetings:{fields:[{name:'GreetingID',type:'int'},{name:'Name',type:'string'},{name:'seen',type:'boolean',defaultValue:!1}]},fileUploads:{storeId:'fileUploads',model:'clientNavigation.model.FileUpload',proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'index.cfm?fuseaction=aClientNavigation.getBackgroundProcesses'},autoLoad:!1}}},0,0,0,0,0,0,[clientNavigation.view,'SharedViewModel'],0);Ext.cmd.derive('clientNavigation.view.clientViewport.ClientViewportController',clientNavigation.view.SharedViewController,{init:function(){var a=this;var c=a.getViewModel(),b=c.get('ProjectUID');a.initHelp();a.loadAccount();mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientNavigation.getNavigationPreference4Project&ProjectUID='+b,successCallback:function(d){if(!d.length){d=[d]}var c=a.getViewModel();c.set('navSettings',{companyLogoURL:d[0].companyLogoURL,projectLogoURL:d[0].projectLogoURL});c.set('account.canRead',1);c.set('account.canWrite',0);c.set('account.JoinedWithAddUserPermission',0);c.set('account.MultivistaContentPermission',0);var m=c.get('navButtonSettings');var j=d[0].navigationBar4Project;var i=a.getPageAlias();for(var f=0;f<j.length;f++){var e='client-navigation';var k='';var b=j[f];if(b.alias.substr(0,9)=='tasklist-'){var h=b.alias.split('-')[1],l=Ext.Object.fromQueryString(document.location.search).ListTypeID;a.lookupReference('taskListButtonContainer').add({xtype:'button',ui:e,localized:{text:'MN_'+b.DisplayLabel},height:37,hrefTarget:'',bind:{href:'{mdslink_clientPunchlistOverview_Base}ProjectUID={ProjectUID}&ListTypeID='+h},cls:i=='punchlist'&&l==h?'client-navigation-current-button':undefined});continue}if(i==b.alias){k='client-navigation-current-button'}if(b.alias=='externallink'){if(b.CSSClass){e=b.CSSClass}c.set('navButtonSettings.'+b.alias+'.href',b.LinkURL);var g=a.lookupReference('externalLinkButton');g.el.dom.target=b.NewWindow==1?'_blank':'_self';g.setHref(b.LinkURL)}if(mvstr['MN_'+b.alias]){c.set('navButtonSettings.'+b.alias+'.text',mvstr['MN_'+b.alias])}c.set('navButtonSettings.'+b.alias+'.ui',e);c.set('navButtonSettings.'+b.alias+'.cls',k);if(b.DisplayLabel){c.set('navButtonSettings.'+b.alias+'.text',b.DisplayLabel)}c.set('navButtonSettings.'+b.alias+'.visible',b.visible)}c.set('projectAccountLoaded',!0)},scope:a});a.loadMainProjectData();return a.callParent(arguments)},getPage:function(){return this.getView().down('#activePage')},getPageName:function(){var a=this.getPage().xtype,b=Ext.Object.fromQueryString(document.location.search);if(a=='clientFloorplanOverview'&&b.ListTypeID){return 'clientFloorplanOverview_punchlistPlans'}return a},getPageAlias:function(){return {clientPhotoList:'photos',clientFloorplanOverview:'floorplans',clientFileManager:'files',clientWebcamOverview:'webcams',client3DImmersive:'3dimmersive',clientVideo:'videos'}[this.getPageName()]},listeners:{updateProjectPreference:function(){var a=this;var b=Ext.Object.fromQueryString(document.location.search);if(a.htmlHelpHelper.greetingIdProjectPreference!=0){mdsAjax.doAjaxRequest({url:'index.cfm?fuseaction=aClientNavigation.updateGreeting&GreetingID='+a.htmlHelpHelper.greetingIdProjectPreference+'&projectpreference='+a.htmlHelpHelper.projectpreference,method:'GET',success:function(c){if(a.htmlHelpHelper.projectpreference=='photos'&&b.fuseaction=='aClientFloorplanOverview.home'||a.htmlHelpHelper.projectpreference=='floorplans'&&b.fuseaction=='aClientPhotoList.home'){window.location.href='/index.cfm?fuseaction=aClientNavigation.ProjectGateway&ProjectUID='+b.ProjectUID}}})}}}},0,0,0,0,['controller.clientNavigation'],0,[clientNavigation.view.clientViewport,'ClientViewportController'],0);Ext.cmd.derive('clientNavigation.view.clientViewport.ClientViewportModel',clientNavigation.view.SharedViewModel,{data:{validatedCompanyLogo:'',validatedProjectLogo:'',validatedProjectLogo:!1,mainNavBarReady:!1},stores:{breadcrumbs:{fields:[{name:'display',type:'string',convert:function(a){return '&nbsp;'+a}},{name:'homepageIcon32',type:'string',convert:function(a){return '<img src="'+a+'" style="vertical-align:middle" width="32" height="32" border="1">'}},{name:'url',type:'string',convert:function(d){var a={url:d};var c=Ext.Object.fromQueryString(a.url).ProjectUID,b=Ext.Object.fromQueryString(a.url).FloorplanUID;a.url=mdslink.clientFloorplanViewer+'ProjectUID='+c+'&FloorplanUID='+b;return a.url}}],proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'index.cfm?fuseaction=aClientNavigation.getProjectBreadcrumb&ProjectUID={ProjectUID}'},autoLoad:!0},floorplans:{model:'clientNavigation.model.MegamenuParent',proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'index.cfm?fuseaction=aClientNavigation.ProjectMegamenu&ProjectUID={ProjectUID}'},autoLoad:!0},workingPlans:{model:'clientNavigation.model.MegamenuParent',proxy:{type:'jsonp',reader:{type:'json',root:'data'},url:'index.cfm?fuseaction=aClientNavigation.getWorkingPlansMenu&ProjectUID={ProjectUID}'},autoLoad:!1}},formulas:{accountReady:function(a){var b=!!(a('globalAccountLoaded')&&a('projectAccountLoaded'));if(b&&window.app){app.fireEvent('accountready',a('account'))}return b},logoHtml:function(d){var b=d('validatedCompanyLogo'),c=d('validatedProjectLogo'),a='<div class="top-logos">';if(b){a+='<img class="company" src="'+b+'">'}if(c){a+='<img class="project" src="'+c+'">'}a+='</div>';return a},_triggerValidateLogos:function(f){var c=f('navSettings'),a=c.companyLogoURL,b=c.projectLogoURL,d=new Image(),e=new Image();d.onload=Ext.bind(function(){this.set('validatedCompanyLogo',a)},this);e.onload=Ext.bind(function(){this.set('validatedProjectLogo',b)},this);if(a){d.src=a}if(b){e.src=b}}}},0,0,0,0,['viewmodel.clientNavigation'],0,[clientNavigation.view.clientViewport,'ClientViewportModel'],0);Ext.cmd.derive('clientNavigation.view.clientViewport.ClientViewport',Ext.Container,{itemId:'topLevelView',scrollable:!1,controller:'clientNavigation',viewModel:{type:'clientNavigation'},layout:{type:'border'},overflowX:'hidden',overflowY:'hidden',loadMaskCls:'light-load-indicator'},0,['clientviewport'],['component','box','container','clientviewport'],{'component':!0,'box':!0,'container':!0,'clientviewport':!0},['widget.clientviewport'],0,[clientNavigation.view.clientViewport,'ClientViewport'],0);Ext.cmd.derive('clientFloorplanViewer.Application',Ext.app.Application,{mvInitLocale:!0,name:'clientFloorplanViewer',init:function(){window.app=this}},0,0,0,0,0,0,[clientFloorplanViewer,'Application'],0);Ext.cmd.derive('clientFloorplanViewer.view.main.Main',Ext.container.Container,{id:'clientFloorplanViewer',layout:{type:'vbox',align:'stretch'},items:[{xtype:'clientFloorplanViewerDisp',viewModel:{data:{localizeFloorplan:!1}}}],constructor:function(){Ext.container.Container.prototype.constructor.apply(this,arguments);window.mainView=this;this.up('clientviewport').lookupController().loadPermissions(function(b,a){})}},1,['clientFloorplanViewer'],['component','box','container','clientFloorplanViewer'],{'component':!0,'box':!0,'container':!0,'clientFloorplanViewer':!0},['widget.clientFloorplanViewer'],0,[clientFloorplanViewer.view.main,'Main'],0);Ext.cmd.derive('clientFloorplanViewer.view.Viewport',clientNavigation.view.clientViewport.ClientViewport,{items:[{region:'north',xtype:'clientnavigation'},{region:'center',xtype:'clientFloorplanViewer',itemId:'activePage'}]},0,0,['component','box','container','clientviewport'],{'component':!0,'box':!0,'container':!0,'clientviewport':!0},0,0,[clientFloorplanViewer.view,'Viewport'],0);mdslink.server='';Ext.application({name:'clientFloorplanViewer',extend:clientFloorplanViewer.Application,autoCreateViewport:'clientFloorplanViewer.view.Viewport'});